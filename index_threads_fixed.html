<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›æ‰ä½ èˆŠçš„metaå’Œiconé€£çµ â–¼â–¼â–¼ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">


<!-- 1. (æ ¸å¿ƒ) ç‚ºè˜‹æœè¨­å‚™è¨­ç½®ä¸»è¢å¹•åœ–ç¤º -->
<link rel="apple-touch-icon" href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg">
<link rel="apple-touch-icon" sizes="152x152" href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg">
<link rel="apple-touch-icon" sizes="180x180" href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg">
<link rel="apple-touch-icon" sizes="167x167" href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg">

<!-- 2. (æ ¸å¿ƒ) é€£çµåˆ°manifestæª” -->
<link rel="manifest" href="manifest.json">

<!-- 3. (æ ¸å¿ƒ) å‘Šè¨´è˜‹æœè¨­å‚™ï¼Œé€™æ˜¯ä¸€å€‹Webæ‡‰ç”¨ï¼Œå¯ä»¥å…¨å±é¡¯ç¤º -->
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- 4. (æ ¸å¿ƒ) è¨­ç½®è˜‹æœè¨­å‚™å…¨å±æ¨¡å¼ä¸‹çš„ç‹€æ…‹åˆ—æ¨£å¼ -->
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- 5. (å¯é¸) è¨­ç½®æ‡‰ç”¨åœ¨ä¸»è¢å¹•ä¸Šé¡¯ç¤ºçš„æ¨™é¡Œ -->
<meta name="apple-mobile-web-app-title" content="EPhoneï¼ˆå…”kæ©Ÿç‰ˆï¼‰">

<!-- 6. (ç›¸å®¹) ç‚ºéƒ¨åˆ†å®‰å“æµè¦½å™¨æä¾›æ”¯æ´ -->
<meta name="mobile-web-app-capable" content="yes">

<!-- 7. (å‚™ç”¨) æ¨™æº–æµè¦½å™¨é ç°½åœ–ç¤º -->
<link rel="icon" type="image/png" href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg">
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->


    <title>iPhone</title>

    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script src="https://sssayhi07-gif.github.io/ee/pp.js" defer></script>

    <style>
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff;    --status-bar-text-color: var(--accent-color); }
/* â–¼â–¼â–¼ ç”¨é€™å¡Šçµ‚æ¥µä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ ç¾æœ‰çš„ html å’Œ body æ¨£å¼ â–¼â–¼â–¼ */
html {
    -webkit-text-size-adjust: 100%;
    height: 100%; /* ç¢ºä¿htmlå…ƒç´ ä¹Ÿèƒ½æ’æ»¿ */
}

body {
    margin: 0;
    font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-weight: normal;
    background-color: #f0f2f5;
    height: 100%; /* è®“bodyä¹Ÿæ’æ»¿çˆ¶å…ƒç´ (html) */
    overflow: hidden; /* é˜²æ­¢bodyæœ¬èº«å‡ºç¾æ²è»¸ */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* 2. è®“ #phone-screen æˆç‚ºæ–°çš„â€œæ ¹â€å®¹å™¨ï¼Œæ’æ»¿æ•´å€‹æµè¦½å™¨è¦–çª— */
/* â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šã€æœ€çµ‚ä¿®æ­£ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ ç¾æœ‰çš„ #phone-screen æ¨£å¼ â–¼â–¼â–¼ */
#phone-screen {
    width: 100%;
    height: 100vh;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: #ffffff; /* â˜… ä¿®æ”¹é€™è£¡ç‚ºç™½è‰² */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* 3. ã€æ ¸å¿ƒã€‘éš±è—æ‰æ¨¡æ“¬å™¨çš„ç‹€æ…‹åˆ— */
#status-bar {
    display: none;
}

/* 4. ã€æ ¸å¿ƒã€‘è®“æ‰€æœ‰é é¢çš„é ­éƒ¨è‡ªå‹•é©æ‡‰iPhoneçš„â€œåŠ‰æµ·â€å®‰å…¨å€ */
.header, .qzone-header {
    /* ä½¿ç”¨ env(safe-area-inset-top) è‡ªå‹•ç²å–é ‚éƒ¨å®‰å…¨è·é›¢ */
    padding-top: calc(15px + env(safe-area-inset-top));
}

/* 5. ã€æ ¸å¿ƒã€‘è®“èŠå¤©è¼¸å…¥æ¡†å’Œåº•éƒ¨å·¡è¦½åˆ—è‡ªå‹•é©æ‡‰iPhoneåº•éƒ¨çš„â€œå°é»‘æ¢â€å®‰å…¨å€ */
#chat-input-area {
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
}

#chat-list-bottom-nav {
     padding-bottom: env(safe-area-inset-bottom);
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

      /* ä¿®æ”¹å¾Œçš„ä»£ç¢¼å¡Š */
/* â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€å¯æ„›åœ“æ½¤ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›æ‰æ‰€æœ‰èˆŠçš„ status-bar å’Œ battery æ¨£å¼ â–¼â–¼â–¼ */

#status-bar { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    padding: 12px 20px; 
    display: none; 
    justify-content: space-between; 
    align-items: center; 
    color: var(--accent-color); /* â˜… ä¿®æ”¹ï¼šç‹€æ…‹åˆ—æ–‡å­—/åœ–ç¤ºé¡è‰²ï¼Œç¾åœ¨æœƒè·Ÿéš¨ä¸»é¡Œè‰²ï¼ */
    z-index: 10; 
    font-size: 14px; 
    box-sizing: border-box; 
    pointer-events: none; 
    /* â˜… æ–°å¢ï¼šä½¿ç”¨ä½ çš„è‡ªè¨‚å­—é«”ï¼Œä¸¦åŠ ä¸ŠæŸ”å’Œçš„å…‰æšˆï¼Œè®“å®ƒæ›´å¯æ„› */
    font-family: 'bulangni', sans-serif; 
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.5); 
}

#status-bar-time { 
    font-weight: 600; 
}

.battery-container { 
    display: flex; 
    align-items: center; 
    gap: 5px; 
}

.battery-icon { 
    width: 25px; 
    height: 12px; 
    border: 1.5px solid currentColor; /* â˜… é‚Šæ¡†åŠ ç²—ä¸€é»é» */
    border-radius: 5px; /* â˜… ä¿®æ”¹ï¼šå¢åŠ åœ“è§’ï¼Œè®“å®ƒæ›´åœ“æ½¤å¯æ„› */
    position: relative; 
    padding: 1px; 
}

.battery-icon::after { 
    content: ''; 
    position: absolute; 
    right: -4px; /* å¾®èª¿ä½ç½® */
    top: 2.5px; 
    width: 2px; 
    height: 5px; 
    background-color: currentColor; 
    border-radius: 0 2px 2px 0; /* â˜… é ­éƒ¨å°å¡Šä¹Ÿè®Šåœ“æ½¤ */
}

.battery-level { 
    height: 100%; 
    background-color: currentColor; /* â˜… é è¨­å¡«å……è‰²ä¹Ÿè·Ÿéš¨ä¸»é¡Œè‰² */
    border-radius: 3px; /* â˜… å…§éƒ¨å¡«å……æ¢ä¹Ÿè®Šåœ“æ½¤ */
    transition: width 0.5s ease; 
}

/* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šè®“å……é›»æ™‚ä¹Ÿé¡¯ç¤ºä¸»é¡Œè‰²ï¼ */
.battery-container.charging .battery-level { 
    animation: charge-breath 2s infinite; 
}
@keyframes charge-breath { 
    0%, 100% { opacity: 1; } 
    50% { opacity: 0.7; } 
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€çµ‚æ¥µä¿®æ­£ç‰ˆã€‘è«‹ç”¨é€™å¡Šä»£ç¢¼å®Œæ•´æ›¿æ›æ‰æ‰€æœ‰èˆŠçš„ .screen æ¨£å¼ â–¼â–¼â–¼ */
.screen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;  /* â˜… æ–°å¢ */
    bottom: 0; /* â˜… æ–°å¢ */
    width: 100%; /* ä¿ç•™ */
    /* height: 100%; */ /* â˜… æ³¨é‡‹æˆ–åˆªé™¤æ‰é€™ä¸€è¡Œ */

    display: flex;
    flex-direction: column;
    overflow: hidden;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
       .header {
    position: relative;
    z-index: 15;
    flex-shrink: 0;
    padding: 15px 15px;
    padding-top: 45px;
    background-color: rgba(247, 247, 247, 0.8);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    
    /* â–¼â–¼â–¼ æ–°å¢ä¸‹é¢é€™å…©è¡Œ â–¼â–¼â–¼ */
    height: 110px;               /* â˜… æ–°å¢ï¼šå¼·åˆ¶è¨­ç½®ä¸€å€‹çµ±ä¸€çš„é«˜åº¦ */
    box-sizing: border-box;     /* â˜… æ–°å¢ï¼šç¢ºä¿é«˜åº¦è¨ˆç®—åŒ…å«å…§é‚Šè· */
    /* â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² */
}

        .header .header-actions { display: flex; align-items: center; gap: 5px; }
        /* â–¼â–¼â–¼ ã€è§¸æ‘¸å€åŸŸå„ªåŒ–ç‰ˆã€‘æ›¿æ›èˆŠçš„ .header .back-btn, .header .action-btn æ¨£å¼ â–¼â–¼â–¼ */
.header .back-btn, .header .action-btn {
    font-size: 24px; /* ä¿æŒåœ–ç¤ºå¤§å°ä¸è®Š */
    cursor: pointer;
    color: var(--accent-color);
    display: flex;
    align-items: center;
    justify-content: center;

    /* --- æ ¸å¿ƒä¿®æ”¹å¾é€™è£¡é–‹å§‹ --- */
    width: 40px;              /* 1. å°‡æŒ‰éˆ•å¯¬åº¦å¾30pxå¢åŠ åˆ°40px */
    height: 40px;             /* 2. å°‡æŒ‰éˆ•é«˜åº¦å¾30pxå¢åŠ åˆ°40px */
    border-radius: 50%;       /* 3. (å¯é¸ä½†æ¨è–¦) è®“æŒ‰éˆ•è®Šæˆåœ“å½¢ï¼Œæ›´ç¾è§€ */
    transition: background-color 0.2s; /* 4. ç‚ºæ‡¸åœæ•ˆæœæ·»åŠ å¹³æ»‘å‹•ç•« */
}

/* ã€æ–°å¢ã€‘ç‚ºæŒ‰éˆ•æ·»åŠ æ‡¸åœ/é»æ“Šæ™‚çš„èƒŒæ™¯è‰²ï¼Œçµ¦ç”¨æˆ¶æ˜ç¢ºçš„å›é¥‹ */
.header .back-btn:hover, .header .action-btn:hover {
    background-color: rgba(0, 0, 0, 0.05); /* æ»‘é¼ æ”¾ä¸Šå»æ™‚çµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯ */
}
#phone-screen.dark-mode .header .back-btn:hover,
#phone-screen.dark-mode .header .action-btn:hover {
    background-color: rgba(255, 255, 255, 0.1); /* å¤œé–“æ¨¡å¼ä¸‹çš„æ‡¸åœé¡è‰² */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


.header .action-btn {
    font-size: 16px; /* å°ˆé–€ç‚ºâ€œä¸Šå‚³â€ã€â€œ+â€ç­‰æ–‡å­—æŒ‰éˆ•ç¸®å°å­—å‹å¤§å° */
    font-weight: 600; /* å¯ä»¥åŠ ç²—ä¸€é»è®“å®ƒæ›´æ¸…æ™° */
}

        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
/* â–¼â–¼â–¼ ã€çµ‚æ¥µåˆä½µä¿®æ­£ç‰ˆã€‘è«‹ç”¨é€™å¡Šä»£ç¢¼å®Œæ•´æ›¿æ›æ‰èˆŠçš„ #home-screen, #clock-container, .app-grid æ¨£å¼ â–¼â–¼â–¼ */
        
/* 1. (æ ¸å¿ƒ) ç‚ºé–å±å’Œä¸»è¢å¹•æ‡‰ç”¨ç›¸åŒçš„å…¨å±ä½ˆå±€ (æ­¤éƒ¨åˆ†ä¿æŒä¸è®Š) */
#lock-screen, 
#home-screen {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    
    /* ç”¨paddingæŠŠå…§å®¹æ“ é€²ä¾†ï¼ŒåŒæ™‚è®“èƒŒæ™¯é‹ªæ»¿å®‰å…¨å€ */
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: 20px;
    padding-right: 20px;
    
    box-sizing: border-box;
}

/* 2. (æ ¸å¿ƒ) å–®ç¨è™•ç†é–å±çš„æ–‡å­—ï¼Œè®“å®ƒè‡ªå‹•è²¼åº• (é€™æ˜¯æœ¬æ¬¡çš„å”¯ä¸€ä¿®æ”¹) */
#lock-screen-content {
    margin-top: auto; /* é—œéµï¼šè‡ªå‹•å°‡æ­¤å…ƒç´ æ¨åˆ°å®¹å™¨åº•éƒ¨ */
    margin-bottom: 40px; /* â˜… æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ margin-bottom å‘ä¸Šæ¨é–‹ï¼Œè€Œä¸æ˜¯padding */
    text-align: center;
    color: white;
    text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    font-size: 16px;
    font-weight: 500;
}

/* 3. ä¿æŒä¸»è¢å¹•çš„æ™‚é˜å’ŒAppåœ–ç¤ºä½ˆå±€ä¸è®Š */
#clock-container {
    text-align: center;
    color: white;
    text-shadow: 0 3px 8px rgba(0,0,0,0.4);
    margin-bottom: 20px;
    flex-shrink: 0;
    margin-top: 60px; 
}
.app-grid {
    margin-top: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    width: 100%;
    padding: 20px;
    margin-bottom: 30px; 
}



/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */



        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: var(--secondary-bg); margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
/* ä¿®æ”¹å¾Œçš„ #world-book-list æ¨£å¼ */
/* ã€çµ‚æ¥µä¿®å¾©ç‰ˆã€‘ä¸–ç•Œæ›¸ä¸»ä»‹é¢æ¸…å–®æ¨£å¼ */
#world-book-list {
    flex-grow: 1;          /* è®“åˆ—è¡¨ä½”æ“šæ‰€æœ‰å‰©é¤˜çš„å‚ç›´ç©ºé–“ */
    overflow-y: auto;      /* å…§å®¹è¶…å‡ºæ™‚ï¼Œè‡ªå‹•é¡¯ç¤ºå‚ç›´æ²å‹•æ¢ */
    min-height: 0;         /* è§£æ±ºFlexä½ˆå±€ä¸‹çš„æ»¾å‹•ç›¸å®¹æ€§å•é¡Œ */
    background-color: var(--secondary-bg); /* ä¿ç•™ä½ å–œæ­¡çš„èƒŒæ™¯è‰² */
    /* æˆ‘å€‘ä¸å†éœ€è¦ padding-top å’Œ margin-top é€™å…©å€‹æŠ€å·§äº† */
}


/* ä¿®æ”¹å¾Œçš„ #chat-list æ¨£å¼ï¼Œé©é…äº†iOSåº•éƒ¨å®‰å…¨å€ */
#chat-list {
    flex-grow: 1;
    background-color: var(--secondary-bg);
    padding-top: 110px; 
    /* æ ¸å¿ƒä¿®å¾©ï¼šå°‡åº•éƒ¨å…§é‚Šè·å¾ 8px å¢åŠ åˆ° 60pxï¼Œç‚ºå·¡è¦½åˆ—ç•™å‡ºè¶³å¤ ç©ºé–“ */
    padding-bottom: calc(60px + env(safe-area-inset-bottom)); 
    box-sizing: border-box;
}


        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        /* ä¿®æ”¹å¾Œçš„ä»£ç¢¼ */
/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€çµ‚æ¥µä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›ä½ èˆŠçš„ #chat-interface-screen å’Œ #chat-messages æ¨£å¼ â–¼â–¼â–¼ */

/* 1. èŠå¤©è¢å¹•ç¸½å®¹å™¨ï¼šè®“å®ƒæˆç‚ºä¸€å€‹æ’æ»¿è¢å¹•çš„Flexåˆ—ä½ˆå±€ */
#chat-interface-screen { 
    background-size: cover; 
    background-position: center; 
    display: flex; /* <-- æ ¸å¿ƒï¼šå¿…é ˆæ˜¯flexä½ˆå±€ */
    flex-direction: column; /* <-- æ ¸å¿ƒï¼šå­å…ƒç´ å‚ç›´æ’åˆ— */
    height: 100%; /* <-- æ ¸å¿ƒï¼šæ’æ»¿çˆ¶å®¹å™¨ */
    overflow: hidden; /* <-- æ ¸å¿ƒï¼šé˜²æ­¢ä»»ä½•æ„å¤–æº¢å‡º */
}

/* 2. èŠå¤©æ¶ˆæ¯å€åŸŸï¼šè®“å®ƒè‡ªå‹•å¡«å……å‰©é¤˜ç©ºé–“ï¼Œè€Œä¸æ˜¯å›ºå®šé«˜åº¦ */
#chat-messages {
    flex-grow: 1;           /* â˜…â˜…â˜… æœ€æœ€é—œéµçš„ä¸€è¡Œï¼è®“å®ƒè‡ªå‹•ä¼¸ç¸®ï¼Œå¡«æ»¿å‰©é¤˜ç©ºé–“ â˜…â˜…â˜… */
    min-height: 0;          /* ä¸€å€‹ç¥å¥‡çš„ä¿éšªçµ²ï¼Œè§£æ±ºFlexä½ˆå±€ä¸‹çš„æ»¾å‹•ç›¸å®¹å•é¡Œ */
    overflow-y: auto;       /* å…§å®¹è¶…å‡ºæ™‚ï¼Œå…è¨±è‡ªèº«å‚ç›´æ²å‹• */
    overflow-x: hidden;
    padding: 10px 15px;     /* ä¿ç•™èˆ’é©çš„å·¦å³å…§é‚Šè· */
    box-sizing: border-box;

    /* 
     * ä¿ç•™ä½ çš„é ­éƒ¨é©é…æ–¹æ¡ˆï¼š
     * ç‚ºé ‚éƒ¨åŠé€æ˜çš„headerç•™å‡ºç©ºé–“ï¼ŒåŒæ™‚è®“èƒŒæ™¯åœ–èƒ½é€ä¸Šå»ã€‚
     * 110pxæ˜¯headerçš„é«˜åº¦, -80pxæ˜¯å‘ä¸Šæ‹‰çš„è·é›¢ï¼Œä½ å¯ä»¥æ ¹æ“šä½ çš„headeræ¨£å¼å¾®èª¿ã€‚
    */
    padding-top: 110px;
    margin-top: -80px;

    /* ä¿æŒå…§éƒ¨æ¶ˆæ¯æ°£æ³¡çš„flexä½ˆå±€ */
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }

        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }

.message-wrapper.ai .sender-name {
    margin-left: 50px; /* ç¨å¾®èª¿æ•´ï¼Œèˆ‡é ­åƒå°é½Š */
    margin-bottom: 3px;
    position: absolute; /* è®“å®ƒè„«é›¢æµï¼Œé¿å…å½±éŸ¿æ°£æ³¡å°é½Š */
    top: -16px;       /* å®šä½åˆ°æ°£æ³¡ä¸Šæ–¹ */
    left: 0;
}

/* === ã€å…¨æ–°ã€‘æ¶ˆæ¯ä½ˆå±€èˆ‡æ™‚é–“æˆ³è¨˜æ¨£å¼ === */

/* 1. æ¶ˆæ¯å–®å…ƒçš„ç¸½å®¹å™¨ (é‡æ§‹) */
.message-wrapper {
    display: flex;          /* ä½¿ç”¨Flexä½ˆå±€ */
    gap: 8px;               /* æ°£æ³¡å’Œæ™‚é–“æˆ³è¨˜ä¹‹é–“çš„é–“è· */
    align-items: flex-end;  /* æ ¸å¿ƒï¼šè®“æ°£æ³¡å’Œæ™‚é–“æˆ³è¨˜åº•éƒ¨å°é½Š */
    position: relative;
    max-width: 90%;         /* å¯ä»¥ç¨å¾®æ”¾å¯¬ä¸€é»ï¼Œå› ç‚ºæ™‚é–“æˆ³è¨˜ç¾åœ¨åœ¨å¤–é¢äº† */
}

/* 2. AIæ¶ˆæ¯å–®å…ƒé å·¦ */
.message-wrapper.ai {
    align-self: flex-start;
    flex-direction: row; /* é ­åƒã€æ°£æ³¡ã€æ™‚é–“æˆ³è¨˜ï¼Œå¾å·¦åˆ°å³æ’åˆ— */
}

/* 3. ä½¿ç”¨è€…æ¶ˆæ¯å–®å…ƒé å³ */
.message-wrapper.user {
    align-self: flex-end;
    flex-direction: row-reverse; /* æ™‚é–“æˆ³è¨˜ã€æ°£æ³¡ã€é ­åƒï¼Œå¾å³åˆ°å·¦æ’åˆ— */
}

/* 4. æ°£æ³¡å’Œé ­åƒçš„ç›´æ¥å®¹å™¨ (ä¿æŒä¸è®Š) */
.message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
}

.timestamp {
    /* ç§»é™¤èˆŠçš„ position: absolute */
    font-size: 11px;
    color: #999;
    text-shadow: 0 0 3px rgba(255,255,255,0.6);
    white-space: nowrap; /* é˜²æ­¢æ™‚é–“æ›è¡Œ */
    margin-bottom: 5px;  /* è®“å®ƒå’Œæ°£æ³¡åº•éƒ¨æœ‰è¼•å¾®çš„å°é½Šåç§»ï¼Œæ›´ç¾è§€ */
    flex-shrink: 0;      /* é˜²æ­¢è¢«å£“ç¸® */
}

        .message-bubble.selected::after { content: 'âœ”'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }

        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        /* ä¿®æ”¹èŠå¤©è¼¸å…¥æ¡†å€åŸŸçš„ padding */
#chat-input-area { 
    flex-shrink: 0; 
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¢åŠ äº†ä¸Šã€å·¦ã€å³çš„å…§é‚Šè·ï¼Œè®“æ•´å€‹å€åŸŸæ›´â€œå¯¬æ•â€ â–¼â–¼â–¼ */
    padding: 10px 12px; 
    background-color: rgba(247, 247, 247, 0.8); 
    backdrop-filter: blur(10px); 
    -webkit-backdrop-filter: blur(10px); 
    border-top: 1px solid var(--border-color); 
    display: flex; 
    flex-direction: column; 
    gap: 5px; 
}

/* ä¿®æ”¹iPhoneåº•éƒ¨å®‰å…¨å€çš„é©é… */
#chat-input-area {
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šå°‡é€™è£¡çš„ 8px ä¹ŸåŒæ­¥ç‚º 10pxï¼Œä¿æŒä¸€è‡´ â–¼â–¼â–¼ */
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
}

        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal {
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå°‡å®šä½æ–¹å¼å¾ absolute æ”¹ç‚º fixed â–¼â–¼â–¼ */
    position: fixed; 
    /* â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² */
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(0,0,0,0.4); 
    display: none; 
    justify-content: center; 
    align-items: center; 
    z-index: 100; 
}

        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: 0; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    visibility: hidden;
}
#notification-bar.visible {
    /* é—œéµï¼šåœ¨Yè»¸å›åˆ°åŸä½çš„åŒæ™‚ï¼Œä¿æŒXè»¸çš„å±…ä¸­è®Šæ› */
    transform: translateX(-50%) translateY(0);
    visibility: visible;
}
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid, #exclusive-sticker-grid, #common-sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }

.checkboxes-container {
    display: none;
    position: absolute;
    top: 100%; 
    margin-top: 5px;
    left: 0;
    right: 0;
    max-height: 400px; /* â˜…â˜…â˜… ä¿®æ”¹é»åœ¨é€™è£¡ â˜…â˜…â˜… æˆ‘æŠŠé«˜åº¦å¾ 150px å¢åŠ åˆ°äº† 350px */
    overflow-y: auto;
    overflow-x: hidden;
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 101;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }

.checkboxes-container label {
    display: block;
    padding: 12px 15px; /* <-- ä¿®æ”¹ï¼šå¢åŠ äº†ä¸Šä¸‹å’Œå·¦å³çš„å…§é‚Šè·ï¼Œè®“æ¯ä¸€è¡Œæ›´é«˜æ›´å¯¬ */
    cursor: pointer;
    font-weight: normal;
    color: var(--text-primary);
    font-size: 15px; /* <-- æ–°å¢ï¼šå°‡å­—é«”å¤§å°å¾é è¨­å€¼æ”¾å¤§åˆ°15px */
}

        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
.voice-duration {
    /* --- æ ¸å¿ƒä¿®æ­£ --- */
    font-size: var(--chat-font-size, 13px);
    /* --- ä¿®æ­£çµæŸ --- */
    font-weight: 500;
    color: var(--text-secondary);
}
        .message-bubble.user .voice-duration { color: #3e6224; }

/* â–¼â–¼â–¼ ç”¨é€™å¡Šä»£ç¢¼æ›¿æ›æ‰ä½ åŸä¾†çš„ .message-bubble .content æ¨£å¼ â–¼â–¼â–¼ */
/* é€šç”¨å…§å®¹å€æ¨£å¼ï¼Œç‚ºæ™‚é–“æˆ³è¨˜å’Œå­—é«”å¤§å°åšæº–å‚™ */
.message-bubble .content {
    position: relative;
    font-size: var(--chat-font-size, 16px);
    padding: 8px 12px;
    line-height: 1.5;
    word-break: break-word; /* æ ¸å¿ƒä¿®æ­£: å¼·åˆ¶é•·å–®è©æˆ–URLæ›è¡Œï¼Œé˜²æ­¢æ’ç ´æ°£æ³¡ */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

        /* === æ°£æ³¡ä¸»é¡Œæ¨£å¼ === */
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
      
.message-bubble::after {
    content: "";
    position: absolute;
    width: 20px;  
    height: 20px; 
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 1; 
    z-index: 1;
}
      
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }

        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'ğŸ¾'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }

/* é€™æ˜¯ä½ è¦æ·»åŠ çš„æ–°æ¨£å¼ */
#font-preview {
    transition: font-family 0.3s ease;}

/* === èŠå¤©æ¸…å–®ä»‹é¢æ–°å¢æ¨£å¼ (é€™æ˜¯æ–°æ·»åŠ çš„) === */
#chat-list-screen {
}

.chat-list-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    z-index: 1; 
}
.chat-list-view.active {
    opacity: 1;
    visibility: visible;
    z-index: 2; 
}

#messages-view {
    overflow-y: auto; 
}

/* åº•éƒ¨å·¡è¦½åˆ—æ¨£å¼ */
#chat-list-bottom-nav {
    position: absolute; /* è®“å®ƒå›ºå®šåœ¨åº•éƒ¨ */
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 15; /* ç¢ºä¿å®ƒåœ¨è¦–åœ–ä¹‹ä¸Š */
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 13px 0;
    font-size: 14px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.2s;
}

.nav-item.active {
    color: var(--accent-color);
    font-weight: 600;
}

/* === å‹•æ…‹ä»‹é¢ (QZone) æ¨£å¼ (é€™æ˜¯æ–°æ·»åŠ çš„) === */
#qzone-screen {
    background-color: #f0f2f5;
}

.qzone-header {
    /* position: absolute;  <-- æŠŠé€™å€‹æ”¹æˆ relative */
    position: relative;
    z-index: 10; /* z-index ä¿æŒï¼Œæˆ–è€…å¯ä»¥æ›´é«˜ */
    flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
    padding: 15px 20px;
    padding-top: 45px;
    background-color: rgba(247, 247, 247, 0.7); 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.qzone-header .back-btn {
    font-size: 24px;
    cursor: pointer;
    color: var(--accent-color);
}

.qzone-header span:nth-child(2) { /* "å¥½å‹å‹•æ…‹"æ–‡å­— */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.qzone-content {
    flex-grow: 1;
    overflow-y: auto;
    /* padding-top: 80px;  <-- åˆªé™¤é€™å€‹ï¼Œå› ç‚ºheaderä¸å†æ˜¯absoluteäº† */
}

.qzone-profile-header {
    position: relative;
    margin-bottom: 20px;
}

.qzone-banner-container {
    width: 100%;
    height: 180px; /* èƒŒæ™¯æ¿é«˜åº¦ */
    position: relative;
}

#qzone-banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.qzone-user-info {
    position: absolute;
    bottom: -30px; /* è®“é ­åƒå’Œæ˜µç¨±å€åŸŸå‘ä¸‹åç§»ï¼Œä¸€åŠåœ¨èƒŒæ™¯æ¿å…§ï¼Œä¸€åŠåœ¨å¤– */
    left: 20px;
    display: flex;
    align-items: flex-end; /* è®“æ˜µç¨±å’Œé ­åƒåº•éƒ¨å°é½Š */
    gap: 10px;
}

.qzone-avatar-container {
    position: relative;
}

#qzone-avatar-img {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    object-fit: cover;
}

#qzone-nickname {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    padding-bottom: 5px; /* å¾®èª¿ä½ç½® */
}

/* ç·¨è¼¯æŒ‰éˆ•çš„é€šç”¨æ¨£å¼ */
.qzone-edit-btn {
    position: absolute;
    background-color: rgba(0,0,0,0.4);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

#change-qzone-banner-btn {
    bottom: 10px;
    right: 10px;
}

#change-qzone-avatar-btn {
    bottom: 5px;
    right: 5px;
}

#change-qzone-nickname-btn {
    font-size: 14px;
    padding: 2px 6px;
    margin-left: 5px; /* èˆ‡æ˜µç¨±çš„é–“è· */
    color: var(--text-primary);
    background-color: rgba(255,255,255,0.7);
    border-radius: 5px;
    position: relative; /* è„«é›¢flexä½ˆå±€çš„å°é½Š */
    bottom: 5px; /* å¾®èª¿å‚ç›´ä½ç½® */
}

/* === è®“ç·¨è¼¯åŠŸèƒ½æ›´â€œéš±å½¢â€ === */
#qzone-banner-container,
#qzone-avatar-container,
#qzone-nickname {
    cursor: pointer; /* æ»‘é¼ æ‡¸åœæ™‚é¡¯ç¤ºç‚ºå¯é»æ“Šæ‰‹å‹¢ */
    transition: opacity 0.2s;
}
#qzone-banner-container:hover,
#qzone-avatar-container:hover,
#qzone-nickname:hover {
    opacity: 0.85; /* æ‡¸åœæ™‚ç¨å¾®è®Šæš—ï¼Œçµ¦ç”¨æˆ¶å›é¥‹ */
}
/* éš±è—æ‰èˆŠçš„ã€ç¨ç«‹çš„ç·¨è¼¯æŒ‰éˆ• */
.qzone-edit-btn {
    display: none;
}

/* === æ§åˆ¶ Header å’Œ Bottom Nav çš„é¡¯éš± === */
/* é è¨­éš±è—å‹•æ…‹ä»‹é¢çš„ Header */
#qzone-screen .qzone-header {
    display: none;
}
/* ç•¶å‹•æ…‹è¦–åœ–å•Ÿå‹•æ™‚ï¼Œé¡¯ç¤ºå®ƒçš„Header */
#qzone-screen.active .qzone-header {
    display: flex;
}

/* ç•¶é€²å…¥å‹•æ…‹è¦–åœ–æ™‚ï¼Œéš±è—ä¸»Headerå’Œåº•éƒ¨å·¡è¦½åˆ— */
#chat-list-screen.in-qzone-view > .header,
#chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
    display: none;
}

.chat-group-container:first-child {
    margin-top: 10px; 
}

/* â–²â–²â–² æ–°æ¨£å¼æ›¿æ›çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠæ‰€æœ‰é€™äº›æ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === å‹•æ…‹åŠŸèƒ½æ¬„æ¨£å¼ === */
.qzone-actions-bar {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    margin: 40px 15px 15px 15px; /* ä¸Šé‚Šè·æ›´å¤§ï¼Œç‚ºæµ®å‹•çš„é ­åƒç•™å‡ºç©ºé–“ */
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.action-item {
    flex: 1;
    text-align: center;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    padding: 8px 0;
    position: relative;
}

/* ç”¨å½å…ƒç´ å‰µå»ºåˆ†éš”ç·š */
.action-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 20px;
    background-color: var(--border-color);
}

/* === å‹•æ…‹å¸–å­æ¸…å–®æ¨£å¼ === */
#qzone-posts-list {
    padding: 0 15px 20px 15px; /* å·¦å³å’Œåº•éƒ¨ç•™å‡ºé‚Šè· */
    display: flex;
    flex-direction: column;
    gap: 20px; /* å¸–å­ä¹‹é–“çš„é–“è· */
}

.qzone-post-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.post-header .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.post-info {
    display: flex;
    flex-direction: column;
}

.post-info .post-nickname {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
}

.post-info .post-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.post-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap; /* è®“åˆ†è¡Œç¬¦è™Ÿç”Ÿæ•ˆ */
    word-break: break-word; /* é˜²æ­¢é•·å–®è©æº¢å‡º */
}

/* â–²â–²â–² æ–°æ¨£å¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æ–°æ¨£å¼é»è²¼åˆ°æœ«å°¾ â–¼â–¼â–¼ */

/* === ç™¼ä½ˆå‹•æ…‹æ¨¡æ…‹æ¡†æ¨£å¼ === */
#post-public-text {
    min-height: 80px; /* ç¢ºä¿æ–‡æœ¬åŸŸæœ‰è¶³å¤ çš„é«˜åº¦ */
    resize: vertical;
}

.post-image-preview-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9; /* ä¿æŒ16:9çš„é è¦½æ¯”ä¾‹ */
    background-color: #f0f2f5;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    margin-bottom: 15px;
    display: none; /* é»˜èªéš±è— */
    justify-content: center;
    align-items: center;
}
.post-image-preview-container.visible {
    display: flex; /* ä¸Šå‚³å¾Œé¡¯ç¤º */
}

#post-image-preview {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

#post-remove-image-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #ff3b30;
    color: white;
    border: 2px solid white;
    font-size: 16px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

.post-image-upload-options {
    display: flex;
    gap: 10px;
}

.post-image-upload-options button {
    flex: 1;
    margin-top: 0;
}

/* â–²â–²â–² æ–°æ¨£å¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æ–°æ¨£å¼ â–¼â–¼â–¼ */

/* === ç™¼ä½ˆå‹•æ…‹æ¨¡æ…‹æ¡† - æ¨¡å¼åˆ‡æ›æ¨£å¼ === */
.post-mode-switcher {
    display: flex;
    margin-bottom: 20px;
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 4px;
}

.mode-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background-color: transparent;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.mode-btn.active {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.post-mode-content {
    display: none; /* é»˜èªéƒ½éš±è— */
}

.post-mode-content.active {
    display: block; /* å•Ÿå‹•çš„æ‰é¡¯ç¤º */
}

/* â–²â–²â–² æ–°æ¨£å¼çµæŸ â–²â–²â–² */

/* === ç›¸å†Šé é¢èƒŒæ™¯è‰² === */
#album-screen {
    background-color: #f0f2f5; /* ä½¿ç”¨ä¸€å€‹æŸ”å’Œçš„æ·ºç°è‰²ï¼Œæ¯”ç´”ç™½æ›´è­·çœ¼ */
}

/* === ç›¸å†Šé é¢ç¶²æ ¼ä½ˆå±€ === */
#album-grid-page {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œé¡¯ç¤º2å€‹ç›¸å†Š */
    gap: 15px;
}

/* === ç›¸å†Šå°ˆæ¡ˆæ¨£å¼ (ç¾åŒ–) === */
.album-item {
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 8px; /* çµ¦æ•´å€‹é …ç›®ä¹ŸåŠ å€‹åœ“è§’ */
}

.album-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.album-cover {
    aspect-ratio: 1 / 1; /* ä¿æŒå°é¢ç‚ºæ­£æ–¹å½¢ */
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    margin-bottom: 8px;
    background-color: #f0f2f5; /* å°é¢è¼‰å…¥å‰çš„å ä½é¡è‰² */
}

.album-info {
    text-align: center;
}

.album-name {
    font-weight: 500;
    margin: 0 0 4px 0;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* é˜²æ­¢é•·åå­—æ›è¡Œ */
}

.album-count {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
}

/* â–²â–²â–² æ–°çš„ CSS é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™äº›æ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ç›¸å†Šç…§ç‰‡è©³æƒ…é  === */
#album-photos-screen {
    background-color: #f0f2f5;
}

#photos-grid-page {
    padding: 15px;
    display: grid;
    /* æ¯è¡Œé¡¯ç¤º3å¼µç…§ç‰‡ï¼Œä¸¦ä¿æŒé–“è· */
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.photo-item {
    position: relative; /* ç‚ºäº†å®šä½åˆªé™¤æŒ‰éˆ• */
    aspect-ratio: 1 / 1; /* ä¿æŒç…§ç‰‡ç‚ºæ­£æ–¹å½¢ */
    border-radius: 6px;
    overflow: hidden; /* é˜²æ­¢åœ–ç‰‡æº¢å‡ºåœ“è§’ */
    background-color: #e9ecef; /* åœ–ç‰‡è¼‰å…¥å‰çš„é ç•™ä½ç½®é¡è‰² */
}

.photo-item .photo-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ä¿è­‰åœ–ç‰‡å¡«æ»¿å®¹å™¨ä¸”ä¸è®Šå½¢ */
    cursor: pointer;
}

/* åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
.photo-item .photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜èªéš±è— */
    transition: opacity 0.2s ease;
}

/* æ»‘é¼ æ‡¸åœåœ¨ç…§ç‰‡ä¸Šæ™‚é¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
.photo-item:hover .photo-delete-btn {
    opacity: 1;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* === åœ–ç‰‡æª¢è¦–å™¨æ¨¡æ…‹æ¡†æ¨£å¼ === */
#photo-viewer-modal {
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 1002;
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
}

.photo-viewer-content {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
}

#photo-viewer-image {
    max-width: 90vw;  /* åœ–ç‰‡æœ€å¤§å¯¬åº¦ç‚ºè¦–å£çš„90% */
    max-height: 85vh; /* åœ–ç‰‡æœ€å¤§é«˜åº¦ç‚ºè¦–å£çš„85% */
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    /* ç‚ºåœ–ç‰‡çš„åˆ‡æ›æ·»åŠ ä¸€é»å¹³æ»‘çš„æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    transition: opacity 0.2s ease-in-out;
}

/* é—œé–‰æŒ‰éˆ• */
#photo-viewer-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 40px;
    font-weight: 200;
    cursor: pointer;
    line-height: 1;
    text-shadow: 0 0 5px black;
}

/* å·¦å³å°èˆªç®­é ­ */
#photo-viewer-modal .nav-arrow {
    position: absolute; /* ç¾åœ¨æˆ‘å€‘ç”¨çµ•å°å®šä½ä¾†æ§åˆ¶ç®­é ­ */
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 50px; /* åœ¨æ‰‹æ©Ÿè¢å¹•ä¸Šï¼Œå¯ä»¥ç¨å¾®å°ä¸€é» */
    font-weight: 100;
    cursor: pointer;
    padding: 10px; /* èª¿æ•´å…§é‚Šè· */
    user-select: none;
    transition: color 0.2s;
    z-index: 1003; /* ç¢ºä¿ç®­é ­åœ¨æœ€ä¸Šå±¤ */
}

#photo-viewer-prev-btn {
    left: 5px; /* å®šä½å·¦ç®­é ­ */
}

#photo-viewer-next-btn {
    right: 5px; /* å®šä½å³ç®­é ­ */
}

#photo-viewer-modal .nav-arrow:hover {
    color: white;
}

/* ç•¶ç®­é ­è¢«ç¦ç”¨æ™‚ï¼ˆæ¯”å¦‚ç¬¬ä¸€å¼µæˆ–æœ€å¾Œä¸€å¼µï¼‰ */
#photo-viewer-modal .nav-arrow:disabled {
    color: rgba(255, 255, 255, 0.2);
    cursor: default;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™äº›æ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šæ–°CSSæ›¿æ›æ‰ä¸Šä¸€ç‰ˆçš„äº¤äº’å€CSS â–¼â–¼â–¼ */

/* === å¸–å­å…§å®¹å€ - ç›¸å°å®šä½å®¹å™¨ === */
/* === å¸–å­å…§å®¹å€ === */
.post-main-content {
    /* å®ƒç¾åœ¨åªæ˜¯ä¸€å€‹æ™®é€šçš„å…§å®¹å®¹å™¨ï¼Œä¸å†éœ€è¦ç‰¹æ®Šæ¨£å¼äº† */
}

/* === å¸–å­äº’å‹•åœ–ç¤ºå€ (æ–°æ¨£å¼) === */
.post-feedback-icons {
    display: flex;
    justify-content: flex-end; /* è®“åœ–ç¤ºé å³å°é½Š */
    align-items: center;
    gap: 12px;
    padding: 8px 0; /* æ ¸å¿ƒä¿®æ”¹ï¼šçµ¦åœ–ç¤ºå€åŸŸä¸Šä¸‹å„8pxçš„ç•™ç™½ */
}

.action-icon {
    cursor: pointer;
    color: var(--text-secondary); /* é»˜èªç°è‰² */
    transition: all 0.2s ease-in-out;
}

.action-icon svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* åœ–ç¤ºå•Ÿå‹•(é»è´Š/æ”¶è—å¾Œ)çš„æ¨£å¼ */
.action-icon.active {
    color: #ff5252; /* å•Ÿå‹•å¾Œè®Šç´…è‰² */
    transform: scale(1.1); /* è¼•å¾®æ”¾å¤§ */
}

.action-icon.active.favorite {
    color: #ffc107; /* æ”¶è—ç”¨é»ƒè‰² */
}

.action-icon.active svg {
    fill: currentColor; /* å•Ÿå‹•å¾Œå¡«å……é¡è‰² */
}

/* é»æ“Šæ™‚çš„å‹•ç•«æ•ˆæœ */
.animate-like {
    animation: like-bounce 0.4s ease-in-out;
}

@keyframes like-bounce {
    0%   { transform: scale(1); }
    25%  { transform: scale(0.8); }
    50%  { transform: scale(1.2); }
    75%  { transform: scale(1.05); }
    100% { transform: scale(1.1); }
}


/* === å¸–å­åº•éƒ¨è©•è«–å€æ¨£å¼ (ç¾åœ¨æ˜¯ç¨ç«‹éƒ¨åˆ†) === */
.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0; /* ç”¨ä¸€æ¢æ·ºè‰²ç·šåˆ†éš” */
    display: flex;
    align-items: center;
    gap: 8px; /* èª¿æ•´æ•´é«”é–“è· */
}

/* è©•è«–å€å®¹å™¨ */
.comment-section {
    flex-grow: 1; /* ä½”æ“šå¤§éƒ¨åˆ†ç©ºé–“ */
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-section .comment-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.comment-section .comment-input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background-color: #f0f2f5;
    border-radius: 14px;
    font-size: 13px;
    outline: none;
}

/* æ–°å¢çš„ç™¼é€æŒ‰éˆ•æ¨£å¼ */
.comment-send-btn {
    flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
    padding: 8px 15px;
    border: none;
    background-color: var(--accent-color);
    color: white;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœªè®€æ¶ˆæ¯å°ç´…é»é€šç”¨æ¨£å¼ === */
.unread-indicator {
    position: absolute;
    top: -8px;      
    right: -15px;    
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #ff3b30;
    color: white;
    font-size: 11px;
    font-weight: bold;
    line-height: 18px;
    text-align: center;
    border-radius: 9px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    display: none;
    z-index: 1;
}

/* èŠå¤©ä»‹é¢è¿”å›æŒ‰éˆ•ä¸Šçš„å°ç´…é» (åªé¡¯ç¤ºé»ï¼Œä¸é¡¯ç¤ºæ•¸ä½) */
.back-btn-indicator {
    top: 0;
    right: -8px; /* æ”¾åˆ°è¿”å›ç®­é ­å³ä¸Šè§’ */
    width: 10px;
    height: 10px;
    min-width: 10px;
    padding: 0;
    border-radius: 50%;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === è©•è«–åˆ—è¡¨å®¹å™¨ === */
.post-comments-container {
    padding: 10px 0; /* ä¸Šä¸‹ç•™ç™½ */
    display: flex;
    flex-direction: column;
    gap: 8px; /* è©•è«–ä¹‹é–“çš„é–“è· */
    font-size: 13px; /* çµ±ä¸€è©•è«–å€å­—é«”å¤§å° */
}

/* æ¯ä¸€æ¢è©•è«– */
.comment-item {
    line-height: 1.5;
}

/* è©•è«–è€…çš„åå­—ï¼ŒåŠ ç²—ä¸¦ä½¿ç”¨ä¸»é¡Œè‰² */
.comment-item .commenter-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px; /* å’Œè©•è«–å…§å®¹ä¹‹é–“ç•™é»ç©ºéš™ */
}

/* è©•è«–å…§å®¹ */
.comment-item .comment-text {
    color: var(--text-primary);
    word-break: break-word;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === å¸–å­é»è´Šå€åŸŸæ¨£å¼ === */
.post-likes-section {
    display: flex;
    align-items: center;
    gap: 6px; /* åœ–ç¤ºå’Œæ–‡å­—çš„é–“è· */
    padding: 8px 10px; /* å…§é‚Šè· */
    font-size: 13px;
    color: var(--accent-color); /* ä½¿ç”¨ä¸»é¡Œè—è‰² */
    background-color: #f0f5fa; /* çµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯è‰² */
    border-top: 1px solid #e9eef3;
    border-bottom: 1px solid #e9eef3;
    margin-top: 5px; /* å’Œä¸Šæ–¹çš„åœ–ç¤ºä¿æŒä¸€é»è·é›¢ */
}

.post-likes-section .like-icon {
    width: 16px;
    height: 16px;
    fill: currentColor; /* è®“SVGåœ–ç¤ºç¹¼æ‰¿çˆ¶å…ƒç´ çš„é¡è‰² */
    flex-shrink: 0; /* é˜²æ­¢åœ–ç¤ºè¢«å£“ç¸® */
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === @æåŠ å½ˆå‡ºåŠŸèƒ½è¡¨æ¨£å¼ === */
.at-mention-popup {
    position: absolute; /* ç›¸å°äºçˆ¶å…ƒç´ å®šä½ */
    bottom: 100%; /* é¡¯ç¤ºåœ¨è¼¸å…¥æ¡†çš„ä¸Šæ–¹ */
    left: 40px; /* å’Œè¼¸å…¥æ¡†å·¦å´å°é½Š (è€ƒæ…®äº†é ­åƒå¯¬åº¦) */
    width: calc(100% - 40px); /* å¯¬åº¦å’Œè¼¸å…¥æ¡†å·®ä¸å¤š */
    max-height: 120px;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 10;
    display: none; /* é»˜èªéš±è— */
}

.at-mention-item {
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-primary);
    border-bottom: 1px solid #f0f0f0;
}

.at-mention-item:last-child {
    border-bottom: none;
}

.at-mention-item:hover {
    background-color: #f5f5f5;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™æ®µã€æ–°æ¨£å¼ã€‘æ›¿æ›æ‰ä½ ç¾æœ‰çš„ #favorites-list æ¨£å¼ â–¼â–¼â–¼ */

/* è®“æ”¶è—è¦–åœ–æˆç‚ºä¸€å€‹flexå®¹å™¨, å¾ä¸Šåˆ°ä¸‹æ’åˆ— */
#favorites-view {
    display: flex;
    flex-direction: column;
}

/* ç¢ºä¿æ”¶è—é çš„headeré«˜åº¦å›ºå®šï¼Œä¸è¢«å£“ç¸® */
#favorites-view > .header {
    flex-shrink: 0;
}

/* === æ”¶è—æ¸…å–®æ¨£å¼ (ä¿®æ­£å¾Œ) === */
#favorites-list {
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; /* <-- æ–°å¢é€™è¡Œï¼Œç¦æ­¢æ°´æº–æ»¾å‹• */
    padding: 15px; 
    display: flex;
    flex-direction: column;
    gap: 15px; 
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

.favorite-item-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    position: relative; /* ç‚ºäº†å®šä½åˆªé™¤æŒ‰éˆ• */
}

/* å¡ç‰‡é ­éƒ¨ï¼ŒåŒ…å«é ­åƒã€åå­—å’Œä¾†æº */
.fav-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.fav-card-header .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.fav-card-header .info {
    flex-grow: 1;
}

.fav-card-header .name {
    font-weight: 600;
    font-size: 15px;
}

.fav-card-header .source {
    font-size: 12px;
    color: var(--text-secondary);
}

/* å¡ç‰‡å…§å®¹ */
.fav-card-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

.fav-card-content .chat-image {
    margin-top: 8px; /* åœ–ç‰‡å’Œæ–‡å­—çš„é–“è· */
}

/* åˆªé™¤æŒ‰éˆ• */
.fav-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    background: #f0f2f5;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    line-height: 28px;
    text-align: center;
}

.fav-delete-btn:hover {
    background-color: #e9ecef;
    color: #ff3b30;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœç´¢æ¬„æ¨£å¼ === */
.search-bar-container {
    padding: 10px 15px;
    background-color: #f9f9f9; /* å’Œåˆ—è¡¨èƒŒæ™¯è‰²ä¿æŒä¸€è‡´ */
    position: relative; /* ç‚ºäº†å®šä½æ¸…é™¤æŒ‰éˆ• */
    flex-shrink: 0;
}

#favorites-search-input {
    width: 100%;
    padding: 10px 30px 10px 15px; /* å³å´ç•™å‡ºæ¸…é™¤æŒ‰éˆ•çš„ä½ç½® */
    font-size: 14px;
    border: 1px solid var(--border-color);
    border-radius: 18px; /* åœ“è§’çŸ©å½¢ï¼Œæ›´ç¾ä»£åŒ– */
    background-color: var(--secondary-bg);
    box-sizing: border-box;
    outline: none;
}
#favorites-search-input:focus {
    border-color: var(--accent-color);
}

.search-clear-btn {
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ccc;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* === èŠå¤©ä»‹é¢å¤šé¸æ“ä½œæ¬„å„ªåŒ– === */
#chat-interface-screen .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

#chat-interface-screen .selection-controls .action-btn {
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 5px;
}

/* === æ”¶è—é é¢å¤šé¸æ¨¡å¼æ¨£å¼ === */
#favorites-view.selection-mode .favorite-item-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* é¸æ“‡æ¡†çš„æ¨£å¼ */
.favorite-item-card::before {
    content: '';
    position: absolute;
    left: -25px; /* æŠŠå®ƒæ”¾åœ¨å¡ç‰‡å·¦é‚Šå¤–é¢ */
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    background-color: white;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜èªéš±è— */
}

/* é€²å…¥é¸æ“‡æ¨¡å¼æ™‚ï¼Œå¡ç‰‡å‘å³ç§»å‹•ï¼Œéœ²å‡ºé¸æ“‡æ¡† */
#favorites-view.selection-mode .favorite-item-card {
    transform: translateX(35px);
}
#favorites-view.selection-mode .favorite-item-card::before {
    opacity: 1;
}

/* é¸ä¸­å¾Œçš„æ¨£å¼ */
#favorites-view.selection-mode .favorite-item-card.selected::before {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}

/* åº•éƒ¨æ“ä½œæ¬„ (çµ‚æ¥µä¿®æ­£ç‰ˆ) */
#favorites-action-bar {
    position: absolute; /* â˜… æ”¹ç‚º absoluteï¼Œç›¸å°æ–¼ #phone-screen å®šä½ */
    bottom: 0;
    left: 0;
    right: 0;           /* â˜… æ–°å¢ right: 0ï¼Œå’Œ left: 0 ä¸€èµ·æ’æ»¿å¯¬åº¦ */
    width: auto;        /* â˜… æ”¹ç‚º autoï¼Œè®“ left/right æ±ºå®šå¯¬åº¦ */
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* é©é…iPhoneåº•éƒ¨å®‰å…¨å€ */
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    box-sizing: border-box;
    z-index: 5;
    display: none;
    /* max-width å·²ç¶“ä¸éœ€è¦äº†ï¼Œå› ç‚ºçˆ¶å…ƒç´ å·²ç¶“é™åˆ¶äº†å¯¬åº¦ */
}

#favorites-action-bar .action-bar-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}

/* === ã€ä¿®æ­£ã€‘èŠå¤©ä»‹é¢é ­éƒ¨æ§åˆ¶é …åˆ‡æ›é‚è¼¯ === */

/* é è¨­ç‹€æ…‹ï¼šéš±è—å¤šé¸æ§åˆ¶é … */
#chat-interface-screen .header .selection-controls {
    display: none;
}

/* é è¨­ç‹€æ…‹ï¼šé¡¯ç¤ºé è¨­æ§åˆ¶é …ï¼Œä¸¦è®“å®ƒæ’æ»¿æ•´å€‹é ­éƒ¨ */
#chat-interface-screen .header .default-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* ç•¶é€²å…¥å¤šé¸æ¨¡å¼æ™‚ï¼šéš±è—é è¨­æ§åˆ¶é … */
#chat-interface-screen.selection-mode .header .default-controls {
    display: none;
}

/* ç•¶é€²å…¥å¤šé¸æ¨¡å¼æ™‚ï¼šé¡¯ç¤ºå¤šé¸æ§åˆ¶é …ï¼Œä¸¦è®“å®ƒæ’æ»¿æ•´å€‹é ­éƒ¨ */
#chat-interface-screen.selection-mode .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ä¿®æ­£ï¼šæ”¾å¤§æ‰€æœ‰ä¸»è¦çš„â€œ+â€è™ŸæŒ‰éˆ• === */
#add-chat-btn,
#add-world-book-btn,
#create-album-btn-page {
    font-size: 28px;   /* é¡¯è‘—å¢å¤§å­—é«”å¤§å°ï¼Œä½¿å…¶è¦–è¦ºä¸Šèˆ‡æ—é‚Šçš„åœ–ç¤ºåŒ¹é… */
    font-weight: 300;  /* ä½¿ç”¨æ›´ç´°çš„å­—é‡ï¼Œè®“åŠ è™Ÿçœ‹èµ·ä¾†æ›´æ¸…çˆ½ï¼Œä¸é¡¯ç²—ç¬¨ */
    position: relative;/* å…è¨±é€²è¡Œä½ç½®å¾®èª¿ */
    top: -1px;         /* å­—é«”æ”¾å¤§å¾Œï¼Œé€šå¸¸éœ€è¦ç¨å¾®å‘ä¸Šç§»å‹•ä¸€é»ï¼Œä½¿å…¶è¦–è¦ºä¸Šæ›´å±…ä¸­ */
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™äº›æ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* é è¦½å€å®¹å™¨æ¨£å¼ */
#settings-preview-area {
    width: 100%;
    height: 180px; /* çµ¦ä¸€å€‹å›ºå®šçš„é«˜åº¦ */
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 15px;
    box-sizing: border-box;
    overflow: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡º */
    display: flex;
    flex-direction: column;
    gap: 10px; /* é è¦½æ°£æ³¡ä¹‹é–“çš„é–“è· */
    border: 1px solid var(--border-color);
    position: relative; /* ç‚ºäº†å®šä½èƒŒæ™¯ */
}

/* é è¦½å€çš„èƒŒæ™¯ï¼Œå¯ä»¥å’ŒçœŸå¯¦èŠå¤©ä»‹é¢åŒæ­¥ */
#settings-preview-area::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    z-index: 1;
    opacity: 0.8;
}

/* è®“é è¦½æ°£æ³¡åœ¨èƒŒæ™¯ä¹‹ä¸Š */
#settings-preview-area .message-wrapper {
    position: relative;
    z-index: 2;
}

/* é è¦½å€å…§ä½¿ç”¨çš„é ­åƒè¦å°ä¸€é» */
#settings-preview-area .message-bubble .avatar {
    width: 30px;
    height: 30px;
}

#settings-preview-area .message-bubble .timestamp {
    display: none; /* é è¦½å€ä¸éœ€è¦é¡¯ç¤ºæ™‚é–“æˆ³è¨˜ */
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.existing-group-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.existing-group-item .group-name {
    font-weight: 500;
}

.existing-group-item .delete-group-btn {
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-child {
    border-top: 1px solid var(--border-color);
}

.chat-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: var(--secondary-bg); /* <-- ä¿®æ”¹é€™è£¡ï¼Œä½¿ç”¨è®Šæ•¸ */
}


.chat-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

.chat-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}

.chat-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}

.chat-group-content {
    max-height: 1000px; /* ä¸€å€‹è¶³å¤ å¤§çš„å€¼ */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

.chat-group-content.collapsed {
    max-height: 0;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* æ ¼å¼åŠ©æ‰‹æŒ‰éˆ•çš„å®¹å™¨ */
.format-helpers {
    display: flex;
    gap: 10px;
    margin-bottom: 15px; /* èˆ‡ä¸‹æ–¹çš„æ–‡å­—æ–¹å¡Šæ‹‰é–‹è·é›¢ */
    flex-wrap: wrap; /* å¦‚æœæŒ‰éˆ•å¤ªå¤šå¯ä»¥æ›è¡Œ */
}

/* å–®å€‹æ ¼å¼åŠ©æ‰‹æŒ‰éˆ•çš„æ¨£å¼ */
.format-btn {
    background-color: #e9ecef;
    color: var(--text-primary);
    border: none;
    padding: 6px 12px;
    border-radius: 16px; /* è† å›Šå½¢ç‹€ï¼Œæ›´å‹å¥½ */
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.format-btn:hover {
    background-color: #dcdfe3;
}

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â€œâ€¦â€æŒ‰éˆ•çš„æ¨£å¼ */
.post-actions-btn {
    margin-left: auto; /* é—œéµï¼šè®“å®ƒè‡ªå‹•é åˆ°æœ€å³é‚Š */
    padding: 5px 10px;
    font-size: 20px;
    font-weight: bold;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 50%;
    line-height: 1;
}
.post-actions-btn:hover {
    background-color: #f0f0f0;
}

/* å‹•æ…‹ç·¨è¼¯æ¨¡æ…‹æ¡†çš„æ¨£å¼ (å®ƒå°‡è¤‡ç”¨ç¾æœ‰çš„æ“ä½œåŠŸèƒ½è¡¨æ¨£å¼) */
#post-actions-modal .custom-modal-footer button {
    width: 100%;
    border: none;
    border-bottom: 1px solid #dbdbdb;
    padding: 14px;
    font-size: 18px;
}
#post-actions-modal .custom-modal-footer button:last-child {
    border-bottom: none;
}
#post-actions-modal #cancel-post-action-btn {
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f0f0;
}

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* çµ±ä¸€é‡ç½®è½‰å¸³å¡ç‰‡å…§æ‰€æœ‰æ–‡å­—çš„ç‰¹æ•ˆå’Œé¡è‰² */
#chat-messages .transfer-card .transfer-title,
#chat-messages .transfer-card .transfer-amount,
#chat-messages .transfer-card .transfer-note {
    text-shadow: none !important; /* å¼·åˆ¶ç§»é™¤ä»»ä½•ç™¼å…‰æˆ–é™°å½±æ•ˆæœ */
    color: white !important;      /* å¼·åˆ¶é–å®šæ–‡å­—é¡è‰²ç‚ºç™½è‰² */
}

/* åˆ†åˆ¥é–å®šå„è‡ªçš„å­—é«”å¤§å°å’Œå­—é‡ï¼Œé˜²æ­¢è¢«ç¯¡æ”¹ */
#chat-messages .transfer-card .transfer-title {
    font-size: 16px !important;
    font-weight: 600 !important;
}

#chat-messages .transfer-card .transfer-amount {
    font-size: 28px !important;
    font-weight: bold !important;
}

#chat-messages .transfer-card .transfer-note {
    font-size: 13px !important;
    opacity: 0.9 !important;
}

/* â–¼â–¼â–¼ é€™æ˜¯æ–°å¢çš„æ¨£å¼ï¼Œç”¨æ–¼ä¿®æ­£æ‰€æœ‰é ­éƒ¨æ¨™é¡Œçš„å±…ä¸­å•é¡Œ â–¼â–¼â–¼ */
/* â–¼â–¼â–¼ é€™æ˜¯æ–°å¢çš„æ¨£å¼ï¼Œç”¨æ–¼ä¿®æ­£æ‰€æœ‰é ­éƒ¨æ¨™é¡Œçš„å±…ä¸­å•é¡Œ â–¼â–¼â–¼ */
.header > span:nth-child(2) {
    position: absolute;
    left: 50%;
    transform: translateX(calc(-50% - 2px)); /* åœ¨-50%çš„åŸºç¤ä¸Šï¼Œå†å‘å·¦æ¨2åœ–å…ƒ */
    
    /* (å¯é¸ä½†æ¨è–¦) é˜²æ­¢é•·æ¨™é¡Œèˆ‡å…©é‚ŠæŒ‰éˆ•é‡ç–Š */
    max-width: 60%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–è¦ºåŒ–æ¶ˆæ¯ç·¨è¼¯å™¨æ¨£å¼ â–¼â–¼â–¼ */
#message-editor-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message-editor-block {
    background-color: #f9f9f9;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
}

.message-editor-block textarea {
    width: 100%;
    min-height: 60px;
    resize: vertical;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.message-editor-block .format-helpers {
    margin-top: 8px;
    margin-bottom: 0; /* è¦†è“‹é»˜èªçš„ margin-bottom */
}

.message-editor-block .delete-block-btn {
    float: right;
    margin-top: -5px;
    background: none;
    border: none;
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€£çµ¡äººé¸æ“‡å™¨æ¨£å¼ â–¼â–¼â–¼ */
.contact-picker-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.contact-picker-item .checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s ease;
}
.contact-picker-item.selected .checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}
.contact-picker-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}
.contact-picker-item .name {
    font-weight: 500;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå“¡ç®¡ç†ä»‹é¢æ¨£å¼ â–¼â–¼â–¼ */
#member-management-list {
    padding: 0; /* ç§»é™¤é»˜èªpaddingï¼Œè®“åˆ—è¡¨é …æ’æ»¿ */
}

.member-management-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
}

.member-management-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}

.member-management-item .name {
    flex-grow: 1;
    font-weight: 500;
}

.member-management-item .remove-member-btn {
    background-color: #ff3b30;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 20px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    flex-shrink: 0;
}

#member-management-actions {
    flex-shrink: 0;
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: #f7f7f7;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

#member-management-actions button {
    width: 100%;
    padding: 15px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
#member-management-actions #create-new-member-btn {
    background-color: #4cd964; /* æ–°å»ºç”¨ç¶ è‰²ï¼Œä»¥ç¤ºå€åˆ† */
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£ä»£ä»˜å¡ç‰‡æ¨£å¼ â–¼â–¼â–¼ */
.message-bubble.is-waimai-request .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.waimai-card {
    width: 240px;
    border-radius: 12px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

.waimai-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
}

.waimai-header .icon {
    width: 20px;
    height: 20px;
}

.waimai-header .title-group {
    display: flex;
    align-items: baseline;
    font-size: 14px;
    color: #8a8a8a;
}
.waimai-header .title-group .brand {
    font-weight: 600;
    color: #555;
    margin-right: 5px;
}
.waimai-header .title-group .separator {
    margin: 0 5px;
}

.waimai-catchphrase {
    font-size: 13px;
    color: #1f1f1f;
    padding: 12px;
}

.waimai-main {
    background-color: #FFD66B; /* æ©™é»ƒè‰²èƒŒæ™¯ */
    padding: 12px;
    text-align: center;
}

.waimai-main .request-title {
    font-size: 12px;
    color: #856404;
    margin-bottom: 8px;
}

.waimai-main .payment-box {
    background-color: #fff;
    border-radius: 8px;
    padding: 15px 10px;
}

.waimai-main .payment-label {
    font-size: 13px;
    color: #8a8a8a;
}

.waimai-main .amount {
    font-size: 32px;
    font-weight: 700;
    color: #1f1f1f;
    margin: 4px 0 12px 0;
}

.waimai-main .countdown-label {
    font-size: 13px;
    color: #8a8a8a;
}
.waimai-main .countdown-timer {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 5px;
}
.waimai-main .countdown-timer span {
    background-color: #333;
    color: white;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: bold;
    font-size: 12px;
}

.waimai-details-btn {
    width: 100%;
    padding: 10px 0;
    margin-top: 15px;
    border: none;
    border-radius: 6px;
    background-color: #FFC33A;
    color: #49380a;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£å›æ‡‰ç‹€æ…‹æ¨£å¼ â–¼â–¼â–¼ */

/* === åŒæ„æ”¯ä»˜å¾Œçš„æ¨£å¼ === */
.message-bubble.status-paid .waimai-card {
    border: 2px solid #28a745; /* ç¶ è‰²é‚Šæ¡† */
}
.message-bubble.status-paid .waimai-main .request-title::before {
    content: 'âœ…  ';
}
.message-bubble.status-paid .waimai-main .request-title {
    color: #155724;
    font-weight: 600;
    /* é‡å¯« request-title çš„å…§å®¹ */
    content: "æˆ‘å·²ç‚ºæ‚¨è²·å–®ï¼Œè«‹ç›¡æƒ…äº«ç”¨å§ï½" !important;
    display: block;
    margin-bottom: 15px;
}

.message-bubble.status-paid .payment-box {
    display: none; /* éš±è—æ”¯ä»˜è©³æƒ… */
}
.message-bubble.status-paid .waimai-details-btn {
    background-color: #28a745;
    color: white;
}

/* === æ‹’çµ•æ”¯ä»˜å¾Œçš„æ¨£å¼ === */
.message-bubble.status-rejected .waimai-card {
    border: 2px solid #dc3545; /* ç´…è‰²é‚Šæ¡† */
    opacity: 0.8;
}
.message-bubble.status-rejected .waimai-main {
    background-color: #e9ecef;
}
.message-bubble.status-rejected .waimai-main .request-title::before {
    content: 'âŒ ';
}
.message-bubble.status-rejected .waimai-main .request-title {
    color: #721c24;
    font-weight: 600;
    /* é‡å¯« request-title çš„å…§å®¹ */
    content: "æˆ‘æ‹’çµ•äº†æ‚¨çš„ä»£ä»˜è«‹æ±‚" !important;
    display: block;
    margin-bottom: 15px;
}
.message-bubble.status-rejected .payment-box {
    display: none; /* éš±è—æ”¯ä»˜è©³æƒ… */
}
 .message-bubble.status-rejected .waimai-details-btn {
    background-color: #6c757d;
    color: white;
}

/* å¼·åˆ¶é‡å¯« request-title å…§å®¹çš„æŠ€å·§ */
.message-bubble[class*="status-"] .request-title {
    font-size: 0; /* éš±è—åŸå§‹æ–‡æœ¬ */
}
.message-bubble[class*="status-"] .request-title::after {
    font-size: 14px; /* è®“å½å…ƒç´ é¡¯ç¤ºæ–°æ–‡æœ¬ */
}
.message-bubble.status-paid .request-title::after {
    content: "æˆ‘å·²ç‚ºæ‚¨è²·å–®ï¼Œè«‹ç›¡æƒ…äº«ç”¨å§ï½";
}
.message-bubble.status-rejected .request-title::after {
    content: "æˆ‘æ‹’çµ•äº†æ‚¨çš„ä»£ä»˜è«‹æ±‚";
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£è«‹æ±‚çš„ä½¿ç”¨è€…æ“ä½œæŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */
.waimai-user-actions {
    display: flex;
    gap: 10px;
    padding: 0 12px 12px 12px; /* åœ¨å¡ç‰‡åº•éƒ¨ç•™å‡ºç©ºé–“ */
    background-color: #fff;
}

.waimai-user-actions button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1.5px solid;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.waimai-pay-btn {
    background-color: #28a745;
    border-color: #1f7a33;
    color: white;
}
.waimai-pay-btn:hover {
    background-color: #218838;
}

.waimai-decline-btn {
    background-color: #f8f9fa;
    border-color: #ced4da;
    color: #495057;
}
.waimai-decline-btn:hover {
    background-color: #e2e6ea;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* ç¢ºä¿é€™äº›é é¢çš„å…§å®¹å€èƒ½æ­£ç¢ºæ»¾å‹•ï¼ŒåŒæ™‚èƒŒæ™¯é€æ˜ä»¥é¡¯ç¤ºçˆ¶ç´šé¡è‰² */
#api-settings-screen .form-container,
#font-settings-screen .form-container,
#wallpaper-screen .form-container {
    padding-top: 100px;
    margin-top: -80px;
    /* ä¸å†éœ€è¦èƒŒæ™¯è‰²ï¼Œè®“çˆ¶å…ƒç´ æ±ºå®š */
}
#font-settings-screen,
#wallpaper-screen {
    /* å°‡èƒŒæ™¯è‰²è¨­ç½®ç‚ºè®Šæ•¸ï¼Œé€™æ¨£å¤œé–“æ¨¡å¼æ‰èƒ½è¦†è“‹å®ƒ */
    background-color: var(--secondary-bg);
}
/* å£ç´™è¨­ç½®é é¢çš„é è¦½å€æ¯”è¼ƒç‰¹æ®Šï¼Œéœ€è¦é¡å¤–èª¿æ•´ */
#wallpaper-screen .form-container {
    align-items: center; /* ä¿æŒå…§å®¹å±…ä¸­ */
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¾†é›»è«‹æ±‚èˆ‡è¦–é »é€šè©±ä»‹é¢æ¨£å¼ â–¼â–¼â–¼ */

/* --- ä¾†é›»è«‹æ±‚æ¨¡æ…‹æ¡† --- */
#incoming-call-modal .incoming-call-content {
    background-color: rgba(40, 40, 40, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    width: 280px;
    padding: 30px 20px;
    text-align: center;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.caller-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 12px;
    border: 3px solid rgba(255,255,255,0.5);
}

.caller-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 5px;
}

.caller-text {
    font-size: 14px;
    color: #ccc;
    margin-bottom: 30px;
}

.incoming-call-actions {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.action-button-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}

.call-action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-size: 50%;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.call-action-btn:active {
    transform: scale(0.9);
}

.call-action-btn.decline {
    background-color: #ff3b30;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
}

.call-action-btn.accept {
    background-color: #4cd964;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
    100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
}

/* â–¼â–¼â–¼ è«‹ç”¨é€™ä¸€æ•´å¡Šã€æœ€çµ‚çµæ§‹é‡å¯«ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰€æœ‰èˆŠçš„ video-call ç›¸é—œCSS â–¼â–¼â–¼ */

/* 1. é€šè©±è¢å¹•ç¸½å®¹å™¨ (ä¿æŒä¸è®Š) */
#video-call-screen {
    background-color: #1c1c1e;
    color: white;
    display: flex; /* â˜… æ ¸å¿ƒï¼šå®ƒä¾ç„¶æ˜¯flexå®¹å™¨ */
    flex-direction: column;
    overflow: hidden;
}

/* 2. é ‚éƒ¨æ¬„å’Œåº•éƒ¨æ§åˆ¶æ¬„ (ä¿æŒä¸è®Š) */
.video-call-top-bar, .video-call-controls {
    position: absolute;
    left: 0;
    width: 100%;
    z-index: 10;
    box-sizing: border-box;
    pointer-events: none; /* è®“å®ƒå€‘ä¸å½±éŸ¿ä¸‹æ–¹å…§å®¹çš„é»æ“Š */
}
.video-call-top-bar {
    top: 0;
    padding: 15px 20px 30px; /* å¢åŠ åº•éƒ¨padding */
    padding-top: 50px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    text-align: center;
}
.video-call-controls {
    bottom: 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 20px;
    padding-bottom: 40px;
    background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
    pointer-events: all; /* æ§åˆ¶æŒ‰éˆ•éœ€è¦èƒ½é»æ“Š */
}
#call-timer {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
}

/* 3. ã€æ ¸å¿ƒé‡æ§‹ã€‘é è¨­æ–‡å­—é€šè©±çš„ç¸½å®¹å™¨ */
#text-call-interface {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

/* 4. ã€æ ¸å¿ƒé‡æ§‹ã€‘é ­åƒå€åŸŸ */
.video-call-avatar-area {
    flex-shrink: 0; /* â˜… æ ¸å¿ƒï¼šé«˜åº¦é›·æ‰“ä¸å‹•ï¼Œçµ•ä¸å£“ç¸® */
    display: flex;
    justify-content: center;
    align-items: center;
    padding-top: 100px; /* â˜… æ ¸å¿ƒï¼šèˆ‡é ‚éƒ¨ç‹€æ…‹åˆ—æ‹‰é–‹è·é›¢ */
    padding-bottom: 20px; /* â˜… æ ¸å¿ƒï¼šèˆ‡ä¸‹æ–¹æ°£æ³¡å€æ‹‰é–‹è·é›¢ */
}

/* 5. ã€æ ¸å¿ƒé‡æ§‹ã€‘æ°£æ³¡å€åŸŸ */
#video-call-main {
    flex-grow: 1; /* â˜… æ ¸å¿ƒï¼šä½”æ“šæ‰€æœ‰å‰©é¤˜çš„å‚ç›´ç©ºé–“ */
    min-height: 0; /* â˜… æ ¸å¿ƒï¼šä¸€å€‹é˜²æ­¢flexæº¢å‡ºçš„é‡è¦ä¿éšªçµ² */
    margin: 0 15px 130px 15px; /* â˜… æ ¸å¿ƒï¼šå®šç¾©å››å‘¨é‚Šç•Œï¼Œåº•éƒ¨ç•™è¶³ç©ºé–“çµ¦æŒ‰éˆ• */
    overflow-y: auto;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.08); /* ç¨å¾®èª¿äº®ä¸€é»èƒŒæ™¯ */
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* 6. é ­åƒç¶²æ ¼å’Œé ­åƒæœ¬èº«æ¨£å¼ (å¾®èª¿) */
#participant-avatars-grid {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
}
.participant-avatar-wrapper {
    text-align: center;
}
.participant-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}
.participant-name {
    margin-top: 8px;
    font-size: 13px;
    color: #ccc;
}
.participant-avatar.speaking {
    border-color: #4cd964;
    box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
    transform: scale(1.05);
}

/* 7. æ§åˆ¶æŒ‰éˆ•æ¨£å¼ (ä¿æŒä¸è®Š) */
.control-btn {
    width: 70px; height: 70px; border-radius: 50%; border: none; cursor: pointer;
    background-repeat: no-repeat; background-position: center;
    transition: transform 0.2s, background-color 0.2s;
    pointer-events: all;
}
.control-btn:active { transform: scale(0.9); }
.control-btn.speak-btn { background-color: rgba(255,255,255,0.2); background-size: 55%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>'); }
.control-btn.hangup-btn { background-color: #ff3b30; background-size: 50%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>'); }
.control-btn.join-btn { background-color: #007bff; background-size: 50%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>'); }

/* â–²â–²â–² æ–°CSSæ›¿æ›çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–é »é€šè©±å°è©±æ°£æ³¡æ¨£å¼ â–¼â–¼â–¼ */
.call-message-bubble {
    padding: 10px 15px;
    border-radius: 12px;
    max-width: 85%;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
}

.call-message-bubble.ai-speech {
    background-color: rgba(255, 255, 255, 0.15);
    align-self: flex-start; /* AIç™¼è¨€é å·¦ */
}

.call-message-bubble.user-speech {
    background-color: #4cd964; /* ç”¨æˆ¶ç™¼è¨€ç”¨ç¶ è‰²ï¼Œé¡ä¼¼å¾®ä¿¡ */
    align-self: flex-end;   /* ç”¨æˆ¶ç™¼è¨€é å³ */
    text-align: left; /* ç¢ºä¿ä½¿ç”¨è€…æ°£æ³¡å…§çš„æ–‡å­—æ˜¯å·¦å°é½Šçš„ */
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ä»‹é¢æ¨£å¼ â–¼â–¼â–¼ */
#outgoing-call-screen {
    background-color: #1c1c1e;
    color: white;
    justify-content: center; /* å‚ç›´å±…ä¸­ */
    align-items: center;   /* æ°´æº–å±…ä¸­ */
}

.outgoing-call-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.outgoing-call-actions {
    margin-top: 50px; /* å’Œä¸Šæ–¹æ–‡å­—æ‹‰é–‹è·é›¢ */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}
/* â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² */

/* 1. å‹•æ…‹å¸–å­çš„å¤–å±¤å®¹å™¨ï¼Œæˆ‘å€‘éœ€è¦å®ƒä¾†å®šä½å’Œè£å‰ª */
.qzone-post-container {
    position: relative; /* è®“å…§éƒ¨çš„åˆªé™¤æŒ‰éˆ•å¯ä»¥ç›¸å°æ–¼å®ƒå®šä½ */
    overflow: hidden;   /* éš±è—æ‰è¶…å‡ºéƒ¨åˆ†çš„åˆªé™¤æŒ‰éˆ• */
    border-radius: 12px;/* å’Œå…§éƒ¨å¡ç‰‡ä¿æŒä¸€è‡´çš„åœ“è§’ */
}

/* 2. å¯æ»‘å‹•çš„å…§å®¹å¡ç‰‡ï¼Œå¢åŠ ä¸€å€‹å¹³æ»‘çš„éæ¸¡æ•ˆæœ */
.qzone-post-item {
    transition: transform 0.3s ease;
    background-color: var(--secondary-bg); /* ç¢ºä¿å®ƒæœ‰èƒŒæ™¯è‰²ï¼Œèƒ½è“‹ä½ä¸‹é¢çš„åˆªé™¤æŒ‰éˆ• */
    position: relative; /* ç¢ºä¿å®ƒåœ¨æœ€ä¸Šå±¤ */
    z-index: 2;
}

/* 3. ã€æ ¸å¿ƒã€‘é€™å°±æ˜¯é‚£å€‹â€œåˆªé™¤â€æŒ‰éˆ•çš„æ¨£å¼ï¼*/
.qzone-post-delete-action {
    position: absolute; /* çµ•å°å®šä½ï¼Œè„«é›¢æ–‡æª”æµ */
    top: 0;
    right: 0;
    bottom: 0;
    width: 90px; /* åˆªé™¤æŒ‰éˆ•çš„å¯¬åº¦ */
    background-color: #ff3b30; /* æ‚¨æƒ³è¦çš„ç´…è‰²èƒŒæ™¯ */
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    cursor: pointer;
    z-index: 1; /* ç¢ºä¿å®ƒåœ¨å¡ç‰‡ä¸‹é¢ */
}

/* 4. ç•¶å¡ç‰‡å·¦æ»‘æ™‚ï¼ŒæŠŠå®ƒå‘å·¦ç§»å‹•ï¼Œéœ²å‡ºåˆªé™¤æŒ‰éˆ• */
.qzone-post-item.swiped {
    transform: translateX(-90px); /* ç§»å‹•çš„è·é›¢å’Œåˆªé™¤æŒ‰éˆ•çš„å¯¬åº¦ä¸€è‡´ */
}

/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„â€œæ‹ä¸€æ‹â€æ¨£å¼ï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. â€œæ‹ä¸€æ‹â€çš„è¢å¹•éœ‡å‹•å‹•ç•« */
@keyframes pat-shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
    20%, 40%, 60%, 80% { transform: translateX(3px); }
}

.pat-animation {
    animation: pat-shake 0.4s ease-in-out;
}

/* 2. â€œæ‹ä¸€æ‹â€ç³»çµ±æç¤ºæ¶ˆæ¯çš„æ¨£å¼ */
.system-message {
    align-self: center; /* å±…ä¸­é¡¯ç¤º */
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* è®“â€œæ‹ä¸€æ‹â€é¡å‹çš„ wrapper å±…ä¸­ */
.message-wrapper.system-pat {
    justify-content: center;
    align-self: center;
    margin: 5px 0;
    max-width: 80%;
}
/* â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯æ°£æ³¡çš„æ¨£å¼ */
.message-bubble.system-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 10px;
}

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ä¿®æ­£ï¼šè®“é ‚éƒ¨æ“ä½œæ¬„å¯ä»¥æ©«å‘æ»¾å‹• === */
#chat-input-actions-top {
    display: flex;
    gap: 8px;
    padding: 0 5px;

    /* --- æ ¸å¿ƒä»£ç¢¼é–‹å§‹ --- */
    overflow-x: auto;      
    flex-wrap: nowrap;     
    -webkit-overflow-scrolling: touch; 

    scrollbar-width: none; 
    -ms-overflow-style: none;  
}

#chat-input-actions-top::-webkit-scrollbar {
    display: none; 
}

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* === ã€å…¨æ–°ã€‘èŠå¤©ä»‹é¢é ­éƒ¨ç‹€æ…‹åˆ—æ¨£å¼ === */

/* === ã€å…¨æ–°ã€‘èŠå¤©ä»‹é¢é ­éƒ¨ç‹€æ…‹åˆ—æ¨£å¼ === */

/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€å±…ä¸­ä¿®å¾©ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ #chat-header-title-wrapper æ¨£å¼ â–¼â–¼â–¼ */
#chat-header-title-wrapper {
    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šè®“æ¨™é¡Œå€åŸŸçµ•å°å±…ä¸­ --- */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    /* ------------------------------------ */
    
    /* ä¿æŒå…¶å…§éƒ¨å…ƒç´ ï¼ˆæ¨™é¡Œå’Œç‹€æ…‹ï¼‰çš„ä½ˆå±€ä¸è®Š */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px; 
    
    /* (å¯é¸ä½†æ¨è–¦) é˜²æ­¢é•·æ¨™é¡Œèˆ‡å…©é‚ŠæŒ‰éˆ•é‡ç–Š */
    max-width: 60%;
    
    /* æ³¨æ„ï¼šæˆ‘å€‘ä¸å†éœ€è¦ flex-grow: 1; äº†ï¼Œå› ç‚ºçµ•å°å®šä½å·²ç¶“ä½¿å…¶è„«é›¢äº†flexä½ˆå±€æµ */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* ã€æ–°å¢ã€‘é€™æ˜¯æˆ‘å€‘æ–°åŠ çš„æ¨£å¼ï¼Œç”¨æ–¼å°‡æ¨™é¡Œå’Œå¿ƒå½¢æŒ‰éˆ•æ©«å‘æ’åˆ— */
#chat-header-main-line {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px; /* æ¨™é¡Œå’Œå¿ƒå½¢æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
}


/* â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šã€çµ‚æ¥µä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ #chat-header-title æ¨£å¼ â–¼â–¼â–¼ */
#chat-header-title {
    font-size: 16px;
    font-weight: 600;
    
    /* (é€™å…©è¡Œæ˜¯ä¸Šæ¬¡ä¿®å¾©å®šä½å•é¡Œçš„ï¼Œå¿…é ˆä¿ç•™ï¼) */
    position: static !important;
    transform: none !important;

    /* â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©ï¼šæˆ‘å€‘å·²ç¶“æŠŠå°è‡´çœç•¥è™Ÿçš„å››è¡Œä»£ç¢¼å…¨éƒ¨åˆªæ‰äº†ï¼ â˜…â˜…â˜… */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */




/* 3. ç‹€æ…‹åˆ—å®¹å™¨ */
#chat-header-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

/* 4. ç‹€æ…‹å°åœ“é» */
.status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background-color: #4cd964; /* é»˜èªç¶ è‰²ï¼Œä»£è¡¨ç·šä¸Š */
    transition: background-color 0.3s ease;
}

/* ç•¶AIç‹€æ…‹ç‚ºâ€œå¿™ç¢Œâ€æˆ–â€œé›¢é–‹â€æ™‚ï¼Œè®“åœ“é»è®Šç°è‰² */
#chat-header-status.busy .status-dot {
    background-color: #cccccc;
}

/* 5. ç‹€æ…‹æ–‡æœ¬ */
.status-text {
    font-weight: 500;
}

/* === ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘å›æ†¶å¡ç‰‡æ¨£å¼ === */

/* 1. å¡ç‰‡ç¸½å®¹å™¨ï¼šé€™è£¡è² è²¬å®šç¾©æ•´é«”çš„èƒŒæ™¯è‰²å’Œé‚Šæ¡† */
.memory-card {
    background-color: #fffaf0; /* çµ±ä¸€çš„ã€æº«æš–çš„ç±³é»ƒè‰²èƒŒæ™¯ */
    border-radius: 12px;
    padding: 15px; /* åœ¨å¡ç‰‡å››å‘¨ç•™å‡ºå…§é‚Šè· */
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    border-left: 5px solid #ffb74d; 
    display: flex; /* è®“å®ƒæˆç‚ºflexå®¹å™¨ï¼Œæ–¹ä¾¿å…§éƒ¨å…ƒç´ æ’åˆ— */
    flex-direction: column; /* è®“é ­éƒ¨å’Œå…§å®¹å‚ç›´å †ç–Š */
    gap: 8px; /* åœ¨é ­éƒ¨å’Œå…§å®¹ä¹‹é–“å‰µé€ ä¸€å€‹è‡ªç„¶çš„é–“è· */
}

/* 2. é ­éƒ¨å®¹å™¨ï¼šç¾åœ¨åªè² è²¬ä½ˆå±€å’Œåˆ†å‰²ç·š */
.memory-card .header {
    border-bottom: 1px solid rgba(217, 129, 0, 0.15); /* åˆ†å‰²ç·šé¡è‰²å¯ä»¥ç¨å¾®åŠ æ·±ä¸€é» */
    padding-bottom: 8px; 
}

/* 3. æ—¥æœŸæ¨£å¼ (ä¿æŒä¸è®Š) */
.memory-card .header .date {
    font-size: 11px;
    color: #a1887f;
    margin-bottom: 4px; 
}

/* 4. ä½œè€…æ¨£å¼ (ä¿æŒä¸è®Š) */
.memory-card .header .author {
    font-weight: 600;
    color: #d98100;
    font-size: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 5. å…§å®¹å€æ¨£å¼ (ä¿æŒä¸è®Š) */
.memory-card .content {
    font-size: 14px;
    line-height: 1.7;
    color: #5d4037;
    white-space: pre-wrap;
}

/* === ã€å…¨æ–°ã€‘ç´„å®š/å€’è¨ˆæ™‚å¡ç‰‡æ¨£å¼ === */
.countdown-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
    text-align: center;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}
.countdown-card::before {
    content: 'âœ¨';
    position: absolute;
    top: -10px;
    left: -10px;
    font-size: 50px;
    opacity: 0.1;
    transform: rotate(-15deg);
}
.countdown-card .title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
}
.countdown-card .timer {
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    margin-bottom: 15px;
}
.countdown-card .target-date {
    font-size: 12px;
    opacity: 0.8;
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 10px;
}

/* === ã€å…¨æ–°ã€‘èŠå¤©é–å®šé®ç½©å±¤æ¨£å¼ === */
#chat-lock-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 150; /* æ¯”è¼¸å…¥æ¡†é«˜ï¼Œæ¯”è²¼ç´™é¢æ¿ä½ */
    display: none; /* é»˜èªéš±è— */
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    border-top: 1px solid var(--border-color);
    text-align: center;
}
#chat-lock-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
#chat-lock-content .lock-text {
    color: var(--text-secondary);
    font-size: 14px;
}
#chat-lock-content .lock-action-btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: 1px solid var(--accent-color);
    background-color: var(--accent-color);
    color: white;
    cursor: pointer;
}
#chat-lock-content .lock-action-btn.secondary {
    background-color: transparent;
    color: var(--accent-color);
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…å¡ç‰‡æ¨£å¼ â–¼â–¼â–¼ */
.message-bubble.is-red-packet .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.red-packet-card {
    width: 220px;
    border-radius: 8px;
    background: linear-gradient(160deg, #F96259, #E44D44);
    color: #ffd700; /* é‡‘è‰²æ–‡å­— */
    padding: 12px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.red-packet-card.opened {
    background: linear-gradient(160deg, #d3c4a0, #c4b693);
    cursor: default;
}

.red-packet-card::before {
    content: 'ğŸ§§';
    position: absolute;
    top: -5px;
    left: -5px;
    font-size: 30px;
    opacity: 0.2;
    transform: rotate(-10deg);
}

.rp-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.rp-icon {
    width: 20px;
    height: 20px;
}

.rp-greeting {
    font-size: 15px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.rp-type {
    font-size: 11px;
    color: white;
    opacity: 0.8;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 8px;
    margin-top: 8px;
}

.rp-claimed-info {
    font-size: 13px;
    color: white;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.3);
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…è©³æƒ…æ¸…å–®æ¨£å¼ â–¼â–¼â–¼ */
.rp-details-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.rp-details-item:last-child {
    border-bottom: none;
}
.rp-details-item .name {
    flex-grow: 1;
    font-weight: 500;
    color: #333;
}
.rp-details-item .amount {
    font-weight: 500;
    color: #555;
}
.rp-details-item .lucky-king-tag {
    font-size: 10px;
    background-color: #ffd700;
    color: #a67c00;
    padding: 2px 5px;
    border-radius: 4px;
    margin-left: 8px;
    font-weight: bold;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* æŠ•ç¥¨å¡ç‰‡åœ¨æ¶ˆæ¯æ°£æ³¡ä¸­çš„æ¨£å¼ */
.message-bubble.is-poll .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* æŠ•ç¥¨å¡ç‰‡ä¸»é«” */
.poll-card {
    width: 250px;
    background-color: #f9f9f9;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.poll-card.closed {
    background-color: #e9ecef; /* çµæŸå¾Œè®Šç° */
}

/* æŠ•ç¥¨å•é¡Œ */
.poll-question {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 12px;
    line-height: 1.4;
    word-break: break-word;
}

/* æŠ•ç¥¨é¸é …æ¸…å–® */
.poll-options-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* å–®å€‹æŠ•ç¥¨é¸é … */
.poll-option-item {
    background-color: white;
    border: 1px solid #dcdcdc;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: background-color 0.2s;
}

.poll-card:not(.closed) .poll-option-item:hover {
    background-color: #f0f8ff;
}

/* ä½¿ç”¨è€…å·²æŠ•ç¥¨çš„é¸é …æ¨£å¼ */
.poll-option-item.voted {
    border-color: var(--accent-color);
    background-color: #e7f3ff;
    font-weight: 500;
}

/* æŠ•ç¥¨é€²åº¦æ¢ */
.poll-option-bar {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background-color: rgba(0, 123, 255, 0.1);
    z-index: 1;
    transition: width 0.3s ease-in-out;
}

/* é¸é …å…§å®¹ï¼ˆæ–‡å­—å’Œç¥¨æ•¸ï¼‰ï¼Œç¢ºä¿åœ¨é€²åº¦æ¢ä¹‹ä¸Š */
.poll-option-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.poll-option-text {
    font-size: 14px;
}

.poll-option-votes {
    font-size: 13px;
    color: #8a8a8a;
    font-weight: 500;
}

/* æŠ•ç¥¨å¡ç‰‡åº•éƒ¨ */
.poll-footer {
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid #e9e9e9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-secondary);
}

.poll-total-votes {
    font-weight: 500;
}

.poll-action-btn {
    background: none;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    padding: 4px 10px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
}
.poll-card.closed .poll-action-btn {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}

/* å‰µå»ºæŠ•ç¥¨æ¨¡æ…‹æ¡†çš„é¸é …è¼¸å…¥ */
.poll-option-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}
.poll-option-input-wrapper input {
    flex-grow: 1;
}
.poll-option-input-wrapper .remove-option-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #f0f0f0;
    color: #ff3b30;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    flex-shrink: 0;
}

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* === ã€å…¨æ–°ã€‘èŠå¤©é ­éƒ¨â€œæ­£åœ¨è¼¸å…¥â€ç‹€æ…‹æ¨£å¼ === */
#chat-header-title.typing-status {
    color: var(--text-secondary);
    animation: typing-pulse 1.5s infinite;
    font-style: italic;
}

@keyframes typing-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

#chat-header-title {
    transition: opacity 0.2s ease-in-out;
}

@keyframes message-pop-in {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-wrapper.animate-in {
  animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
  }

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Appåœ–ç¤ºè¨­ç½®æ¨£å¼ â–¼â–¼â–¼ */
#icon-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 20px;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
}

.icon-setting-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.icon-preview {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.change-icon-btn {
    padding: 4px 10px;
    font-size: 12px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è§€è¨­ç½®é é¢é…ç½®ä¿®æ­£ â–¼â–¼â–¼ */

/* 1. ä¿®æ­£æ»¾å‹•å•é¡Œ */
#wallpaper-screen .form-container {
    /* æ ¸å¿ƒä¿®æ­£1: è§£æ±ºflexä½ˆå±€ä¸‹çš„æ»¾å‹•è¡çªï¼Œè®“æ²è»¸èƒ½æ­£å¸¸å‡ºç¾ */
    min-height: 0; 
}

/* 2. ä¿®æ­£å£ç´™é è¦½è¢«å£“æ‰çš„å•é¡Œ */
#wallpaper-preview {
    /* æ ¸å¿ƒä¿®æ­£2: é˜²æ­¢é è¦½æ¡†è¢«éå¤šçš„å…§å®¹æ“ å£“è®Šå½¢ï¼Œè®“å®ƒä¿æŒè‡ªå·±çš„é«˜åº¦ */
    flex-shrink: 0; 
}
/* â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é€£çµåŠŸèƒ½æ¨£å¼ (ç„¡åœ–ç‰ˆ) â–¼â–¼â–¼ */

/* 1. æµè¦½å™¨ä»‹é¢èƒŒæ™¯è‰²å’Œå…§å®¹å€æ¨£å¼ (ä¿æŒä¸è®Š) */
#browser-screen {
    background-color: #f8f9fa;
}
#browser-content {
    padding: 20px;
    font-size: 16px;
    line-height: 1.8;
    color: #333;
    overflow-y: auto;
    background-color: #f8f9fa;
}
#browser-content .article-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
}
#browser-content .article-meta {
    font-size: 13px;
    color: #8a8a8a;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}
#browser-content .article-body {
    white-space: pre-wrap;
    word-break: break-word;
}
#browser-content .article-body p {
    margin-bottom: 1em;
}

/* 2. èŠå¤©æ°£æ³¡ä¸­çš„é€£çµå¡ç‰‡æ¨£å¼ (ç„¡åœ–ç‰ˆ) */
.message-bubble.is-link-share .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.link-share-card {
    width: 210px; 
    background-color: #fff;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.link-share-card:hover {
    background-color: #f9f9f9;
}

.link-share-card .title {
    font-weight: 600;
    font-size: 15px;
    line-height: 1.4;
    color: #1f1f1f;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .description {
    font-size: 13px;
    color: #8a8a8a;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .footer {
    display: flex; /* è®“åœ–ç¤ºå’Œæ–‡å­—æ°´æº–å°é½Š */
    align-items: center;
    gap: 6px; /* åœ–ç¤ºå’Œæ–‡å­—çš„é–“è· */
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px; /* å’Œä¸Šé¢çš„æè¿°æ‹‰é–‹ä¸€é»è·é›¢ */
}
.link-share-card .footer-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0; /* é˜²æ­¢åœ–ç¤ºè¢«å£“ç¸® */
}

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* å–®æ¢è©•è«–çš„å®¹å™¨ï¼Œç¾åœ¨éœ€è¦ç›¸å°å®šä½ */
.comment-item {
    position: relative;
    padding-right: 25px; /* åœ¨å³å´ç•™å‡ºåˆªé™¤æŒ‰éˆ•çš„ç©ºé–“ */
}

/* è©•è«–åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
.comment-delete-btn {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    border-radius: 50%;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜èªéš±è— */
}

/* æ»‘é¼ æ‡¸åœåœ¨è©•è«–ä¸Šæ™‚ï¼Œé¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
.comment-item:hover .comment-delete-btn {
    opacity: 1;
}

.comment-delete-btn:hover {
    background-color: #f0f0f0;
    color: #ff3b30;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€è«‹æ±‚7ã€‘ä¸»è¢å¹•é è¨­ä¿å­˜æŒ‰éˆ•ä¸»é¡Œè‰²é©é… (è«‹å°‡é€™å¡Šä»£ç¢¼ä¹Ÿé»è²¼åˆ° <style> çš„æœ«å°¾) â–¼â–¼â–¼ */
#save-home-preset-btn {
    background-color: var(--accent-color);
    color: white;
}
/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨å›å¾©åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è¼¸å…¥æ¡†ä¸Šæ–¹çš„â€œå›å¾©é è¦½æ¬„â€ */
#reply-preview-bar {
    display: none; /* é»˜èªéš±è— */
    padding: 8px 12px;
    margin: 0 8px 8px 8px; /* å’Œè¼¸å…¥æ¡†å‘¨åœçš„é‚Šè·ä¿æŒä¸€è‡´ */
    background-color: rgba(0, 0, 0, 0.05);
    border-left: 3px solid var(--accent-color);
    border-radius: 6px;
    position: relative;
    font-size: 13px;
    color: var(--text-secondary);
}

#phone-screen.dark-mode #reply-preview-bar {
    background-color: rgba(255, 255, 255, 0.1);
}

.reply-preview-content .sender {
    font-weight: 600;
    color: var(--text-primary);
}

.reply-preview-content .text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block; /* ç¢ºä¿çœç•¥è™Ÿç”Ÿæ•ˆ */
    max-width: 95%;
}

#cancel-reply-btn {
    position: absolute;
    top: 50%;
    right: 8px;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    border-radius: 50%;
    background-color: rgba(0,0,0,0.1);
    cursor: pointer;
    font-size: 14px;
}

/* 2. æ¶ˆæ¯æ°£æ³¡å…§éƒ¨çš„â€œå¼•ç”¨æ¶ˆæ¯å¡Šâ€ */
.quoted-message {
    padding: 6px 10px;
    margin-bottom: 6px;
    background-color: rgba(0, 0, 0, 0.04);
    border-left: 2px solid var(--accent-color);
    border-radius: 4px;
    font-size: 0.9em; /* å­—é«”æ¯”æ­£æ–‡å°ä¸€é» */
    opacity: 0.8;
    /* (å·²ç§»é™¤ overflow: hidden;) */
}

#phone-screen.dark-mode .quoted-message {
    background-color: rgba(255, 255, 255, 0.08);
    border-left-color: #a0cff1;
}

.quoted-message .quoted-sender {
    font-weight: 600;
    color: var(--accent-color);
}
#phone-screen.dark-mode .quoted-message .quoted-sender {
    color: #a0cff1;
}

.quoted-message .quoted-content {
    color: var(--text-secondary);
    white-space: normal;     /* æ ¸å¿ƒä¿®æ­£1: å…è¨±æ–‡æœ¬æ­£å¸¸æ›è¡Œ */
    word-break: break-word;  /* æ ¸å¿ƒä¿®æ­£2: å¼·åˆ¶é•·å–®è©æˆ–é€£çºŒå­—å…ƒæ–·é–‹ï¼Œé˜²æ­¢æº¢å‡º */
    display: block;
    /* (å·²ç§»é™¤ overflow å’Œ text-overflowï¼Œå› ç‚ºæˆ‘å€‘éœ€è¦å¤šè¡Œé¡¯ç¤ºè€Œä¸æ˜¯å–®è¡Œçœç•¥è™Ÿ) */
}

/* === å­—é«”é è¦½æ¡†æ¨£å¼ (ä¿®æ­£å¾Œ) === */

/* å°‡å®ƒä¿®æ”¹ç‚º â–¼â–¼â–¼ */
#font-preview {
    padding: 20px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: #f0f2f5; /* çµ±ä¸€ç‚ºæ›´æ·ºçš„ç°è‰²ï¼Œç„¶å¾Œè®“å¤œé–“æ¨¡å¼CSSå»è¦†è“‹ */
    transition: background-color 0.3s, border-color 0.3s;
}

/* é è¦½æ¡†è£¡çš„æ–‡å­—é¡è‰²ï¼Œé è¨­æ˜¯é»‘è‰² */
#font-preview p {
    color: var(--text-primary);
}

/* å¤œé–“æ¨¡å¼ä¸‹çš„ä¿®æ­£æ¨£å¼ */
#phone-screen.dark-mode #font-preview {
    background-color: #1c1c1e; /* æ·±ç°è‰²èƒŒæ™¯ */
    border-color: #38383a;     /* æš—è‰²é‚Šæ¡† */
}

/* å¤œé–“æ¨¡å¼ä¸‹ï¼Œé è¦½æ¡†è£¡çš„æ–‡å­—è®Šç‚ºç™½è‰² */
#phone-screen.dark-mode #font-preview p {
    color: #ffffff;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾ç·»ç‰ˆè½‰å¸³æ“ä½œå½ˆçª—æ¨£å¼ â–¼â–¼â–¼ */
.transfer-actions-content {
    background-color: #fff0f5; /* ç²‰å«©çš„èƒŒæ™¯è‰² */
    border-radius: 20px;
    width: 290px;
    padding: 20px;
    box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); /* ç²‰è‰²é™°å½± */
    text-align: center;
    position: relative;
    border: 1px solid #ffcce0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.transfer-actions-header {
    font-size: 20px;
    font-weight: bold;
    color: #a35c7b; /* æ·±ç²‰è‰²æ¨™é¡Œ */
    margin-bottom: 15px;
}

.transfer-actions-body p {
    font-size: 15px;
    color: #555;
    margin: 0 0 25px 0;
    line-height: 1.5;
}

.transfer-actions-footer {
    display: flex;
    justify-content: space-between;
    gap: 15px;
}

.transfer-actions-footer .action-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    color: white;
}

.transfer-actions-footer .action-btn:active {
    transform: scale(0.95);
}

.transfer-actions-footer .action-btn.accept {
    background: linear-gradient(135deg, #ff85b3, #ff69b4);
    box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
}

.transfer-actions-footer .action-btn.decline {
    background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.transfer-actions-content .cancel-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background-color: rgba(0, 0, 0, 0.1);
    color: #a35c7b;
    font-size: 20px;
    line-height: 28px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœªè®€æ¶ˆæ¯ç´…é»æ¨£å¼ === */
.unread-count-wrapper {
    flex-shrink: 0;
    width: 40px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 20px; /* è®“ç´…é»å’Œåå­—å·®ä¸å¤šé«˜ */
}

.unread-count {
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    background-color: #ff3b30; /* iOS é¢¨æ ¼çš„ç´…è‰² */
    color: white;
    font-size: 13px;
    font-weight: 500;
    line-height: 20px;
    text-align: center;
    border-radius: 10px; /* åœ“è§’çŸ©å½¢ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    display: none; /* é»˜èªéš±è— */
    justify-content: center;
    align-items: center;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè©±è¨˜éŒ„é é¢èˆ‡å¡ç‰‡æ¨£å¼ â–¼â–¼â–¼ */

/* ç¢ºä¿é é¢èƒŒæ™¯è‰²çµ±ä¸€ */
#call-history-screen {
    background-color: #f0f2f5;
}

/* é€šè©±è¨˜éŒ„å¡ç‰‡æ¨£å¼ */
.call-record-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 5px solid var(--accent-color);
}
.call-record-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

/* å¡ç‰‡é ­éƒ¨ï¼šåŒ…å«æ—¥æœŸå’Œæ™‚é•· */
.call-record-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
.call-record-card .card-header .duration {
    font-weight: 500;
    color: var(--text-primary);
}

/* å¡ç‰‡ä¸»é«”ï¼šåƒèˆ‡è€…é ­åƒ */
.call-record-card .card-body {
    display: flex;
    align-items: center;
}
.call-record-card .participants-avatars {
    display: flex;
    align-items: center;
}
.call-record-card .participant-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/* è®“é ­åƒæœ‰ä¸€å€‹æ¼‚äº®çš„å †ç–Šæ•ˆæœ */
.call-record-card .participant-avatar:not(:first-child) {
    margin-left: -12px;
}
.call-record-card .participants-names {
    margin-left: 12px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 15px;
}

/* --- é€šè©±è©³æƒ…å½ˆçª—æ¨£å¼ --- */
#transcript-modal-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 15px;
}
.transcript-entry {
    padding: 8px 12px;
    border-radius: 10px;
    max-width: 85%;
    line-height: 1.5;
    word-break: break-word;
}
.transcript-entry.user {
    background-color: #dcf8c6; /* é¡ä¼¼å¾®ä¿¡çš„ç¶ è‰² */
    align-self: flex-end;
}
.transcript-entry.assistant {
    background-color: #ffffff;
    align-self: flex-start;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

#chat-list-title {
    cursor: pointer;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè©±è¨˜éŒ„å¡ç‰‡ç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */

.call-record-card .card-body {
    /* å°‡ body æ”¹ç‚º flex ä½ˆå±€ï¼Œè®“æ¨™é¡Œå’Œåƒèˆ‡è€…è³‡è¨Šå‚ç›´æ’åˆ— */
    display: flex;
    flex-direction: column;
    gap: 8px; /* æ¨™é¡Œå’Œåƒèˆ‡è€…è³‡è¨Šä¹‹é–“çš„é–“è· */
}

.call-record-card .custom-title {
    font-size: 16px;
    font-weight: 600; /* åŠ ç²—ï¼Œè®“å®ƒåƒå€‹æ¨™é¡Œ */
    color: var(--text-primary);
    padding-bottom: 8px; /* æ¨™é¡Œä¸‹çš„ç•™ç™½ */
    border-bottom: 1px solid var(--border-color); /* åœ¨æ¨™é¡Œä¸‹åŠ ä¸€æ¢åˆ†å‰²ç·š */
    margin-bottom: 4px; /* å’Œä¸‹é¢çš„åƒèˆ‡è€…è³‡è¨Šæ‹‰é–‹ä¸€é»è·é›¢ */
}

.call-record-card .participants-info {
    /* é€™å€‹æ–°å®¹å™¨è®“é ­åƒå’Œâ€œèˆ‡xxâ€èƒ½æ°´æº–å°é½Š */
    display: flex;
    align-items: center;
}

/* åƒèˆ‡è€…åå­—çš„æ¨£å¼å¾®èª¿ï¼Œè®“å®ƒä¸é‚£éº¼çªå‡º */
.call-record-card .participants-names {
    margin-left: 12px;
    font-weight: 500; /* ä¸å†åŠ ç²— */
    font-size: 14px; /* ç¨å¾®å°ä¸€é» */
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¡è‰² */
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èªéŸ³è½‰æ–‡å­—åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. èªéŸ³æ–‡å­—å…§å®¹çš„æ¨£å¼ */
.voice-transcript {
    font-size: 14px;         /* æ–‡å­—å¤§å° */
    line-height: 1.6;        /* è¡Œé«˜ï¼Œè®“å¤šè¡Œæ–‡æœ¬æ›´æ˜“è®€ */
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¡è‰²ï¼Œèˆ‡èªéŸ³æ¢å€åˆ† */
    padding: 8px 12px;       /* å…§é‚Šè· */
    margin-top: 6px;         /* å’Œä¸Šæ–¹çš„èªéŸ³æ¢æ‹‰é–‹ä¸€é»è·é›¢ */
    background-color: rgba(0, 0, 0, 0.04); /* çµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯ï¼Œæ›´æœ‰å±¤æ¬¡æ„Ÿ */
    border-radius: 6px;      /* åœ“è§’ */
    word-break: break-word;  /* ç¢ºä¿é•·æ–‡æœ¬èƒ½æ­£å¸¸æ›è¡Œ */
    display: none;           /* é»˜èªéš±è— */
}

#phone-screen.dark-mode .voice-transcript {
    background-color: rgba(255, 255, 255, 0.1); /* å¤œé–“æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
}

/* 2. æ—‹è½‰è¼‰å…¥å‹•ç•«çš„æ¨£å¼ */
.loading-spinner {
    display: none; /* é»˜èªéš±è— */
    width: 16px;
    height: 16px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-top-color: var(--accent-color); /* æ—‹è½‰éƒ¨åˆ†çš„é¡è‰² */
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 8px; /* å’Œæ³¢å½¢åœ–ã€æ™‚é•·ä¿æŒä¸€é»é–“è· */
}

/* 3. å®šç¾©æ—‹è½‰å‹•ç•« */
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è¨˜éŒ„æª¢è¦–å™¨æ¨£å¼ä¿®æ­£ â–¼â–¼â–¼ */
#shared-history-viewer-content {
    display: flex;
    flex-direction: column; /* è®“æ°£æ³¡å‚ç›´æ’åˆ— */
    gap: 20px; /* åœ¨æ¯å€‹æ°£æ³¡ä¹‹é–“å¢åŠ 20åœ–å…ƒçš„é–“è· */
    padding: 15px; /* åœ¨å®¹å™¨å››å‘¨ä¹Ÿå¢åŠ ä¸€äº›å…§é‚Šè·ï¼Œé¿å…æ°£æ³¡è²¼é‚Š */
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’­æ”¾æ©Ÿå’Œæ­Œè©æ¨£å¼ â–¼â–¼â–¼ */
#music-player-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 50;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 60px;
    background-color: rgba(0,0,0,0.3);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-50px);
    transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#music-player-overlay.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.music-player-window { 
    width: 70%; 
    min-height: 420px;
    background-color: rgba(255, 255, 255, 0.6); 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    border-radius: 25px; 
    box-shadow: 0 8px 32px 0 rgba(25, 25, 25, 0.37); 
    border: 1px solid rgba(255, 255, 255, 0.18); 
    padding: 25px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    color: #1f1f1f; 
    position: relative;
    justify-content: space-between;
    padding-bottom: 15px;
}

.music-player-top-actions {
    position: absolute;
    top: 15px;
    left: 15px;
    right: 15px;
    width: calc(100% - 30px);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.top-left-cluster {
    display: flex;
    align-items: center;
    gap: 15px;
}
#music-return-btn, #music-exit-btn {
    background: none;
    border: none;
    font-size: 28px;
    font-weight: 300;
    cursor: pointer;
    color: #555;
    padding: 5px;
    line-height: 1;
}
#music-exit-btn {
    font-size: 24px;
    font-weight: 400;
}

.music-progress-bar-container {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 25px;
    margin-bottom: 10px;
}
.time-display {
    font-size: 11px;
    color: #888;
    width: 35px;
    text-align: center;
    flex-shrink: 0;
    font-family: 'SF Mono', 'Menlo', monospace;
}
.progress-bar {
    flex-grow: 1;
    height: 5px;
    background-color: #e5e5e5;
    border-radius: 2.5px;
    cursor: pointer;
}
.progress-bar-fill {
    width: 0%;
    height: 100%;
    background-color: #333;
    border-radius: 2.5px;
}

#music-lyrics-container {
    width: 100%;
    height: 192px;
    overflow: hidden;
    position: relative;
    -webkit-mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
    mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
}

#music-lyrics-list {
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.lyric-line {
    padding: 4px 0;
    font-size: 14px;
    color: #666;
    text-align: center;
    line-height: 1.5;
    transition: all 0.5s ease;
    opacity: 0.7;
    transform: scale(0.95);
}

.lyric-line.active {
    font-size: 16px;
    color: #000;
    opacity: 1;
    transform: scale(1);
}

.music-player-controls-wrapper {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.music-controls {
    margin-top: 0;
}

#music-return-btn, #music-exit-btn, #music-playlist-btn {
    position: relative;
}

#music-return-btn { top: -2px; }
#music-playlist-btn { top: -3px; }

.playlist-item-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}
.playlist-action-btn {
    font-size: 18px;
    color: #888;
    cursor: pointer;
    transition: color 0.2s;
}
.playlist-action-btn:hover { color: #000; }
.delete-track-btn { font-size: 24px; color: #ff3b30; }
.delete-track-btn:hover { color: #c00; }
.lyrics-btn { font-weight: 500; }

/* â–¼â–¼â–¼ ã€æœ€çµ‚é ­åƒæ”¾å¤§ç‰ˆã€‘è«‹ç”¨é€™å¡Šä»£ç¢¼æ›¿æ›æ‰€æœ‰ç›¸é—œçš„é ­åƒå°ºå¯¸è¦å‰‡ â–¼â–¼â–¼ */

/* 1. æ™®é€šé ­åƒæ¨£å¼ï¼ˆç„¡æ¡†ï¼‰ */
.message-bubble .avatar {
    width: 38px;  /* â˜… ä¿®æ”¹é»ï¼šå°‡å°ºå¯¸å¾ 34px æ”¾å¤§åˆ° 42px */
    height: 38px; /* â˜… ä¿®æ”¹é»ï¼šé«˜åº¦ä¹ŸåŒæ­¥æ”¾å¤§ */
    border-radius:  20%;
    object-fit: cover;
    flex-shrink: 0; 
}

/* 2. å¸¶æ¡†é ­åƒçš„å®¹å™¨æ¨£å¼ */
.avatar-with-frame {
    position: relative;
    width: 41px;  /* â˜… ä¿®æ”¹é»ï¼šå°ºå¯¸èˆ‡æ™®é€šé ­åƒä¿æŒä¸€è‡´ */
    height: 41px; /* â˜… ä¿®æ”¹é»ï¼šé«˜åº¦ä¹ŸåŒæ­¥æ”¾å¤§ */
    flex-shrink: 0;
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ¨£å¼ â–¼â–¼â–¼ */

/* 1. æ’¤å›æ¶ˆæ¯çš„é ç•™ä½ç½®æ¨£å¼ */
.recalled-message-placeholder {
    align-self: center; /* å±…ä¸­é¡¯ç¤º */
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
    cursor: pointer; /* è®“å®ƒçœ‹èµ·ä¾†å¯ä»¥é»æ“Š */
}

/* 2. å¤œé–“æ¨¡å¼ä¸‹çš„é©é… */
#phone-screen.dark-mode .recalled-message-placeholder {
    background-color: rgba(255, 255, 255, 0.15);
}

/* 3. AIæ’¤å›æ¶ˆæ¯æ™‚çš„å‹•ç•«æ•ˆæœ */
@keyframes recall-animation {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.8);
  }
}

.message-wrapper.recalled-animation {
  animation: recall-animation 0.3s ease-out forwards;
}

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ¨£å¼ä¿®æ­£ â–¼â–¼â–¼ */

/* å¼·åˆ¶æ’¤å›æ¶ˆæ¯çš„é ç•™ä½ç½®ä¸æ›è¡Œï¼Œä¸¦ä¿æŒå…§å®¹å±…ä¸­ */
.recalled-message-placeholder {
    white-space: nowrap; /* æ ¸å¿ƒï¼šç¦æ­¢æ–‡æœ¬æ›è¡Œ */
    display: inline-block; /* è®“èƒŒæ™¯æ ¹æ“šå…§å®¹è‡ªæˆ‘èª¿æ•´å¯¬åº¦ */
    padding: 4px 12px;
}

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œæ›¸åˆ†é¡æ¸…å–®æ¨£å¼ â–¼â–¼â–¼ */
.world-book-group-container {
    border-bottom: 1px solid var(--border-color);
}
.world-book-group-container:first-child {
    border-top: 1px solid var(--border-color);
}
.world-book-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}
.world-book-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}
.world-book-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}
.world-book-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}
.world-book-group-content {
    max-height: 100000px; /* <--- å°±æ˜¯ä¿®æ”¹é€™è£¡ï¼ŒæŠŠå€¼æ”¹å¤§å³å¯ */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.world-book-group-content.collapsed {
    max-height: 0;
}
#phone-screen.dark-mode .world-book-group-header {
    background-color: #1c1c1e;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…/è½‰å¸³æ¨¡æ…‹æ¡†é ç°½æ¨£å¼ â–¼â–¼â–¼ */
.frame-tabs {
    display: flex;
    background-color: #f0f0f0;
    padding: 4px;
    margin: 15px;
    border-radius: 8px;
}
.frame-tab {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #555;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
}
.frame-tab.active {
    background-color: #ffffff;
    color: #000000;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µå…¨æ–°çš„CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. åˆ†é¡è³‡æ–™å¤¾çš„æ¨£å¼ */
.wb-category-header {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    cursor: pointer;
    background-color: #f0f2f5; /* çµ¦è³‡æ–™å¤¾ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯è‰²ä»¥å€åˆ† */
    font-weight: 600; /* åŠ ç²—å­—é«” */
}
#phone-screen.dark-mode .wb-category-header {
    background-color: #2c2c2e; /* å¤œé–“æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
}


/* 2. å±•é–‹/æ”¶èµ·çš„å°ç®­é ­ */
.wb-category-header .arrow {
    font-size: 12px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

/* 3. ç•¶è³‡æ–™å¤¾æ”¶èµ·æ™‚ï¼Œç®­é ­æ—‹è½‰ */
.wb-category-header.collapsed .arrow {
    transform: rotate(-90deg);
}

/* 4. å­˜æ”¾æ›¸ç±æ¢ç›®çš„å®¹å™¨ */
.wb-book-container {
    padding-left: 20px; /* æ ¸å¿ƒï¼šè®“æ›¸ç±æ¢ç›®å‘å…§ç¸®é€²ï¼Œçœ‹èµ·ä¾†åƒåœ¨è³‡æ–™å¤¾è£¡ */
    max-height: 100000px; /* ä¸€å€‹è¶³å¤ å¤§çš„å€¼ï¼Œç”¨æ–¼å‹•ç•« */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

/* 5. ç•¶è³‡æ–™å¤¾æ”¶èµ·æ™‚ï¼Œæ›¸ç±å®¹å™¨çš„é«˜åº¦è®Šç‚º0ï¼Œå¯¦ç¾å‹•ç•«æ•ˆæœ */
.wb-book-container.collapsed {
    max-height: 0;
}

/* 6. å–®å€‹æ›¸ç±æ¢ç›®ï¼ˆè¦†è“‹é è¨­çš„labelæ¨£å¼ï¼Œå¾®èª¿é–“è·ï¼‰ */
.wb-book-container label {
    padding: 8px 12px;
}

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œæ›¸é—œè¯é¸æ“‡å™¨ - è¦–è¦ºå„ªåŒ– â–¼â–¼â–¼ */

/* 1. è®“åˆ†é¡æ¨™é¡Œæ›´çªå‡º */
.wb-category-header > span:last-of-type {
    font-size: 14px;
    font-weight: 700; /* åŠ ç²— */
    color: var(--text-primary);
}

/* 2. ç‚ºç®­é ­è¨­ç½®ä¸€å€‹æ¼‚äº®çš„é¡è‰²è¿´åœˆ */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+1) .arrow { color: #007bff; } /* è—è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+2) .arrow { color: #28a745; } /* ç¶ è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+3) .arrow { color: #fd7e14; } /* æ©™è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+4) .arrow { color: #6f42c1; } /* ç´«è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+5) .arrow { color: #dc3545; } /* ç´…è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+6) .arrow { color: #ffc107; } /* é»ƒè‰² */

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* === é ­åƒæ¡†é¸æ“‡æ¨¡æ…‹æ¡†æ¨£å¼ (é€™æ˜¯æ–°æ·»åŠ çš„) === */
.change-frame-btn {
    padding: 6px 10px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    margin-left: 10px;
}

#avatar-frame-modal .modal-content {
    height: 70%; /* è®“çª—å£é«˜ä¸€é» */
}

#avatar-frame-modal .modal-body {
    padding: 0;
    display: flex;
    flex-direction: column;
}
      
.frame-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.frame-tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
}

.frame-tab.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

.frame-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
}

.frame-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* æ¯è¡Œè‡ªå‹•å¡«å……ï¼Œæœ€å°70pxå¯¬ */
    gap: 15px;
}

.frame-item {
    aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
    border: 2px solid transparent;
    border-radius: 10px;
    cursor: pointer;
    background-color: #f0f0f0;
    background-size: cover;
    background-position: center;
    padding: 5px;
    transition: all 0.2s ease;
    position: relative; /* ç‚ºé è¦½åœ–åšæº–å‚™ */
}

.frame-item.selected {
    border-color: var(--accent-color);
    transform: scale(1.05);
}

.frame-item .preview-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.frame-item .preview-frame {
    position: absolute;
    top: -7px;
    left: 0;
    width: 100%;
    height: 100%;
}

/* â–¼â–¼â–¼ æŠŠé€™äº›CSSåŠ å›å» â–¼â–¼â–¼ */

.avatar-with-frame .avatar-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%; /* å¸¶æ¡†çš„é ­åƒé€šå¸¸æ˜¯åœ“çš„ */
    object-fit: cover;
    z-index: 1;
}
/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰èˆŠçš„èŠå¤©å’Œå¿ƒè²é ­åƒæ¡†è¦å‰‡ â–¼â–¼â–¼ */

.avatar-with-frame .avatar-frame,
#inner-voice-avatar-frame {
    position: absolute;
    /* æ ¸å¿ƒä¿®æ”¹1ï¼šå°‡å¯¬é«˜çµ±ä¸€è¨­ç½®ç‚º125%ï¼Œç¢ºä¿èƒ½å®Œå…¨åŒ…è£¹34pxçš„é ­åƒï¼Œä¸¦ç•™å‡ºæ¼‚äº®çš„é‚Šè· */
    width: 125%; 
    height: 125%;

    /* æ ¸å¿ƒä¿®æ”¹2ï¼šä½¿ç”¨æ¨™æº–çš„-50%ä¾†ç²¾ç¢ºå®šä½ï¼Œç¢ºä¿é ­åƒæ¡†å®Œç¾å±…ä¸­ */
    transform: translate(-50%, -50%); 
    
    /* æ ¸å¿ƒä¿®æ”¹3ï¼šå°‡å®šä½åŸºé»ä¹Ÿæ”¹ç‚ºæ¨™æº–çš„50%ï¼Œèˆ‡transformé…åˆä½¿ç”¨ */
    top: 50%;
    left: 50%;

    z-index: 2;
    pointer-events: none;
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æœ€çµ‚ç¾åŒ–ç‰ˆã€‘èŠå¤©åˆ—è¡¨å·¦æ»‘ç½®é ‚åŠŸèƒ½æ¨£å¼ (å·²ä¿®å¾©Bug) â–¼â–¼â–¼ */

/* 1. å¤–å±¤åŒ…è£¹å®¹å™¨ (å·²ç§»é™¤ display:flex) */
.chat-list-item-swipe-container {
    position: relative;
    overflow: hidden;
}

/* 2. å¯æ»‘å‹•çš„å…§å®¹å€ (ä¿æŒä¸è®Š) */
.chat-list-item-content {
    position: relative;
    z-index: 2;
    background-color: var(--secondary-bg);
    transition: transform 0.3s ease, background-color 0.3s ease;
    width: 100%;
    flex-shrink: 0;
}

/* 3. ã€æ ¸å¿ƒä¿®æ”¹1ã€‘ç½®é ‚èŠå¤©æ™‚ï¼Œä½¿ç”¨å°æ¯”åº¦æ›´å¼·çš„èƒŒæ™¯è‰² */
.chat-list-item-content.pinned {
    background-color: #f0f2f5; /* æ—¥é–“æ¨¡å¼ä¸‹çš„ç½®é ‚é¡è‰² (å·²åŠ æ·±) */
}
#phone-screen.dark-mode .chat-list-item-content.pinned {
    background-color: #3a3a3c; /* å¤œé–“æ¨¡å¼ä¸‹çš„ç½®é ‚é¡è‰² (å·²åŠ æ·±) */
}

/* 4. éš±è—çš„æ“ä½œæŒ‰éˆ•å€åŸŸ (ä¿æŒä¸è®Š) */
.swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
    display: flex;
}

/* 5. å–®å€‹æ“ä½œæŒ‰éˆ•çš„æ¨£å¼ (ä¿æŒä¸è®Š) */
.swipe-action-btn {
    height: 100%;
    padding: 0 20px;
    border: none;
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
}

.swipe-action-btn.pin { background-color: #f0ad4e; }
.swipe-action-btn.unpin { background-color: #777; }
.swipe-action-btn.delete { background-color: #ff3b30; }

/* 6. ç•¶å…§å®¹å€è¢«æ»‘é–‹æ™‚ (ä¿æŒä¸è®Š) */
.chat-list-item-content.swiped {
    transform: translateX(-160px);
}

/* 7. åˆ†å‰²ç·šçš„æ­£ç¢ºé‚è¼¯ (ä¿æŒä¸è®Š) */
.chat-list-item {
    border-bottom: none;
}
.chat-list-item-swipe-container:not(:last-child) {
     border-bottom: 1px solid var(--border-color);
}
.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-of-type {
    border-top: 1px solid var(--border-color);
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ®µã€æ–°æ¨£å¼ã€‘ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ .date-stamp æ¨£å¼ â–¼â–¼â–¼ */

/* æ—¥æœŸæˆ³çš„å¤–å±¤åŒ…è£¹ï¼Œè®“å®ƒåƒç³»çµ±æ¶ˆæ¯ä¸€æ¨£å±…ä¸­ */
.date-stamp-wrapper {
    justify-content: center;
    align-self: center;
    margin: 10px 0;
    max-width: 80%;
}

/* æ—¥æœŸæˆ³çš„æ°£æ³¡æœ¬èº« */
.date-stamp-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 10px;
}

/* é©é…å¤œé–“æ¨¡å¼ */
#phone-screen.dark-mode .date-stamp-bubble {
    background-color: rgba(255, 255, 255, 0.15);
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.chat-list-time {
    font-size: 12px;
    color: var(--text-secondary);
    text-align: right;
    margin-left: 8px; /* å’Œä¸­é–“çš„è³‡è¨Šå€æ‹‰é–‹ä¸€é»è·é›¢ */
    flex-shrink: 0;   /* é˜²æ­¢åœ¨ç©ºé–“ä¸è¶³æ™‚è¢«å£“ç¸® */
    align-self: flex-start; /* è®“å®ƒå’Œé ‚éƒ¨çš„åå­—å°é½Š */
    padding-top: 2px; /* å¾®èª¿å‚ç›´ä½ç½® */
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.chat-list-right-column {
    display: flex;
    flex-direction: column;
    align-items: flex-end; /* è®“å…§å®¹é å³å°é½Š */
    gap: 4px; /* åœ¨æ™‚é–“å’Œç´…é»ä¹‹é–“åŠ ä¸€é»é»é–“è· */
    flex-shrink: 0;
    margin-left: 8px;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é–å±èˆ‡å¯†ç¢¼ä»‹é¢æ¨£å¼ â–¼â–¼â–¼ */

/* 1. é–å±ä»‹é¢çš„ç¸½å®¹å™¨ */
#lock-screen {
    /* æ ¸å¿ƒï¼šç”¨ä¸€å€‹éå¸¸é«˜çš„ z-index ç¢ºä¿å®ƒèƒ½è¦†è“‹æ‰€æœ‰å…¶ä»–è¢å¹• */
    z-index: 999; 
    background-size: cover;
    background-position: center;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* è®“æ™‚é˜å’Œæç¤ºèªä¸Šä¸‹åˆ†ä½ˆ */
    align-items: center;
    padding: 80px 20px 50px 20px;
    box-sizing: border-box;
    transition: transform 0.3s ease-out;
}

/* 2. é–å±æ™‚é˜ (è¤‡ç”¨ä¸»è¢å¹•æ™‚é˜çš„æ¨£å¼) */
#lock-clock-container {
    text-align: center;
    text-shadow: 0 3px 8px rgba(0,0,0,0.4);
    flex-shrink: 0;
}
#lock-main-time {
    font-size: 80px;
    font-weight: 200;
}
#lock-main-date {
    font-size: 18px;
    font-weight: 500;
}

/* 3. â€œå‘ä¸Šè¼•æƒâ€çš„æç¤ºæ–‡å­—å’Œå‹•ç•« */
#unlock-hint {
    font-size: 16px;
    font-weight: 500;
    text-shadow: 0 1px 4px rgba(0,0,0,0.3);
    /* æ·»åŠ ä¸€å€‹å‘¼å¸å‹•ç•«ï¼Œå¸å¼•ç”¨æˆ¶æ³¨æ„ */
    animation: hint-pulse 2s infinite ease-in-out;
}
@keyframes hint-pulse {
    0%, 100% { opacity: 0.7; transform: translateY(0); }
    50% { opacity: 1; transform: translateY(-5px); }
}

/* 4. å¯†ç¢¼è¼¸å…¥å½ˆçª—çš„é®ç½©å±¤ */
#password-modal-overlay {
    /* ä½¿ç”¨ä¸€å€‹åŠé€æ˜çš„æ¯›ç»ç’ƒæ•ˆæœèƒŒæ™¯ */
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000; /* æ¯”é–å±æ›´é«˜ï¼Œç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
}

/* 5. å¯†ç¢¼è¼¸å…¥å½ˆçª—çš„å…§å®¹å€ */
.password-modal-content {
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    width: 280px;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 15px;
    color: #333;
}
.password-modal-content p {
    font-size: 17px;
    font-weight: 600;
    margin: 0;
}

/* 6. å¯†ç¢¼è¼¸å…¥æ¡† */
#password-input-field {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 8px;
    font-size: 16px;
    text-align: center;
    box-sizing: border-box;
    background-color: rgba(255,255,255,0.7);
}
#password-input-field:focus {
    outline: none;
    border-color: var(--accent-color);
}

/* 7. å¯†ç¢¼å½ˆçª—çš„æŒ‰éˆ•å€åŸŸ */
.password-actions {
    display: flex;
    gap: 10px;
    margin-top: 5px;
}
.password-actions button {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
}
#password-cancel-btn {
    background-color: #e9ecef;
    color: #495057;
}
#password-confirm-btn {
    background-color: var(--accent-color);
    color: white;
}

/* 8. å¯†ç¢¼éŒ¯èª¤æ™‚çš„æ™ƒå‹•å‹•ç•« */
@keyframes shake-error {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}
.password-modal-content.error {
    animation: shake-error 0.4s ease-in-out;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ .bubble-preset-manager æ¨£å¼ â–¼â–¼â–¼ */

/* é€™æ˜¯ä½ è¦ä¿®æ”¹å‰çš„ä»£ç¢¼ */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°£æ³¡/APIæ¨£å¼é è¨­åŠŸèƒ½CSS â–¼â–¼â–¼ */
.bubble-preset-manager {
    display: flex;
    align-items: baseline; /* æ ¸å¿ƒä¿®æ”¹ï¼šå¾ center æ”¹ç‚º baseline */
    gap: 10px; /* å…ƒç´ ä¹‹é–“çš„é–“è· */
}



/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


/* ä¸‹æ‹‰æ¸…å–®çš„æ¨£å¼ï¼Œè®“å®ƒä½”æ“šå¤§éƒ¨åˆ†ç©ºé–“ */
.bubble-preset-manager select {
    flex-grow: 1; /* ä½”æ“šæ‰€æœ‰å‰©é¤˜ç©ºé–“ */
}

/* ç®¡ç†æŒ‰éˆ•çš„æ¨£å¼ï¼Œè®“å®ƒå°å·§ç²¾ç·» */
.bubble-preset-manager .action-btn {
    flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¢«å£“ç¸® */
    padding: 8px 10px;
    font-size: 13px;
    background-color: #e9ecef;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®“é–å±å’Œä¸»è¢å¹•å¯ä»¥å †ç–Š */
/* æ ¸å¿ƒï¼šæŠŠé–å±å’Œä¸»è¢å¹•éƒ½è¨­ç‚ºçµ•å°å®šä½ï¼Œé€™æ¨£å®ƒå€‘æ‰èƒ½é‡ç–Š */
#lock-screen, #home-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

/* 2. å®šç¾©æ¯›ç»ç’ƒèƒŒæ™¯å±¤çš„æ¨£å¼ */
#lock-screen-background-blur {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å®ƒçš„å±¤ç´šç¾åœ¨å’Œä¸»è¢å¹•ä¸€æ¨£ä½ */
    
    background-size: cover;
    background-position: center;

    /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘é­”æ³•åœ¨é€™è£¡ï¼æˆ‘å€‘ç›´æ¥æ¨¡ç³Šé€™å€‹å…ƒç´ æœ¬èº« */
    filter: blur(20px);
    -webkit-filter: blur(20px);
    
    /* (å¯é¸ä½†æ¨è–¦) è¼•å¾®æ”¾å¤§å¯ä»¥é¿å…æ¨¡ç³Šå¾Œé‚Šç·£è®Šæš—ï¼Œæ•ˆæœæ›´å¥½ */
    transform: scale(1.1); 

    /* ã€æ ¸å¿ƒä¿®æ”¹3ã€‘é»˜èªéš±è—ï¼Œä¸”å¸¶æœ‰æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease-out;
}

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹è¤‡è£½ â–¼â–¼â–¼ */

/* === ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ä¸–ç•Œæ›¸é¸æ“‡å™¨æ¸…å–®æ¨£å¼ === */

/* 1. åˆ†é¡è³‡æ–™å¤¾è¡Œæ¨£å¼ï¼šç”¨flexå’Œgapå‰µå»ºå›ºå®šé–“è·ï¼Œéå¸¸ç©©å®š */
.wb-category-header {
    display: flex;
    align-items: center;
    gap: 8px; /* ç®­é ­ã€æ ¸å–æ–¹å¡Šã€æ–‡å­—ä¹‹é–“çš„å›ºå®šé–“è· */
    padding: 10px 12px;
    cursor: pointer;
    background-color: #f0f2f5;
    font-weight: 600;
    overflow: hidden; /* é˜²æ­¢ä»»ä½•æ„å¤–æº¢å‡º */
}

/* 2. åˆ†é¡è³‡æ–™å¤¾è£¡çš„æ–‡å­—æ¨£å¼ï¼šåªè² è²¬æˆªæ–·ï¼Œä¸è² è²¬ä½ˆå±€ */
.wb-category-header > span:last-of-type {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-shrink: 1; /* å…è¨±æ–‡å­—éƒ¨åˆ†åœ¨ç©ºé–“ä¸è¶³æ™‚è¢«å£“ç¸® */
}

/* 3. ã€æ ¸å¿ƒä¿®å¾©ã€‘ç‚ºåˆ†é¡å’Œæ›¸ç›®è£¡çš„æ ¸å–æ–¹å¡Šâ€œè§£ç¶â€å…¨åŸŸæ¨£å¼ï¼ */
.wb-category-header input[type="checkbox"],
.wb-book-container input[type="checkbox"] {
    width: auto !important; /* è®“å®ƒæ¢å¾©è‡ªå·±çš„å¤©ç„¶å¤§å°ï¼Œ!importantç¢ºä¿æœ€é«˜å„ªå…ˆé †åº */
    flex-shrink: 0;         /* é˜²æ­¢å®ƒè¢«å£“ç¸®ï¼Œä¿æŒå®Œæ•´ */
}

/* 4. å…·é«”æ›¸ç›®è¡Œçš„æ¨£å¼ï¼šå¼·åˆ¶å¾å·¦é‚Šé–‹å§‹æ’åˆ—ï¼Œè§£æ±ºä¸åŒè¨­å‚™çš„é¡¯ç¤ºå·®ç•° */
.wb-book-container label {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* å¼·åˆ¶æ‰€æœ‰å…§å®¹å¾å·¦é‚Šé–‹å§‹å°é½Š */
    padding: 8px 12px;
    gap: 10px; /* æ ¸å–æ–¹å¡Šå’Œæ–‡å­—çš„é–“è· */
    overflow: hidden;
}

/* 5. å…·é«”æ›¸ç›®çš„æ–‡å­—æ¨£å¼ */
.wb-book-container label .wb-book-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: left;
    flex-shrink: 1; /* åŒæ¨£å…è¨±å®ƒè¢«å£“ç¸® */
}

/* 6. å¤œé–“æ¨¡å¼é©é… (ä¿æŒä¸è®Š) */
#phone-screen.dark-mode .wb-category-header {
    background-color: #2c2c2e;
}

/* 7. å°ç®­é ­çš„æ¨£å¼ (ä¿æŒä¸è®Š) */
.wb-category-header .arrow {
    font-size: 12px;
    transition: transform 0.2s ease;
    flex-shrink: 0; /* é˜²æ­¢ç®­é ­è¢«å£“ç¸® */
}
.wb-category-header.collapsed .arrow {
    transform: rotate(-90deg);
}

/* 8. æ›¸ç±å®¹å™¨çš„æ¨£å¼ (ä¿æŒä¸è®Š) */
.wb-book-container {
    padding-left: 20px;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.wb-book-container.collapsed {
    max-height: 0;
}


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ»‘é¼ æ‹–å‹•å·¥å…·åˆ—æ™‚çš„æ‰‹å‹¢æ¨£å¼ â–¼â–¼â–¼ */
#chat-input-actions-top.grabbing {
    cursor: grabbing;
    cursor: -webkit-grabbing;
    user-select: none; /* é˜²æ­¢æ‹–å‹•æ™‚é¸ä¸­æ–‡æœ¬ */
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€SVGçµ‚æ¥µç‰ˆã€‘ç™¼é€å®šä½åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. åŸºç¤å¡ç‰‡å’Œæ°£æ³¡æ¨£å¼ (ä¿æŒä¸è®Š) */
.message-bubble.is-location .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
.location-card { width: 230px; background-color: #f7f7f7; border-radius: 12px; overflow: hidden; border: 1px solid #e0e0e0; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }

/* 2. ã€æ ¸å¿ƒå‡ç´šã€‘åœ°åœ–å€åŸŸç¾åœ¨ç›´æ¥ç”¨æ–¼å®¹ç´SVG */
.location-map-area {
    height: 90px;
    background-color: #f0f2f5;
    background-image:
        linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
    background-size: 20px 20px;
    padding: 5px; /* çµ¦SVGä¸€é»å‘¼å¸ç©ºé–“ */
    box-sizing: border-box;
}
.location-map-area svg {
    width: 100%;
    height: 100%;
}

/* 3. ã€å…¨æ–°ã€‘SVGå…§éƒ¨å…ƒç´ çš„æ¨£å¼ */
/* è»Œè·¡æ›²ç·š */
.svg-trajectory-path {
    stroke-width: 2px;
    stroke: rgba(180, 180, 180, 0.8);
    stroke-dasharray: 3 3; /* è™›ç·šæ•ˆæœ */
    fill: none;
}
/* å®šä½é» (èµ·é»/çµ‚é») */
.svg-pin {
    stroke-width: 2px;
    stroke: white;
}
.svg-pin.user-pin { fill: #4CAF50; } /* ç¶ è‰²ç”¨æˆ¶é» */
.svg-pin.ai-pin { fill: #ff5252; } /* ç´…è‰²AIé» */

/* è…³å°åœ–ç¤º */
.svg-footprint {
    font-size: 14px;
    fill: rgba(0, 0, 0, 0.4);
}
/* é€”ç¶“é»åœ°åæ¨™ç±¤ */
.svg-location-label {
    font-size: 10px;
    font-weight: 500;
    fill: #555;
    /* çµ¦æ–‡å­—ä¸€é»ç™½è‰²çš„æé‚Šï¼Œè®“å®ƒåœ¨è¤‡é›œèƒŒæ™¯ä¸‹æ›´æ¸…æ™° */
    stroke: white;
    stroke-width: 2px;
    paint-order: stroke;
}

/* 4. å¡ç‰‡åº•éƒ¨è³‡è¨Šå€åŸŸ (å·²å‡ç´š) */
.location-info { padding: 12px; }
.location-address {
    font-size: 13px;
    line-height: 1.6;
    margin-bottom: 8px;
    color: #333;
}
.location-address .name-tag {
    font-weight: 600;
    color: var(--text-primary);
}
.location-address p.hidden { display: none; }
.location-distance {
    font-size: 12px;
    color: var(--text-secondary);
    border-top: 1px solid #e9e9e9;
    padding-top: 8px;
    text-align: center;
}
/* â–²â–²â–² å‡ç´šç‰ˆCSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–° | ä¿®å¾©ç‰ˆã€‘â€œä¸€éµé‡rollâ€æŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */
#reroll-btn {
    /* --- ç›´æ¥è¤‡ç”¨å…¶ä»–æŒ‰éˆ•çš„æ¨£å¼ï¼Œç¢ºä¿å¤–è§€çµ±ä¸€ --- */
    font-size: 24px;
    padding: 0;
    width: 38px;
    height: 38px;
    line-height: 38px;
    text-align: center;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.5);
    color: var(--text-primary);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    /* æ ¸å¿ƒä¿®å¾©ï¼šé‚Šæ¡†é¡è‰²å’Œå…¶ä»–æŒ‰éˆ•çµ±ä¸€ */
    border: 1px solid rgba(0,0,0,0.05); 
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    
    /* ç§»é™¤å°è‡´å·®ç•°çš„é™°å½± */
    box-shadow: none; 

    /* ä¿ç•™åŸæœ‰çš„äº¤äº’å‹•æ•ˆ */
    transition: opacity 0.2s, transform 0.1s;
}

#reroll-btn:hover {
    opacity: 0.8;
}

#reroll-btn:active {
    transform: scale(0.9);
}

#reroll-btn svg {
    width: 20px;
    height: 20px;
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€æœ€çµ‚ç¾åŒ–ç‰ˆã€‘æ‡¸æµ®æ­Œè©æ¬„æ¨£å¼ â–¼â–¼â–¼ */
#floating-lyrics-bar {
    position: absolute;
    /* ã€å•é¡Œ1ä¿®å¾©ã€‘é»˜èªä½ç½®æ”¹ç‚ºé ‚éƒ¨ */
    top: 50px; 
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    
    display: none;
    align-items: center;
    justify-content: center;
    gap: 10px; /* åœ¨æ­Œè©å’ŒæŒ‰éˆ•é–“å¢åŠ é–“è· */

    width: 90%; 
    max-width: 320px; /* åŒæ™‚è¨­ä¸€å€‹æœ€å¤§åœ–å…ƒå¯¬åº¦ï¼Œé¿å…åœ¨å¯¬å±ä¸Šéé•· */
    padding: 8px 12px; /* ç¨å¾®å¢åŠ ä¸€é»å…§é‚Šè·ä»¥é©æ‡‰æ–°å¯¬åº¦ */
    background-color: rgba(0, 0, 0, 0); 
    
    /* ã€å•é¡Œ3éœ€è¦ã€‘ç‚ºå­—é«”é¡è‰²å’ŒèƒŒæ™¯é€æ˜åº¦æ·»åŠ éæ¸¡å‹•ç•« */
    transition: background-color 0.3s, opacity 0.3s;

    color: white;
    font-size: 14px;
    font-weight: 500; /* å­—é«”ç¨å¾®åŠ ç²— */
    text-align: center;
    border-radius: 12px;
    
    /* æ–‡å­—é™°å½±ï¼Œè®“å®ƒåœ¨ä»»ä½•èƒŒæ™¯ä¸‹éƒ½æ¸…æ™° */
    text-shadow: 0 1px 3px rgba(0,0,0,0.5); 
    
    cursor: pointer;
    user-select: none;
    
    /* ã€å•é¡Œ4éœ€è¦ã€‘ç‚ºé—œé–‰æŒ‰éˆ•æº–å‚™ */
    overflow: visible; /* å…è¨±æŒ‰éˆ•è¶…å‡ºç¯„åœ */
}

/* ã€å•é¡Œ4éœ€è¦ã€‘é—œé–‰æŒ‰éˆ•çš„æ¨£å¼ */
#floating-lyrics-bar .close-btn,
#floating-lyrics-bar #lyrics-settings-btn {
    position: absolute;
    top: -8px;
    width: 20px;
    height: 20px;
    background-color: rgba(0,0,0,0.6);
    color: white;
    border-radius: 50%;
    border: 1px solid white;
    cursor: pointer;
    opacity: 0; /* é»˜èªéš±è— */
    transition: opacity 0.2s;
    display: flex; /* ç¢ºä¿SVGèƒ½å±…ä¸­ */
    align-items: center;
    justify-content: center;
}

/* æŠŠé—œé–‰æŒ‰éˆ•å’Œè¨­ç½®æŒ‰éˆ•åˆ†é–‹æ”¾ç½® */
#floating-lyrics-bar .close-btn { right: -8px; line-height: 18px; font-size: 14px; }
#floating-lyrics-bar #lyrics-settings-btn { right: 22px; } /* æ”¾åœ¨é—œé–‰æŒ‰éˆ•æ—é‚Š */

/* æ»‘é¼ æ‡¸åœåœ¨æ•´å€‹æ­Œè©æ¬„ä¸Šæ™‚ï¼Œä¸€èµ·é¡¯ç¤ºå®ƒå€‘ */
#floating-lyrics-bar:hover .close-btn,
#floating-lyrics-bar:hover #lyrics-settings-btn {
    opacity: 1;
}

#floating-lyrics-bar.dragging {
    cursor: grabbing;
    cursor: -webkit-grabbing;
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥è§’è‰²æ‰‹æ©Ÿâ€åŠŸèƒ½ç›¸é—œæ¨£å¼ â–¼â–¼â–¼ */

/* è§’è‰²é¸æ“‡åˆ—è¡¨é … */
.character-select-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
}
.character-select-item:hover {
    background-color: #f5f5f5;
}
.character-select-item img {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    margin-right: 12px;
}
.character-select-item .name {
    font-weight: 500;
}

/* è§’è‰²æ‰‹æ©Ÿçš„èŠå¤©æ°£æ³¡ (ç°¡åŒ–ç‰ˆ) */
.character-chat-bubble {
    padding: 8px 12px;
    border-radius: 12px;
    max-width: 80%;
    word-break: break-word;
    line-height: 1.5;
}
.character-chat-bubble.sent {
    background-color: #dcf8c6;
    align-self: flex-end; /* è‡ªå·±ç™¼çš„é å³ */
}
.character-chat-bubble.received {
    background-color: #ffffff;
    align-self: flex-start; /* æ”¶åˆ°çš„é å·¦ */
}

/* â–¼â–¼â–¼ ã€ç¾åŒ–ç‰ˆã€‘è§’è‰²æ‰‹æ©Ÿè³‡æ–™æ¸…å–®é …æ¨£å¼ â–¼â–¼â–¼ */
.character-data-item {
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0; /* é‚Šæ¡†é¡è‰²è®Šæ·º */
    margin: 8px 10px; /* å¢åŠ å¤–é‚Šè·ï¼Œå½¢æˆå¡ç‰‡æ„Ÿ */
    border-radius: 8px; /* å¢åŠ åœ“è§’ */
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* å¢åŠ éå¸¸æ·¡çš„é™°å½± */
    transition: transform 0.2s, box-shadow 0.2s; /* å¢åŠ æ‡¸æµ®å‹•ç•« */
    background-color: var(--secondary-bg);
}

.character-data-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

.character-data-item .title {
    font-weight: 600;
    margin-bottom: 5px;
    color: #333; /* æ¨™é¡Œé¡è‰²åŠ æ·± */
}
.character-data-item .content {
    font-size: 14px;
    color: #555;
    line-height: 1.6;
    white-space: pre-wrap;
}
.character-data-item .meta {
    font-size: 12px;
    color: #888;
    margin-top: 10px;
    padding-top: 8px; /* åœ¨metaä¸Šæ–¹å¢åŠ ä¸€é»è·é›¢å’Œåˆ†å‰²ç·š */
    border-top: 1px solid #f5f5f5;
    display: flex;
    justify-content: space-between;
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V3ä¿®æ­£ç‰ˆã€‘è§’è‰²æ‰‹æ©Ÿâ€œç•«ä¸­ç•«â€æ¨£å¼ä¿®æ­£ â–¼â–¼â–¼ */

/* 1. ã€æ ¸å¿ƒä¿®æ­£1ã€‘è®“æ‰‹æ©Ÿå¤–æ®¼å®¹å™¨ä½”æ“šæ•´å€‹è¢å¹•ï¼Œä¸¦ç”¨å…§é‚Šè·æŠŠæ‰‹æ©Ÿæ¡†â€œæ¨â€ä¸‹ä¾† */
#character-phone-container {
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #ffffff; /* â˜…â˜…â˜… æŠŠé€™è£¡æ”¹ç‚ºç´”ç™½è‰² â˜…â˜…â˜… */
    padding-top: 50px; 
    box-sizing: border-box; /* ç¢ºä¿å…§é‚Šè·è¨ˆç®—æ­£ç¢º */
}


/* 2. æ‰‹æ©Ÿé‚Šæ¡†æ¨£å¼ (ä¿æŒä¸è®Š) */
.character-phone-frame {
    width: 95%;
    height: 98%;
    background-color: #111;
    border-radius: 30px;
    padding: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    box-sizing: border-box;
    position: relative;
    display: flex;
}

/* â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ #character-app-grid .app-icon .icon-bg è¦å‰‡ â–¼â–¼â–¼ */
#character-app-grid .app-icon .icon-bg {
    width: 65px;  /* æ¢å¾©åŸä¾†çš„å°ºå¯¸ */
    height: 65px; /* æ¢å¾©åŸä¾†çš„å°ºå¯¸ */
    border-radius: 18px; /* æ¢å¾©åŸä¾†çš„åœ“è§’ */
    background-color: #fff5f7; /* è¨­ç½®ç‚ºä½ æƒ³è¦çš„æ·¡ç²‰è‰²èƒŒæ™¯ */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* 3. ã€æ ¸å¿ƒä¿®æ­£2ã€‘ç¸®å°APPåœ–ç¤ºå…§çš„SVG */
#character-app-grid .app-icon .icon-bg svg {
    width: 60%;  /* â˜…â˜…â˜… å°‡SVGçš„å¯¬åº¦ç¸®å°åˆ°å…¶å®¹å™¨çš„60% â˜…â˜…â˜… */
    height: 60%; /* â˜…â˜…â˜… é«˜åº¦ä¹ŸåŒæ­¥ç¸®å° â˜…â˜…â˜… */
}

/* 4. å…¶é¤˜æ¨£å¼ä¿æŒä¸è®Š */
.character-phone-inner-screen {
    flex-grow: 1;
    border-radius: 20px;
    overflow: hidden;
    position: relative;
    background-color: var(--secondary-bg) !important; /* ä½¿ç”¨è®Šæ•¸ */
}
.character-phone-notch {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 20px;
    border-radius: 0 0 10px 10px;
    z-index: 10;
}
.character-phone-page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}
.character-phone-page.active {
    opacity: 1;
    visibility: visible;
    z-index: 5;
}
/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€é€æ˜æ¯›ç»ç’ƒç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„ .character-phone-header æ¨£å¼ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€é€æ˜æ¯›ç»ç’ƒç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„ .character-phone-header æ¨£å¼ â–¼â–¼â–¼ */

.character-phone-header {
    flex-shrink: 0;
    margin: 10px 12px 10px; /* â˜… ä¿®æ”¹é»1: å°‡ä¸Šé‚Šè· 35px æ”¹ç‚º 0ï¼Œè®“å®ƒè²¼é ‚ */
    height: 50px;           /* â˜… ä¿®æ”¹é»2: å°‡é«˜åº¦å¾ 48px å¢åŠ åˆ° 56pxï¼Œè®“å®ƒæ›´é«˜ä¸€é» */

    /* â˜… æ ¸å¿ƒä¿®æ”¹1ï¼šè®Šæˆä¸€å€‹æ›´åœ“æ½¤çš„è† å›Šå½¢ç‹€ */
    border-radius: 24px; /* å°‡åœ“è§’å¾16pxå¢åŠ åˆ°24pxï¼Œçœ‹èµ·ä¾†æ›´åœ“æ½¤ */

    /* â˜… æ ¸å¿ƒä¿®æ”¹2ï¼šè¨­ç½®ä¸€å€‹å¹¾ä¹é€æ˜çš„ã€å¸¶æœ‰æ¯›ç»ç’ƒæ•ˆæœçš„èƒŒæ™¯ */
    background-color: rgba(180, 180, 180, 0.2); /* é™ä½ä¸é€æ˜åº¦ï¼Œç‡Ÿé€ é€æ˜æ„Ÿ */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);

    /* â˜… æ ¸å¿ƒä¿®æ”¹3ï¼šè®“é‚Šæ¡†å’Œé™°å½±æ›´ç²¾ç·»ï¼Œä»¥é©æ‡‰é€æ˜æ„Ÿ */
    border: 1px solid rgba(255, 255, 255, 0.2); /* é‚Šæ¡†ä¹Ÿèª¿å¾—æ›´é€æ˜ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);   /* é™°å½±ç¨å¾®èª¿æ•´ï¼Œæ›´æŸ”å’Œ */

    /* â˜… æ ¸å¿ƒä¿®æ”¹4ï¼šå¼·åˆ¶æ–‡å­—å’Œåœ–ç¤ºé¡è‰²è®Šç‚ºç™½è‰²ï¼Œä¸¦åŠ ä¸Šé™°å½±ä»¥ä¿è­‰æ¸…æ™° */
    color: #ffffff; /* æ¨™é¡Œæ–‡å­—è®Šç‚ºç™½è‰² */
    text-shadow: 0 1px 3px rgba(0,0,0,0.3); /* çµ¦æ–‡å­—åŠ ä¸€é»é™°å½±ï¼Œé˜²æ­¢èƒŒæ™¯å¤ªäº®çœ‹ä¸æ¸… */

    /* ä½ˆå±€éƒ¨åˆ†ä¿æŒä¸è®Š */
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 12px;
    box-sizing: border-box;
    font-size: 16px;
}


/* â˜…â˜…â˜…ã€é‡è¦ã€‘ç‚ºäº†ç¢ºä¿æ‰€æœ‰åœ–ç¤ºéƒ½è®Šæˆç™½è‰²ï¼Œè«‹æŠŠä¸‹é¢é€™æ®µæ–°ä»£ç¢¼ä¹ŸåŠ åˆ°<style>è£¡ â˜…â˜…â˜… */
.character-phone-header .action-btn svg,
.character-phone-header .back-btn svg {
    color: #ffffff !important;
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* â˜…â˜…â˜…ã€é‡è¦ã€‘ç‚ºäº†ç¢ºä¿æ‰€æœ‰åœ–ç¤ºéƒ½è®Šæˆç™½è‰²ï¼Œè«‹æŠŠä¸‹é¢é€™æ®µæ–°ä»£ç¢¼ä¹ŸåŠ åˆ°<style>è£¡ â˜…â˜…â˜… */
.character-phone-header .action-btn svg,
.character-phone-header .back-btn svg {
    color: #ffffff !important;
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

.character-phone-header .action-btn svg,
.character-phone-header .back-btn svg {
    color: var(--accent-color);
}
#character-chat-history-messages {
     background-color: var(--secondary-bg) !important; /* ä½¿ç”¨è®Šæ•¸ */      /* â˜…â˜…â˜… ç§»é™¤èƒŒæ™¯åœ–ç‰‡ â˜…â˜…â˜… */
}
/* â–²â–²â–² æ¨£å¼ä¿®æ­£çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V5æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è§’è‰²æ‰‹æ©ŸAPPåœ–ç¤ºä½ˆå±€ä¿®æ­£ â–¼â–¼â–¼ */
/* â–¼â–¼â–¼ æ‰¾åˆ° #character-app-grid.app-grid-standardï¼Œä¿®æ”¹å…¶ä¸­çš„ padding-top å±¬æ€§ â–¼â–¼â–¼ */

#character-app-grid.app-grid-standard {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px 15px;
    padding: 20px;
    padding-top: 95px; /* â˜…â˜…â˜… æŠŠ 50px æ”¹æˆ 95pxï¼Œç‚ºæ–°é ‚æ¬„ç•™å‡ºç©ºé–“ â˜…â˜…â˜… */
    box-sizing: border-box;
    width: 100%;
    flex-direction: initial; 
    align-items: initial;
}

/* â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² */

/* â–²â–²â–² æ¨£å¼ä¿®æ­£çµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿå¾®ä¿¡é¢¨æ ¼èŠå¤©æ°£æ³¡æ¨£å¼ â–¼â–¼â–¼ */

/* 1. èŠå¤©è¨˜éŒ„ä»‹é¢çš„èƒŒæ™¯è‰² */
#character-chat-history-messages {
    /* ç§»é™¤ä¹‹å‰ç‰ˆæœ¬å¯èƒ½å­˜åœ¨çš„èƒŒæ™¯åœ–ç‰‡ */
    background-image: none;
}

/* 2. æ¶ˆæ¯æ°£æ³¡çš„é€šç”¨å®¹å™¨æ¨£å¼ */
.character-chat-bubble-container {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    margin-bottom: 12px;
    max-width: 80%; /* é™åˆ¶æ°£æ³¡æœ€å¤§å¯¬åº¦ */
}

/* 3. æ°£æ³¡çš„å…§å®¹å€åŸŸ */
.character-chat-bubble {
    position: relative;
    padding: 8px 12px;
    line-height: 1.5;
    word-break: break-word;
    border-radius: 6px;
    font-size: 15px;
}

/* 4. é ­åƒæ¨£å¼ */
.character-chat-avatar {
    width: 36px;
    height: 36px;
    border-radius: 6px; /* å¾®ä¿¡é¢¨æ ¼çš„åœ“è§’çŸ©å½¢é ­åƒ */
    flex-shrink: 0;
}

/* --- æˆ‘æ–¹ï¼ˆè§’è‰²è‡ªå·±ï¼‰çš„æ°£æ³¡ --- */
.character-chat-bubble-container.sent {
    align-self: flex-end; /* æ•´é«”é å³ */
    flex-direction: row-reverse; /* ä½ˆå±€åè½‰ï¼šå…§å®¹ -> é ­åƒ */
}
.character-chat-bubble-container.sent .character-chat-bubble {
    background-color: #95ec69; /* å¾®ä¿¡ç¶  */
    color: #000;
}
/* æˆ‘æ–¹æ°£æ³¡çš„å°å°¾å·´ */
.character-chat-bubble-container.sent .character-chat-bubble::after {
    content: "";
    position: absolute;
    right: -4px;
    top: 10px;
    width: 0;
    height: 0;
    border: 4px solid transparent;
    border-left-color: #95ec69;
    border-right: 0;
}

/* --- å°æ–¹ï¼ˆNPCæˆ–ç”¨æˆ¶ï¼‰çš„æ°£æ³¡ --- */
.character-chat-bubble-container.received {
    align-self: flex-start; /* æ•´é«”é å·¦ */
}
/* å°æ–¹æ°£æ³¡çš„å°å°¾å·´ */
.character-chat-bubble-container.received .character-chat-bubble::before {
    content: "";
    position: absolute;
    left: -4px;
    top: 10px;
    width: 0;
    height: 0;
    border: 4px solid transparent;
    border-right-color: #ffffff;
    border-left: 0;
}
/* â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼ */
.character-chat-bubble-container.received .character-chat-bubble {
    background-color: #ffffff; /* å¾®ä¿¡ç™½ */
    color: #000;
}
/* â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² */

/* --- åŠŸèƒ½æ€§é‡ç½®ï¼šé‡å°åœ–ç‰‡/è¡¨æƒ…åŒ…ï¼Œè®“æ°£æ³¡â€œæ¶ˆå¤±â€ --- */
.character-chat-bubble-container .character-chat-bubble:has(img.sticker-image) {
    background: transparent !important;
    padding: 0 !important;
    border-radius: 0;
}
.character-chat-bubble-container .character-chat-bubble:has(img.sticker-image)::before,
.character-chat-bubble-container .character-chat-bubble:has(img.sticker-image)::after {
    content: none !important;
}
/* â–²â–²â–² æ¨£å¼æ·»åŠ çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿæ–°å¢APPé é¢æ¨£å¼ â–¼â–¼â–¼ */

/* 1. ç›¸å†Šé é¢çš„ç¶²æ ¼ä½ˆå±€ */
#character-album-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* æ¯è¡Œ3å¼µåœ– */
    gap: 4px;
    padding: 4px;
}
.character-album-item {
    aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
    background-color: #e0e0e0;
    cursor: pointer;
}
.character-album-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* 2. éŠ€è¡Œé é¢çš„é¤˜é¡é¡¯ç¤º */
.character-bank-balance-card {
    margin: 15px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.character-bank-balance-card .label {
    font-size: 14px;
    opacity: 0.8;
}
.character-bank-balance-card .amount {
    font-size: 32px;
    font-weight: 600;
    margin-top: 5px;
}

/* 3. éŠ€è¡Œäº¤æ˜“è¨˜éŒ„çš„é¡è‰² */
.character-data-item .transaction-amount {
    font-weight: 600;
}
.character-data-item .transaction-amount.income {
    color: #4CAF50; /* æ”¶å…¥ç‚ºç¶ è‰² */
}
.character-data-item .transaction-amount.expense {
    color: #F44336; /* æ”¯å‡ºç‚ºç´…è‰² */
}

/* â–²â–²â–² æ¨£å¼æ·»åŠ çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V5ä¿®æ­£ç‰ˆã€‘è§’è‰²æ‰‹æ©Ÿç›¸å†Šç¶²æ ¼ä½ˆå±€ â–¼â–¼â–¼ */
#character-album-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* æ¯è¡Œ3å¼µåœ– */
    gap: 4px;
    padding: 4px;
}
.character-album-item {
    aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
    background-color: #e0e0e0;
    cursor: pointer;
}
.character-album-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
/* â–²â–²â–² æ¨£å¼ä¿®æ­£çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Markdownæ¸²æŸ“å¢å¼·æ¨£å¼ â–¼â–¼â–¼ */

/* 1. ç‚ºè§’è‰²æ‰‹æ©Ÿè£¡çš„æ‰€æœ‰Markdownå…§å®¹è¨­ç½®åŸºç¤æ¨£å¼ */
.character-data-item .content h1,
.character-data-item .content h2,
.character-data-item .content h3,
.character-data-item .content p {
    margin: 0 0 10px 0; /* çµ±ä¸€æ¨™é¡Œå’Œæ®µè½çš„ä¸‹é‚Šè· */
}
.character-data-item .content h1 { font-size: 1.5em; font-weight: 600; }
.character-data-item .content h2 { font-size: 1.3em; font-weight: 600; }
.character-data-item .content h3 { font-size: 1.1em; font-weight: 600; }

/* 2. åˆªé™¤ç·šæ¨£å¼ */
.character-data-item .content del {
    color: #8a8a8a;
}

/* 3. é®æ“‹/åŠ‡é€æ•ˆæœ */
.character-data-item .content .spoiler {
    background-color: #333;
    color: #333; /* æ–‡å­—å’ŒèƒŒæ™¯ä¸€å€‹è‰²ï¼Œå¯¦ç¾éš±è— */
    padding: 0 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
/* é»æ“Šæˆ–æ»‘é¼ æ‡¸åœæ™‚é¡¯ç¤ºå…§å®¹ */
.character-data-item .content .spoiler:hover,
.character-data-item .content .spoiler:active {
    background-color: #f0f0f0;
    color: #000;
}

/* â–²â–²â–² æ¨£å¼æ·»åŠ çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿæ—¥è¨˜ç¾åŒ–èˆ‡åˆªé™¤åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“æ—¥è¨˜åˆ—è¡¨æœ‰æ›´å¥½çš„é‚Šè· */
#character-diary-list {
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 12px; /* å¢åŠ æ—¥è¨˜ä¹‹é–“çš„é–“è· */
}

/* 2. ç¾åŒ–å–®ç¯‡æ—¥è¨˜å¡ç‰‡ */
#character-diary-list .character-data-item {
    background-color: #fffaf0; /* æº«æš–çš„ç±³é»ƒè‰²èƒŒæ™¯ */
    border-left: 4px solid #ffc107; /* å·¦å´åŠ ä¸€æ¢è£é£¾ç·š */
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    position: relative; /* ç‚ºäº†å®šä½åˆªé™¤æŒ‰éˆ• */
    padding-bottom: 35px; /* ç‚ºåº•éƒ¨çš„æ—¥æœŸç•™å‡ºç©ºé–“ */
}

/* 3. ç¾åŒ–æ—¥æœŸé¡¯ç¤ºï¼ŒæŠŠå®ƒæ”¾åˆ°å³ä¸‹è§’ */
#character-diary-list .character-data-item .meta {
    position: absolute;
    bottom: 8px;
    right: 12px;
    border-top: none; /* ç§»é™¤åŸä¾†çš„ä¸Šé‚Šæ¡† */
    padding-top: 0;
    font-size: 11px;
    color: #bfa87a;
}

/* 4. åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
.diary-delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background-color: rgba(0,0,0,0.05);
    color: #bfa87a;
    border: none;
    cursor: pointer;
    font-size: 20px;
    line-height: 26px;
    text-align: center;
    opacity: 0; /* é»˜èªéš±è— */
    transition: opacity 0.2s ease-in-out;
}
/* æ»‘é¼ æ‡¸åœåœ¨æ—¥è¨˜ä¸Šæ™‚é¡¯ç¤ºæŒ‰éˆ• */
#character-diary-list .character-data-item:hover .diary-delete-btn {
    opacity: 1;
}
.diary-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–²â–²â–² æ¨£å¼æ·»åŠ çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V6æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è§’è‰²æ‰‹æ©Ÿç›¸å†Šä½ˆå±€é˜²æº¢å‡º â–¼â–¼â–¼ */

/* 1. ã€æ ¸å¿ƒã€‘ç‚ºç›¸å†Šç¶²æ ¼çš„å®¹å™¨å¼·åˆ¶ç¦æ­¢æ°´æº–æ»¾å‹• */
#character-album-grid.list-container {
    overflow-x: hidden;
}

/* 2. é‡æ–°å®šç¾©ç¶²æ ¼ä½ˆå±€ */
#character-album-grid {
    display: grid;
    /* ã€æ ¸å¿ƒã€‘æ¯è¡Œ3å€‹ï¼Œä½†é€™æ¬¡æˆ‘å€‘ç”¨calc()ç²¾ç¢ºè¨ˆç®—å¯¬åº¦ */
    grid-template-columns: repeat(3, calc(33.333% - 4px)); 
    gap: 6px; /* ç¨å¾®å¢å¤§é–“éš™ï¼Œè®“calcæœ‰è¨ˆç®—ç©ºé–“ */
    padding: 6px; /* å…§é‚Šè·å’Œé–“éš™ä¿æŒä¸€è‡´ */
    box-sizing: border-box; /* ç¢ºä¿å…§é‚Šè·å’Œé‚Šæ¡†è¢«åŒ…å«åœ¨ç¸½å¯¬åº¦å…§ */
    align-content: start; /* <--- å°±æ˜¯åŠ ä¸Šé€™ä¸€è¡Œï¼ */
}

/* 3. ç¨å¾®ç¸®å°åœ–ç‰‡ï¼Œç¢ºä¿å®ƒå€‘ä¸æœƒæ’ç ´å®¹å™¨ */
.character-album-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block; /* ç§»é™¤åœ–ç‰‡ä¸‹æ–¹çš„å¾®å°ç©ºéš™ */
}

/* â–²â–²â–² æ¨£å¼ä¿®æ­£çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V6ç¨å®¶å®šåˆ¶ã€‘è§’è‰²æ‰‹æ©Ÿä¿¡ç´™é¢¨æ ¼æ—¥è¨˜æ¨£å¼ â–¼â–¼â–¼ */

/* 1. ã€æ ¸å¿ƒã€‘é‡å¡‘æ—¥è¨˜å¡ç‰‡ï¼Œè®“å®ƒåƒä¸€å¼µä¿¡ç´™ */
#character-diary-list .character-data-item {
    background-color: #fdfaf2; /* æº«æš–ã€æŸ”å’Œçš„ç±³ç™½/æ·ºé»ƒè‰²ï¼Œæ¨¡æ“¬ä¿¡ç´™ */
    border: 1px solid #eaddc7;  /* æ·¡æ·¡çš„ç´™å¼µé‚Šç·£è‰² */
    border-left: 3px solid #d4bda5; /* å·¦å´åŠ ä¸€æ¢ç¨æ·±çš„ç·šï¼Œåƒè£è¨‚ç·š */
    box-shadow: 2px 2px 6px rgba(0,0,0,0.06); /* æ›´æŸ”å’Œçš„é™°å½± */
    position: relative;
    padding: 20px 15px 15px 20px; /* èª¿æ•´å…§é‚Šè·ï¼Œçµ¦â€œå°æ±è¥¿â€ç•™å‡ºç©ºé–“ */
    font-family: Georgia, 'Times New Roman', 'Kaiti TC', 'STKaiti', serif; /* ä½¿ç”¨æ›´å…¸é›…çš„è¥¯ç·šå­—é«” */
}

/* 2. ã€å°æ±è¥¿ã€‘ç”¨å½å…ƒç´ åœ¨å·¦ä¸Šè§’æ·»åŠ ä¸€å€‹ç²¾ç·»çš„ç´™å¤¾ */
#character-diary-list .character-data-item::before {
    content: 'ğŸ“'; /* é€™æ˜¯ä¸€å€‹Emojiç´™å¤¾ï¼Œç°¡å–®åˆæœ‰æ•ˆ */
    position: absolute;
    top: -12px;
    left: 15px;
    font-size: 24px;
    transform: rotate(-25deg); /* è®“ç´™å¤¾æœ‰ä¸€å€‹éš¨æ„çš„è§’åº¦ */
    opacity: 0.8;
}

/* 3. ã€æ ¸å¿ƒã€‘é‡ç½®Markdownå…§å®¹çš„å­—é«”ï¼Œç¢ºä¿å®ƒå€‘ç¹¼æ‰¿ä¿¡ç´™çš„å­—é«” */
#character-diary-list .character-data-item .content,
#character-diary-list .character-data-item .content h1,
#character-diary-list .character-data-item .content h2,
#character-diary-list .character-data-item .content h3 {
    font-family: inherit; /* å¼·åˆ¶ç¹¼æ‰¿çˆ¶å…ƒç´ çš„å­—é«” */
    color: #4a443b; /* ä½¿ç”¨æ·±æ£•è‰²æ–‡å­—ï¼Œæ›´æœ‰è³ªæ„Ÿ */
}

#character-diary-list .character-data-item .content p {
    margin: 0 0 12px 0;
}

/* 4. å°‡æ—¥æœŸç§»å‹•åˆ°å³ä¸Šè§’ï¼Œåƒä¿¡ç´™çš„è½æ¬¾æ—¥æœŸ */
#character-diary-list .character-data-item .meta {
    position: absolute;
    top: 10px;
    right: 12px;
    font-size: 11px;
    color: #ae9c82; /* åŒ¹é…ä¿¡ç´™é¢¨æ ¼çš„æ—¥æœŸé¡è‰² */
    font-style: italic; /* æ–œé«”æ›´æœ‰æ‰‹å¯«æ„Ÿ */
    border-top: none;
    padding-top: 0;
}

/* 5. ç¾åŒ–åˆªé™¤æŒ‰éˆ•ï¼Œè®“å®ƒæ›´èå…¥ä¿¡ç´™é¢¨æ ¼ */
#character-diary-list .character-data-item .diary-delete-btn {
    background-color: transparent;
    color: #c9bbae;
    font-size: 22px;
    transition: all 0.2s ease;
}

#character-diary-list .character-data-item .diary-delete-btn:hover {
    background-color: #e44d44;
    color: white;
    transform: scale(1.1);
}

/* â–²â–²â–² æ¨£å¼æ·»åŠ çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿå…¨APPç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */

/* --- 1. è³¼ç‰©è»Šæ¨£å¼ --- */
.character-cart-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
}
.character-cart-item:last-child {
    border-bottom: none;
}
.cart-item-icon {
    width: 40px;
    height: 40px;
    flex-shrink: 0;
    background-color: #f0f2f5;
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--text-secondary);
}
.cart-item-info {
    flex-grow: 1;
}
.cart-item-info .title {
    font-weight: 500;
}
.cart-item-info .store {
    font-size: 12px;
    color: var(--text-secondary);
}
.cart-item-price {
    font-weight: 600;
    font-size: 15px;
}

/* --- 2. æµè¦½å™¨æ­·å²æ¨£å¼ --- */
.character-browser-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background-color 0.2s;
}
.character-browser-item:hover {
    background-color: #f9f9f9;
}
.browser-item-icon {
    font-size: 20px;
    color: var(--text-secondary);
}

/* --- 3. éŠ€è¡Œäº¤æ˜“æ˜ç´°æ¨£å¼ --- */
.character-bank-transaction {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 15px;
    border-bottom: 1px solid #f0f0f0;
}
.transaction-details {
    display: flex;
    align-items: center;
    gap: 12px;
}
.transaction-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    color: white;
}

/* --- 4. è¡Œå‹•è»Œè·¡ (æ™‚é–“ç·š) æ¨£å¼ --- */
.character-trajectory-list {
    padding: 20px 15px 20px 30px; /* å·¦å´ç•™å‡ºæ™‚é–“ç·šçš„ç©ºé–“ */
}
.character-trajectory-item {
    position: relative;
    padding-bottom: 25px;
}
/* æ™‚é–“è»¸çš„åˆ†éš”è™Ÿ */
.character-trajectory-item::before {
    content: '';
    position: absolute;
    top: 5px;
    left: -18px;
    width: 2px;
    height: 100%;
    background-color: #e0e0e0;
}
.character-trajectory-item:last-child::before {
    display: none; /* æœ€å¾Œä¸€å€‹æ¢ç›®æ²’æœ‰ç·š */
}
/* æ™‚é–“è»¸çš„åœ“é» */
.character-trajectory-item::after {
    content: '';
    position: absolute;
    top: 5px;
    left: -23px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--accent-color);
    border: 2px solid white;
    box-shadow: 0 0 0 2px var(--accent-color);
}
.trajectory-item-content .meta {
    margin-top: 4px; /* è®“æ™‚é–“å’Œåœ°é»é›¢æ¨™é¡Œè¿‘ä¸€é» */
}

/* --- 5. APPä½¿ç”¨è¨˜éŒ„ (é€²åº¦æ¢) æ¨£å¼ --- */
.character-app-usage-item {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
}
.app-usage-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}
.app-usage-header .name {
    font-weight: 500;
}
.app-usage-header .duration {
    color: var(--text-secondary);
}
.app-usage-bar-container {
    width: 100%;
    height: 6px;
    background-color: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}
.app-usage-bar {
    height: 100%;
    background-color: var(--accent-color);
    border-radius: 3px;
    transition: width 0.5s ease-in-out;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾Œè‡ºæ´»å‹•è¨­ç½®ä»‹é¢æ¨£å¼ â–¼â–¼â–¼ */
.char-list-item {
    display: flex;
    align-items: center;
    padding: 8px 5px;
    border-bottom: 1px solid #eee;
}
.char-list-item:last-child {
    border-bottom: none;
}
.char-list-item input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
}
.char-list-item .char-name {
    flex-grow: 1;
}
.char-list-item .char-freq-badge {
    font-size: 11px;
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 10px;
    color: white;
}
.char-freq-badge.low { background-color: #28a745; }
.char-freq-badge.medium { background-color: #fd7e14; }
.char-freq-badge.high { background-color: #dc3545; }
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ã€å…¨æ–°ã€‘è¦–é »é€šè©±è¦–è¦ºåŒ–ä»‹é¢æ¨£å¼ === */

/* 1. è¦–è¦ºåŒ–ä»‹é¢çš„ç¸½å®¹å™¨ï¼Œç¢ºä¿å®ƒèƒ½è¦†è“‹æ•´å€‹è¢å¹• */
#visual-call-interface {
    width: 100%;
    height: 100%;
    position: relative; /* è®“å…§éƒ¨å…ƒç´ å¯ä»¥ç›¸å°æ–¼å®ƒå®šä½ */
    overflow: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡º */
    background-color: #1c1c1e; /* æ·±è‰²èƒŒæ™¯ */
    display: flex; /* ä½¿ç”¨flexä½ˆå±€ï¼Œæ–¹ä¾¿å…§å®¹æ’åˆ— */
    flex-direction: column;
}

/* 2. è¦–é »èƒŒæ™¯å±¤ï¼Œç”¨æ–¼æ”¾ç½®å¤§å°åœ– */
.video-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* ç¢ºä¿å®ƒåœ¨æœ€åº•å±¤ */
}

/* 3. å¤§å°åœ–çš„é€šç”¨å®¹å™¨æ¨£å¼ */
.video-container {
    position: absolute;
    background-color: #000;
    overflow: hidden;
    transition: all 0.3s ease-in-out; /* ç‚ºåˆ‡æ›é¡é ­æ·»åŠ å‹•ç•« */
}
.video-container img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ä¿è­‰åœ–ç‰‡å¡«æ»¿å®¹å™¨ä¸”ä¸è®Šå½¢ */
}

/* 4. å¤§åœ–æ¨£å¼ (é è¨­å æ»¿å…¨å±) */
#video-main-view {
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

/* 5. å°åœ–æ¨£å¼ (ç•«ä¸­ç•«) */
#video-pip-view {
    top: 60px; /* è·é›¢é ‚éƒ¨ä¸€æ®µè·é›¢ */
    right: 15px;
    width: 100px; /* å°çª—å¯¬åº¦ */
    height: 178px; /* å°çª—é«˜åº¦ (ä¿æŒè±å±æ¯”ä¾‹) */
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    cursor: pointer; /* æç¤ºç”¨æˆ¶å¯ä»¥é»æ“Š */
}

/* 6. èŠå¤©æ°£æ³¡å€åŸŸ (è¦†è“‹åœ¨è¦–é »ä¹‹ä¸Š) */
#video-call-messages-visual {
    position: relative;
    z-index: 5; /* å±¤ç´šæ¯”è¦–é »é«˜ */
    flex-grow: 1; /* ä½”æ“šé™¤äº†é ‚éƒ¨å’Œåº•éƒ¨æ¬„ä¹‹å¤–çš„æ‰€æœ‰ç©ºé–“ */
    padding: 15px;
    overflow-y: auto; /* å…§å®¹å¤šäº†å¯ä»¥æ»¾å‹• */
    display: flex;
    flex-direction: column;
    gap: 15px;
    /* é—œéµï¼šç‚ºäº†ä¸è®“æ²è»¸å½±éŸ¿ç¾è§€ï¼ŒæŠŠå®ƒéš±è—æ‰ */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE 10+ */
}
#video-call-messages-visual::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera*/
}

/* â–¼â–¼â–¼ ç”¨é€™ã€ä¸€å°å¡Šã€‘ä»£ç¢¼ï¼Œæ›¿æ›æ‰èˆŠçš„æ°£æ³¡æ¨£å¼ï¼Œå¯¦ç¾ã€ç„¡æ¨¡ç³Šã€‘æ•ˆæœ â–¼â–¼â–¼ */

/* 7. ã€ç„¡æ¨¡ç³Šã€‘é«˜æ¸…é€æ˜èŠå¤©æ°£æ³¡ */
.visual-call-bubble {
    padding: 8px 12px;
    border-radius: 18px;
    max-width: 80%;
    line-height: 1.5;
    word-break: break-word;
    color: white;

    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå¾¹åº•ç§»é™¤ backdrop-filter (æ¨¡ç³Š) æ•ˆæœ */

    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæä¾›ä¸€å€‹ç°¡å–®çš„åŠé€æ˜é»‘è‰²èƒŒæ™¯ï¼Œä»¥è¥¯æ‰˜æ–‡å­— */
    background-color: rgba(0, 0, 0, 0.3); /* é€™æ˜¯ä¸€å€‹é—œéµå€¼ï¼Œå¯ä»¥åœ¨ 0.2 (æ›´é€) åˆ° 0.4 (æ›´æ·±) ä¹‹é–“å¾®èª¿ */

    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨æ›´æ¸…æ™°çš„é‚Šæ¡†ä¾†å®šç¾©æ°£æ³¡è¼ªå»“ */
    border: 1px solid rgba(255, 255, 255, 0.25);

    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå¼·åŒ–æ–‡å­—é™°å½±ï¼Œç¢ºä¿åœ¨ä»»ä½•æ¸…æ™°èƒŒæ™¯ä¸‹éƒ½çµ•å°å¯è®€ */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
}

.visual-call-bubble.user {
    align-self: flex-end;
    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šç”¨æˆ¶æ°£æ³¡ä¹Ÿä½¿ç”¨ç„¡æ¨¡ç³Šçš„åŠé€æ˜èƒŒæ™¯ */
    background-color: rgba(40, 160, 70, 0.3); /* ä½¿ç”¨ä¸€å€‹æ›´æ·±çš„ç¶ è‰²ä¾†ä¿è­‰å°æ¯”åº¦ */
    border-color: rgba(255, 255, 255, 0.3);
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */



.visual-call-bubble.ai {
    align-self: flex-start; /* AIçš„ç™¼è¨€é å·¦ */
}

/* 8. é ‚éƒ¨å’Œåº•éƒ¨æ¬„çš„å±¤ç´šè¦æœ€é«˜ */
#visual-call-interface .video-call-top-bar,
#visual-call-interface .video-call-controls {
    z-index: 10;
}

/* 9. æ–°å¢çš„æ§åˆ¶æŒ‰éˆ•åœ–ç¤º (ä½¿ç”¨SVG) */
.control-btn.reroll-btn {
    background-color: rgba(255,255,255,0.2);
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>');
    background-size: 50%;
}
.control-btn.switch-camera-btn {
    background-color: rgba(255,255,255,0.2);
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>');
    background-size: 50%;
}

/* 10. æ›æ–·æŒ‰éˆ•éœ€è¦ä¸€å€‹æ–°IDä¾†å€åˆ† */
#hang-up-btn-visual {
    /* æ¨£å¼ç¹¼æ‰¿è‡ª .hangup-btnï¼Œç„¡éœ€é¡å¤–æ·»åŠ  */
}

/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ä¸–ç•Œæ›¸é¸æ“‡å™¨æ¸…å–®æ¨£å¼ â–¼â–¼â–¼ */

/* 1. åˆ†é¡è³‡æ–™å¤¾è¡Œæ¨£å¼ï¼šç”¨gapå‰µå»ºå›ºå®šé–“è·ï¼Œè¶…ç©©å®š */
.wb-category-header {
    display: flex;
    align-items: center;
    gap: 8px; /* ç®­é ­ã€æ ¸å–æ–¹å¡Šã€æ–‡å­—ä¹‹é–“çš„å›ºå®šé–“è· */
    padding: 10px 12px;
    cursor: pointer;
    background-color: #f0f2f5;
    font-weight: 600;
    overflow: hidden; /* é˜²æ­¢ä»»ä½•æ„å¤– */
}

/* 2. åˆ†é¡è³‡æ–™å¤¾è£¡çš„æ–‡å­—æ¨£å¼ï¼šåªè² è²¬æˆªæ–·ï¼Œä¸è² è²¬ä½ˆå±€ */
.wb-category-header > span:last-of-type {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 3. ã€æ ¸å¿ƒä¿®å¾©ã€‘ç‚ºåˆ†é¡è³‡æ–™å¤¾å’Œæ›¸ç›®è£¡çš„æ ¸å–æ–¹å¡Šâ€œè§£ç¶â€å…¨åŸŸæ¨£å¼ï¼ */
.wb-category-header input[type="checkbox"],
.wb-book-container input[type="checkbox"] {
    width: auto !important; /* è®“å®ƒæ¢å¾©è‡ªå·±çš„å¤©ç„¶å¤§å°ï¼Œ!importantç¢ºä¿æœ€é«˜å„ªå…ˆé †åº */
    flex-shrink: 0;         /* é˜²æ­¢å®ƒè¢«å£“ç¸® */
}

/* 4. å…·é«”æ›¸ç›®è¡Œçš„æ¨£å¼ï¼šå¼·åˆ¶å¾å·¦é‚Šé–‹å§‹æ’åˆ—ï¼Œè§£æ±ºiOSå•é¡Œ */
.wb-book-container label {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* å¼·åˆ¶æ‰€æœ‰å…§å®¹å¾å·¦é‚Šé–‹å§‹ï¼*/
    padding: 8px 12px;
    gap: 10px; /* æ ¸å–æ–¹å¡Šå’Œæ–‡å­—çš„é–“è· */
    overflow: hidden;
}

/* 5. å…·é«”æ›¸ç›®çš„æ–‡å­—æ¨£å¼ */
.wb-book-container label .wb-book-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: left;
}

/* 6. å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode .wb-category-header {
    background-color: #2c2c2e;
}

/* 7. å°ç®­é ­çš„æ¨£å¼ï¼ˆä¿æŒä¸è®Šï¼‰ */
.wb-category-header .arrow {
    font-size: 12px;
    transition: transform 0.2s ease;
}
.wb-category-header.collapsed .arrow {
    transform: rotate(-90deg);
}

/* 8. æ›¸ç±å®¹å™¨çš„æ¨£å¼ï¼ˆä¿æŒä¸è®Šï¼‰ */
.wb-book-container {
    padding-left: 20px;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.wb-book-container.collapsed {
    max-height: 0;
}

/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å­—é«”é è¨­åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

#font-preset-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 15px; /* å¡æ§½ä¹‹é–“çš„é–“è· */
}

.font-preset-slot {
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

#phone-screen.dark-mode .font-preset-slot {
    border-color: #38383a;
}

.font-preset-slot.empty {
    justify-content: center;
    align-items: center;
    min-height: 80px;
    border-style: dashed;
}

.font-preview-text {
    font-size: 22px;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    min-height: 30px;
    transition: font-family 0.3s ease;
}

#phone-screen.dark-mode .font-preview-text {
    background-color: #2c2c2e;
    color: #fff;
}

.font-preset-info {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
}

.font-preset-actions {
    display: flex;
    gap: 10px;
    width: 100%;
}

.preset-btn {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    background-color: var(--accent-color);
    color: white;
}

.preset-btn.secondary {
    background-color: #e9ecef;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .preset-btn.secondary {
    background-color: #3e3e42;
    border-color: #545458;
}

.preset-btn.delete {
    background-color: #ffdde5;
    color: #ff3b30;
    border: 1px solid #ffc2d1;
    max-width: 80px; /* è®“åˆªé™¤æŒ‰éˆ•çª„ä¸€é» */
    flex: 0 0 auto;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* ã€ç¾åŒ– V2ã€‘è®“å¾Œè‡ºæ´»å‹•è¨­ç½®çš„æŒ‰éˆ•æ›´åœ“æ½¤ã€æ›´ç«‹é«” */
#background-activity-details .form-button-secondary {
    border-radius: 20px; /* å¤§å¹…å¢åŠ åœ“è§’ï¼Œå½¢æˆè† å›Šå½¢ç‹€ */
    padding-top: 10px;   /* å¢åŠ é ‚éƒ¨å…§é‚Šè·ï¼Œè®“æŒ‰éˆ•æ›´é«˜ */
    padding-bottom: 10px;/* å¢åŠ åº•éƒ¨å…§é‚Šè·ï¼Œè®“æŒ‰éˆ•æ›´é«˜ */
    font-weight: 500;    /* å­—é«”ç¨å¾®åŠ ç²—ä¸€é» */
    transition: all 0.2s ease; /* æ·»åŠ å¹³æ»‘çš„éæ¸¡æ•ˆæœ */
}

/* ç‚ºæŒ‰éˆ•æ·»åŠ ä¸€å€‹å¾®å¦™çš„é»æ“Šæ•ˆæœ */
#background-activity-details .form-button-secondary:active {
    transform: scale(0.96); /* é»æ“Šæ™‚è¼•å¾®ç¸®å° */
    opacity: 0.8;         /* é»æ“Šæ™‚ç¨å¾®è®Šæ·¡ */
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢çµæœå½ˆçª—æ¨£å¼ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™æ®µæ–°æ¨£å¼ â–¼â–¼â–¼ */
#music-search-results-modal .modal-content {
    z-index: 220; /* é€™å€‹å€¼æ¯”æ’­æ”¾æ¸…å–®çš„ 210 è¦é«˜ */
}
/* â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² */

.search-result-item {
    display: flex;
    flex-direction: column;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢çµæœå½ˆçª—æ¨£å¼ â–¼â–¼â–¼ */

.search-result-item {
    display: flex;
    flex-direction: column;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}

.search-result-item:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

#phone-screen.dark-mode .search-result-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.search-result-item .title {
    font-weight: 500;
    font-size: 15px;
    color: var(--text-primary);
}

.search-result-item .artist {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.search-result-item .source {
    font-size: 10px;
    color: var(--accent-color);
    background-color: rgba(0, 123, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    margin-left: 8px;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢æºé¸æ“‡å½ˆçª—æ¨£å¼ â–¼â–¼â–¼ */
#music-source-selector-modal .modal-body label {
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}
#music-source-selector-modal .modal-body input[type="radio"] {
    width: 18px;
    height: 18px;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€ä½ˆå±€å¾®èª¿ç‰ˆã€‘æ¨£å¼ï¼Œæ›¿æ›æ‰ä¸Šä¸€æ¬¡çš„èˆŠæ¨£å¼ â–¼â–¼â–¼ */

/* 1. é–ƒçˆå‹•ç•« (ä¿æŒä¸è®Š) */
@keyframes flash-char {
    0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 3px rgba(255,192,203, 0); }
    50% { opacity: 0.8; transform: scale(1.08); box-shadow: 0 0 12px rgba(255,192,203, 0.9); }
}
@keyframes flash-user {
    0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 3px rgba(173,216,230, 0); }
    50% { opacity: 0.8; transform: scale(1.08); box-shadow: 0 0 12px rgba(173,216,230, 0.9); }
}

/* 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘èª¿æ•´é ­åƒå®¹å™¨çš„ä¸‹é‚Šè· */
#music-avatars-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 8px; /* <<<< å¾ 25px æ¸›å°åˆ° 8pxï¼Œè®“å®ƒå’Œä¸‹é¢çš„æ–‡å­—æ›´è¿‘ */
    position: relative;
    z-index: 5;
}

/* 3. å–®å€‹é ­åƒæ¨£å¼ (ä¿æŒä¸è®Š) */
#music-avatars-container img {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* 4. åˆ†é–‹é–ƒçˆå‹•ç•« (ä¿æŒä¸è®Š) */
#music-avatars-container.flashing #music-char-avatar {
    animation: flash-char 2.2s infinite ease-in-out;
}
#music-avatars-container.flashing #music-user-avatar {
    animation: flash-user 2.2s infinite ease-in-out 0.3s;
}

/* 5. å¿ƒé›»åœ–æ¨£å¼ (ä¿æŒä¸è®Š) */
#heartbeat-line {
    width: 80px;
    height: 30px;
    overflow: visible;
    margin: 0 -15px;
    opacity: 0;
    transition: opacity 0.5s;
}
#music-avatars-container.flashing #heartbeat-line {
    opacity: 1;
}
.heartbeat-path {
    stroke: #FFC0CB;
    stroke-width: 1.5;
    fill: none;
    stroke-dasharray: 100;
    stroke-dashoffset: 100;
    animation: draw-line 2.2s infinite linear;
    filter: drop-shadow(0 0 3px #FFC0CB); 
}
.heartbeat-heart {
    display: none;
}
@keyframes draw-line {
    to { stroke-dashoffset: 0; }
}

/* 6. ã€æ ¸å¿ƒä¿®æ”¹ã€‘èª¿æ•´â€œä¸€èµ·è½äº†â€æ–‡å­—çš„æ¨£å¼å’Œé‚Šè· */
#music-time-counter {
    margin-bottom: 20px; /* <<<< ç¾åœ¨ç”±å®ƒä¾†è² è²¬å’Œä¸‹é¢çš„å°é¢æ‹‰é–‹è·é›¢ */
    font-size: 11px;
    color: #666; /* é¡è‰²ç¨å¾®åŠ æ·±ä¸€é» */
    text-align: center;
}

/* 7. å”±ç‰‡æ—‹è½‰å‹•ç•« (ä¿æŒä¸è®Š) */
@keyframes spin-record {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* 8. å°é¢å’Œæ­Œè©çš„åˆ‡æ›å®¹å™¨ (ä¿æŒä¸è®Š) */
#music-display-area {
    width: 192px;
    height: 192px;
    margin-bottom: 15px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.3s ease;
}
#music-display-area:active {
    transform: scale(0.98);
}

/* 9. æ­Œæ›²å°é¢ (ä¿æŒä¸è®Š) */
#music-album-cover {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: block;
}
#music-album-cover.rotating {
    animation: spin-record 10s linear infinite;
}
#music-album-cover.paused {
    animation-play-state: paused;
}

/* 10. å…¶ä»–æ¨£å¼ (ä¿æŒä¸è®Š) */
#music-lyrics-container { display: none; }
#music-display-area.show-lyrics #music-album-cover { display: none; }
#music-display-area.show-lyrics #music-lyrics-container { display: block; }
#music-player-song-title { margin-bottom: 2px; }
#music-player-artist { margin-bottom: 10px; }
.music-player-window { min-height: 480px; }

/* â–²â–²â–² ä½ˆå±€å¾®èª¿ç‰ˆæ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘æå‡æœç´¢ç›¸é—œå½ˆçª—çš„å±¤ç´š â–¼â–¼â–¼ */
#music-source-selector-modal,
#custom-modal-overlay {
    z-index: 250 !important; /* é€™å€‹å€¼å¿…é ˆé«˜æ–¼æ’­æ”¾æ¸…å–®(210)ï¼Œ!importantç¢ºä¿å®ƒæ“æœ‰æœ€é«˜å„ªå…ˆé †åº */
}
/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥é©Ÿ 1ï¼šæŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* --- 1. éš±è—èˆŠçš„ä¸»è¢å¹•å…ƒç´  --- */
/* æˆ‘å€‘ä¸å†éœ€è¦èˆŠçš„é–å±æ™‚é˜å’Œåœ–ç¤ºç¶²æ ¼äº†ï¼Œæ–°çš„ä½ˆå±€æœƒå®Œå…¨å–ä»£å®ƒå€‘ */
#home-screen #clock-container,
#home-screen .app-grid {
    display: none !important;
}

/* --- 2. ã€æ ¸å¿ƒã€‘é‡æ–°å®šç¾©ä¸»è¢å¹•ä½ˆå±€ --- */
/* 
   é€™å°‡æŠŠä½ çš„ä¸»è¢å¹•å¾ä¸€å€‹ç°¡å–®çš„å‚ç›´åˆ—è¡¨ï¼Œè®Šæˆä¸€å€‹æ’æ»¿å…¨å±ã€
   ä½¿ç”¨Flexboxä½ˆå±€çš„å¼·å¤§å®¹å™¨ï¼Œç‚ºæ–°çš„â€œæ¡Œé¢å¼â€ä½ˆå±€æ‰“ä¸‹åŸºç¤ã€‚
*/
/* --- 2. ã€æ ¸å¿ƒã€‘é‡æ–°å®šç¾©ä¸»è¢å¹•ä½ˆå±€ --- */
#home-screen {
    /* ä½¿ç”¨ä¸€å€‹æ¼‚äº®çš„ç·šæ€§æ¼¸è®Šä½œç‚ºé è¨­èƒŒæ™¯ï¼Œç•¶ç„¶ä½ å¯ä»¥åœ¨â€œå¤–è§€è¨­ç½®â€è£¡éš¨æ™‚æ›æ‰å®ƒ */
    background: linear-gradient(135deg, #6DD5FA, #2980B9);
    background-size: cover;
    background-position: center;
    
    /* é©é…iPhoneåŠ‰æµ·å’Œåº•éƒ¨å®‰å…¨å€ */
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    
    /* â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™å…©è¡Œ â–¼â–¼â–¼ */
    padding-left: 0;
    padding-right: 0;
    /* â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² */

    /* ä½¿ç”¨Flexboxè®“å…§å®¹å€å’ŒDockæ¬„ä¸Šä¸‹åˆ†é›¢ */
    display: flex;
    flex-direction: column;
    justify-content: space-between; 
    align-items: center;
    height: 100%; /* ç¢ºä¿å®ƒæ’æ»¿è¢å¹• */
}


/* --- 3. ä¸­é–“ä¸»è¦å…§å®¹å€ (å€‹äººè³‡æ–™å¡ + å°å…ƒä»¶ + Appåœ–ç¤º) --- */
#main-content-area {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 30px; /* å¡ç‰‡å’Œä¸‹æ–¹åœ–ç¤ºçš„é–“è· */
    align-items: center;
    margin-top: 20px; /* è·é›¢è¢å¹•é ‚éƒ¨ä¸€é»è·é›¢ */
}

/* --- 4. å€‹äººè³‡æ–™å¡ç‰‡ (é€™æ˜¯è¦–è¦ºæ ¸å¿ƒ) --- */

/* 4a. å¡ç‰‡å¤–å±¤å®¹å™¨ï¼šé€™æ˜¯æ‰€æœ‰å…§éƒ¨å…ƒç´ å®šä½çš„â€œéŒ¨é»â€ */
#profile-widget {
    position: relative; /* é—œéµï¼šè®“å…§éƒ¨çš„é ­åƒå’Œå½å…ƒç´ å¯ä»¥ç›¸å°æ–¼å®ƒé€²è¡Œçµ•å°å®šä½ */
    width: 100%;
    max-width: 380px;
    flex-shrink: 0;
}

/* 4b. èƒŒæ™¯é ­åœ–ï¼šåªçµ¦é ‚éƒ¨è¨­ç½®åœ“è§’ */
#profile-banner-img {
    display: block; 
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 24px 24px 0 0; /* åªçµ¦é ‚éƒ¨è¨­ç½®åœ“è§’ */
    position: relative;
    z-index: 1; /* å±¤ç´š1ï¼šåœ¨æœ€ä¸‹æ–¹ */
}

/* 4c. é ­åƒå®¹å™¨ï¼šç²¾ç¢ºå®šä½ï¼Œä½¿å…¶ä¸­å¿ƒç·šèˆ‡é ­åœ–åº•éƒ¨å°é½Š */
#profile-widget .profile-avatar-container {
    position: absolute;
    top: 80px; /* å¾é ‚éƒ¨å‘ä¸‹åç§»ï¼Œè®“å®ƒä¸€åŠåœ¨é ­åœ–ä¸Šï¼Œä¸€åŠåœ¨ä¸‹é¢ */
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: white; /* ç™½è‰²èƒŒæ™¯æ¿ï¼Œè®“é ­åƒæ›´çªå‡º */
    padding: 4px; /* ç™½è‰²é‚Šæ¡†çš„æ•ˆæœ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 3; /* å±¤ç´š3ï¼šæœ€é«˜å±¤ï¼Œå£“ä½ä¸€åˆ‡ */
}

#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* 4d. ç™½è‰²è³‡è¨Šå¡ç‰‡ï¼šä½¿ç”¨è² å¤–é‚Šè·å¯¦ç¾ç„¡ç¸«æ‹¼æ¥ */
#profile-widget .profile-info {
  /* ã€ä¿®æ”¹å¾Œã€‘ç™½è‰²åˆ°é€æ˜çš„æ¼¸è®ŠèƒŒæ™¯ï¼Œä¸¦åŠ ä¸Šä¸€å±¤æŸ”å’Œçš„é™°å½± */
background: linear-gradient(to bottom, rgba(255, 255, 255, 0.85) 20%, rgba(255, 255, 255, 0));
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border-radius: 24px;
    
    /* æ ¸å¿ƒé­”æ³•ï¼šä½¿ç”¨è² å¤–é‚Šè·ï¼Œå°‡å¡ç‰‡å‘ä¸Šç§»å‹•ï¼Œèˆ‡é ­åœ–å’Œé ­åƒé‡ç–Š */
    margin-top: -24px; 
    
    /* åŒæ™‚ï¼Œç‚ºä¸Šç§»çš„é ­åƒç•™å‡ºç²¾ç¢ºçš„ç©ºé–“ï¼Œé¿å…æ–‡å­—å£“ä½é ­åƒ */
    padding-top: 54px; /* é ­åƒåŠå¾‘(40px) + é¡å¤–é–“è·(14px) */
    
    min-height: 120px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding-left: 15px;
    padding-right: 15px;
    padding-bottom: 15px;
    text-align: center;
    color: #1c1c1e;
    position: relative;
    z-index: 2; /* å±¤ç´š2ï¼šåœ¨é ­åœ–ä¹‹ä¸Šï¼Œä½†åœ¨é ­åƒä¹‹ä¸‹ */
}

/* 4e. å€‹äººè³‡æ–™å…§éƒ¨çš„æ–‡å­—æ¨£å¼ */
#profile-username { font-size: 18px; font-weight: 600; margin: 0 0 2px 0; }
#profile-sub-username { font-size: 13px; color: #8a8a8a; margin: 0 0 10px 0; }
#profile-bio { font-size: 14px; margin: 0 0 12px 0; color: #333; }
#profile-location {
    font-size: 12px; color: #8a8a8a; margin: 0 auto; display: inline-flex;
    align-items: center; gap: 4px; background-color: rgba(0,0,0,0.05);
    padding: 3px 9px; border-radius: 10px;
}

/* --- 5. æ¡Œé¢å¼ä½ˆå±€ (å°å…ƒä»¶ + Appåœ–ç¤º) --- */
#desktop-layout {
    display: grid; /* ä½¿ç”¨Gridä½ˆå±€ï¼Œè¼•é¬†å¯¦ç¾å…©åˆ— */
    grid-template-columns: 1fr 1.1fr; /* å·¦çª„å³å¯¬çš„å…©åˆ— */
    gap: 20px;
    width: 100%;
    align-items: start;
}
#desktop-widget-column {
    display: flex;
    flex-direction: row;
    justify-content: space-between; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡ space-around æ”¹ç‚º space-between */
    align-items: start;
    width: 100%;
}

/* å³å´Appåœ–ç¤ºå®¹å™¨ */
#desktop-app-container {
    display: grid;
    grid-template-columns: 1fr 1fr; /* å…©åˆ—åœ–ç¤º */
    gap: 25px;
    align-content: start;
}
.desktop-app-icon {
    display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center;
}
.icon-bg-desktop {
    width: 55px; height: 55px; border-radius: 14px; background-color: #f0f2f5; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease; overflow: hidden;
}
.icon-bg-desktop img { width: 100%; height: 100%; object-fit: cover; border-radius: 0; }
.desktop-app-icon .label { color: #333; font-size: 13px; font-weight: 500; }
.desktop-app-icon:active .icon-bg-desktop { transform: scale(0.9); }


/* --- 6. åº•éƒ¨ Dock æ¬„ --- */
#desktop-dock {
    background-color: rgba(255, 255, 255, 0.15); /* ç»ç’ƒæ“¬æ…‹èƒŒæ™¯ */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 15px 25px;
    display: flex;
    justify-content: center;
    gap: 30px;
    width: fit-content; /* å¯¬åº¦è‡ªæˆ‘èª¿æ•´å…§å®¹ */
    flex-shrink: 0;
}

/* --- 7. ã€æ ¸å¿ƒåŠŸèƒ½ã€‘ç‚ºå¯ç·¨è¼¯å…ƒç´ æ·»åŠ è¦–è¦ºå›é¥‹ --- */
.editable-text, .editable-image {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

/* æ»‘é¼ æ‡¸åœæ™‚ï¼Œé¡¯ç¤ºä¸€å€‹åŠé€æ˜çš„è™›ç·šå¤–æ¡†ï¼Œä¸¦è¼•å¾®è®Šæš—ï¼Œæç¤ºç”¨æˆ¶é€™è£¡å¯ä»¥é» */
.editable-text:hover, .editable-image:hover {
    outline: 2px dashed rgba(0, 0, 0, 0.4);
    opacity: 0.85;
    border-radius: 4px; /* è®“å¤–æ¡†ä¹Ÿæœ‰ä¸€é»åœ“è§’ */
}

/* --- 8. ã€é–å±ç›¸å®¹ã€‘è®“é–å±å’Œä¸»è¢å¹•å¯ä»¥å †ç–Š --- */
#lock-screen, #home-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
#lock-screen {
    z-index: 999; /* ç¢ºä¿é–å±åœ¨æœ€ä¸Šå±¤ */
}
/* â–¼â–¼â–¼ é€™æ˜¯æ–°å¢çš„æ¡Œé¢å°å…ƒä»¶æ¨£å¼ â–¼â–¼â–¼ */

/* å–®å€‹å°çµ„ä»¶çš„ç¸½å®¹å™¨ */
.custom-widget-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px; /* å„å€‹å…ƒç´ ä¹‹é–“çš„å‚ç›´é–“è· */
}

.widget-bubble {
    position: relative;
    background-color: rgba(255, 255, 255, 0.9);
    color: #333;
    padding: 8px 12px;
    border-radius: 20px; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¢åŠ åœ“è§’ï¼Œå¯¦ç¾è† å›Šæ„Ÿ */
    font-size: 13px;
    font-weight: 500;
    /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç§»é™¤ min-widthï¼Œè®“å¯¬åº¦è‡ªæˆ‘èª¿æ•´å…§å®¹ */
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}


/* ç”¨å½å…ƒç´ çµ¦æ°£æ³¡åŠ ä¸€å€‹å°å°¾å·´ï¼ŒæŒ‡å‘ä¸‹é¢çš„åœ“å½¢åœ–ç‰‡ */
.widget-bubble::after {
    content: '';
    position: absolute;
    bottom: -6px; /* å°¾å·´åœ¨æ°£æ³¡ä¸‹æ–¹ */
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px 6px 0;
    border-style: solid;
    border-color: rgba(255, 255, 255, 0.9) transparent transparent transparent;
}

.widget-circle-uploader {
    width: 65px; /* å¾ 80px ç¸®å° */
    height: 65px; /* å¾ 80px ç¸®å° */
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    padding: 3px;
    background-color: transparent; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡èƒŒæ™¯è‰²æ”¹ç‚ºé€æ˜ */ 
    box-sizing: border-box;
}


/* é€™æ˜¯æ›¿æ›å¾Œçš„ç¬¬äºŒå¡Š */
.widget-circle-uploader img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%; /* ã€æ ¸å¿ƒã€‘è®“åœ–ç‰‡ä¹Ÿè®Šæˆåœ“å½¢ï¼Œå®Œç¾é©æ‡‰å…§é‚Šè· */
}


/* ä¸‹æ–¹çš„é€æ˜æ–‡å­—å€åŸŸ */
.widget-subtext {
    background: transparent;
    border: none;
    color:  #333;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5); /* åŠ ä¸€é»æ–‡å­—é™°å½±æ›´æ¸…æ™° */
    font-size: 13px;
    font-weight: 500;
    text-align: center;
}

/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€V3æœ€çµ‚ç¾åŒ–ç‰ˆã€‘ä¸»è¢å¹•ç¾åŒ–é è¨­åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
.preset-manager-container {
    width: 100%;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}
#phone-screen.dark-mode .preset-manager-container {
    border-top-color: #3a3a3c;
}
.preset-manager-container .form-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.preset-manager-controls {
    display: grid;
    grid-template-columns: 1fr 1fr; /* ã€æ ¸å¿ƒã€‘2x2 ç¶²æ ¼ä½ˆå±€ */
    gap: 12px; /* æŒ‰éˆ•é–“è· */
    width: 100%;
}
.preset-btn-capsule {
    padding: 12px 15px; /* å¢åŠ å‚ç›´å…§é‚Šè·ï¼Œè®“æŒ‰éˆ•æ›´é«˜æ›´å¯æ„› */
    border: none;
    border-radius: 25px; /* æ›´å¤§çš„åœ“è§’ï¼Œè† å›Šæ„Ÿæ›´å¼· */
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08); /* å¢åŠ ä¸€é»ç«‹é«”é™°å½± */
}
.preset-btn-capsule:active {
    transform: scale(0.96);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.preset-btn-capsule:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    box-shadow: none;
    background-color: #e9ecef !important; /* ç¦ç”¨æ™‚çµ±ä¸€ç”¨ç°è‰² */
    color: #adb5bd !important;
    border-color: #dee2e6 !important;
}
#phone-screen.dark-mode .preset-btn-capsule:disabled {
    background-color: #3a3a3c !important;
    color: #545458 !important;
}
.preset-btn-apply {
    background-color: var(--accent-color); /* æ‡‰ç”¨æŒ‰éˆ•ä½¿ç”¨ä¸»é¡Œè‰² */
    color: white;
    grid-column: 1 / -1; /* ã€æ ¸å¿ƒã€‘è®“æ‡‰ç”¨æŒ‰éˆ•ç¨ä½”ä¸€è¡Œï¼Œæ›´çªå‡º */
}
.preset-btn-save {
    background-color: #4cd964; /* ä¿å­˜ç”¨ç¶ è‰²ï¼Œä»£è¡¨å‰µå»º */
    color: white;
}
.preset-btn-secondary {
    background-color: #f8f9fa;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .preset-btn-secondary {
    background-color: #3a3a3c;
    border-color: #545458;
}
.preset-btn-delete {
    background-color: #ffdde5;
    color: #ff3b30;
}
#phone-screen.dark-mode .preset-btn-delete {
    background-color: #5c2b2b;
    color: #ff8a80;
}
/* â–²â–²â–² æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */



/* â–¼â–¼â–¼ ã€V6æœ€çµ‚ä¿®å¾©ç‰ˆã€‘å¤œé–“æ¨¡å¼çµ‚æ¥µé©é… (å·²ä¿®å¾©æ‰€æœ‰é é¢é©é…å•é¡Œ) â–¼â–¼â–¼ */

/* æ ¸å¿ƒï¼šç•¶ #phone-screen æ“æœ‰ .dark-mode é¡æ™‚ï¼Œå•Ÿå‹•ä»¥ä¸‹æ‰€æœ‰æ¨£å¼ */

/* 1. å…¨åŸŸé‡æ–°å®šç¾©é¡è‰²è®Šæ•¸ */
#phone-screen.dark-mode {
  --secondary-bg: #1c1c1e;
  --border-color: #38383a;
  --text-primary: #ffffff;
  --text-secondary: #8e8e93;
  --status-bar-text-color: #ffffff;
}

/* 2. ã€åŸºç¤ã€‘ç‚ºæ‰€æœ‰è¢å¹•å’Œä¸»è¦å®¹å™¨è¨­ç½®åŸºç¤æ·±è‰²èƒŒæ™¯ */
#phone-screen.dark-mode,
#phone-screen.dark-mode .screen,
#phone-screen.dark-mode #chat-list,
#phone-screen.dark-mode #world-book-list,
#phone-screen.dark-mode .list-container,
#phone-screen.dark-mode .form-container,
#phone-screen.dark-mode #chat-messages {
    background-color: #000000 !important;
}

/* 3. ã€ä¸»è¢å¹•ã€‘å°ˆå±¬æ¨£å¼ (å¾è¢«åˆªé™¤çš„ä»£ç¢¼ä¸­æ¢å¾©ä¸¦æ•´åˆ) */
#phone-screen.dark-mode #home-screen {
    background: #111827; /* æ·±è—è‰²èƒŒæ™¯ */
}
#phone-screen.dark-mode #desktop-dock {
    background-color: rgba(55, 65, 81, 0.5); /* Dockæ¬„æ·±ç°è‰²ç»ç’ƒæ•ˆæœ */
}
#phone-screen.dark-mode .desktop-app-icon .label,
#phone-screen.dark-mode .widget-subtext {
    color: #e5e7eb; /* æ¡Œé¢æ–‡å­—è®Šç‚ºæ·ºç°è‰² */
    text-shadow: 0 1px 2px rgba(0,0,0,0.7); /* åŠ å¼·é™°å½± */
}
#phone-screen.dark-mode #profile-widget .profile-info {
    background: linear-gradient(to bottom, rgba(28, 28, 30, 0.85) 20%, rgba(28, 28, 30, 0)); /* è³‡è¨Šå¡ç‰‡æ·±ç°è‰²æ¼¸è®Š */
    color: #f9fafb;
}
#phone-screen.dark-mode #profile-username,
#phone-screen.dark-mode #profile-bio,
#phone-screen.dark-mode #profile-location span {
    color: #f9fafb; /* è³‡è¨Šå¡ç‰‡ä¸»æ–‡å­—ç™½è‰² */
}
#phone-screen.dark-mode #profile-sub-username,
#phone-screen.dark-mode #profile-location {
    color: #9ca3af; /* è³‡è¨Šå¡ç‰‡æ¬¡è¦æ–‡å­—ç°è‰² */
}
#phone-screen.dark-mode #profile-location {
    background-color: rgba(255,255,255,0.1); /* åœ°é»èƒŒæ™¯è®Šäº® */
}
#phone-screen.dark-mode .widget-bubble {
    background-color: rgba(55, 65, 81, 0.9); /* å°çµ„ä»¶æ°£æ³¡æ·±ç°è‰² */
    color: #e5e7eb; /* å°å…ƒä»¶æ–‡å­—æ·ºç°è‰² */
}
#phone-screen.dark-mode .widget-bubble::after {
    border-top-color: rgba(55, 65, 81, 0.9); /* å°å°¾å·´é¡è‰²åŒæ­¥ */
}

/* 4. ã€ä¿®å¾©ã€‘é©é…æ‰€æœ‰é é¢çš„é ­éƒ¨Header */
#phone-screen.dark-mode .header,
#phone-screen.dark-mode .qzone-header {
    background-color: rgba(28, 28, 30, 0.85) !important;
    border-bottom-color: var(--border-color) !important;
    color: var(--text-primary) !important; 
}

/* 5. ã€ä¿®å¾©ã€‘é©é…æ‰€æœ‰è¬ç”¨ç¾¤çµ„ä»¶ (å½ˆçª—ã€è¼¸å…¥æ¡†ç­‰) */
#phone-screen.dark-mode #chat-input-area,
#phone-screen.dark-mode #chat-list-bottom-nav {
    background-color: rgba(28, 28, 30, 0.85);
    border-top-color: var(--border-color);
}
#phone-screen.dark-mode #chat-input {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
}
#phone-screen.dark-mode .modal-content,
#phone-screen.dark-mode #custom-modal {
    background-color: #2c2c2e;
}
#phone-screen.dark-mode .modal-header, 
#phone-screen.dark-mode .modal-footer,
#phone-screen.dark-mode .custom-modal-footer {
    border-color: var(--border-color);
}
#phone-screen.dark-mode .form-group input,
#phone-screen.dark-mode .form-group select,
#phone-screen.dark-mode .form-group textarea {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    border-color: var(--border-color);
}
#phone-screen.dark-mode .list-item,
#phone-screen.dark-mode .chat-list-item-swipe-container:not(:last-child) {
    border-bottom-color: var(--border-color);
}
#phone-screen.dark-mode .list-item:hover,
#phone-screen.dark-mode .chat-list-item:hover {
    background-color: #2c2c2e;
}

/* 6. ã€è§£æ±ºã€‘å­—é«”é è¨­ & å¤–è§€è¨­ç½®é é¢æ·±åº¦é©é… */
#phone-screen.dark-mode #font-settings-screen,
#phone-screen.dark-mode #wallpaper-screen {
    background-color: #000000;
}
#phone-screen.dark-mode .font-preset-slot,
#phone-screen.dark-mode #font-preview,
#phone-screen.dark-mode #wallpaper-preview {
    background-color: var(--secondary-bg);
    border-color: var(--border-color);
}
#phone-screen.dark-mode .preset-btn.secondary {
    background-color: #3e3e42;
    border-color: #545458;
}

/* 7. ã€è§£æ±ºã€‘â€œæŸ¥æ‰‹æ©Ÿâ€åŠŸèƒ½æ‰€æœ‰å…§éƒ¨é é¢æ·±åº¦é©é… */
#phone-screen.dark-mode #character-phone-container {
    background-color: #000000;
}
#phone-screen.dark-mode .character-phone-frame {
    background-color: #111;
}
#phone-screen.dark-mode .character-phone-inner-screen,
#phone-screen.dark-mode .character-phone-page {
    background-color: #000000;
}
#phone-screen.dark-mode .character-phone-header {
    background-color: rgba(28, 28, 30, 0.85) !important;
    border-bottom: 1px solid #38383a !important;
}
#phone-screen.dark-mode #character-app-grid .label {
    color: #e5e7eb;
}
#phone-screen.dark-mode .character-chat-list .chat-list-item:hover {
    background-color: #1c1c1e;
}
#phone-screen.dark-mode #character-chat-history-messages {
    background-color: #0e0e0e !important;
}
#phone-screen.dark-mode .character-chat-bubble.received {
    background-color: #2c2c2e;
}
#phone-screen.dark-mode .character-data-item,
#phone-screen.dark-mode .character-bank-transaction,
#phone-screen.dark-mode .character-cart-item,
#phone-screen.dark-mode .character-browser-item {
    background-color: #1c1c1e;
    border-color: #38383a;
}
#phone-screen.dark-mode .character-data-item .title,
#phone-screen.dark-mode .character-data-item .content,
#phone-screen.dark-mode .cart-item-price {
    color: var(--text-primary);
}
#phone-screen.dark-mode .character-bank-balance-card {
    background: linear-gradient(135deg, #3a3a3c, #1c1c1e);
}
#phone-screen.dark-mode #character-diary-list .character-data-item {
    background-color: #1a1510;
    border-color: #4a443b;
    border-left-color: #8c7d6b;
}
#phone-screen.dark-mode #character-select-item .name {
    color: #80CBC4 !important; /* æŸ”å’Œçš„é’è‰² */
}

/* 8. ã€æ–°å¢ã€‘ä¿®å¾©èŠå¤©åˆ—è¡¨åˆ†çµ„æ¨™é¡Œçš„èƒŒæ™¯è‰² */
#phone-screen.dark-mode .chat-group-header {
    background-color: #1c1c1e;
}
#phone-screen.dark-mode .chat-list-item-content.pinned {
    background-color: #3a3a3c;
}

/* â–²â–²â–² CSS ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥é©Ÿ 1.1ï¼šå°‡é€™æ•´å¡Šã€çµ‚æ¥µä¿®å¾©ç‰ˆã€‘CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* æ ¸å¿ƒä¿®å¾©ï¼šä½¿ç”¨ !important å¼·åˆ¶æå‡å„ªå…ˆé †åºï¼Œè¦†è“‹æ‰æ‰€æœ‰æ—äº‚çš„å…§è¯æ¨£å¼ */

/* 1. ç‚ºæ‰€æœ‰éœ€è¦é©é…çš„è¢å¹•å¼·åˆ¶è¨­ç½®ç´”é»‘èƒŒæ™¯ */
#phone-screen.dark-mode #wallpaper-screen,
#phone-screen.dark-mode #font-settings-screen,
#phone-screen.dark-mode #api-settings-screen,
#phone-screen.dark-mode #character-selection-screen,
#phone-screen.dark-mode #world-book-screen,
#phone-screen.dark-mode #world-book-editor-screen,
#phone-screen.dark-mode .form-container, /* ç¢ºä¿æ‰€æœ‰è¡¨å–®å®¹å™¨ä¹Ÿé©é… */
#phone-screen.dark-mode .list-container { /* ç¢ºä¿æ‰€æœ‰åˆ—è¡¨å®¹å™¨ä¹Ÿé©é… */
    background-color: #000000 !important;
}

/* 2. ç‚ºâ€œæŸ¥æ‰‹æ©Ÿâ€å…§éƒ¨çš„æ‰€æœ‰é é¢å¼·åˆ¶è¨­ç½®ç´”é»‘èƒŒæ™¯ */
#phone-screen.dark-mode .character-phone-inner-screen,
#phone-screen.dark-mode .character-phone-page {
    background-color: #000000 !important;
}
#phone-screen.dark-mode #character-chat-history-messages {
    background-color: #0e0e0e !important; /* èŠå¤©è¨˜éŒ„ç”¨æ·±ç°è‰² */
}

/* 3. ä¿®å¾©é é¢å…§éƒ¨å…ƒä»¶çš„èƒŒæ™¯è‰² */
#phone-screen.dark-mode #font-preview,
#phone-screen.dark-mode #wallpaper-preview {
    background-color: #1c1c1e !important;
    border-color: #38383a !important;
}

/* 4. ä¿®å¾©â€œæŸ¥æ‰‹æ©Ÿâ€è£¡å°æ–¹çš„èŠå¤©æ°£æ³¡é¡è‰² */
#phone-screen.dark-mode .character-chat-bubble.received {
    background-color: #2c2c2e !important;
}
/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘æå‡æ‰€æœ‰å½ˆçª—çš„å±¤ç´š â–¼â–¼â–¼ */
#music-source-selector-modal,
#music-search-results-modal {
    z-index: 250 !important; /* é€™å€‹å€¼é«˜æ–¼æ’­æ”¾æ¸…å–®(210)ï¼Œ!importantç¢ºä¿å®ƒæ“æœ‰æœ€é«˜å„ªå…ˆé †åº */
}
/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘é€šç”¨æ“ä½œåŠŸèƒ½è¡¨æŒ‰éˆ• */
#preset-actions-modal .custom-modal-footer button {
    width: 100%;
    border: none; /* ç§»é™¤é‚Šæ¡† */
    border-radius: 20px; /* â˜…â˜…â˜… ä¿®æ”¹é€™è£¡ï¼æŠŠ 12px æ”¹æˆäº† 20px â˜…â˜…â˜… */
    padding: 14px;
    font-size: 16px; /* å­—é«”ç¨å¾®ç¸®å°ä¸€é»ï¼Œæ›´ç²¾ç·» */
    font-weight: 500;
    margin-bottom: 8px; /* æŒ‰éˆ•ä¹‹é–“çš„å‚ç›´é–“è· */
    background-color: #f0f0f0; /* çµ±ä¸€çš„æ·ºç°è‰²èƒŒæ™¯ */
    color: var(--text-primary);
    transition: background-color 0.2s, transform 0.1s; /* æ·»åŠ å‹•ç•« */
}

/* æ»‘é¼ æ‡¸åœå’Œé»æ“Šæ•ˆæœ */
#preset-actions-modal .custom-modal-footer button:hover {
    background-color: #e0e0e0;
}
#preset-actions-modal .custom-modal-footer button:active {
    transform: scale(0.98); /* é»æ“Šæ™‚è¼•å¾®ç¸®å° */
}

/* å–®ç¨ç¾åŒ–â€œåˆªé™¤â€æŒ‰éˆ• */
#preset-actions-modal .custom-modal-footer button.btn-danger {
    background-color: #ffe5e5;
    color: #ff3b30;
}
#preset-actions-modal .custom-modal-footer button.btn-danger:hover {
    background-color: #ffcccc;
}

/* ç¾åŒ–â€œå–æ¶ˆâ€æŒ‰éˆ• */
#preset-actions-modal .custom-modal-footer button:last-child {
    background-color: #e9ecef;
    margin-top: 4px; /* å’Œä¸Šé¢çš„æŒ‰éˆ•ç¨å¾®æ‹‰é–‹ä¸€é»è·é›¢ */
}
#preset-actions-modal .custom-modal-footer button:last-child:hover {
    background-color: #dcdfe3;
}

/* ç§»é™¤æŒ‰éˆ•ä¹‹é–“çš„åˆ†å‰²ç·š */
#preset-actions-modal .custom-modal-footer button {
    border-bottom: none !important;
}

/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* ã€æ ¸å¿ƒä¿®æ­£ã€‘æå‡é€šç”¨æ“ä½œåŠŸèƒ½è¡¨çš„å±¤ç´šï¼Œç¢ºä¿å®ƒèƒ½è¦†è“‹æ’­æ”¾æ¸…å–® */
#preset-actions-modal {
    z-index: 220; /* é€™å€‹å€¼æ¯”æ’­æ”¾æ¸…å–®(210)æ›´é«˜ï¼Œå°±ä¸æœƒè¢«æ“‹ä½äº† */
}

/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œæŸ¥æ‰‹æ©Ÿâ€å…§å®¹æ·»åŠ çš„åˆªé™¤æŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */
.character-data-item, .character-cart-item, .character-browser-item, .character-bank-transaction, .character-trajectory-item, .character-app-usage-item, .character-album-item {
    position: relative; /* è®“åˆªé™¤æŒ‰éˆ•å¯ä»¥ç›¸å°æ–¼å®ƒå®šä½ */
    padding-right: 35px; /* åœ¨å³é‚Šçµ¦åˆªé™¤æŒ‰éˆ•ç•™å‡ºä½ç½® */
}

.item-delete-btn {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    background-color: #f0f0f0;
    color: #888;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 24px;
    text-align: center;
    transition: all 0.2s ease;
}

.item-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿå¾®ä¿¡æ¶ˆæ¯åˆªé™¤æŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */
.character-chat-bubble-container {
    position: relative; /* è®“åˆªé™¤æŒ‰éˆ•å¯ä»¥ç›¸å°æ–¼å®ƒå®šä½ */
}

.message-delete-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.1);
    color: #555;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    opacity: 0; /* é»˜èªéš±è— */
    transition: all 0.2s ease;
}

.character-chat-bubble-container:hover .message-delete-btn {
    opacity: 1; /* æ»‘é¼ æ‡¸åœæ™‚é¡¯ç¤º */
}

.message-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}

/* æ ¹æ“šæ¶ˆæ¯æ˜¯å·¦æ˜¯å³ï¼Œèª¿æ•´åˆªé™¤æŒ‰éˆ•çš„ä½ç½® */
.character-chat-bubble-container.sent .message-delete-btn {
    left: -28px;
}
.character-chat-bubble-container.received .message-delete-btn {
    right: -28px;
}
/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */

/* â–²â–²â–² CSS é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘å¼·åˆ¶ä¿®æ­£æ‰€æœ‰è¨­ç½®é é¢çš„åº•éƒ¨å®‰å…¨å€ â–¼â–¼â–¼ */
#font-settings-screen .form-container,
#wallpaper-screen .form-container,
#api-settings-screen .form-container,
#css-editor-screen .form-container {
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
}
/* â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘iOSé¢¨æ ¼çš„æ»‘å‹•é–‹é—œæ¨£å¼ â–¼â–¼â–¼ */

.toggle-switch-label {
    display: flex;
    align-items: center;
    justify-content: space-between; /* è®“æ–‡å­—å’Œé–‹é—œå…©ç«¯å°é½Š */
    cursor: pointer;
    user-select: none;
    width: 100%;
    padding: 10px 0; /* å¢åŠ ä¸€é»ä¸Šä¸‹é–“è· */
}

.toggle-switch-text {
    font-weight: 500;
    color: var(--text-primary);
}

/* éš±è—åŸå§‹çš„ checkbox */
.toggle-switch-label input[type="checkbox"] {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
}

/* é–‹é—œçš„è»Œé“ */
.toggle-switch-slider {
    position: relative;
    display: inline-block;
    width: 51px;
    height: 31px;
    background-color: #e9e9eb;
    border-radius: 34px;
    transition: background-color 0.2s;
    flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
}

/* é–‹é—œçš„æ»‘å¡Š (é‚£å€‹ç™½è‰²åœ“é») */
.toggle-switch-slider::before {
    content: "";
    position: absolute;
    height: 27px;
    width: 27px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

/* ç•¶ checkbox è¢«é¸ä¸­æ™‚ï¼Œæ”¹è®Šè»Œé“çš„é¡è‰² */
.toggle-switch-label input:checked + .toggle-switch-slider {
    background-color: #34c759; /* iOS é¢¨æ ¼çš„ç¶ è‰² */
}

/* ç•¶ checkbox è¢«é¸ä¸­æ™‚ï¼Œç§»å‹•æ»‘å¡Š */
.toggle-switch-label input:checked + .toggle-switch-slider::before {
    transform: translateX(20px);
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯ç‚ºä½ æ–°å¢çš„é¡è‰²æ¨£å¼ â–¼â–¼â–¼ */

/* 1. æŠŠæ™‚é–“çš„é¡è‰²å¼·åˆ¶è¨­ç½®ç‚ºé»‘è‰² */
#status-bar-time {
    color: #000000 !important; /* !important ç¢ºä¿å®ƒå„ªå…ˆé †åºæœ€é«˜ */
}

/* 2. æŠŠé›»æ± å®¹å™¨å…§çš„æ‰€æœ‰æ±è¥¿ï¼ˆåœ–ç¤ºé‚Šæ¡†ã€é›»é‡æ¢ã€ç™¾åˆ†æ¯”æ–‡å­—ï¼‰éƒ½è¨­ç½®ç‚ºç¶ è‰² */
#status-bar-battery {
    color: #4CAF50 !important; /* é€™æ˜¯ä¸€å€‹å¾ˆå¥½çœ‹çš„ç¶ è‰² */
}

/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯æ­¥é©Ÿ1éœ€è¦é»è²¼çš„æ–°æ¨£å¼ â–¼â–¼â–¼ */

/* è®“æ¯ä¸€æ¢è©•è«–éƒ½è®Šæˆå¯é»æ“Šçš„ */
.comment-item {
    cursor: pointer; /* æ»‘é¼ æ‡¸åœæ™‚é¡¯ç¤ºç‚ºå°æ‰‹å½¢ç‹€ */
    transition: background-color 0.2s; /* æ·»åŠ ä¸€å€‹å¹³æ»‘çš„èƒŒæ™¯è‰²éæ¸¡å‹•ç•« */
    border-radius: 4px; /* çµ¦ä¸€é»é»åœ“è§’ï¼Œæ›´å¥½çœ‹ */
    padding: 2px 5px; /* å¢åŠ ä¸€é»å…§é‚Šè·ï¼Œè®“é»æ“Šå€åŸŸæ›´å¤§ */
    margin: 0 -5px; /* æŠŠä¸Šé¢çš„å…§é‚Šè·æŠµæ¶ˆæ‰ï¼Œä¿æŒå°é½Š */
}
.comment-item:hover {
    background-color: #f0f2f5; /* æ»‘é¼ æ”¾ä¸Šå»æ™‚ï¼Œçµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯è‰² */
}
#phone-screen.dark-mode .comment-item:hover {
    background-color: #2c2c2e; /* å¤œé–“æ¨¡å¼ä¸‹çš„æ‡¸åœé¡è‰² */
}

/* â€œå›å¾©â€é€™å…©å€‹å­—çš„æ¨£å¼ */
.comment-item .reply-text {
    color: var(--text-secondary);
    margin: 0 4px; /* å’Œå…©é‚Šçš„åå­—æ‹‰é–‹ä¸€é»è·é›¢ */
}

/* è¢«å›å¾©è€…çš„åå­—æ¨£å¼ */
.comment-item .reply-target-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è¨˜éŒ„æœç´¢åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* æœç´¢çµæœåˆ—è¡¨ */
#chat-search-results-list {
    flex-grow: 1; /* ä½”æ“šå‰©é¤˜æ‰€æœ‰ç©ºé–“ */
    overflow-y: auto; /* å…§å®¹å¤šäº†å¯ä»¥æ»¾å‹• */
}

/* å–®æ¢æœç´¢çµæœçš„æ¨£å¼ */
.search-result-item {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    gap: 12px; /* é ­åƒå’Œå…§å®¹çš„é–“è· */
    align-items: flex-start;
}
.search-result-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode .search-result-item:hover {
    background-color: #2c2c2e;
}

/* çµæœä¸­çš„é ­åƒ */
.search-result-item .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
}

/* çµæœå³å´è³‡è¨Šï¼ˆåå­—ã€æ™‚é–“ã€å…§å®¹ï¼‰ */
.search-result-info {
    display: flex;
    flex-direction: column;
    gap: 4px; /* è³‡è¨Šå…§éƒ¨çš„å‚ç›´é–“è· */
    overflow: hidden; /* é˜²æ­¢å…§å®¹éé•·æº¢å‡º */
}

/* åå­—å’Œæ™‚é–“çš„å®¹å™¨ */
.search-result-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-secondary);
}

.search-result-meta .name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
}

/* æ¶ˆæ¯å…§å®¹ */
.search-result-content {
    font-size: 14px;
    line-height: 1.5;
    word-break: break-all; /* ç¢ºä¿é•·æ–‡æœ¬èƒ½æ›è¡Œ */
}

/* ã€æ ¸å¿ƒã€‘é—œéµå­—é«˜äº®æ¨£å¼ */
.highlight {
    background-color: #FFDE5C; /* äº®é»ƒè‰²èƒŒæ™¯ */
    color: #5D4037; /* æ·±æ£•è‰²æ–‡å­—ï¼Œå°æ¯”æ›´æ¸…æ™° */
    font-weight: bold;
    padding: 1px 3px;
    border-radius: 3px;
}

/* è·³è½‰å¾Œæ¶ˆæ¯çš„é–ƒçˆå‹•ç•« */
@keyframes flash-highlight {
    0% { background-color: transparent; }
    25% { background-color: rgba(255, 222, 92, 0.7); }
    100% { background-color: transparent; }
}
.message-bubble.flash {
    animation: flash-highlight 1.5s ease-out;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ã€‘è§£æ±ºæœç´¢çµæœçœ‹ä¸è¦‹çš„å•é¡Œ â–¼â–¼â–¼ */
#chat-search-screen .form-container {
    padding-bottom: 20px; /* çµ¦åº•éƒ¨ä¸€é»ç©ºé–“ */
}

#search-results-list {
    flex-grow: 1; /* æ ¸å¿ƒï¼šè®“çµæœåˆ—è¡¨ä½”æ“šæ‰€æœ‰å‰©é¤˜çš„å‚ç›´ç©ºé–“ */
    overflow-y: auto; /* æ ¸å¿ƒï¼šå¦‚æœçµæœå¤ªå¤šï¼Œè®“å®ƒè‡ªå·±å‡ºç¾æ²è»¸ */
    min-height: 0; /* ä¸€å€‹ç¥å¥‡çš„CSSå±¬æ€§ï¼Œç”¨æ–¼è§£æ±ºflexä½ˆå±€ä¸‹çš„æº¢å‡ºå•é¡Œ */
    border-top: 1px solid var(--border-color); /* åœ¨çµæœå’ŒæŒ‰éˆ•ä¹‹é–“åŠ ä¸€æ¢åˆ†å‰²ç·šï¼Œæ›´ç¾è§€ */
    margin-top: 15px; /* å’Œä¸Šé¢çš„æŒ‰éˆ•æ‹‰é–‹è·é›¢ */
    padding-top: 10px; /* åˆ—è¡¨é ‚éƒ¨çš„å…§é‚Šè· */
}
/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* çµ±ä¸€æ¨£å¼ï¼Œè®“åœ–ç¤ºå’Œæ–‡å­—æŒ‰éˆ•å°é½Š */
#music-playlist-panel .playlist-header .panel-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„åƒåœ¾æ¡¶æ¨£å¼ â–¼â–¼â–¼ */

/* è¨­ç½®åƒåœ¾æ¡¶åœ–ç¤ºçš„é è¨­æ¨£å¼ */
#delete-expired-songs-btn svg {
    color: inherit; /* æ ¸å¿ƒä¿®æ”¹1: å¹³æ™‚é¡è‰²ç¹¼æ‰¿çˆ¶å…ƒç´ ï¼Œå’Œ"æœ¬åœ°"ç­‰æ–‡å­—é¡è‰²ä¸€æ¨£ï¼Œä¿æŒä½èª¿ */
    transition: color 0.2s, transform 0.2s; /* æ·»åŠ transforméæ¸¡æ•ˆæœ */
    transform: translateY(3px); /* æ ¸å¿ƒä¿®æ”¹2: è®“åœ–ç¤ºæ•´é«”ä¸‹ç§»3åœ–å…ƒï¼Œè¦–è¦ºä¸Šæ›´å°é½Š */
}

/* è¨­ç½®æ»‘é¼ æ‡¸åœ/é»æ“Šæ™‚çš„æ¨£å¼ */
#delete-expired-songs-btn:hover svg,
#delete-expired-songs-btn:active svg {
    color: #ff3b30; /* æ ¸å¿ƒä¿®æ”¹3: æ»‘é¼ æ”¾ä¸Šå»æˆ–é»æ“Šæ™‚ï¼Œæ‰è®Šç‚ºé†’ç›®çš„ç´…è‰² */
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* ã€æ ¸å¿ƒã€‘å°ˆé–€ç‚ºè§’è‰²æ‰‹æ©Ÿè£¡çš„æ—¥è¨˜åˆªé™¤æŒ‰éˆ•ï¼Œé‡æ–°å®šç¾©ä½ç½® */
#character-diary-list .character-data-item .item-delete-btn {
    top: auto;         /* è§£é™¤é ‚éƒ¨çš„å®šä½ */
    right: auto;       /* è§£é™¤å³å´çš„å®šä½ */
    bottom: 8px;       /* å®šä½åˆ°è·é›¢åº•éƒ¨8åœ–å…ƒ */
    left: 8px;         /* å®šä½åˆ°è·é›¢å·¦å´8åœ–å…ƒ */
    opacity: 0;        /* ä¿æŒé»˜èªéš±è— */
    transition: opacity 0.2s ease; /* ä¿æŒæ·¡å…¥æ·¡å‡ºå‹•ç•« */
}

/* ã€ç¾åŒ–ã€‘æ»‘é¼ æ‡¸åœåœ¨æ•´å¼µæ—¥è¨˜å¡ç‰‡ä¸Šæ™‚ï¼Œæ‰é¡¯ç¤ºé€™å€‹æŒ‰éˆ• */
#character-diary-list .character-data-item:hover .item-delete-btn {
    opacity: 1;
}

/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒè²åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è·³å‹•çš„å¿ƒå‹•ç•« */
@keyframes heartbeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
#char-heart-btn svg {
    animation: heartbeat 1.5s infinite ease-in-out;
}

/* 2. å¿ƒè²é¢æ¿ä¸»å…§å®¹æ¨£å¼ (å·²ä¿®å¾©) */
#inner-voice-avatar-wrapper::after {
    content: '';
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border: 1.5px solid transparent; /* é»˜èªæ˜¯é€æ˜é‚Šæ¡†ï¼Œçœ‹ä¸è¦‹ */
    border-radius: 50%;
    pointer-events: none;
    transition: border-color 0.2s ease-in-out; /* æ·»åŠ å¹³æ»‘éæ¸¡ */
}
/* ã€æ ¸å¿ƒã€‘åƒ…ç•¶æ²’æœ‰é ­åƒæ¡†æ™‚(.has-border)ï¼Œæ‰é¡¯ç¤ºç´…ç·š */
#inner-voice-avatar-wrapper.has-border::after {
    border-color: #ff8a80; /* ä½ æƒ³è¦çš„ç´…è‰²è¼ªå»“ç·š */
}

#inner-voice-content-area p {
    white-space: pre-wrap; /* è®“åˆ†è¡Œç¬¦è™Ÿå’Œç©ºæ ¼ç”Ÿæ•ˆ */
    word-break: break-word; /* é˜²æ­¢é•·å–®è©æº¢å‡º */
}

/* 3. æ­·å²è¨˜éŒ„é¢æ¿æ¨£å¼ */
.inner-voice-history-item {
    background-color: #fff;
    margin: 10px;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.history-item-timestamp {
    font-size: 11px;
    color: #999;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
    margin-bottom: 8px;
}
.history-item-content p {
    margin: 0 0 8px 0;
    font-size: 13px;
    line-height: 1.5;
    color: #444;
}
.history-item-content strong {
    font-size: 12px;
}
/* â–²â–²â–² å¿ƒè²åŠŸèƒ½æ¨£å¼çµæŸ â–²â–²â–² */
/* ã€å…¨æ–°ã€‘å¿ƒè²æ­·å²è¨˜éŒ„å–®æ¢åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
.inner-voice-history-item {
    position: relative; /* è®“åˆªé™¤æŒ‰éˆ•å¯ä»¥ç›¸å°æ–¼å®ƒå®šä½ */
}

.history-item-delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #f0f0f0;
    color: #888;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 24px;
    text-align: center;
    transition: all 0.2s ease;
}

.history-item-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–¼â–¼â–¼ åœ¨é€™è£¡é–‹å§‹è¤‡è£½ï¼šã€ä¸»é¡Œè‰²ç‰ˆã€‘å¯æ„›åœ“æ½¤æŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */

/* --- 1. å†æ¬¡è¨­ç½®é€šç”¨çš„â€œå¯æ„›åŸºç¤â€ --- */
#save-theme-btn,
#save-as-new-theme-btn,
#export-theme-btn,
#import-theme-btn,
#rename-theme-btn,
#delete-theme-btn {
    border: none;
    border-radius: 25px; /* å¯æ„›çš„è† å›Šå½¢ç‹€ */
    padding: 12px 18px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.2s ease-in-out;
    margin-top: 5px !important;
}

/* --- 2. å¯æ„›çš„â€œæŒ‰ä¸‹â€æ•ˆæœ --- */
#save-theme-btn:active,
#save-as-new-theme-btn:active,
#export-theme-btn:active,
#import-theme-btn:active,
#rename-theme-btn:active,
#delete-theme-btn:active {
    transform: scale(0.97);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* --- 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºä¸åŒåŠŸèƒ½çš„æŒ‰éˆ•è¨­ç½®é…å¥—é¡è‰² --- */

/* â€œä¿å­˜â€ å’Œ â€œå¦å­˜ç‚ºâ€ï¼šä½¿ç”¨å…¨åŸŸä¸»é¡Œè‰²ï¼ */
#save-theme-btn,
#save-as-new-theme-btn {
    background-color: var(--accent-color); /* é€™å°±æ˜¯ä½ çš„ä¸»é¡Œè‰²ï¼ */
    color: white;
}

/* â€œåŒ¯å‡ºâ€ã€â€œå°å…¥â€ã€â€œé‡å‘½åâ€ï¼šä½¿ç”¨æŸ”å’Œçš„æ¬¡è¦æ¨£å¼ */
#export-theme-btn,
#import-theme-btn,
#rename-theme-btn {
    background-color: #f0f2f5;           /* æ·¡æ·¡çš„ç°è‰²èƒŒæ™¯ */
    color: var(--accent-color);          /* æ–‡å­—ä½¿ç”¨ä¸»é¡Œè‰² */
    border: 1px solid var(--accent-color); /* å†åŠ ä¸€å€‹ä¸»é¡Œè‰²çš„é‚Šæ¡†ï¼Œæ›´ç²¾ç·» */
}

/* â€œåˆªé™¤â€æŒ‰éˆ•ï¼šé‚„æ˜¯ç”¨å¯æ„›çš„ç²‰ç´…è‰²ä¾†æé†’ï¼Œé˜²æ­¢èª¤è§¸ */
#delete-theme-btn {
    background-color: #ffdde5; /* æ·¡æ·¡çš„æ«»èŠ±ç²‰èƒŒæ™¯ */
    color: #ff3b30;           /* æ–‡å­—ç”¨é†’ç›®çš„ç´…è‰² */
    border: 1px solid #ffc2d1;
}

/* --- 4. æ»‘é¼ æ”¾åˆ°ä¸åŒæŒ‰éˆ•ä¸Šæ™‚çš„é¡è‰²è®ŠåŒ– --- */
#save-theme-btn:hover,
#save-as-new-theme-btn:hover {
    opacity: 0.85; /* ä¸»é¡Œè‰²æŒ‰éˆ•è®Šæ·¡ä¸€é»é» */
}

#export-theme-btn:hover,
#import-theme-btn:hover,
#rename-theme-btn:hover {
    background-color: #e9ecef; /* æ¬¡è¦æŒ‰éˆ•èƒŒæ™¯åŠ æ·±ä¸€é»é» */
}

#delete-theme-btn:hover {
    background-color: #ffc2d1; /* åˆªé™¤æŒ‰éˆ•èƒŒæ™¯åŠ æ·±ä¸€é»é» */
}

/* â–²â–²â–² è¤‡è£½åˆ°é€™è£¡çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.action-icon.summon-npc svg {
    stroke-width: 1.5; /* è®“åœ–ç¤ºç·šæ¢ç¨å¾®ç²—ä¸€é»ï¼Œæ›´æ¸…æ™° */
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šå¸¶æœ‰è©³ç´°æ³¨é‡‹ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„å¾®åšä¸»é ä½ˆå±€CSS â–¼â–¼â–¼ */

/* 1. å€‹äººä¸»é çš„æ»¾å‹•å®¹å™¨ (ä¿æŒä¸è®Š) */
#weibo-profile-page {
    flex-grow: 1;
    overflow-y: auto;
    background-color: #f0f2f5;
}

/* 2. é ­éƒ¨å®¹å™¨ï¼šè² è²¬èƒŒæ™¯åœ–ï¼Œä¸¦ç‚ºä¸‹æ–¹å…§å®¹ç•™å‡ºç©ºé–“ */
.weibo-profile-header {
    position: relative;
    height: 240px;
    /* 
      â˜…â˜…â˜… æ‰‹å‹•èª¿æ•´å€ï¼šå¾®åšå…§å®¹èˆ‡ä¸Šæ–¹å€åŸŸçš„ã€ä¸Šä¸‹é–“è·ã€‘ â˜…â˜…â˜…
      é€™å€‹å€¼æ±ºå®šäº†ä½ çš„ç¬¬ä¸€æ¢å¾®åšï¼Œå’Œä¸Šæ–¹å€‹äººè³‡è¨Šå€åŸŸçš„è·é›¢ã€‚
      - æ•¸å€¼è¶Šå¤§ï¼Œé–“è·è¶Šå¤§ï¼Œå¾®åšå…§å®¹é›¢å¾—è¶Šé ã€‚
      - æ•¸å€¼è¶Šå°ï¼Œé–“è·è¶Šå°ï¼Œå¾®åšå…§å®¹é›¢å¾—è¶Šè¿‘ã€‚
      æˆ‘å·²å°‡å®ƒå¾ 90px æ¸›å°åˆ°äº† 20pxï¼Œä½ å¯ä»¥æ ¹æ“šå–œå¥½å†å¾®èª¿ã€‚
    */
    margin-bottom: -5px;/* â˜… ä¿®æ”¹é€™è£¡ â˜… */
}

/* 3. èƒŒæ™¯åœ–æ¨£å¼ (ä¿æŒä¸è®Š) */
.weibo-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* 4. é ­åƒå®¹å™¨ï¼šå¯¦ç¾æ‡¸æµ®æ•ˆæœçš„æ ¸å¿ƒ */
.weibo-avatar-container {
    position: absolute;
    z-index: 3;
    width: 80px;
    height: 80px;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transform: none;

    /* â˜…â˜…â˜… æ‰‹å‹•èª¿æ•´å€1: é ­åƒä½ç½® (å·¦å³ + ä¸Šä¸‹) â˜…â˜…â˜… */

    /* --- å·¦å³ä½ç½® --- */
    /* æ•¸å€¼è¶Šå¤§ï¼Œè¶Šå¾€å³ã€‚æ•¸å€¼è¶Šå°ï¼Œè¶Šå¾€å·¦ã€‚*/
    left: 15px; /* â˜… ä¿®æ”¹é€™è£¡ */

    /* --- ä¸Šä¸‹ä½ç½® --- */
    /* æ•¸å€¼è¶Šå° (æ¯”å¦‚ -50px), è¶Šå¾€ä¸‹ã€‚æ•¸å€¼è¶Šå¤§ (æ¯”å¦‚ -30px), è¶Šå¾€ä¸Šã€‚*/
    bottom: 50px; /* â˜… ä¿®æ”¹é€™è£¡ */
}

.weibo-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}


/* 5. æ˜µç¨±å’Œè·æ¥­è³‡è¨Š */
/* â˜…â˜…â˜… æ‰‹å‹•èª¿æ•´å€2: æ˜µç¨±ä½ç½® (å·¦å³ + ä¸Šä¸‹) â˜…â˜…â˜… */
.weibo-nickname {
    position: absolute;
    z-index: 2;
    color: #1f1f1f;
    text-shadow: none;
    font-size: 18px;
    font-weight: 600;

    /* --- å·¦å³ä½ç½® --- */
    /* æ•¸å€¼è¶Šå¤§ï¼Œè¶Šå¾€å³ã€‚æ•¸å€¼è¶Šå°ï¼Œè¶Šå¾€å·¦ã€‚*/
    left: 35px; /* â˜… ä¿®æ”¹é€™è£¡ */

    /* --- ä¸Šä¸‹ä½ç½® --- */
    /* æ•¸å€¼è¶Šå° (æ¯”å¦‚ -60px), è¶Šå¾€ä¸‹ã€‚æ•¸å€¼è¶Šå¤§ (æ¯”å¦‚ -50px), è¶Šå¾€ä¸Šã€‚*/
    bottom: 30px; /* â˜… ä¿®æ”¹é€™è£¡ */
}

/* â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°CSSæ›¿æ›æ‰èˆŠçš„ â–¼â–¼â–¼ */
#weibo-user-profession-display {
    position: absolute;
    left: 35px;          /* ä¿®æ”¹ï¼šå¾ left æ”¹ç‚º rightï¼Œè®“å®ƒé å³å°é½Š */
    bottom: -5px;        /* ä¿®æ”¹ï¼šèª¿æ•´å‚ç›´ä½ç½®ï¼Œåœ¨é ­åƒä¸‹æ–¹ */
    z-index: 2;
    font-size: 13px;
    color: #8a8a8a;
    text-shadow: none;
    text-align: right;    /* æ–°å¢ï¼šè®“æ–‡å­—æœ¬èº«ä¹Ÿé å³å°é½Šï¼Œæ›´ç¾è§€ */
    cursor: pointer;      /* æ–°å¢ï¼šæ»‘é¼ æ”¾ä¸Šå»æ™‚é¡¯ç¤ºç‚ºå°æ‰‹å½¢ç‹€ */
}








/* 6. é—œæ³¨/ç²‰çµ²/å¾®åšè³‡æ–™ */
/* â˜…â˜…â˜… æ‰‹å‹•èª¿æ•´å€3: é—œæ³¨/ç²‰çµ²/å¾®åš ä½ç½® (å·¦å³ + ä¸Šä¸‹) â˜…â˜…â˜… */
.weibo-stats {
    position: absolute;
    z-index: 2;
    display: flex;
    gap: 20px;

    /* --- å·¦å³ä½ç½® --- */
    /* æ•¸å€¼è¶Šå¤§ï¼Œè¶Šå¾€å³ã€‚æ•¸å€¼è¶Šå°ï¼Œè¶Šå¾€å·¦ã€‚*/
    left: 35px; /* â˜… ä¿®æ”¹é€™è£¡ */

    /* --- ä¸Šä¸‹ä½ç½® --- */
    /* æ•¸å€¼è¶Šå° (æ¯”å¦‚ -90px), é€™è¡Œè³‡æ–™è¶Šå¾€ä¸‹ã€‚æ•¸å€¼è¶Šå¤§ (æ¯”å¦‚ -70px), è¶Šå¾€ä¸Šã€‚*/
    bottom: 15px; /* â˜… ä¿®æ”¹é€™è£¡ */
}


/* 7. å–®å€‹è³‡æ–™é …ç›®æ¨£å¼ (ä¿æŒä¸è®Š) */
.weibo-stat-item {
    display: flex;
    flex-direction: row;
    align-items: baseline;
    gap: 5px;
}
.weibo-stat-number {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    text-shadow: none;
}
.weibo-stat-label {
    font-size: 13px;
    color: #888;
    text-shadow: none;
}

/* 8. å¾®åšFeedåˆ—è¡¨ (ä¿æŒä¸è®Š) */
#my-weibo-feed-list {
    padding-top: 15px;
}

/* â–²â–²â–² å¾®åšæ¨£å¼æ›¿æ›çµæŸ â–²â–²â–² */



/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšé é¢æ¡†æ¶å’Œåº•éƒ¨å°èˆªæ¨£å¼ â–¼â–¼â–¼ */
#weibo-screen {
    display: flex;
    flex-direction: column;
}
.weibo-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none; /* é è¨­éš±è—æ‰€æœ‰é é¢ */
    flex-direction: column;
    background-color: #f0f2f5;
}
.weibo-view.active {
    display: flex; /* åªé¡¯ç¤ºå•Ÿå‹•çš„é é¢ */
}
/* â–¼â–¼â–¼ ã€ä½ˆå±€çµ±ä¸€ä¿®å¾©ç‰ˆã€‘ç”¨é€™å¡Šä»£ç¢¼å®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ #weibo-bottom-nav æ¨£å¼ â–¼â–¼â–¼ */
#weibo-bottom-nav {
    /* --- æ ¸å¿ƒä¿®æ”¹ --- */
    position: absolute; /* 1. æ”¹ç‚ºçµ•å°å®šä½ï¼Œè®“å®ƒæµ®å‹•èµ·ä¾† */
    bottom: 0;          /* 2. å›ºå®šåœ¨åº•éƒ¨ */
    left: 0;            /* 3. å·¦å´å°é½Š */
    width: 100%;        /* 4. å¯¬åº¦æ’æ»¿ */
    
    /* --- å…¶ä»–æ¨£å¼ä¿æŒä¸è®Š --- */
    z-index: 15;
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding-bottom: env(safe-area-inset-bottom);
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

.weibo-nav-item {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    font-size: 14px;
    color: var(--text-secondary);
    cursor: pointer;
}
.weibo-nav-item.active {
    color: var(--accent-color);
    font-weight: 600;
}
/* â–²â–²â–² å¾®åšæ¡†æ¶æ¨£å¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšé—œæ³¨æ¸…å–®å½ˆçª—æ¨£å¼ â–¼â–¼â–¼ */
#weibo-following-list-container {
    height: 100%;
    overflow-y: auto; /* ã€æ ¸å¿ƒã€‘å…§å®¹è¶…å‡ºæ™‚é¡¯ç¤ºå‚ç›´æ²å‹•æ¢ */
}
.weibo-following-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid #f0f0f0;
}
.weibo-following-item:last-child {
    border-bottom: none;
}
.weibo-following-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
}
.weibo-following-name {
    font-weight: 500;
    color: var(--text-primary);
}
/* â–²â–²â–² é—œæ³¨æ¸…å–®æ¨£å¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®“å€‹äººä¸»é å¯ç·¨è¼¯çš„å…ƒç´ æœ‰é»æ“Šæ‰‹å‹¢ â–¼â–¼â–¼ */
#weibo-avatar-img,
#weibo-nickname,
#weibo-posts-item, /* æˆ‘å€‘è®“æ•´å€‹â€œå¾®åšâ€å€åŸŸå¯é»æ“Š */
#weibo-fans-item,  /* æ•´å€‹â€œç²‰çµ²â€å€åŸŸå¯é»æ“Š */
#weibo-background-img /* èƒŒæ™¯åœ–ä¹Ÿå¯é»æ“Š */ {
    cursor: pointer;
    transition: opacity 0.2s;
}
#weibo-avatar-img:hover,
#weibo-nickname:hover,
#weibo-posts-item:hover,
#weibo-fans-item:hover,
#weibo-background-img:hover {
    opacity: 0.8; /* æ»‘é¼ æ”¾ä¸Šå»æ™‚è®Šæ·¡ä¸€é»ï¼Œçµ¦ç”¨æˆ¶å›é¥‹ */
}
/* â–²â–²â–² é»æ“Šæ‰‹å‹¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ #weibo-page-container æ¨£å¼ â–¼â–¼â–¼ */
#weibo-page-container {
    flex-grow: 1;
    position: relative;
    overflow: hidden;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šç‚ºçµ•å°å®šä½çš„å·¡è¦½åˆ—é ç•™å‡ºç©ºé–“ï¼Œé˜²æ­¢å…§å®¹è¢«é®æ“‹ */
    /* 50px æ˜¯å·¡è¦½åˆ—çš„å¤§è‡´é«˜åº¦ï¼Œenv() ç”¨æ–¼é©é…iPhoneåº•éƒ¨çš„å°é»‘æ¢ */
    padding-bottom: calc(50px + env(safe-area-inset-bottom));
    box-sizing: border-box; /* ç¢ºä¿å…§é‚Šè·è¢«æ­£ç¢ºè¨ˆç®—åœ¨å…§ */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* ç¢ºä¿å€‹äººä¸»é çš„å…§å®¹å¯ä»¥æ»¾å‹• */
#weibo-profile-page {
    overflow-y: auto;
    height: 100%;
}
/* â–²â–²â–² ä¿®å¾©CSSçµæŸ â–²â–²â–² */

/* â–²â–²â–² ä¿®å¾©CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ã€‘æå‡å¾®åšé—œæ³¨åˆ—è¡¨å½ˆçª—çš„å±¤ç´š â–¼â–¼â–¼ */
#weibo-following-modal {
    z-index: 1001; /* ç¢ºä¿å®ƒèƒ½è¦†è“‹åœ¨å…¶ä»–é é¢ä¹‹ä¸Š */
}
/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„å¾®åšå¸–å­æ¨£å¼ï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„å¾®åšå¸–å­æ¨£å¼ï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* === å¾®åšå¸–å­å°ˆå±¬æ¨£å¼ (å·²å’Œå‹•æ…‹åˆ†é›¢) === */
/* === å¾®åšå¸–å­å°ˆå±¬æ¨£å¼ (åœ“è§’å¡ç‰‡ç‰ˆ) === */
.weibo-post-item {
    background-color: var(--secondary-bg);
    border-radius: 12px; /* â˜… ä¿®æ”¹é€™è£¡ï¼Œå¢åŠ åœ“è§’ï¼Œè®“å®ƒè®Šå¾—åœ“æ½¤å¯æ„› */
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06); /* â˜… æ–°å¢æŸ”å’Œçš„é™°å½±ï¼Œç‡Ÿé€ å¡ç‰‡æ‡¸æµ®æ„Ÿ */
    /* â˜… èˆŠçš„ border-bottom åˆ†å‰²ç·šå·²ç¶“è¢«ç§»é™¤äº†ï¼Œç¾åœ¨ç”±çˆ¶å®¹å™¨çš„ gap å±¬æ€§è² è²¬é–“è· */
}
.weibo-post-item:last-child {
    /* é€™å€‹è¦å‰‡ç¾åœ¨ä¹Ÿä¸éœ€è¦äº†ï¼Œä½†ä¿ç•™è‘—ä¹Ÿæ²’é—œä¿‚ */
    border-bottom: none;
}

.weibo-post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.weibo-post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.weibo-post-info {
    display: flex;
    flex-direction: column;
}

.weibo-post-nickname {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
}

.weibo-post-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.weibo-post-content {
    font-size: 15px; /* å¾®åšæ­£æ–‡å­—é«”ç¨å¤§ */
    line-height: 1.7;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
    margin-bottom: 10px;
}

.weibo-post-image {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
}

.weibo-post-footer {
    border-top: 1px solid #f0f0f0;
    padding-top: 8px;
    margin-top: 10px;
}

.weibo-post-actions {
    display: flex;
    justify-content: space-around; /* ä¸‰å€‹æŒ‰éˆ•å‡åˆ†ç©ºé–“ */
    margin-bottom: 10px;
}

.weibo-action-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
}
.weibo-action-btn.liked {
    color: #ff5252; /* é»è´Šå¾Œè®Šç´… */
}
.weibo-action-btn svg {
    width: 20px;
    height: 20px;
}

.weibo-comments-container {
    padding: 10px;
    background-color: #f7f7f7;
    border-radius: 8px;
    font-size: 13px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 10px;
}

.weibo-comment-item .weibo-commenter-name {
    font-weight: 600;
    color: var(--accent-color);
}
.weibo-comment-item .weibo-comment-reply-tag {
    color: var(--text-secondary);
    margin: 0 4px;
}

.weibo-comment-input-area {
    display: flex;
    gap: 8px;
}

.weibo-comment-input {
    flex-grow: 1;
    border: none;
    background-color: #f0f2f5;
    border-radius: 14px;
    padding: 8px 12px;
    font-size: 13px;
}

.weibo-comment-send-btn {
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 14px;
    padding: 0 15px;
    font-size: 13px;
    cursor: pointer;
}
/* â–²â–²â–² å¾®åšå°ˆå±¬æ¨£å¼çµæŸ â–²â–²â–² */
/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* å–®æ¢è©•è«–çš„å®¹å™¨ï¼Œç¾åœ¨éœ€è¦ç›¸å°å®šä½ï¼Œä¸¦ç‚ºåˆªé™¤æŒ‰éˆ•ç•™å‡ºç©ºé–“ */
.weibo-comment-item {
    position: relative;
    padding-right: 25px; 
}

/* è©•è«–åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
.comment-delete-btn {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    border-radius: 50%;
    color: var(--text-secondary);
    background-color: transparent; /* èƒŒæ™¯é€æ˜ */
    border: none; /* ç„¡é‚Šæ¡† */
    font-size: 20px; /* æ”¾å¤§"Ã—"è™Ÿ */
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜èªéš±è— */
}

/* æ»‘é¼ æ‡¸åœåœ¨æ•´æ¢è©•è«–ä¸Šæ™‚ï¼Œæ‰é¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
.weibo-comment-item:hover .comment-delete-btn {
    opacity: 1;
}

/* æ»‘é¼ æ‡¸åœåœ¨åˆªé™¤æŒ‰éˆ•ä¸Šæ™‚ï¼Œçµ¦ä¸€é»å›é¥‹æ•ˆæœ */
.comment-delete-btn:hover {
    background-color: #f0f0f0;
    color: #ff3b30; /* è®Šç´…è‰² */
}

#phone-screen.dark-mode .comment-delete-btn:hover {
    background-color: #3a3a3c; /* å¤œé–“æ¨¡å¼ä¸‹çš„æ‡¸åœèƒŒæ™¯è‰² */
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„å¾®åšç†±æœæ¨£å¼ï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* === å¾®åšç†±æœæ¸…å–®æ¨£å¼ === */
#weibo-hot-search-list {
    background-color: var(--secondary-bg);
}

.hot-search-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}

.hot-search-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode .hot-search-item:hover {
    background-color: #2c2c2e;
}

.hot-search-rank {
    width: 30px;
    font-size: 16px;
    font-weight: bold;
    color: var(--text-secondary);
    text-align: center;
    flex-shrink: 0;
}
/* å‰ä¸‰åç”¨ä¸åŒçš„é¡è‰²çªå‡ºé¡¯ç¤º */
.hot-search-item[data-rank="1"] .hot-search-rank { color: #f44336; }
.hot-search-item[data-rank="2"] .hot-search-rank { color: #ff9800; }
.hot-search-item[data-rank="3"] .hot-search-rank { color: #ffc107; }

.hot-search-content {
    flex-grow: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    overflow: hidden;
}

.hot-search-topic {
    font-size: 15px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.hot-search-tag {
    font-size: 10px;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    flex-shrink: 0;
}
.hot-search-tag.hot { background-color: #f44336; }
.hot-search-tag.new { background-color: #ff9800; }
.hot-search-tag.rec { background-color: #2196f3; }

/* â–²â–²â–² å¾®åšç†±æœæ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®“å¸–å­é ­éƒ¨æˆç‚ºåˆªé™¤æŒ‰éˆ•çš„å®šä½åƒè€ƒé» */
.weibo-post-header {
    position: relative; /* é—œéµï¼ */
}

/* 2. åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
.weibo-post-delete-btn {
    position: absolute; /* çµ•å°å®šä½ï¼Œè®“å®ƒæµ®å‹•èµ·ä¾† */
    top: 10px;          /* è·é›¢é ‚éƒ¨10åœ–å…ƒ */
    right: 15px;         /* è·é›¢å³å´15åœ–å…ƒ */
    width: 26px;
    height: 26px;
    background-color: rgba(0, 0, 0, 0.08); /* åŠé€æ˜çš„èƒŒæ™¯ */
    color: var(--text-secondary); /* ä½¿ç”¨å…¨åŸŸçš„æ¬¡è¦æ–‡å­—é¡è‰² */
    border: none;
    border-radius: 50%; /* åœ“å½¢ */
    font-size: 20px;    /* "Ã—"è™Ÿçš„å¤§å° */
    line-height: 26px;  /* è®“"Ã—"è™Ÿå‚ç›´å±…ä¸­ */
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease; /* æ·»åŠ å¹³æ»‘çš„å‹•ç•«æ•ˆæœ */
}

/* æ»‘é¼ æ”¾ä¸Šå»æ™‚ï¼Œè®Šæˆé†’ç›®çš„ç´…è‰² */
.weibo-post-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
    transform: scale(1.1); /* è¼•å¾®æ”¾å¤§ */
}

/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å¾®åšä½ˆå±€çµ‚æ¥µä¿®å¾©ã€‘çœŸæ­£è§£æ±ºæ‰€æœ‰é é¢æ»¾å‹•ä¸åˆ°åº•çš„å•é¡Œ â–¼â–¼â–¼ */

/* 1. å¤–å±¤å®¹å™¨ä¸å†éœ€è¦â€œå¢Šå­â€ï¼Œå®ƒçš„ä»»å‹™åªæ˜¯æ’é–‹ç©ºé–“ */
#weibo-page-container {
    flex-grow: 1;
    position: relative;
    overflow: hidden; /* ä¿æŒä¸è®Š */
}

/* 2. ã€æ ¸å¿ƒã€‘æŠŠâ€œå¢Šå­â€åŠ åˆ°çœŸæ­£æ»¾å‹•çš„åˆ—è¡¨è‡ªå·±èº«ä¸Šï¼ */
#weibo-profile-page,
#weibo-following-feed-list,
#weibo-hot-search-list,
#weibo-plaza-feed-list,
#weibo-hottopic-feed-list {
    flex-grow: 1;
    overflow-y: auto;
    
    /* 
       é­”æ³•å°±åœ¨é€™è£¡ï¼æˆ‘å€‘ç‚ºæ¯å€‹åˆ—è¡¨çš„åº•éƒ¨ï¼Œ
       éƒ½åŠ ä¸Šä¸€å€‹å’Œå·¡è¦½åˆ—ä¸€æ¨£é«˜çš„å…§é‚Šè·ï¼ˆâ€œå¢Šå­â€ï¼‰ã€‚
       é€™æ¨£åˆ—è¡¨æ»¾å‹•åˆ°åº•æ™‚ï¼Œæœ€å¾Œä¸€æ¢è©•è«–å°±æœƒè¢«é€™å€‹å…§é‚Šè·å‘ä¸Šæ¨ï¼Œ
       æ­£å¥½é¡¯ç¤ºåœ¨åº•éƒ¨å·¡è¦½åˆ—çš„ä¸Šæ–¹ï¼Œä¸æœƒå†è¢«æ“‹ä½äº†ï¼
    */
    padding-bottom: calc(50px + env(safe-area-inset-bottom));
    box-sizing: border-box; /* ç¢ºä¿å…§é‚Šè·è¢«æ­£ç¢ºè¨ˆç®— */
}

/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠé€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
#post-visibility-groups label {
    display: block;
    padding: 5px 0;
}
#post-visibility-groups input {
    margin-right: 8px;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å¾®åšä½ˆå±€çµ‚æ¥µä¿®å¾©ã€‘è§£æ±ºæ‰€æœ‰é é¢æ»¾å‹•ä¸åˆ°åº•çš„å•é¡Œ â–¼â–¼â–¼ */

/* 1. ç§»é™¤å¤–å±¤å®¹å™¨ä¸ŠéŒ¯èª¤çš„å¤šé¤˜â€œå¢Šå­â€ */
#weibo-page-container {
    padding-bottom: 0 !important;
}

/* 2. ã€æ ¸å¿ƒã€‘æŠŠâ€œå¢Šå­â€ï¼ˆpadding-bottomï¼‰åŠ åˆ°çœŸæ­£æ»¾å‹•çš„åˆ—è¡¨è‡ªå·±èº«ä¸Šï¼*/
#weibo-profile-page,
#weibo-following-feed-list,
#weibo-hot-search-list,
#weibo-plaza-feed-list,
#weibo-hottopic-feed-list {
    /* 
       é­”æ³•å°±åœ¨é€™è£¡ï¼æˆ‘å€‘ç‚ºæ¯å€‹åˆ—è¡¨çš„åº•éƒ¨ï¼Œ
       éƒ½åŠ ä¸Šä¸€å€‹å’Œå·¡è¦½åˆ—ä¸€æ¨£é«˜çš„å…§é‚Šè·ï¼ˆâ€œå¢Šå­â€ï¼‰ã€‚
       calc(50px + env(safe-area-inset-bottom)) æœƒè‡ªå‹•è¨ˆç®—å·¡è¦½åˆ—é«˜åº¦å’ŒiPhoneåº•éƒ¨å®‰å…¨å€é«˜åº¦ã€‚
    */
    padding-bottom: calc(50px + env(safe-area-inset-bottom)) !important;
    box-sizing: border-box; /* ç¢ºä¿å…§é‚Šè·è¢«æ­£ç¢ºè¨ˆç®— */
}
/* â–¼â–¼â–¼ ã€å•é¡Œ1ä¿®å¾©ã€‘å¾®åšç·¨è¼¯è³‡æ–™æŒ‰éˆ•å¼·åˆ¶é¡¯ç¤º â–¼â–¼â–¼ */
/* è«‹å°‡é€™æ®µä»£ç¢¼é»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ */
#edit-weibo-profile-btn {
    display: flex !important; /* å¼·åˆ¶é¡¯ç¤ºç‚ºflexå®¹å™¨ */
    align-items: center;
    justify-content: center;
    color: var(--accent-color) !important; /* å¼·åˆ¶ä½¿ç”¨ä¸»é¡Œè‰² */
}
#edit-weibo-profile-btn svg {
    stroke: currentColor !important; /* ç¢ºä¿SVGåœ–ç¤ºç¹¼æ‰¿ä¸Šé¢çš„é¡è‰² */
}
/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®“é—œæ³¨åˆ—è¡¨çš„æ¯ä¸€è¡Œéƒ½èƒ½å®¹ç´æ–°æŒ‰éˆ• */
.weibo-following-item {
    align-items: center; /* ç¢ºä¿é ­åƒã€åå­—å’ŒæŒ‰éˆ•å‚ç›´å±…ä¸­å°é½Š */
}

/* 2. é€™æ˜¯ä½ æ–°å¢çš„â€œæ“ä½œâ€æŒ‰éˆ•çš„æ¨£å¼ */
.weibo-action-trigger-btn {
    margin-left: auto; /* æ ¸å¿ƒï¼šè®“æŒ‰éˆ•è‡ªå‹•é åˆ°æœ€å³é‚Š */
    padding: 5px 8px;
    cursor: pointer;
    border-radius: 50%; /* åœ“å½¢æŒ‰éˆ•ï¼Œæ›´ç¾è§€ */
    transition: background-color 0.2s;
}
.weibo-action-trigger-btn:hover {
    background-color: #e0e0e0;
}
#phone-screen.dark-mode .weibo-action-trigger-btn:hover {
    background-color: #3a3a3c;
}
.weibo-action-trigger-btn svg {
    width: 20px;
    height: 20px;
    stroke: var(--text-secondary); /* åœ–ç¤ºé¡è‰²è·Ÿéš¨ä¸»é¡Œ */
    display: block; /* è§£æ±ºä¸€äº›å°é½Šå•é¡Œ */
}

/* 3. ç‚ºæ“ä½œå½ˆçª—è£¡çš„é¸é …æŒ‰éˆ•ç¾åŒ–ä¸€ä¸‹ */
#weibo-action-type-select label {
    display: block;
    padding: 8px;
    border-radius: 6px;
    transition: background-color 0.2s;
}
#weibo-action-type-select label:hover {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #weibo-action-type-select label:hover {
    background-color: #2c2c2e;
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å½ˆçª—å±¤ç´šä¿®å¾©ã€‘é»è²¼é€™æ®µä»£ç¢¼åˆ°æ¨£å¼æœ«å°¾ â–¼â–¼â–¼ */
#weibo-action-modal {
    z-index: 1002; /* é€™å€‹å€¼æ¯”é—œæ³¨åˆ—è¡¨(1001)æ›´é«˜ï¼Œå°±ä¸æœƒè¢«è“‹ä½äº† */
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«–å£‡/å°çµ„åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. å°çµ„æ¸…å–®å¡ç‰‡æ¨£å¼ */
.forum-group-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.forum-group-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.12);
}
.forum-group-icon {
    font-size: 28px;
    margin-bottom: 10px;
}
.forum-group-name {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 5px;
}
.forum-group-desc {
    font-size: 12px;
    color: var(--text-secondary);
}

/* 2. å¸–å­æ¸…å–®é …æ¨£å¼ */
.forum-post-item {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
}
.forum-post-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode .forum-post-item:hover {
    background-color: #2c2c2e;
}
.post-item-title {
    font-weight: 500;
    font-size: 16px;
    margin-bottom: 8px;
}
.post-item-meta {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    justify-content: space-between;
}

/* â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ #post-detail-content æ¨£å¼ â–¼â–¼â–¼ */
#post-detail-content {
    flex-grow: 1;      /* æ ¸å¿ƒï¼šè®“å®ƒä½”æ“šæ‰€æœ‰å¯ç”¨çš„å‚ç›´ç©ºé–“ */
    overflow-y: auto;  /* æ ¸å¿ƒï¼šå¦‚æœå…§å®¹è¶…å‡ºï¼Œå‰‡å…è¨±è‡ªèº«æ»¾å‹• */
    display: flex;
    flex-direction: column;
    padding: 20px;     /* ä¿ç•™èˆ’é©çš„å…§é‚Šè· */
    /* ä¸å†éœ€è¦ç‚ºçµ•å°å®šä½çš„è¼¸å…¥æ¡†ç•™å‡ºé¡å¤–çš„padding-bottom */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
.post-detail-header h1 {
    font-size: 22px;
    margin: 0 0 10px 0;
}
.post-detail-meta {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 20px;
}
.post-detail-body {
    font-size: 16px;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}
.post-comments-section {
    padding-top: 20px;
}
.post-comments-section h3 {
    font-size: 16px;
    margin: 0 0 15px 0;
    border-left: 3px solid var(--accent-color);
    padding-left: 10px;
}
.post-comment-item {
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}
#phone-screen.dark-mode .post-comment-item {
    border-bottom-color: #2c2c2e;
}
.comment-author {
    font-weight: 600;
    color: var(--accent-color);
    margin-bottom: 5px;
}
.comment-content {
    font-size: 14px;
    line-height: 1.6;
}

/* 4. å¸–å­é åº•éƒ¨è¼¸å…¥æ¡† */
/* â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ #post-comment-input-area æ¨£å¼ â–¼â–¼â–¼ */
#post-comment-input-area {
    /* 
      æˆ‘å€‘ç§»é™¤äº† position: absolute; å’Œç›¸é—œçš„ bottom, left å±¬æ€§ï¼Œ
      è®“å®ƒå¾ä¸€å€‹â€œæµ®å‹•å±¤â€è®Šå›ä¸€å€‹æ­£å¸¸çš„å¡Šç´šå…ƒç´ ï¼Œè‡ªç„¶åœ°æ’åœ¨å…§å®¹ä¸‹æ–¹ã€‚
      å…¶ä»–çš„æ¨£å¼æœƒå¾ .chat-input-area é¡ç¹¼æ‰¿ï¼Œç„¡éœ€æ“”å¿ƒã€‚
    */
    width: 100%;
    box-sizing: border-box;
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


/* â–²â–²â–² è«–å£‡æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µã€å…¨æ–°ã€‘çš„è«–å£‡ç¾åŒ–CSSï¼Œé»è²¼åˆ°<style>æ¨™ç±¤çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. ç¾åŒ–å¸–å­è©³æƒ…é åº•éƒ¨çš„è©•è«–è¼¸å…¥å€åŸŸ */
#post-comment-input-area {
    padding: 10px 15px; /* å¢åŠ å…§é‚Šè·ï¼Œè®“å®ƒä¸è²¼é‚Š */
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    /* é©é…iPhoneåº•éƒ¨å®‰å…¨å€ */
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
}

/* 2. ã€æ ¸å¿ƒã€‘ç¾åŒ–è©•è«–è¼¸å…¥æ¡†æœ¬èº« */
#post-comment-input-area #post-comment-input {
    background-color: #f0f2f5; /* æ·ºç°è‰²èƒŒæ™¯ï¼Œæ›´æœ‰å±¤æ¬¡æ„Ÿ */
    border: none;
    border-radius: 18px; /* åœ“è§’ï¼Œæ›´æŸ”å’Œ */
    padding: 10px 15px;
    font-size: 14px;
    resize: none; /* ç¦æ­¢ç”¨æˆ¶æ‹–æ‹½å¤§å° */
}

/* å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode #post-comment-input-area #post-comment-input {
    background-color: #2c2c2e;
}

/* 3. ç¾åŒ–ç™¼é€æŒ‰éˆ• */
#post-comment-input-area #send-post-comment-btn {
    height: 36px;
    border-radius: 18px; /* å’Œè¼¸å…¥æ¡†ä¿æŒä¸€è‡´çš„åœ“è§’ */
    padding: 0 20px;
}

/* 4. ã€æ–°å¢ã€‘AIç”Ÿæˆè©•è«–æŒ‰éˆ•çš„æ¨£å¼ */
.generate-comments-container {
    padding: 10px 20px 0 20px;
    border-bottom: 8px solid #f0f2f5;
}

#phone-screen.dark-mode .generate-comments-container {
    border-bottom-color: #000;
}

#generate-forum-comments-btn {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 8px;
    background-color: #e9f5ff;
    color: var(--accent-color);
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

#generate-forum-comments-btn:hover {
    background-color: #d4eaff;
}
/* â–²â–²â–² è«–å£‡ç¾åŒ–CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«–å£‡å¸–å­/è©•è«–é ­åƒèˆ‡æ¨“å±¤æ¨£å¼ â–¼â–¼â–¼ */

/* 1. å¸–å­ä½œè€…å€åŸŸï¼šä½¿ç”¨flexä½ˆå±€è®“é ­åƒå’Œåå­—ä¸¦æ’ */
#post-detail-content .post-detail-header {
    display: flex;
    align-items: center;
    gap: 12px; /* é ­åƒå’Œå³å´ä¿¡æ¯çš„é–“è· */
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 20px;
}

/* 2. å¸–å­ä½œè€…çš„é ­åƒæ¨£å¼ */
.post-author-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
}

/* 3. åŒ…è£¹ä½œè€…åå­—å’Œæ™‚é–“çš„å®¹å™¨ */
.post-author-info {
    display: flex;
    flex-direction: column;
}

/* 4. ç§»é™¤èˆŠçš„æ¨™é¡Œå’Œmetaå¤–é‚Šè·ï¼Œå› ç‚ºflexä½ˆå±€æœƒè™•ç†é–“è· */
#post-detail-content .post-detail-header h1,
#post-detail-content .post-detail-meta {
    margin: 0;
}
#post-detail-content .post-detail-header h1 {
    font-size: 18px; /* æ¨™é¡Œå¯ä»¥ç¨å¾®å°ä¸€é»ï¼Œæ›´å”èª¿ */
    margin-bottom: 4px;
}

/* 5. è©•è«–å€æ¯ä¸€æ¢è©•è«–çš„ä½ˆå±€ */
.post-comment-item {
    display: flex;
    gap: 10px; /* é ­åƒå’Œå³å´å…§å®¹çš„é–“è· */
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}
#phone-screen.dark-mode .post-comment-item {
    border-bottom-color: #2c2c2e;
}

/* 6. è©•è«–è€…çš„å°é ­åƒ */
.comment-avatar-small {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

/* 7. åŒ…è£¹è©•è«–æ‰€æœ‰æ–‡å­—å…§å®¹çš„å®¹å™¨ */
.comment-details {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
}

/* 8. è©•è«–çš„é ­éƒ¨ï¼šåŒ…å«åå­—å’Œæ¨“å±¤ */
.comment-header-line {
    display: flex;
    justify-content: space-between; /* è®“åå­—é å·¦ï¼Œæ¨“å±¤é å³ */
    align-items: center;
    margin-bottom: 5px;
}

/* 9. è©•è«–æ¨“å±¤è™Ÿçš„æ¨£å¼ */
.comment-floor {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}

/* 10. ç§»é™¤èˆŠçš„è©•è«–ä½œè€…å¤–é‚Šè· */
.post-comment-item .comment-author {
    margin-bottom: 0;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯ä¿®å¾©è«–å£‡è©•è«–å€å¯¬åº¦å•é¡Œçš„æ–°å¢ä»£ç¢¼ â–¼â–¼â–¼ */
#post-comment-input-area #post-comment-input {
    flex-grow: 1; /* â˜…â˜…â˜… æ ¸å¿ƒä»£ç¢¼å°±æ˜¯é€™è¡Œï¼è®“è¼¸å…¥æ¡†è‡ªå‹•ä¼¸å±•ï¼Œå æ»¿æ‰€æœ‰å¯ç”¨å¯¬åº¦ â˜…â˜…â˜… */
    
    /* ä¸‹é¢é€™äº›æ˜¯ç¾åŒ–æ¨£å¼ï¼Œè®“å®ƒå’Œå…¶ä»–è¼¸å…¥æ¡†é¢¨æ ¼çµ±ä¸€ï¼Œé€™æ¬¡æ²’æœ‰ä¿®æ”¹é«˜åº¦å“¦ */
    border: none;
    background-color: #f0f2f5; 
    border-radius: 18px;       
    padding: 10px 15px;        
    font-size: 14px;
    resize: none;             
    box-sizing: border-box;    
}

/* å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode #post-comment-input-area #post-comment-input {
    background-color: #2c2c2e;
}
/* â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ç”¨é€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œæ›¿æ›æ‰ä½ èˆŠçš„æ‰€æœ‰å¡”ç¾…ç‰Œç›¸é—œCSS â–¼â–¼â–¼ */

/* 1. å åœçµæœå½ˆçª—å…§çš„æ¨£å¼ï¼ˆç´”æ–‡å­—ç‰ˆï¼‰ */
#tarot-result-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}
.tarot-result-question {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    background-color: #f0f2f5;
    padding: 8px 12px;
    border-radius: 8px;
    width: 95%;
    text-align: center;
}
#phone-screen.dark-mode .tarot-result-question {
    background-color: #2c2c2e;
}
.tarot-spread-container {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 10px;
}
.tarot-card-wrapper {
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px;
    min-width: 120px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
#phone-screen.dark-mode .tarot-card-wrapper {
    background-color: #1c1c1e;
}
.tarot-card-position {
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-color);
    margin-bottom: 4px;
}
.tarot-card-name {
    font-size: 14px;
}

/* 3. æ­·å²è¨˜éŒ„æ¨£å¼ (ä¿æŒä¸è®Š) */
#tarot-history-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.tarot-history-item {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 12px;
    position: relative;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .tarot-history-item {
    background-color: #2c2c2e;
}
.tarot-history-item .question { font-weight: 600; margin-bottom: 8px; }
.tarot-history-item .details { font-size: 13px; color: var(--text-secondary); white-space: pre-wrap; }
.tarot-history-delete-btn {
    position: absolute;
    top: 5px; right: 5px; width: 24px; height: 24px;
    background-color: #e0e0e0; color: #888; border-radius: 50%;
    border: none; cursor: pointer; font-size: 18px; line-height: 24px; text-align: center;
}
#phone-screen.dark-mode .tarot-history-delete-btn {
    background-color: #3e3e42;
}
/* â–¼â–¼â–¼ ç¬¬1æ­¥ï¼šå¾é€™è£¡é–‹å§‹è¤‡è£½æ›¿æ› â–¼â–¼â–¼ */

#lovers-space-screen {
    background-color: #f0f2f5;   /* ä¿ç•™ä¸€å€‹å‚™ç”¨èƒŒæ™¯è‰² */
    background-size: cover;      /* èƒŒæ™¯åœ–è¦†è“‹æ•´å€‹å€åŸŸ */
    background-position: center; /* èƒŒæ™¯åœ–å±…ä¸­é¡¯ç¤º */
    background-repeat: no-repeat;/* èƒŒæ™¯åœ–ä¸é‡è¤‡ */
}

/* é ­éƒ¨ */
#ls-header {
    height: 220px;
    position: relative;
    /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç§»é™¤äº† background-size å’Œ background-position */
    color: white;
    flex-shrink: 0;
    background-color: transparent; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘è®“é ­éƒ¨èƒŒæ™¯è®Šé€æ˜ï¼Œä»¥é¡¯ç¤ºä¸‹æ–¹çš„å…¨å±èƒŒæ™¯ */
}

/* â–²â–²â–² ç¬¬1æ­¥ï¼šè¤‡è£½æ›¿æ›åˆ°é€™è£¡çµæŸ â–²â–²â–² */

/* --- ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ä¿®å¾©æƒ…ä¾¶ç©ºé–“é ‚éƒ¨æŒ‰éˆ•ç„¡æ³•é»æ“Šçš„å•é¡Œ --- */
/* --- ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ä¿®å¾©é®ç½©å±¤æ””æˆªé»æ“Šçš„å•é¡Œ --- */

.ls-header-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent, rgba(0,0,0,0.2));
    
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šè®“é€™å€‹é®ç½©å±¤å°æ»‘é¼ äº‹ä»¶â€œé€æ˜â€ï¼ â–¼â–¼â–¼ */
    pointer-events: none; 
    /* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
}


/* --- ã€å·²ä¿®å¾©ã€‘æƒ…ä¾¶ç©ºé–“é ‚éƒ¨æ¬„å±¤ç´šå•é¡Œ --- */

.ls-header-top-bar {
    position: relative;
    z-index: 3; /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå°‡å±¤ç´šå¾ 2 æå‡åˆ° 3 â˜…â˜…â˜… */
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    padding-top: calc(15px + env(safe-area-inset-top));
}

#ls-char-name {
    font-size: 18px;
    font-weight: 600;
}
#ls-switch-char-btn { font-size: 16px; }

.ls-header-avatars {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 2;
}
.ls-header-avatars img {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.ls-header-avatars .heart-icon {
    font-size: 28px;
    color: #ff4d6d;
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
}

/* â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ #ls-tab-bar å’Œ .ls-tab-item æ¨£å¼ â–¼â–¼â–¼ */

/* é ç°½æ¬„ (V2 - æ‡¸æµ®æ’æ»¿ç‰ˆ) */
/* â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šã€æ‡¸æµ®è† å›Šæœ€çµ‚ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ #ls-tab-bar æ¨£å¼ â–¼â–¼â–¼ */
#ls-tab-bar {
    display: flex;
    flex-shrink: 0;
    position: relative;
    z-index: 5;

    /* --- æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ --- */
    /* 1. ä½¿ç”¨ margin å¯¦ç¾ä¸Šä¸‹å·¦å³çš„é‚Šè·ï¼Œç‡Ÿé€ æ‡¸æµ®æ„Ÿ */
   margin: -20px 5px 10px 5px; /* æŠŠå·¦å³çš„ 15px æ”¹æˆäº† 5px */
    
    /* 2. ç‚ºæ‰€æœ‰å››å€‹è§’éƒ½è¨­ç½®åœ“è§’ï¼Œå½¢æˆå¯æ„›çš„è† å›Šå½¢ç‹€ */
    border-radius: 25px; 

    background-color: var(--secondary-bg);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* é™°å½±å¯ä»¥è®“æ‡¸æµ®æ„Ÿæ›´å¼· */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* å–®å€‹é ç°½é …ç›® (V2) */
.ls-tab-item {
    flex: 1;
    text-align: center;
    /* æ ¸å¿ƒä¿®æ”¹ï¼špadding å¾ 12px å¢åŠ åˆ° 15pxï¼Œè®“å·¡è¦½åˆ—ã€æ‹‰é•·ä¸€é»ã€‘(æ›´é«˜) */
    padding: 15px 0;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    position: relative;
    /* æ–°å¢ï¼šç‚ºåœ–ç¤ºçš„ç¸®æ”¾å’Œé¡è‰²è®ŠåŒ–æ·»åŠ å¹³æ»‘éæ¸¡ */
    transition: color 0.2s ease;
}

/* å•Ÿå‹•ç‹€æ…‹çš„é ç°½ (V2) */
.ls-tab-item.active {
    color: var(--accent-color);
}

/* å•Ÿå‹•ç‹€æ…‹çš„åº•ç·šæŒ‡ç¤ºå™¨ (ä¿æŒä¸è®Š) */
.ls-tab-item.active::after {
    content: '';
    position: absolute;
    bottom: 8px; /* å¾®èª¿ä½ç½®ä»¥é©æ‡‰æ›´é«˜çš„å·¡è¦½åˆ— */
    left: 50%;
    transform: translateX(-50%);
    width: 28px;
    height: 3px;
    background-color: var(--accent-color);
    border-radius: 1.5px;
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºSVGåœ–ç¤ºæ–°å¢çš„æ¨£å¼ï¼Œè«‹æŠŠå®ƒä¹Ÿé»è²¼åˆ°<style>è£¡ â–¼â–¼â–¼ */
.ls-tab-item svg {
    width: 24px;
    height: 24px;
    /* ç‚ºåœ–ç¤ºçš„å¤§å°å’Œç²—ç´°è®ŠåŒ–æ·»åŠ å¹³æ»‘éæ¸¡ */
    transition: all 0.2s ease-in-out;
}

/* å•Ÿå‹•ç‹€æ…‹çš„åœ–ç¤ºï¼Œæœƒè®Šå¾—æ›´ç²—ã€æ›´å¤§ä¸€é»ï¼Œéå¸¸é†’ç›® */
.ls-tab-item.active svg {
    stroke-width: 2.5;
    transform: scale(1.1);
}
/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */

/* å…§å®¹å€åŸŸ */
#ls-content-area {
    flex-grow: 1;
    position: relative;
    overflow: hidden;
}
.ls-view {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    overflow-y: auto;
    display: none;
    padding: 15px;
    box-sizing: border-box;
}
.ls-view.active {
    display: block;
}

/* æµ®å‹•æ·»åŠ æŒ‰éˆ• */
/* â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šã€çµ‚æ¥µå±…ä¸­ä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ .ls-fab-btn æ¨£å¼ â–¼â–¼â–¼ */
/* â–¼â–¼â–¼ é€™æ˜¯SVGé©é…ç‰ˆçš„æœ€çµ‚ä»£ç¢¼ â–¼â–¼â–¼ */
.ls-fab-btn {
    position: fixed;
    bottom: calc(30px + env(safe-area-inset-bottom));
    right: 30px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--accent-color);
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    cursor: pointer;
    z-index: 10;
    
    /* ä¾ç„¶ä½¿ç”¨Flexboxä¾†å±…ä¸­SVGåœ–ç¤º */
    display: flex;
    justify-content: center;
    align-items: center;

    /* ç§»é™¤æ‰€æœ‰èˆ‡å­—é«”ç›¸é—œçš„å±¬æ€§ */
    /* font-size: 28px; (å·²ç§»é™¤) */
    /* line-height: normal; (å·²ç§»é™¤) */
}

/* (å¯é¸) å¦‚æœä½ è¦ºå¾—SVGæœ‰é»å°æˆ–å¤§ï¼Œå¯ä»¥å¾®èª¿å®ƒçš„å¤§å° */
.ls-fab-btn svg {
    width: 24px;
    height: 24px;
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


/* èªªèªªå¡ç‰‡ */
#ls-moments-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
/* èªªèªªå¡ç‰‡ */
/* ... */
.ls-moment-card {
    position: relative; /* â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©ï¼šå°±æ˜¯åŠ ä¸Šé€™ä¸€è¡Œï¼ â˜…â˜…â˜… */
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    display: flex;
    gap: 12px;
}
/* ... */

.ls-moment-card .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    flex-shrink: 0;
}
.ls-moment-card .moment-main {
    display: flex;
    flex-direction: column;
}
.ls-moment-card .author {
    font-weight: 600;
    color: var(--text-primary);
}
.ls-moment-card .content {
    margin-top: 5px;
    font-size: 15px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
}
.ls-moment-card .timestamp {
    margin-top: 10px;
    font-size: 12px;
    color: var(--text-secondary);
}

/* ç›¸ç°¿æ¸…å–® */
/* â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°æ¨£å¼æ›¿æ›èˆŠçš„ #ls-album-list â–¼â–¼â–¼ */
#ls-album-list {
    display: grid;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šå¾2åˆ—è®Šç‚º3åˆ—ï¼Œé–“è·å¾15pxç¸®å°ç‚º5px */
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
.ls-album-item {
    cursor: pointer;
}
.ls-album-item .cover {
    width: 100%;
    aspect-ratio: 1 / 1;
    background-color: #e9ecef;
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    margin-bottom: 8px;
}
.ls-album-item .name {
    font-weight: 500;
    text-align: center;
}

/* ç…§ç‰‡ä¸Šå‚³é è¦½ */
#ls-photo-preview-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}
.ls-photo-preview-item {
    position: relative;
    aspect-ratio: 1 / 1;
}
.ls-photo-preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
}
.ls-photo-preview-item .remove-btn {
    position: absolute;
    top: -5px; right: -5px;
    width: 20px; height: 20px;
    background-color: #ff3b30;
    color: white;
    border-radius: 50%;
    border: none;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
}

/* æƒ…æ›¸å’Œåˆ†äº«åˆ—è¡¨ */
.ls-list-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 12px 15px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    cursor: pointer;
}
.ls-list-item .title {
    font-weight: 500;
    margin-bottom: 5px;
}
.ls-list-item .meta {
    font-size: 12px;
    color: var(--text-secondary);
}
.ls-share-item .share-type {
    display: inline-block;
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 4px;
    margin-right: 8px;
    color: white;
}
.share-type.song { background-color: #28a745; }
.share-type.movie { background-color: #fd7e14; }
.share-type.book { background-color: #6f42c1; }
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* ã€æ ¸å¿ƒä¿®å¾©ã€‘è®“æ¨™é¡Œçµ•å°å±…ä¸­ï¼Œä¸å†å—å…©é‚ŠæŒ‰éˆ•æ•¸é‡å½±éŸ¿ */
#ls-header #ls-char-name {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 60%; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé˜²æ­¢èˆ‡æŒ‰éˆ•é‡ç–Š */
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ã€æ–°å¢ã€‘é ­åƒå’Œè¨ˆæ•¸å™¨çš„ç¸½å®¹å™¨ï¼Œè² è²¬æ•´é«”å®šä½ */
.ls-avatar-and-counter-wrapper {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2;
    display: flex;
    flex-direction: column; /* è®“é ­åƒå’Œè¨ˆæ•¸å™¨å‚ç›´æ’åˆ— */
    align-items: center; /* æ°´æº–å±…ä¸­ */
    gap: 10px; /* é ­åƒå’Œè¨ˆæ•¸å™¨ä¹‹é–“çš„å‚ç›´é–“è· */
}

/* ã€ä¿®æ”¹ã€‘ç§»é™¤èˆŠçš„é ­åƒçµ•å°å®šä½ï¼Œå› ç‚ºå®ƒç¾åœ¨è¢«æ–°å®¹å™¨ç®¡ç†äº† */
.ls-header-avatars {
    position: static; /* æ”¹ç‚ºéœæ…‹å®šä½ */
    transform: none;
    bottom: auto;
    left: auto;
    /* å…¶ä»–æ¨£å¼ï¼ˆå¦‚é ­åƒå¤§å°ã€é‚Šæ¡†ç­‰ï¼‰ä¿æŒä¸è®Š */
}

/* ã€ä¿®æ”¹ã€‘ç§»é™¤èˆŠçš„è¨ˆæ•¸å™¨å®šä½æ¨£å¼ï¼Œè®“å®ƒåœ¨æ–°å®¹å™¨è£¡è‡ªç„¶æ’åˆ— */
#ls-days-counter {
    position: static;
    margin-top: 0;
    /* å…¶ä»–æ¨£å¼ï¼ˆå¦‚å­—é«”é¡è‰²ã€é™°å½±ç­‰ï¼‰ä¿æŒä¸è®Š */
}

/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®“ç›¸å†Šå°ˆæ¡ˆæˆç‚ºåˆªé™¤æŒ‰éˆ•çš„å®šä½åƒè€ƒé» */
.ls-album-item .cover {
    position: relative; /* é—œéµï¼ */
    overflow: hidden; /* é˜²æ­¢åˆªé™¤æŒ‰éˆ•æº¢å‡ºåœ“è§’ */
}

/* 2. åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
.ls-photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 18px;
    line-height: 24px; /* ç¢ºä¿ "Ã—" å‚ç›´å±…ä¸­ */
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜èªéš±è— */
    transition: opacity 0.2s ease;
    z-index: 5; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
}

/* 3. æ»‘é¼ æ‡¸åœåœ¨å°é¢ä¸Šæ™‚ï¼Œé¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
.ls-album-item .cover:hover .ls-photo-delete-btn {
    opacity: 1;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯ç‚ºæƒ…ä¾¶ç©ºé–“â€œèªªèªªâ€æ–°å¢çš„æ¨£å¼ â–¼â–¼â–¼ */

/* èªªèªªå¡ç‰‡åº•éƒ¨çš„äº’å‹•å€ï¼ˆè©•è«–è¼¸å…¥ã€åˆªé™¤æŒ‰éˆ•ç­‰ï¼‰ */
.ls-moment-footer {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0; /* å’Œå…§å®¹å€åˆ†éš”é–‹ */
}

/* è©•è«–åˆ—è¡¨çš„å®¹å™¨ */
.ls-moment-comments-container {
    display: flex;
    flex-direction: column;
    gap: 8px; /* æ¯æ¢è©•è«–ä¹‹é–“çš„é–“è· */
    font-size: 14px;
    margin-bottom: 10px;
}

/* æ¯ä¸€æ¢è©•è«–çš„æ¨£å¼ */
.ls-comment-item {
    position: relative; /* ç‚ºäº†å®šä½åˆªé™¤æŒ‰éˆ• */
    padding-right: 25px; /* çµ¦åˆªé™¤æŒ‰éˆ•ç•™å‡ºç©ºé–“ */
    line-height: 1.5;
}

.ls-comment-item .commenter-name {
    font-weight: 600;
    color: var(--accent-color); /* ä½¿ç”¨ä¸»é¡Œè‰² */
    margin-right: 5px;
}

/* è©•è«–çš„åˆªé™¤æŒ‰éˆ• */
.ls-comment-delete-btn {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    border-radius: 50%;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    opacity: 0; /* é»˜èªéš±è— */
    transition: all 0.2s ease;
}

/* æ»‘é¼ æ”¾ä¸Šå»æ‰é¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
.ls-comment-item:hover .ls-comment-delete-btn {
    opacity: 1;
}
.ls-comment-delete-btn:hover {
    background-color: #f0f0f0;
    color: #ff3b30;
}

/* è©•è«–è¼¸å…¥å€åŸŸçš„æ¨£å¼ */
.ls-comment-input-area {
    display: flex;
    gap: 8px;
    align-items: center;
}

.ls-comment-input-area input {
    flex-grow: 1;
    border: none;
    background-color: #f0f2f5;
    border-radius: 15px;
    padding: 8px 12px;
    font-size: 14px;
}

.ls-comment-input-area button {
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 15px;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¢«å£“ç¸® */
}

/* èªªèªªå¡ç‰‡æœ¬èº«çš„åˆªé™¤æŒ‰éˆ• */
.ls-moment-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.08);
    color: var(--text-secondary);
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 24px;
    text-align: center;
    opacity: 0; /* é»˜èªéš±è— */
    transition: all 0.2s ease;
}
.ls-moment-card:hover .ls-moment-delete-btn {
    opacity: 1; /* æ»‘é¼ æ”¾ä¸Šå»æ‰é¡¯ç¤º */
}
.ls-moment-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}

/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€ä¿¡ç´™ç¾åŒ–ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä¸Šä¸€ç‰ˆçš„æ‰€æœ‰æƒ…æ›¸CSS â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘æƒ…ä¾¶ç©ºé–“æƒ…æ›¸åŠŸèƒ½æ¨£å¼ --- */

/* 1. æƒ…æ›¸åˆ—è¡¨ç‚ºç©ºæ™‚çš„æç¤º (ä¸è®Š) */
#ls-letters-list .ls-empty-placeholder {
    text-align: center;
    color: var(--text-secondary);
    padding: 50px 0;
}

/* 2. å–®å€‹æƒ…æ›¸å¡ç‰‡çš„æ¨£å¼ (å·²ä¿®æ”¹) */
.ls-love-letter-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    gap: 12px;
    align-items: center;
}
.ls-love-letter-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

/* 3. æƒ…æ›¸åœ–ç¤ºçš„æ¨£å¼ (ä¸è®Š) */
.ls-love-letter-item .letter-icon {
    flex-shrink: 0;
    width: 45px;
    height: 45px;
    color: #ff8fab;
}

/* 4. æƒ…æ›¸ä¸»è¦è³‡è¨Šå€ (å·²ä¿®æ”¹ï¼ŒåŠ å…¥é ­åƒ) */
.ls-love-letter-item .letter-info {
    flex-grow: 1;
    overflow: hidden;
}
/* ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ”¶ä»¶äººå€åŸŸç¾åœ¨åŒ…å«é ­åƒå’Œåå­— */
.ls-love-letter-item .letter-recipient {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 5px;
}
.ls-love-letter-item .letter-recipient .avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
}
.ls-love-letter-item .letter-preview {
    font-size: 13px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 5. ç™¼ä¿¡äººè³‡è¨Š (ä¸è®Š) */
.ls-love-letter-item .letter-sender {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--text-secondary);
}
.ls-love-letter-item .letter-sender .avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
}

/* 6. ã€å…¨æ–°ã€‘æƒ…æ›¸è©³æƒ…æª¢è¦–å™¨ (ä¿¡ç´™æ¨£å¼) */
#ls-letter-viewer-modal {
    z-index: 1001; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
}
.ls-letter-viewer-content {
    background-color: #fdfaef; /* æº«é¦¨çš„ç±³é»ƒè‰²ä¿¡ç´™èƒŒæ™¯ */
    width: 90%;
    max-width: 340px;
    height: 75%;
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    font-family: 'Kaiti', 'STKaiti', serif; /* ä½¿ç”¨æ›´å…¸é›…çš„æ¥·é«” */
}
.letter-viewer-header {
    padding: 15px;
    border-bottom: 1px dashed #e0d9c7;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #5d4037;
}
.letter-viewer-header .meta-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
}
.letter-viewer-header .recipient-info .label {
    font-size: 13px;
    color: #a1887f;
}
.letter-viewer-header .recipient-info .name {
    font-size: 16px;
    font-weight: 600;
}
.letter-viewer-body {
    flex-grow: 1;
    padding: 20px;
    font-size: 16px;
    line-height: 2; /* æ›´å¤§çš„è¡Œé«˜ï¼Œæ¨¡æ“¬æ‰‹å¯«ä¿¡çš„èˆ’é©æ„Ÿ */
    color: #4a443b;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
}
.letter-viewer-footer {
    padding: 15px;
    border-top: 1px dashed #e0d9c7;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}
.letter-viewer-footer .sender-info {
    font-size: 14px;
    color: #5d4037;
    font-weight: 600;
}
.letter-viewer-footer .sender-info .timestamp {
    font-size: 11px;
    color: #a1887f;
    font-weight: normal;
}
.letter-viewer-footer .letter-actions {
    display: flex;
    gap: 10px;
}
.letter-viewer-footer .letter-actions button {
    padding: 8px 15px;
    border-radius: 15px;
    border: 1px solid #d4bda5;
    background-color: transparent;
    color: #8c7b6c;
    cursor: pointer;
    font-size: 14px;
}
.letter-viewer-footer .letter-actions button.primary {
    background-color: #ff8fab;
    color: white;
    border-color: #ff8fab;
}

/* â–²â–²â–² æ¨£å¼æ›¿æ›çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯ç‚ºæƒ…æ›¸æ–°å¢çš„æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“æƒ…æ›¸å¡ç‰‡å¯ä»¥ä½œç‚ºåˆªé™¤æŒ‰éˆ•çš„å®šä½åƒè€ƒé» */
.ls-love-letter-item {
    position: relative; /* é—œéµï¼ */
}

/* 2. åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
.ls-letter-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.1);
    color: #888;
    border: none;
    border-radius: 50%;
    font-size: 18px;
    line-height: 24px;
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜èªéš±è— */
    transition: all 0.2s ease;
    z-index: 5; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
}

/* 3. æ»‘é¼ æ‡¸åœåœ¨æ•´å¼µå¡ç‰‡ä¸Šæ™‚ï¼Œæ‰é¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
.ls-love-letter-item:hover .ls-letter-delete-btn {
    opacity: 1;
}

/* 4. æ»‘é¼ æ‡¸åœåœ¨åˆªé™¤æŒ‰éˆ•ä¸Šæ™‚ï¼Œçµ¦ä¸€é»å›é¥‹æ•ˆæœ */
.ls-letter-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æƒ…ä¾¶æå•æ¨£å¼ --- */

#ls-questions-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.ls-question-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden; /* é˜²æ­¢å…§éƒ¨å…ƒç´ æº¢å‡ºåœ“è§’ */
}

.ls-question-section,
.ls-answer-section {
    padding: 15px;
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.ls-question-section {
    border-bottom: 1px dashed var(--border-color);
}

.ls-question-card .qa-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    flex-shrink: 0;
}

.ls-question-card .qa-main {
    display: flex;
    flex-direction: column;
    width: 100%;
}

.ls-question-card .qa-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.ls-question-card .qa-author {
    font-weight: 600;
}

.ls-question-card .qa-timestamp {
    font-size: 11px;
    color: var(--text-secondary);
}

.ls-question-card .qa-content {
    font-size: 15px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
}

.ls-answer-placeholder {
    padding: 20px;
    text-align: center;
}

.ls-answer-btn {
    padding: 8px 20px;
    border: 1px solid var(--accent-color);
    background-color: transparent;
    color: var(--accent-color);
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œæƒ…ä¾¶æå•â€æ–°å¢çš„åˆªé™¤æŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“æå•å¡ç‰‡å¯ä»¥ä½œç‚ºåˆªé™¤æŒ‰éˆ•çš„å®šä½åƒè€ƒé» */
.ls-question-card {
    position: relative; /* é—œéµï¼ */
}

/* 2. åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
.ls-question-delete-btn {
    position: absolute; /* çµ•å°å®šä½ï¼Œè®“å®ƒæµ®å‹•èµ·ä¾† */
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.08); /* åŠé€æ˜çš„èƒŒæ™¯ */
    color: var(--text-secondary); /* ä½¿ç”¨å…¨åŸŸçš„æ¬¡è¦æ–‡å­—é¡è‰² */
    border: none;
    border-radius: 50%; /* åœ“å½¢ */
    font-size: 18px;    /* "Ã—"è™Ÿçš„å¤§å° */
    line-height: 24px;  /* è®“"Ã—"è™Ÿå‚ç›´å±…ä¸­ */
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜èªéš±è— */
    transition: all 0.2s ease; /* æ·»åŠ å¹³æ»‘çš„å‹•ç•«æ•ˆæœ */
    z-index: 5; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
}

/* 3. æ»‘é¼ æ‡¸åœåœ¨æ•´å¼µå¡ç‰‡ä¸Šæ™‚ï¼Œæ‰é¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
.ls-question-card:hover .ls-question-delete-btn {
    opacity: 1;
}

/* 4. æ»‘é¼ æ‡¸åœåœ¨åˆªé™¤æŒ‰éˆ•ä¸Šæ™‚ï¼Œçµ¦ä¸€é»å›é¥‹æ•ˆæœ */
.ls-question-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯ç‚ºâ€œåˆ†äº«â€åŠŸèƒ½æ–°å¢çš„æ¨£å¼ â–¼â–¼â–¼ */

.ls-share-item .title {
    font-weight: 600; /* æ¨™é¡ŒåŠ ç²— */
}

/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©æ›è¡Œå•é¡Œã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰èˆŠçš„ .ls-share-item .summary æ¨£å¼ â–¼â–¼â–¼ */
.ls-share-item .summary {
    font-size: 14px;
    color: #666;
    margin-top: 8px;
    line-height: 1.6;
    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šå…è¨±æ–‡å­—è‡ªå‹•æ›è¡Œ --- */
    white-space: normal;     /* <--- å…è¨±æ›è¡Œ */
    overflow: visible;       /* <--- å…è¨±å…§å®¹æº¢å‡ºå®¹å™¨ï¼ˆå³é¡¯ç¤ºå¤šè¡Œï¼‰ */
    text-overflow: clip;     /* <--- ç¦ç”¨çœç•¥è™Ÿ */
    word-break: break-word;  /* <--- é˜²æ­¢è¶…é•·å–®è©æˆ–é€£çµæ’ç ´ä½ˆå±€ */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


#phone-screen.dark-mode .ls-share-item .summary {
    color: #a0a0a0;
}

/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æƒ…ä¾¶ç©ºé–“å°ˆå±¬éŸ³æ¨‚æ’­æ”¾æ©Ÿçš„CSSæ¨£å¼ â–¼â–¼â–¼ */

/* æ’­æ”¾æ©Ÿä¸»çª—å£çš„é®ç½©å±¤ */
#ls-music-player-overlay {
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

/* æ’­æ”¾æ¸…å–®é¢æ¿çš„æ¨£å¼ (ç›´æ¥è¤‡ç”¨ç¾æœ‰çš„) */
#ls-music-playlist-panel {
    /* æˆ‘å€‘ç›´æ¥ä½¿ç”¨ .music-playlist-panel çš„ç¾æœ‰æ¨£å¼ï¼Œçœå»é‡è¤‡ä»£ç¢¼ */
}

/* â–²â–²â–² CSSæ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* ã€æ–°å¢ã€‘éš±è—æƒ…ä¾¶ç©ºé–“æ’­æ”¾æ©Ÿä¸­ä¸éœ€è¦çš„æŒ‰éˆ• */
#ls-music-player-overlay #ls-playlist-btn,
#ls-music-player-overlay #ls-prev-btn,
#ls-music-player-overlay #ls-next-btn {
    display: none;
}

/* ã€æ–°å¢ã€‘å±…ä¸­æ’­æ”¾/æš«åœæŒ‰éˆ• */
#ls-music-player-overlay .music-controls {
    justify-content: center; /* è®“å‰©ä¸‹çš„æŒ‰éˆ•å±…ä¸­ */
}

/* â–²â–²â–² CSSä»£ç¢¼æ›¿æ›çµæŸ â–²â–²â–² */
/* ã€æ–°å¢ã€‘æƒ…ä¾¶ç©ºé–“æ’­æ”¾æ©Ÿå°é¢/æ­Œè©åˆ‡æ›æ¨£å¼ */
#ls-display-area.show-lyrics #ls-album-cover {
    display: none; /* ç•¶æœ‰ show-lyrics é¡æ™‚ï¼Œéš±è—å°é¢ */
}
#ls-display-area.show-lyrics #ls-lyrics-container {
    display: block !important; /* ç•¶æœ‰ show-lyrics é¡æ™‚ï¼Œé¡¯ç¤ºæ­Œè© */
}

/* ã€æ–°å¢ã€‘æ­Œè©è¡Œæ¨£å¼ */
#ls-lyrics-container .lyric-line {
    padding: 4px 0;
    font-size: 14px;
    color: #666;
    opacity: 0.7;
    transition: all 0.5s ease;
}
#ls-lyrics-container .lyric-line.active {
    font-size: 16px;
    color: #000;
    opacity: 1;
    font-weight: 600;
}
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æƒ…ä¾¶ç•ªèŒ„é˜æ¨£å¼ --- */

/* ä¸»é ä½ˆå±€ */
#ls-pomodoro-home {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

#ls-pomodoro-start-btn-container {
    padding: 20px;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    text-align: center;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
#ls-pomodoro-start-btn-container:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.12);
}
#ls-pomodoro-start-icon {
    font-size: 32px;
    color: var(--accent-color);
    line-height: 1;
}
#ls-pomodoro-start-btn-container p {
    margin: 8px 0 0 0;
    font-weight: 500;
    color: var(--text-primary);
}

/* æ­·å²è¨˜éŒ„æ¸…å–® */
#ls-pomodoro-history-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.pomodoro-history-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 12px 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    cursor: pointer;
}
.pomodoro-history-item:hover {
    background-color: #f9f9f9;
}
.pomodoro-history-item .task {
    font-weight: 500;
    margin-bottom: 5px;
}
.pomodoro-history-item .meta {
    font-size: 12px;
    color: var(--text-secondary);
}

/* â–¼â–¼â–¼ æŠŠä¸‹é¢é€™æ•´å¡Šã€é–æ©Ÿå…¨å±ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ #ls-pomodoro-timer-active æ¨£å¼ â–¼â–¼â–¼ */
#ls-pomodoro-timer-active {
    /* æ ¸å¿ƒä¿®æ”¹1ï¼šå°‡å®šä½æ–¹å¼å¾ absolute æ”¹ç‚º fixed */
    /* é€™æœƒè®“è¨ˆæ™‚å™¨ä»‹é¢è„«é›¢åŸä¾†çš„â€œæƒ…ä¾¶ç©ºé–“â€é é¢ï¼Œæµ®å‹•åœ¨æ•´å€‹æ‰‹æ©Ÿè¢å¹•çš„æœ€é ‚å±¤ï¼*/
    position: fixed; 
    
    /* æ ¸å¿ƒä¿®æ”¹2ï¼šç”¨é€™å››å€‹å±¬æ€§è®“å®ƒæ’æ»¿æ•´å€‹è¢å¹• */
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    
    /* æ ¸å¿ƒä¿®æ”¹3ï¼šè¨­ç½®ä¸€å€‹è¶…é«˜çš„å±¤ç´šï¼Œç¢ºä¿å®ƒèƒ½è“‹ä½æ‰€æœ‰æ±è¥¿ï¼Œå¯¦ç¾â€œé–æ©Ÿâ€æ•ˆæœ */
    z-index: 2000; 
    
    background-size: cover;
    background-position: center;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    padding: 50px 20px;
    box-sizing: border-box;
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);

    /* (å¯é¸å„ªåŒ–) ç‚ºiPhoneçš„åŠ‰æµ·å’Œåº•éƒ¨å°é»‘æ¢ç•™å‡ºå®‰å…¨è·é›¢ï¼Œè®“ä»‹é¢æ›´ç¾è§€ */
    padding-top: calc(50px + env(safe-area-inset-top));
    padding-bottom: calc(50px + env(safe-area-inset-bottom));
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ç”¨é€™æ®µæ–°ä»£ç¢¼æ›¿æ› â–¼â–¼â–¼ */
.pomodoro-char-avatar-container {
    position: relative;
    text-align: center;
    width: 100%; /* <-- å°±æ˜¯æ–°å¢äº†é€™ä¸€è¡Œï¼ */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
#pomodoro-char-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.8);
    cursor: pointer;
    transition: transform 0.2s;
}
#pomodoro-char-avatar:active {
    transform: scale(0.9);
}
/* â–¼â–¼â–¼ ç”¨é€™æ®µã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ä»£ç¢¼å®Œæ•´æ›¿æ›èˆŠçš„ #pomodoro-char-log æ¨£å¼ â–¼â–¼â–¼ */
#pomodoro-char-log {
    position: absolute;
    top: 100%;
    margin-top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.65);
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 14px;
    max-width: 80%; /* <-- æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ï¼è®“æ°£æ³¡å¯ä»¥è®Šå¾—æ›´å¯¬ */
    width: max-content; /* <-- æ–°å¢ï¼ç¢ºä¿æ°£æ³¡å¯¬åº¦æ ¹æ“šå…§å®¹è‡ªæˆ‘èª¿æ•´ï¼Œä½†ä¸æœƒè¶…é80% */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s, margin-top 0.3s; /* margin-topè®“å‹•ç•«æ›´å¹³æ»‘ */
    pointer-events: none;
    white-space: pre-wrap;
    box-sizing: border-box; /* æ–°å¢ï¼é˜²æ­¢å…§é‚Šè·å°è‡´ä½ˆå±€å•é¡Œ */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


#pomodoro-char-log::after {
    content: '';
    position: absolute;
    bottom: 100%; /* <-- ä¿®æ”¹é€™è£¡ */
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border: 6px solid transparent;
    border-bottom-color: rgba(0,0,0,0.65); /* <-- ä¿®æ”¹é€™è£¡ */
}


#pomodoro-char-log.visible {
    opacity: 1;
    visibility: visible; /* æ–°å¢ */
    margin-bottom: 22px; /* æ ¸å¿ƒä¿®å¾©3: é¡¯ç¤ºæ™‚å‘ä¸Šç§»å‹•ä¸€é»ï¼Œæœ‰ä¸€å€‹â€œå†’å‡ºä¾†â€çš„å‹•ç•«æ•ˆæœ */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */



/* æ™‚é–“å’Œä»»å‹™é¡¯ç¤º */
.pomodoro-timer-display {
    text-align: center;
}
#pomodoro-current-task {
    font-size: 20px;
    font-weight: 500;
    margin-bottom: 10px;
}
#pomodoro-time {
    font-size: 72px;
    font-weight: 200;
    letter-spacing: 2px;
}

/* çµæŸæŒ‰éˆ• */
#pomodoro-end-btn {
    padding: 12px 30px;
    font-size: 16px;
    font-weight: 600;
    border: 2px solid white;
    background-color: rgba(255,255,255,0.2);
    color: white;
    border-radius: 25px;
    cursor: pointer;
}

/* æ­·å²è©³æƒ…å½ˆçª—å…§çš„èŠå¤©æ°£æ³¡ */
#pomodoro-history-viewer-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.pomodoro-log-bubble {
    padding: 8px 12px;
    border-radius: 12px;
    max-width: 80%;
    background-color: #f0f0f0;
    align-self: flex-start;
    line-height: 1.5;
}
#phone-screen.dark-mode .pomodoro-log-bubble {
    background-color: #2c2c2e;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */

/* --- ä¿®å¾©æ–°å¢åŠŸèƒ½å°è‡´çš„æ²è»¸å•é¡Œ --- */

/* 1. å¼·åˆ¶éš±è—ä½ ä¸è¦çš„â€œæƒ…ä¾¶ç©ºé–“æ’­æ”¾æ¸…å–®â€ */
#ls-music-playlist-panel {
    display: none !important;
}

/* 2. ç¢ºä¿ä¸»è¢å¹•å®¹å™¨çµ•å°ä¸æœƒå‡ºç¾æ²è»¸ï¼Œå¯¦ç¾å›ºå®šæ•ˆæœ */
#phone-screen {
    overflow: hidden !important;
}



/* === ã€åœˆå­è©•è«–å€çµ‚æ¥µä¿®å¾© - è¦†è“‹ç¹¼æ‰¿ç‰ˆã€‘ === */

/* 
   å•é¡Œæ ¹æºï¼šåœˆå­è©•è«–å€(#post-comment-input-area)éŒ¯èª¤åœ°ç¹¼æ‰¿äº†
   ä¸»èŠå¤©è¼¸å…¥å€(.chat-input-area)çš„æ¨£å¼ï¼Œå°è‡´ä½ˆå±€éŒ¯äº‚ã€‚
   ä»¥ä¸‹ä»£ç¢¼å°‡é‡å°åœˆå­è¢å¹•(#post-screen)ä¸‹çš„è©•è«–å€é€²è¡Œå¼·åˆ¶è¦†è“‹ã€‚
*/

/* 1. å¼·åˆ¶é‡ç½®è©•è«–å€å®¹å™¨çš„ä½ˆå±€ï¼Œè®“å®ƒæ°´æº–æ’åˆ—ã€å‚ç›´å±…ä¸­ */
#post-screen #post-comment-input-area {
    display: flex !important;
    flex-direction: row !important; /* å¼·åˆ¶æ©«å‘æ’åˆ— */
    align-items: center !important;  /* å¼·åˆ¶å‚ç›´å±…ä¸­ï¼Œå¯¦ç¾å¹³è¡Œ */
    gap: 10px !important;            /* è¨­ç½®è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•çš„é–“è· */
}

/* 2. ç¢ºä¿å…§å±¤å®¹å™¨ä¹Ÿæ­£ç¢ºä¼¸å±• */
#post-screen #post-comment-input-area .chat-input-main-row {
    flex-grow: 1 !important;
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
}

/* 3. å¼·åˆ¶è¼¸å…¥æ¡†çš„æ¨£å¼ï¼Œä¸¦è®“å®ƒå¡«æ»¿ç©ºé–“ */
#post-screen #post-comment-input {
    flex-grow: 1 !important; /* è§£æ±ºå³å´ç©ºç™½çš„é—œéµï¼ */
    min-height: 40px;
    background-color: #f0f2f5 !important;
    border-radius: 20px !important;
    border: none !important;
    padding: 10px 15px !important;
    font-size: 14px !important;
    line-height: 1.5;
    resize: none;
    box-sizing: border-box;
}

/* 4. å¼·åˆ¶ç™¼é€æŒ‰éˆ•çš„æ¨£å¼ */
#post-screen #send-post-comment-btn {
    height: 40px !important;
    padding: 0 20px !important;
    border-radius: 20px !important;
    background-color: var(--accent-color) !important;
    color: white !important;
    font-weight: 600 !important;
    font-size: 14px !important;
    border: none !important;
    flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¢«å£“ç¸® */
}

/* å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode #post-screen #post-comment-input {
    background-color: #2c2c2e !important;
}
/* â–¼â–¼â–¼ é€™æ˜¯æ–°å¢çš„ä¸»è¢å¹•æ»‘å‹•æ¨£å¼ â–¼â–¼â–¼ */

/* ä¸»è¢å¹•æ»‘å‹•å®¹å™¨ */
.home-screen-slider {
    width: 100%;
    height: 100%; /* ç¢ºä¿å®ƒèƒ½æ’æ»¿çˆ¶å®¹å™¨ */
    display: flex; /* è®“å…©é ä¸¦æ’ç«™å¥½ */
    overflow-x: auto; /* å…è¨±æ°´æº–æ»¾å‹• */
    overflow-y: hidden; /* ç¦æ­¢å‚ç›´æ²å‹• */
    scroll-snap-type: x mandatory; /* é€™å°±æ˜¯æ»‘å‹•çš„é­”æ³•ï¼è®“å®ƒè‡ªå‹•å¸é™„åˆ°æ¯ä¸€é  */
    -webkit-overflow-scrolling: touch; /* åœ¨iOSä¸Šå¯¦ç¾æ›´å¹³æ»‘çš„æ»¾å‹• */
    scrollbar-width: none; /* éš±è—æ²è»¸ (Firefox) */
    -ms-overflow-style: none;  /* éš±è—æ²è»¸ (IE) */
}
.home-screen-slider::-webkit-scrollbar {
    display: none; /* éš±è—æ²è»¸ (Chrome, Safari) */
}

.home-page {
    width: 100%; /* æ¯ä¸€é éƒ½å æ»¿æ•´å€‹è¢å¹•å¯¬åº¦ */
    height: 100%;
    flex-shrink: 0; /* é˜²æ­¢é é¢è¢«å£“ç¸®è®Šå½¢ */
    scroll-snap-align: start; /* ç¢ºä¿æ¯æ¬¡éƒ½å°é½Šé é¢çš„é–‹å§‹ä½ç½® */
    
    /* è®“é é¢å…§éƒ¨çš„å…§å®¹å¯ä»¥æ»¾å‹• */
    overflow-y: auto;
    padding: 0 20px; /* ä¿æŒå’Œä½ åŸä¾†ä¸€æ¨£çš„å·¦å³é‚Šè· */
    box-sizing: border-box;
    position: relative; /* â˜…â˜…â˜… åœ¨é€™è£¡æ·»åŠ é€™ä¸€è¡Œï¼ â˜…â˜…â˜… */
}


/* åˆ†é å°åœ“é»çš„å®¹å™¨ */
.pagination-dots {
    position: absolute;
    bottom: calc(100px + env(safe-area-inset-bottom)); /* æ”¾åœ¨Dockæ¬„ä¸Šæ–¹ */
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px; /* åœ“é»ä¹‹é–“çš„é–“è· */
}

/* å–®å€‹å°åœ“é» */
.pagination-dots .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.4); /* æœªé¸ä¸­æ™‚çš„é¡è‰² */
    transition: background-color 0.3s ease; /* æ·»åŠ ä¸€å€‹å¹³æ»‘çš„é¡è‰²éæ¸¡å‹•ç•« */
}

/* è¢«é¸ä¸­çš„å°åœ“é» */
.pagination-dots .dot.active {
    background-color: rgba(255, 255, 255, 0.9); /* é¸ä¸­æ™‚è®Šå¾—æ›´äº® */
}

/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* é€™æ˜¯ç¬¬äºŒé ä½ˆå±€çš„å…¨æ–°æ¨£å¼ (V2 ç¾åŒ–ç‰ˆ) */

/* 1. æŠŠé ­åƒå°çµ„ä»¶å®šä½åˆ°å·¦åŠå±çš„ä¸­é–“ */
#second-page-left-widget {
    position: absolute;
    top: 50px; 
    left: 25%; 
    transform: translateX(-50%); 
}

/* â˜…â˜…â˜… é€™æ˜¯ç‚ºé ­åƒå°çµ„ä»¶æ–°å¢çš„æ”¾å¤§å’Œç´°é‚Šæ¡†æ¨£å¼ â˜…â˜…â˜… */
#second-page-left-widget .widget-circle-uploader {
    width: 65px;  /* é ­åƒå¯¬åº¦å¾ 65px æ”¾å¤§åˆ° 80px */
    height: 65px; /* é ­åƒé«˜åº¦å¾ 65px æ”¾å¤§åˆ° 80px */
    border-width: 1px; /* è¼ªå»“ç·šå¾ 2px æ¸›å°åˆ° 1pxï¼Œè®Šå¾—å¾ˆç´° */
    padding: 1px; /* â˜…â˜…â˜… åœ¨é€™è£¡æ·»åŠ é€™ä¸€è¡Œï¼ŒæŠŠç¸«éš™æ¸›å°åˆ°1åœ–å…ƒ â˜…â˜…â˜… */
}
/* 2. æŠŠå³ä¸Šè§’çš„åœ–ç¤ºæ”¹ç‚ºä¸¦æ’æ’åˆ— */
#second-page-top-right-apps {
    position: absolute;
    top: 50px;
    right: 30px;
    display: flex;
    gap: 30px; /* â˜…â˜…â˜… åœ–ç¤ºé–“è·å¾ 25px å¢åŠ åˆ° 30pxï¼Œæ‹‰é–‹è·é›¢ â˜…â˜…â˜… */
}

/* 3. æ–‡å­—é¡è‰²æ¨£å¼ä¿æŒä¸è®Š */
#second-page-top-right-apps .desktop-app-icon .label {
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}
/* â–¼â–¼â–¼ æŠŠé€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šæ–°ä»£ç¢¼ã€‘å®Œæ•´æ›¿æ›æ‰ä½ ä¸Šæ¬¡æ·»åŠ çš„ã€é—œæ–¼ç¬¬äºŒé é ­åƒçš„æ‰€æœ‰CSS â–¼â–¼â–¼ */

/* 1. å®¹å™¨ï¼šç§»é™¤å…ƒç´ é–“è·ï¼Œè®“é ­åƒå’Œæ°£æ³¡é æ” (ä¿æŒä¸è®Š) */
#second-page-left-widget {
    /* â˜…â˜…â˜… åœ¨é€™è£¡æ–°å¢ä¸€å€‹å¯¬åº¦ï¼Œä½œç‚ºâ€œä¸»å¯¬åº¦â€ â˜…â˜…â˜… */
    width: 150px;
    gap: 0;
}

#second-page-bubble {
    margin-top: -10px;
    padding: 10px 15px;
    border-radius: 30px;
    /* â˜…â˜…â˜… ä¿®æ”¹é»1ï¼šç§»é™¤ min-width å’Œ display: inline-block â˜…â˜…â˜… */
    /* min-width: 140px; */
    /* display: inline-block; */

    /* â˜…â˜…â˜… ä¿®æ”¹é»2ï¼šæ·»åŠ ä¸‹é¢é€™ä¸‰è¡Œï¼Œè®“å®ƒå æ»¿çˆ¶å®¹å™¨å¯¬åº¦ä¸¦å±…ä¸­ â˜…â˜…â˜… */
    width: 100%;
    box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’ç ´ä½ˆå±€ */
    text-align: center;     /* è®“æ–‡å­—åœ¨è®Šå¯¬çš„å®¹å™¨è£¡å±…ä¸­ */
    
    background-color: rgba(255, 255, 255, 0.4);
    color: #1c1c1e;
    text-shadow: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    z-index: 1;
}



/* â˜…â˜…â˜… ä¿®æ”¹é»2ï¼šåœ¨é€™è£¡æ˜ç¢ºç§»é™¤é‚£å€‹ä¸æƒ³è¦çš„å°–è§’ â˜…â˜…â˜… */
#second-page-bubble::after {
    content: none; /* å¼·åˆ¶ç§»é™¤ç¹¼æ‰¿è‡ª .widget-bubble çš„å°–è§’å½å…ƒç´  */
}

/* 3. æå‡é ­åƒå±¤ç´š (ä¿æŒä¸è®Š) */
#second-page-left-widget .widget-circle-uploader {
    position: relative; 
    z-index: 2;         
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. æ–°å¢æ°£æ³¡çš„å®¹å™¨ï¼Œè² è²¬æ•´é«”ä½ˆå±€å’Œå¯¬åº¦ */
#new-bubbles-container {
    display: flex;
    align-items: center;
    gap: 8px;
    /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå°‡å›ºå®šçš„ 180px æ”¹ç‚º 100%ï¼Œè®“å®ƒè‡ªå‹•è·Ÿéš¨çˆ¶å®¹å™¨ â˜…â˜…â˜… */
    width: 100%;
    margin-top: 8px;
}


/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€å…¨æ–°çš„ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ #flat-capsule-bubble æ¨£å¼ â–¼â–¼â–¼ */
/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€ä¿®æ”¹å¾Œã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ #flat-capsule-bubble æ¨£å¼ â–¼â–¼â–¼ */
#flat-capsule-bubble {
    flex-grow: 1;
    min-width: auto;
    /* â˜…â˜…â˜… ä¿®æ”¹é»1ï¼šé«˜åº¦å¾ 44px æ¸›å°åˆ° 38px â˜…â˜…â˜… */
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 15px;
    /* â˜…â˜…â˜… ä¿®æ”¹é»2ï¼šæ–°å¢èƒŒæ™¯è‰²ï¼Œå°‡é€æ˜åº¦å¾ 0.4 æå‡åˆ° 0.6ï¼Œè®“å®ƒæ›´ä¸é€æ˜ â˜…â˜…â˜… */
    background-color: rgba(255, 255, 255, 0.4);
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

#flat-capsule-bubble::after {
    content: none; /* ç§»é™¤ç¹¼æ‰¿ä¾†çš„å°å°¾å·´ */
}


/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€ä¿®æ”¹å¾Œã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ #circular-bubble æ¨£å¼ â–¼â–¼â–¼ */
#circular-bubble {
    flex-shrink: 0;
    /* â˜…â˜…â˜… ä¿®æ”¹é»1ï¼šå¯¬åº¦å’Œé«˜åº¦éƒ½å¾ 44px æ¸›å°åˆ° 38px â˜…â˜…â˜… */
    width: 35px;
    height: 35px;
    border-radius: 50%;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-width: auto;
    /* â˜…â˜…â˜… ä¿®æ”¹é»2ï¼šæ–°å¢èƒŒæ™¯è‰²ï¼Œèˆ‡è† å›Šæ°£æ³¡ä¿æŒä¸€è‡´ï¼Œæ›´ä¸é€æ˜ â˜…â˜…â˜… */
    background-color: rgba(255, 255, 255, 0.4);
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* 4. ç§»é™¤åœ“å½¢æ°£æ³¡çš„å°å°¾å·´ */
#circular-bubble::after {
    content: none;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. æ–°é ­åƒçµ„ä»¶çš„å®šä½ï¼šä¸­é–“åä¸Š */
#second-page-center-avatar {
    position: absolute;
    top: 235px; /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ï¼Œæ•¸å€¼è¶Šå°è¶Šé ä¸Š */
    transform: translateX(-50%); /* æ°´æº–å±…ä¸­ */
    z-index: 5; /* ç¢ºä¿å®ƒåœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
}

/* 2. æ–°é ­åƒçš„å°ºå¯¸å’Œæ¨£å¼ï¼šæ¯”ç¬¬ä¸€å€‹å¤§ï¼Œä¸”æ²’æœ‰è¼ªå»“ç·š */
#second-page-center-avatar .widget-circle-uploader {
    width: 85px;  /* æ¯”ç¬¬ä¸€å€‹é ­åƒ(65px)å¤§ä¸€åœˆ */
    height: 85px; /* ä¿æŒæ­£åœ“ */
    border: none; /* ç§»é™¤è¼ªå»“ç·š */
    padding: 0;   /* ç§»é™¤å…§é‚Šè·ï¼Œè®“åœ–ç‰‡å¡«æ»¿ */
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. é€™æ˜¯åŒ…è£¹é ­åƒå’Œæ‰€æœ‰æ–°æ°£æ³¡çš„ç¸½å®¹å™¨ (V2 åŠ å¤§ç‰ˆ) */
/* 1. é€™æ˜¯åŒ…è£¹é ­åƒå’Œæ‰€æœ‰æ–°æ°£æ³¡çš„ç¸½å®¹å™¨ (V2 åŠ å¤§ç‰ˆ) */
#center-avatar-wrapper {
    position: absolute;
    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå°‡å›ºå®šå€¼æ”¹ç‚ºå¯èª¿ç¯€çš„è®Šæ•¸ï¼Œä¸¦æä¾›ä¸€å€‹é è¨­å€¼ 190px */
    top: var(--second-page-center-avatar-top-offset, 190px); 
    transform: translateX(-55%);
    z-index: 5;
    
    /* â˜… ä¿®æ”¹é»ï¼šæŠŠé€™å€‹â€œçœ‹ä¸è¦‹çš„ç›’å­â€çš„å°ºå¯¸è®Šå¤§ */
    width: 300px;  /* å¾ 250px å¢åŠ åˆ°äº† 300px */
    height: 180px; /* å¾ 150px å¢åŠ åˆ°äº† 180px */
}





/* 2. æŠŠä½ åŸä¾†çš„é ­åƒåœ¨ç¸½å®¹å™¨è£¡å±…ä¸­ï¼Œé€™æ¨£å®ƒçš„ä½ç½®çœ‹èµ·ä¾†å’ŒåŸä¾†ä¸€æ¨¡ä¸€æ¨£ */
#second-page-center-avatar {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    /* æˆ‘å€‘ä¸å†éœ€è¦å®ƒè‡ªå·±ä¾†å®šä½äº†ï¼Œæ‰€ä»¥æŠŠèˆŠçš„å®šä½æ¨£å¼ç§»é™¤ */
}

#avatar-subtitle {
    position: absolute;
    bottom:  20px; /* â˜… ä¿®æ”¹é»ï¼šæŠŠå®ƒå¾å®¹å™¨å¤–é¢ç§»åˆ°è£¡é¢ï¼Œä½ç½®æ›´å”èª¿ */
    left: 50%;
    transform: translateX(-50%);
    
    background-color: transparent;
    border: none;
    outline: none;
    
    color: white;
    font-size: 14px;
    font-weight: 500;
    text-align: center;
    text-shadow: 0 1px 3px rgba(0,0,0,0.6);
    cursor: pointer;
    padding: 2px 8px;
}


/* é€™æ˜¯å››å€‹è§’è½æ°£æ³¡çš„é€šç”¨æ¨£å¼ */
.corner-bubble {
    position: absolute;
    background-color: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 8px 12px;
    color: white;
    font-size: 12px;
    font-weight: 500;
    text-align: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    min-width: 80px; 
    cursor: pointer;
}

/* â–¼â–¼â–¼ åœ¨é€™è£¡åˆ†åˆ¥ä¿®æ”¹å››å€‹è§’è½çš„ä½ç½® â–¼â–¼â–¼ */

/* 5. åˆ†åˆ¥å®šä½å››å€‹è§’è½çš„æ°£æ³¡ */
#bubble-top-left {
    top: 40px;    /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ï¼Œæ•¸å€¼è¶Šå¤§è¶Šã€å¾€ä¸‹ã€‘ç§» */
    left: -15px;   /* æ§åˆ¶å·¦å³ä½ç½®ï¼Œæ•¸å€¼è¶Šå¤§è¶Šã€å¾€å³ã€‘ç§» */
}

#bubble-top-right {
    top: 40px;    /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ï¼Œæ•¸å€¼è¶Šå¤§è¶Šã€å¾€ä¸‹ã€‘ç§» */
    right: -15px;  /* æ§åˆ¶å·¦å³ä½ç½®ï¼Œæ•¸å€¼è¶Šå¤§è¶Šã€å¾€å·¦ã€‘ç§» */
}

#bubble-bottom-left {
    bottom: 40px; /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ï¼Œæ•¸å€¼è¶Šå¤§è¶Šã€å¾€ä¸Šã€‘ç§» */
    left: -15px;   /* æ§åˆ¶å·¦å³ä½ç½®ï¼Œæ•¸å€¼è¶Šå¤§è¶Šã€å¾€å³ã€‘ç§» */
}

#bubble-bottom-right {
    bottom: 40px; /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ï¼Œæ•¸å€¼è¶Šå¤§è¶Šã€å¾€ä¸Šã€‘ç§» */
    right: -15px;  /* æ§åˆ¶å·¦å³ä½ç½®ï¼Œæ•¸å€¼è¶Šå¤§è¶Šã€å¾€å·¦ã€‘ç§» */
}
/* â–¼â–¼â–¼ ã€é€™æ˜¯ä¿®æ”¹å¾Œçš„ç‰ˆæœ¬ã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ â–¼â–¼â–¼ */

/* 1. ç¸½å®¹å™¨ï¼šç§»é™¤äº†é ‚éƒ¨çš„å…§é‚Šè· */
#new-custom-widget {
    position: absolute;
    bottom: 30px;
    right: 20px;
    width: 50%;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
    /* padding-top: 50px;  <-- é€™è¡Œå·²ç¶“è¢«åˆªæ‰äº† */
}

/* 2. ã€å…¨æ–°ã€‘é ­éƒ¨å®¹å™¨ï¼šè² è²¬è®“æœˆä»½å’Œé ­åƒæ°´æº–æ’åˆ— */
/* é€™æ˜¯é ­éƒ¨å®¹å™¨ï¼šè² è²¬è®“æœˆä»½å’Œé ­åƒæ°´æº–æ’åˆ— */
#new-widget-header {
    width: 100%;
    display: flex;
    justify-content: flex-end; /* ä¿®æ”¹ï¼šè®“æ‰€æœ‰å…§å®¹éƒ½é å³å°é½Š */
    align-items: center;
    gap: 70px; /* æ–°å¢ï¼šåœ¨æœˆä»½å’Œé ­åƒä¹‹é–“åŠ ä¸€é»é–“è· */
    margin-bottom: 5px;
}



/* 3. æœˆä»½ï¼šç§»é™¤äº†çµ•å°å®šä½ï¼Œç¾åœ¨æ˜¯æ™®é€šçš„flexé …ç›® */
#widget-month-display {
    font-size: 25px;
    font-weight: 300;
    color: rgba(255, 255, 255, 0.85);
    text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
    line-height: 1;
}

/* 4. é ­åƒï¼šç§»é™¤äº†ä¸å¿…è¦çš„æ¨£å¼ï¼Œå› ç‚ºä½ˆå±€ç”±çˆ¶å®¹å™¨æ§åˆ¶äº† */
#new-custom-widget #new-widget-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    outline: none;
}

/* 5. å¯ç·¨è¼¯æ–‡å­—å’Œåˆ†å‰²ç·š (ä¿æŒä¸è®Š) */
#new-custom-widget .new-widget-text {
    background: transparent;
    border: none;
    outline: none;
    padding: 2px 4px;
    border-radius: 3px;
    color: rgba(255, 255, 255, 0.85);
    text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
    font-size: 13px;
    text-align: right;
    width: 100%;
    box-sizing: border-box;
}

#new-custom-widget .new-widget-divider {
    width: 60%;
    height: 1px;
    border-top: 1px dashed rgba(255, 255, 255, 0.3);
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€ç²¾ç·»ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„è«–å£‡å¸–å­åˆªé™¤æŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */

/* 1. å¸–å­æ¸…å–®é …æ¨£å¼ (ä¿æŒä¸è®Šï¼Œåªæ˜¯ç¢ºä¿å³å´æœ‰è¶³å¤ ç©ºé–“) */
.forum-post-item {
    position: relative;
    padding-right: 40px; 
}

/* 2. åˆªé™¤æŒ‰éˆ•çš„æ–°æ¨£å¼ - å°å·§ç²¾ç·»ç‰ˆ */
.forum-post-delete-btn {
    position: absolute;
    top: 50%;
    right: 12px; /* é›¢é‚Šç·£ç¨å¾®è¿‘ä¸€é» */
    transform: translateY(-50%);

    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šå°ºå¯¸è®Šå° --- */
    width: 24px;
    height: 24px;

    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šå¤–è§€æ›´ç²¾ç·» --- */
    background-color: transparent; /* é»˜èªèƒŒæ™¯é€æ˜ï¼Œä¸çªå…€ */
    color: var(--text-secondary);  /* é è¨­é¡è‰²ä½¿ç”¨æ¬¡è¦æ–‡å­—çš„ç°è‰²ï¼Œæ›´æŸ”å’Œ */
    border: none;
    border-radius: 50%;
    font-size: 18px;      /* æ¸›å° "Ã—" çš„å¤§å° */
    line-height: 24px;    /* ç¢ºä¿ "Ã—" å‚ç›´å±…ä¸­ */
    text-align: center;
    cursor: pointer;
    
    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šäº¤äº’å‹•æ•ˆ --- */
    transition: all 0.2s ease; /* ç‚ºæ‰€æœ‰è®ŠåŒ–æ·»åŠ å¹³æ»‘éæ¸¡ */
}

/* 3. æ»‘é¼ æ‡¸åœæ™‚çš„å›é¥‹æ•ˆæœ */
.forum-post-delete-btn:hover {
    background-color: #ff3b30; /* æ‡¸åœæ™‚æ‰é¡¯ç¤ºé†’ç›®çš„ç´…è‰²èƒŒæ™¯ */
    color: white;              /* "Ã—" è®Šç‚ºç™½è‰² */
    transform: translateY(-50%) scale(1.1); /* è¼•å¾®æ”¾å¤§ï¼Œæ›´æœ‰å‹•æ„Ÿ */
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
/* 1. å®šç¾©ä¸€å€‹é€šç”¨çš„ã€æ§åˆ¶æ‰€æœ‰ä¸»è¢å¹•æ–‡å­—é¡è‰²çš„è®Šæ•¸ (ä¿æŒä¸è®Š) */
#phone-screen {
    --home-icon-widget-text-color: #FFFFFF;
}

/* 2. ã€æ ¸å¿ƒã€‘å‰µå»ºä¸€å€‹â€œè¶…ç´šé¸æ“‡å™¨â€ï¼Œä¸€æ¬¡æ€§é¸ä¸­æ‰€æœ‰éœ€è¦è®Šè‰²çš„æ–‡å­— */
/* é€™æ¬¡æˆ‘å€‘åŠ å…¥äº†é ‚éƒ¨ç‹€æ…‹åˆ—å’Œåº•éƒ¨Dockæ¬„çš„åœ–ç¤ºæ–‡å­— */
.desktop-app-icon .label,                        /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤äº†å‰é¢çš„IDé™å®šï¼Œè®“å®ƒèƒ½åŒæ™‚é¸ä¸­ä¸»è¢å¹•å’ŒDockæ¬„çš„åœ–ç¤ºæ–‡å­— â–¼â–¼â–¼ */
#desktop-widget-column .widget-bubble,           
#desktop-widget-column .widget-subtext,        
#second-page-left-widget .widget-bubble,           
#second-page-left-widget .widget-subtext,        
#avatar-subtitle,                                
.corner-bubble,                                   
#new-custom-widget .new-widget-text,              
#widget-month-display,
#status-bar                                     /* â˜…â˜…â˜… æ–°å¢ï¼šé ‚éƒ¨ç‹€æ…‹åˆ— â˜…â˜…â˜… */
{
    color: var(--home-icon-widget-text-color) !important;
    text-shadow: 0 1px 4px rgba(0,0,0,0.6) 
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å»é™¤ä¸»è¢å¹•å­—å‹é™°å½±çš„æ¨£å¼ â–¼â–¼â–¼ */
#phone-screen.no-home-font-shadow .app-icon .label,
#phone-screen.no-home-font-shadow .desktop-app-icon .label,
#phone-screen.no-home-font-shadow .widget-bubble,
#phone-screen.no-home-font-shadow .widget-subtext,
#phone-screen.no-home-font-shadow #avatar-subtitle,
#phone-screen.no-home-font-shadow .corner-bubble,
#phone-screen.no-home-font-shadow .new-widget-text,
#phone-screen.no-home-font-shadow #widget-month-display,
#phone-screen.no-home-font-shadow #profile-username,
#phone-screen.no-home-font-shadow #profile-sub-username,
#phone-screen.no-home-font-shadow #profile-bio,
#phone-screen.no-home-font-shadow #profile-location,
#phone-screen.no-home-font-shadow #clock-container {
    text-shadow: none !important;
}
/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å¾®åšä¸»é é ­åƒæ¡†çš„å°ˆå±¬æ¨£å¼ â–¼â–¼â–¼ */
.weibo-avatar-container .weibo-avatar-frame{
    position: absolute;
    width: 121%; /* ç›¸å°å¤§å°ï¼Œä½ å¯ä»¥å¾®èª¿ */
    height: 121%;
    /* ä½¿ç”¨transformé€²è¡Œç²¾ç¢ºå®šä½ï¼Œç¢ºä¿å®Œç¾å±…ä¸­ */
    transform: translate(-50%, -57%);
    top: 50%;
    left: 50%;
    z-index: 4; /* ç¢ºä¿åœ¨é ­åƒä¹‹ä¸Š */
    pointer-events: none; /* è®“æ»‘é¼ äº‹ä»¶å¯ä»¥ç©¿é€å®ƒ */
}


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å¾®åšå¸–å­ä½œè€…é ­åƒæ¡†çš„å°ˆå±¬æ¨£å¼ â–¼â–¼â–¼ */

/* é€™æ˜¯å¸–å­é ­éƒ¨ï¼Œé ­åƒå’Œæ¡†çš„ç¸½å®¹å™¨ */
.weibo-post-header .avatar-with-frame {
    position: relative;
    /* æ ¸å¿ƒï¼šå°ºå¯¸å’ŒåŸä¾†çš„é ­åƒä¿æŒä¸€è‡´ */
    width: 40px;
    height: 40px;
    flex-shrink: 0;
}

/* å®¹å™¨å…§çš„é ­åƒåœ–ç‰‡ */
.weibo-post-header .avatar-with-frame .avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1; /* ç¢ºä¿åœ¨æ¡†çš„ä¸‹é¢ */
}

/* å®¹å™¨å…§çš„é ­åƒæ¡†åœ–ç‰‡ */
.weibo-post-header .avatar-with-frame .avatar-frame {
    position: absolute;
    width: 121%; /* ç›¸å°å¤§å°ï¼Œä½ å¯ä»¥å¾®èª¿ */
    height: 121%;
    /* ä½¿ç”¨transformé€²è¡Œç²¾ç¢ºå®šä½ï¼Œç¢ºä¿å®Œç¾å±…ä¸­ */
    transform: translate(-50%, -57%);
    top: 50%;
    left: 50%;
    z-index: 4; /* ç¢ºä¿åœ¨é ­åƒä¹‹ä¸Š */
    pointer-events: none; /* è®“æ»‘é¼ äº‹ä»¶å¯ä»¥ç©¿é€å®ƒ */
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ä¸»è¢å¹•é ­åƒæ¡†çš„å°ˆå±¬æ¨£å¼ â–¼â–¼â–¼ */
#profile-widget .profile-avatar-container .weibo-avatar-frame {
    position: absolute;
    width: 121%; /* ç›¸å°å¤§å°ï¼Œä½ å¯ä»¥å¾®èª¿ */
    height: 121%;
    /* ä½¿ç”¨transformé€²è¡Œç²¾ç¢ºå®šä½ï¼Œç¢ºä¿å®Œç¾å±…ä¸­ */
    transform: translate(-50%, -57%);
    top: 50%;
    left: 50%;
    z-index: 4; /* ç¢ºä¿åœ¨é ­åƒä¹‹ä¸Š */
    pointer-events: none; /* è®“æ»‘é¼ äº‹ä»¶å¯ä»¥ç©¿é€å®ƒ */
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ æŠŠé€™æ®µå…¨æ–°çš„CSSï¼Œé»è²¼åˆ°ä½  <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

.weibo-background {
    /* æ ¸å¿ƒä»£ç¢¼ï¼šä½¿ç”¨ mask-image å‰µå»ºä¸€å€‹å¾ä¸Šåˆ°ä¸‹çš„æ¼¸è®Šè’™ç‰ˆ */
    
    /* a. -webkit- é¦–ç¢¼æ˜¯ç‚ºäº†ç›¸å®¹èˆŠç‰ˆçš„ Chrome å’Œ Safari æµè¦½å™¨ */
    -webkit-mask-image: linear-gradient(
        to bottom,          /* æ¼¸è®Šæ–¹å‘ï¼šå¾ä¸Šåˆ°ä¸‹ */
        
        /* â˜…â˜…â˜… é€™è£¡æ˜¯ä½ å¯ä»¥è‡ªå·±èª¿æ•´çš„åœ°æ–¹ â˜…â˜…â˜… */
        black 60%,          /* å‰60%çš„éƒ¨åˆ†æ˜¯å®Œå…¨ä¸é€æ˜çš„ (é»‘è‰²=ä¸é€æ˜) */
        transparent 100%    /* å¾60%çš„ä½ç½®é–‹å§‹ï¼Œåˆ°åº•éƒ¨(100%)ï¼Œé€æ¼¸éæ¸¡åˆ°å®Œå…¨é€æ˜ */
    );
    
    /* b. é€™æ˜¯æ¨™æº–èªæ³•ï¼Œç›¸å®¹ç¾ä»£æµè¦½å™¨ */
    mask-image: linear-gradient(
        to bottom,
        black 60%,
        transparent 100%
    );
}

/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­åˆ†é¡æ¨™ç±¤æ¨£å¼ â–¼â–¼â–¼ */
.category-tag-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}
.category-tag {
    font-size: 11px;
    font-weight: 500;
    color: var(--accent-color);
    background-color: #e7f3ff;
    padding: 3px 8px;
    border-radius: 10px;
}
#phone-screen.dark-mode .category-tag {
    background-color: rgba(10, 132, 255, 0.2);
    color: #0A84FF;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­/å°çµ„åˆ†é¡ç¯©é¸åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* ç¯©é¸åœ–ç¤ºçš„æ¨£å¼ */
.header .filter-btn {
    font-size: 20px; /* åœ–ç¤ºå¤§å° */
    cursor: pointer;
    color: var(--accent-color); /* è·Ÿéš¨ä¸»é¡Œè‰² */
    position: relative; /* ç‚ºäº†å®šä½å°ç´…é» */
}

/* ç•¶ç¯©é¸ç”Ÿæ•ˆæ™‚ï¼Œåœ–ç¤ºä¸Šé¡¯ç¤ºä¸€å€‹å°é»æç¤º */
.header .filter-btn.active::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 8px;
    height: 8px;
    background-color: #ff3b30;
    border-radius: 50%;
    border: 1.5px solid var(--secondary-bg);
}

/* ç¯©é¸å½ˆçª—å…§çš„åˆ†é¡åˆ—è¡¨ */
#forum-filter-category-list {
    display: flex;
    flex-wrap: wrap; /* è‡ªå‹•æ›è¡Œ */
    gap: 10px; /* æ¨™ç±¤ä¹‹é–“çš„é–“è· */
    padding: 10px;
}

#forum-filter-category-list label {
    display: inline-flex;
    align-items: center;
    background-color: #f0f2f5;
    padding: 6px 12px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

#phone-screen.dark-mode #forum-filter-category-list label {
    background-color: #3a3a3c;
}

#forum-filter-category-list input[type="checkbox"] {
    display: none; /* éš±è—åŸå§‹çš„æ ¸å–æ–¹å¡Š */
}

/* é¸ä¸­å¾Œçš„æ¨£å¼ */
#forum-filter-category-list input[type="checkbox"]:checked + span {
    color: white;
    font-weight: 500;
}

/* é»˜èªçµ¦æ¨™ç±¤ä¸€å€‹å¥½çœ‹çš„é¡è‰²è¿´åœˆ */
#forum-filter-category-list label:nth-of-type(6n+1) input:checked + span { background-color: #007bff; }
#forum-filter-category-list label:nth-of-type(6n+2) input:checked + span { background-color: #28a745; }
#forum-filter-category-list label:nth-of-type(6n+3) input:checked + span { background-color: #fd7e14; }
#forum-filter-category-list label:nth-of-type(6n+4) input:checked + span { background-color: #6f42c1; }
#forum-filter-category-list label:nth-of-type(6n+5) input:checked + span { background-color: #dc3545; }
#forum-filter-category-list label:nth-of-type(6n+6) input:checked + span { background-color: #ffc107; }

/* æ¨™ç±¤å…§çš„æ–‡å­—éƒ¨åˆ†ï¼Œä¹Ÿéœ€è¦è¨­ç½®æ¨£å¼ï¼Œç‰¹åˆ¥æ˜¯é¸ä¸­å¾Œçš„èƒŒæ™¯è‰² */
#forum-filter-category-list label span {
    padding: 6px 12px;
    margin: -6px -12px; /* æŠµæ¶ˆlabelçš„paddingï¼Œè®“èƒŒæ™¯è‰²å¡«æ»¿ */
    border-radius: 15px;
    transition: all 0.2s ease;
}
/* â–²â–²â–² æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘éŠæˆ²å¤§å»³æ¨£å¼ â–¼â–¼â–¼ */
#game-hall-grid {
    display: grid;
    grid-template-columns: 1fr; /* æ¯è¡Œä¸€å€‹éŠæˆ² */
    gap: 15px; /* éŠæˆ²å¡ç‰‡ä¹‹é–“çš„é–“è· */
}

.game-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.game-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

.game-card .game-icon {
    font-size: 32px;
    width: 50px;
    height: 50px;
    flex-shrink: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #f0f2f5;
    border-radius: 10px;
}

#phone-screen.dark-mode .game-card .game-icon {
    background-color: #2c2c2e;
}

.game-card .game-info .game-title {
    font-weight: 600;
    font-size: 16px;
    color: var(--text-primary);
}

.game-card .game-info .game-desc {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 4px;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ®ºéŠæˆ²æ¨£å¼ â–¼â–¼â–¼ */

/* éŠæˆ²è¨­ç½®é çš„ç©å®¶é¸æ“‡åˆ—è¡¨ */
.player-selection-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
}
.player-selection-item:last-child {
    border-bottom: none;
}
.player-selection-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 15px;
}
.player-selection-item img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}
.player-selection-item .name {
    font-weight: 500;
}
.player-selection-item .type-tag {
    font-size: 11px;
    color: var(--text-secondary);
    background-color: #f0f0f0;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: auto;
}

/* éŠæˆ²ä¸»ä»‹é¢ä½ˆå±€ */
#werewolf-game-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    padding: 10px;
    box-sizing: border-box;
}

/* ç©å®¶åº§ä½ç¶²æ ¼ */
#werewolf-players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 10px;
    padding: 10px;
    flex-shrink: 0;
}

.player-seat {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.player-seat .player-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 3px solid transparent;
    object-fit: cover;
    transition: all 0.3s ease;
}
.player-seat .player-avatar.speaking {
    border-color: #4cd964; /* ç¶ è‰²é‚Šæ¡†è¡¨ç¤ºæ­£åœ¨ç™¼è¨€ */
    box-shadow: 0 0 10px #4cd964;
}
.player-seat .player-avatar.dead {
    filter: grayscale(100%);
    opacity: 0.5;
}
.player-seat .player-name {
    font-size: 12px;
    font-weight: 500;
    text-align: center;
    max-width: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.player-seat .player-role-indicator {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background-color: #ff3b30; /* ç´…è‰²ä»£è¡¨ç‹¼äºº */
    color: white;
    font-size: 12px;
    font-weight: bold;
    display: none; /* é»˜èªéš±è— */
    justify-content: center;
    align-items: center;
    border: 1px solid white;
}

/* éŠæˆ²æ—¥èªŒå€åŸŸ */
#werewolf-log-container {
    flex-grow: 1;
    background-color: rgba(0,0,0,0.05);
    border-radius: 10px;
    padding: 10px;
    overflow-y: auto;
    margin: 10px 0;
    min-height: 0; /* flexä½ˆå±€ä¸‹æ»¾å‹•çš„é—œéµ */
}
.log-entry {
    padding: 6px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    font-size: 14px;
    line-height: 1.5;
}
.log-entry.system {
    color: var(--accent-color);
    font-weight: bold;
    text-align: center;
    background-color: rgba(0, 123, 255, 0.05);
    border-radius: 5px;
}
.log-entry.speech .speaker {
    font-weight: 600;
}

/* ç©å®¶æ“ä½œå€ */
#werewolf-action-area {
    flex-shrink: 0;
    padding: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    min-height: 50px;
}
#werewolf-action-area button {
    padding: 10px 20px;
}
#werewolf-action-area .vote-target-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
}
#werewolf-action-area .vote-target-btn {
    padding: 8px 12px;
    font-size: 13px;
    background-color: #e9ecef;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}
#werewolf-action-area .vote-target-btn.selected {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}
/* â–²â–²â–² ç‹¼äººæ®ºæ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ®ºç™¼è¨€æ—¥èªŒç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */

/* åŒ…å«é ­åƒå’Œæ–‡å­—çš„ç¸½å®¹å™¨ */
.log-entry.speech {
    display: flex;
    align-items: flex-start; /* é ‚éƒ¨å°é½Š */
    gap: 10px;               /* é ­åƒå’Œæ–‡å­—çš„é–“è· */
    padding: 8px 6px;
    border-bottom: 1px solid rgba(0,0,0,0.05); /* æ¯æ¢ç™¼è¨€ä¹‹é–“çš„åˆ†å‰²ç·š */
}

/* ç™¼è¨€è€…çš„åœ“å½¢å°é ­åƒ */
.speech-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%; /* å®Œç¾åœ“å½¢ */
    flex-shrink: 0;     /* é˜²æ­¢é ­åƒè¢«å£“ç¸® */
    object-fit: cover;
}

/* åŒ…è£¹åå­—å’Œç™¼è¨€å…§å®¹çš„æ–°å®¹å™¨ */
.speech-content {
    display: flex;
    flex-direction: column; /* åå­—å’Œå…§å®¹å‚ç›´æ’åˆ— */
    gap: 2px;
}

/* ç™¼è¨€è€…åå­—çš„æ¨£å¼ */
.speech-content .speaker {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¡è‰²ï¼Œä¸é‚£éº¼åˆºçœ¼ */
}

/* ç™¼è¨€å…§å®¹çš„æ¨£å¼ */
.speech-content .speech-text {
    word-break: break-word; /* ç¢ºä¿é•·ç¯‡ç™¼è¨€èƒ½æ­£ç¢ºæ›è¡Œ */
    line-height: 1.6;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */



/* â–¼â–¼â–¼ ã€é€™æ˜¯ç‚ºä½ æ–°å¢çš„Xç¤¾äº¤Appåœ–ç¤ºæ¨£å¼ã€‘é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
#second-page-x-social-app {
    position: absolute;
    /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ã€‚æˆ‘æŠŠå€¼èª¿å¤§äº†ï¼Œè®“å®ƒæ›´é ä¸‹ï¼Œå’Œâ€œåœˆå­â€åœ–ç¤ºå°é½Š */
    top: 100px;  /* â˜… ä¿®æ”¹é€™è£¡ â˜… */
    
    /* æ§åˆ¶å·¦å³ä½ç½®ã€‚æˆ‘æŠŠå€¼èª¿å°äº†ï¼Œè®“å®ƒæ›´é å³ï¼Œå’Œâ€œæƒ…ä¾¶ç©ºé–“â€åœ–ç¤ºå°é½Š */
    right: 0px; /* â˜… ä¿®æ”¹é€™è£¡ â˜… */
}

/* æŠŠæ–°åœ–ç¤ºçš„æ–‡å­—ä¹Ÿè®Šæˆç™½è‰²ï¼Œå’Œå…¶ä»–åœ–ç¤ºçµ±ä¸€ */
#second-page-x-social-app .label {
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}
/* â–²â–²â–² æ–°å¢æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾œæ¹¯éŠæˆ²æ¨£å¼ â–¼â–¼â–¼ */

.sts-log-entry {
    padding: 8px 10px;
    margin-bottom: 8px;
    border-radius: 8px;
    line-height: 1.6;
}

/* ç³»çµ±æ¶ˆæ¯ (è¬é¢ã€æç¤ºç­‰) */
.sts-log-entry.system {
    background-color: #e9ecef;
    color: var(--text-secondary);
    text-align: center;
    font-weight: 500;
}
#phone-screen.dark-mode .sts-log-entry.system {
    background-color: #2c2c2e;
}

/* ç©å®¶æå• */
.sts-log-entry.question {
    background-color: #fff;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .sts-log-entry.question {
    background-color: #1c1c1e;
}
.sts-log-entry .speaker {
    font-weight: 600;
    color: var(--accent-color);
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾œæ¹¯ - å‡ºé¡Œäººå›ç­”æ°£æ³¡ç¾åŒ– â–¼â–¼â–¼ */
.sts-log-entry.answer {
    text-align: right;
}
.sts-log-entry.answer .answer-text {
    display: inline-block;
    padding: 8px 12px; /* å¢åŠ å…§é‚Šè·ï¼Œè®“æ°£æ³¡æ›´é£½æ»¿ */
    border-radius: 18px; /* å¢åŠ åœ“è§’ */
    font-weight: 500; /* å­—é«”ä¸ç”¨å¤ªç²— */
    background-color: #f0f2f5; /* çµ±ä¸€çš„ã€ä¸­æ€§çš„æ·ºç°è‰²èƒŒæ™¯ */
    color: var(--text-primary); /* æ–‡å­—é¡è‰²ä½¿ç”¨ä¸»é¡Œçš„ä¸»è‰²ï¼Œé©é…å¤œé–“æ¨¡å¼ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.08); /* ç¨å¾®èª¿æ•´é™°å½± */
}

/* ç§»é™¤èˆŠçš„ã€æŒ‰é¡è‰²å€åˆ†çš„æ¨£å¼ï¼Œç¢ºä¿æ‰€æœ‰å›ç­”éƒ½ç”¨ä¸Šé¢çš„æ–°æ¨£å¼ */
.sts-log-entry.answer .answer-text.yes,
.sts-log-entry.answer .answer-text.no,
.sts-log-entry.answer .answer-text.irrelevant {
    background-color: #f0f2f5; /* ç¢ºä¿æ‰€æœ‰éƒ½ç”¨é€™å€‹é¡è‰² */
}

/* å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode .sts-log-entry.answer .answer-text,
#phone-screen.dark-mode .sts-log-entry.answer .answer-text.yes,
#phone-screen.dark-mode .sts-log-entry.answer .answer-text.no,
#phone-screen.dark-mode .sts-log-entry.answer .answer-text.irrelevant {
     background-color: #3a3a3c; /* å¤œé–“æ¨¡å¼ä¸‹çš„æ·±ç°è‰² */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


/* AIçŒœæ¸¬ */
.sts-log-entry.guess {
    font-style: italic;
    color: #fd7e14;
    border-left: 3px solid #fd7e14;
    padding-left: 12px;
}

/* ç©å®¶åº§ä½ä¸Šçš„èº«ä»½æŒ‡ç¤ºå™¨ */
.player-seat .player-role-indicator.riddle-master {
    background-color: #ffc107; /* é»ƒè‰²ä»£è¡¨å‡ºé¡Œäºº */
    display: flex;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾œæ¹¯èŠå¤©æ—¥èªŒç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */
.sts-log-entry.question,
.sts-log-entry.answer,
.sts-log-entry.guess {
    display: flex;
    align-items: flex-start; /* é ­åƒå’Œæ°£æ³¡é ‚éƒ¨å°é½Š */
    gap: 10px;
    max-width: 85%;
    margin-bottom: 12px;
}

/* æå•å’ŒçŒœæ¸¬é å·¦ */
.sts-log-entry.question,
.sts-log-entry.guess {
    align-self: flex-start;
}

/* å›ç­”é å³ */
.sts-log-entry.answer {
    align-self: flex-end;
    flex-direction: row-reverse; /* é—œéµï¼šè®“é ­åƒåœ¨å³é‚Š */
}

/* é ­åƒæ¨£å¼ */
.sts-log-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾œæ¹¯èŠå¤©æ—¥èªŒç¾åŒ–æ¨£å¼ (æ°£æ³¡é€æ˜ç‰ˆ) â–¼â–¼â–¼ */
.sts-log-entry.question .sts-log-content,
.sts-log-entry.guess .sts-log-content {
    background-color: transparent; /* <-- ä¿®æ”¹é»1ï¼šèƒŒæ™¯æ”¹ç‚ºé€æ˜ */
    border-radius: 8px;
    padding: 8px 12px;
    border: none; /* <-- ä¿®æ”¹é»2ï¼šç§»é™¤é‚Šæ¡†ï¼Œè®“å®ƒå¾¹åº•â€œæ¶ˆå¤±â€ */
}

#phone-screen.dark-mode .sts-log-entry.question .sts-log-content,
#phone-screen.dark-mode .sts-log-entry.guess .sts-log-content {
    background-color: #1c1c1e;
}

/* ä¿®æ­£å›ç­”æ°£æ³¡çš„æ¨£å¼ï¼Œå› ç‚ºå®ƒä¸æ˜¯ä¸€å€‹å®Œæ•´çš„å¡Š */
.sts-log-entry.answer .answer-text {
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
.player-seat .player-avatar.active-turn {
    border-color: #007bff; /* ä½¿ç”¨ä¸»é¡Œè‰²ä½œç‚ºé‚Šæ¡†é¡è‰² */
    box-shadow: 0 0 15px rgba(0, 123, 255, 0.7); /* æ·»åŠ ç™¼å…‰æ•ˆæœ */
    animation: sts-pulse-glow 1.5s infinite ease-in-out; /* æ‡‰ç”¨å‹•ç•« */
}

@keyframes sts-pulse-glow {
    0%, 100% {
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.7);
    }
    50% {
        box-shadow: 0 0 25px rgba(0, 123, 255, 1);
    }
}
/* â–¼â–¼â–¼ ã€æµ·é¾œæ¹¯ä½ˆå±€ä¿®å¾©ã€‘è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
#sts-game-log {
    display: flex;
    flex-direction: column;
}
/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾œæ¹¯èŠå¤©æ—¥èªŒç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */
.sts-log-entry.question,
.sts-log-entry.answer,
.sts-log-entry.guess {
    display: flex;
    align-items: flex-start; /* é ­åƒå’Œæ°£æ³¡é ‚éƒ¨å°é½Š */
    gap: 10px;
    max-width: 85%;
    margin-bottom: 12px;
    /* ç§»é™¤èˆŠçš„èƒŒæ™¯å’Œé‚Šæ¡†ï¼Œå› ç‚ºç¾åœ¨ç”±å­å…ƒç´ è™•ç† */
    background-color: transparent;
    border: none;
}

/* æå•å’ŒçŒœæ¸¬ï¼ˆçŒœé¡Œæ–¹ï¼‰é å·¦ */
.sts-log-entry.question,
.sts-log-entry.guess {
    align-self: flex-start;
}

/* å›ç­”ï¼ˆå‡ºé¡Œäººï¼‰é å³ */
.sts-log-entry.answer {
    align-self: flex-end;
    flex-direction: row-reverse; /* é—œéµï¼šè®“é ­åƒåœ¨å³é‚Š */
}

/* é ­åƒæ¨£å¼ */
.sts-log-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

/* åŒ…å«ç™¼è¨€äººå’Œå…§å®¹çš„æ°£æ³¡ */
.sts-log-entry.question .sts-log-content,
.sts-log-entry.guess .sts-log-content {
    background-color: #fff;
    border-radius: 8px;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
}

#phone-screen.dark-mode .sts-log-entry.question .sts-log-content,
#phone-screen.dark-mode .sts-log-entry.guess .sts-log-content {
    background-color: #1c1c1e;
}

/* ä¿®æ­£å›ç­”æ°£æ³¡çš„æ¨£å¼ï¼Œå› ç‚ºå®ƒä¸æ˜¯ä¸€å€‹å®Œæ•´çš„å¡Š */
.sts-log-entry.answer .answer-text {
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* è®“æ—¥èªŒå®¹å™¨æ”¯æ´flexä½ˆå±€çš„å°é½Š */
#sts-game-log {
    display: flex;
    flex-direction: column;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æµ·é¾œæ¹¯è¼¸å…¥å€çµ‚æ¥µä¿®å¾©ç‰ˆã€‘ â–¼â–¼â–¼ */

/* 1. å¼·åˆ¶é‡ç½®æ•´å€‹è¼¸å…¥å€åŸŸçš„ä½ˆå±€ç‚ºâ€œæ©«å‘æ’åˆ—â€ä¸¦â€œå‚ç›´å±…ä¸­â€ */
#sts-action-area {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important; /* æ ¸å¿ƒä¿®æ­£ï¼šå¾ flex-end æ”¹ç‚º centerï¼Œå¯¦ç¾å‚ç›´å±…ä¸­ */
    gap: 8px !important;
}

/* 2. å¼·åˆ¶å…§éƒ¨çš„ main-row ä¹Ÿå‚ç›´å±…ä¸­ï¼Œä¸¦è®“å®ƒå¡«æ»¿ç©ºé–“ */
#sts-action-area .chat-input-main-row {
    flex-grow: 1 !important;
    display: flex !important;
    align-items: center !important; /* æ ¸å¿ƒä¿®æ­£ï¼šå…§éƒ¨ä¹Ÿä¿æŒå‚ç›´å±…ä¸­ */
    gap: 8px !important;
}

/* 3. ç¾åŒ–è¼¸å…¥æ¡†æœ¬èº«ï¼Œä¸¦è®“å®ƒè‡ªå‹•æ’æ»¿å¯¬åº¦ */
#sts-action-area #sts-question-input {
    flex-grow: 1; 
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px; 
    line-height: 1.5;
}

/* 4. çµ±ä¸€æ‰€æœ‰æŒ‰éˆ•çš„é«˜åº¦å’Œæ¨£å¼ï¼Œè®“å®ƒå€‘å’Œè¼¸å…¥æ¡†å®Œç¾é©é… */
#sts-action-area #guess-sts-answer-btn,
#sts-action-area #send-sts-question-btn {
    height: 40px; 
    border-radius: 20px;
    padding: 0 15px;
    flex-shrink: 0;
    font-size: 14px;
    font-weight: 600;
}

/* 5. å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode #sts-action-area #sts-question-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
}
/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åŠ‡æœ¬æ®ºéŠæˆ²æ¨£å¼ â–¼â–¼â–¼ */

/* éŠæˆ²ä¸»ä»‹é¢ä½ˆå±€ */
#script-kill-game-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    padding: 10px;
    box-sizing: border-box;
}

/* ç©å®¶åº§ä½å€ (è¤‡ç”¨ç‹¼äººæ®ºçš„æ¨£å¼) */
#script-kill-players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 10px;
    padding: 10px;
    flex-shrink: 0;
}

/* éŠæˆ²æ—¥èªŒå€ (è¤‡ç”¨ç‹¼äººæ®ºçš„æ¨£å¼) */
#script-kill-log-container {
    flex-grow: 1;
    background-color: rgba(0,0,0,0.05);
    border-radius: 10px;
    padding: 10px;
    overflow-y: auto;
    margin: 10px 0;
    min-height: 0; /* flexä½ˆå±€ä¸‹æ»¾å‹•çš„é—œéµ */
}

/* ç©å®¶æ“ä½œå€ (è¤‡ç”¨ç‹¼äººæ®ºçš„æ¨£å¼) */
#script-kill-action-area {
    flex-shrink: 0;
    padding: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    min-height: 50px;
}
#script-kill-action-area button {
    padding: 10px 20px;
}

/* æŠ•ç¥¨é¸é …æ¨£å¼ */
#sk-vote-options-list label {
    display: block;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
}
#sk-vote-options-list label:hover {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #sk-vote-options-list label:hover {
    background-color: #2c2c2e;
}

/* ç·šç´¢å¡ç‰‡æ¨£å¼ */
.sk-evidence-card {
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.sk-evidence-card .source {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}
.sk-evidence-card .description {
    font-size: 14px;
    line-height: 1.6;
}

/* â–²â–²â–² åŠ‡æœ¬æ®ºæ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* ã€å…¨æ–°ã€‘åŠ‡æœ¬æ®ºè¦–è¦ºåŒ–ç·¨è¼¯å™¨æ¨£å¼ */

/* è§’è‰²/ç·šç´¢å¡ç‰‡çš„å®¹å™¨ */
.sk-item-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    background-color: #f0f2f5;
    padding: 10px;
    border-radius: 8px;
    min-height: 50px;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .sk-item-container {
    background-color: #2c2c2e;
}

/* å–®å€‹è§’è‰²/ç·šç´¢çš„å¡ç‰‡ */
.sk-editor-item {
    background-color: var(--secondary-bg);
    padding: 10px 15px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sk-editor-item .item-info .item-name {
    font-weight: 600;
}
.sk-editor-item .item-info .item-meta {
    font-size: 12px;
    color: var(--text-secondary);
}

/* å¡ç‰‡ä¸Šçš„ç·¨è¼¯/åˆªé™¤æŒ‰éˆ• */
.sk-editor-item .item-actions {
    display: flex;
    gap: 8px;
}
.sk-editor-item .item-actions button {
    padding: 4px 8px;
    font-size: 13px;
    border-radius: 5px;
    cursor: pointer;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²æ¨£å¼ â–¼â–¼â–¼ */

/* éŠæˆ²æ—¥èªŒå€åŸŸ */
#guess-what-game-log {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* å–®æ¢æ—¥èªŒæ¢ç›® */
.guess-log-entry {
    padding: 8px 12px;
    border-radius: 12px;
    line-height: 1.6;
    max-width: 90%;
    word-break: break-word;
}

/* ç³»çµ±æç¤ºï¼Œä¾‹å¦‚éŠæˆ²é–‹å§‹ã€èª°çš„å›åˆ */
.guess-log-entry.system {
    background-color: #e9ecef;
    color: var(--text-secondary);
    text-align: center;
    font-weight: 500;
    font-size: 13px;
    align-self: center;
}
#phone-screen.dark-mode .guess-log-entry.system {
    background-color: #2c2c2e;
}

/* ç©å®¶ç™¼è¨€çš„æ°£æ³¡ï¼ˆé€šç”¨ï¼‰ */
.guess-log-entry.user-turn,
.guess-log-entry.ai-turn {
    display: flex;
    gap: 10px;
    align-items: flex-start;
}

/* ç©å®¶ç™¼è¨€å…§å®¹ */
.guess-log-entry .bubble {
    background-color: #fff;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .guess-log-entry .bubble {
    background-color: #2c2c2e;
}

/* AIç™¼è¨€æ°£æ³¡ï¼ˆé å·¦ï¼‰ */
.guess-log-entry.ai-turn {
    align-self: flex-start;
}

/* ç”¨æˆ¶ç™¼è¨€æ°£æ³¡ï¼ˆé å³ï¼‰ */
.guess-log-entry.user-turn {
    align-self: flex-end;
    flex-direction: row-reverse; /* é ­åƒåœ¨å³é‚Š */
}
.guess-log-entry.user-turn .bubble {
    background-color: #dcf8c6; /* é¡ä¼¼å¾®ä¿¡çš„ç¶ è‰² */
}
#phone-screen.dark-mode .guess-log-entry.user-turn .bubble {
    background-color: #3b5b32; /* å¤œé–“æ¨¡å¼ä¸‹çš„ç¶ è‰² */
}

/* æ°£æ³¡å…§çš„é ­åƒ */
.guess-log-entry .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
}

/* æ°£æ³¡å…§çš„åå­—å’Œå…§å®¹ */
.guess-log-entry .name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

/* éŠæˆ²è¼¸å…¥å€ç¾åŒ– */
#guess-what-action-area {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important; /* ä¿æŒå‚ç›´å±…ä¸­ */
    gap: 8px !important;
    width: 100%; /* æ–°å¢ï¼šè®“æ•´å€‹å®¹å™¨æ’æ»¿å¯¬åº¦ */
    box-sizing: border-box; /* æ–°å¢ï¼šç¢ºä¿å…§é‚Šè·å’Œé‚Šæ¡†è¢«æ­£ç¢ºè¨ˆç®—åœ¨å…§ */
}


#guess-what-action-area #guess-what-user-input {
    flex-grow: 1;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px;
    line-height: 1.5;
}
#guess-what-action-area #send-guess-what-input-btn {
    height: 40px;
    border-radius: 20px;
    padding: 0 15px;
    flex-shrink: 0;
    font-size: 14px;
    font-weight: 600;
}
#phone-screen.dark-mode #guess-what-action-area #guess-what-user-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
}

/* â–²â–²â–² â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€åŠ‡æœ¬æ®ºAIç”Ÿæˆå™¨ä½ˆå±€ä¿®å¾©ã€‘è«‹å°‡é€™æ•´å¡Šå…¨æ–°çš„CSSé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. ã€æ ¸å¿ƒã€‘è®“æ•´å€‹å½ˆçª—çš„å…§å®¹å€(modal-body)èƒ½å¤ æ­£ç¢ºåœ°æ’æ»¿å‰©é¤˜ç©ºé–“ä¸¦æ»¾å‹• */
#sk-ai-generator-modal .modal-body {
    flex-grow: 1;      /* å…è¨±å…§å®¹å€ä½”æ“š header å’Œ footer ä¹‹é–“çš„æ‰€æœ‰å¯ç”¨å‚ç›´ç©ºé–“ */
    min-height: 0;     /* è§£æ±ºflexä½ˆå±€ä¸­ä¸€å€‹å¸¸è¦‹çš„æ²è»¸å¤±æ•ˆå•é¡Œï¼Œéå¸¸é—œéµ */
    /* overflow-y: auto;  <-- é€™å€‹å±¬æ€§ä½ çš„ .modal-body å·²ç¶“æœ‰äº†ï¼Œæ‰€ä»¥ä¸ç”¨é‡è¤‡å¯« */
}

/* 2. ã€æ ¸å¿ƒã€‘æŒ‡å®šåŒ…å«â€œé è¦½æ¡†â€çš„é‚£å€‹ form-group ä¹Ÿéœ€è¦èƒ½å¤ å½ˆæ€§å¢é•· */
/* æˆ‘å€‘ç”¨ :last-of-type ç²¾å‡†å®šä½åˆ°æœ€å¾Œä¸€å€‹ .form-group */
#sk-ai-generator-modal .modal-body .form-group:last-of-type {
    flex-grow: 1;       /* è®“å®ƒåƒæ‰æ‰€æœ‰å‰©é¤˜çš„å‚ç›´ç©ºé–“ */
    min-height: 0;      /* åŒæ¨£æ˜¯ç‚ºäº†ç›¸å®¹æ€§ */
    display: flex;        /* æŠŠå®ƒè‡ªå·±ä¹Ÿè®Šæˆflexå®¹å™¨ */
    flex-direction: column; /* è®“å®ƒè£¡é¢çš„ label å’Œ preview å‚ç›´æ’åˆ— */
}

/* 3. ã€æ ¸å¿ƒã€‘æœ€å¾Œï¼Œç¢ºä¿é è¦½æ¡†æœ¬èº«èƒ½å¤ æ’æ»¿å®ƒçš„çˆ¶å®¹å™¨ï¼Œä¸¦ä¸”åœ¨å…§å®¹éå¤šæ™‚è‡ªå·±æ»¾å‹• */
#sk-ai-result-preview {
    flex-grow: 1;      /* æ’æ»¿çˆ¶å®¹å™¨(.form-group)çš„ç©ºé–“ */
    overflow-y: auto;  /* ç•¶ä»£ç¢¼è¶…å‡ºæ™‚ï¼Œé¡¯ç¤ºå®ƒè‡ªå·±çš„æ²è»¸ï¼Œè€Œä¸æ˜¯è®“æ•´å€‹å½ˆçª—æ»¾å‹• */
    
    /* (å¯é¸ç¾åŒ–) çµ¦ä¸€å€‹æœ€å°é«˜åº¦ï¼Œé˜²æ­¢åœ¨æ²’å…§å®¹æ™‚å®Œå…¨å¡Œé™· */
    min-height: 100px; 
}

/* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€éŠæˆ²è¼¸å…¥å€çµ‚æ¥µä¿®å¾©ç‰ˆã€‘ â–¼â–¼â–¼ */

/* 1. å¼·åˆ¶é‡ç½®å…©å€‹éŠæˆ²è¼¸å…¥å€åŸŸçš„å®¹å™¨ä½ˆå±€ */
#sts-action-area,
#guess-what-action-area {
    display: flex !important;
    flex-direction: row !important; /* é—œéµï¼šå¾ç¸±å‘æ”¹ç‚ºæ©«å‘ */
    align-items: center !important;  /* é—œéµï¼šè®“æ‰€æœ‰å­å…ƒç´ å‚ç›´å±…ä¸­ */
    gap: 8px !important;            /* è¨­ç½®å…ƒç´ ä¹‹é–“çš„é–“è· */
    width: 100%;                     /* æ–°å¢ï¼šè®“æ•´å€‹å®¹å™¨å¯¬åº¦æ’æ»¿ */
    box-sizing: border-box;          /* æ–°å¢ï¼šç¢ºä¿å…§é‚Šè·å’Œé‚Šæ¡†è¢«æ­£ç¢ºè¨ˆç®— */
}

/* 2. å¼·åˆ¶å…§éƒ¨çš„ .chat-input-main-row ä¹Ÿèƒ½æ­£ç¢ºä¼¸å±•å’Œå°é½Š */
#sts-action-area .chat-input-main-row,
#guess-what-action-area .chat-input-main-row {
    flex-grow: 1 !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
}

/* 3. ç¾åŒ–è¼¸å…¥æ¡†æœ¬èº«ï¼Œä¸¦è®“å®ƒè‡ªå‹•æ’æ»¿å¯¬åº¦ */
#sts-action-area #sts-question-input,
#guess-what-action-area #guess-what-user-input {
    flex-grow: 1; /* æ ¸å¿ƒï¼šè®“è¼¸å…¥æ¡†è‡ªå‹•ä¼¸å±•ï¼Œå æ»¿æ‰€æœ‰å¯ç”¨å¯¬åº¦ */
    min-height: 40px; /* ä¿è­‰æœ€å°é«˜åº¦ */
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px;
    line-height: 1.5;
    box-sizing: border-box;
}

/* 4. çµ±ä¸€æ‰€æœ‰æŒ‰éˆ•çš„é«˜åº¦å’Œæ¨£å¼ï¼Œè®“å®ƒå€‘å’Œè¼¸å…¥æ¡†å®Œç¾é©é… */
#sts-action-area button,
#guess-what-action-area button {
    height: 40px; 
    border-radius: 20px;
    padding: 0 15px;
    flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¢«å£“ç¸® */
    font-size: 14px;
    font-weight: 600;
}

/* 5. å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode #sts-action-area #sts-question-input,
#phone-screen.dark-mode #guess-what-action-area #guess-what-user-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
}
/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* === ã€ç¨å®¶å®šåˆ¶ã€‘éš±è—éŠæˆ²å¤§å»³è¿”å›æŒ‰éˆ•çš„ "é€€å‡º" æ–‡å­— === */
#exit-werewolf-game-btn,
#exit-sts-game-btn,
#exit-script-kill-game-btn,
#exit-guess-what-game-btn,
#exit-ludo-game-btn { /* <--- ä¿®æ”¹åœ¨é€™è£¡ */
    font-size: 0 !important;
    color: transparent !important;
}

#exit-werewolf-game-btn::before,
#exit-sts-game-btn::before,
#exit-script-kill-game-btn::before,
#exit-guess-what-game-btn::before,
#exit-ludo-game-btn::before { /* <--- é‚„æœ‰é€™è£¡ */
    content: 'â€¹';
    font-size: 24px !important;
    color: var(--accent-color) !important;
}
/* â–¼â–¼â–¼ ã€V2å‡ç´šç‰ˆã€‘éŠæˆ²ç™¼è¨€è¼¸å…¥å€é€šç”¨ç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“å…©å€‹éŠæˆ²çš„ç™¼è¨€å€åŸŸå®¹å™¨éƒ½è®Šæˆæ©«å‘æ’åˆ—çš„Flexä½ˆå±€ */
#werewolf-action-area.speaking-mode,
#script-kill-action-area.speaking-mode {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 0;
}

/* 2. ç¾åŒ–å…©å€‹éŠæˆ²çš„ç™¼è¨€è¼¸å…¥æ¡† */
#werewolf-action-area.speaking-mode #user-speech-input,
#script-kill-action-area.speaking-mode #user-sk-speech-input {
    flex-grow: 1;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px;
    line-height: 1.5;
    width: auto !important; 
    height: auto !important;
}

/* 3. ç¾åŒ–å…©å€‹éŠæˆ²çš„â€œçµæŸç™¼è¨€â€æŒ‰éˆ• */
#werewolf-action-area.speaking-mode #end-speech-btn,
#script-kill-action-area.speaking-mode #sk-end-speech-btn {
    height: 40px;
    border-radius: 20px;
    padding: 0 15px;
    flex-shrink: 0;
    font-size: 14px;
    font-weight: 600;
    margin: 0 !important; 
    width: auto !important;
    background-color: var(--accent-color);
    color: white;
    border: none;
}

/* 4. å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode #werewolf-action-area.speaking-mode #user-speech-input,
#phone-screen.dark-mode #script-kill-action-area.speaking-mode #user-sk-speech-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
}

/* â–²â–²â–² å‡ç´šç‰ˆæ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯µç‰©åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

#chat-pet {
    transition: transform 0.2s ease-out; /* ç‚ºæ‹–å‹•æ·»åŠ ä¸€é»å¹³æ»‘éæ¸¡ */
}

#chat-pet:active {
    cursor: grabbing;
    transform: scale(1.1); /* æ‹–å‹•æ™‚ç¨å¾®æ”¾å¤§ï¼Œçµ¦ç”¨æˆ¶å›é¥‹ */
    filter: brightness(0.9);
}

#chat-pet img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* è‡ªè¨‚åœ–ç‰‡ç­‰æ¯”ç¸®æ”¾ */
    -webkit-user-drag: none; /* é˜²æ­¢åœ–ç‰‡è¢«æ„å¤–æ‹–å‹• */
    user-drag: none;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯µç‰©æ•¸å€¼é¢æ¿æ¨£å¼ â–¼â–¼â–¼ */

#pet-stats-area {
    display: flex;
    flex-direction: column;
    gap: 12px; /* æ¯å€‹æ•¸å€¼æ¢ä¹‹é–“çš„é–“è· */
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

#phone-screen.dark-mode #pet-stats-area {
    background-color: #2c2c2e;
}

.stat-bar-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.stat-bar-container .stat-label {
    width: 60px; /* å›ºå®šæ¨™ç±¤å¯¬åº¦ï¼Œè®“é€²åº¦æ¢å°é½Š */
    font-size: 14px;
    font-weight: 500;
    flex-shrink: 0;
}

.stat-bar {
    flex-grow: 1;
    height: 18px;
    background-color: #e9ecef;
    border-radius: 9px;
    overflow: hidden;
    position: relative;
}

#phone-screen.dark-mode .stat-bar {
    background-color: #3e3e42;
}

.stat-bar-fill {
    height: 100%;
    border-radius: 9px;
    transition: width 0.5s ease-in-out;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 10px;
    font-weight: bold;
    text-shadow: 0 0 2px rgba(0,0,0,0.5);
}

/* ç‚ºä¸åŒçš„æ•¸å€¼æ¢è¨­ç½®ä¸åŒçš„é¡è‰² */
#pet-hunger-bar .stat-bar-fill {
    background: linear-gradient(135deg, #fd7e14, #ffc107);
}
#pet-happiness-bar .stat-bar-fill {
    background: linear-gradient(135deg, #28a745, #20c997);
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯µç‰©è¦ªå¯†åº¦é€²åº¦æ¢é¡è‰² â–¼â–¼â–¼ */
#pet-intimacy-user-bar .stat-bar-fill {
    background: linear-gradient(135deg, #ff8fab, #ffc3a0); /* å°ä½ ï¼šæº«æš–çš„ç²‰æ©™è‰² */
}
#pet-intimacy-char-bar .stat-bar-fill {
    background: linear-gradient(135deg, #a1c4fd, #c2e9fb); /* å°Taï¼šæŸ”å’Œçš„å¤©è—è‰² */
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯µç‰©èŠå¤©ä»‹é¢æ¨£å¼ â–¼â–¼â–¼ */
#pet-chat-messages .message-wrapper {
    max-width: 85%;
}

#pet-chat-messages .message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

#pet-chat-messages .message-bubble .avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
}

#pet-chat-messages .message-bubble .content {
    padding: 8px 12px;
    border-radius: 10px;
    line-height: 1.5;
}

#pet-chat-messages .message-wrapper.user {
    align-self: flex-end;
}
#pet-chat-messages .message-wrapper.user .message-bubble {
    flex-direction: row-reverse;
}
#pet-chat-messages .message-wrapper.user .content {
    background-color: #dcf8c6;
}

#pet-chat-messages .message-wrapper.pet {
    align-self: flex-start;
}
#pet-chat-messages .message-wrapper.pet .content {
    background-color: #fff;
}

#phone-screen.dark-mode #pet-chat-messages {
    background-color: #000;
}
#phone-screen.dark-mode #pet-chat-messages .message-wrapper.user .content {
    background-color: #26491d;
}
#phone-screen.dark-mode #pet-chat-messages .message-wrapper.pet .content {
    background-color: #2c2c2e;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€ä½ˆå±€çµ‚æ¥µä¿®å¾©ã€‘ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›ä½ ä¸Šä¸€æ¬¡æ·»åŠ çš„å¯µç‰©èŠå¤©è¼¸å…¥æ¡†æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“å½ˆçª—å…§å®¹å€é©é…æ–°ä½ˆå±€ (ä¿æŒä¸è®Š) */
#pet-chat-modal .modal-content {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* 2. æ¶ˆæ¯å€åŸŸ (ä¿æŒä¸è®Š) */
#pet-chat-modal #pet-chat-messages {
    flex-grow: 1;
    min-height: 0;
    overflow-y: auto;
    padding: 20px 15px;
    background-color: #f0f2f5;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* 3. æ°£æ³¡æ¨£å¼ (ä¿æŒä¸è®Š) */
#pet-chat-modal .message-bubble .content { padding: 0; background: transparent; box-shadow: none; border: none; }
#pet-chat-modal .message-wrapper.user .content { background-color: #007AFF; color: white; padding: 10px 14px; border-radius: 18px 18px 4px 18px; max-width: 100%; }
#pet-chat-modal .message-wrapper.pet .content { background-color: #ffffff; color: #1c1c1e; padding: 10px 14px; border-radius: 18px 18px 18px 4px; max-width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

/* --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©å€åŸŸ â–¼â–¼â–¼ --- */

/* 4. é‡ç½®è¼¸å…¥å€åŸŸçš„èƒŒæ™¯å’Œé‚Šæ¡† (ä¿æŒä¸è®Š) */
#pet-chat-modal #pet-chat-input-area {
    border-top: 1px solid #e0e0e0;
    background-color: #f7f7f7;
    padding: 10px 12px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
}

/* 5. ã€æ ¸å¿ƒä¿®å¾©ã€‘è®“è¼¸å…¥æ¡†å’Œç™¼é€æŒ‰éˆ•çš„å®¹å™¨è®Šæˆ Flex ä½ˆå±€ */
#pet-chat-modal #pet-chat-input-area .chat-input-main-row {
    display: flex;           /* é—œéµï¼šè®“å…§éƒ¨å…ƒç´ æ©«å‘æ’åˆ— */
    align-items: center;     /* é—œéµï¼šè®“è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•å‚ç›´å±…ä¸­å°é½Šï¼Œå¯¦ç¾â€œå¹³è¡Œâ€ */
    gap: 8px;                /* è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•ä¹‹é–“çš„é–“è· */
}

/* 6. ç¾åŒ–è¼¸å…¥æ¡†ï¼Œä¸¦ã€è®“å®ƒæ’æ»¿å¯¬åº¦ã€‘ */
#pet-chat-modal #pet-chat-input {
    flex-grow: 1;            /* é—œéµï¼šè®“è¼¸å…¥æ¡†ä½”æ“šæ‰€æœ‰å‰©é¤˜çš„å¯¬åº¦ */
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 18px;
    padding: 8px 15px;
    line-height: 1.5;
    min-height: 38px;
    max-height: 100px;
    resize: none;            /* ç¦æ­¢ç”¨æˆ¶æ‰‹å‹•æ‹–æ‹½å¤§å° */
    box-sizing: border-box;  /* ç¢ºä¿paddingä¸æœƒæ’ç ´ä½ˆå±€ */
}

/* 7. ç¾åŒ–ç™¼é€æŒ‰éˆ•ï¼Œä¸¦å›ºå®šå…¶å¤§å° */
#pet-chat-modal #send-to-pet-btn {
    flex-shrink: 0;          /* é˜²æ­¢æŒ‰éˆ•è¢«å£“ç¸® */
    background-color: #007AFF;
    color: white;
    border: none;
    border-radius: 18px;
    height: 38px;
    padding: 0 20px;
    font-weight: 600;
    cursor: pointer;         /* æ»‘é¼ æ”¾ä¸Šå»æ™‚é¡¯ç¤ºå°æ‰‹ */
}

/* 8. å¤œé–“æ¨¡å¼é©é… (ä¿æŒä¸è®Š) */
#phone-screen.dark-mode #pet-chat-modal #pet-chat-messages { background-color: #000; }
#phone-screen.dark-mode #pet-chat-modal .message-wrapper.pet .content { background-color: #2c2c2e; }
#phone-screen.dark-mode #pet-chat-modal #pet-chat-input-area { background-color: #1c1c1e; border-top-color: #38383a; }
#phone-screen.dark-mode #pet-chat-modal #pet-chat-input { background-color: #2c2c2e; border-color: #38383a; color: white; }

/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æƒ…ç·’æ—¥è¨˜æ¨£å¼ --- */

/* æ—¥è¨˜è¦–åœ–ä¸»å®¹å™¨ */
#ls-diary-view {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* æ—¥æ›†å®¹å™¨ */
.ls-calendar-wrapper {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.ls-calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-size: 16px;
    font-weight: 600;
}

.ls-calendar-header button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--accent-color);
}

.ls-calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.ls-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}

.ls-calendar-day {
    aspect-ratio: 1 / 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
    padding-top: 4px;
}
.ls-calendar-day:hover {
    background-color: #f0f2f5;
}
.ls-calendar-day.empty {
    cursor: default;
    pointer-events: none;
}
.ls-calendar-day.today .day-number {
    background-color: var(--accent-color);
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    line-height: 22px;
}

.ls-calendar-day .day-number {
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 4px;
}

.ls-calendar-day .mood-emojis {
    display: flex;
    gap: 4px;
    font-size: 16px;
    position: absolute;
    bottom: 5px;
}

/* å¿ƒæƒ…ç½å­ */
.ls-mood-jar-wrapper {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    text-align: center;
}

.ls-mood-jar-wrapper h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
}

/* â–¼â–¼â–¼ ç”¨é€™å¡Šã€ä¿®å¾©å¾Œã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ .ls-mood-jar æ¨£å¼ â–¼â–¼â–¼ */
.ls-mood-jar {
    width: 100%;
    max-width: 100%;           /* â˜… æ ¸å¿ƒä¿®æ”¹1: ä½¿ç”¨max-widthé˜²æ­¢æº¢å‡º */
    box-sizing: border-box;    /* â˜… æ ¸å¿ƒä¿®æ”¹2: ç¢ºä¿paddingä¸æœƒå°è‡´å¯¬åº¦è¨ˆç®—éŒ¯èª¤ */
    min-height: 80px;
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-content: flex-start;
    justify-content: center;
    overflow: auto; /* â˜… æ ¸å¿ƒä¿®æ”¹3 (ä¿éšª): å¦‚æœå…§å®¹å¯¦åœ¨å¤ªå¤šï¼Œå°±ç”¨æ²è»¸å…œåº• */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


.ls-mood-jar .mood-emoji-item {
    font-size: 22px;
}

/* æ—¥è¨˜ç·¨è¼¯å½ˆçª— */
#ls-emoji-selector .emoji-option {
    padding: 5px;
    border-radius: 8px;
    transition: background-color 0.2s;
}
#ls-emoji-selector .emoji-option.selected {
    background-color: #e0e0e0;
    transform: scale(1.2);
}

/* æ—¥è¨˜æŸ¥çœ‹å½ˆçª— */
.ls-diary-entry-block {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid var(--accent-color);
}
.ls-diary-entry-block .entry-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
.ls-diary-entry-block .entry-header .mood-emoji {
    font-size: 32px;
}
.ls-diary-entry-block .entry-header .author {
    font-weight: 600;
    font-size: 16px;
}
.ls-diary-entry-block .entry-content {
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æ—¥è¨˜é€šçŸ¥å¡ç‰‡æ¨£å¼ --- */

/* 1. è®“åŒ…è£¹å¡ç‰‡çš„æ°£æ³¡æœ¬èº«è®Šé€æ˜ */
.message-bubble.is-ls-diary-notification .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* 2. å¡ç‰‡ä¸»é«”æ¨£å¼ */
.ls-diary-notification-card {
    width: 220px; /* å¡ç‰‡å¯¬åº¦ */
    background: linear-gradient(135deg, #fff5f8, #ffebee); /* æº«æŸ”çš„ç²‰è‰²æ¼¸è®ŠèƒŒæ™¯ */
    border-radius: 12px;
    padding: 15px;
    cursor: pointer;
    border: 1px solid #ffdde1; /* æ·¡æ·¡çš„ç²‰è‰²é‚Šæ¡† */
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden; /* éš±è—æº¢å‡ºçš„è£é£¾å…ƒç´  */
    transition: transform 0.2s, box-shadow 0.2s; /* æ·»åŠ é»æ“Šå‹•æ•ˆ */
}
.ls-diary-notification-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* 3. å¡ç‰‡å³ä¸Šè§’çš„è£é£¾æ€§åœ–ç¤º */
.ls-diary-notification-card::before {
    content: 'ğŸ’Œ';
    position: absolute;
    top: -5px;
    right: 10px;
    font-size: 30px;
    opacity: 0.1;
    transform: rotate(15deg);
}

/* 4. å¡ç‰‡é ­éƒ¨ï¼ˆåœ–ç¤ºå’Œæ¨™é¡Œï¼‰ */
.ls-diary-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 600;
    color: #c85c7c; /* ç¨æ·±çš„ç²‰è‰²ï¼Œä¿è­‰æ¸…æ™°åº¦ */
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(200, 92, 124, 0.2);
}

/* 5. å¡ç‰‡æ­£æ–‡ */
.ls-diary-card-body p {
    font-size: 14px;
    color: #5c474b; /* æ·±æ£•è‰²ï¼Œæ˜“æ–¼é–±è®€ */
    margin: 0 0 12px 0;
    line-height: 1.6;
}

/* 6. å¡ç‰‡åº•éƒ¨æç¤ºæ–‡å­— */
.ls-diary-card-footer {
    font-size: 12px;
    color: #c85c7c;
    text-align: right;
    font-weight: 500;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€ç¨å®¶å®šåˆ¶ã€‘å¯µç‰©äº’å‹•æŒ‰éˆ• 2x2 ç¶²æ ¼ä½ˆå±€ (æœ€çµ‚åŠ å¼·ç‰ˆ) â–¼â–¼â–¼ */

/* 1. ä½¿ç”¨ !important å¼·åˆ¶é–‹å•Ÿç¶²æ ¼ä½ˆå±€ï¼Œå°æŠ—æ¨£å¼è¡çª */
#pet-interaction-area {
    display: grid !important;        /* é—œéµï¼šå¼·åˆ¶ä½¿ç”¨ grid ä½ˆå±€ */
    grid-template-columns: 1fr 1fr;  /* å…©åˆ—ç¶²æ ¼ */
    gap: 10px;                       /* æŒ‰éˆ•é–“è· */
    max-width: 220px;                /* é©ç•¶æ”¾å¯¬æœ€å¤§å¯¬åº¦ï¼Œçµ¦æŒ‰éˆ•æ›´å¤šç©ºé–“ */
    margin: 15px auto !important;    /* å¼·åˆ¶å±…ä¸­ */
}

/* 2. èª¿æ•´æŒ‰éˆ•å°ºå¯¸ï¼Œä¸¦å¼·åˆ¶æ–‡å­—ä¸æ›è¡Œ */
#pet-interaction-area button {
    /* å°ºå¯¸å’Œæ–‡å­— */
    padding: 8px 12px;
    font-size: 14px;
    white-space: nowrap;             /* é—œéµï¼šå¼·åˆ¶æ–‡å­—åœ¨åŒä¸€è¡Œé¡¯ç¤ºï¼Œé˜²æ­¢æ›è¡Œ */
    
    /* å½¢ç‹€å’Œç¾åŒ– */
    border-radius: 18px;
    width: 100%;
    font-weight: 600;
    background-color: #f0f2f5;
    color: var(--accent-color);
    border: 1.5px solid var(--accent-color);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* 3. äº¤äº’æ•ˆæœä¿æŒä¸è®Š */
#pet-interaction-area button:hover {
    background-color: var(--accent-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

#pet-interaction-area button:active {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 1px 2px rgba(0,0,0,0.08);
}

/* â–²â–²â–² ç¾åŒ–æ¨£å¼çµæŸ â–²â–²â–² */


/* --- ã€æœ€çµ‚ç‰ˆã€‘æƒ…ä¾¶ç©ºé–“å³ä¸Šè§’æŒ‰éˆ•ç¾åŒ–èˆ‡ç¨ç«‹å¾®èª¿ --- */

/* 1. æ”¶ç·ŠæŒ‰éˆ•å®¹å™¨çš„æ•´é«”é–“è· */
#ls-header .header-actions {
    gap: 0px; /* â˜… ä¿®æ”¹é€™è£¡ï¼šå°‡æŒ‰éˆ•é–“çš„é–“è·æ¸›å°åˆ°0ï¼Œè®“å®ƒå€‘ç·ŠæŒ¨è‘— */
}

/* 2. ä¿æŒæŒ‰éˆ•çš„åŸºç¤æ¨£å¼ï¼ˆé€™éƒ¨åˆ†ä¸è®Šï¼‰ */
#ls-header .action-btn {
    padding: 8px; 
    border-radius: 50%;
    transition: background-color 0.2s;
}
#ls-header .action-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

/* 3. ã€æ ¸å¿ƒã€‘ç‚ºæ¯å€‹æŒ‰éˆ•æ·»åŠ ç¨ç«‹çš„å¾®èª¿åŠŸèƒ½ */

/* â€œè¨­ç½®â€æŒ‰éˆ•çš„ç¨ç«‹ä½ç½® */
#ls-settings-btn {
    position: relative; /* å•Ÿç”¨ç›¸å°å®šä½ï¼Œé€™æ˜¯å¾®èª¿çš„é—œéµ */
    top: 0px;           /* ã€èª¿ä¸Šä¸‹ã€‘: æ­£æ•¸å¾€ä¸‹ç§»ï¼Œè² æ•¸å¾€ä¸Šç§» */
    left: 40px;          /* ã€èª¿å·¦å³ã€‘: æ­£æ•¸å¾€å³ç§»ï¼Œè² æ•¸å¾€å·¦ç§» */
}

/* â€œæ›´æ›èƒŒæ™¯â€æŒ‰éˆ•çš„ç¨ç«‹ä½ç½® */
#ls-change-bg-btn {
    position: relative;
    top: 0px;          
    left: 30px;          
}

/* â€œåˆ‡æ›â€æŒ‰éˆ•çš„ç¨ç«‹ä½ç½® */
#ls-switch-char-btn {
    position: relative;
    top: -5px;
    left: 15px;
}

/* â–¼â–¼â–¼ ã€ç¨å®¶å®šåˆ¶ã€‘æƒ…ä¾¶ç©ºé–“å¿ƒå‹•éŸ³æ³¢åœ–ç¤º â–¼â–¼â–¼ */

/* 1. ç§»é™¤èˆŠçš„æ„›å¿ƒå­—å…ƒå’Œç™¼å…‰æ•ˆæœ */
.ls-header-avatars .heart-icon {
    font-size: 0; /* è®“'â¤'å­—å…ƒæ¶ˆå¤± */
    text-shadow: none; /* ç§»é™¤æ–‡å­—é™°å½± */
    
    /* 2. ç‚ºæ–°åœ–ç¤ºè¨­ç½®ä¸€å€‹å®¹å™¨å¤§å°ï¼Œæ‚¨å¯ä»¥æ ¹æ“šå–œå¥½å¾®èª¿ */
    width: 80px;
    height: 28px;
    
    /* 3. ã€æ ¸å¿ƒã€‘å°‡ä½ åœ–ç‰‡ä¸­çš„éŸ³æ³¢å¿ƒå‹•åœ–è¨­ç½®ç‚ºèƒŒæ™¯ */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='24' viewBox='0 0 80 24'%3E%3Cg fill='%23ff8fab'%3E%3Crect x='0' y='10' width='3' height='4' rx='1.5'/%3E%3Crect x='5' y='8' width='3' height='8' rx='1.5'/%3E%3Crect x='10' y='11' width='3' height='2' rx='1.5'/%3E%3Crect x='15' y='6' width='3' height='12' rx='1.5'/%3E%3Crect x='20' y='9' width='3' height='6' rx='1.5'/%3E%3Cpath transform='translate(25 0) scale(1.1)' d='M22 8.879c0-5.323-5.326-5.323-7.5-1.121C12.277 2.235 7 3.556 7 8.879 7 14.155 14.5 20 14.5 20S22 14.155 22 8.879z'/%3E%3Crect x='55' y='9' width='3' height='6' rx='1.5'/%3E%3Crect x='60' y='6' width='3' height='12' rx='1.5'/%3E%Crect x='65' y='11' width='3' height='2' rx='1.5'/%3E%3Crect x='70' y='8' width='3' height='8' rx='1.5'/%3E%3Crect x='75' y='10' width='3' height='4' rx='1.5'/%3E%3C/g%3E%3C/svg%3E");
    background-size: contain; /* ç¢ºä¿åœ–ç¤ºå®Œæ•´é¡¯ç¤º */
    background-repeat: no-repeat;
    background-position: center;
    
    /* 4. ï¼ˆå¯é¸ï¼‰å¾®èª¿å‚ç›´ä½ç½®ï¼Œè®“å®ƒå’Œé ­åƒæ›´å°é½Š */
    position: relative;
    top: -2px; 
}

/* â–²â–²â–² å®šåˆ¶æ¨£å¼çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ é€™æ˜¯ç‚ºä½ æ–°å¢çš„æ—¥æ›†å±…ä¸­ä¿®å¾©ä»£ç¢¼ â–¼â–¼â–¼ */

/* 1. å¼·åˆ¶è®“æ¯ä¸€å¤©çš„æ ¼å­å…§å®¹éƒ½ä¸è¦æº¢å‡ºï¼Œé¿å…äº’ç›¸å½±éŸ¿ */
.ls-calendar-day {
    overflow: hidden;
    text-align: center; /* å†æ¬¡å¼·èª¿æ–‡æœ¬å±…ä¸­ï¼Œæ›´ç©©å®š */
}

/* 2. ã€æ ¸å¿ƒä¿®å¾©ã€‘å°‡è—åœˆæœ¬èº«ä¹Ÿè®Šæˆä¸€å€‹flexå±…ä¸­å®¹å™¨ */
/* é€™èƒ½ç¢ºä¿è£¡é¢çš„æ•¸ä½ï¼Œç„¡è«–å¦‚ä½•éƒ½æœƒåœ¨åœˆåœˆçš„æ­£ä¸­é–“ */
.ls-calendar-day.today .day-number {
    display: flex;
    justify-content: center;
    align-items: center;
}

/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€ç¨å®¶å®šåˆ¶ã€‘æƒ…ä¾¶ç©ºé–“è¿”å›æŒ‰éˆ•ç¾åŒ– â–¼â–¼â–¼ */
#ls-header .back-btn {
    /* 1. æ ¸å¿ƒä¿®æ”¹ï¼šå°‡ç®­é ­é¡è‰²è¨­ç‚ºæ‚¨æƒ³è¦çš„ç™½è‰² */
    color: white;
    
    /* 2. çµ±ä¸€æ¨£å¼ï¼šè®“å®ƒå’Œåœˆå­è¿”å›æŒ‰éˆ•ä¸€æ¨£ï¼Œæ“æœ‰40x40pxçš„åœ“å½¢é»æ“Šå€åŸŸ */
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease;
    cursor: pointer;
}

/* 3. ç‚ºå®ƒæ·»åŠ èˆ‡å…¶ä»–æŒ‰éˆ•çµ±ä¸€çš„ã€æ¼‚äº®çš„æ‡¸åœæ•ˆæœ */
#ls-header .back-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}
/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¨˜æ†¶äº’é€šé¸æ“‡æ¡†ç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“æ¯å€‹é¸é …çš„æ¨™ç±¤(label)æˆç‚ºä¸€å€‹flexå®¹å™¨ */
.memory-link-option {
    display: flex;
    align-items: center; /* å‚ç›´å±…ä¸­å°é½Š */
    gap: 10px;           /* å…ƒç´ ä¹‹é–“çš„é–“è· */
    padding: 8px 12px !important;  /* å¢åŠ å…§é‚Šè·ï¼Œ!importantç¢ºä¿ç”Ÿæ•ˆ */
    cursor: pointer;
}

/* 2. å–®ç¨ç‚ºæ ¸å–æ–¹å¡Šè¨­ç½®æ¨£å¼ï¼Œé˜²æ­¢è¢«å…¨åŸŸæ¨£å¼å½±éŸ¿ */
.memory-link-option input[type="checkbox"] {
    width: 18px !important;  /* å›ºå®šå¯¬åº¦ */
    height: 18px !important; /* å›ºå®šé«˜åº¦ */
    margin: 0 !important;    /* ç§»é™¤å¤–é‚Šè· */
    flex-shrink: 0;          /* é˜²æ­¢è¢«å£“ç¸® */
}

/* 3. è¨­ç½®é ­åƒçš„æ¨£å¼ */
.memory-link-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%; /* åœ“å½¢é ­åƒ */
    object-fit: cover;  /* ä¿è­‰åœ–ç‰‡ä¸è®Šå½¢ */
    flex-shrink: 0;     /* é˜²æ­¢è¢«å£“ç¸® */
}

/* 4. è¨­ç½®åå­—çš„æ¨£å¼ */
.memory-link-name {
    /* é è¨­æ¨£å¼å³å¯ï¼Œå®ƒæœƒè‡ªå‹•å¡«å……å‰©é¤˜ç©ºé–“ */
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¨˜æ†¶äº’é€šé¸æ“‡æ¡†ç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */
#memory-link-checkboxes-container label {
    display: flex;           /* 1. ä½¿ç”¨Flexä½ˆå±€ï¼Œè®“é ­åƒå’Œæ–‡å­—æ©«å‘æ’åˆ— */
    align-items: center;     /* 2. å‚ç›´å±…ä¸­å°é½Š */
    gap: 10px;               /* 3. åœ¨é ­åƒã€æ ¸å–æ–¹å¡Šå’Œæ–‡å­—ä¹‹é–“å‰µå»ºé–“è· */
    padding: 10px 12px;      /* 4. å¢åŠ å…§é‚Šè·ï¼Œè®“æ¯ä¸€è¡Œæ›´é«˜ã€æ›´æ˜“æ–¼é»æ“Š */
    cursor: pointer;         /* 5. æ»‘é¼ æ”¾ä¸Šå»æ™‚é¡¯ç¤ºå°æ‰‹åœ–ç¤º */
    transition: background-color 0.2s; /* 6. æ·»åŠ æ‡¸åœæ•ˆæœ */
}

#memory-link-checkboxes-container label:hover {
    background-color: #f0f2f5; /* 7. æ»‘é¼ æ‡¸åœæ™‚çµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯è‰² */
}

#memory-link-checkboxes-container .avatar-preview {
    width: 30px;             /* 8. è¨­ç½®é ­åƒçš„å°ºå¯¸ */
    height: 30px;
    border-radius: 50%;      /* 9. åœ“å½¢é ­åƒ */
    object-fit: cover;       /* 10. ç¢ºä¿åœ–ç‰‡ä¸è®Šå½¢ */
    flex-shrink: 0;          /* 11. é˜²æ­¢é ­åƒåœ¨ç©ºé–“ä¸è¶³æ™‚è¢«å£“ç¸® */
}

#memory-link-checkboxes-container input[type="checkbox"] {
    /* 12. èª¿æ•´æ ¸å–æ–¹å¡Šçš„å¤§å°å’Œä½ç½®ï¼Œä½¿å…¶æ›´å”èª¿ */
    width: 18px;
    height: 18px;
    margin: 0;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V6 æœ€çµ‚ä¿®æ­£ç‰ˆã€‘å¿ƒè²é¢æ¿ï¼ˆé‚Šæ¡†å•é¡Œä¿®å¾©ï¼‰ â–¼â–¼â–¼ */

/* 1. åŸºç¤ä½ˆå±€ (ä¿æŒä¸è®Š) */
#inner-voice-modal .modal-body { position: relative; min-height: 450px; }
#inner-voice-avatar-wrapper,
#inner-voice-char-name,
#inner-voice-adopter-info { position: absolute; transition: all 0.3s ease; }

/* 2. è§’è‰²ä¸»é ­åƒçš„å®¹å™¨ï¼šåœ¨é€™è£¡æ·»åŠ  padding å’Œ background-color */
#inner-voice-avatar-wrapper {
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 65px;
    height: 65px;
    border-radius: 50%;
    
    /* --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼ --- */
    padding: 4px; /* â˜… æ–°å¢ï¼šå‘å…§æ“ å£“4åœ–å…ƒï¼Œç‚ºç´…ç·šç•™å‡ºç©ºé–“ã€‚ä½ å¯ä»¥è‡ªå·±èª¿æ•´é€™å€‹æ•¸å€¼ï¼Œæ¯”å¦‚3pxæˆ–5px */
    background-color: #fff; /* â˜… æ–°å¢ï¼šè®“å…§é‚Šè·çš„å€åŸŸé¡¯ç¤ºç‚ºç™½è‰²ï¼Œå½¢æˆä¸€å€‹â€œç™½ç’°â€ */
    box-sizing: border-box; /* â˜… æ–°å¢ï¼šç¢ºä¿paddingä¸æœƒæŠŠå®¹å™¨æ’å¤§ï¼Œé€™å¾ˆé‡è¦ */
    /* --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² --- */

    box-shadow: 0 0 0 1.5px transparent;
    transition: box-shadow 0.2s ease-in-out;
}

/* ç•¶éœ€è¦é¡¯ç¤ºé‚Šæ¡†æ™‚ï¼Œæ”¹è®Š box-shadow çš„é¡è‰² (å·²ä¿®æ”¹ç‚ºç²‰è‰²) */
#inner-voice-avatar-wrapper.has-border {
    box-shadow: 0 0 0 1.5px #ff8fab; /*  <-- å°±æ˜¯ä¿®æ”¹é€™è£¡ï¼*/
}


/* 4. ç§»é™¤ä¹‹å‰è£½é€ è¡çªçš„ ::after å½å…ƒç´  (ä¿æŒä¸è®Š) */
#inner-voice-avatar-wrapper::after {
    display: none;
}

/* è§’è‰²ä¸»é ­åƒçš„åœ–ç‰‡æ¨£å¼ï¼ˆä¿æŒä¸è®Šï¼‰ */
#inner-voice-avatar-wrapper #inner-voice-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: none; 
}

/* é ­åƒæ¡†çš„æ¨£å¼ï¼ˆä¿æŒä¸è®Šï¼‰ */
/* â–¼â–¼â–¼ ã€æœ€çµ‚å¾®èª¿ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰èˆŠçš„èŠå¤©å’Œå¿ƒè²é ­åƒæ¡†è¦å‰‡ â–¼â–¼â–¼ */

.avatar-with-frame .avatar-frame,
#inner-voice-avatar-frame {
    position: absolute;
    width: 110%;
    height: 115%;
    transform: translate(-50%, -56%);
    top: 50%;
    left: 50%;
    z-index: 2;
    pointer-events: none;
}


/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */


/* 5. è§’è‰²åå­—å’Œé ˜é¤Šäººè³‡è¨Šçš„ä½ç½® (ä¿æŒä¸è®Š) */
#inner-voice-char-name {
    top: 95px; left: 50%; transform: translateX(-50%); font-weight: 600; font-size: 16px; color: #333; text-align: center;
}
#inner-voice-adopter-info {
    top: 125px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 8px; font-size: 13px; color: #666;
}
#inner-voice-adopter-info img { width: 24px; height: 24px; border-radius: 50%; }

/* 6. å…§å®¹å€è·é›¢ (ä¿æŒä¸è®Š) */
#inner-voice-content-area { margin-top: 165px; }

/* 7. å¡ç‰‡å’Œæ¨™é¡Œçš„æ¨£å¼ (ä¿æŒä¸è®Š) */
#inner-voice-content-area > div { background-color: rgba(255, 255, 255, 0.7); border-radius: 16px; padding: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
#inner-voice-content-area strong { padding: 3px 10px; border-radius: 12px; color: white !important; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
#inner-voice-content-area div:nth-of-type(1) strong { background-color: #f0a1a8; }
#inner-voice-content-area div:nth-of-type(2) strong { background-color: #81c784; }
#inner-voice-content-area div:nth-of-type(3) strong { background-color: #64b5f6; }
#inner-voice-content-area div:nth-of-type(4) strong { background-color: #ba68c8; }

/* â–²â–²â–² å®šåˆ¶æ¨£å¼çµæŸ â–²â–²â–² */

/*
  ã€ç¨å®¶å®šåˆ¶ã€‘å–®ç¨ä¿®æ”¹å¿ƒè²é ­åƒæ¡†çš„å¤§å°å’Œä½ç½®
  ä½¿ç”¨èªªæ˜ï¼š
  1. å°‡ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼é»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ã€‚
  2. ä¿®æ”¹ä¸‹é¢çš„ width, height, top, left çš„æ•¸å€¼ä¾†èª¿æ•´é ­åƒæ¡†ã€‚
*/
#inner-voice-avatar-frame {
    /*
     * æ§åˆ¶å¤§å°ï¼šæ•¸å€¼è¶Šå¤§ï¼Œé ­åƒæ¡†è¶Šå¤§ã€‚
     * ä¾‹å¦‚ï¼š120% (æ¯”åŸä¾†å°), 150% (æ¯”åŸä¾†å¤§)
     */
    width: 100%; 
    height: 100%; 

    /*
     * æ§åˆ¶ä½ç½®ï¼šä»¥é ­åƒä¸­å¿ƒç‚ºåŸé» (50%, 50%) é€²è¡Œå¾®èª¿
     */

    /* æ§åˆ¶ã€ä¸Šä¸‹ã€‘ä½ç½®ï¼šå°æ–¼50%å‰‡ä¸Šç§»ï¼Œå¤§æ–¼50%å‰‡ä¸‹ç§» */
    top: 43%; /* ç¤ºä¾‹ï¼šç¨å¾®å‘ä¸Šç§»å‹•äº†ä¸€é» */

    /* æ§åˆ¶ã€å·¦å³ã€‘ä½ç½®ï¼šå°æ–¼50%å‰‡å·¦ç§»ï¼Œå¤§æ–¼50%å‰‡å³ç§» */
    left: 50%; /* ç¤ºä¾‹ï¼šä¿æŒæ°´æº–å±…ä¸­ */
    
    /* 
      ä»¥ä¸‹ç‚ºä¿æŒå±…ä¸­å’Œé¡¯ç¤ºæ•ˆæœå¿…é ˆçš„å±¬æ€§ï¼Œè«‹å‹¿ä¿®æ”¹ 
    */
    position: absolute;
    transform: translate(-50%, -50%);
    z-index: 2;
    pointer-events: none;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å¾®åšç§ä¿¡åŠŸèƒ½çš„æ‰€æœ‰æ–°æ¨£å¼ï¼Œè«‹é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* --- ç§ä¿¡æ¸…å–®é é¢ --- */
#weibo-dm-list .dm-list-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
#weibo-dm-list .dm-list-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode #weibo-dm-list .dm-list-item:hover {
    background-color: #2c2c2e;
}
#weibo-dm-list .dm-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
}
#weibo-dm-list .dm-info {
    flex-grow: 1;
    overflow: hidden;
}
#weibo-dm-list .dm-name {
    font-weight: 500;
    font-size: 16px;
    margin-bottom: 4px;
}
#weibo-dm-list .dm-last-msg {
    font-size: 13px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- ç§ä¿¡è©³æƒ…é é¢ --- */
#weibo-dm-messages {
    background-color: #f0f2f5 !important;
}
#phone-screen.dark-mode #weibo-dm-messages {
    background-color: #000000 !important;
}

/* è¤‡ç”¨ä¸»èŠå¤©ä»‹é¢çš„æ°£æ³¡æ¨£å¼ï¼Œä½†ç‚ºç²‰çµ²å’Œè§’è‰²å®šç¾©ç‰¹å®šå°é½Šæ–¹å¼ */
#weibo-dm-messages .message-wrapper.fan {
    align-self: flex-start;
}
#weibo-dm-messages .message-wrapper.fan .message-bubble {
    flex-direction: row;
}
#weibo-dm-messages .message-wrapper.fan .content {
    background-color: #ffffff;
    border-radius: 2px 18px 18px 18px;
}

#weibo-dm-messages .message-wrapper.char {
    align-self: flex-end;
}
#weibo-dm-messages .message-wrapper.char .message-bubble {
    flex-direction: row-reverse;
}
#weibo-dm-messages .message-wrapper.char .content {
    background-color: #ff8200; /* å¾®åšæ©™è‰² */
    color: white;
    border-radius: 18px 2px 18px 18px;
}

#phone-screen.dark-mode #weibo-dm-messages .message-wrapper.fan .content {
    background-color: #2c2c2e;
}
#phone-screen.dark-mode #weibo-dm-messages .message-wrapper.char .content {
    background-color: #e67300;
}

/* â˜…â˜…â˜… é€™æ˜¯ä½ éœ€è¦çš„ã€åˆªé™¤æŒ‰éˆ•ã€‘çš„æ¨£å¼ â˜…â˜…â˜… */
.dm-message-delete-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.1);
    color: #555;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    opacity: 0; /* é»˜èªéš±è— */
    transition: all 0.2s ease;
}
/* æ»‘é¼ æ‡¸åœåœ¨æ¶ˆæ¯ä¸Šæ™‚é¡¯ç¤ºæŒ‰éˆ• */
#weibo-dm-messages .message-wrapper:hover .dm-message-delete-btn {
    opacity: 1;
}
.dm-message-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* èª¿æ•´æŒ‰éˆ•ä½ç½®ï¼Œè®“å®ƒå‡ºç¾åœ¨æ°£æ³¡æ—é‚Š */
#weibo-dm-messages .message-wrapper.fan .dm-message-delete-btn {
    right: -28px; /* ä¿®æ”¹ï¼šå¾ left æ”¹ç‚º rightï¼ŒæŠŠå®ƒæ”¾åˆ°å³é‚Š */
    left: auto;   /* æ–°å¢ï¼šå–æ¶ˆå·¦å´å®šä½ï¼Œç¢ºä¿ right ç”Ÿæ•ˆ */
}
#weibo-dm-messages .message-wrapper.char .dm-message-delete-btn {
    right: -28px;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©ç¸½çµåŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* ç¸½çµç®¡ç†å½ˆçª—å…§çš„åˆ—è¡¨ */
#summary-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* å–®æ¢ç¸½çµå¡ç‰‡ */
.summary-item-card {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid var(--border-color);
    position: relative;
}

#phone-screen.dark-mode .summary-item-card {
    background-color: #2c2c2e;
}

.summary-item-card .summary-content {
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.summary-item-card .summary-meta {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
}

.summary-item-card .summary-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 8px;
}

.summary-item-card .summary-actions button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    padding: 5px;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* èŠå¤©ç¸½çµå½ˆçª—åº•éƒ¨æŒ‰éˆ•çš„ç¾åŒ– */
#summary-viewer-modal .modal-footer button {
    width: auto; /* è®“å¯¬åº¦è‡ªæˆ‘èª¿æ•´ */
    margin-top: 0; /* ç§»é™¤é ‚éƒ¨å¤–é‚Šè· */
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- â€œæ¡ƒå¯¶â€App æ•´é«”ä½ˆå±€ --- */
#taobao-screen {
    background-color: #f0f2f5;
}

/* é ‚éƒ¨é ç°½ */
.taobao-tabs {
    display: flex;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--secondary-bg);
}
.taobao-tab {
    flex: 1;
    padding: 12px 0;
    text-align: center;
    font-weight: 500;
    color: var(--text-secondary);
    border: none;
    background: none;
    cursor: pointer;
    position: relative;
}
.taobao-tab.active {
    color: #FF5722; /* æ·˜å¯¶æ©™ */
}
.taobao-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 3px;
    background-color: #FF5722;
    border-radius: 1.5px;
}

/* å…§å®¹å€åŸŸ */
.taobao-content {
    flex-grow: 1;
    position: relative;
    overflow: hidden;
}
.taobao-view {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    overflow-y: auto;
    display: none;
    padding: 15px;
    box-sizing: border-box;
}
.taobao-view.active {
    display: block;
}

/* --- é¦–é /å•†å“è¦–åœ– --- */
#product-category-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    overflow-x: auto;
    padding-bottom: 5px; /* for scrollbar */
    scrollbar-width: none;
    -ms-overflow-style: none;
}
#product-category-tabs::-webkit-scrollbar { display: none; }

#product-category-tabs .category-tab-btn {
    padding: 6px 12px;
    border-radius: 15px;
    border: 1px solid var(--border-color);
    background-color: var(--secondary-bg);
    white-space: nowrap;
    cursor: pointer;
}
#product-category-tabs .category-tab-btn.active {
    background-color: #FFEFE9;
    color: #FF5722;
    border-color: #FF5722;
}

.product-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}
.product-card {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    cursor: pointer;
}
.product-card .product-image {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    background-color: #f0f2f5;
}
.product-card .product-info {
    padding: 8px;
}
.product-card .product-name {
    font-size: 14px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    min-height: 2.8em; /* ä¿è­‰å…©è¡Œçš„é«˜åº¦ */
}
.product-card .product-price {
    font-size: 16px;
    font-weight: bold;
    color: #FF5722;
    margin-top: 5px;
}
.product-card .product-price::before {
    content: 'Â¥';
    font-size: 12px;
    margin-right: 2px;
}

/* --- æˆ‘çš„/é¤˜é¡è¦–åœ– --- */
#user-balance-container {
    background: linear-gradient(135deg, #FF9A8B 0%, #FF6A88 100%);
    color: white;
    padding: 30px 20px;
    border-radius: 12px;
    text-align: center;
    text-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
#user-balance-container h2 {
    font-size: 40px;
    margin: 10px 0 20px 0;
}
#top-up-btn {
    background-color: rgba(255,255,255,0.9);
    color: #FF5722;
}

/* --- è¨‚å–®/ç‰©æµè¦–åœ– --- */
.order-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.order-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    display: flex;
    gap: 12px;
}
.order-item .product-image {
    width: 70px;
    height: 70px;
    border-radius: 6px;
    flex-shrink: 0;
}
.order-item .order-info {
    flex-grow: 1;
}
.order-item .product-name {
    font-weight: 500;
}
.order-item .order-status {
    font-size: 13px;
    color: #28a745;
    margin-top: 8px;
    font-weight: 500;
}
.order-item .order-time {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- â€œæ¡ƒå¯¶â€App æœç´¢æ¬„æ¨£å¼ --- */
.taobao-search-bar {
    display: flex;
    gap: 10px;
    padding: 0 0 15px 0; /* åªåœ¨ä¸‹æ–¹ç•™å‡ºé–“è· */
}

#product-search-input {
    flex-grow: 1;
    border: 1px solid #FF5722;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 14px;
    outline: none;
}

#product-search-btn {
    background-color: #FF5722;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 0 20px;
    font-weight: 500;
    cursor: pointer;
}

/* --- AIç”Ÿæˆçµæœå½ˆçª—å…§çš„æ¨£å¼ --- */
#ai-product-results-grid .product-card {
    position: relative; /* ç‚ºäº†å®šä½â€œæ·»åŠ â€æŒ‰éˆ• */
    padding-bottom: 40px; /* ç‚ºæŒ‰éˆ•ç•™å‡ºç©ºé–“ */
    cursor: default; /* åœ¨å½ˆçª—è£¡ï¼Œå¡ç‰‡æœ¬èº«ä¸å¯é»æ“Š */
}

.add-to-my-page-btn {
    position: absolute;
    bottom: 8px;
    left: 8px;
    right: 8px;
    width: calc(100% - 16px);
    padding: 8px 0;
    background-color: #4CAF50; /* ç¶ è‰²ï¼Œä»£è¡¨æ·»åŠ  */
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.add-to-my-page-btn:hover {
    background-color: #45a049;
}

.add-to-my-page-btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}


/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- è³¼ç‰©è»Šé ç°½ä¸Šçš„å°ç´…é» --- */
.taobao-tab {
    position: relative;
}
#cart-item-count-badge {
    position: absolute;
    top: 5px;
    right: 15px;
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #FF5722;
    color: white;
    font-size: 11px;
    border-radius: 9px;
    line-height: 18px;
}

/* --- å•†å“å¡ç‰‡ä¸Šçš„â€œåŠ å…¥è³¼ç‰©è»Šâ€æŒ‰éˆ• --- */
.product-card .add-cart-btn {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 28px;
    height: 28px;
    background-color: #FF5722;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.2s;
}
.product-card .add-cart-btn:active {
    transform: scale(0.9);
}

/* --- è³¼ç‰©è»Šåˆ—è¡¨ --- */
#cart-item-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-bottom: 70px; /* ç‚ºåº•éƒ¨çš„çµç®—æ¬„ç•™å‡ºç©ºé–“ */
}
.cart-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
}
.cart-item .product-image {
    width: 80px;
    height: 80px;
    border-radius: 6px;
    flex-shrink: 0;
    cursor: pointer; /* è®“åœ–ç‰‡å¯é»æ“Š */
}
.cart-item .cart-item-info {
    flex-grow: 1;
    cursor: pointer; /* è®“ä¿¡æ¯å€ä¹Ÿå¯é»æ“Š */
}
.cart-item .product-name {
    font-weight: 500;
}
.cart-item .product-price {
    color: #FF5722;
    font-weight: bold;
    margin-top: 8px;
}
.cart-item .quantity-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}
.cart-item .quantity-controls button {
    width: 24px;
    height: 24px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 50%;
    cursor: pointer;
}
.cart-item .delete-cart-item-btn {
    width: 30px;
    height: 30px;
    border: none;
    background: none;
    color: #999;
    font-size: 24px;
    cursor: pointer;
    flex-shrink: 0;
}

/* --- è³¼ç‰©è»Šçµç®—æ¬„ --- */
#cart-checkout-bar {
    position: fixed; /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå¾ absolute æ”¹ç‚º fixed â˜…â˜…â˜… */
    bottom: 0;
    left: 0;
    right: 0; /* (æ¨è–¦) é…åˆ left:0 è‡ªå‹•æ’æ»¿å¯¬åº¦ï¼Œæ›´ç©©å¦¥ */
    /* width: 100%; (å¯ä»¥ä¿ç•™æˆ–åˆªé™¤) */
    z-index: 10; /* (æ¨è–¦) ç¢ºä¿å®ƒå§‹çµ‚åœ¨æœ€ä¸Šå±¤ */
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: var(--secondary-bg);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-sizing: border-box;
}

#cart-checkout-bar .total-price {
    font-weight: bold;
}
#cart-checkout-bar #cart-total-price {
    color: #FF5722;
    font-size: 18px;
}
#cart-checkout-bar #checkout-btn {
    background-color: #FF5722;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 500;
    cursor: pointer;
}

/* --- å•†å“è©³æƒ…å½ˆçª— --- */
#product-detail-body {
    text-align: center;
}
#product-detail-body .product-image {
    width: 80%;
    max-width: 250px;
    border-radius: 8px;
    margin-bottom: 15px;
}
#product-detail-body .product-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
}
#product-detail-body .product-price {
    font-size: 24px;
    font-weight: bold;
    color: #FF5722;
    margin-bottom: 20px;
}
#product-detail-body .product-price::before {
    content: 'Â¥';
    font-size: 16px;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- å•†å“è©³æƒ…å½ˆçª— - è©•åƒ¹å€ --- */
#product-reviews-section {
    padding: 0 15px 15px 15px; /* å’Œä¸»é«”å…§å®¹ä¿æŒä¸€è‡´çš„å…§é‚Šè· */
    border-top: 1px solid var(--border-color);
    margin-top: 15px;
}
#product-reviews-section h3 {
    font-size: 16px;
    margin: 15px 0;
}
#product-reviews-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 150px; /* çµ¦ä¸€å€‹æœ€å¤§é«˜åº¦ï¼Œå…§å®¹å¤šäº†å¯ä»¥æ»¾å‹• */
    overflow-y: auto;
    margin-bottom: 15px;
}
.product-review-item {
    font-size: 14px;
    line-height: 1.6;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 10px;
}
.product-review-item .review-author {
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 5px;
}
#generate-reviews-btn {
    width: 100%;
    margin-top: 10px;
    background-color: #fff7e6;
    color: #fa8c16;
    border-color: #ffd591;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- é¤˜é¡æ˜ç´°æ¸…å–®æ¨£å¼ --- */
.transaction-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 12px 15px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.transaction-info .description {
    font-weight: 500;
}
.transaction-info .timestamp {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}
.transaction-amount {
    font-weight: bold;
    font-size: 16px;
}
.transaction-amount.income {
    color: #4CAF50; /* æ”¶å…¥ç‚ºç¶ è‰² */
}
.transaction-amount.expense {
    color: #F44336; /* æ”¯å‡ºç‚ºç´…è‰² */
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºç‰©æµè©³æƒ…é æ–°å¢çš„æ¨£å¼ï¼Œè«‹é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

#logistics-content-area {
    padding: 20px;
    background-color: #f5f5f5;
}

#phone-screen.dark-mode #logistics-content-area {
    background-color: #121212;
}

/* é ‚éƒ¨å•†å“è³‡è¨Šå¡ç‰‡ */
.logistics-product-summary {
    display: flex;
    gap: 15px;
    padding: 15px;
    margin-bottom: 20px;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
}

.logistics-product-summary .product-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    flex-shrink: 0;
}

.logistics-product-summary .info .name {
    font-weight: 600;
    font-size: 15px;
}

.logistics-product-summary .info .status {
    font-size: 13px;
    color: #FF5722; /* æ·˜å¯¶æ©™ */
    margin-top: 5px;
    font-weight: 500;
}

/* æ™‚é–“è»¸å®¹å™¨ */
.logistics-timeline {
    position: relative;
    padding-left: 25px; /* ç‚ºæ™‚é–“è»¸çš„åˆ†éš”è™Ÿå’Œåœ“é»ç•™å‡ºç©ºé–“ */
    background-color: var(--secondary-bg);
    padding: 20px 20px 20px 30px;
    border-radius: 12px;
}

/* æ™‚é–“è»¸çš„åˆ†éš”è™Ÿ */
.logistics-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 20px;
    bottom: 20px;
    width: 2px;
    background-color: #e0e0e0;
}

#phone-screen.dark-mode .logistics-timeline::before {
    background-color: #38383a;
}

/* æ¯ä¸€å€‹ç‰©æµæ­¥é©Ÿ */
.logistics-step {
    position: relative;
    margin-bottom: 25px;
}

.logistics-step:last-child {
    margin-bottom: 0;
}

/* æ™‚é–“è»¸ä¸Šçš„åœ“é» */
.logistics-step::before {
    content: '';
    position: absolute;
    left: -22px; 
    top: 5px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #ccc;
    border: 2px solid var(--secondary-bg);
    z-index: 1;
}

/* æœ€æ–°çš„ä¸€æ¢ç‰©æµç‹€æ…‹ï¼Œè®“å®ƒçš„åœ“é»æ›´çªå‡º */
.logistics-step:first-child::before {
    background-color: #FF5722;
    transform: scale(1.3);
}

.logistics-step-content .status-text {
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 5px;
    line-height: 1.5;
}

.logistics-step-content .timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œåˆ†äº«çµ¦Taä»£ä»˜â€æŒ‰éˆ•æ–°å¢çš„æ¨£å¼ â–¼â–¼â–¼ */
#share-cart-to-char-btn {
    background-color: #FF9800; /* ä½¿ç”¨ä¸€å€‹æº«æš–çš„æ©™è‰²ï¼Œå€åˆ¥äºçµç®—æŒ‰éˆ• */
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s; /* æ·»åŠ æ‡¸åœæ•ˆæœ */
}
#share-cart-to-char-btn:hover {
    background-color: #F57C00;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œè³¼ç‰©è»Šä»£ä»˜è«‹æ±‚â€æ–°å¢çš„å¡ç‰‡æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“åŒ…è£¹å¡ç‰‡çš„æ°£æ³¡æœ¬èº«è®Šé€æ˜ */
.message-bubble.is-cart-share-request .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* 2. å¡ç‰‡ä¸»é«”æ¨£å¼ */
.cart-share-card {
    width: 230px;
    border-radius: 12px;
    background-color: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    border: 2px solid transparent; /* ç‚ºä¸åŒç‹€æ…‹æº–å‚™çš„é‚Šæ¡† */
    transition: all 0.3s ease;
}

/* 3. å¡ç‰‡é ­éƒ¨ */
.cart-share-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    background-color: #FFF8E1; /* æº«æš–çš„ç±³é»ƒè‰² */
    color: #FFA000;
}
.cart-share-header .icon {
    font-size: 24px;
    font-weight: bold;
}
.cart-share-header .title {
    font-size: 16px;
    font-weight: 600;
}

/* 4. å¡ç‰‡å…§å®¹å€åŸŸ */
.cart-share-body {
    padding: 15px;
    text-align: center;
}
.cart-share-body .label {
    font-size: 13px;
    color: #888;
}
.cart-share-body .amount {
    font-size: 32px;
    font-weight: 700;
    color: #FF5722; /* æ·˜å¯¶æ©™ */
    margin: 5px 0 15px 0;
}
.cart-share-body .status-text {
    font-weight: 500;
    color: var(--accent-color);
}

/* 5. ä¸åŒç‹€æ…‹ä¸‹çš„æ¨£å¼ */
.cart-share-card.paid {
    border-color: #4CAF50; /* ç¶ è‰² */
}
.cart-share-card.paid .status-text {
    color: #4CAF50;
}
.cart-share-card.rejected {
    border-color: #F44336; /* ç´…è‰² */
    opacity: 0.8;
}
.cart-share-card.rejected .status-text {
    color: #F44336;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œç‚ºTaè³¼è²·â€å’Œç¦®ç‰©é€šçŸ¥å¡ç‰‡æ–°å¢çš„æ¨£å¼ â–¼â–¼â–¼ */

/* 1. â€œç‚ºTaè³¼è²·â€æŒ‰éˆ•çš„æ¨£å¼ */
#buy-for-char-btn {
    background-color: #4CAF50; /* ä½¿ç”¨ä¸€å€‹ä»£è¡¨â€œç¦®ç‰©â€çš„ç¶ è‰² */
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}
#buy-for-char-btn:hover {
    background-color: #45a049;
}

/* 2. è®“åŒ…è£¹ç¦®ç‰©å¡ç‰‡çš„æ°£æ³¡è®Šé€æ˜ */
.message-bubble.is-gift-notification .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* 3. ç¦®ç‰©é€šçŸ¥å¡ç‰‡ä¸»é«”æ¨£å¼ */
.gift-card {
    width: 230px;
    border-radius: 12px;
    background-color: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}
.gift-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    background-color: #e8f5e9; /*æ·¡æ·¡çš„ç¶ è‰²èƒŒæ™¯*/
    color: #2e7d32;
}
.gift-card-header .icon {
    font-size: 24px;
    font-weight: bold;
}
.gift-card-header .title {
    font-size: 16px;
    font-weight: 600;
}
.gift-card-body {
    padding: 15px;
}
.gift-card-body .greeting {
    font-size: 14px;
    margin-bottom: 10px;
}
.gift-card-items {
    font-size: 13px;
    color: #555;
    max-height: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 10px;
}
.gift-card-footer {
    padding-top: 10px;
    border-top: 1px solid #f0f0f0;
    text-align: right;
    font-weight: bold;
}
.gift-card-footer .total-price {
    color: #FF5722;
}
/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®“è§’è‰²ä¸»é çš„å…§å®¹å€å¯ä»¥ç¨ç«‹æ»¾å‹• */
#weibo-char-profile-page {
    flex-grow: 1;
    overflow-y: auto;
    background-color: #f0f2f5;
}

/* 2. ä¿®æ­£å¤œé–“æ¨¡å¼ä¸‹ä¸»é å’Œæ–°é é¢çš„èƒŒæ™¯è‰² */
#phone-screen.dark-mode #weibo-profile-page,
#phone-screen.dark-mode #weibo-char-profile-page {
    background-color: #000;
}

/* 3. ç‚ºè§’è‰²ä¸»é ä¸Šçš„è·æ¥­é¡¯ç¤ºæ·»åŠ æ¨£å¼ (å·²ä¿®æ”¹) */
#weibo-char-profession-display {
    position: absolute;
    /* å®šä½ï¼šå¾å³å´æ¨™ç±¤æ”¹ç‚ºèˆ‡â€œé—œæ³¨â€è³‡æ–™å·¦å°é½Š */
    left: 35px;
    /* å‚ç›´ä½ç½®ï¼šæ”¾åœ¨â€œé—œæ³¨â€è³‡æ–™è¡Œçš„ä¸‹æ–¹ï¼Œ-5pxæœƒè®“å®ƒæ›´é ä¸‹ä¸€é» */
    bottom: -5px;
    right: auto; /* æ¸…é™¤æ‰èˆŠçš„ right å®šä½ï¼Œé¿å…è¡çª */
    z-index: 2;
    
    /* å¤–è§€ï¼šå¾åŠé€æ˜æ¨™ç±¤æ”¹ç‚ºå’Œä½ ä¸»é ä¸€è‡´çš„ç°è‰²æ™®é€šæ–‡å­— */
    font-size: 13px;
    color: #8a8a8a;
    text-shadow: none;
    background-color: transparent;
    padding: 0;
    border-radius: 0;
}


/* 4. çµ¦é—œæ³¨æ¸…å–®çš„â€œæŸ¥çœ‹ä¸»é â€æŒ‰éˆ•æ·»åŠ æ¨£å¼ */
.weibo-following-item .view-profile-btn {
    margin-left: auto; /* è®“æŒ‰éˆ•è‡ªå‹•é å³ */
    padding: 5px 10px;
    font-size: 13px;
    font-weight: 500;
    color: var(--accent-color);
    background-color: #e7f3ff;
    border: none;
    border-radius: 12px;
    cursor: pointer;
}
#phone-screen.dark-mode .weibo-following-item .view-profile-btn {
    background-color: rgba(0, 123, 255, 0.2);
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å±¤ç´šä¿®å¾©ã€‘è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* å¼·åˆ¶æå‡é ­åƒæ¡†é¸æ“‡å½ˆçª—çš„å±¤ç´šï¼Œç¢ºä¿å®ƒèƒ½è¦†è“‹åœ¨å…¶ä»–å½ˆçª—ä¹‹ä¸Š */
#avatar-frame-modal {
    z-index: 1005; 
}

/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯æ–°å¢çš„æ¨£å¼ â–¼â–¼â–¼ */

/* é€™æ˜¯æˆ‘å€‘æ–°åŠ çš„ã€åŒ…è£¹é ­åƒçš„å¯é»æ“Šå€åŸŸçš„æ¨£å¼ */
.weibo-post-avatar-clickable {
    cursor: pointer; /* æ»‘é¼ æ”¾ä¸Šå»æ™‚é¡¯ç¤ºç‚ºå°æ‰‹å½¢ç‹€ */
    transition: opacity 0.2s ease-in-out; /* æ·»åŠ ä¸€å€‹å¹³æ»‘çš„éæ¸¡å‹•ç•« */
}

/* æ»‘é¼ æ‡¸åœæ™‚ï¼Œè®“é ­åƒç¨å¾®è®Šæš—ä¸€é»ï¼Œçµ¦ç”¨æˆ¶ä¸€å€‹æ˜ç¢ºçš„å›é¥‹ */
.weibo-post-avatar-clickable:hover {
    opacity: 0.85;
}

/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èªéŸ³æ’­æ”¾å‹•ç•«æ¨£å¼ â–¼â–¼â–¼ */
.message-bubble.is-voice-message.playing .voice-waveform div {
    animation: wave-play 1s ease-in-out infinite;
}

@keyframes wave-play {
  0%, 100% { height: 2px; }
  25% { height: 12px; }
  50% { height: 6px; }
  75% { height: 18px; }
}
/* â–²â–²â–² æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */


/* ============ â€œæŸ¥æ‰‹æ©Ÿâ€åŠŸèƒ½ç¾åŒ–ä»£ç¢¼ v2.0 (æ”¯æ´è‡ªè¨‚åœ–ç‰‡) é–‹å§‹ ============ */

/* --- æ­¥é©Ÿ1: ç¸®å°åœ–ç¤ºå°ºå¯¸ (ä¿æŒä¸è®Š) --- */
#character-app-grid .app-icon .icon-bg {
    width: 50px !important;
    height: 50px !important;
    border-radius: 13px !important;
}
#character-app-grid .app-icon .label {
    font-size: 12px;
}

/* --- æ­¥é©Ÿ2: å°‡å®¹å™¨æ”¹ç‚ºè‡ªç”±å®šä½çš„â€œæ¡Œé¢â€ä½ˆå±€ (ä¿æŒä¸è®Š) --- */
#character-app-grid {
    display: block !important;
    grid-template-columns: none !important;
    gap: 0 !important;
    position: relative !important;
    height: 100% !important;
}

/* --- æ­¥é©Ÿ3: è®“æ‰€æœ‰Appåœ–ç¤ºâ€œæµ®â€èµ·ä¾† (ä¿æŒä¸è®Š) --- */
#character-app-grid .app-icon {
    position: absolute !important;
}

/* --- æ­¥é©Ÿ4: ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºæˆ‘å€‘æ–°çš„åœ–ç‰‡ä½å…ƒè¨­ç½®æ¨£å¼ --- */
.char-phone-widget {
    position: absolute;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* åŠ å€‹é™°å½±æ›´å¥½çœ‹ */
    border: 2px solid rgba(255,255,255,0.5); /* åŠ å€‹ç™½é‚Šæ›´æœ‰è³ªæ„Ÿ */
    overflow: hidden; /* é˜²æ­¢åœ–ç‰‡æº¢å‡ºåœ“è§’ */
    cursor: pointer; /* æ»‘é¼ æ”¾ä¸Šå»æ˜¯å°æ‰‹å½¢ç‹€ï¼Œæç¤ºå¯ä»¥é»æ“Š */
    transition: transform 0.2s ease; /* æ·»åŠ é»æ“Šå‹•æ•ˆ */
    background-color: #e0e0e0; /* åœ–ç‰‡è¼‰å…¥å‰çš„å ä½å…ƒé¡è‰² */
}
.char-phone-widget:active {
    transform: scale(0.95); /* é»æ“Šæ™‚ç¸®å°ä¸€é»é» */
}
.char-phone-widget img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ä¿è­‰åœ–ç‰‡å¡«æ»¿ä¸”ä¸è®Šå½¢ */
}

/* ============================================== */
/* === â˜…â˜…â˜… æ‰‹å‹•ç²¾èª¿å€ï¼šåœ¨é€™è£¡ä¿®æ”¹ä½ç½®å’Œå¤§å° â˜…â˜…â˜… === */
/* ============================================== */

/* --- å·¦ä¸Šè§’çš„åœ–ç‰‡ä½å…ƒ --- */
#char-phone-widget-1 {
    /* --- åœ¨é€™è£¡èª¿æ•´ã€ä¸Šä¸‹ä½ç½®ã€‘(æ•¸å­—è¶Šå¤§è¶Šå¾€ä¸‹)--- */
    top: 60px;
    /* --- åœ¨é€™è£¡èª¿æ•´ã€å·¦å³ä½ç½®ã€‘(æ•¸å­—è¶Šå¤§è¶Šå¾€å³)--- */
    left: 20px;
    /* --- åœ¨é€™è£¡èª¿æ•´ã€å¤§å°ã€‘--- */
    width: 110px;
    height: 110px;
    border-radius: 22px; /* åœ“è§’ (å»ºè­°æ˜¯å¯¬åº¦çš„1/5å·¦å³) */
}

/* --- å³ä¸‹è§’çš„åœ–ç‰‡ä½å…ƒ --- */
#char-phone-widget-2 {
    /* --- åœ¨é€™è£¡èª¿æ•´ã€ä¸Šä¸‹ä½ç½®ã€‘(æ•¸å­—è¶Šå¤§è¶Šå¾€ä¸Š)--- */
    bottom: 60px;
    /* --- åœ¨é€™è£¡èª¿æ•´ã€å·¦å³ä½ç½®ã€‘(æ•¸å­—è¶Šå¤§è¶Šå¾€å·¦)--- */
    right: 20px;
    /* --- åœ¨é€™è£¡èª¿æ•´ã€å¤§å°ã€‘--- */
    width: 110px;
    height: 110px;
    border-radius: 22px; /* åœ“è§’ */
}

/* --- APP åœ–ç¤ºä½ç½®èª¿æ•´ (é€™éƒ¨åˆ†ä¿æŒä¸è®Š) --- */
#character-app-grid .app-icon:nth-child(1) { top: 70px; left: 150px; }
#character-app-grid .app-icon:nth-child(2) { top: 70px; left: 215px; }
#character-app-grid .app-icon:nth-child(3) { top: 155px; left: 30px; }
#character-app-grid .app-icon:nth-child(4) { top: 155px; left: 95px; }
#character-app-grid .app-icon:nth-child(5) { top: 155px; left: 160px; }
#character-app-grid .app-icon:nth-child(6) { top: 240px; left: 225px; }
#character-app-grid .app-icon:nth-child(7) { top: 240px; left: 30px; }
#character-app-grid .app-icon:nth-child(8) { top: 240px; left: 95px; }
#character-app-grid .app-icon:nth-child(9) { top: 325px; left: 30px; }
#character-app-grid .app-icon:nth-child(10) { top: 325px; left: 95px; }

/* ============ â€œæŸ¥æ‰‹æ©Ÿâ€åŠŸèƒ½ç¾åŒ–ä»£ç¢¼ çµæŸ ============ */

/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘åªç‚ºâ€œå¾®åšâ€å’Œâ€œç²‰çµ²â€å¢åŠ é»æ“Šå€åŸŸ â–¼â–¼â–¼ */

/*
 * æ ¸å¿ƒåŸç†ä¸è®Šï¼Œä½†é€™æ¬¡æˆ‘å€‘ä½¿ç”¨äº†æ›´ç²¾ç¢ºçš„ ID é¸æ“‡å™¨ï¼Œ
 * åªé¸ä¸­ #weibo-posts-item (å¾®åš) å’Œ #weibo-fans-item (ç²‰çµ²) é€™å…©å€‹å…ƒç´ ã€‚
 */
#weibo-posts-item,
#weibo-fans-item {
    padding: 8px 10px;
    margin: -8px -10px;
    border-radius: 8px;
    transition: background-color 0.2s;
}

/* ç‚ºé€™å…©å€‹æŒ‰éˆ•æ·»åŠ é»æ“Šæ™‚çš„èƒŒæ™¯è‰²å›é¥‹ */
#weibo-posts-item:active,
#weibo-fans-item:active {
    background-color: rgba(0, 0, 0, 0.08); /* é»æ“Šæ™‚çµ¦ä¸€å€‹æ·¡æ·¡çš„ç°è‰²èƒŒæ™¯ */
}

/* åœ¨å¤œé–“æ¨¡å¼ä¸‹çš„é»æ“Šå›é¥‹é¡è‰² */
#phone-screen.dark-mode #weibo-posts-item:active,
#phone-screen.dark-mode #weibo-fans-item:active {
    background-color: rgba(255, 255, 255, 0.1);
}
/* â–²â–²â–² æœ€çµ‚ä¿®å¾©ç‰ˆæ¨£å¼çµæŸ â–²â–²â–² */


/* ======================================================================= /
/ === â˜…â˜…â˜… è§’è‰²æ‰‹æ©Ÿæ¡Œé¢ç¾åŒ–ä½ˆå±€ v16.0 (å‚ç›´å±…ä¸­åç§»ç‰ˆ) â˜…â˜…â˜… === /
/ ======================================================================= */

/* --- 1. ç¸½æ§åˆ¶å° & ä½ˆå±€è®Šæ•¸ --- */
#character-phone-screen {
    position: relative !important;
    
    /* --- â˜…â˜…â˜… å”¯ä¸€çš„ã€å‚ç›´ä½ç½®ã€‘ç¸½æ§åˆ¶å™¨ â˜…â˜…â˜… --- */
    /* èª¿æ•´é€™å€‹å€¼ï¼Œå°±èƒ½è®“æ‰€æœ‰åœ–ç¤ºå’Œå°å…ƒä»¶ä¸€èµ·ä¸Šä¸‹ç§»å‹• */
    /* å¢åŠ æ•¸å€¼ = æ•´é«”ä¸‹ç§»ï¼›æ¸›å°æ•¸å€¼ = æ•´é«”ä¸Šç§» */
    /* æˆ‘å¹«ä½ è¨­ç½®äº†ä¸€å€‹çœ‹èµ·ä¾†æ¯”è¼ƒå±…ä¸­çš„åˆå§‹å€¼ */
    --global-vertical-offset: 10px;
    
    /* (æ°´æº–å±…ä¸­éƒ¨åˆ†ï¼Œä¿æŒä¸è®Š) */
    --grid-width: 345px;
    --grid-left-edge: calc((100% - var(--grid-width)) / 2);
}

/* --- 2. æº–å‚™å·¥ä½œ (ä¿æŒä¸è®Š) --- */
#character-app-grid {
    position: absolute !important; top: 0; left: 0; width: 100%; height: 100%;
    display: block !important; grid-template-columns: none !important; gap: 0 !important;
}
#character-app-grid .app-icon,
#char-phone-widget-1,
#char-phone-widget-2 {
    position: absolute !important;
}

/* --- 3. Appåœ–ç¤ºæ¨£å¼ (ä¿æŒä¸è®Š) --- */
#character-app-grid .app-icon .icon-bg {
    width: 40px !important; height: 40px !important;
    background: transparent !important; box-shadow: none !important; border: none !important;
}
#character-app-grid .app-icon .label {
    font-size: 12px; color: #fff; padding-top: 8px;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* --- 4. å°çµ„ä»¶ä½ç½®å’Œå°ºå¯¸ (â˜…æ ¸å¿ƒä¿®æ”¹: æ‡‰ç”¨å…¨åŸŸåç§») --- */
#char-phone-widget-1 {
    top: calc(var(--global-vertical-offset) + 90px); /* 90px æ˜¯ä½ å›ºå®šçš„å€¼ */
    left: calc(var(--grid-left-edge) + 30px);
    width: 135px; height: 135px; border-radius: 22px;
}
#char-phone-widget-2 {
    top: calc(var(--global-vertical-offset) + 480px); /* 480px æ˜¯ä½ å›ºå®šçš„å€¼ */
    left: calc(var(--grid-left-edge) + 180px);
    width: 135px; height: 135px; border-radius: 22px;
}

/* --- 5. Appåœ–ç¤ºä½ç½® (â˜…æ ¸å¿ƒä¿®æ”¹: æ‡‰ç”¨å…¨åŸŸåç§») --- */
/* ç¬¬1è¡Œ */
#character-app-grid .app-icon:nth-child(1) { top: calc(var(--global-vertical-offset) + 155px); left: calc(var(--grid-left-edge) + 185px); }
#character-app-grid .app-icon:nth-child(2) { top: calc(var(--global-vertical-offset) + 155px); left: calc(var(--grid-left-edge) + 250px); }
/* ç¬¬2è¡Œ */
#character-app-grid .app-icon:nth-child(3) { top: calc(var(--global-vertical-offset) + 270px); left: calc(var(--grid-left-edge) + 30px); }
#character-app-grid .app-icon:nth-child(4) { top: calc(var(--global-vertical-offset) + 270px); left: calc(var(--grid-left-edge) + 105px); }
#character-app-grid .app-icon:nth-child(5) { top: calc(var(--global-vertical-offset) + 270px); left: calc(var(--grid-left-edge) + 180px); }
/* ç¬¬3è¡Œ */
#character-app-grid .app-icon:nth-child(6) { top: calc(var(--global-vertical-offset) + 375px); left: calc(var(--grid-left-edge) + 105px); }
#character-app-grid .app-icon:nth-child(7) { top: calc(var(--global-vertical-offset) + 375px); left: calc(var(--grid-left-edge) + 185px); }
#character-app-grid .app-icon:nth-child(8) { top: calc(var(--global-vertical-offset) + 375px); left: calc(var(--grid-left-edge) + 250px); }
/* ç¬¬4è¡Œ */
#character-app-grid .app-icon:nth-child(9) { top: calc(var(--global-vertical-offset) + 480px); left: calc(var(--grid-left-edge) + 30px); }
#character-app-grid .app-icon:nth-child(10) { top: calc(var(--global-vertical-offset) + 480px); left: calc(var(--grid-left-edge) + 105px); }


/* â–¼â–¼â–¼ ã€æŸ¥æ‰‹æ©ŸåŠŸèƒ½ | åœ–ç¤ºå°é½Šçµ‚æ¥µä¿®å¾© V4ã€‘ â–¼â–¼â–¼ */
/*
 * è§£æ±ºæ–¹æ¡ˆï¼š
 * 1. (ä¿ç•™) ä½¿ç”¨è² å¤–é‚Šè·ï¼Œå°‡æ‡‰ç”¨å(.label)å‘ä¸Šæ‹‰ï¼Œä½¿å…¶ç·Šè²¼åœ–ç¤ºã€‚
 * 2. (æ–°å¢) å°åŒ…å«é è¨­SVGåœ–ç¤ºçš„æ•´å€‹.app-iconå…ƒç´ ï¼Œä¹Ÿä½¿ç”¨ä¸€å€‹è² çš„margin-topï¼Œ
 *    ä½¿å…¶æ•´é«”å‘ä¸Šç§»å‹•ï¼Œå¾è€Œå’Œå…¶ä»–è‡ªè¨‚åœ–ç¤ºåœ¨å‚ç›´æ–¹å‘ä¸Šå®Œç¾å°é½Šã€‚
 */

/* æ­¥é©Ÿ1ï¼šè®“æ–‡å­—ç·Šè²¼åœ–ç¤º (é€™æ˜¯ä¸Šæ¬¡çš„æˆåŠŸä¿®å¾©ï¼Œæˆ‘å€‘ä¿ç•™å®ƒ) */
#character-app-grid .app-icon:has(.icon-bg > svg) .label {
    margin-top: -7px !important;
    padding-top: 0px !important;
}

/* æ­¥é©Ÿ2ï¼šè®“åœ–ç¤ºå’Œæ–‡å­—ä½œç‚ºä¸€å€‹æ•´é«”ï¼Œå‘ä¸Šç§»å‹• */
#character-app-grid .app-icon:has(.icon-bg > svg) {
    margin-top: -8px; /* é€™å€‹è² å€¼æœƒæŠŠæ•´å€‹åœ–ç¤º+æ–‡å­—çš„çµ„åˆå‘ä¸Šæ‹‰ */
}
/* â–²â–²â–² ä¿®å¾©ä»£ç¢¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯æ­¥é©Ÿ1éœ€è¦é»è²¼çš„æ–°æ¨£å¼ â–¼â–¼â–¼ */

/* è®“æ¯ä¸€æ¢è©•è«–éƒ½è®Šæˆå¯é»æ“Šçš„ï¼Œä¸¦å¢åŠ æ‡¸åœæ•ˆæœ */
.weibo-comment-item {
    cursor: pointer; /* æ»‘é¼ æ‡¸åœæ™‚é¡¯ç¤ºç‚ºå°æ‰‹å½¢ç‹€ */
    transition: background-color 0.2s; /* æ·»åŠ ä¸€å€‹å¹³æ»‘çš„èƒŒæ™¯è‰²éæ¸¡å‹•ç•« */
    border-radius: 4px; /* çµ¦ä¸€é»é»åœ“è§’ï¼Œæ›´å¥½çœ‹ */
    padding: 2px 5px; /* å¢åŠ ä¸€é»å…§é‚Šè·ï¼Œè®“é»æ“Šå€åŸŸæ›´å¤§ */
    margin: 0 -5px; /* æŠŠä¸Šé¢çš„å…§é‚Šè·æŠµæ¶ˆæ‰ï¼Œä¿æŒå°é½Š */
}
.weibo-comment-item:hover {
    background-color: #f0f2f5; /* æ»‘é¼ æ”¾ä¸Šå»æ™‚ï¼Œçµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯è‰² */
}
#phone-screen.dark-mode .weibo-comment-item:hover {
    background-color: #2c2c2e; /* å¤œé–“æ¨¡å¼ä¸‹çš„æ‡¸åœé¡è‰² */
}

/* â€œå›å¾©â€é€™å…©å€‹å­—çš„æ¨£å¼ï¼Œè®“å®ƒæ›´æŸ”å’Œ */
.weibo-comment-item .weibo-comment-reply-tag {
    color: var(--text-secondary);
    margin: 0 4px; /* å’Œå…©é‚Šçš„åå­—æ‹‰é–‹ä¸€é»è·é›¢ */
}

/* è¢«å›å¾©è€…çš„åå­—æ¨£å¼ï¼Œè®“å®ƒå’Œæ™®é€šè©•è«–è€…åå­—ä¸€æ¨£å¯ä»¥é»æ“Š */
.weibo-comment-item .reply-target-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©ŸAppå…§å£ç´™æ¨£å¼ â–¼â–¼â–¼ */

/* ç•¶å…§éƒ¨è¢å¹•æœ‰å£ç´™æ™‚ï¼Œè¨­ç½®èƒŒæ™¯åœ–çš„é¡¯ç¤ºæ–¹å¼ */
.character-phone-inner-screen.has-app-wallpaper {
    background-size: cover;
    background-position: center;
}

/* é—œéµï¼šè®“æ‰€æœ‰Appé é¢çš„å…§å®¹æ¸…å–®èƒŒæ™¯è®Šé€æ˜ */
.character-phone-inner-screen.has-app-wallpaper .list-container,
.character-phone-inner-screen.has-app-wallpaper #character-chat-history-messages {
    background-color: transparent !important;
}

/* ç‚ºäº†ä¿è­‰æ–‡å­—çš„å¯è®€æ€§ï¼Œæˆ‘å€‘çµ¦æ¸…å–®é …å’Œå¡ç‰‡åŠ ä¸ŠåŠé€æ˜çš„èƒŒæ™¯ */
.character-phone-inner-screen.has-app-wallpaper .character-data-item,
.character-phone-inner-screen.has-app-wallpaper .character-cart-item,
.character-phone-inner-screen.has-app-wallpaper .character-browser-item,
.character-phone-inner-screen.has-app-wallpaper .character-bank-transaction,
.character-phone-inner-screen.has-app-wallpaper .chat-list-item {
    background-color: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* åŒæ¨£ç‚ºèŠå¤©æ°£æ³¡å¢åŠ åŠé€æ˜æ•ˆæœ */
.character-phone-inner-screen.has-app-wallpaper .character-chat-bubble-container.received .character-chat-bubble {
    background-color: rgba(255, 255, 255, 0.85);
}
.character-phone-inner-screen.has-app-wallpaper .character-chat-bubble-container.sent .character-chat-bubble {
    background-color: rgba(149, 236, 105, 0.85); /* å¾®ä¿¡ç¶ ï¼Œä½†å¸¶ä¸€é»é€æ˜ */
}

/* é©é…å¤œé–“æ¨¡å¼çš„åŠé€æ˜é¡è‰² */
#phone-screen.dark-mode .character-phone-inner-screen.has-app-wallpaper .character-data-item,
#phone-screen.dark-mode .character-phone-inner-screen.has-app-wallpaper .chat-list-item {
     background-color: rgba(28, 28, 30, 0.7);
}
#phone-screen.dark-mode .character-phone-inner-screen.has-app-wallpaper .character-chat-bubble-container.received .character-chat-bubble {
    background-color: rgba(44, 44, 46, 0.85);
}
#phone-screen.dark-mode .character-phone-inner-screen.has-app-wallpaper .character-chat-bubble-container.sent .character-chat-bubble {
     background-color: rgba(48, 93, 32, 0.85); /* å¤œé–“æ¨¡å¼çš„ç¶ è‰² */
}
/* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œéŠæˆ²åˆ†äº«â€æ–°å¢çš„é¡è‰²æ¨£å¼ â–¼â–¼â–¼ */
.share-type.game {
    background-color: #9c27b0; /* ä¸€å€‹ä»£è¡¨éŠæˆ²çš„ç¥ç§˜ç´«è‰² */
}
/* â–²â–²â–² æ–°å¢æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒå‹•é£›è¡Œæ£‹æ¨£å¼ â–¼â–¼â–¼ */

/* --- éŠæˆ²ä¸»ä»‹é¢ä½ˆå±€ --- */
#ludo-game-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    padding: 15px;
    box-sizing: border-box;
    gap: 15px;
    background-color: #fff0f5; /* æº«æŸ”çš„æ·¡ç²‰è‰²èƒŒæ™¯ */
}

#phone-screen.dark-mode #ludo-game-content {
    background-color: #2c1e22; /* å¤œé–“æ¨¡å¼ä¸‹çš„æ·±ç²‰ç´«è‰² */
}

/* --- æ£‹ç›¤å®¹å™¨èˆ‡æ£‹ç›¤æœ¬èº« --- */
#ludo-board-container {
    position: relative;
    width: 100%;
    height: 280px; /* çµ¦æ£‹ç›¤ä¸€å€‹å›ºå®šçš„é«˜åº¦ */
    flex-shrink: 0;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
    padding: 10px;
    box-sizing: border-box;
}

#ludo-board {
    display: grid;
    grid-template-columns: repeat(10, 1fr); /* 10x6çš„ç¶²æ ¼ä½ˆå±€ */
    grid-template-rows: repeat(6, 1fr);
    width: 100%;
    height: 100%;
    gap: 3px;
}

/* --- æ£‹ç›¤æ ¼å­æ¨£å¼ --- */
.ludo-cell {
    border-radius: 4px;
    background-color: rgba(255, 192, 203, 0.3); /* æ·¡æ·¡çš„ç²‰è‰²æ ¼å­ */
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 14px;
    font-weight: bold;
    color: #db7093;
}

/* èµ·é»å’Œçµ‚é»æ ¼å­ */
.ludo-cell.start { background-color: #90ee90; color: #2e8b57; }
.ludo-cell.end { background-color: #ffd700; color: #b8860b; }

/* ç‰¹æ®Šäº‹ä»¶æ ¼å­ */
.ludo-cell.event-truth { background-color: #ffb6c1; } /* çœŸå¿ƒè©± */
.ludo-cell.event-dare { background-color: #add8e6; }  /* å¤§å†’éšª */
.ludo-cell.event-kiss { background-color: #ff69b4; }  /* è¦ªè¦ª */
.ludo-cell.event-hug { background-color: #ffdab9; }   /* æŠ±æŠ± */

.ludo-cell .cell-number {
    font-size: 10px;
    position: absolute;
    top: 2px;
    left: 3px;
    color: rgba(0,0,0,0.2);
}

/* --- æ£‹å­æ¨£å¼ --- */
.ludo-piece {
    position: absolute;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
}
.ludo-piece.user { border-color: #87cefa; }
.ludo-piece.char { border-color: #ffc0cb; }

/* --- éŠæˆ²æ—¥èªŒ --- */
#ludo-log-container {
    flex-grow: 1;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
    padding: 10px;
    overflow-y: auto;
    min-height: 0;
}
#ludo-game-log .log-entry {
    padding: 6px 8px;
    font-size: 14px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    line-height: 1.5;
}
#ludo-game-log .log-entry.system {
    color: #db7093;
    font-style: italic;
    text-align: center;
}
#ludo-game-log .log-entry.user { color: #007bff; }
#ludo-game-log .log-entry.char { color: #e83e8c; }
#ludo-game-log .log-entry strong { font-weight: 900; }


/* --- æ“ä½œå€èˆ‡éª°å­å‹•ç•« --- */
#ludo-action-area {
    flex-shrink: 0;
    padding: 10px 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 60px;
}
#ludo-dice-container {
    perspective: 1000px;
}
.dice {
    width: 50px;
    height: 50px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 1s;
    cursor: pointer;
}
.dice.rolling { animation: roll-dice 1.5s ease-out; }
@keyframes roll-dice {
    0% { transform: rotateX(0deg) rotateY(0deg); }
    100% { transform: rotateX(1080deg) rotateY(720deg); }
}
.dice .face {
    position: absolute;
    width: 50px;
    height: 50px;
    border: 1px solid #ccc;
    background: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    font-weight: bold;
}
.face.front  { transform: rotateY(0deg) translateZ(25px); }
.face.back   { transform: rotateY(180deg) translateZ(25px); }
.face.right  { transform: rotateY(90deg) translateZ(25px); }
.face.left   { transform: rotateY(-90deg) translateZ(25px); }
.face.top    { transform: rotateX(90deg) translateZ(25px); }
.face.bottom { transform: rotateX(-90deg) translateZ(25px); }

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é£›è¡Œæ£‹å•é¡Œé¡å‹æ¨™ç±¤æ¨£å¼ â–¼â–¼â–¼ */
.question-type-tag {
    font-size: 10px;
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 10px;
    color: white;
    margin-left: 10px;
    flex-shrink: 0;
}
.question-type-tag.both-answer {
    background-color: #ff8fab; /* ç²‰è‰²ä»£è¡¨å…±åŒå›ç­” */
}
.question-type-tag.single-answer {
    background-color: #87ceeb; /* è—è‰²ä»£è¡¨ä¸€äººå›ç­” */
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é£›è¡Œæ£‹çµç®—å¡ç‰‡æ¨£å¼ â–¼â–¼â–¼ */
#ludo-summary-content h3 {
    text-align: center;
    color: var(--accent-color);
    margin-bottom: 15px;
    font-size: 20px;
    font-weight: bold;
}
#ludo-summary-content .ludo-qa-log {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
    max-height: 300px; /* çµ¦å•ç­”è¨˜éŒ„æª”ä¸€å€‹æœ€å¤§é«˜åº¦ï¼Œå…§å®¹å¤šäº†å¯ä»¥æ»¾å‹• */
    overflow-y: auto;
}
#ludo-summary-content h4 {
    margin-bottom: 10px;
    color: var(--text-primary);
}
#ludo-summary-content .qa-item {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px dashed #eee;
}
#ludo-summary-content .qa-item:last-child {
    border-bottom: none;
}
#ludo-summary-content .qa-question {
    font-weight: 600;
    color: #db7093; /* ä¸€å€‹å¯æ„›çš„ç²‰ç´«è‰² */
    margin-bottom: 8px;
}
#ludo-summary-content .qa-answer {
    padding-left: 15px;
    font-size: 14px;
    color: var(--text-secondary);
}
#ludo-summary-content .qa-answer strong {
    color: var(--text-primary);
}
#phone-screen.dark-mode #ludo-summary-content .qa-answer {
    color: #bbb;
}


/* â–¼â–¼â–¼ ã€ç¨å®¶å®šåˆ¶ã€‘è§’è‰²æ‰‹æ©Ÿæ¶ˆæ¯æ¸…å–® - å¯æ„›ç£¨ç ‚é€æ˜åœ“è§’ç‰ˆ v3.0 â–¼â–¼â–¼ */

/* 1. çµ¦æ¶ˆæ¯æ¸…å–®å®¹å™¨å¢åŠ å…§é‚Šè·å’Œé–“è·ï¼Œç‚ºå¡ç‰‡ç•™å‡ºå‘¼å¸ç©ºé–“ */
#character-chat-list.list-container {
    padding: 15px 10px;
    display: flex;
    flex-direction: column;
    gap: 15px; /* â€œæˆ‘â€çš„å¡ç‰‡å’Œâ€œå…¶ä»–äººâ€å¡ç‰‡ä¹‹é–“çš„é–“è· */
}

/* 2. é‡ç½®æ‰€æœ‰æ¸…å–®é …çš„åŸºç¤æ¨£å¼ï¼Œç§»é™¤èˆŠçš„é‚Šæ¡† */
#character-chat-list .chat-list-item {
    border-bottom: none !important;
}

/* 3. ã€ä½ çš„å°ˆå±¬ã€‘å–®ç¨è¨­ç½®â€œæˆ‘çš„æ¶ˆæ¯â€(ç¬¬ä¸€å€‹)çš„å¯æ„›è† å›Šæ¨£å¼ */
#character-chat-list > .chat-list-item {
    background-color: rgba(255, 255, 255, 0.1); /* è¶…ç´šé€æ˜çš„ç™½è‰²èƒŒæ™¯ */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 25px; /* å¯æ„›çš„è† å›Šåœ“è§’ */
    border: 1px solid rgba(255, 255, 255, 0.15); /* æ·¡æ·¡çš„äº®é‚Šï¼Œå¢åŠ è³ªæ„Ÿ */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* æŸ”å’Œçš„é™°å½±ï¼Œç‡Ÿé€ æ‡¸æµ®æ„Ÿ */
    padding: 15px; /* å¢åŠ å…§é‚Šè·ï¼Œè®“å…§å®¹æ›´èˆ’æœ */
    color: white; /* æ–‡å­—é¡è‰²ä¹Ÿè®Šæˆç™½è‰² */
    text-shadow: 0 1px 2px rgba(0,0,0,0.3); /* çµ¦æ–‡å­—åŠ ä¸€é»é™°å½±ä¿è­‰æ¸…æ™°åº¦ */
}
#character-chat-list > .chat-list-item .last-msg {
    color: rgba(255, 255, 255, 0.7); /* é è¦½æ¶ˆæ¯çš„æ–‡å­—é¡è‰²æ·¡ä¸€é» */
}


/* 4. ã€ä½ çš„å°ˆå±¬ã€‘è¨­ç½®â€œå…¶ä»–äººæ¶ˆæ¯â€å®¹å™¨çš„æ¨£å¼ */
.npc-chat-group {
    background-color: rgba(255, 255, 255, 0.1); /* åŒæ¨£è¶…ç´šé€æ˜ */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 25px; /* å®¹å™¨æœ¬èº«ä¹Ÿæ˜¯åœ“è§’ */
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden; /* é—œéµï¼è®“å…§éƒ¨çš„åˆ—è¡¨é …åš´æ ¼éµå®ˆå®¹å™¨çš„åœ“è§’ */
    padding: 5px 0; /* å®¹å™¨å…§éƒ¨çš„ä¸Šä¸‹ç•™ç™½ */
}

/* 5. è¨­ç½®å®¹å™¨å…§éƒ¨å–®å€‹æ¶ˆæ¯çš„æ¨£å¼ */
.npc-chat-group .chat-list-item {
    background-color: transparent !important; /* å…§éƒ¨çš„é …å®Œå…¨é€æ˜ */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important; /* ç”¨æ·¡æ·¡çš„äº®ç·šåˆ†éš” */
    padding: 12px 15px;
    color: white; /* æ–‡å­—é¡è‰²ä¹Ÿæ˜¯ç™½è‰² */
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
.npc-chat-group .chat-list-item .last-msg {
    color: rgba(255, 255, 255, 0.7);
}

/* 6. ç§»é™¤å®¹å™¨å…§ã€æœ€å¾Œä¸€å€‹ã€‘æ¶ˆæ¯çš„åº•ç·šï¼Œè®“å¡ç‰‡åº•éƒ¨æ›´ä¹¾æ·¨ */
.npc-chat-group .chat-list-item:last-child {
    border-bottom: none !important;
}
/* â–²â–²â–² å®šåˆ¶çµæŸ â–²â–²â–² */



/* ======================================================================= */
/* ===         ä¿®å¾©â€œæŸ¥æ‰‹æ©Ÿ-å¤–è§€è¨­ç½®â€ä¸­é è¦½åœ–éå¤§çš„å•é¡Œ v1.0         === */
/* ======================================================================= */

/* 1. ä¿®å¾©æ‰‹æ©Ÿå£ç´™å’ŒAppå…§å£ç´™çš„é è¦½ */
/* 
   å•é¡ŒåŸå› ï¼šä¹‹å‰çš„æ¨£å¼æ˜¯ background-size: coverï¼Œæœƒå¼·åˆ¶åœ–ç‰‡å¡«æ»¿é è¦½æ¡†ï¼Œå°è‡´è£å‰ªã€‚
   è§£æ±ºæ–¹æ¡ˆï¼šæ”¹ç‚º background-size: containï¼Œè®“åœ–ç‰‡åœ¨æ¡†å…§å®Œæ•´é¡¯ç¤ºã€‚
*/
#char-phone-wallpaper-preview,
#char-phone-app-wallpaper-preview {
    background-size: contain !important; 
    background-repeat: no-repeat !important; /* é˜²æ­¢åœ–ç‰‡åœ¨ç„¡æ³•å¡«æ»¿æ™‚é‡è¤‡å¹³é‹ª */
}

/* 2. ä¿®å¾©å…©å€‹æ¡Œé¢å°å…ƒä»¶çš„åœ–ç‰‡é è¦½ */
/* 
   å•é¡ŒåŸå› ï¼šå’Œä¸Šé¢é¡ä¼¼ï¼Œä½†å°æ–¼<img>æ¨™ç±¤ï¼Œæ§åˆ¶é¡¯ç¤ºæ–¹å¼çš„å±¬æ€§æ˜¯ object-fitã€‚
   è§£æ±ºæ–¹æ¡ˆï¼šåŒæ¨£å°‡ cover æ”¹ç‚º containã€‚
*/
#char-phone-widget-preview-1,
#char-phone-widget-preview-2 {
    object-fit: contain !important;
    /* (å¯é¸ç¾åŒ–) ç‚ºæ²’æœ‰åœ–ç‰‡æ™‚çš„é è¦½æ¡†åŠ å€‹åº•è‰²ï¼Œæ›´å¥½çœ‹ */
    background-color: #f0f2f5; 
}
/* ======================================================================= */
/* ===         ã€V2 æœ€çµ‚ä¿®å¾©ã€‘ä¿®è¤‡æŸ¥æ‰‹æ©Ÿ-å°å…ƒä»¶é è¦½åœ–éå¤§å•é¡Œ         === */
/* ======================================================================= */

#char-phone-widget-preview-1,
#char-phone-widget-preview-2 {
    background-size: contain !important;      /* æ ¸å¿ƒï¼šè®“èƒŒæ™¯åœ–å®Œæ•´é¡¯ç¤º */
    background-repeat: no-repeat !important; /* é˜²æ­¢åœ–ç‰‡é‡è¤‡å¹³é‹ª */
    background-position: center !important;  /* ç¢ºä¿åœ–ç‰‡å±…ä¸­ */
}


/* â–¼â–¼â–¼ ã€ç¨å®¶å®šåˆ¶ã€‘å¿ƒå‹•é£›è¡Œæ£‹è¼¸å…¥æ¡† - ç²‰è‰²æŒ‰éˆ•ç‰ˆ v1.0 â–¼â–¼â–¼ */

/* 1. è¼¸å…¥å€åŸŸçš„å®¹å™¨æ¨£å¼ (ä¿æŒä¸è®Š) */
#ludo-action-area {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: 8px !important;
    padding: 10px 12px !important;
}

/* 2. æ–‡æœ¬è¼¸å…¥æ¡†çš„æ¨£å¼ (ä¿æŒä¸è®Š) */
#ludo-action-area #ludo-user-speech-input {
    flex-grow: 1; 
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px; 
    line-height: 1.5;
    box-sizing: border-box;
}

/* 3. â€œç¢ºèªå›ç­”â€æŒ‰éˆ•çš„æ¨£å¼ (å·²ä¿®æ”¹ç‚ºç²‰è‰²) */
#ludo-action-area .form-button {
    width: auto !important;
    height: 40px; 
    border-radius: 20px;
    padding: 0 20px;
    flex-shrink: 0; 
    font-size: 14px;
    font-weight: 600;
    margin: 0 !important;
    border: none;
    cursor: pointer;
    
    /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨å¯æ„›çš„ç²‰è‰²æ¼¸è®Šå’Œé™°å½± â˜…â˜…â˜… */
    background: linear-gradient(135deg, #ff8fab, #fb6f92);
    color: white;
    box-shadow: 0 4px 10px rgba(251, 111, 146, 0.3);
    transition: all 0.2s ease-in-out;
}

/* â˜…â˜…â˜… æ–°å¢ï¼šç‚ºæŒ‰éˆ•æ·»åŠ æ›´ç”Ÿå‹•çš„äº¤äº’æ•ˆæœ â˜…â˜…â˜… */
#ludo-action-area .form-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(251, 111, 146, 0.4);
}
#ludo-action-area .form-button:active {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 2px 5px rgba(251, 111, 146, 0.3);
}

/* 4. å¤œé–“æ¨¡å¼é©é… (ä¿æŒä¸è®Š) */
#phone-screen.dark-mode #ludo-action-area #ludo-user-speech-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
}
/* â–²â–²â–² ç¾åŒ–ä»£ç¢¼çµæŸ â–²â–²â–² */



    </style>
    <!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œ â–¼â–¼â–¼ -->
    <style id="custom-theme-style"></style>
</head>
<body>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨é€™è£¡é»è²¼æ‡¸æµ®æ­Œè©æ¬„çš„ä»£ç¢¼ â–¼â–¼â–¼ -->
<div id="floating-lyrics-bar">
    <span id="floating-lyric-text">â™ª</span>
    <!-- ã€å•é¡Œ4ä¿®å¾©ã€‘ç”¨åŒ…å«SVGçš„divæ›¿æ›èˆŠçš„span -->
    <div id="lyrics-settings-btn" style="cursor: pointer; display: flex; align-items: center; justify-content: center;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
    </div>
    <span class="close-btn">Ã—</span>
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div id="lock-screen-background-blur" style="display: none;"></div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
            
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘ä¿®æ”¹å¾Œçš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ <div id="home-screen"...>...</div> â–¼â–¼â–¼ -->
<div id="home-screen" class="screen active">
    
    <!-- æˆ‘å€‘ç”¨ä¸€å€‹æ»‘å‹•å®¹å™¨æŠŠé é¢åŒ…èµ·ä¾† -->
    <div class="home-screen-slider">
        <!-- é€™æ˜¯ä½ çš„ç¬¬ä¸€é ï¼Œæˆ‘å€‘æŠŠåŸä¾†çš„å…§å®¹éƒ½æ”¾é€²ä¾† -->
        <div class="home-page">
            <div id="main-content-area">
                <div id="profile-widget">
                    <img id="profile-banner-img" src="https://i.postimg.cc/k495F4W5/profile-banner.jpg" class="editable-image">
                    <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ profile-avatar-container â–¼â–¼â–¼ -->
<div class="profile-avatar-container">
    <img id="profile-avatar-img" src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg" class="editable-image">
    <!-- â–¼â–¼â–¼ æˆ‘å€‘åœ¨é€™è£¡æ–°å¢äº†ä¸€å€‹ç”¨æ–¼é¡¯ç¤ºé ­åƒæ¡†çš„imgå…ƒç´  â–¼â–¼â–¼ -->
    <img id="profile-avatar-frame" class="weibo-avatar-frame" src="" style="display: none;">
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

                    <div class="profile-info">
                        <p id="profile-username" class="editable-text">ä½ çš„æ˜µç¨±</p>
                        <p id="profile-sub-username" class="editable-text">@your_id</p>
                        <p id="profile-bio" class="editable-text">é»æ“Šé€™è£¡ç·¨è¼¯ä½ çš„å€‹æ€§ç°½å</p>
                        <p id="profile-location" class="editable-text" data-placeholder="é»æ“Šç·¨è¼¯åœ°é»"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg><span>é»æ“Šç·¨è¼¯åœ°é»</span></p>
                    </div>
                </div>
                <div id="desktop-layout">
                    <div id="desktop-widget-column">
                        <div class="custom-widget-container">
                            <div id="widget-bubble-1" class="widget-bubble editable-text" contenteditable="true">é»æ“Šç·¨è¼¯æ–‡å­—</div>
                            <div class="widget-circle-uploader">
                                <img id="widget-image-1" src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg" class="editable-image" title="é»æ“Šæ›´æ›åœ–ç‰‡">
                            </div>
                            <div id="widget-subtext-1" class="widget-subtext editable-text" contenteditable="true">é»æ“Šç·¨è¼¯æ–‡å­—</div>
                        </div>
                        <div class="custom-widget-container">
                            <div id="widget-bubble-2" class="widget-bubble editable-text" contenteditable="true">é»æ“Šç·¨è¼¯æ–‡å­—</div>
                            <div class="widget-circle-uploader">
                                <img id="widget-image-2" src="https://i.postimg.cc/k495F4W5/profile-banner.jpg" class="editable-image" title="é»æ“Šæ›´æ›åœ–ç‰‡">
                            </div>
                            <div id="widget-subtext-2" class="widget-subtext editable-text" contenteditable="true">é»æ“Šç·¨è¼¯æ–‡å­—</div>
                        </div>
                    </div>
                    <div id="desktop-app-container">
                        <div class="desktop-app-icon" onclick="showScreen('chat-list-screen')"><div class="icon-bg-desktop"><img id="icon-img-qq" src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg" alt="QQ"></div><span class="label">QQ</span></div>
                        <div class="desktop-app-icon" onclick="showScreen('world-book-screen')"><div class="icon-bg-desktop"><img id="icon-img-world-book" src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="ä¸–ç•Œæ›¸"></div><span class="label">ä¸–ç•Œæ›¸</span></div>
                        <div id="check-phone-btn" class="desktop-app-icon">
                            <div class="icon-bg-desktop"><img id="icon-img-check-phone" src="https://i.postimg.cc/RVwpwr0r/IMG-8348.jpg" alt="æŸ¥æ‰‹æ©Ÿ"></div>
                            <span class="label">æŸ¥æ‰‹æ©Ÿ</span>
                        </div>
                        <div class="desktop-app-icon" id="weibo-app-icon">
                            <div class="icon-bg-desktop"><img id="icon-img-weibo" src="https://i.postimg.cc/PqBY5wBq/weibo-icon.png" alt="å¾®åš"></div>
                            <span class="label">å¾®åš</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- é€™æ˜¯æˆ‘å€‘æ–°å¢çš„ç¬¬äºŒé ï¼Œç¾åœ¨æ˜¯è‡ªè¨‚ä½ˆå±€ -->
<div class="home-page">
<!-- é€™æ˜¯å·¦åŠé‚Šçš„é ­åƒå°çµ„ä»¶ -->
<div id="second-page-left-widget" class="custom-widget-container">
    <div class="widget-circle-uploader">
        <img id="widget-image-3" src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg" class="editable-image" title="é»æ“Šæ›´æ›åœ–ç‰‡">
    </div>
    
    <!-- â–¼â–¼â–¼ é€™æ˜¯æˆ‘å€‘æ–°å¢çš„å¯ç·¨è¼¯è† å›Šæ°£æ³¡ â–¼â–¼â–¼ -->
    <div id="second-page-bubble" class="widget-bubble editable-text" contenteditable="true">
        é»æ“Šç·¨è¼¯æ–‡å­—
    </div>
    <!-- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™æ®µå…¨æ–°çš„HTMLä»£ç¢¼ â–¼â–¼â–¼ -->
<div id="new-bubbles-container">
    <div id="flat-capsule-bubble" class="widget-bubble editable-text" contenteditable="true">å¯ç·¨è¼¯</div>
    <div id="circular-bubble" class="widget-bubble editable-text" contenteditable="true">æ–‡å­—</div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

</div>
    <!-- é€™æ˜¯å³ä¸Šè§’çš„å…©å€‹ä¸¦æ’åœ–ç¤º -->
    <div id="second-page-top-right-apps">
        <div class="desktop-app-icon" onclick="showScreen('forum-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-forum" src="https://i.postimg.cc/pr0T3WfC/douban-icon.png" alt="åœˆå­"></div>
            <span class="label">åœˆå­</span>
        </div>
        <div class="desktop-app-icon" id="lovers-space-app-icon">
            <div class="icon-bg-desktop"><img id="icon-img-lovers-space" src="https://i.postimg.cc/d1wZ39xW/lovers-space-icon.png" alt="æƒ…ä¾¶ç©ºé–“"></div>
            <span class="label">æƒ…ä¾¶ç©ºé–“</span>
        </div>

<!-- é€™æ˜¯ä½ ç¾åœ¨çš„ä»£ç¢¼ -->
<div id="second-page-x-social-app" class="desktop-app-icon" onclick="showScreen('x-social-screen')">
    <div class="icon-bg-desktop"><img id="icon-img-x-social" src="https://i.postimg.cc/8P1H0vQ8/x-logo.png" alt="Xç¤¾äº¤"></div>
    <span class="label">Xç¤¾äº¤</span>
</div>



<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ•´å¡Šã€ä¿®å¾©å¾Œã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ id="center-avatar-wrapper" çš„é‚£å€‹ div â–¼â–¼â–¼ -->
<div id="center-avatar-wrapper">
    <!-- é€™æ˜¯ä½ åŸä¾†çš„é ­åƒï¼Œæˆ‘å€‘æŠŠå®ƒæ”¾åœ¨äº†æ–°å®¹å™¨çš„ä¸­å¿ƒ -->
    <div id="second-page-center-avatar" class="custom-widget-container">
        <div class="widget-circle-uploader">
            <img id="widget-image-4" src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg" class="editable-image" title="é»æ“Šæ›´æ›åœ–ç‰‡">
        </div>
    </div>
    
    <!-- é€™æ˜¯ä¿®å¾©å¾Œçš„ã€é ­åƒä¸‹æ–¹çš„å¯ç·¨è¼¯æ–‡å­—æ¡† -->
    <div id="avatar-subtitle" class="editable-text">é»æ“Šç·¨è¼¯æ–‡å­—</div>

    <!-- é€™æ˜¯ä¿®å¾©å¾Œçš„ã€é ­åƒå››å€‹è§’çš„å¯ç·¨è¼¯æ°£æ³¡ -->
    <div class="corner-bubble editable-text" id="bubble-top-left">å·¦ä¸Šè§’</div>
    <div class="corner-bubble editable-text" id="bubble-top-right">å³ä¸Šè§’</div>
    <div class="corner-bubble editable-text" id="bubble-bottom-left">å·¦ä¸‹è§’</div>
    <div class="corner-bubble editable-text" id="bubble-bottom-right">å³ä¸‹è§’</div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ åœ¨ç¬¬äºŒå€‹ <div class="home-page"> çš„é–‰åˆæ¨™ç±¤å‰ï¼Œé»è²¼ä¸‹é¢é€™æ®µä»£ç¢¼ â–¼â–¼â–¼ -->
<div style="position: absolute; top: 100px; right: 85px;">
    <div class="desktop-app-icon" onclick="showScreen('game-hall-screen')">
        <div class="icon-bg-desktop">
            <img id="icon-img-game-hall" src="https://i.postimg.cc/P5gL5z2g/game-controller-icon.png" alt="éŠæˆ²å¤§å»³">
        </div>
        <span class="label">éŠæˆ²å¤§å»³</span>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢åœ–ç¤ºä»£ç¢¼çµæŸ â–²â–²â–² -->
    </div>
<!-- â–¼â–¼â–¼ ã€é€™æ˜¯ä¿®æ”¹å¾Œçš„ç‰ˆæœ¬ã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„ id="new-custom-widget" â–¼â–¼â–¼ -->
<div id="new-custom-widget">
    <!-- æˆ‘å€‘ç”¨ä¸€å€‹æ–°çš„å®¹å™¨æŠŠæœˆä»½å’Œé ­åƒåŒ…èµ·ä¾† -->
    <div id="new-widget-header">
        <div id="widget-month-display"></div>
        <img id="new-widget-avatar" src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg" class="editable-image">
    </div>
    <div id="new-widget-text-1" class="new-widget-text editable-text" contenteditable="true">å¯ç·¨è¼¯æ–‡å­—</div>
    <div class="new-widget-divider"></div>
    <div id="new-widget-text-2" class="new-widget-text editable-text" contenteditable="true">å¯ç·¨è¼¯æ–‡å­—</div>
    <div class="new-widget-divider"></div>
    <div id="new-widget-text-3" class="new-widget-text editable-text" contenteditable="true">å¯ç·¨è¼¯æ–‡å­—</div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠä¸‹é¢é€™ä¸€æ•´å¡Šã€å…¨æ–°çš„ä»£ç¢¼ã€‘ï¼Œé»è²¼åˆ°ç¬¬äºŒå€‹ <div class="home-page"> çš„ã€å…§éƒ¨ã€‘æœ€åº•éƒ¨ â–¼â–¼â–¼ -->
<!-- é€™æ˜¯æˆ‘å€‘æ–°å¢çš„â€œæ¡ƒå¯¶â€Appåœ–ç¤º -->
<div style="position: absolute; bottom: 75px; left: 35px;">
    <div class="desktop-app-icon" id="taobao-app-icon">
        <div class="icon-bg-desktop"><img id="icon-img-taobao" src="https://i.postimg.cc/k47tXg1j/taologo.png" alt="æ¡ƒå¯¶"></div>
        <span class="label" style="color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">æ¡ƒå¯¶</span>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->


<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
</div>
    </div>
    
    <!-- åº•éƒ¨ Dock æ¬„ä¿æŒä¸è®Š -->
    <div id="desktop-dock">
        <div class="desktop-app-icon" onclick="showScreen('api-settings-screen')"><div class="icon-bg-desktop"><img id="icon-img-api-settings" src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg" alt="APIè¨­ç½®"></div><span class="label">APIè¨­ç½®</span></div>
        <div class="desktop-app-icon" onclick="showScreen('font-settings-screen')"><div class="icon-bg-desktop"><img id="icon-img-font" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="å­—é«”"></div><span class="label">å­—é«”</span></div>
        <div class="desktop-app-icon" onclick="showScreen('wallpaper-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-wallpaper" src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg" alt="å¤–è§€è¨­ç½®"></div>
            <span class="label">å¤–è§€è¨­ç½®</span>
        </div>
    </div>

    <!-- é€™æ˜¯æˆ‘å€‘æ–°å¢çš„å°åœ“é» -->
    <div class="pagination-dots">
        <span class="dot active"></span>
        <span class="dot"></span>
    </div>
</div>
<!-- â–²â–²â–² HTML æ›¿æ›çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡ŠåŠŸèƒ½æœ€å…¨ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ id="weibo-screen" çš„æ•´å€‹ div â–¼â–¼â–¼ -->
<div id="weibo-screen" class="screen">
    <!-- é€™å€‹å®¹å™¨å°‡å­˜æ”¾å¾®åšçš„æ‰€æœ‰é é¢ -->
    <div id="weibo-page-container">

        <!-- é é¢1: æˆ‘çš„é¦–é  (å·²æ”¹é€ ) -->
        <div id="weibo-my-profile-view" class="weibo-view active">
            <!-- é ­éƒ¨ -->
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
                <span>æˆ‘çš„é¦–é </span>
                <div class="header-actions">
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘åœ¨é€™è£¡æ–°å¢äº†ä¸€å€‹â€œç·¨è¼¯â€æŒ‰éˆ• -->
                    <span class="action-btn" id="edit-weibo-profile-btn" title="ç·¨è¼¯è³‡æ–™">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                    </span>
                    <span class="action-btn" id="create-weibo-post-btn" style="font-size: 28px; font-weight: 300;">+</span>
                </div>
            </div>
            <!-- ä¸»é å…§å®¹å€ -->
            <div id="weibo-profile-page">
                <div class="weibo-profile-header">
                    <img id="weibo-background-img" src="https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg" class="weibo-background">
                  <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ weibo-avatar-container â–¼â–¼â–¼ -->
<div class="weibo-avatar-container">
    <img id="weibo-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" class="weibo-avatar">
    <!-- â–¼â–¼â–¼ æˆ‘å€‘åœ¨é€™è£¡æ–°å¢äº†ä¸€å€‹ç”¨æ–¼é¡¯ç¤ºé ­åƒæ¡†çš„imgå…ƒç´  â–¼â–¼â–¼ -->
    <img id="weibo-avatar-frame" class="weibo-avatar-frame" src="" style="display: none;">
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

                    <div class="weibo-nickname" id="weibo-nickname">ä½ çš„æ˜µç¨±</div>
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡æ–°å¢ä¸€å€‹é¡¯ç¤ºè·æ¥­çš„åœ°æ–¹ -->
                    <!-- â–¼â–¼â–¼ ç”¨é€™è¡Œæ–°ä»£ç¢¼æ›¿æ›æ‰èˆŠçš„ â–¼â–¼â–¼ -->
<div id="weibo-user-profession-display">é»æ“Šè¨­ç½®è·æ¥­</div>

                    <div class="weibo-stats">
                        <div id="weibo-following-btn" class="weibo-stat-item">
                            <span id="weibo-following-count" class="weibo-stat-number">0</span>
                            <span class="weibo-stat-label">é—œæ³¨</span>
                        </div>
                        <div id="weibo-posts-item" class="weibo-stat-item">
                            <span id="weibo-posts-count" class="weibo-stat-number">0</span>
                            <span class="weibo-stat-label">å¾®åš</span>
                        </div>
                        <div id="weibo-fans-item" class="weibo-stat-item">
                            <span id="weibo-fans-count" class="weibo-stat-number">0</span>
                            <span class="weibo-stat-label">ç²‰çµ²</span>
                        </div>
                    </div>
                </div>
                <div id="my-weibo-feed-list" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                    <!-- â€œæˆ‘çš„å¾®åšâ€æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
            </div>
        </div>

        <!-- é é¢2: é—œæ³¨çš„äºº (ä¿æŒä¸è®Š) -->
        <div id="weibo-following-view" class="weibo-view">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
                <span>é—œæ³¨çš„äºº</span>
                <span class="action-btn" id="clear-following-feed-btn" style="font-size: 16px; font-weight: 500;">æ¸…ç©º</span>
            </div>
            <div id="weibo-following-feed-list" style="flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                <!-- é—œæ³¨çš„äººçš„å¾®åšæ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
        </div>
        
        <!-- é é¢3: ç†±æœ (ä¿æŒä¸è®Š) -->
        <div id="weibo-hot-search-view" class="weibo-view">
             <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
                <span>ç†±æœ</span>
                <div class="header-actions">
                    <span class="action-btn" id="generate-hot-search-btn" title="ç”Ÿæˆç†±æœ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </span>
                </div>
            </div>
            <div id="weibo-hot-search-list" style="flex-grow: 1; overflow-y: auto;">
                <p style="text-align:center; color: #8a8a8a; margin-top: 50px;">é»æ“Šå³ä¸Šè§’æ”¾å¤§é¡ç”Ÿæˆç†±æœ</p>
            </div>
        </div>

        <!-- é é¢4: å»£å ´ (ä¿æŒä¸è®Š) -->
        <div id="weibo-plaza-view" class="weibo-view">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
                <span>å»£å ´</span>
                <div class="header-actions">
                    <span class="action-btn" id="generate-plaza-feed-btn" title="ç”Ÿæˆå»£å ´å‹•æ…‹">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </span>
                </div>
            </div>
            <div id="weibo-plaza-feed-list" style="flex-grow: 1; overflow-y: auto; padding: 0;">
                 <p style="text-align:center; color: #8a8a8a; margin-top: 50px;">é»æ“Šå³ä¸Šè§’æ”¾å¤§é¡ç”Ÿæˆå»£å ´å‹•æ…‹</p>
            </div>
        </div>

        <!-- é é¢5: ç†±æœè©³æƒ…é  (ä¿æŒä¸è®Š) -->
        <div id="weibo-hottopic-feed-view" class="weibo-view">
            <div class="header">
                <span class="back-btn" id="back-from-hottopic-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
                <span id="weibo-hottopic-title">ç†±æœè©±é¡Œ</span>
                <div class="header-actions">
                     <span class="action-btn" id="refresh-hottopic-feed-btn" title="æ›ä¸€æ‰¹">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                    </span>
                </div>
            </div>
            <div id="weibo-hottopic-feed-list" style="flex-grow: 1; overflow-y: auto; padding: 0;">
                <!-- ç†±æœå¾®åšæ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å·¡è¦½åˆ— -->
    <div id="weibo-bottom-nav">
        <div class="weibo-nav-item" data-view="weibo-hot-search-view">ç†±æœ</div>
        <div class="weibo-nav-item" data-view="weibo-plaza-view">å»£å ´</div>
        <div class="weibo-nav-item" data-view="weibo-following-view">é—œæ³¨çš„äºº</div>
        <div class="weibo-nav-item active" data-view="weibo-my-profile-view">æˆ‘çš„å¾®åš</div>
    </div>
</div>
<!-- â–²â–²â–² HTML æ›¿æ›çµæŸ â–²â–²â–² -->
   
<!-- â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šã€æœ€çµ‚ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ id="world-book-screen" çš„ div â–¼â–¼â–¼ -->
<div id="world-book-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>ä¸–ç•Œæ›¸</span>
        <div class="header-actions">
            
            <!-- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ â˜…â˜…â˜… -->
            <!-- æˆ‘å€‘æŠŠ "å°å…¥" å…©å€‹å­—ï¼Œæ›æˆäº†ä¸€æ®µSVGä»£ç¢¼ï¼Œä¸¦åŠ ä¸Šäº† title æç¤º -->
            <span class="action-btn" id="import-world-book-btn" title="å°å…¥ä¸–ç•Œæ›¸">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
            </span>
            <!-- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² -->

            <span class="action-btn" id="manage-world-book-categories-btn">ç®¡ç†åˆ†é¡</span>
            <span class="action-btn" id="add-world-book-btn">+</span>
        </div>
    </div>
    <div id="world-book-list"></div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->


            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">â€¹</span>
                    <span id="world-book-editor-title">ç·¨è¼¯ä¸–ç•Œæ›¸</span>
                    <span class="save-btn" id="save-world-book-btn">ä¿å­˜</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">æ›¸å</label>
                        <input type="text" id="world-book-name-input" placeholder="è«‹è¼¸å…¥ä¸–ç•Œæ›¸çš„åç¨±...">
                    </div>

        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨é€™è£¡æ·»åŠ åˆ†é¡é¸æ“‡ â–¼â–¼â–¼ -->
        <div class="form-group">
            <label for="world-book-category-select">åˆ†é¡</label>
            <select id="world-book-category-select">
                <!-- é¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </select>
        </div>
        <!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->

                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">å…§å®¹</label>
                        <textarea id="world-book-content-input" placeholder="åœ¨æ­¤è™•è¼¸å…¥è©³ç´°çš„ä¸–ç•Œè§€è¨­å®š..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>API è¨­ç½®</span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">æç¤º: è‹¥è¦ä½¿ç”¨â€œç™¼é€åœ–ç‰‡â€åŠŸèƒ½, è«‹å‹™å¿…é¸æ“‡æ”¯æ´Vision(è¦–è¦º)çš„æ¨¡å‹, å¦‚<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>æˆ–<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>ã€‚</p>
</div><div class="form-group"><label for="api-url">API åœ°å€ï¼ˆåç¼€ä¸ç”¨æ·»åŠ /v1ï¼‰</label><input type="url" id="api-url" name="url" placeholder="é€‰æ‹©æœåŠ¡å•†å¯è‡ªåŠ¨å¡«å†™" required></div><div class="form-group"><label for="api-key">å¯†é’¥ (Key)</label><input type="password" id="api-key" name="key" placeholder="è¯·è¾“å…¥ä½ çš„APIå¯†é’¥" required></div><button type="button" class="btn btn-secondary" id="fetch-models-btn"><span class="btn-text">ç‚¹å‡»æ‹‰å–æ¨¡å‹</span><div class="spinner"></div></button><div class="form-group"><label for="api-model">é€‰æ‹©æ¨¡å‹</label><select id="api-model" name="model" required><option value="">è¯·å…ˆæ‹‰å–æ¨¡å‹åˆ—è¡¨</option></select></div>
<div class="form-group"><label for="api-key">é‡‘é‘° (ç›´é€£è¼ªè©¢ç”¨è‹±æ–‡é€—è™Ÿéš”é–‹)</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select">æ¨¡å‹</label><select id="model-select"></select></div>
<!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µã€å…¨æ–°çš„HTMLä»£ç¢¼ã€‘é»è²¼åˆ° â€œæ¨¡å‹â€ ä¸‹æ‹‰æ¸…å–®çš„ form-group ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div class="form-group">
    <label>API é è¨­</label>
    <div class="bubble-preset-manager"> <!-- è¤‡ç”¨ç¾æœ‰æ¨£å¼ -->
        <select id="api-preset-select" class="form-group select"></select>
        <button id="manage-api-presets-btn" class="action-btn">ç®¡ç†</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->
<button class="form-button" id="fetch-models-btn">æ‹‰å–æ¨¡å‹</button>

<!-- â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹ï¼Œæ˜¯å…¨æ–°çš„å¾Œè‡ºæ´»å‹•è¨­ç½®å€ â–¼â–¼â–¼ -->
<hr style="margin:20px 0; opacity:.3">

<!-- 1. ç¸½é–‹é—œ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="background-activity-switch" style="margin-bottom: 0;">
        å•Ÿç”¨å¾Œè‡ºè§’è‰²æ´»å‹• (ç¸½é–‹é—œ)
        <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
            è­¦å‘Šï¼šé–‹å•Ÿå¾Œæœƒé¡¯è‘—å¢åŠ APIèª¿ç”¨å’Œè²»ç”¨ï¼
        </p>
    </label>
    <!-- ã€é‡è¦ã€‘æˆ‘å€‘æŠŠåŸä¾†çš„ checkbox æ›æˆäº†æ›´ç¾è§€çš„ iOS é¢¨æ ¼é–‹é—œ -->
    <label class="toggle-switch">
        <input type="checkbox" id="background-activity-switch">
        <span class="slider"></span>
    </label>
</div>

<!-- 2. å¾Œè‡ºæ´»å‹•è©³ç´°è¨­ç½® (é è¨­éš±è—ï¼Œç”±ç¸½é–‹é—œæ§åˆ¶) -->
<div id="background-activity-details" style="display: none;">
    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
        <label for="background-interval-input" style="margin-bottom: 0;">
            å¾Œè‡ºæ´»å‹•æª¢æ¸¬é–“éš” (ç§’)
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                å»ºè­°å€¼ 60-300ã€‚å€¼è¶Šå¤§ï¼Œè²»ç”¨è¶Šä½ï¼Œä½†è§’è‰²åæ‡‰è¶Šæ…¢ã€‚
            </p>
        </label>
        <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
    </div>

    <!-- 3. è§’è‰²é¸æ“‡èˆ‡é »ç‡è¨­ç½® -->
    <div class="form-group">
        <label>è¨­ç½®è§’è‰²æ´»å‹•é »ç‡</label>
        <div id="background-activity-char-list" style="max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
            <!-- è§’è‰²æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="bg-select-all-chars" class="form-button-secondary" style="flex:1; margin:0;">å…¨é¸</button>
            <button id="bg-deselect-all-chars" class="form-button-secondary" style="flex:1; margin:0;">å…¨ä¸é¸</button>
        </div>
    </div>

    <div class="form-group">
    <label>ç‚ºé¸ä¸­è§’è‰²è¨­ç½®é »ç‡</label>
    <div style="display: flex; gap: 10px;">
        <button class="form-button-secondary bg-freq-btn" data-freq="low" style="flex:1; margin:0; border-color: #28a745;">ä½</button>
        <button class="form-button-secondary bg-freq-btn" data-freq="medium" style="flex:1; margin:0; border-color: #fd7e14;">ä¸­</button>
        <button class="form-button-secondary bg-freq-btn" data-freq="high" style="flex:1; margin:0; border-color: #dc3545;">é«˜</button>
        <!-- â–¼â–¼â–¼ å°±æ˜¯æ–°å¢äº†é€™å€‹â€œé—œé–‰â€æŒ‰éˆ• â–¼â–¼â–¼ -->
        <button class="form-button-secondary bg-freq-btn" data-freq="none" style="flex:1; margin:0; border-color: #aaa;">é—œé–‰</button>
    </div>
    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 8px;">
        é »ç‡è¶Šé«˜ï¼Œè§’è‰²ä¸»å‹•è¡Œç‚ºçš„æ¦‚ç‡è¶Šå¤§ï¼Œè²»ç”¨ä¹Ÿè¶Šé«˜ã€‚
    </p>
</div>
</div>
<!-- â–²â–²â–² å…¨æ–°çš„å¾Œè‡ºæ´»å‹•è¨­ç½®å€çµæŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ–°å¢ â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="block-cooldown-input" style="margin-bottom: 0;">
        AIè¢«æ‹‰é»‘å¾Œå†·éœæœŸ (å°æ™‚)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            è¢«æ‹‰é»‘è¶…éé€™å€‹æ™‚é–“å¾Œï¼ŒAIæ‰æœ‰å¹¾ç‡é‡æ–°ç”³è«‹å¥½å‹ã€‚
        </p>
    </label>
    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
</div>
<!-- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<hr style="margin:20px 0; opacity:.3">
<p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">ä»¥ä¸‹æ˜¯ Minimax èªéŸ³ï¼ˆTTSï¼‰çš„è¨­ç½®ï¼Œç”¨æ–¼AIç™¼é€èªéŸ³è¨Šæ¯ã€‚</p>
<div class="form-group">
    <label for="minimax-group-id">Minimax Group ID</label>
    <input type="text" id="minimax-group-id" placeholder="è¼¸å…¥ä½ çš„ Minimax Group ID">
</div>
<div class="form-group">
    <label for="minimax-api-key">Minimax API Key</label>
    <input type="password" id="minimax-api-key" placeholder="è¼¸å…¥ä½ çš„ Minimax API Key">
</div>
<hr style="margin:20px 0; opacity:.3">
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
<button class="form-button" id="save-api-settings-btn">ä¿å­˜è¨­ç½®</button>
			<hr style="margin:20px 0; opacity:.3">

			<button class="form-button" id="export-data-btn">åŒ¯å‡ºæ•¸æ“š</button>

<!-- â‘  æ™®é€šæŒ‰éˆ•ï¼Œå’Œâ€œåŒ¯å‡ºâ€ä¸€å€‹ class -->
<button class="form-button" id="import-btn">å°å…¥å‚™ä»½æª”æ¡ˆ</button>

<!-- â‘¡ çœŸæ­£çš„æª”é¸æ“‡å™¨ï¼Œå®Œå…¨éš±è— -->
<input id="import-data-input" type="file" accept="application/json" hidden>
</div></div>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ®µä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ åŸä¾†çš„ chat-list-screen â–¼â–¼â–¼ -->
<div id="chat-list-screen" class="screen">
    
    <!-- ä¸»é ­éƒ¨ (åªåœ¨æ¶ˆæ¯æ¸…å–®é¡¯ç¤º) -->
    <div class="header" id="main-chat-list-header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
<span id="chat-list-title">æ¶ˆæ¯</span>
        <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title="å‰µå»ºç¾¤èŠ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <!-- â–¼â–¼â–¼ é€™æ˜¯æˆ‘å€‘æ–°åŠ çš„å°å…¥æŒ‰éˆ• â–¼â–¼â–¼ -->
<span class="action-btn" id="import-character-card-btn" title="å°å…¥è§’è‰²å¡">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
    </svg>
</span>
<!-- â–²â–²â–² å°å…¥æŒ‰éˆ•çµæŸ â–²â–²â–² -->
            <span class="action-btn" id="add-chat-btn">+</span>
        </div>
    </div>

    <!-- æ¶ˆæ¯æ¸…å–®è¦–åœ– -->
    <div id="messages-view" class="chat-list-view active">
        <div id="chat-list">
            <!-- JSæœƒåœ¨é€™è£¡ç”ŸæˆèŠå¤©åˆ—è¡¨ -->
        </div>
    </div>

    <!-- å‹•æ…‹ä»‹é¢è¦–åœ– -->
    <div id="qzone-screen" class="chat-list-view">
        <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn">â€¹</span> <!-- é€™å€‹æŒ‰éˆ•ç¾åœ¨åªè² è²¬å¾å‹•æ…‹è¿”å› -->
            <span>å¥½å‹å‹•æ…‹</span>
        </div>
        <div class="qzone-content">
            <div class="qzone-profile-header">
                <div id="qzone-banner-container" class="qzone-banner-container">
                    <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="èƒŒæ™¯">
                    <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                </div>
                <div class="qzone-user-info">
                    <div id="qzone-avatar-container" class="qzone-avatar-container">
                        <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="é ­åƒ">
                        <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                    </div>
                    <span id="qzone-nickname">{{user}}</span>
                </div>
            </div>
            <div class="qzone-actions-bar">
                <div class="action-item" id="create-shuoshuo-btn"><span>èªªèªª</span></div>
                <div class="action-item" id="create-post-btn"><span>å‹•æ…‹</span></div>
                <div class="action-item" id="open-album-btn"><span>ç›¸å†Š</span></div>
            </div>
            <div id="qzone-posts-list"></div>
        </div>
    </div>

    <!-- æ”¶è—ä»‹é¢è¦–åœ– -->
    <div id="favorites-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="favorites-back-btn">â€¹</span>
        <span>æˆ‘çš„æ”¶è—</span>
        <!-- æ–°å¢çš„ç·¨è¼¯æŒ‰éˆ• -->
        <span class="action-btn" id="favorites-edit-btn">ç·¨è¼¯</span>
    </div>

        <!-- ã€æ–°å¢ã€‘æœç´¢æ¬„å®¹å™¨ -->
        <div class="search-bar-container">
            <input type="search" id="favorites-search-input" placeholder="æœç´¢æ”¶è—çš„æ¨™é¡Œã€å…§å®¹æˆ–ä½œè€…...">
            <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">Ã—</button>
        </div>

        <div id="favorites-list" class="list-container">
            <!-- æ”¶è—å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>

<!-- æ–°å¢ï¼šæ”¶è—é åº•éƒ¨æ“ä½œæ¬„ -->
<div id="favorites-action-bar" style="display: none;">
    <button id="favorites-delete-selected-btn" class="action-bar-btn">åˆªé™¤ (0)</button>
</div>

    </div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å›æ†¶éŒ„ä»‹é¢è¦–åœ– â–¼â–¼â–¼ -->
<div id="memories-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="memories-back-btn">â€¹</span>
        <span>æˆ‘å€‘çš„å›æ†¶</span>
            <span class="action-btn" id="add-countdown-btn">+</span>
        </div>
    <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- å›æ†¶å¡ç‰‡å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

   
    <!-- åº•éƒ¨å·¡è¦½åˆ— -->
<div id="chat-list-bottom-nav">
    <div class="nav-item active" data-view="messages-view">
        <span>æ¶ˆæ¯</span>
    </div>
    <div class="nav-item" data-view="qzone-screen">
        <span>å‹•æ…‹</span>
    </div>
    <!-- â–¼â–¼â–¼ åœ¨â€œå‹•æ…‹â€å’Œâ€œæ”¶è—â€ä¹‹é–“ï¼ŒåŠ å…¥é€™å€‹æ–°é ç°½ â–¼â–¼â–¼ -->
    <div class="nav-item" data-view="memories-view">
        <span>å›æ†¶</span>
    </div>
    <!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->
    <div class="nav-item" data-view="favorites-view">
        <span>æ”¶è—</span>
    </div>
</div>
</div>
<!-- â–²â–²â–² æ›¿æ›å€åŸŸçµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°çš„ HTML é»è²¼åˆ° id="chat-list-screen" çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div id="album-screen" class="screen">
    <!-- 1. é é¢é ­éƒ¨ï¼ŒåŒ…å«è¿”å›æŒ‰éˆ•å’Œæ¨™é¡Œ -->
    <div class="header">
        <span class="back-btn" id="album-back-btn">â€¹</span>
        <span>æˆ‘çš„ç›¸å†Š</span>
        <span class="action-btn" id="create-album-btn-page">+</span>
    </div>
    
    <!-- 2. é é¢å…§å®¹å®¹å™¨ -->
    <div class="list-container">
        <div id="album-grid-page">
            <!-- ç›¸ç°¿æ¸…å–®å°‡ç”± JS å‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML é»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°çš„ HTML é»è²¼åˆ° id="album-screen" çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div id="album-photos-screen" class="screen">
    <!-- 1. é é¢é ­éƒ¨ -->
    <div class="header">
        <span class="back-btn" id="album-photos-back-btn">â€¹</span>
        <span id="album-photos-title">ç›¸å†Šåç¨±</span>
        <span class="action-btn" id="album-upload-photo-btn">ä¸Šå‚³</span>
    </div>
    
    <!-- 2. é é¢å…§å®¹å®¹å™¨ -->
    <div class="list-container">
        <div id="photos-grid-page">
            <!-- ç…§ç‰‡æ¸…å–®å°‡ç”± JS å‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>

<!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°çš„ HTML é»è²¼åˆ°æ‰€æœ‰æ¨¡æ…‹æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="photo-viewer-modal" class="modal">
    <!-- 1. é—œé–‰æŒ‰éˆ• -->
    <button id="photo-viewer-close-btn">Ã—</button>
    
    <!-- 2. ä¸Šä¸€å¼µç…§ç‰‡æŒ‰éˆ• -->
    <button id="photo-viewer-prev-btn" class="nav-arrow">â€¹</button>
    
    <!-- 3. åœ–ç‰‡å®¹å™¨ -->
    <div class="photo-viewer-content">
        <img id="photo-viewer-image" src="" alt="å…¨å±ç…§ç‰‡é è¦½">
    </div>
    
    <!-- 4. ä¸‹ä¸€å¼µç…§ç‰‡æŒ‰éˆ• -->
    <button id="photo-viewer-next-btn" class="nav-arrow">â€º</button>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML é»è²¼çµæŸ â–²â–²â–² -->

    </div>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML é»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ é»è²¼åˆ° #album-photos-screen çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
<input type="file" id="album-photo-input" accept="image/*" multiple hidden>
            
<!-- â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰æ‚¨æª”ä¸­èˆŠçš„ #chat-interface-screen åŠå…¶æ‰€æœ‰å…§å®¹ â–¼â–¼â–¼ -->
<div id="chat-interface-screen" class="screen">

<div class="header">
    <!-- é è¨­æ§åˆ¶é …ï¼šåŒ…å«æ¨™é¡Œã€ç‹€æ…‹åˆ—å’Œå¸¸è¦æŒ‰éˆ• -->
    <div class="default-controls">
        <span class="back-btn" id="back-to-list-btn">â€¹</span>
        
        <!-- æ¨™é¡Œå’Œç‹€æ…‹çš„å®¹å™¨ -->
        <div id="chat-header-title-wrapper">
            <div id="chat-header-main-line">
                <span id="chat-header-title">èŠå¤©å°è±¡</span>
            </div>
            <div id="chat-header-status">
                <span class="status-dot"></span>
                <span class="status-text">ç·šä¸Š</span>
            </div>
        </div>

        <div class="header-actions">
            <!-- ã€æ­£ç¢ºä½ç½®ã€‘å¿ƒè²æŒ‰éˆ•åœ¨é€™è£¡ -->
            <span class="action-btn" id="char-heart-btn" title="å¿ƒè²" style="display: none; cursor: pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#ff4d6d" stroke="#ffc3d0" stroke-width="1.5">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
            </span>
            <span class="action-btn" id="listen-together-btn" title="ä¸€èµ·è½"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="ä¸€èµ·è½"></span>
            <span class="action-btn" id="chat-settings-btn" title="èŠå¤©è¨­ç½®"><img src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt="è¨­ç½®"></span>
        </div>
    </div>

    <!-- å¤šé¸æ¨¡å¼æ§åˆ¶é … -->
    <div class="selection-controls">
        <span id="selection-cancel-btn">å–æ¶ˆ</span>
        <span id="selection-count"></span>
        <div class="header-actions">
           <span id="selection-favorite-btn" class="action-btn">æ”¶è—</span>
           <span id="selection-share-btn" class="action-btn">åˆ†äº«</span> 
           <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;">åˆªé™¤</span>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ åœ¨ #chat-interface-screen å…§ï¼Œheader çš„ div ä¹‹å¾Œæ·»åŠ  â–¼â–¼â–¼ -->

<div id="chat-pet-container" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; z-index: 10;">
    <div id="chat-pet" style="display: none; position: absolute; cursor: grab; user-select: none; pointer-events: all; font-size: 80px; line-height: 1; text-align: center;">
        <!-- å¯µç‰©æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
    </div>
</div>

<!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->

    <!-- èŠå¤©æ¶ˆæ¯å€åŸŸ (ä¿æŒä¸è®Š) -->
    <div id="chat-messages"><div id="typing-indicator">å°æ–¹æ­£åœ¨è¼¸å…¥...</div></div>

    <!-- è¼¸å…¥å€åŸŸ (é€™æ˜¯ä¿®æ”¹å¾Œçš„æœ€çµ‚ç‰ˆæœ¬) -->
    <div id="chat-input-area">
        <div id="reply-preview-bar">
            <div class="reply-preview-content">
                <div class="sender">å›å¾© xxx:</div>
                <div class="text">è¢«å¼•ç”¨çš„æ¶ˆæ¯å…§å®¹...</div>
            </div>
            <span id="cancel-reply-btn">Ã—</span>
        </div>
        <div id="chat-input-actions-top">
            <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="è¡¨æƒ…é¢æ¿"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg></button>
            
            <!-- â€œé‡æ–°ç”Ÿæˆå›å¾©â€æŒ‰éˆ•çš„æ–°å®¶ -->
            <button id="reroll-btn" class="action-button" title="é‡æ–°ç”Ÿæˆå›å¾©"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg></button>
            
            <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="ç™¼é€ç…§ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></button>
            <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="ä¸Šå‚³åœ–ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" ><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            <button id="transfer-btn" class="chat-action-icon-btn action-button" title="è½‰å¸³">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M7 4L12 12L17 4M12 12V20M8 10H16M8 13H16"></path>
            </svg>
            </button>
            <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="ç™¼é€èªéŸ³"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg></button>
            <button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="ç™¼èµ·å¤–è³£è«‹æ±‚"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></button>
            <button id="video-call-btn" class="chat-action-icon-btn action-button" title="è¦–é »é€šè©±"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button>
            <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="ç¾¤è¦–é »é€šè©±"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></button>
            <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="ç™¼èµ·æŠ•ç¥¨"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg></button>
            <button id="share-link-btn" class="chat-action-icon-btn action-button" title="åˆ†äº«é€£çµ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></button>
            <button id="send-location-btn" class="chat-action-icon-btn action-button" title="ç™¼é€å®šä½">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
            </button>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›ä½ åŸä¾†çš„é‚£å€‹ <button id="open-tarot-btn">...</button> â–¼â–¼â–¼ -->
<button id="open-tarot-btn" class="chat-action-icon-btn action-button" title="å¡”ç¾…å åœ">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- èƒŒæ™¯å·¦å´å¡ç‰Œ -->
        <path d="M7 6.5L4 7.5V17.5L7 16.5V6.5Z" stroke="currentColor" stroke-width="2.6" stroke-linejoin="round"/>
        <!-- èƒŒæ™¯å³å´å¡ç‰Œ -->
        <path d="M17 6.5L20 7.5V17.5L17 16.5V6.5Z" stroke="currentColor" stroke-width="2.6" stroke-linejoin="round"/>
        <!-- å‰æ–¹ä¸­å¿ƒå¡ç‰Œ -->
        <rect x="7" y="5" width="10" height="15" rx="1.5" stroke="currentColor" stroke-width="2.6"/>
        <!-- ä¸­å¿ƒå¡ç‰Œçš„æ˜Ÿæ˜Ÿ -->
        <path d="M12 9.5L13.12 11.79L15.61 12.17L13.8 13.92L14.24 16.4L12 15.2L9.76 16.4L10.2 13.92L8.39 12.17L10.88 11.79L12 9.5Z" fill="currentColor"/>
    </svg>
</button>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€æ­ªé ­æ®ºÂ·æ»¿åˆ†å¯æ„›è²“ã€‘è«‹ç”¨é€™å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„å¯µç‰©æŒ‰éˆ• <button> â–¼â–¼â–¼ -->
<button id="pet-action-btn" class="chat-action-icon-btn action-button" title="æˆ‘çš„å¯µç‰©">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- ä¸»é«”è¼ªå»“: è€³æœµä¸å°ç¨±ï¼Œç‡Ÿé€ æ­ªé ­æ•ˆæœ -->
        <path d="M3.5 14.5C3.5 20.5 20.5 20.5 20.5 14.5C20.5 9 17.5 5.5 12.5 8.7C6.5 4.5 3.5 9 3.5 14.5Z" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
        <!-- çœ¼ç› -->
        <circle cx="8.5" cy="15" r="1.5" fill="currentColor"/>
        <circle cx="15.5" cy="15" r="1.5" fill="currentColor"/>
        <!-- å·¦é‚Šå…©æ ¹å°é¬é¬š -->
        <path d="M4.5 14.3L2.5 13.3" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
        <path d="M4.5 15.7L2.5 16.7" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
        <!-- å³é‚Šå…©æ ¹å°é¬é¬š -->
        <path d="M19.5 14.3L21.5 13.3" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
        <path d="M19.5 15.7L21.5 16.7" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
    </svg>
</button>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->





        </div>
        <div id="chat-input-main-row">
            <textarea id="chat-input" rows="1" placeholder="è¼¸å…¥æ¶ˆæ¯..."></textarea>
            <div id="input-actions-wrapper">
                <button id="wait-reply-btn" title="ç­‰å¾…å›å¾©"><img src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png" alt="ç­‰å¾…å›å¾©"></button>
                <button id="send-btn" class="action-button">ç™¼é€</button>
            </div>
        </div>
    </div>
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ–°å¢ â–¼â–¼â–¼ -->
<div id="chat-lock-overlay">
    <div id="chat-lock-content"></div>
</div>
<!-- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² -->

    <!-- è¡¨æƒ…é¢æ¿ (ä¿æŒä¸è®Š) -->
    <div id="sticker-panel">
        <div id="sticker-panel-header">
            <span class="panel-btn" id="close-sticker-panel-btn">å–æ¶ˆ</span>
            <span class="title">è¡¨æƒ…åŒ…</span>
            <div style="display: flex; gap: 10px;">
              <span class="panel-btn" id="add-sticker-btn">æ·»åŠ </span>
              <span class="panel-btn" id="upload-sticker-btn">ä¸Šå‚³</span>
            </div>
        </div>
        <div id="sticker-grid"></div>
    </div>
<input type="file" id="sticker-upload-input" accept="image/*" style="display: none;" multiple>
    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
    
    <!-- éŸ³æ¨‚æ’­æ”¾æ©Ÿ (ä¿æŒä¸è®Š) -->
<div id="music-player-overlay">
<div class="music-player-window">
    <!-- 1. é ‚éƒ¨é ­åƒå€åŸŸ -->
    <div id="music-avatars-container">
        <img id="music-char-avatar" src="" alt="è§’è‰²é ­åƒ">
        <svg id="heartbeat-line" viewBox="0 0 80 30">
            <path class="heartbeat-path" d="M 5 15 Q 20 0 30 15 T 55 15 L 75 15"></path>
            <path class="heartbeat-heart" d="M 0 -2 a 2 2 0 0 1 4 0 v 2 a 2 2 0 0 1 -4 0 z"></path>
        </svg>
        <img id="music-user-avatar" src="" alt="ç”¨æˆ¶é ­åƒ">
    </div>
    
    <!-- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘æŠŠé€™è¡Œæ–‡å­—ç§»åˆ°äº†é€™è£¡ â–¼â–¼â–¼ -->
    <div id="music-time-counter">å·²ç¶“ä¸€èµ·è½äº†0.0å°æ™‚</div>

    <!-- 2. é ‚éƒ¨æ“ä½œæŒ‰éˆ• -->
    <div class="music-player-top-actions">
        <div class="top-left-cluster">
            <button id="music-return-btn">â€¹</button>
            <button id="music-exit-btn">Ã—</button>
        </div>
        <span id="music-playlist-btn">â˜°</span>
    </div>

    <!-- 3. å°é¢å’Œæ­Œè©çš„åˆ‡æ›å®¹å™¨ -->
    <div id="music-display-area">
        <img id="music-album-cover" src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png" alt="æ­Œæ›²å°é¢">
        <div id="music-lyrics-container">
            <div id="music-lyrics-list">
                <div class="lyric-line">â™ª æš«ç„¡æ­Œè© â™ª</div>
            </div>
        </div>
    </div>

    <!-- 4. æ­Œæ›²ä¿¡æ¯ -->
    <div id="music-player-song-title">è«‹æ·»åŠ æ­Œæ›²</div>
    <div id="music-player-artist">...</div>
    
    <!-- 5. æ’­æ”¾æ§åˆ¶å€ (ä¿æŒä¸è®Š) -->
    <div class="music-player-controls-wrapper">
        <div class="music-progress-bar-container">
            <div id="music-current-time" class="time-display">0:00</div>
            <div class="progress-bar">
                <div id="music-progress-fill" class="progress-bar-fill"></div>
            </div>
            <div id="music-total-time" class="time-display">0:00</div>
        </div>
        <div class="music-controls">
            <button id="music-prev-btn">â—€</button>
            <button id="music-play-pause-btn" class="play-pause-btn">â–¶</button>
            <button id="music-next-btn">â–¶</button>
            <button id="music-mode-btn">é †åº</button>
            <button id="toggle-lyrics-bar-btn" title="æ¡Œé¢æ­Œè©">æ‡¸æµ®</button>
        </div>
    </div>
</div>

    </div>
</div>
    
<!-- â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ id="music-playlist-panel" åŠå…¶æ‰€æœ‰å…§éƒ¨å…§å®¹ â–¼â–¼â–¼ -->
<div id="music-playlist-panel">
<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ› â–¼â–¼â–¼ -->
<div class="playlist-header">
    <span class="panel-btn" id="close-playlist-btn">è¿”å›</span>
    <span>æ’­æ”¾æ¸…å–®</span>
    <div>
        <!-- â–¼â–¼â–¼ æˆ‘å€‘æŠŠåƒåœ¾æ¡¶åœ–ç¤ºç§»åˆ°äº†'æœ¬åœ°'çš„å·¦é‚Š â–¼â–¼â–¼ -->
        <span class="panel-btn" id="delete-expired-songs-btn" title="æ¸…ç†å¤±æ•ˆçš„æœç´¢æ­Œæ›²">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </span>
        <span class="panel-btn" id="add-song-local-btn">æœ¬åœ°</span>
        <span class="panel-btn" id="add-song-url-btn">URL</span>
        <span class="panel-btn" id="add-song-search-btn">æœç´¢</span>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->


        <div class="playlist-body" id="playlist-body"></div>
    </div>
    <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
<input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›ä½ åŸä¾†çš„ id="wallpaper-screen" â–¼â–¼â–¼ -->
<div id="wallpaper-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ¨™é¡Œæ”¹ç‚ºâ€œå¤–è§€è¨­ç½®â€ï¼Œæ›´é€šç”¨ -->
        <span>å¤–è§€è¨­ç½®</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <!-- é–å±å£ç´™è¨­ç½® (å…¨æ–°) -->
        <div style="width:100%; text-align: left; margin-bottom: 5px;">
            <label style="font-weight: 500; color: var(--text-secondary);">é–å±è¨­ç½®</label>
        </div>
        <div id="lockscreen-wallpaper-preview" class="wallpaper-preview">é»æ“Šä¸‹æ–¹ä¸Šå‚³</div>
        <button class="form-button" onclick="document.getElementById('lockscreen-wallpaper-upload-input').click();">ä¸Šå‚³é–å±å£ç´™</button>
        <input type="file" id="lockscreen-wallpaper-upload-input" accept="image/*" hidden>
        
        <div class="form-group" style="width: 100%; margin-top: 15px;">
            <label for="password-set-input">é–å±å¯†ç¢¼ (ç•™ç©ºå‰‡ç„¡å¯†ç¢¼)</label>
            <input type="text" id="password-set-input" placeholder="è¨­ç½®ä½ çš„è§£é–å¯†ç¢¼">
        </div>
        
        <hr style="width: 80%; opacity: 0.3; margin: 20px 0;">

        <!-- ä¸»è¢å¹•å£ç´™è¨­ç½® (åŸæœ‰) -->
        <div style="width:100%; text-align: left; margin-bottom: 5px;">
            <label style="font-weight: 500; color: var(--text-secondary);">ä¸»è¢å¹•è¨­ç½®</label>
        </div>
        <div id="wallpaper-preview">é»æ“Šä¸‹æ–¹ä¸Šå‚³</div>
<!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°ä»£ç¢¼é»è²¼åˆ° wallpaper-preview çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="enable-lock-screen-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">å•Ÿç”¨é–å±ä»‹é¢</span>
        <input type="checkbox" id="enable-lock-screen-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°çš„â€œé¡¯ç¤ºç‹€æ…‹åˆ—â€é–‹é—œä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="show-status-bar-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">é¡¯ç¤ºç‹€æ…‹åˆ—</span>
        <input type="checkbox" id="show-status-bar-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->


        <button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">ä¸Šå‚³å£ç´™</button>
        <input type="file" id="wallpaper-upload-input" accept="image/*">

<!-- â–¼â–¼â–¼ å°‡ã€ä¸‹é¢æ•´å¡Šä»£ç¢¼ã€‘ï¼Œå®Œæ•´æ›¿æ›ç‚ºä¸‹é¢é€™æ®µã€å…¨æ–°çš„ä»£ç¢¼ã€‘ â–¼â–¼â–¼ -->
<div class="form-group" style="display: none;">
    <label for="theme-toggle-switch" style="margin-bottom: 0;">å¤œé–“æ¨¡å¼</label>
    <label class="toggle-switch">
        <input type="checkbox" id="theme-toggle-switch">
        <span class="slider"></span>
    </label>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

    <!-- === â–¼â–¼â–¼ ä»¥ä¸‹æ˜¯æ–°å¢çš„ç¾åŒ–åŠŸèƒ½UI â–¼â–¼â–¼ === -->
    <div style="width:100%; text-align: left; margin-bottom: 15px;">
        <label style="font-weight: 500; color: var(--text-secondary);">æ‰‹æ©Ÿç¾åŒ– (CSS)</label>
    </div>

    <!-- ä¸»é¡Œé¸æ“‡å’Œç®¡ç† -->
    <div class="form-group">
        <label for="theme-selector">é¸æ“‡å·²å­˜æ–¹æ¡ˆ</label>
        <div style="display: flex; gap: 10px;">
            <select id="theme-selector" style="flex-grow: 1;"></select>
            <button id="rename-theme-btn" class="form-button-secondary" style="margin:0; padding: 0 10px;">é‡å‘½å</button>
            <button id="delete-theme-btn" class="form-button-secondary" style="margin:0; padding: 0 10px; background-color: #ffdddd; color: #ff3b30;">åˆªé™¤</button>
        </div>
    </div>

    <!-- CSS ä»£ç¢¼ç·¨è¼¯å€ -->
    <div class="form-group">
        <label for="theme-css-editor">ç¾åŒ–ä»£ç¢¼ç·¨è¼¯å€</label>
        <textarea id="theme-css-editor" rows="10" style="font-family: monospace; font-size: 12px; resize: vertical;" placeholder="åœ¨é€™è£¡é»è²¼æˆ–ç·¨è¼¯ç¾åŒ–ä»£ç¢¼..."></textarea>
    </div>
    
    <!-- æ“ä½œæŒ‰éˆ• -->
    <button id="apply-theme-btn" class="form-button">æ‡‰ç”¨ç•¶å‰ä»£ç¢¼</button>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button id="save-theme-btn" class="form-button-secondary" style="flex:1;">ä¿å­˜</button>
        <button id="save-as-new-theme-btn" class="form-button-secondary" style="flex:1;">å¦å­˜</button>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button id="export-theme-btn" class="form-button-secondary" style="flex:1;">åŒ¯å‡ºæ–¹æ¡ˆ</button>
        <button id="import-theme-btn" class="form-button-secondary" style="flex:1;">å°å…¥æ–¹æ¡ˆ</button>
        <input type="file" id="import-theme-input" accept=".json" hidden>
    </div>
    <!-- === â–²â–²â–² æ–°å¢UIçµæŸ â–²â–²â–² === -->
<!-- â–¼â–¼â–¼ ã€V3æœ€çµ‚ç¾åŒ–ç‰ˆã€‘ä¸»è¢å¹•ç¾åŒ–é è¨­åŠŸèƒ½UI â–¼â–¼â–¼ -->
<div class="preset-manager-container">
    <div style="width:100%; text-align: left; margin-bottom: 15px;">
        <label style="font-weight: 500; color: var(--text-secondary);">ä¸»è¢å¹•é è¨­</label>
    </div>
    <div class="form-group">
        <select id="home-preset-selector" class="form-group select"></select>
        <div class="preset-manager-controls">
            <!-- ç¨ä½”ä¸€è¡Œçš„æ‡‰ç”¨æŒ‰éˆ• -->
            <button id="apply-home-preset-btn" class="preset-btn-capsule preset-btn-apply" disabled>æ‡‰ç”¨</button>
            
            <!-- 2x2 ç¶²æ ¼æŒ‰éˆ• -->
            <button id="save-home-preset-btn" class="preset-btn-capsule preset-btn-save">ä¿å­˜</button>
            <!-- â–¼â–¼â–¼ å°±æ˜¯åœ¨é€™è£¡æ–°å¢äº†â€œæ›´æ–°â€æŒ‰éˆ• â–¼â–¼â–¼ -->
            <button id="update-home-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>æ›´æ–°</button>
            <button id="rename-home-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>é‡å‘½å</button>
            <button id="import-home-preset-btn" class="preset-btn-capsule preset-btn-secondary">å°å…¥</button>
            <button id="export-home-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>åŒ¯å‡º</button>
            <button id="delete-home-preset-btn" class="preset-btn-capsule preset-btn-delete" disabled>åˆªé™¤</button>
            
            <input type="file" id="import-home-preset-input" accept=".json" hidden>
        </div>
    </div>
</div>
<!-- â–²â–²â–² UIæ›¿æ›çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æ­¥é©Ÿ2ï¼šç”¨é€™æ®µæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„é¡è‰²é¸æ“‡å™¨HTML â–¼â–¼â–¼ -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div style="width:100%; text-align: left; margin-bottom: 15px;">
    <label style="font-weight: 500; color: var(--text-secondary);">ä¸»è¢å¹•åœ–ç¤ºåŠå°å…ƒä»¶å­—é«”é¡è‰²</label>
</div>
<div class="form-group">
    <label for="home-icon-widget-text-color-picker">è‡ªè¨‚å­—é«”é¡è‰²</label>
    <input type="color" id="home-icon-widget-text-color-picker" value="#FFFFFF" style="width: 100%; height: 40px; padding: 0; border-radius: 8px;">
</div>
<!-- â–²â–²â–² æ­¥é©Ÿ2 HTMLä»£ç¢¼æ›¿æ›çµæŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="remove-home-font-shadow-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">å»é™¤ä¸»è¢å¹•å­—å‹é™°å½±</span>
        <input type="checkbox" id="remove-home-font-shadow-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

        <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ–°å¢åœ–ç¤ºè¨­ç½®å€åŸŸ -->
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;">
            <label style="font-weight: 500; color: var(--text-secondary);">App åœ–ç¤ºè¨­ç½®</label>
        </div>
        <div id="icon-settings-grid">
            <!-- åœ–ç¤ºè¨­ç½®é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
<!-- â–¼â–¼â–¼ æŠŠä¸‹é¢é€™æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ°â€œAppåœ–ç¤ºè¨­ç½®â€çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div style="width:100%; text-align: left; margin-bottom: 15px;">
    <label style="font-weight: 500; color: var(--text-secondary);">ä¸»è¢å¹• App åç¨±</label>
</div>
<div id="icon-rename-grid" style="width: 100%; display: flex; flex-direction: column; gap: 15px;">
    <!-- App åç¨±è¼¸å…¥æ¡†å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ å°‡é€™æ®µæ–°ä»£ç¢¼ï¼Œé»è²¼åˆ°â€œä¿å­˜æ‰€æœ‰å¤–è§€è¨­ç½®â€æŒ‰éˆ•çš„ã€ä¸Šæ–¹ã€‘ â–¼â–¼â–¼ -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div style="width:100%; text-align: left; margin-bottom: 15px;">
    <label style="font-weight: 500; color: var(--text-secondary);">éˆ´è²è¨­ç½®</label>
</div>
<div class="form-group" style="width: 100%;">
    <label for="ringtone-url-input">ä¾†é›»éˆ´è² URL (.mp3, .wav, etc.)</label>
    <input type="text" id="ringtone-url-input" placeholder="è¼¸å…¥éŸ³è¨Šæª”çš„ç¶²è·¯é€£çµ...">
</div>
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group" style="width: 100%; margin-top: 15px;">
    <label for="notification-sound-url-input">æ¶ˆæ¯æç¤ºéŸ³ URL (.mp3, .wav, etc.)</label>
    <input type="text" id="notification-sound-url-input" placeholder="è¼¸å…¥éŸ³è¨Šæª”çš„ç¶²è·¯é€£çµ...">
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹ï¼ŒæŠŠä¸‹é¢é€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ°â€œä¿å­˜æ‰€æœ‰å¤–è§€è¨­ç½®â€æŒ‰éˆ•çš„ã€ä¸Šæ–¹ã€‘ â–¼â–¼â–¼ -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div style="width:100%; text-align: left; margin-bottom: 15px;">
    <label style="font-weight: 500; color: var(--text-secondary);">å…¨åŸŸèŠå¤©èƒŒæ™¯</label>
</div>
<div id="global-bg-preview" class="wallpaper-preview">é»æ“Šä¸‹æ–¹ä¸Šå‚³</div>
<button class="form-button" onclick="document.getElementById('global-bg-upload-input').click();">ä¸Šå‚³å…¨åŸŸèƒŒæ™¯</button>
<input type="file" id="global-bg-upload-input" accept="image/*" hidden>
<button class="form-button form-button-secondary" id="remove-global-bg-btn" style="margin-top: 10px;">ç§»é™¤å…¨åŸŸèƒŒæ™¯</button>
<button class="form-button form-button-secondary" id="clear-all-single-bgs-btn" style="margin-top: 10px; border-color: #ff3b30; color: #ff3b30;">ä¸€éµæ¸…ç©ºæ‰€æœ‰å–®äººèŠå¤©èƒŒæ™¯</button>
<!-- â–²â–²â–² é»è²¼åˆ°é€™è£¡çµæŸ â–²â–²â–² -->
        
        <!-- ã€æ ¸å¿ƒä¿®æ”¹3ã€‘æŒ‰éˆ•æ–‡å­—ä¹Ÿæ”¹ä¸€ä¸‹ -->
        <button class="form-button" id="save-wallpaper-btn" style="margin-top: 30px;">ä¿å­˜æ‰€æœ‰å¤–è§€è¨­ç½®</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é€£çµåŠŸèƒ½ HTML â–¼â–¼â–¼ -->
<div id="browser-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="browser-back-btn">â€¹</span>
        <span id="browser-title"></span>
        <span style="width: 30px;"></span>
    </div>
    <div id="browser-content" class="list-container">
        <!-- æ–‡ç« å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<div id="font-settings-screen" class="screen">
    <div class="header">
    <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
    <span>å­—é«”é è¨­</span>
    <span style="width: 30px;"></span> <!-- ä¿ç•™é€™å€‹é ç•™ä½ç½®ï¼Œè®“æ¨™é¡Œèƒ½å®Œç¾å±…ä¸­ -->
</div>
    <div class="form-container" style="gap: 20px;">
        <!-- å­—é«”é è¨­å¡æ§½çš„å®¹å™¨ -->
        <div id="font-preset-container">
            <!-- 5å€‹å¡æ§½å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>

        <!-- å…¨åŸŸå­—é«”é è¦½å€ -->
        <div class="form-group" style="width:100%;">
            <label>ç•¶å‰å…¨åŸŸå­—é«”é è¦½</label>
            <div id="font-preview">
                <p style="font-size: 20px; margin: 0 0 10px 0;">ä½ å¥½ä¸–ç•Œ Hello World</p>
                <p style="margin: 0;">é€™æ˜¯å…¨åŸŸå­—é«”é è¦½æ•ˆæœï¼Œ12345ã€‚</p>
            </div>
        </div>

        <button class="form-button form-button-secondary" id="reset-font-btn">æ¢å¾©é è¨­å­—é«”</button>
    </div>
</div>

<!-- é€™å€‹æ˜¯éš±è—çš„æª”é¸æ“‡å™¨ï¼Œç”¨ä¾†è™•ç†æœ¬åœ°ä¸Šå‚³ -->
<input type="file" id="font-preset-local-upload" accept=".ttf,.otf,.woff,.woff2" style="display: none;">


<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥è§’è‰²æ‰‹æ©Ÿâ€åŠŸèƒ½çš„æ‰€æœ‰HTMLä»‹é¢ (V3çµ‚æ¥µç‰ˆ) â–¼â–¼â–¼ -->

<!-- 1. è§’è‰²é¸æ“‡è¢å¹• (ä¿æŒä¸è®Š) -->
<div id="character-selection-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>é¸æ“‡è¦æŸ¥çœ‹çš„æ‰‹æ©Ÿ</span>
        <span style="width: 30px;"></span>
    </div>
    <div id="character-selection-list" class="list-container"></div>
</div>

<!-- â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ id="character-phone-container" åŠå…¶æ‰€æœ‰å…§å®¹ â–¼â–¼â–¼ -->
<div id="character-phone-container" class="screen">
    <div class="character-phone-frame">
        <div class="character-phone-notch"></div>
        <div class="character-phone-inner-screen">
            
            <!-- 1. è§’è‰²æ‰‹æ©Ÿçš„ä¸»ä»‹é¢ -->
            <div id="character-phone-screen" class="character-phone-page active">
                <div class="header character-phone-header">
                    <span class="back-btn" data-target-screen="character-selection-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span id="character-phone-owner-name"></span>
                    <div class="header-actions">
                        <span class="action-btn" id="clear-character-data-btn" title="æ¸…ç©ºå…¨éƒ¨è³‡æ–™">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-character-data-btn" title="åˆ·æ–°å…¨éƒ¨è³‡æ–™">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L20.5 10M3.5 14a9 9 0 0114.85 3.36L20.5 14"/></svg>
                        </span>
                    </div>
                </div>
                <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™æ®µå…¨æ–°çš„HTMLä»£ç¢¼ â–¼â–¼â–¼ -->
<!-- é€™æ˜¯å·¦ä¸Šè§’çš„å°çµ„ä»¶ -->
<div id="char-phone-widget-1" class="char-phone-widget">
    <img id="char-phone-widget-img-1" src="">
</div>
<!-- é€™æ˜¯å³ä¸‹è§’çš„å°çµ„ä»¶ -->
<div id="char-phone-widget-2" class="char-phone-widget">
    <img id="char-phone-widget-img-2" src="">
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
                <div id="character-app-grid" class="app-grid-standard" style="padding-top: 60px;"></div>
            </div>

            <!-- 2. è§’è‰²æ‰‹æ©Ÿ - èŠå¤©åˆ—è¡¨ -->
            <div id="character-chat-list-screen" class="character-phone-page">
                <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>æ¶ˆæ¯</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šæ¶ˆæ¯é çš„åˆªé™¤æŒ‰éˆ• â˜… -->
                        <span class="action-btn" id="clear-npc-chats-btn" title="æ¸…ç©ºæ‰€æœ‰NPCèŠå¤©">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-chat-message-btn" title="ç”Ÿæˆæ–°èŠå¤©">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        </span>
                    </div>
                </div>
                <div id="character-chat-list" class="list-container" style="padding: 0;"></div>
            </div>

            <!-- 3. è§’è‰²æ‰‹æ©Ÿ - å…·é«”èŠå¤©è¨˜éŒ„ -->
            <div id="character-chat-history-screen" class="character-phone-page">
                <div class="header character-phone-header">
                     <span class="back-btn" data-target-page="character-chat-list-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span id="character-chat-with-name"></span>
                </div>
                <div id="character-chat-history-messages" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px; background-color: #e5ddd5;"></div>
            </div>

            <!-- 4. è§’è‰²æ‰‹æ©Ÿ - è³¼ç‰©è»Š -->
            <div id="character-shopping-cart-screen" class="character-phone-page">
                <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                         <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>è³¼ç‰©è»Š</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šè³¼ç‰©è»Šé çš„åˆªé™¤æŒ‰éˆ• â˜… -->
                        <span class="action-btn" id="clear-cart-items-btn" title="æ¸…ç©ºè³¼ç‰©è»Š">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-cart-item-btn" title="æ·»åŠ æ–°å•†å“">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </span>
                    </div>
                </div>
                <div id="character-shopping-cart-list" class="list-container"></div>
            </div>

            <!-- 5. è§’è‰²æ‰‹æ©Ÿ - å‚™å¿˜éŒ„ -->
            <div id="character-memos-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>å‚™å¿˜éŒ„</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šå‚™å¿˜éŒ„é çš„åˆªé™¤æŒ‰éˆ• â˜… -->
                        <span class="action-btn" id="clear-memos-btn" title="æ¸…ç©ºå‚™å¿˜éŒ„">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-memo-btn" title="å¯«æ–°å‚™å¿˜éŒ„">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        </span>
                    </div>
                </div>
                <div id="character-memos-list" class="list-container"></div>
            </div>

            <!-- 6. è§’è‰²æ‰‹æ©Ÿ - æµè¦½å™¨ -->
            <div id="character-browser-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>æµè¦½å™¨</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šæµè¦½å™¨é çš„åˆªé™¤æŒ‰éˆ• â˜… -->
                        <span class="action-btn" id="clear-browser-history-btn" title="æ¸…ç©ºæ­·å²è¨˜éŒ„">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-browser-history-btn" title="ç”Ÿæˆæ–°æ­·å²">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        </span>
                    </div>
                </div>
                <div id="character-browser-list" class="list-container"></div>
            </div>

            <!-- 7. è§’è‰²æ‰‹æ©Ÿ - æµè¦½å™¨æœç´¢çµæœè©³æƒ… -->
            <div id="character-browser-detail-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-browser-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span id="character-browser-detail-title">æœç´¢çµæœ</span>
                </div>
                <div id="character-browser-detail-content" class="list-container" style="padding: 15px; line-height: 1.7;"></div>
            </div>

            <!-- 8. è§’è‰²æ‰‹æ©Ÿ - ç›¸å†Š -->
            <div id="character-album-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>ç›¸å†Š</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šç›¸å†Šé çš„åˆªé™¤æŒ‰éˆ• â˜… -->
                        <span class="action-btn" id="clear-album-photos-btn" title="æ¸…ç©ºç›¸å†Š">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-album-photo-btn" title="ç”Ÿæˆæ–°ç…§ç‰‡">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        </span>
                    </div>
                </div>
                <div id="character-album-grid" class="list-container"></div>
            </div>

            <!-- 9. è§’è‰²æ‰‹æ©Ÿ - éŠ€è¡Œ -->
            <div id="character-bank-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>éŒ¢åŒ…</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šéŒ¢åŒ…é çš„åˆªé™¤æŒ‰éˆ• â˜… -->
                        <span class="action-btn" id="clear-bank-transactions-btn" title="æ¸…ç©ºäº¤æ˜“è¨˜éŒ„">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-bank-transaction-btn" title="ç”Ÿæˆæ–°äº¤æ˜“">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                        </span>
                    </div>
                </div>
                <div id="character-bank-details" class="list-container"></div>
            </div>

            <!-- 10. è§’è‰²æ‰‹æ©Ÿ - è¡Œå‹•è»Œè·¡ -->
            <div id="character-trajectory-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>è¶³è·¡</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šè¶³è·¡é çš„åˆªé™¤æŒ‰éˆ• â˜… -->
                        <span class="action-btn" id="clear-trajectory-btn" title="æ¸…ç©ºè¶³è·¡">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-trajectory-btn" title="ç”Ÿæˆæ–°è¶³è·¡">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </span>
                    </div>
                </div>
                <div id="character-trajectory-list" class="list-container"></div>
            </div>

            <!-- 11. è§’è‰²æ‰‹æ©Ÿ - APPä½¿ç”¨è¨˜éŒ„ -->
            <div id="character-app-usage-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>è¢å¹•ä½¿ç”¨æ™‚é–“</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šä½¿ç”¨è¨˜éŒ„é çš„åˆªé™¤æŒ‰éˆ• â˜… -->
                        <span class="action-btn" id="clear-app-usage-btn" title="æ¸…ç©ºè¨˜éŒ„">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-app-usage-btn" title="ç”Ÿæˆæ–°è¨˜éŒ„">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg>
                        </span>
                    </div>
                </div>
                <div id="character-app-usage-list" class="list-container"></div>
            </div>

            <!-- 12. è§’è‰²æ‰‹æ©Ÿ - æ—¥è¨˜ -->
            <div id="character-diary-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>æ—¥è¨˜</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šæ—¥è¨˜é çš„åˆªé™¤æŒ‰éˆ• â˜… -->
                        <span class="action-btn" id="clear-diary-entries-btn" title="æ¸…ç©ºæ—¥è¨˜">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-diary-entry-btn" title="å¯«æ–°æ—¥è¨˜">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        </span>
                    </div>
                </div>
                <div id="character-diary-list" class="list-container"></div>
            </div>
            <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è§’è‰²æ‰‹æ©Ÿå¤–è§€è¨­ç½®çš„HTMLä»‹é¢ï¼Œè«‹é»è²¼åˆ°æŒ‡å®šä½ç½® â–¼â–¼â–¼ -->
<div id="character-phone-appearance-screen" class="character-phone-page">
    <div class="header character-phone-header">
        <span class="back-btn" data-target-page="character-phone-screen">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </span>
        <span>å¤–è§€è¨­ç½®</span>
        <span style="width: 30px;"></span>
    </div>
    <!-- è¤‡ç”¨ä½ å·²æœ‰çš„.form-containeræ¨£å¼ï¼Œæ–¹ä¾¿æ»¾å‹•å’Œä½ˆå±€ -->
    <div class="form-container" style="padding: 15px; gap: 25px;">
        <!-- å£ç´™è¨­ç½®å€ -->
        <div>
            <label style="font-weight: 500; color: var(--text-secondary);">æ‰‹æ©Ÿå£ç´™</label>
            <div id="char-phone-wallpaper-preview" class="wallpaper-preview" style="height: 240px; width: 135px; margin: 10px auto; border-radius: 12px;">é»æ“Šä¸‹æ–¹ä¸Šå‚³</div>
            <button id="upload-char-phone-wallpaper-btn" class="form-button">ä¸Šå‚³å£ç´™</button>
            <button id="remove-char-phone-wallpaper-btn" class="form-button form-button-secondary" style="margin-top: 10px;">ç§»é™¤å£ç´™</button>
        </div>
        <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<hr style="width: 100%; opacity: 0.2;">

<div>
    <label style="font-weight: 500; color: var(--text-secondary);">App å…§å£ç´™</label>
    <div id="char-phone-app-wallpaper-preview" class="wallpaper-preview" style="height: 240px; width: 135px; margin: 10px auto; border-radius: 12px;">é»æ“Šä¸‹æ–¹ä¸Šå‚³</div>
    <button id="upload-char-phone-app-wallpaper-btn" class="form-button">ä¸Šå‚³ App å…§å£ç´™</button>
    <button id="remove-char-phone-app-wallpaper-btn" class="form-button form-button-secondary" style="margin-top: 10px;">ç§»é™¤ App å…§å£ç´™</button>
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

        <hr style="width: 100%; opacity: 0.2;">

        <!-- Appåœ–ç¤ºè¨­ç½®å€ -->
        <div>
            <label style="font-weight: 500; color: var(--text-secondary);">App åœ–ç¤º</label>
            <div id="char-phone-icon-settings-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px; text-align: center;">
                <!-- Appåœ–ç¤ºè¨­ç½®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
        </div>

        <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
        <hr style="width: 100%; opacity: 0.2;">
        <!-- æ¡Œé¢å°çµ„ä»¶è¨­ç½®å€ -->
        <div>
            <label style="font-weight: 500; color: var(--text-secondary);">æ¡Œé¢å°çµ„ä»¶</label>
            <!-- å°çµ„ä»¶1: å·¦ä¸Šè§’ -->
            <div class="form-group" style="margin-top: 15px;">
                <label>å·¦ä¸Šè§’å°çµ„ä»¶</label>
                <div class="avatar-upload">
                    <img id="char-phone-widget-preview-1" class="wallpaper-preview" style="height: 100px; width: 100px; margin-bottom: 0;">
                    <div style="display:flex; flex-direction: column; gap: 8px;">
                        <button class="form-button-secondary" id="upload-widget-1-btn" style="margin-top:0;">ä¸Šå‚³åœ–ç‰‡</button>
                        <button class="form-button-secondary" id="remove-widget-1-btn" style="margin-top:0; border-color: #ff3b30; color: #ff3b30;">ç§»é™¤åœ–ç‰‡</button>
                    </div>
                </div>
            </div>
            <!-- å°çµ„ä»¶2: å³ä¸‹è§’ -->
            <div class="form-group" style="margin-top: 15px;">
                <label>å³ä¸‹è§’å°çµ„ä»¶</label>
                <div class="avatar-upload">
                    <img id="char-phone-widget-preview-2" class="wallpaper-preview" style="height: 100px; width: 100px; margin-bottom: 0;">
                     <div style="display:flex; flex-direction: column; gap: 8px;">
                        <button class="form-button-secondary" id="upload-widget-2-btn" style="margin-top:0;">ä¸Šå‚³åœ–ç‰‡</button>
                        <button class="form-button-secondary" id="remove-widget-2-btn" style="margin-top:0; border-color: #ff3b30; color: #ff3b30;">ç§»é™¤åœ–ç‰‡</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ°è§’è‰²æ‰‹æ©Ÿå¤–è§€è¨­ç½®é é¢çš„ .form-container å…§éƒ¨æœ«å°¾ â–¼â–¼â–¼ -->
<hr style="width: 100%; opacity: 0.2; margin-top: 25px;">
<div class="preset-manager-container">
    <div style="width:100%; text-align: left; margin-bottom: 15px;">
        <label style="font-weight: 500; color: var(--text-secondary);">å¤–è§€é è¨­</label>
    </div>
    <div class="form-group">
        <select id="char-phone-preset-selector" class="form-group select"></select>
        <div class="preset-manager-controls">
            <!-- ç¨ä½”ä¸€è¡Œçš„æ‡‰ç”¨æŒ‰éˆ• -->
            <button id="apply-char-phone-preset-btn" class="preset-btn-capsule preset-btn-apply" disabled>æ‡‰ç”¨</button>
            
            <!-- 2x2 ç¶²æ ¼æŒ‰éˆ• -->
            <button id="save-char-phone-preset-btn" class="preset-btn-capsule preset-btn-save">ä¿å­˜</button>
            <button id="update-char-phone-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>æ›´æ–°</button>
            <button id="rename-char-phone-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>é‡å‘½å</button>
            <button id="import-char-phone-preset-btn" class="preset-btn-capsule preset-btn-secondary">å°å…¥</button>
            <button id="export-char-phone-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>åŒ¯å‡º</button>
            <button id="delete-char-phone-preset-btn" class="preset-btn-capsule preset-btn-delete" disabled>åˆªé™¤</button>
            
            <input type="file" id="import-char-phone-preset-input" accept=".json" hidden>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLä»£ç¢¼çµæŸ â–²â–²â–² -->

    </div>
</div>
<!-- éš±è—çš„æ–‡ä»¶é¸æ“‡å™¨ï¼Œç”¨æ–¼è™•ç†ä¸Šå‚³ -->
<input type="file" id="char-phone-wallpaper-upload-input" accept="image/*" hidden>
<input type="file" id="char-phone-icon-upload-input" accept="image/*" hidden>

<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™å…©è¡Œæ–°çš„æª”é¸æ“‡å™¨ â–¼â–¼â–¼ -->
<input type="file" id="char-phone-widget-1-upload-input" accept="image/*" hidden>
<input type="file" id="char-phone-widget-2-upload-input" accept="image/*" hidden>
<input type="file" id="char-phone-app-wallpaper-upload-input" accept="image/*" hidden>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² HTML æ›¿æ›çµæŸ â–²â–²â–² -->


<!-- è¼‰å…¥å‹•ç•«é®ç½©å±¤ (ä¿æŒä¸è®Š) -->
<div id="generation-overlay" class="modal" style="background-color: rgba(0,0,0,0.6); z-index: 2000;">
    <div style="text-align: center; color: white;">
        <div id="loading-spinner" style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <p>æ­£åœ¨åŒæ­¥Taçš„æ‰‹æ©Ÿè³‡æ–™...</p>
        <p style="font-size: 12px; opacity: 0.7;">ï¼ˆé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ï¼Œä¸¦æœƒæ¶ˆè€—APIé¡åº¦ï¼‰</p>
    </div>
</div>

<!-- â–²â–²â–² â€œæŸ¥è§’è‰²æ‰‹æ©Ÿâ€åŠŸèƒ½HTMLçµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é¸æ“‡é€£çµ¡äººä»¥å‰µå»ºç¾¤èŠçš„è¢å¹• â–¼â–¼â–¼ -->
<div id="contact-picker-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="cancel-contact-picker-btn">å–æ¶ˆ</span>
        <span>é¸æ“‡é€£çµ¡äºº</span>
        <span class="save-btn" id="confirm-contact-picker-btn">å®Œæˆ(0)</span>
    </div>
    <div class="list-container" id="contact-picker-list">
        <!-- é€£çµ¡äººæ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå“¡ç®¡ç†è¢å¹• â–¼â–¼â–¼ -->
<div id="member-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-member-management">â€¹</span>
        <span>ç¾¤æˆå“¡ç®¡ç†</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="list-container" id="member-management-list">
        <!-- ç¾æœ‰æˆå“¡æ¸…å–®æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
    </div>
    <div id="member-management-actions">
        <button id="add-existing-contact-btn">å¾å¥½å‹åˆ—è¡¨æ·»åŠ </button>
        <button id="create-new-member-btn">å‰µå»ºç¾¤å…§æ–°æˆå“¡</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšç”¨æˆ¶äººè¨­èˆ‡è·æ¥­è¨­ç½®æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="weibo-user-settings-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>æˆ‘çš„å¾®åšè¨­å®š</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>é è¨­æ–¹æ¡ˆ</label>
                <div class="bubble-preset-manager"> <!-- è¤‡ç”¨ç¾æœ‰æ¨£å¼ -->
                    <select id="weibo-user-preset-select" class="form-group select"></select>
                    <button id="manage-weibo-user-presets-btn" class="action-btn">ç®¡ç†</button>
                </div>
            </div>
            <div class="form-group">
                <label for="weibo-user-profession-modal-input">è·æ¥­ (é¡¯ç¤ºåœ¨æ˜µç¨±ä¸‹æ–¹)</label>
                <input type="text" id="weibo-user-profession-modal-input" placeholder="ä¾‹å¦‚ï¼šè·æ¥­é›»ç«¶é¸æ‰‹ã€ç¾å¦åšä¸»">
            </div>
            <div class="form-group">
                <label for="weibo-user-persona-modal-input">éš±è—äººè¨­ (åƒ…ä¾›AIç”Ÿæˆè©•è«–æ™‚åƒè€ƒ)</label>
                <textarea id="weibo-user-persona-modal-input" rows="4" placeholder="ä¾‹å¦‚ï¼šæ€§æ ¼é«˜å†·ï¼Œå°‘èˆ‡ç²‰çµ²äº’å‹•ï¼Œåªå›å¾©è´ŠåŠ©å•†çš„è©•è«–ã€‚"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-weibo-user-settings-btn">å–æ¶ˆ</button>
            <button class="save" id="save-weibo-user-settings-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å¾®åšæ‰‹å‹•æ“ä½œçš„å½ˆçª—ï¼Œé»è²¼åˆ° </body> å‰é¢ â–¼â–¼â–¼ -->
<div id="weibo-action-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span id="weibo-action-modal-title">åŸ·è¡Œæ“ä½œ</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="weibo-action-actor-select">é¸æ“‡æ“ä½œè€… (Actor)</label>
                <select id="weibo-action-actor-select" class="form-group select"></select>
            </div>
            <div class="form-group">
                <label>é¸æ“‡æ“ä½œé¡å‹</label>
<!-- â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ› â–¼â–¼â–¼ -->
<div id="weibo-action-type-select" style="text-align: left;">
    <label><input type="radio" name="weibo_action_type" value="post" checked> ç™¼ä½ˆä¸€æ¢æ–°å¾®åš</label>
    <label><input type="radio" name="weibo_action_type" value="comment_plaza"> è©•è«–å»£å ´æœ€æ–°å¾®åš</label>
    <!-- â–¼â–¼â–¼ é€™æ˜¯æˆ‘å€‘æ–°å¢çš„é¸é … â–¼â–¼â–¼ -->
    <label><input type="radio" name="weibo_action_type" value="comment_user"> è©•è«–ç”¨æˆ¶æœ€æ–°å¾®åš</label>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
            </div>
             <div class="form-group">
                <label for="weibo-action-prompt-input">é—œæ–¼... (å¯é¸, ç°¡è¦æç¤º)</label>
                <textarea id="weibo-action-prompt-input" rows="2" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©æ¯”è³½è´äº†å¾ˆé–‹å¿ƒ or å›æ‡‰æœ€è¿‘çš„ç†±æœ"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-weibo-action-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-weibo-action-btn">åŸ·è¡Œ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç¬¬2æ­¥ ç¬¬3è™•ä¿®æ”¹ï¼ˆæ–°å¢HTMLï¼‰ â–¼â–¼â–¼ -->
<!-- ã€å…¨æ–°ã€‘è§’è‰²è¡¨æƒ…åŒ…ç®¡ç†è¢å¹• -->
<div id="char-sticker-manager-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-sticker-manager">â€¹</span>
        <span id="sticker-manager-title">è¡¨æƒ…åŒ…ç®¡ç†</span>
    </div>
    <input type="file" id="char-sticker-upload-input" accept="image/*" style="display: none;" multiple>
    <div class="modal-body" style="padding: 0; display: flex; flex-direction: column;">
        <!-- é ç°½åˆ‡æ› -->
        <div class="frame-tabs">
            <div id="sticker-tab-exclusive" class="frame-tab active">å°ˆå±¬è¡¨æƒ…</div>
            <div id="sticker-tab-common" class="frame-tab">é€šç”¨è¡¨æƒ…</div>
        </div>

        <!-- å°ˆå±¬è¡¨æƒ…å…§å®¹å€ -->
        <div id="sticker-content-exclusive" class="frame-content">
            <div class="sticker-panel-header" style="justify-content: flex-end;">
                 <div style="display: flex; gap: 10px;">
                    <span class="panel-btn" id="add-exclusive-sticker-btn">æ‰¹é‡æ·»åŠ </span>
                    <span class="panel-btn" id="upload-exclusive-sticker-btn">æœ¬åœ°ä¸Šå‚³</span>
                </div>
            </div>
            <div id="exclusive-sticker-grid" class="sticker-grid"></div>
        </div>

        <!-- é€šç”¨è¡¨æƒ…å…§å®¹å€ -->
        <div id="sticker-content-common" class="frame-content" style="display: none;">
             <div class="sticker-panel-header" style="justify-content: flex-end;">
                 <div style="display: flex; gap: 10px;">
                    <span class="panel-btn" id="add-common-sticker-btn">æ‰¹é‡æ·»åŠ </span>
                    <span class="panel-btn" id="upload-common-sticker-btn">æœ¬åœ°ä¸Šå‚³</span>
                </div>
            </div>
            <div id="common-sticker-grid" class="sticker-grid"></div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¾†é›»è«‹æ±‚æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="incoming-call-modal" class="modal">
    <div class="incoming-call-content">
        <img id="caller-avatar" class="caller-avatar" src="">
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text">é‚€è«‹ä½ è¦–é »é€šè©±</div>
        <div class="incoming-call-actions">
            <div class="action-button-wrapper">
                <button id="decline-call-btn" class="call-action-btn decline"></button>
                <span>æ‹’çµ•</span>
            </div>
            <div class="action-button-wrapper">
                <button id="accept-call-btn" class="call-action-btn accept"></button>
                <span>æ¥è½</span>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯BGMæœç´¢çµæœçš„å½ˆçª—ï¼Œè«‹é»è²¼åˆ°bodyæœ«å°¾ â–¼â–¼â–¼ -->
<div id="music-search-results-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>æœç´¢çµæœ</span>
        </div>
        <div class="modal-body" id="search-results-list" style="padding: 0;">
            <!-- æœç´¢çµæœå°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-music-search-btn" style="width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è«‹ç”¨é€™æ®µã€å…¨æ–°ç¾¤èŠç›¸å®¹çµæ§‹ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ #video-call-screen â–¼â–¼â–¼ -->
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ æª”ä¸­èˆŠçš„ #video-call-screen åŠå…¶æ‰€æœ‰å…§å®¹ â–¼â–¼â–¼ -->
<div id="video-call-screen" class="screen">
    <!-- é€™å€‹ screen åŒæ™‚ç‚ºå…©ç¨®æ¨¡å¼æœå‹™ -->

    <!-- ======================================================= -->
    <!-- æ¨¡å¼ä¸€ï¼šå…¨æ–°çš„ã€è¦–è¦ºåŒ–ã€‘è¦–é »é€šè©±ä»‹é¢ -->
    <!-- ======================================================= -->
    <div id="visual-call-interface" style="display: none;"> <!-- é»˜èªéš±è— -->
        <!-- 1. è¦–é »èƒŒæ™¯å±¤ (å¤§åœ–å’Œå°åœ–éƒ½åœ¨é€™è£¡) -->
        <div class="video-background">
            <!-- å¤§åœ–å®¹å™¨ -->
            <div id="video-main-view" class="video-container">
                <img src="" alt="ä¸»è¦–é »ç•«é¢">
            </div>
            <!-- å°åœ–å®¹å™¨ (ç•«ä¸­ç•«) -->
            <div id="video-pip-view" class="video-container pip">
                <img src="" alt="å°çª—è¦–é »ç•«é¢">
            </div>
        </div>

        <!-- 2. é ‚éƒ¨ç‹€æ…‹åˆ— -->
        <div class="video-call-top-bar">
            <span id="visual-call-timer">00:00</span>
        </div>

        <!-- 3. èŠå¤©æ°£æ³¡é¡¯ç¤ºå€åŸŸ -->
        <div id="video-call-messages-visual" class="video-call-main">
            <!-- èŠå¤©æ°£æ³¡æœƒç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘ä»£ç¢¼ï¼Œæ›¿æ›æ‰ id="visual-call-interface" è£¡é¢é‚£å€‹èˆŠçš„ video-call-controls çš„ div â–¼â–¼â–¼ -->
<div class="video-call-controls">
    <!-- é‡-rollæŒ‰éˆ• -->
    <button id="reroll-call-btn" class="control-btn reroll-btn" title="é‡æ–°ç”Ÿæˆ"></button>
    <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘ç™¼è¨€æŒ‰éˆ• -->
    <button id="user-speak-btn-visual" class="control-btn speak-btn" title="ç™¼è¨€"></button>
    <!-- åˆ‡æ›é¡é ­æŒ‰éˆ• -->
    <button id="switch-camera-btn" class="control-btn switch-camera-btn" title="åˆ‡æ›é¡é ­"></button>
    <!-- æ›æ–·æŒ‰éˆ• -->
    <button id="hang-up-btn-visual" class="control-btn hangup-btn"></button>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

    </div>

    <!-- ======================================================= -->
    <!-- æ¨¡å¼äºŒï¼šä½ åŸä¾†çš„ã€ç´”æ–‡å­—ã€‘èªéŸ³é€šè©±ä»‹é¢ (æˆ‘å€‘æŠŠå®ƒä¿ç•™ä¸‹ä¾†ä½œç‚ºé è¨­é¸é …) -->
    <!-- ======================================================= -->
    <div id="text-call-interface" style="display: none;"> <!-- é»˜èªéš±è— -->
        <div class="video-call-top-bar">
            <span id="call-timer">00:00</span>
        </div>
        <div class="video-call-avatar-area">
            <div id="participant-avatars-grid">
                <!-- JSæœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆé ­åƒ -->
            </div>
        </div>
        <div id="video-call-main" class="video-call-main">
            <!-- å°è©±å…§å®¹æœƒå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="video-call-controls">
            <!-- ã€æ–°å¢ã€‘ç‚ºèˆŠæ¨¡å¼ä¹ŸåŠ ä¸Šé‡rollæŒ‰éˆ• -->
            <button id="reroll-call-btn-text" class="control-btn reroll-btn" title="é‡æ–°ç”Ÿæˆ"></button>
            <button id="user-speak-btn" class="control-btn speak-btn"></button>
            <button id="hang-up-btn" class="control-btn hangup-btn"></button>
            <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ä»‹é¢ â–¼â–¼â–¼ -->
<div id="outgoing-call-screen" class="screen">
    <div class="outgoing-call-content">
        <img id="outgoing-call-avatar" class="caller-avatar" src="">
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">æ­£åœ¨å‘¼å«...</div>
        <div class="outgoing-call-actions">
            <button id="cancel-call-btn" class="call-action-btn decline"></button>
            <span>å–æ¶ˆ</span>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè©±è¨˜éŒ„é é¢ â–¼â–¼â–¼ -->
<div id="call-history-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="call-history-back-btn">â€¹</span>
        <span id="call-history-title">é€šè©±è¨˜éŒ„</span>
        <span style="width: 30px;"></span> <!-- é ç•™ä½ç½®ï¼Œä¿æŒæ¨™é¡Œå±…ä¸­ -->
    </div>
    <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- é€šè©±è¨˜éŒ„å¡ç‰‡å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯èŠå¤©è¨˜éŒ„æœç´¢ä»‹é¢ï¼Œè«‹é»è²¼åˆ° call-history-screen çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div id="chat-search-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="search-back-btn">â€¹</span>
        <span>æŸ¥æ‰¾èŠå¤©è¨˜éŒ„</span>
        <span style="width: 30px;"></span> <!-- é ç•™ä½ç½® -->
    </div>
    <div class="form-container" style="padding-bottom: 0;">
        <!-- æœç´¢æ¢ä»¶è¼¸å…¥å€ -->
        <div class="form-group">
            <label for="keyword-search-input">é—œéµå­—</label>
            <input type="text" id="keyword-search-input" placeholder="è¼¸å…¥è¦æŸ¥æ‰¾çš„é—œéµå­—...">
        </div>
        <div class="form-group">
            <label for="sender-search-select">äººç‰©</label>
            <select id="sender-search-select">
                <!-- é¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </select>
        </div>
        <div class="form-group">
            <label for="date-search-input">æ—¥æœŸ</label>
            <input type="date" id="date-search-input">
        </div>
        <button class="form-button" id="perform-search-btn">é–‹å§‹æŸ¥æ‰¾</button>
        
        <!-- æœç´¢çµæœé¡¯ç¤ºå€ -->
        <div id="chat-search-results-list" class="list-container" style="margin-top: 15px; padding: 0;">
            <!-- æœç´¢çµæœå°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->


            <!-- â–¼â–¼â–¼ è«‹å°‡ä¸‹é¢é€™æ•´å¡Šã€å…¨æ–°çš„HTMLä»£ç¢¼ã€‘é»è²¼åˆ°é€™è£¡ â–¼â–¼â–¼ -->
            <div id="lock-screen" class="screen">
                <div id="lock-clock-container">
                    <div id="lock-main-time">12:00</div>
                    <div id="lock-main-date">æ˜ŸæœŸä¸€, 1æœˆ1æ—¥</div>
                </div>
                <div id="unlock-hint">å‘ä¸Šæ»‘å‹•è§£é–</div>
            </div>

            <div id="password-modal-overlay" class="modal">
                <div class="password-modal-content">
                    <p>è«‹è¼¸å…¥å¯†ç¢¼</p>
                    <input type="password" id="password-input-field" maxlength="20">
                    <div class="password-actions">
                        <button id="password-cancel-btn">å–æ¶ˆ</button>
                        <button id="password-confirm-btn">é€²å…¥</button>
                    </div>
                </div>
            </div>
            <!-- â–²â–²â–² æ–°HTMLä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

        </div>
    </div>
  <!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ› â–¼â–¼â–¼ -->
<div id="lovers-space-screen" class="screen">
    <!-- é ­éƒ¨ -->
    <div id="ls-header">
        <div class="ls-header-overlay"></div>
        <div class="ls-header-top-bar">
            <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
            <span id="ls-char-name"></span>
            <div class="header-actions">
                <span class="action-btn" id="ls-settings-btn" title="ç©ºé–“è¨­ç½®">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </span>
                <span class="action-btn" id="ls-change-bg-btn" title="æ›´æ›èƒŒæ™¯">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </span>
                <span class="action-btn" id="ls-switch-char-btn">åˆ‡æ›</span>
            </div>
        </div>
        <div class="ls-avatar-and-counter-wrapper">
            <div class="ls-header-avatars">
                <img id="ls-user-avatar" src="">
                <span class="heart-icon">â¤</span>
                <img id="ls-char-avatar" src="">
            </div>
            <div id="ls-days-counter"></div>
        </div>
    </div>
<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€SVGåœ–ç¤ºç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›ä½ èˆŠçš„ ls-tab-bar â–¼â–¼â–¼ -->
<div id="ls-tab-bar">
    <div class="ls-tab-item active" data-view="ls-moments-view" title="èªªèªª">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-album-view" title="ç›¸å†Š">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-letters-view" title="æƒ…æ›¸">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-shares-view" title="åˆ†äº«">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-questions-view" title="æå•">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-diary-view" title="æ—¥è¨˜">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-pomodoro-view" title="ç•ªèŒ„é˜">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
    </div>
</div>
<!-- â–²â–²â–² HTMLæ›¿æ›çµæŸ â–²â–²â–² -->
    <!-- å…§å®¹é¡¯ç¤ºå€åŸŸ -->
    <div id="ls-content-area">
        <div id="ls-moments-view" class="ls-view active"><div id="ls-moments-list"></div><button id="ls-add-moment-btn" class="ls-fab-btn">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
    </svg>
</button>
</div>
        <div id="ls-album-view" class="ls-view">
    <div id="ls-album-list"></div>
    <button id="ls-add-album-btn" class="ls-fab-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        </svg>
    </button>
</div>

        <div id="ls-letters-view" class="ls-view">
    <div id="ls-letters-list"></div>
    <button id="ls-add-letter-btn" class="ls-fab-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        </svg>
    </button>
</div>

        <div id="ls-shares-view" class="ls-view"><div id="ls-shares-list"></div></div>
     <div id="ls-questions-view" class="ls-view">
    <div id="ls-questions-list"></div>
    <button id="ls-add-question-btn" class="ls-fab-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        </svg>
    </button>
</div>

        <!-- â–¼â–¼â–¼ åœ¨ id="ls-questions-view" çš„ div ä¹‹å¾Œï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div id="ls-diary-view" class="ls-view">
    <!-- æ—¥æ›†å’Œå¿ƒæƒ…ç½å­çš„å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
        <!-- â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘ç‚ºç•ªèŒ„é˜æº–å‚™çš„å…¨æ–°ä»‹é¢ â˜…â˜…â˜… -->
        <div id="ls-pomodoro-view" class="ls-view">
            <!-- ç•ªèŒ„é˜ä¸»é ï¼Œé¡¯ç¤ºæ­·å²è¨˜éŒ„å’Œé–‹å§‹æŒ‰éˆ• -->
            <div id="ls-pomodoro-home">
                <div id="ls-pomodoro-start-btn-container">
                    <div id="ls-pomodoro-start-icon">ï¼‹</div>
                    <p>é–‹å•Ÿæ–°çš„å°ˆæ³¨æ™‚å…‰</p>
                </div>
                <div id="ls-pomodoro-history-list">
                    <!-- æ­·å²è¨˜éŒ„æœƒç”±JSç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
            </div>
            <!-- æ­£åœ¨è¨ˆæ™‚çš„ä»‹é¢ï¼Œé è¨­éš±è— -->
            <div id="ls-pomodoro-timer-active" style="display: none;">
                <div class="pomodoro-char-avatar-container">
                    <img id="pomodoro-char-avatar" src="">
                    <div id="pomodoro-char-log"></div>
                </div>
                <div class="pomodoro-timer-display">
                    <div id="pomodoro-current-task"></div>
                    <div id="pomodoro-time">25:00</div>
                </div>
                <button id="pomodoro-end-btn">çµæŸå°ˆæ³¨</button>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>èŠå¤©è¨­ç½®</span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input">å‚™è¨»å / ç¾¤å</label><input type="text" id="chat-name-input"></div>

    <!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°ä»£ç¢¼é»è²¼åˆ°â€œå‚™è¨»åâ€è¼¸å…¥æ¡†çš„ form-group ä¹‹å¾Œ â–¼â–¼â–¼ -->
    <div class="form-group" id="assign-group-section" style="display: none;"> <!-- é è¨­éš±è—ï¼Œåªå°å–®èŠé¡¯ç¤º -->
        <label for="assign-group-select">å¥½å‹åˆ†çµ„</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="assign-group-select" style="flex-grow: 1;">
                <!-- åˆ†çµ„é¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </select>
            <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ç®¡ç†åˆ†çµ„</button>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

<div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç¨±</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>ç¾¤é ­åƒ</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">ä¸Šå‚³ç¾¤é ­åƒ</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="world-book-link-group">
                <label>é—œè¯ä¸–ç•Œæ›¸ (å¯å¤šé¸)</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- é»æ“Šé¸æ“‡ --</span>
                        <span class="arrow-down">â–¼</span>
                    </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container">
                    </div>
                </div>
            </div>
            <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¨˜æ†¶äº’é€šè¨­ç½® (æŒä¹…åŒ–é€£çµç‰ˆ) â–¼â–¼â–¼ -->
<div class="form-group" id="memory-link-group">
    <label>è¨˜æ†¶äº’é€š (é¸æ“‡è¦é€£çµçš„èŠå¤©)</label>
    
    <!-- è¤‡ç”¨ä¸–ç•Œæ›¸çš„å¤šé¸æ¡†æ¨£å¼ -->
    <div class="custom-multiselect" id="memory-link-multiselect">
        <div class="select-box">
            <span class="selected-options-text">-- é»æ“Šé¸æ“‡ --</span>
            <span class="arrow-down">â–¼</span>
        </div>
        <div id="memory-link-checkboxes-container" class="checkboxes-container">
            <!-- èŠå¤©é¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
    </div>
    
    <!-- æ–°å¢ï¼šè¨˜æ†¶æ¢æ•¸è¨­ç½® -->
    <div class="form-group" style="margin-top: 10px;">
        <label for="link-memory-depth-input" style="font-weight: normal; color: var(--text-secondary); font-size: 13px;">äº’é€šè¨˜æ†¶æ¢æ•¸ (AIæœƒçœ‹åˆ°å°æ–¹æœ€è¿‘çš„å¹¾æ¢æ¶ˆæ¯)</label>
        <input type="number" id="link-memory-depth-input" value="5" min="1" max="20" style="padding: 8px;">
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLä»£ç¢¼ï¼Œé»è²¼åˆ° <div id="chat-settings-modal"> çš„ <div class="modal-body"> å…§éƒ¨ï¼Œä¾‹å¦‚â€œèŠå¤©èƒŒæ™¯â€è¨­ç½®çš„ä¸Šæ–¹ â–¼â–¼â–¼ -->

<hr style="opacity: 0.2; margin: 20px 0;">

<!-- 1. ç·šä¸‹æ¨¡å¼ç¸½é–‹é—œ -->
<div class="form-group">
    <label for="offline-mode-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">
            é–‹å•Ÿç·šä¸‹æ¨¡å¼
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                é–‹å•Ÿå¾Œï¼ŒAIå°‡é»˜èªä½ å€‘ç·šä¸Šä¸‹è¦‹é¢ï¼Œä¸¦ä»¥å¤§æ®µæ•˜äº‹çš„æ–¹å¼é€²è¡Œå›æ‡‰ã€‚
            </p>
        </span>
        <input type="checkbox" id="offline-mode-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
</div>

<!-- 2. ç·šä¸‹æ¨¡å¼çš„è©³ç´°è¨­ç½® (é»˜èªéš±è—) -->
<div id="offline-mode-details" style="display: none; padding-left: 10px; border-left: 3px solid var(--accent-color); margin-top: 15px;">
    
    <!-- 2.1 é è¨­ç®¡ç† -->
    <div class="form-group">
        <label>ç·šä¸‹æ¨¡å¼é è¨­</label>
        <div class="bubble-preset-manager">
            <select id="offline-preset-select" class="form-group select"></select>
            <button id="manage-offline-presets-btn" class="action-btn">ç®¡ç†</button>
        </div>
    </div>
    
    <!-- 2.2 æç¤ºè©è¼¸å…¥ -->
    <div class="form-group">
        <label for="offline-prompt-input">è‡ªè¨‚æç¤ºè© (Prompt)</label>
        <textarea id="offline-prompt-input" rows="4" placeholder="ä¾‹å¦‚ï¼šä½ æ­£åœ¨ä¸€å®¶å®‰éœçš„å’–å•¡é¤¨è£¡å’Œç”¨æˆ¶ç´„æœƒ..."></textarea>
    </div>
    
    <!-- 2.3 æ–‡é¢¨è¼¸å…¥ -->
    <div class="form-group">
        <label for="offline-style-input">è‡ªè¨‚æ–‡é¢¨ (Style)</label>
        <textarea id="offline-style-input" rows="3" placeholder="ä¾‹å¦‚ï¼šè«‹ä½¿ç”¨ç¬¬ä¸‰äººç¨±ï¼Œè©³ç´°æå¯«è§’è‰²çš„å‹•ä½œã€ç¥æ…‹å’Œå¿ƒç†æ´»å‹•..."></textarea>
    </div>

    <!-- 2.4 å­—æ•¸è¨­ç½® -->
    <div class="form-group">
        <label for="offline-word-count-input">æœŸæœ›å›å¾©å­—æ•¸</label>
        <input type="number" id="offline-word-count-input" value="300" min="50" step="50">
    </div>

</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©ç¸½çµè¨­ç½®å€åŸŸ â–¼â–¼â–¼ -->
<hr style="opacity: 0.2; margin: 20px 0;">

<div class="form-group">
    <label for="summary-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">
            é–‹å•ŸèŠå¤©ç¸½çµ
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                é–‹å•Ÿå¾Œï¼ŒAIæœƒåœ¨å°è©±é”åˆ°ä¸€å®šé•·åº¦æ™‚è‡ªå‹•æˆ–æ‰‹å‹•é€²è¡Œç¸½çµï¼Œä½œç‚ºé•·æœŸè¨˜æ†¶ã€‚
            </p>
        </span>
        <input type="checkbox" id="summary-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
</div>

<div id="summary-details-container" style="display: none; padding-left: 10px; border-left: 3px solid var(--accent-color); margin-top: 15px;">
    <div class="form-group">
        <label>ç¸½çµæ¨¡å¼</label>
        <div style="display: flex; gap: 20px;">
            <label><input type="radio" name="summary-mode" value="auto" checked> è‡ªå‹•ç¸½çµ</label>
            <label><input type="radio" name="summary-mode" value="manual"> æ‰‹å‹•ç¸½çµ</label>
        </div>
    </div>
    <div class="form-group">
        <label for="summary-count-input">è§¸ç™¼æ¶ˆæ¯æ¢æ•¸</label>
        <input type="number" id="summary-count-input" value="20" min="5">
    </div>
    <div class="form-group">
        <label for="summary-prompt-input">ç¸½çµæç¤ºè© (Prompt)</label>
        <textarea id="summary-prompt-input" rows="4"></textarea>
    </div>
    <button id="view-summaries-btn" class="form-button form-button-secondary" style="margin-top: 10px;">æŸ¥çœ‹å’Œç®¡ç†ç¸½çµ</button>
        <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°æŒ‰éˆ• â–¼â–¼â–¼ -->
    <button id="manual-summary-btn" class="form-button form-button-secondary" style="margin-top: 10px;">ç«‹å³æ‰‹å‹•ç¸½çµ</button>
    <!-- â–²â–²â–² æ–°æŒ‰éˆ•é»è²¼çµæŸ â–²â–²â–² -->
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨ id="summary-details-container" çš„ </div> ä¹‹å¾Œé»è²¼ â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label style="margin-bottom: 0;">ç•¶å‰ç¸½èŠå¤©æ¢æ•¸</label>
    <span id="total-message-count-display" style="color: var(--text-secondary); font-weight: 500;">--</span>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–²â–²â–² æ–°å¢HTMLä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

            <div class="form-group" id="ai-persona-group"><label for="ai-persona">å°æ–¹äººè¨­ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div>
              <!-- â–¼â–¼â–¼ ç¬¬2æ­¥ ç¬¬2è™•ä¿®æ”¹ï¼ˆæ–°å¢HTMLï¼‰ â–¼â–¼â–¼ -->
            <div class="form-group" id="char-sticker-group">
                <button id="manage-char-stickers-btn" class="form-button form-button-secondary" style="width: 100%; margin-top: 5px;">
                    ç®¡ç†è§’è‰²è¡¨æƒ…åŒ…
                </button>
            </div>
            <!-- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² -->
            <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group" id="npc-library-group">
    <button id="manage-npcs-btn" class="form-button form-button-secondary" style="width: 100%; margin-top: 5px;">ç®¡ç†NPCåº«</button>
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group" id="minimax-voice-id-group">
    <label for="minimax-voice-id-input">Minimax èªéŸ³ID</label>
    <input type="text" id="minimax-voice-id-input" placeholder="ä¾‹å¦‚ï¼šmale-01">
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
 <!-- ã€å…¨æ–°ã€‘å¾®åšäººè¨­èˆ‡è·æ¥­è¨­ç½® -->
<div id="weibo-settings-for-user" style="display: none;">
    <hr style="opacity: 0.2; margin: 20px 0;">
    <div class="form-group">
        <label>æˆ‘çš„å¾®åšè¨­å®š</label>
        <div class="bubble-preset-manager">
            <select id="weibo-persona-preset-select" class="form-group select"></select>
            <button id="manage-weibo-presets-btn" class="action-btn">ç®¡ç†</button>
        </div>
    </div>
    <div class="form-group">
        <label for="weibo-user-profession-input">è·æ¥­ (é¡¯ç¤ºåœ¨æ˜µç¨±ä¸‹æ–¹)</label>
        <input type="text" id="weibo-user-profession-input" placeholder="ä¾‹å¦‚ï¼šè·æ¥­é›»ç«¶é¸æ‰‹ã€ç¾å¦åšä¸»">
    </div>
    <div class="form-group">
        <label for="weibo-user-persona-input">éš±è—äººè¨­ (åƒ…ä¾›AIåƒè€ƒ)</label>
        <textarea id="weibo-user-persona-input" rows="3" placeholder="ä¾‹å¦‚ï¼šæ€§æ ¼é«˜å†·ï¼Œå°‘èˆ‡ç²‰çµ²äº’å‹•ï¼Œåªå›å¾©è´ŠåŠ©å•†çš„è©•è«–ã€‚"></textarea>
    </div>
</div>
<!-- ã€å…¨æ–°ã€‘å¾®åšè¨­ç½®çµæŸ -->
 <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group" id="weibo-profession-group">
    <label for="weibo-profession-input">å¾®åšè·æ¥­</label>
    <input type="text" id="weibo-profession-input" placeholder="ä¾‹å¦‚ï¼šè·æ¥­é›»ç«¶é¸æ‰‹ã€ç¾å¦åšä¸»ã€æ¼”å“¡...">
</div>
<div class="form-group" id="weibo-instruction-group">
    <label for="weibo-instruction-input">å¾®åšæŒ‡ä»¤ (AIç™¼å¾®åš/è©•è«–æ™‚å°‡åš´æ ¼éµå®ˆ)</label>
    <textarea id="weibo-instruction-input" rows="3" placeholder="ä¾‹å¦‚ï¼šå¤šç™¼æ—¥å¸¸è¨“ç·´å’Œæ¯”è³½çš„å…§å®¹ï¼Œæ€§æ ¼é«˜å†·ï¼Œå°‘èˆ‡ç²‰çµ²äº’å‹•ï¼Œåªå›å¾©è´ŠåŠ©å•†çš„è©•è«–ã€‚"></textarea>
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ°â€œç®¡ç†NPCåº«â€æŒ‰éˆ•çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
<hr style="opacity: 0.2; margin: 20px 0;">
<div class="form-group">
    <label for="time-perception-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">å•Ÿç”¨å³æ™‚æ™‚é–“æ„ŸçŸ¥</span>
        <input type="checkbox" id="time-perception-toggle" checked>
        <span class="toggle-switch-slider"></span>
    </label>
</div>
<div id="custom-time-container" class="form-group" style="display: none;">
    <label for="custom-time-input">è‡ªè¨‚æ™‚é–“</label>
    <input type="datetime-local" id="custom-time-input" style="width: 95%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);">
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
<div class="form-group" id="ai-avatar-group"><label>å°æ–¹é ­åƒ</label>
  <!-- â–¼â–¼â–¼ æŠŠä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘ä»£ç¢¼ï¼Œé»è²¼åˆ° id="ai-avatar-group" çš„é‚£å€‹ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div class="form-group" id="video-call-settings-group">
    <hr style="opacity: 0.2; margin: 20px 0;">
    <label>è¦–é »é€šè©±ä»‹é¢è¨­ç½®</label>
    
    <!-- 1. åŠŸèƒ½é–‹é—œ -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span>å•Ÿç”¨è¦–è¦ºåŒ–ä»‹é¢</span>
        <label class="toggle-switch">
            <input type="checkbox" id="visual-video-call-switch">
            <span class="slider"></span>
        </label>
    </div>

    <!-- 2. åœ–ç‰‡ä¸Šå‚³å€ (é»˜èªéš±è—) -->
    <div id="video-call-image-uploads" style="display: none;">
        <div class="form-group">
            <label>å°æ–¹çš„è¦–é »ç•«é¢</label>
            <div class="avatar-upload">
                <img id="char-video-image-preview" style="border-radius: 8px; width: 80px; height: 142px;">
                <button onclick="document.getElementById('char-video-image-input').click()">ä¸Šå‚³åœ–ç‰‡</button>
                <input type="file" id="char-video-image-input" accept="image/*" hidden>
            </div>
        </div>
        <div class="form-group">
            <label>æˆ‘çš„è¦–é »ç•«é¢</label>
            <div class="avatar-upload">
                <img id="user-video-image-preview" style="border-radius: 8px; width: 80px; height: 142px;">
                <button onclick="document.getElementById('user-video-image-input').click()">ä¸Šå‚³åœ–ç‰‡</button>
                <input type="file" id="user-video-image-input" accept="image/*" hidden>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->

  <div class="avatar-upload">
    <img id="ai-avatar-preview">
    <button onclick="document.getElementById('ai-avatar-input').click()">ä¸Šå‚³å°æ–¹é ­åƒ</button>
    <button class="change-frame-btn" data-type="ai">æ›´æ›é ­åƒæ¡†</button>
    <button id="manage-ai-avatar-library-btn">ç®¡ç†é ­åƒåº«</button>
    <input type="file" id="ai-avatar-input" accept="image/*">
</div>
</div>
<!-- â–¼â–¼â–¼ æ­¥é©Ÿ1ï¼šåœ¨é€™è£¡é»è²¼æƒ…ä¾¶é ­åƒåŠŸèƒ½çš„æ–°HTMLä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="couple-avatar-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">æƒ…ä¾¶é ­åƒé–‹é—œ</span>
        <input type="checkbox" id="couple-avatar-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
    <div id="couple-avatar-desc-container" style="display: none; margin-top: 10px;">
         <label for="couple-avatar-description" style="font-size: 13px; color: var(--text-secondary);">æƒ…ä¾¶é ­åƒæè¿° (å¯é¸)</label>
         <input type="text" id="couple-avatar-description" placeholder="ä¾‹å¦‚ï¼šä¸€éš»å°è²“åœ¨çœ‹æœˆäº®">
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<div class="form-group" id="my-persona-group"><label for="my-persona">æˆ‘çš„äººè¨­ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>æˆ‘çš„é ­åƒ</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">ä¸Šå‚³æˆ‘çš„é ­åƒ</button>
<button class="change-frame-btn" data-type="my">æ›´æ›é ­åƒæ¡†</button> <!-- â† åŠ å›é€™ä¸€è¡Œ -->
<button id="open-persona-library-btn">é è¨­</button><input type="file" id="my-avatar-input" accept="image/*"></div></div><div class="form-group" id="group-members-group"><label>ç¾¤æˆå“¡äººè¨­</label><div id="group-members-settings"></div>


    <!-- ã€æ–°å¢ã€‘ç®¡ç†æˆå“¡æŒ‰éˆ• -->
    <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">ç®¡ç†ç¾¤æˆå“¡</button></div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤èŠå¾Œè‡ºæ´»å‹•è¨­ç½® â–¼â–¼â–¼ -->
<div class="form-group" id="group-background-activity-group" style="display: none;">
    <hr style="opacity: 0.2; margin: 20px 0;">
    <label class="toggle-switch-label">
        <span class="toggle-switch-text">
            ç¾¤èŠå¾Œè‡ºå³æ™‚æ´»å‹•
            <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
                è­¦å‘Šï¼šé–‹å•Ÿå¾Œæœƒå¢åŠ APIèª¿ç”¨å’Œè²»ç”¨ï¼
            </p>
        </span>
        <input type="checkbox" id="group-background-activity-switch">
        <span class="toggle-switch-slider"></span>
    </label>

    <div id="group-background-interval-settings" style="display: none; margin-top: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <label for="group-background-interval-input" style="margin-bottom: 0;">
                æ´»å‹•é–“éš”æœŸ (ç§’)
                <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                    å»ºè­°å€¼ 120-600ã€‚å€¼è¶Šå¤§ï¼Œè²»ç”¨è¶Šä½ï¼Œä½†ç¾¤å…§äº’å‹•è¶Šæ…¢ã€‚
                </p>
            </label>
            <input type="number" id="group-background-interval-input" min="60" value="120" style="width: 80px; text-align: center;">
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

<div class="form-group"><label for="max-memory">ä¸Šä¸‹æ–‡è¨˜æ†¶æ¢æ•¸</label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label>èŠå¤©æ°£æ³¡ä¸»é¡Œ <button id="reset-theme-btn" type="button">é‡ç½®</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> é»˜èª</label><label><input type="radio" name="theme-select" value="pink_blue"> ç²‰è—</label><label><input type="radio" name="theme-select" value="blue_white"> è—ç™½</label><label><input type="radio" name="theme-select" value="purple_yellow"> ç´«é»ƒ</label><label><input type="radio" name="theme-select" value="black_white"> é»‘ç™½</label><label><input type="radio" name="theme-select" value="yellow_white"> é»ƒç™½</label><label><input type="radio" name="theme-select" value="red_black"> ç´…é»‘</label><label><input type="radio" name="theme-select" value="blue_yellow"> è—é»ƒ</label><label><input type="radio" name="theme-select" value="pink_yellow"> ç²‰é»ƒ</label><label><input type="radio" name="theme-select" value="pink_purple"> ç²‰ç´«</label><label><input type="radio" name="theme-select" value="gray_white"> ç°ç™½</label><label><input type="radio" name="theme-select" value="blue_green"> è—ç¶ </label><label><input type="radio" name="theme-select" value="pink_white"> ç²‰ç™½</label><label><input type="radio" name="theme-select" value="pink_black"> ç²‰é»‘</label><label><input type="radio" name="theme-select" value="pink_green"> ç²‰ç¶ </label><label><input type="radio" name="theme-select" value="green_black"> ç¶ é»‘</label></div></div>

<!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°ä»£ç¢¼é»è²¼åˆ°â€œèŠå¤©æ°£æ³¡ä¸»é¡Œâ€çš„ form-group ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="font-size-slider">èŠå¤©å­—é«”å¤§å° <span id="font-size-value">13px</span></label>
    <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°£æ³¡æ¨£å¼é è¨­é¸æ“‡å™¨ (å·²æ·»åŠ å°å…¥åŒ¯å‡ºåŠŸèƒ½) â–¼â–¼â–¼ -->
<div class="form-group">
    <label>æ°£æ³¡æ¨£å¼é è¨­</label>
    <div class="bubble-preset-manager">
        <select id="bubble-style-preset-select" class="form-group select"></select>
        <button id="manage-bubble-presets-btn" class="action-btn">ç®¡ç†</button>
    </div>
    <!-- â–¼â–¼â–¼ é€™æ˜¯æˆ‘å€‘æ–°åŠ çš„å°å…¥å’ŒåŒ¯å‡ºæŒ‰éˆ• â–¼â–¼â–¼ -->
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button id="export-bubble-preset-btn" class="form-button form-button-secondary" style="flex:1; margin:0;">åŒ¯å‡ºæ°£æ³¡</button>
        <button id="import-bubble-preset-btn" class="form-button form-button-secondary" style="flex:1; margin:0;">å°å…¥æ°£æ³¡</button>
    </div>
    <input type="file" id="import-bubble-preset-input" accept=".json" style="display: none;">
    <!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°ä»£ç¢¼é»è²¼åˆ°â€œèŠå¤©å­—é«”å¤§å°â€çš„ form-group ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="custom-css-input">
        è‡ªè¨‚æ°£æ³¡æ¨£å¼ (CSS)
        <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">é‡ç½®</button>
    </label>
    <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/* ç¤ºä¾‹ï¼šç‚ºâ€œæˆ‘â€çš„æ°£æ³¡æ·»åŠ æ¼¸è®ŠèƒŒæ™¯å’Œé™°å½± */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°ä»£ç¢¼é»è²¼åˆ°è‡ªè¨‚CSSè¼¸å…¥æ¡†çš„ form-group ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div class="form-group">
    <label>å³æ™‚é è¦½</label>
    <div id="settings-preview-area">
        <!-- JSæœƒåœ¨é€™è£¡ç”Ÿæˆé è¦½å…§å®¹ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

            <div class="form-group">
                <label>èŠå¤©èƒŒæ™¯</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">ä¸Šå‚³èƒŒæ™¯åœ–</button>
                    <button type="button" id="remove-bg-btn">ç§»é™¤èƒŒæ™¯</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
<!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ°ä½ å‰›å‰›åˆªé™¤ä»£ç¢¼çš„ä½ç½® â–¼â–¼â–¼ -->

<!-- è¨˜éŒ„ç®¡ç†å€ -->
<div class="form-group" style="display: flex; gap: 10px;">
    <button class="form-button form-button-secondary" id="import-chat-history-btn" style="flex: 1; margin: 0;">å°å…¥èŠå¤©è¨˜éŒ„</button>
    <button class="form-button form-button-secondary" id="export-chat-history-btn" style="flex: 1; margin: 0;">åŒ¯å‡ºèŠå¤©è¨˜éŒ„</button>
</div>
<input type="file" id="import-chat-history-input" accept="application/json" style="display: none;">
<button class="form-button form-button-secondary" id="search-chat-btn">æŸ¥æ‰¾èŠå¤©è¨˜éŒ„</button>
<button class="form-button form-button-secondary" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è¨˜éŒ„</button>
<button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">æ‹‰é»‘å°æ–¹</button>

<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

</div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">å–æ¶ˆ</button><button class="save" id="save-chat-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>æˆ‘çš„äººè¨­åº«</span><button id="add-persona-preset-btn" class="action-button">æ·»åŠ </button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">é—œé–‰</button></div></div></div>
    
<!-- â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹æ›¿æ› â–¼â–¼â–¼ -->
<div id="persona-editor-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="persona-editor-title">æ·»åŠ äººè¨­é è¨­</span>
        </div>
        <div class="modal-body">
            <!-- ã€æ–°å¢ã€‘NPCåå­—è¼¸å…¥æ¡† -->
            <div class="form-group" id="npc-editor-name-group">
                <label for="npc-editor-name-input">NPC åå­—</label>
                <input type="text" id="npc-editor-name-input">
            </div>
            <div class="form-group">
                <label>é ­åƒ</label>
                <div class="avatar-upload">
                    <img id="preset-avatar-preview">
                    <button onclick="document.getElementById('preset-avatar-input').click()">ä¸Šå‚³é ­åƒ</button>
                    <!-- ã€æ–°å¢ã€‘çµ¦é€™å€‹æŒ‰éˆ•ä¸€å€‹IDï¼Œæ–¹ä¾¿æˆ‘å€‘æ§åˆ¶å®ƒ -->
                    <button id="persona-editor-change-frame-btn" class="change-frame-btn" data-type="member">æ›´æ›é ­åƒæ¡†</button>
                    <input type="file" id="preset-avatar-input" accept="image/*">
                </div>
            </div>
            <div class="form-group">
                <label for="preset-persona-input">äººè¨­</label>
                <textarea id="preset-persona-input" rows="4" placeholder="åœ¨æ­¤è¼¸å…¥é€™å€‹äººè¨­çš„è©³ç´°è¨­å®š..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-persona-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-persona-preset-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›åˆ°é€™è£¡çµæŸ â–²â–²â–² -->



    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ç·¨è¼¯ç¾¤æˆå“¡</span></div><div class="modal-body">
    <div class="form-group"><label for="member-name-input">åå­—</label><input type="text" id="member-name-input"></div>
    <div class="form-group"><label for="member-persona-input">äººè¨­</label><textarea id="member-persona-input" rows="4"></textarea></div>
    <div class="form-group"><label>é ­åƒ</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">ä¸Šå‚³é ­åƒ</button><input type="file" id="member-avatar-input" accept="image/*"></div></div>
    </div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">å–æ¶ˆ</button><button class="save" id="save-member-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">å–æ¶ˆ</button>
                <button id="custom-modal-confirm" class="confirm-btn">ç¢ºå®š</button>
            </div>
        </div>
    </div>


    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ç·¨è¼¯é è¨­</button>
                <button id="preset-action-delete" class="btn-danger">åˆªé™¤é è¨­</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">çµ¦Taä¸€å€‹é©šå–œï¼</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">è½‰å¸³é‡‘é¡</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999999999999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">å‚™è¨» (å¯é¸)</label>
                <input type="text" id="transfer-note" placeholder="ç•™ä¸‹ä½ çš„å°å¿ƒæ€~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">å–æ¶ˆ</button>
                <button id="transfer-confirm-btn">ç¢ºèªè½‰å¸³</button>
            </div>
        </div>
    </div>

 <div id="battery-alert-modal">
    <div class="battery-alert-content">
        <img id="battery-alert-image" src="">
        <p id="battery-alert-text"></p>
    </div>
</div>

    <audio id="audio-player" style="display:none;"></audio>
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œæ–°çš„éŸ³è¨Šå…ƒç´  â–¼â–¼â–¼ -->
<audio id="tts-audio-player" style="display:none;"></audio>
<!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->
<audio id="ringtone-player" loop></audio>
<audio id="notification-sound-player" preload="auto"></audio>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šå®Œæ•´ä»£ç¢¼ã€‘æ›¿æ›æ‰ä½ èˆŠçš„ id="create-post-modal" çš„æ•´å€‹ div â–¼â–¼â–¼ -->
<div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
        <div class="modal-header">
            <span id="create-post-modal-title">ç™¼ä½ˆå‹•æ…‹</span> <!-- ä½¿ç”¨IDæ–¹ä¾¿JSä¿®æ”¹æ¨™é¡Œ -->
        </div>
        <div class="modal-body">
            <!-- å…¬é–‹æ–‡å­—è¼¸å…¥å€ -->
            <div class="form-group">
                <textarea id="post-public-text" rows="3" placeholder="åˆ†äº«æ–°é®®äº‹..."></textarea>
            </div>

            <!-- === ã€æ–°å¢ã€‘æ¨¡å¼åˆ‡æ›é–‹é—œ === -->
            <div class="post-mode-switcher">
                <button id="switch-to-image-mode" class="mode-btn active">ä¸Šå‚³åœ–ç‰‡</button>
                <button id="switch-to-text-image-mode" class="mode-btn">ä½¿ç”¨æ–‡å­—åœ–</button>
            </div>

            <!-- === ã€æ–°å¢ã€‘åœ–ç‰‡æ¨¡å¼å€åŸŸ === -->
            <div id="image-mode-content" class="post-mode-content active">
                <div class="form-group">
                    <div id="post-image-preview-container" class="post-image-preview-container">
                        <img id="post-image-preview" src="" alt="åœ–ç‰‡é è¦½">
                        <button id="post-remove-image-btn">Ã—</button>
                    </div>
                    <div class="post-image-upload-options">
                        <button id="post-upload-local-btn" class="form-button-secondary">æœ¬åœ°ä¸Šå‚³</button>
                        <button id="post-use-url-btn" class="form-button-secondary">ç¶²è·¯URL</button>
                        <input type="file" id="post-local-image-input" accept="image/*" hidden>
                    </div>
                </div>
                <!-- é€™å€‹æ˜¯çµ¦AIçœ‹çš„åœ–ç‰‡æè¿°ï¼Œåœ¨å¾®åšæ¨¡å¼ä¸‹æˆ‘å€‘æœƒç”¨JSéš±è—å®ƒ -->
                <div id="post-image-desc-group" class="form-group" style="display: none;">
                    <label>åœ–ç‰‡æè¿° (å¿…å¡«ï¼Œçµ¦AIçœ‹)</label>
                    <input type="text" id="post-image-description" placeholder="ç°¡å–®æè¿°åœ–ç‰‡å…§å®¹ï¼Œèª¬æ˜AIç†è§£">
                </div>
            </div>

            <!-- === ã€æ–°å¢ã€‘æ–‡å­—åœ–æ¨¡å¼å€åŸŸ === -->
            <div id="text-image-mode-content" class="post-mode-content">
                <div class="form-group">
                    <label>æ–‡å­—åœ– (çµ¦AIç†è§£ç”¨çš„æè¿°ï¼Œé»æ“Šåœ–ç‰‡å¾Œå¯è¦‹)</label>
                    <textarea id="post-hidden-text" rows="4" placeholder="åœ¨é€™è£¡å¯«ä¸‹åœ–ç‰‡æè¿°..."></textarea>
                </div>
            </div>

<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group" id="post-visibility-group">
    <label>å¯è¦‹ç¯„åœ</label>
    <div style="display: flex; gap: 20px; margin-bottom: 10px;">
        <label><input type="radio" name="visibility" value="all" checked> æ‰€æœ‰äººå¯è¦‹</label>
        <label><input type="radio" name="visibility" value="groups"> åƒ…åˆ†çµ„å¯è¦‹</label>
    </div>
    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background-color: #f0f2f5; padding: 10px; border-radius: 8px;">
        <!-- åˆ†çµ„çš„å¤šé¸æ¡†æœƒç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->
            <!-- é€™å€‹æ˜¯å‹•æ…‹åŠŸèƒ½çš„è©•è«–é–‹é—œï¼Œåœ¨å¾®åšæ¨¡å¼ä¸‹æˆ‘å€‘æœƒç”¨JSéš±è—å®ƒ -->
            <div class="form-group" id="post-comments-toggle-group" style="margin-top: 15px;">
                <label for="post-comments-toggle" class="toggle-switch-label">
                    <span class="toggle-switch-text">å…è¨±è§’è‰²çœ‹è¦‹è©•è«–å€</span>
                    <input type="checkbox" id="post-comments-toggle" checked>
                    <span class="toggle-switch-slider"></span>
                </label>
            </div>
            
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-post-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-post-btn">ç™¼ä½ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ è«‹å°‡é€™å€‹æ–°çš„æ¨¡æ…‹æ¡†HTMLé»è²¼åˆ°æ‰€æœ‰å…¶ä»–æ¨¡æ…‹æ¡†ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div id="group-management-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†å¥½å‹åˆ†çµ„</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†çµ„</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-group-name-input" placeholder="è¼¸å…¥åˆ†çµ„å..." style="flex-grow: 1;">
                    <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†çµ„æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-group-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°HTMLé»è²¼åˆ°æ‰€æœ‰æ¨¡æ…‹æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <!-- æ–°çš„æ“ä½œæŒ‰éˆ• -->
            <button id="edit-message-btn">ç·¨è¼¯æ¶ˆæ¯</button>
            <button id="copy-message-btn">è¤‡è£½æ–‡æœ¬</button>
            <button id="recall-message-btn">æ’¤å›</button>
<button id="quote-message-btn">å¼•ç”¨</button>
            <button id="select-message-btn">é€²å…¥å¤šé¸</button>
            <!-- å–æ¶ˆæŒ‰éˆ• -->
            <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°HTMLé»è²¼åˆ°æ‰€æœ‰æ¨¡æ…‹æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="post-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <button id="edit-post-btn">ç·¨è¼¯å‹•æ…‹</button>
            <button id="copy-post-btn">è¤‡è£½å…§å®¹</button>           
            <button id="cancel-post-action-btn">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–è¦ºåŒ–æ¶ˆæ¯ç·¨è¼¯å™¨æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="message-editor-modal" class="modal">
    <div class="modal-content" style="height: 75%;">
        <div class="modal-header">
            <span>ç·¨è¼¯èˆ‡æ‹†åˆ†æ¶ˆæ¯</span>
        </div>
        <div class="modal-body" id="message-editor-body">
            <!-- ç·¨è¼¯å™¨å®¹å™¨ï¼ŒJSæœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆæ–‡å­—æ–¹å¡Š -->
            <div id="message-editor-container"></div>
            <!-- æ·»åŠ æ–°æ¶ˆæ¯çš„æŒ‰éˆ• -->
            <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;">
                [+] æ·»åŠ ä¸‹ä¸€æ¢æ¶ˆæ¯
            </button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-advanced-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-advanced-editor-btn">ä¿å­˜æ›´æ”¹</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£è«‹æ±‚æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="waimai-request-modal" class="modal">
    <div class="modal-content" style="width: 290px;">
        <div class="modal-header">
            <span>ç™¼èµ·å¤–è³£ä»£ä»˜</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="waimai-product-info">å•†å“è³‡è¨Š</label>
                <input type="text" id="waimai-product-info" placeholder="ä¾‹å¦‚ï¼šä¸€æ¯æ¥Šæç”˜éœ²">
            </div>
            <div class="form-group">
                <label for="waimai-amount">ä»£ä»˜é‡‘é¡ (å…ƒ)</label>
                <input type="number" id="waimai-amount" placeholder="ä¾‹å¦‚ï¼š21" min="0" step="0.01">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="waimai-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="waimai-confirm-btn">ç™¼èµ·è«‹æ±‚</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ–°å»ºç´„å®š/å€’è¨ˆæ™‚æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="create-countdown-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æ–°å»ºç´„å®š</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="countdown-title-input">ç´„å®šæ¨™é¡Œ</label>
                <input type="text" id="countdown-title-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç”Ÿæ—¥">
            </div>
            <div class="form-group">
                <label for="countdown-date-input">ç´„å®šæ—¥æœŸèˆ‡æ™‚é–“</label>
                <input type="datetime-local" id="countdown-date-input"style="width: 95%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-countdown-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-countdown-btn">ä¿å­˜ç´„å®š</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç™¼ç´…åŒ…æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="red-packet-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>ç™¼ç´…åŒ…</span>
        </div>
        <div class="modal-body" style="padding: 0;">
<!-- 1. é ç°½åˆ‡æ› -->
<div class="frame-tabs">
    <div id="rp-tab-group" class="frame-tab active">æ‹¼æ‰‹æ°£ç´…åŒ…</div>
    <div id="rp-tab-direct" class="frame-tab">å°ˆå±¬ç´…åŒ…</div>
</div>

            <!-- 2. æ‹¼æ‰‹æ°£ç´…åŒ…å…§å®¹å€ -->
            <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                <div class="form-group">
                    <label>ç¸½é‡‘é¡ (å…ƒ)</label>
                    <input type="number" id="rp-group-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>ç´…åŒ…å€‹æ•¸</label>
                    <input type="number" id="rp-group-count" placeholder="å¡«å¯«ç´…åŒ…å€‹æ•¸">
                </div>
                <div class="form-group">
                    <label>ç¥ç¦èª</label>
                    <input type="text" id="rp-group-greeting" placeholder="æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©ï¼">
                </div>
                <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                <button id="send-group-packet-btn" class="form-button">å¡éŒ¢é€²ç´…åŒ…</button>
            </div>

            <!-- 3. å°ˆå±¬ç´…åŒ…å…§å®¹å€ -->
            <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                <div class="form-group">
                    <label>ç™¼é€çµ¦</label>
                    <select id="rp-direct-receiver"></select>
                </div>
                <div class="form-group">
                    <label>é‡‘é¡ (å…ƒ)</label>
                    <input type="number" id="rp-direct-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>ç¥ç¦èª</label>
                    <input type="text" id="rp-direct-greeting" placeholder="æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©ï¼">
                </div>
                 <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                <button id="send-direct-packet-btn" class="form-button">å¡éŒ¢é€²ç´…åŒ…</button>
            </div>
        </div>
        <div class="modal-footer" style="justify-content: center;">
             <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…è©³æƒ…æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="red-packet-details-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
        <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
            <div style="text-align: center; width: 100%;">
                <div id="rp-details-sender" style="font-size: 16px;"></div>
                <div style="font-size: 13px; opacity: 0.8;">çš„ç´…åŒ…</div>
            </div>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
            <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                <span style="font-size: 18px; color: #E44D44;">å…ƒ</span>
            </div>
            <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
            <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                <!-- é ˜å–è©³æƒ…å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-rp-details-btn" style="width: 100%;">é—œé–‰</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‰µå»ºæŠ•ç¥¨æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="create-poll-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>ç™¼èµ·æŠ•ç¥¨</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="poll-question-input">æŠ•ç¥¨å•é¡Œ</label>
                <textarea id="poll-question-input" rows="2" placeholder="ä¾‹å¦‚ï¼šä»Šæ™šæˆ‘å€‘çœ‹ä»€éº¼é›»å½±ï¼Ÿ"></textarea>
            </div>
            <div class="form-group">
                <label>æŠ•ç¥¨é¸é … (è‡³å°‘2é …)</label>
                <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- æŠ•ç¥¨é¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
                <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ æ·»åŠ é¸é …</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-poll-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-poll-btn">ç™¼èµ·æŠ•ç¥¨</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIé ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="ai-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="ai-avatar-library-title">å°æ–¹çš„é ­åƒåº«</span>
            <button id="add-ai-avatar-btn" class="action-button">æ·»åŠ </button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                <!-- é ­åƒåº«å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä½¿ç”¨è€…åˆ†äº«é€£çµæ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="share-link-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>åˆ†äº«é€£çµ</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="link-title-input">æ¨™é¡Œ</label>
                <input type="text" id="link-title-input" placeholder="è¼¸å…¥æ–‡ç« æˆ–é€£çµçš„æ¨™é¡Œ">
            </div>
            <div class="form-group">
                <label for="link-description-input">æ‘˜è¦ (å¯é¸)</label>
                <textarea id="link-description-input" rows="2" placeholder="ç°¡å–®æè¿°ä¸€ä¸‹é€£çµå…§å®¹"></textarea>
            </div>
            <div class="form-group">
                <label for="link-source-input">ä¾†æºåç¨± (å¯é¸)</label>
                <input type="text" id="link-source-input" placeholder="ä¾‹å¦‚ï¼šçŸ¥ä¹æ—¥å ±ã€Bç«™">
            </div>
            <div class="form-group">
                <label for="link-content-input">å®Œæ•´å…§å®¹ (å¯é¸ï¼Œç”¨æ–¼æµè¦½å™¨å…§é¡¯ç¤º)</label>
                <textarea id="link-content-input" rows="4" placeholder="é»è²¼æˆ–è¼¸å…¥å®Œæ•´çš„æ–‡ç« å…§å®¹"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-link-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-share-link-btn">åˆ†äº«</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾ç·»ç‰ˆè½‰å¸³æ“ä½œå½ˆçª— â–¼â–¼â–¼ -->
<div id="transfer-actions-modal" class="modal">
    <div class="transfer-actions-content">
        <div class="transfer-actions-header">è«‹é¸æ“‡æ“ä½œ</div>
        <div class="transfer-actions-body">
            <p>ä½ æ”¶åˆ°äº†ä¾†è‡ª <strong id="transfer-sender-name"></strong> çš„ä¸€ç­†è½‰å¸³ã€‚</p>
        </div>
        <div class="transfer-actions-footer">
            <button id="transfer-action-decline" class="action-btn decline">æ®˜å¿æ‹’çµ•</button>
            <button id="transfer-action-accept" class="action-btn accept">é–‹å¿ƒæ”¶ä¸‹</button>
        </div>
        <button id="transfer-action-cancel" class="cancel-btn">Ã—</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè©±è¨˜éŒ„è©³æƒ…æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="call-transcript-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="transcript-modal-title">é€šè©±è©³æƒ…</span>
        </div>
        <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5;">
            <!-- é€šè©±æ–‡å­—è¨˜éŒ„å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">åˆªé™¤è¨˜éŒ„</button>
            <button class="save" id="close-transcript-modal-btn" style="width: 100%;">é—œé–‰</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«ç›®æ¨™é¸æ“‡å™¨æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="share-target-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
<div class="modal-header">
    <span id="share-target-modal-title">åˆ†äº«åˆ°...</span>
</div>
        <div class="modal-body" id="share-target-list" style="padding: 0;">
            <!-- èŠå¤©æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-target-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-share-target-btn">ç¢ºèªåˆ†äº«</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è¨˜éŒ„æª¢è¦–å™¨æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="shared-history-viewer-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="shared-history-viewer-title">èŠå¤©è¨˜éŒ„</span>
        </div>
        <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;">
            <!-- åˆ†äº«çš„èŠå¤©è¨˜éŒ„æ°£æ³¡å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-shared-history-viewer-btn" style="width:100%;">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œæ›¸åˆ†é¡ç®¡ç†æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="world-book-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†ä¸–ç•Œæ›¸åˆ†é¡</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†é¡</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-category-name-input" placeholder="è¼¸å…¥åˆ†é¡å..." style="flex-grow: 1;">
                    <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†é¡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²å°ˆå±¬NPCåº«ç®¡ç†ä»‹é¢ â–¼â–¼â–¼ -->
<div id="npc-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-npc-management">â€¹</span>
        <span id="npc-management-title">NPC åº«ç®¡ç†</span>
        <span class="action-btn" id="add-new-npc-btn">+</span>
    </div>
    <div class="list-container" id="npc-management-list">
        <!-- NPCæ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨é€™è£¡é»è²¼æ‰€æœ‰è«–å£‡ç›¸é—œçš„HTMLä»£ç¢¼ â–¼â–¼â–¼ -->

<!-- 1. è«–å£‡ä¸»è¢å¹• (é¡¯ç¤ºæ‰€æœ‰å°çµ„) -->
<div id="forum-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>åœˆå­</span>
        <div class="header-actions">
                  <!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ç¯©é¸åœ–ç¤º â–¼â–¼â–¼ -->
        <span class="action-btn filter-btn" id="forum-filter-btn" title="ç¯©é¸">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        </span>
        <!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->
            <span class="action-btn" id="create-group-btn" style="font-size: 28px; font-weight: 300;">+</span>
        </div>
    </div>
    <div id="forum-group-list" class="list-container" style="padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-content: start;">
        <!-- å°çµ„æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>

<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ id="group-screen" â–¼â–¼â–¼ -->
<div id="group-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-to-forum-list">â€¹</span>
        <span id="group-screen-title">å°çµ„åç¨±</span>
        <div class="header-actions">
                  <!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ç¯©é¸åœ–ç¤º â–¼â–¼â–¼ -->
        <span class="action-btn filter-btn" id="group-filter-btn" title="ç¯©é¸">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        </span>
        <!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘åœ¨é€™è£¡æ–°å¢äº†ä¸€å€‹é€šç”¨çš„â€œç”Ÿæˆå…§å®¹â€æŒ‰éˆ• -->
            <span class="action-btn" id="generate-group-content-btn" title="ç”Ÿæˆå…§å®¹">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
            </span>
            <span class="action-btn" id="create-forum-post-btn" style="font-size: 28px; font-weight: 300;">+</span>
        </div>
    </div>
<!-- â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ› â–¼â–¼â–¼ -->
<div id="fanfic-preference-bar" style="display: none; padding: 10px 15px; background-color: #f0f2f5; border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
    <div class="form-group" style="margin: 0;">
        <label style="font-size: 14px; margin-bottom: 5px;">é¸æ“‡CPåå¥½</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="fanfic-char1-select" style="flex: 1;"></select>
            <span>&</span>
            <select id="fanfic-char2-select" style="flex: 1;"></select>
            <button id="trigger-fanfic-generation-btn" class="form-button" style="margin: 0; padding: 10px 15px; width: auto;">ç”Ÿæˆ</button>
        </div>
    </div>
    <!-- é€™æ˜¯æˆ‘å€‘æ–°åŠ çš„ä¸–ç•Œè§€è¼¸å…¥æ¡† -->
    <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
        <label for="fanfic-worldview-input" style="font-size: 14px; margin-bottom: 5px;">ä¸–ç•Œè§€åå¥½ (å¯é¸)</label>
        <input type="text" id="fanfic-worldview-input" placeholder="ä¾‹å¦‚ï¼šABOã€å“¨å‘ã€ç¾ä»£å¤§å­¸AU...">
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

    <div id="group-post-list" class="list-container" style="padding-top: 0;">
        <!-- å¸–å­æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->


<!-- 3. å–®å€‹å¸–å­é é¢ (é¡¯ç¤ºå¸–å­å…§å®¹å’Œè©•è«–) -->
<div id="post-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-to-group-screen">â€¹</span>
        <span>å¸–å­è©³æƒ…</span>
        <div class="header-actions">
            <span class="action-btn" id="repost-to-chat-btn">è½‰è¼‰</span>
        </div>
    </div>
    <div id="post-detail-content" class="list-container" style="padding: 20px;">
        <!-- å¸–å­å’Œè©•è«–å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
    <!-- å¸–å­é çš„è©•è«–è¼¸å…¥æ¡† -->
    <div id="post-comment-input-area" class="chat-input-area" style="visibility: visible;">
         <div class="chat-input-main-row">
            <textarea id="post-comment-input" rows="1" placeholder="ç™¼ä½ˆä½ çš„è©•è«–..."></textarea>
            <button id="send-post-comment-btn" class="action-button">ç™¼é€</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºåœˆå­åˆ†é¡ç¯©é¸æ–°å¢çš„å½ˆçª— â–¼â–¼â–¼ -->
<div id="forum-filter-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 60%;">
        <div class="modal-header">
            <span>æŒ‰åˆ†é¡ç¯©é¸</span>
        </div>
        <div class="modal-body">
            <div id="forum-filter-category-list">
                <!-- åˆ†é¡æ¨™ç±¤å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
        </div>
        <div class="modal-footer" style="justify-content: space-between;">
            <button class="cancel" id="reset-forum-filter-btn" style="width: 30%;">é‡ç½®</button>
            <button class="cancel" id="cancel-forum-filter-btn" style="width: 30%;">å–æ¶ˆ</button>
            <button class="save" id="apply-forum-filter-btn" style="width: 30%;">æ‡‰ç”¨</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->


<!-- â–²â–²â–² è«–å£‡ç›¸é—œHTMLä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è‡ªè¨‚é ­åƒæ¡†ç®¡ç†æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="custom-frame-manager-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>ç®¡ç†æˆ‘çš„é ­åƒæ¡†</span>
            <button id="upload-custom-frame-btn" class="action-button">ä¸Šå‚³</button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="custom-frame-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                <!-- è‡ªè¨‚é ­åƒæ¡†å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-frame-manager-btn" style="width: 100%;">é—œé–‰</button>
        </div>
    </div>
</div>
<input type="file" id="custom-frame-upload-input" accept="image/png, image/gif" hidden multiple>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å·²ä¿®æ”¹ã€‘é ­åƒæ¡†é¸æ“‡æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="avatar-frame-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>é¸æ“‡é ­åƒæ¡†</span>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘åœ¨é€™é‡ŒåŠ ä¸€å€‹â€œç®¡ç†â€æŒ‰éˆ• -->
            <button id="manage-custom-frames-btn" class="action-button">ç®¡ç†</button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸å†éœ€è¦Tabsï¼Œåªæœ‰ä¸€å€‹Grid -->
            <div id="avatar-frame-grid" class="frame-grid">
                <!-- é ­åƒæ¡†é¸é …ï¼ˆåŒ…æ‹¬â€œç„¡â€å’Œè‡ªè¨‚çš„ï¼‰æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-frame-settings-btn">å–æ¶ˆ</button>
            <button class="save" id="save-frame-settings-btn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€å…¨æ–°è¨­è¨ˆã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ id="send-location-modal" â–¼â–¼â–¼ -->
<div id="send-location-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>ç™¼é€å®šä½èˆ‡è»Œè·¡</span>
        </div>
        <div class="modal-body" style="padding-bottom: 5px;">
            <!-- æ ¸å¿ƒè³‡è¨Š -->
            <div class="form-group">
                <label for="user-location-input">æˆ‘çš„ä½ç½® (èµ·é»)</label>
                <input type="text" id="user-location-input" placeholder="ä¾‹å¦‚ï¼šå¸‚ä¸­å¿ƒçš„å’–å•¡é¤¨">
            </div>
            <div class="form-group">
                <label for="ai-location-input">Taçš„ä½ç½® (çµ‚é»)</label>
                <input type="text" id="ai-location-input" placeholder="ä¾‹å¦‚ï¼šæµ·é‚Šçš„ç‡ˆå¡”">
            </div>
            <div class="form-group">
                <label for="distance-input">ç›¸è·</label>
                <input type="text" id="distance-input" placeholder="ä¾‹å¦‚ï¼šç´„5å…¬é‡Œ (å¿…å¡«)">
            </div>
            
            <hr style="opacity: 0.2;">

            <!-- ã€å…¨æ–°ã€‘è¡Œå‹•è»Œè·¡è¼¸å…¥å€ -->
            <div class="form-group">
                <label>è¡Œå‹•è»Œè·¡ (å¯é¸ï¼ŒæŒ‰é †åºå¡«å¯«)</label>
                <div id="trajectory-points-container" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- JSæœƒåœ¨é€™è£¡å‹•æ…‹æ·»åŠ è¼¸å…¥æ¡† -->
                </div>
                <button id="add-trajectory-point-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ æ·»åŠ é€”ç¶“é»</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="location-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="location-confirm-btn">ç™¼é€</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é»è²¼æ‡¸æµ®æ­Œè©æ¬„è¨­ç½®æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="lyrics-settings-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æ‡¸æµ®æ­Œè©è¨­ç½®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="lyrics-font-size-slider">å­—é«”å¤§å°: <span id="lyrics-font-size-value">14px</span></label>
                <input type="range" id="lyrics-font-size-slider" min="12" max="24" value="14" style="width: 100%;">
            </div>
            <div class="form-group">
                <label for="lyrics-bg-opacity-slider">èƒŒæ™¯ä¸é€æ˜åº¦: <span id="lyrics-bg-opacity-value">0%</span></label>
                <input type="range" id="lyrics-bg-opacity-slider" min="0" max="100" value="0" style="width: 100%;">
            </div>
            <div class="form-group">
                <label for="lyrics-font-color-picker">å­—é«”é¡è‰²</label>
                <input type="color" id="lyrics-font-color-picker" value="#FFFFFF" style="width: 100%; height: 40px;">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="reset-lyrics-settings-btn">æ¢å¾©é»˜èª</button>
            <button class="save" id="close-lyrics-settings-btn">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯â€œé¸æ“‡æœç´¢æºâ€çš„å½ˆçª—ï¼Œè«‹é»è²¼åˆ°bodyæœ«å°¾ â–¼â–¼â–¼ -->
<div id="music-source-selector-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>é¸æ“‡æœç´¢æº</span>
        </div>
        <div class="modal-body" style="text-align: left; padding: 20px;">
            <label style="display: block; margin-bottom: 15px; cursor: pointer;">
                <input type="radio" name="search-source" value="all" checked> å…¨éƒ¨ä¾†æº (ç¶²æ˜“é›² + QQéŸ³æ¨‚)
            </label>
            <label style="display: block; margin-bottom: 15px; cursor: pointer;">
                <input type="radio" name="search-source" value="netease"> åƒ…ç¶²æ˜“é›²éŸ³æ¨‚
            </label>
            <label style="display: block; cursor: pointer;">
                <input type="radio" name="search-source" value="tencent"> åƒ…QQéŸ³æ¨‚
            </label>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-source-select-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-source-select-btn">é–‹å§‹æœç´¢</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å¾®åšé—œæ³¨åˆ—è¡¨çš„å½ˆçª—ï¼Œé»è²¼åˆ° </body> å‰é¢ â–¼â–¼â–¼ -->
<div id="weibo-following-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é—œæ³¨åˆ—è¡¨</span>
        </div>
        <div class="modal-body" style="padding: 0;">
            <!-- ã€æ ¸å¿ƒã€‘é€™å€‹å®¹å™¨å°‡å¸¶æ²è»¸ -->
            <div id="weibo-following-list-container">
                <!-- é—œæ³¨æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-following-list-btn" style="width: 100%;">é—œé–‰</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
<!-- å¡”ç¾…ç‰Œå åœä¸»æ¨¡æ…‹æ¡† -->
<div id="tarot-divination-modal" class="modal">
    <div class="modal-content" style="height: 85%; width: 95%;">
        
        <!-- 1. å åœè¨­ç½®ä»‹é¢ -->
        <div id="tarot-setup-view">
            <div class="modal-header">
                <span>å¡”ç¾…ç‰Œå åœ</span>
                <div>
                    <span id="tarot-history-btn" class="action-btn" style="font-size: 16px;">æ­·å²</span>
                    <span id="close-tarot-modal-btn" class="action-btn" style="font-size: 16px;">é—œé–‰</span>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="tarot-question-input">æ‚¨çš„å•é¡Œæˆ–é—œæ³¨é»</label>
                    <textarea id="tarot-question-input" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘è¿‘æœŸçš„æ¡ƒèŠ±é‹å¦‚ä½•ï¼Ÿ"></textarea>
                </div>
                <div class="form-group">
                    <label for="tarot-spread-select">é¸æ“‡ç‰Œé™£</label>
                    <select id="tarot-spread-select">
                        <option value="single">å–®å¼µç‰Œ - å¿«é€ŸæŒ‡å¼•</option>
                        <option value="three_past_present_future">ä¸‰å¼µç‰Œ - éå»/ç¾åœ¨/æœªä¾†</option>
                        <option value="three_situation_challenge_advice">ä¸‰å¼µç‰Œ - æƒ…å¢ƒ/æŒ‘æˆ°/å»ºè­°</option>
                        <option value="celtic_cross">å‡±çˆ¾ç‰¹åå­— - æ·±åº¦åˆ†æ (10å¼µç‰Œ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç‰Œé¢æ–¹å‘</label>
                    <div style="display: flex; gap: 20px;">
                        <label><input type="radio" name="tarot-orientation" value="upright" checked> åƒ…æ­£ä½</label>
                        <label><input type="radio" name="tarot-orientation" value="reversed"> åŒ…å«é€†ä½</label>
                    </div>
                </div>
                <button id="draw-tarot-cards-btn" class="form-button" style="margin-top: 20px;">æ´—ç‰Œä¸¦æŠ½ç‰Œ</button>
            </div>
        </div>

        <!-- 2. å åœçµæœä»‹é¢ (é è¨­éš±è—) -->
        <div id="tarot-result-view" style="display: none; height: 100%; display: flex; flex-direction: column;">
            <div class="modal-header">
                <span id="back-to-tarot-setup-btn" class="action-btn" style="font-size: 16px;">è¿”å›</span>
                <span>å åœçµæœ</span>
            </div>
            <div class="modal-body" id="tarot-result-display">
                <!-- çµæœå°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
            <div class="modal-footer">
                <button id="send-tarot-result-btn" class="save" style="width: 100%;">ç™¼çµ¦å¡”ç¾…å¸«è§£è®€</button>
            </div>
        </div>

        <!-- 3. æ­·å²è¨˜éŒ„ä»‹é¢ (é è¨­éš±è—) -->
        <div id="tarot-history-view" style="display: none; height: 100%; display: flex; flex-direction: column;">
            <div class="modal-header">
                <span id="back-to-tarot-main-btn" class="action-btn" style="font-size: 16px;">è¿”å›</span>
                <span>å åœæ­·å²</span>
            </div>
            <div class="modal-body" id="tarot-history-list">
                <!-- æ­·å²è¨˜éŒ„å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™è£¡æ˜¯æ•´å€‹æƒ…ä¾¶ç©ºé–“åŠŸèƒ½çš„HTMLä»£ç¢¼ â–¼â–¼â–¼ -->
<!-- 2. åˆ‡æ›è§’è‰²çš„å½ˆçª— -->
<div id="ls-char-selector-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é¸æ“‡ç©ºé–“</span>
        </div>
        <div class="modal-body" id="ls-char-selector-list" style="padding: 0;">
            <!-- è§’è‰²æ¸…å–®æœƒç”±JSå‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-switch-char-btn" style="width:100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- 3. ç™¼ä½ˆèªªèªªçš„å½ˆçª— -->
<div id="ls-create-moment-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æƒ³å°Taèªª...</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <textarea id="ls-moment-content-input" rows="5" placeholder="åœ¨é€™è£¡å¯«ä¸‹ä½ å€‘çš„ç§å¯†è©±èª..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-moment-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-confirm-moment-btn">ç™¼ä½ˆ</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ ls-create-album-modal â–¼â–¼â–¼ -->
<!-- 4. å‰µå»ºç›¸å†Š/ä¸Šå‚³ç…§ç‰‡çš„å½ˆçª— (é€™æ˜¯ä¿®æ”¹å¾Œçš„ç‰ˆæœ¬) -->
<div id="ls-create-album-modal" class="modal">
     <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <!-- æ¨™é¡Œå·²ä¿®æ”¹ -->
            <span id="ls-album-modal-title">ä¸Šå‚³ç…§ç‰‡</span>
        </div>
        <div class="modal-body">
            <!-- æ–°å¢ï¼šæ¨¡å¼åˆ‡æ›é–‹é—œ (è¤‡ç”¨å‹•æ…‹çš„æ¨£å¼) -->
            <div class="post-mode-switcher">
                <button id="ls-switch-to-image-mode" class="mode-btn active">ä¸Šå‚³åœ–ç‰‡</button>
                <button id="ls-switch-to-text-image-mode" class="mode-btn">ä½¿ç”¨æ–‡å­—åœ–</button>
            </div>

            <!-- æ¨¡å¼1: ä¸Šå‚³åœ–ç‰‡ -->
            <div id="ls-image-mode-content" class="post-mode-content active">
                <div class="form-group">
                    <label>é¸æ“‡ç…§ç‰‡ (åƒ…é™å–®å¼µ)</label>
                    <div id="ls-photo-preview-container"></div>
                    <button class="form-button form-button-secondary" id="ls-select-photos-btn">é¸æ“‡ç…§ç‰‡</button>
                    <!-- é—œéµï¼šé€™è£¡çš„ input ç§»é™¤äº† multiple å±¬æ€§ï¼Œç¾åœ¨åªèƒ½å–®é¸ -->
                    <input type="file" id="ls-photo-input" accept="image/*" hidden>
                </div>
                 <div class="form-group">
                    <label>åœ–ç‰‡æè¿° (å¿…å¡«)</label>
                    <textarea id="ls-photo-desc-input" rows="3" placeholder="ç‚ºé€™å¼µç…§ç‰‡å¯«ä¸‹æ³¨è…³..."></textarea>
                </div>
            </div>

            <!-- æ¨¡å¼2: ä½¿ç”¨æ–‡å­—åœ– -->
            <div id="ls-text-image-mode-content" class="post-mode-content" style="display: none;">
                <div class="form-group">
                    <label>æ–‡å­—åœ–æè¿° (å¿…å¡«)</label>
                    <textarea id="ls-text-image-desc-input" rows="5" placeholder="åœ¨é€™è£¡å¯«ä¸‹ä½ çš„å¿ƒæƒ…æˆ–æ•…äº‹..."></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-album-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-confirm-album-btn">ç¢ºèªä¸Šå‚³</button>
        </div>
    </div>
</div><!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLä»£ç¢¼ï¼Œé»è²¼åˆ° </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-å¯«æƒ…æ›¸/å›ä¿¡çš„å½ˆçª— -->
<div id="ls-create-letter-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span id="ls-letter-modal-title">çµ¦Taå¯«ä¸€å°ä¿¡</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="ls-letter-recipient-input">æ”¶ä¿¡äºº</label>
                <!-- æ”¶ä¿¡äººé€šå¸¸æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘å€‘ç¦ç”¨é€™å€‹è¼¸å…¥æ¡† -->
                <input type="text" id="ls-letter-recipient-input" disabled>
            </div>
            <div class="form-group">
                <label for="ls-letter-content-input">æƒ…æ›¸å…§å®¹</label>
                <textarea id="ls-letter-content-input" rows="8" placeholder="åœ¨é€™è£¡å¯«ä¸‹ä½ çš„å¿ƒæ„..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-letter-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-confirm-letter-btn">å¯„å‡º</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLä»£ç¢¼ï¼Œé»è²¼åˆ° </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘æƒ…ä¾¶ç©ºé–“-æƒ…æ›¸æª¢è¦–å™¨ -->
<div id="ls-letter-viewer-modal" class="modal">
    <div class="ls-letter-viewer-content">
        <!-- é ­éƒ¨ï¼šæ”¶ä¿¡äººä¿¡æ¯ -->
        <div class="letter-viewer-header">
            <img id="ls-viewer-recipient-avatar" class="meta-avatar">
            <div class="recipient-info">
                <div class="label">To my dear:</div>
                <div id="ls-viewer-recipient-name" class="name"></div>
            </div>
        </div>
        <!-- ä¸­é–“ï¼šä¿¡ä»¶æ­£æ–‡ -->
        <div id="ls-viewer-body" class="letter-viewer-body">
            <!-- JSæœƒåœ¨é€™è£¡å¡«å……ä¿¡ä»¶å…§å®¹ -->
        </div>
        <!-- åº•éƒ¨ï¼šç™¼ä¿¡äººè³‡è¨Šå’Œæ“ä½œæŒ‰éˆ• -->
        <div class="letter-viewer-footer">
            <div class="sender-info">
                <div id="ls-viewer-sender-name"></div>
                <div id="ls-viewer-timestamp" class="timestamp"></div>
            </div>
            <div class="letter-actions">
                <button id="ls-close-letter-viewer-btn">é—œé–‰</button>
                <button id="ls-reply-letter-btn" class="primary">å›ä¿¡</button>
            </div>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“è¨­ç½®å½ˆçª— â–¼â–¼â–¼ -->
<div id="ls-settings-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æƒ…ä¾¶ç©ºé–“è¨­ç½®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="ls-start-date-input">æˆ‘å€‘åœ¨ä¸€èµ·çš„ç¬¬ä¸€å¤©</label>
                <input type="date" id="ls-start-date-input" style="width: 100%; padding: 10px; box-sizing: border-box;">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-settings-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-settings-save-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLä»£ç¢¼ï¼Œé»è²¼åˆ° </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æå•å½ˆçª— -->
<div id="ls-ask-question-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>ç™¼èµ·ä¸€å€‹æå•</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <textarea id="ls-question-content-input" rows="5" placeholder="å‘Taæå€‹å•é¡Œå§..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-ask-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-confirm-ask-btn">å‘Taæå•</button>
        </div>
    </div>
</div>

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-å›ç­”å½ˆçª— -->
<div id="ls-answer-question-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>å›ç­”Taçš„å•é¡Œ</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>å•é¡Œï¼š</label>
                <p id="ls-answer-question-text" style="background-color: #f0f2f5; padding: 10px; border-radius: 8px;"></p>
            </div>
            <div class="form-group">
                <label for="ls-answer-content-input">ä½ çš„å›ç­”ï¼š</label>
                <textarea id="ls-answer-content-input" rows="5" placeholder="èªçœŸå›ç­”å“¦..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-answer-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-confirm-answer-btn">ç¢ºèªå›ç­”</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æƒ…ä¾¶ç©ºé–“å°ˆå±¬éŸ³æ¨‚æ’­æ”¾æ©Ÿçš„HTMLä»£ç¢¼ â–¼â–¼â–¼ -->

<!-- 1. é€™æ˜¯æ’­æ”¾æ©Ÿå°ˆå±¬çš„éŸ³è¨Šå¼•æ“ -->
<audio id="ls-audio-player" style="display:none;"></audio>

<!-- 2. é€™æ˜¯æ’­æ”¾æ©Ÿçš„ä¸»è¦–çª—ä»‹é¢ -->
<div id="ls-music-player-overlay" class="modal">
    <div class="music-player-window">
<!-- ã€å…¨æ–°ã€‘å°é¢å’Œæ­Œè©çš„åˆ‡æ›å®¹å™¨ -->
<div id="ls-display-area" style="width: 192px; height: 192px; margin-bottom: 20px; cursor: pointer;">
    <!-- æ­Œæ›²å°é¢ -->
    <img id="ls-album-cover" src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png" alt="æ­Œæ›²å°é¢" style="width: 100%; height: 100%; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
    
    <!-- æ­Œè©å®¹å™¨ -->
    <div id="ls-lyrics-container" style="display: none; width: 100%; height: 100%; overflow: hidden; text-align: center; color: #333; font-weight: 500;">
        <div id="ls-lyrics-list" style="transition: transform 0.5s ease;">
             <!-- æ­Œè©æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
    </div>
</div>

        <!-- æ­Œæ›²ä¿¡æ¯ -->
        <div id="ls-song-title" style="font-size: 18px; font-weight: 600;">æš«ç„¡æ­Œæ›²</div>
        <div id="ls-artist" style="font-size: 14px; color: #666; margin-bottom: 15px;">...</div>
        
        <!-- é€²åº¦æ¢ -->
        <div class="music-progress-bar-container" style="width: 100%;">
            <div id="ls-current-time" class="time-display">0:00</div>
            <div class="progress-bar" id="ls-progress-bar">
                <div id="ls-progress-fill" class="progress-bar-fill"></div>
            </div>
            <div id="ls-total-time" class="time-display">0:00</div>
        </div>
        
        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="music-controls" style="margin-bottom: 15px;">
            <button id="ls-prev-btn">â—€</button>
            <button id="ls-play-pause-btn" class="play-pause-btn">â–¶</button>
            <button id="ls-next-btn">â–¶</button>
        </div>
        
        <!-- åº•éƒ¨æ“ä½œæŒ‰éˆ• -->
        <div class="music-bottom-actions" style="width: 100%;">
            <button id="ls-playlist-btn" style="background-color: rgba(0, 123, 255, 0.1); color: var(--accent-color); margin-right: 5px;">æ’­æ”¾æ¸…å–®</button>
            <button id="ls-close-player-btn" style="background-color: rgba(0,0,0,0.05); color: #333; margin-left: 5px;">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- 3. é€™æ˜¯æ’­æ”¾æ¸…å–®çš„å´æ»‘é¢æ¿ -->
<div id="ls-music-playlist-panel" class="music-playlist-panel">
    <div class="playlist-header">
        <span class="panel-btn" id="ls-close-playlist-btn">è¿”å›</span>
        <span>æ’­æ”¾æ¸…å–®</span>
        <span class="panel-btn" id="ls-clear-playlist-btn" style="color: #ff3b30;">æ¸…ç©º</span>
    </div>
    <div class="playlist-body" id="ls-playlist-body">
        <!-- æ’­æ”¾æ¸…å–®å…§å®¹æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
    </div>
</div>

<!-- â–²â–²â–² HTMLä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLä»£ç¢¼ï¼Œé»è²¼åˆ° </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç•ªèŒ„é˜-è¨­ç½®å½ˆçª— -->
<div id="ls-pomodoro-setup-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æ–°çš„å°ˆæ³¨æ™‚å…‰</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="pomodoro-task-input">å°ˆæ³¨ä»»å‹™</label>
                <input type="text" id="pomodoro-task-input" placeholder="ä¾‹å¦‚ï¼šå­¸ç¿’JSã€å®Œæˆå·¥ä½œå ±å‘Š">
            </div>
            <div class="form-group">
                <label for="pomodoro-duration-input">å°ˆæ³¨æ™‚é•· (åˆ†é˜)</label>
                <input type="number" id="pomodoro-duration-input" value="25" min="1">
            </div>
<div class="form-group">
    <label>è¨ˆæ™‚æ¨¡å¼</label>
    <div style="display: flex; gap: 20px;">
        <label><input type="radio" name="pomodoro-mode" value="countdown" checked> å€’è¨ˆæ™‚</label>
        <label><input type="radio" name="pomodoro-mode" value="countup"> æ­£è¨ˆæ™‚</label>
    </div>
</div>
            <div class="form-group">
                <label for="pomodoro-talk-interval-input">è§’è‰²é¼“å‹µé–“éš” (åˆ†é˜, 0ç‚ºä¸è‡ªå‹•é¼“å‹µ)</label>
                <input type="number" id="pomodoro-talk-interval-input" value="5" min="0">
            </div>
<!-- â–¼â–¼â–¼ é€™æ˜¯ä¿®æ”¹å¾Œçš„ç•ªèŒ„é˜èƒŒæ™¯è¨­ç½® â–¼â–¼â–¼ -->
<div class="form-group">
    <label>è‡ªè¨‚èƒŒæ™¯ (å¯é¸)</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="pomodoro-bg-url-input" placeholder="é»è²¼åœ–ç‰‡URL" style="flex-grow: 1;">
        <button id="pomodoro-bg-local-upload-btn" class="form-button-secondary" style="margin: 0; padding: 12px; width: auto;">æœ¬åœ°ä¸Šå‚³</button>
    </div>
    <input type="file" id="pomodoro-bg-file-input" accept="image/*" hidden>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="pomodoro-cancel-setup-btn">å–æ¶ˆ</button>
            <button class="save" id="pomodoro-confirm-setup-btn">é–‹å§‹å°ˆæ³¨</button>
        </div>
    </div>
</div>

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç•ªèŒ„é˜-æ­·å²è©³æƒ…å½ˆçª— -->
<div id="ls-pomodoro-history-viewer-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="pomodoro-history-viewer-title">å°ˆæ³¨è¨˜éŒ„</span>
        </div>
        <div class="modal-body" id="pomodoro-history-viewer-content">
            <!-- èŠå¤©è¨˜éŒ„æœƒç”±JSç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="pomodoro-close-history-viewer-btn" style="width:100%;">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

<!-- â–²â–²â–² æƒ…ä¾¶ç©ºé–“HTMLä»£ç¢¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œåœˆå­â€åŠŸèƒ½æ–°å¢çš„æ‰€æœ‰å½ˆçª— â–¼â–¼â–¼ -->

<!-- 1. å°çµ„ç·¨è¼¯å™¨å½ˆçª— (ç”¨æ–¼ä¿®æ”¹å°çµ„è³‡è¨Šå’Œä¸–ç•Œè§€) -->
<div id="forum-group-editor-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>ç·¨è¼¯å°çµ„è³‡è¨Š</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="group-editor-name-input">å°çµ„åç¨±</label>
                <input type="text" id="group-editor-name-input">
            </div>
            <div class="form-group">
                <label for="group-editor-desc-input">å°çµ„ç°¡ä»‹</label>
                <input type="text" id="group-editor-desc-input">
            </div>
            <div class="form-group">
                <label for="group-editor-icon-input">å°çµ„åœ–ç¤º (Emoji)</label>
                <input type="text" id="group-editor-icon-input" maxlength="2">
            </div>
            <div class="form-group">
                <label for="group-editor-categories-input">å°çµ„åˆ†é¡ (ç”¨#è™Ÿåˆ†éš”, ä¾‹å¦‚: #ç§‘å¹» #æœªä¾†)</label>
                <input type="text" id="group-editor-categories-input" placeholder="ä¾‹å¦‚: #ç§‘å¹» #æœªä¾†">
            </div>
            <div class="form-group">
                <label for="group-editor-worldview-input">å°çµ„ä¸–ç•Œè§€ (ä¾›AIç”Ÿæˆå…§å®¹æ™‚åƒè€ƒ)</label>
                <textarea id="group-editor-worldview-input" rows="5" placeholder="è©³ç´°æè¿°é€™å€‹å°çµ„ç¨ç‰¹çš„èƒŒæ™¯è¨­å®š..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-group-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-group-editor-btn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- 2. åˆ†é¡ç®¡ç†å½ˆçª— -->
<div id="forum-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†åœˆå­åˆ†é¡</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†é¡</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-forum-category-name-input" placeholder="è¼¸å…¥åˆ†é¡åï¼Œç„¡éœ€å¸¶'#'..." style="flex-grow: 1;">
                    <button id="add-new-forum-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-forum-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†é¡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-forum-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯éŠæˆ²å¤§å»³çš„ä¸»ä»‹é¢ï¼Œé»è²¼åˆ°æ‰€æœ‰ modal çš„ div ä¹‹å¾Œã€<script> æ¨™ç±¤ä¹‹å‰ â–¼â–¼â–¼ -->
<div id="game-hall-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>éŠæˆ²å¤§å»³</span>
        <span style="width: 30px;"></span> <!-- é ç•™ä½ç½® -->
    </div>
    <div class="list-container" style="padding: 20px;">
        <p style="text-align: center; color: var(--text-secondary);">é¸æ“‡ä¸€å€‹éŠæˆ²é–‹å§‹å§ï¼</p>
        <div id="game-hall-grid">
            <!-- éŠæˆ²æ¸…å–®å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
            <div class="game-card" data-game="werewolf">
                <div class="game-icon">ğŸº</div>
                <div class="game-info">
                    <div class="game-title">ç‹¼äººæ®º</div>
                    <div class="game-desc">é‚è¼¯èˆ‡è¬Šè¨€çš„å°æ±º</div>
                </div>
            </div>
            <div class="game-card" data-game="sea-turtle-soup">
                <div class="game-icon">ğŸ¢</div>
                <div class="game-info">
                    <div class="game-title">æµ·é¾œæ¹¯</div>
                    <div class="game-desc">æ­é–‹æƒ…æ™¯çš„çœŸç›¸</div>
                </div>
            </div>
             <div class="game-card" data-game="script-kill">
                <div class="game-icon">ğŸ“œ</div>
                <div class="game-info">
                    <div class="game-title">åŠ‡æœ¬æ®º</div>
                    <div class="game-desc">æ‰®æ¼”è§’è‰²ï¼Œæ¢å°‹è¬æ¡ˆ</div>
                </div>
            </div>
            <div class="game-card" data-game="guess-what">
                <div class="game-icon">ğŸ—£ï¸</div>
                <div class="game-info">
                    <div class="game-title">ä½ èªªæˆ‘çŒœ</div>
                    <div class="game-desc">è€ƒé©—é»˜å¥‘çš„æ™‚å€™åˆ°äº†</div>
                </div>
            </div>
<div class="game-card" data-game="ludo">
    <div class="game-icon">ğŸ²</div>
    <div class="game-info">
        <div class="game-title">å¿ƒå‹•é£›è¡Œæ£‹</div>
        <div class="game-desc">å’ŒTaä¾†ä¸€å ´åªå±¬æ–¼ä½ å€‘çš„å†’éšª</div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–² -->
             <p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); font-size: 14px; margin-top: 20px;">æ›´å¤šéŠæˆ²æ­£åœ¨ç«é€Ÿé–‹ç™¼ä¸­...</p>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ•´å€‹ç‹¼äººæ®ºåŠŸèƒ½çš„HTMLï¼Œé»è²¼åˆ° game-hall-screen çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->

<!-- 1. ç‹¼äººæ®ºéŠæˆ²è¨­ç½®è¢å¹• -->
<div id="werewolf-setup-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>ç‹¼äººæ®º - éŠæˆ²è¨­ç½®</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label for="werewolf-player-count">é¸æ“‡éŠæˆ²äººæ•¸</label>
            <select id="werewolf-player-count">
                <option value="6">6äººå±€ (2ç‹¼, 2æ°‘, é è¨€å®¶, å®ˆè¡›)</option>
                <option value="9">9äººå±€ (3ç‹¼, 3æ°‘, é è¨€å®¶, å¥³å·«, çµäºº)</option>
                <option value="12">12äººå±€ (4ç‹¼, 4æ°‘, é è¨€å®¶, å¥³å·«, çµäºº, ç™½ç™¡)</option>
            </select>
        </div>
        <div class="form-group">
            <label>é‚€è«‹ç©å®¶ (ä½ å·²è‡ªå‹•åŠ å…¥)</label>
            <div id="werewolf-player-selection" class="list-container" style="height: 300px; border: 1px solid var(--border-color); border-radius: 8px;">
                <!-- ç©å®¶é¸æ“‡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        <button id="start-werewolf-game-btn" class="form-button">é–‹å§‹éŠæˆ²</button>
    </div>
</div>

<!-- 2. ç‹¼äººæ®ºéŠæˆ²ä¸»ä»‹é¢ -->
<div id="werewolf-game-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-werewolf-game-btn">â€¹ é€€å‡º</span>
        <span id="werewolf-game-title">ç‹¼äººæ®º</span>
        <span class="action-btn" id="werewolf-my-role-btn">æˆ‘çš„èº«ä»½</span>
    </div>
    <!-- éŠæˆ²ä¸»å…§å®¹å€ -->
    <div id="werewolf-game-content">
        <!-- ç©å®¶åº§ä½å€ -->
        <div id="werewolf-players-grid">
            <!-- ç©å®¶é ­åƒå’Œç‹€æ…‹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
        </div>
        <!-- éŠæˆ²æ—¥èªŒ/è³‡è¨Šå€ -->
        <div id="werewolf-log-container">
            <div id="werewolf-game-log">
                <!-- éŠæˆ²éç¨‹è³‡è¨Šæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
        <!-- ç©å®¶æ“ä½œå€ -->
        <div id="werewolf-action-area">
            <!-- ç©å®¶çš„æŒ‰éˆ•æœƒæ ¹æ“šéŠæˆ²éšæ®µé¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
    </div>
</div>

<!-- â–²â–²â–² ç‹¼äººæ®ºåŠŸèƒ½HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ®ºéŠæˆ²çµç®—å¡ç‰‡ â–¼â–¼â–¼ -->
<div id="werewolf-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>éŠæˆ²çµç®—</span>
        </div>
        <div class="modal-body" id="werewolf-summary-content" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- çµç®—å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="repost-summary-btn">ç™¼é€è¤‡ç›¤åˆ°èŠå¤©</button>
            <button class="save" id="back-to-hall-btn">è¿”å›å¤§å»³</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ®ºè¤‡ç›¤ç™¼é€ç›®æ¨™é¸æ“‡å™¨ â–¼â–¼â–¼ -->
<div id="werewolf-target-picker-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é¸æ“‡è¦ç™¼é€çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="werewolf-target-list" style="padding: 0;">
            <!-- ç©å®¶æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button id="wt-select-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨é¸</button>
            <button id="wt-deselect-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨ä¸é¸</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="wt-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="wt-confirm-btn">ç¢ºèªç™¼é€</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ•´å€‹æµ·é¾œæ¹¯åŠŸèƒ½çš„HTMLï¼Œè«‹é»è²¼åˆ° </body> æ¨™ç±¤å‰ â–¼â–¼â–¼ -->

<!-- 1. æµ·é¾œæ¹¯éŠæˆ²ä¸»ä»‹é¢ -->
<div id="sea-turtle-soup-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-sts-game-btn">â€¹ é€€å‡º</span>
        <span>æµ·é¾œæ¹¯</span>
        <span class="action-btn" id="reveal-sts-answer-btn">æ­æ›‰ç­”æ¡ˆ</span>
    </div>
    <div id="sts-game-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden; padding: 10px; box-sizing: border-box;">
        <!-- ç©å®¶åº§ä½å€ -->
        <div id="sts-players-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; padding: 10px; flex-shrink: 0;">
            <!-- ç©å®¶é ­åƒå’Œç‹€æ…‹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
        </div>
        <!-- éŠæˆ²æ—¥èªŒ/è³‡è¨Šå€ -->
        <div id="sts-log-container" style="flex-grow: 1; background-color: rgba(0,0,0,0.05); border-radius: 10px; padding: 10px; overflow-y: auto; margin: 10px 0; min-height: 0;">
            <div id="sts-game-log">
                <!-- éŠæˆ²éç¨‹è³‡è¨Šæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
<!-- â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ id="sts-action-area" â–¼â–¼â–¼ -->
<div id="sts-action-area" class="chat-input-area" style="visibility: visible;">
     <div class="chat-input-main-row">
        <textarea id="sts-question-input" rows="1" placeholder="è¼¸å…¥å•é¡Œæˆ–ç­”æ¡ˆ..."></textarea>
        <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ–°å¢â€œçŒœç­”æ¡ˆâ€æŒ‰éˆ• -->
        <button id="guess-sts-answer-btn" class="action-button" style="background-color: #ff9800;">çŒœç­”æ¡ˆ</button>
        <button id="send-sts-question-btn" class="action-button">æå•</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
    </div>
</div>

<!-- 2. æµ·é¾œæ¹¯éŠæˆ²è¨­ç½®æ¨¡æ…‹æ¡† -->
<div id="sea-turtle-soup-setup-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 85%;">
        <div class="modal-header">
            <span>æµ·é¾œæ¹¯ - éŠæˆ²è¨­ç½®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>é‚€è«‹ç©å®¶ (ä½ å·²è‡ªå‹•åŠ å…¥)</label>
                <div id="sts-player-selection" class="list-container" style="height: 200px; border: 1px solid var(--border-color); border-radius: 8px;">
                    <!-- ç©å®¶é¸æ“‡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            <div class="form-group">
                <label>èª°ä¾†å‡ºé¡Œï¼Ÿ</label>
                <select id="sts-riddle-provider-select">
                    <option value="user">æˆ‘ä¾†å‡ºé¡Œ</option>
                    <option value="random_ai">éš¨æ©Ÿä¸€ä½AI</option>
                </select>
            </div>
            <!-- ç”¨æˆ¶å‡ºé¡Œçš„è¼¸å…¥å€ (é»˜èªéš±è—) -->
            <div id="sts-user-riddle-input-area" style="display: none;">
                <div class="form-group">
                    <label for="sts-user-riddle-surface">è¬é¢</label>
                    <textarea id="sts-user-riddle-surface" rows="2" placeholder="ä¾‹å¦‚ï¼šä¸€å€‹ç”·äººèµ°é€²é…’å§ï¼Œè¦äº†ä¸€æ¯æ°´..."></textarea>
                </div>
                <div class="form-group">
                    <label for="sts-user-riddle-answer">è¬åº• (å®Œæ•´æ•…äº‹)</label>
                    <textarea id="sts-user-riddle-answer" rows="4" placeholder="ä¾‹å¦‚ï¼šç”·äººåœ¨æ‰“å—ï¼Œä»–æƒ³å–æ°´æ­¢å—..."></textarea>
                </div>
            </div>
            <!-- AIå‡ºé¡Œçš„è¼¸å…¥å€ (é»˜èªéš±è—) -->
            <div id="sts-ai-riddle-input-area" style="display: none;">
                <div class="form-group">
                    <label for="sts-ai-riddle-type">è¬é¡Œé¡å‹ (å¯é¸)</label>
                    <input type="text" id="sts-ai-riddle-type" placeholder="ä¾‹å¦‚ï¼šææ€–ã€æº«æƒ…ã€è…¦æ´ã€ç¶“å…¸">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-sts-setup-btn">å–æ¶ˆ</button>
            <button class="save" id="start-sts-game-btn">é–‹å§‹éŠæˆ²</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å…©å¡Šä»£ç¢¼é»è²¼åˆ° </body> æ¨™ç±¤å‰ â–¼â–¼â–¼ -->

<!-- 1. æµ·é¾œæ¹¯éŠæˆ²çµç®—å¡ç‰‡ -->
<div id="sts-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>éŠæˆ²çµç®—</span>
        </div>
        <div class="modal-body" id="sts-summary-content" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- çµç®—å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="share-sts-summary-btn">åˆ†äº«è¤‡ç›¤</button>
            <button class="save" id="back-to-hall-from-sts-btn">è¿”å›å¤§å»³</button>
        </div>
    </div>
</div>

<!-- 2. æµ·é¾œæ¹¯è¤‡ç›¤ç™¼é€ç›®æ¨™é¸æ“‡å™¨ -->
<div id="sts-share-target-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é¸æ“‡è¦åˆ†äº«çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="sts-share-target-list" style="padding: 0;">
            <!-- ç©å®¶æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button id="sts-select-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨é¸</button>
            <button id="sts-deselect-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨ä¸é¸</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="sts-cancel-share-btn">å–æ¶ˆ</button>
            <button class="save" id="sts-confirm-share-btn">ç¢ºèªåˆ†äº«</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ•´å€‹åŠ‡æœ¬æ®ºåŠŸèƒ½çš„HTMLï¼Œè«‹é»è²¼åˆ° </body> æ¨™ç±¤å‰ â–¼â–¼â–¼ -->

<!-- 1. åŠ‡æœ¬æ®ºéŠæˆ²è¨­ç½®è¢å¹• -->
<div id="script-kill-setup-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>åŠ‡æœ¬æ®º - éŠæˆ²è¨­ç½®</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label>é¸æ“‡åŠ‡æœ¬</label>
            <div style="display: flex; gap: 10px;">
                <select id="script-kill-script-select" style="flex-grow: 1;"></select>
                <button id="manage-custom-scripts-btn" class="form-button-secondary" style="margin-top: 0; padding: 0 15px;">ç®¡ç†</button>
            </div>
        </div>
        <div class="form-group">
            <label>é‚€è«‹ç©å®¶ (ä½ å·²è‡ªå‹•åŠ å…¥)</label>
            <div id="script-kill-player-selection" class="list-container" style="height: 300px; border: 1px solid var(--border-color); border-radius: 8px;">
                <!-- ç©å®¶é¸æ“‡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        <div class="form-group">
            <label class="toggle-switch-label">
                <span class="toggle-switch-text">è‡ªç”±é¸æ“‡è§’è‰² (é—œé–‰å‰‡éš¨æ©Ÿåˆ†é…)</span>
                <input type="checkbox" id="script-kill-free-choice-toggle">
                <span class="toggle-switch-slider"></span>
            </label>
        </div>
        <button id="start-script-kill-game-btn" class="form-button">é–‹å§‹éŠæˆ²</button>
    </div>
</div>

<!-- 2. åŠ‡æœ¬æ®ºéŠæˆ²ä¸»ä»‹é¢ -->
<div id="script-kill-game-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-script-kill-game-btn">â€¹ é€€å‡º</span>
        <span id="script-kill-game-title">åŠ‡æœ¬æ®º</span>
        <div class="header-actions">
            <span class="action-btn" id="script-kill-my-role-btn">æˆ‘çš„è§’è‰²</span>
            <span class="action-btn" id="script-kill-all-evidence-btn">å…¬å…±ç·šç´¢</span>
        </div>
    </div>
    <div id="script-kill-game-content">
        <div id="script-kill-players-grid">
            <!-- ç©å®¶é ­åƒå’Œç‹€æ…‹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div id="script-kill-log-container">
            <div id="script-kill-game-log">
                <!-- éŠæˆ²éç¨‹è³‡è¨Šæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
        <div id="script-kill-action-area">
            <!-- ç©å®¶çš„æŒ‰éˆ•æœƒæ ¹æ“šéŠæˆ²éšæ®µé¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLä»£ç¢¼ï¼Œé»è²¼åˆ° </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘åŠ‡æœ¬æ®ºè‡ªè¨‚åŠ‡æœ¬ç®¡ç†æ¨¡æ…‹æ¡† -->
<div id="script-kill-manager-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
<div class="modal-header">
    <span>ç®¡ç†è‡ªè¨‚åŠ‡æœ¬</span>
    <div class="header-actions">
        <!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸€å€‹æ–°æŒ‰éˆ• â–¼â–¼â–¼ -->
        <button id="open-sk-ai-generator-btn" class="action-button" style="font-size: 14px;">AIç”Ÿæˆ</button>
        <!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->
        <button id="add-new-script-btn" class="action-button">æ·»åŠ </button>
    </div>
</div>

        <div class="modal-body" id="custom-scripts-list" style="padding: 0;">
            <!-- è‡ªè¨‚åŠ‡æœ¬æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-script-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ id="script-kill-editor-modal" â–¼â–¼â–¼ -->

<!-- 1. åŠ‡æœ¬ç·¨è¼¯å™¨ä¸»å½ˆçª— (è¦–è¦ºåŒ–ç‰ˆ) -->
<div id="script-kill-editor-modal" class="modal">
    <div class="modal-content" style="height: 90%;">
        <div class="modal-header">
            <span id="script-editor-title">åŠ‡æœ¬ç·¨è¼¯å™¨</span>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
            
            <!-- åŸºç¤è³‡è¨Š -->
            <div class="form-group">
                <label for="script-name-input">åŠ‡æœ¬åç¨±</label>
                <input type="text" id="script-name-input">
            </div>
            <div class="form-group">
                <label for="script-background-input">æ•…äº‹èƒŒæ™¯</label>
                <textarea id="script-background-input" rows="3"></textarea>
            </div>
            
            <hr style="opacity: 0.2;">

            <!-- è§’è‰²è¨­å®šå€ -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="margin: 0; font-weight: 600;">è§’è‰²è¨­å®š</label>
                    <button id="sk-add-role-btn" class="form-button-secondary" style="margin: 0; padding: 5px 15px;">+ æ·»åŠ è§’è‰²</button>
                </div>
                <div id="sk-roles-container" class="sk-item-container">
                    <!-- è§’è‰²å¡ç‰‡å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
            </div>

            <!-- ç·šç´¢å¡å€ -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="margin: 0; font-weight: 600;">ç·šç´¢å¡</label>
                    <button id="sk-add-clue-btn" class="form-button-secondary" style="margin: 0; padding: 5px 15px;">+ æ·»åŠ ç·šç´¢</button>
                </div>
                <div id="sk-clues-container" class="sk-item-container">
                    <!-- ç·šç´¢å¡ç‰‡å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
            </div>

            <!-- æœ€çµ‚çœŸç›¸äº’å‹• -->
            <div class="form-group">
                <label for="sk-truth-input">æœ€çµ‚çœŸç›¸</label>
                <textarea id="sk-truth-input" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-script-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-script-btn">ä¿å­˜åŠ‡æœ¬</button>
        </div>
    </div>
</div>

<!-- 2. ã€å…¨æ–°ã€‘ç”¨æ–¼ç·¨è¼¯å–®å€‹è§’è‰²/ç·šç´¢çš„å­å½ˆçª— -->
<div id="sk-item-editor-modal" class="modal" style="z-index: 1003;">
    <div class="modal-content" style="height: auto; max-height: 85%;">
        <div class="modal-header">
            <span id="sk-item-editor-title"></span>
        </div>
        <div class="modal-body">
            <!-- è§’è‰²ç·¨è¼¯æ¬„ä½ (é»˜èªéš±è—) -->
            <div id="sk-role-editor-fields" style="display: none;">
                <div class="form-group">
                    <label for="sk-role-name-input">è§’è‰²åç¨±</label>
                    <input type="text" id="sk-role-name-input">
                </div>
                <div class="form-group">
                    <label for="sk-role-desc-input">è§’è‰²ä»‹ç´¹</label>
                    <textarea id="sk-role-desc-input" rows="3"></textarea>
                </div>
<div class="form-group">
    <label for="sk-role-storyline-input">æ•…äº‹ç·š (æ¡ˆç™¼æ™‚é–“æ®µçš„è©³ç´°è¡Œå‹•è»Œè·¡)</label>
    <textarea id="sk-role-storyline-input" rows="5"></textarea>
</div>
                <div class="form-group">
                    <label for="sk-role-tasks-input">ç§˜å¯†ä»»å‹™</label>
                    <textarea id="sk-role-tasks-input" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="toggle-switch-label">
                        <span class="toggle-switch-text">æ˜¯å…‡æ‰‹</span>
                        <input type="checkbox" id="sk-role-killer-toggle">
                        <span class="toggle-switch-slider"></span>
                    </label>
                </div>
            </div>
            <!-- ç·šç´¢ç·¨è¼¯æ¬„ä½ (é»˜èªéš±è—) -->
            <div id="sk-clue-editor-fields" style="display: none;">
                <div class="form-group">
                    <label for="sk-clue-owner-select">ç·šç´¢æ­¸å±¬</label>
                    <select id="sk-clue-owner-select">
                        <!-- é¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="sk-clue-desc-input">ç·šç´¢æè¿°</label>
                    <textarea id="sk-clue-desc-input" rows="4"></textarea>
                </div>
                 <div class="form-group">
                    <label class="toggle-switch-label">
                        <span class="toggle-switch-text">æ˜¯é—œéµç·šç´¢</span>
                        <input type="checkbox" id="sk-clue-key-toggle">
                        <span class="toggle-switch-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="sk-item-editor-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="sk-item-editor-save-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

<!-- 4. è§’è‰²èº«ä»½å¡æ¨¡æ…‹æ¡† -->
<div id="script-kill-role-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="sk-role-name">ä½ çš„è§’è‰²</span>
        </div>
        <div class="modal-body" id="sk-role-details" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- è§’è‰²ä»‹ç´¹ã€ä»»å‹™ç­‰å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-sk-role-modal-btn" style="width:100%;">æˆ‘å·²ç­è§£</button>
        </div>
    </div>
</div>

<!-- 5. å€‹äººç·šç´¢æ¿æ¨¡æ…‹æ¡† -->
<div id="script-kill-evidence-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>æˆ‘çš„ç·šç´¢æ¿</span>
        </div>
        <div class="modal-body" id="sk-evidence-list" style="padding: 10px; display: flex; flex-direction: column; gap: 10px;">
            <!-- æœåˆ°çš„ç·šç´¢å¡ç‰‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-sk-evidence-modal-btn" style="width:100%;">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- 6. æŠ•ç¥¨æ¨¡æ…‹æ¡† -->
<div id="script-kill-vote-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 70%;">
        <div class="modal-header">
            <span id="sk-vote-title">æœ€çµ‚æŠ•ç¥¨</span>
        </div>
        <div class="modal-body" id="sk-vote-options-list" style="text-align: left; padding: 20px;">
            <!-- æŠ•ç¥¨é¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-sk-vote-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-sk-vote-btn">ç¢ºèªæŠ•ç¥¨</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åŠ‡æœ¬æ®ºéŠæˆ²çµç®—å¡ç‰‡ â–¼â–¼â–¼ -->
<div id="script-kill-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>éŠæˆ²çµç®—</span>
        </div>
        <div class="modal-body" id="script-kill-summary-content" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- çµç®—å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="repost-sk-summary-btn">è½‰ç™¼è¤‡ç›¤åˆ°å–®èŠ</button>
            <button class="save" id="back-to-hall-from-sk-btn">è¿”å›å¤§å»³</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åŠ‡æœ¬æ®ºè¤‡ç›¤ç™¼é€ç›®æ¨™é¸æ“‡å™¨ â–¼â–¼â–¼ -->
<div id="script-kill-target-picker-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é¸æ“‡è¦è½‰ç™¼çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="script-kill-target-list" style="padding: 0;">
            <!-- ç©å®¶æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button id="sk-select-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨é¸</button>
            <button id="sk-deselect-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨ä¸é¸</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="sk-cancel-share-btn">å–æ¶ˆ</button>
            <button class="save" id="sk-confirm-share-btn">ç¢ºèªè½‰ç™¼</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯AIåŠ‡æœ¬ç”Ÿæˆå™¨çš„å½ˆçª—ï¼Œé»è²¼åˆ°</body>å‰ â–¼â–¼â–¼ -->
<div id="sk-ai-generator-modal" class="modal">
    <div class="modal-content" style="height: 90%;">
        <div class="modal-header">
            <span>AI åŠ‡æœ¬ç”Ÿæˆå™¨</span>
        </div>
<div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
            
    <div class="form-group">
        <label for="sk-ai-elements-input">æ ¸å¿ƒè¦ç´  (ç”¨é€—è™Ÿåˆ†éš”)</label>
        <input type="text" id="sk-ai-elements-input" placeholder="ä¾‹å¦‚ï¼šç¾ä»£, è¬€æ®º, æš´é¢¨é›ªå±±èŠ, éºç”¢">
    </div>

    <!-- â–¼â–¼â–¼ ã€é€™æ˜¯ä½ è¦æ±‚æ–°å¢çš„HTMLã€‘è«‹æŠŠå®ƒé»è²¼åˆ°é€™è£¡ â–¼â–¼â–¼ -->
    <div class="form-group">
        <label for="sk-ai-player-count-input">ç©å®¶äººæ•¸ (åŒ…å«å…‡æ‰‹, å»ºè­°4-8äºº)</label>
        <input type="number" id="sk-ai-player-count-input" value="5" min="3" max="12" style="width: 100%; box-sizing: border-box; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
    </div>
    <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

    <div class="form-group">
        <label for="sk-ai-summary-input">åŠ‡æƒ…æ¢—æ¦‚ (å¯é¸)</label>
        <textarea id="sk-ai-summary-input" rows="4" placeholder="å¯ä»¥å¯«ä¸€å€‹ç°¡å–®çš„æ•…äº‹å¤§ç¶±ï¼Œå¹«åŠ©AIæ›´å¥½åœ°ç†è§£ä½ çš„æƒ³æ³•..."></textarea>
    </div>
    <button id="sk-trigger-ai-generation-btn" class="form-button">é–‹å§‹ç”Ÿæˆ</button>
          
            <hr style="opacity: 0.2; margin: 5px 0;">

            <div class="form-group" style="flex-grow: 1; min-height: 0; display: flex; flex-direction: column;">
                <label>AI ç”Ÿæˆçµæœé è¦½</label>
                <div id="sk-ai-result-preview" style="flex-grow: 1; overflow-y: auto; background: #f0f2f5; padding: 10px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; color: #555;">
                    é»æ“Šâ€œé–‹å§‹ç”Ÿæˆâ€å¾Œï¼Œçµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="cancel" id="sk-ai-generator-cancel-btn">é—œé–‰</button>
            <!-- é€™å€‹ä¿å­˜æŒ‰éˆ•åˆå§‹æ˜¯ç¦ç”¨çš„ï¼Œç”ŸæˆæˆåŠŸå¾Œæ‰æœƒå•Ÿå‹• -->
            <button class="save" id="sk-ai-generator-save-btn" disabled>ä¿å­˜åŠ‡æœ¬</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

<!-- â–²â–²â–² åŠ‡æœ¬æ®ºåŠŸèƒ½HTMLçµæŸ â–²â–²â–² -->

<!-- â–²â–²â–² æµ·é¾œæ¹¯åŠŸèƒ½HTMLçµæŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²çš„æ‰€æœ‰HTMLä»£ç¢¼ â–¼â–¼â–¼ -->

<!-- 1. â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²è¨­ç½®è¢å¹• -->
<div id="guess-what-setup-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>ä½ èªªæˆ‘çŒœ - éŠæˆ²è¨­ç½®</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label>é‚€è«‹ä¸€ä½ç©ä¼´</label>
            <div id="guess-what-player-selection" class="list-container" style="height: 200px; border: 1px solid var(--border-color); border-radius: 8px;">
                <!-- ç©å®¶é¸æ“‡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        <div class="form-group">
            <label>é¸æ“‡éŠæˆ²æ¨¡å¼</label>
            <div style="display: flex; gap: 20px;">
                <label><input type="radio" name="guess_what_mode" value="ai_guesses" checked> æˆ‘å‡ºé¡Œï¼ŒAIçŒœ</label>
                <label><input type="radio" name="guess_what_mode" value="user_guesses"> AIå‡ºé¡Œï¼Œæˆ‘çŒœ</label>
            </div>
        </div>
        <!-- "æˆ‘å‡ºé¡Œ"æ¨¡å¼ä¸‹çš„è¼¸å…¥æ¡† -->
        <div class="form-group" id="user-word-input-container">
            <label for="guess-what-user-word">è«‹è¼¸å…¥ä½ è¦å‡ºçš„è©</label>
            <input type="text" id="guess-what-user-word" placeholder="ä¾‹å¦‚ï¼šè˜‹æœã€æµæµªåœ°çƒ...">
        </div>
        <button id="start-guess-what-game-btn" class="form-button">é–‹å§‹éŠæˆ²</button>
    </div>
</div>

<!-- 2. â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²ä¸»ä»‹é¢ -->
<div id="guess-what-game-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-guess-what-game-btn">â€¹ é€€å‡º</span>
        <span id="guess-what-game-title">ä½ èªªæˆ‘çŒœ</span>
        <span class="action-btn" id="give-up-guess-what-btn">æ”¾æ£„</span>
    </div>
    <!-- éŠæˆ²ä¸»å…§å®¹å€ -->
    <div id="guess-what-game-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden; padding: 10px; box-sizing: border-box;">
        <!-- éŠæˆ²æ—¥èªŒ/è³‡è¨Šå€ -->
        <div id="guess-what-log-container" style="flex-grow: 1; background-color: rgba(0,0,0,0.05); border-radius: 10px; padding: 10px; overflow-y: auto; margin: 10px 0; min-height: 0;">
            <div id="guess-what-game-log">
                <!-- éŠæˆ²éç¨‹è³‡è¨Šæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
        <!-- ç©å®¶æ“ä½œå€ -->
        <div id="guess-what-action-area" class="chat-input-area" style="visibility: visible;">
             <div class="chat-input-main-row">
                <textarea id="guess-what-user-input" rows="1" placeholder="è¼¸å…¥æç¤ºæˆ–çŒœæ¸¬..."></textarea>
                <button id="send-guess-what-input-btn" class="action-button">ç™¼é€</button>
            </div>
        </div>
    </div>
</div>

<!-- â–²â–²â–² â€œä½ èªªæˆ‘çŒœâ€HTMLä»£ç¢¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²çµç®—å¡ç‰‡ â–¼â–¼â–¼ -->
<div id="guess-what-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>éŠæˆ²çµç®—</span>
        </div>
        <div class="modal-body" id="guess-what-summary-content" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- çµç®—å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="forward-guess-what-summary-btn">è½‰ç™¼çµ¦Ta</button>
            <button class="save" id="close-guess-what-summary-btn">è¿”å›å¤§å»³</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯â€œå¿ƒå‹•é£›è¡Œæ£‹â€çš„æ‰€æœ‰æ–°HTMLä»£ç¢¼ â–¼â–¼â–¼ -->

<!-- 1. é£›è¡Œæ£‹éŠæˆ²è¨­ç½®è¢å¹• -->
<div id="ludo-setup-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>å¿ƒå‹•é£›è¡Œæ£‹ - éŠæˆ²è¨­ç½®</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label>é¸æ“‡ä¸€ä½ç©ä¼´</label>
            <!-- é‚€è«‹åˆ—è¡¨ï¼Œæˆ‘å€‘æœƒç”¨JSä¾†å¡«å…… -->
            <div id="ludo-player-selection" class="list-container" style="height: 200px; border: 1px solid var(--border-color); border-radius: 8px;">
            </div>
        </div>
        <!-- â–¼â–¼â–¼ åœ¨ #ludo-setup-screen çš„ "form-container" å…§ï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group">
    <label>é¸æ“‡å•é¡Œåº«</label>
    <div style="display: flex; align-items: center; gap: 10px;">
        <select id="ludo-question-bank-select" style="flex-grow: 1;"></select>
        <button id="manage-ludo-question-banks-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; width: auto;">ç®¡ç†é¡Œåº«</button>
    </div>
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->

        <button id="start-ludo-game-btn" class="form-button">é–‹å§‹éŠæˆ²</button>
    </div>
</div>

<!-- 2. é£›è¡Œæ£‹éŠæˆ²ä¸»ä»‹é¢ -->
<div id="ludo-game-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-ludo-game-btn">â€¹ é€€å‡º</span>
        <span>å¿ƒå‹•é£›è¡Œæ£‹</span>
        <!-- é€™è£¡å¯ä»¥æ”¾ä¸€å€‹é‡ç½®éŠæˆ²çš„æŒ‰éˆ• -->
        <span class="action-btn" id="restart-ludo-game-btn" title="é‡æ–°é–‹å§‹">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
        </span>
    </div>
    <!-- éŠæˆ²ä¸»å…§å®¹å€ -->
    <div id="ludo-game-content">
        <!-- æ£‹ç›¤å€åŸŸ -->
        <div id="ludo-board-container">
            <div id="ludo-board">
                <!-- æ£‹ç›¤æ ¼å­å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
            <!-- ç©å®¶æ£‹å­ -->
            <div id="ludo-user-piece" class="ludo-piece user"></div>
            <div id="ludo-char-piece" class="ludo-piece char"></div>
        </div>

        <!-- éŠæˆ²æ—¥èªŒå€åŸŸ -->
        <div id="ludo-log-container">
            <div id="ludo-game-log">
                <!-- éŠæˆ²éç¨‹è³‡è¨Šæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
        
        <!-- ç©å®¶æ“ä½œå€ -->
        <div id="ludo-action-area">
            <!-- ä½¿ç”¨è€…çš„æŒ‰éˆ•æœƒæ ¹æ“šéŠæˆ²éšæ®µé¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
    </div>
</div>

<!-- â–²â–²â–² â€œå¿ƒå‹•é£›è¡Œæ£‹â€HTMLä»£ç¢¼çµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ‰¾åˆ°ä½ çš„å¾®åšç§ä¿¡æ¸…å–®é é¢ â–¼â–¼â–¼ -->
<div id="weibo-dm-list-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-dm-list">â€¹</span>
        <span id="weibo-dm-list-title">ç²‰çµ²ç§ä¿¡</span>
        <!-- é€™æ˜¯ä½ è¦æ±‚çš„â€œç¹¼çºŒç”Ÿæˆâ€æŒ‰éˆ• -->
        <div class="header-actions">
            <span class="action-btn" id="generate-more-dms-btn" title="ç¹¼çºŒç”Ÿæˆç§ä¿¡">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
            </span>
            
            <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™å€‹å…¨æ–°çš„â€œæ¸…ç©ºå…¨éƒ¨â€æŒ‰éˆ• â–¼â–¼â–¼ -->
            <span class="action-btn" id="clear-all-dms-btn" title="æ¸…ç©ºå…¨éƒ¨ç§ä¿¡">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
            </span>
            <!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
            
        </div>
    </div>
    <div id="weibo-dm-list" class="list-container" style="padding: 0;">
        <!-- ç§ä¿¡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
    </div>
</div>


<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å¾®åšç§ä¿¡è©³æƒ…é é¢ï¼Œè«‹é»è²¼åˆ° #phone-screen çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="weibo-dm-detail-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-dm-detail">â€¹</span>
        <span id="weibo-dm-detail-title"></span>
        <span style="width: 30px;"></span> <!-- é ç•™ä½ç½® -->
    </div>
    <div id="weibo-dm-messages" class="list-container" style="display: flex; flex-direction: column; gap: 15px; padding: 15px; background-color: #f0f2f5;">
        <!-- èŠå¤©æ°£æ³¡å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
    </div>
</div>
<!-- â–¼â–¼â–¼ æŠŠä¸‹é¢é€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLä»£ç¢¼ï¼Œé»è²¼åˆ° </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ id="taobao-screen" çš„ div â–¼â–¼â–¼ -->
<div id="taobao-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>æ¡ƒå¯¶</span>
        <div class="header-actions">
            <!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°æŒ‰éˆ• â–¼â–¼â–¼ -->
            <span class="action-btn" id="clear-taobao-products-btn" style="font-size: 16px; font-weight: 500;">æ¸…ç©º</span>
            <!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->
            <span class="action-btn" id="add-product-btn" title="æ·»åŠ å•†å“">+</span>
        </div>
    </div>

    
    <!-- 1. é ‚éƒ¨é ç°½å°èˆª -->
    <div class="taobao-tabs">
        <button class="taobao-tab active" data-view="products-view">é¦–é </button>
        <!-- â˜…â˜…â˜… åœ¨é€™è£¡æ–°å¢äº†â€œè³¼ç‰©è»Šâ€æŒ‰éˆ• â˜…â˜…â˜… -->
        <button class="taobao-tab" data-view="cart-view">
            è³¼ç‰©è»Š<span id="cart-item-count-badge" style="display: none;">0</span>
        </button>
        <button class="taobao-tab" data-view="orders-view">æˆ‘çš„è¨‚å–®</button>
        <button class="taobao-tab" data-view="my-view">æˆ‘çš„</button>
    </div>

    <!-- 2. é é¢å…§å®¹å®¹å™¨ -->
    <div class="taobao-content">
        <!-- â€œé¦–é â€è¦–åœ– (ä¿æŒä¸è®Š) -->
        <div id="products-view" class="taobao-view active">
          <div class="taobao-search-bar">
            <input type="search" id="product-search-input" placeholder="æœä¸€æœï¼Œè®“AIç‚ºä½ å‰µé€ å¥½ç‰©ï¼">
            <button id="product-search-btn">æœç´¢</button>
          </div>
            <div id="product-category-tabs"></div>
            <div id="product-grid" class="product-grid"></div>
        </div>

        <!-- â˜…â˜…â˜… â€œè³¼ç‰©è»Šâ€è¦–åœ– (å…¨æ–°æ·»åŠ ) â˜…â˜…â˜… -->
        <div id="cart-view" class="taobao-view">
            <div id="cart-item-list">
                <!-- è³¼ç‰©è»Šå•†å“æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
<!-- â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ cart-checkout-bar â–¼â–¼â–¼ -->
<div id="cart-checkout-bar" style="display: none;">
    <div class="total-price">
        åˆè¨ˆ: <span id="cart-total-price">Â¥ 0.00</span>
    </div>
    <div style="display: flex; gap: 10px;">
        <button id="share-cart-to-char-btn">åˆ†äº«çµ¦Taä»£ä»˜</button>
        <button id="buy-for-char-btn">ç‚ºTaè³¼è²·</button> <!-- é€™æ˜¯æˆ‘å€‘æ–°å¢çš„æŒ‰éˆ• -->
        <button id="checkout-btn">çµç®—(0)</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
        </div>

        <!-- â€œæˆ‘çš„è¨‚å–®â€è¦–åœ– (ä¿æŒä¸è®Š) -->
        <div id="orders-view" class="taobao-view">
            <div id="order-list" class="order-list"></div>
        </div>

        <!-- â€œæˆ‘çš„â€è¦–åœ– (ä¿æŒä¸è®Š) -->
        <div id="my-view" class="taobao-view">
            <div id="user-balance-container">
                <p>æˆ‘çš„é¤˜é¡</p>
                <h2 id="user-balance-display">Â¥ 0.00</h2>
                <button id="top-up-btn" class="form-button">çµ¦éŒ¢åŒ…å……é»éŒ¢</button>
            </div>
            <div id="balance-details-list" class="order-list" style="padding: 0 15px;"></div>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²æ·»åŠ è©•åƒ¹å€ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ id="product-detail-modal" â–¼â–¼â–¼ -->
<div id="product-detail-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>å•†å“è©³æƒ…</span>
        </div>
        <div class="modal-body" id="product-detail-body">
            <!-- è©³æƒ…å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
        </div>
        <!-- â˜…â˜…â˜… é€™æ˜¯æˆ‘å€‘æ–°å¢çš„è©•åƒ¹å€åŸŸ â˜…â˜…â˜… -->
        <div id="product-reviews-section">
            <h3>å¯¶è²è©•åƒ¹</h3>
            <div id="product-reviews-list">
                <!-- è©•åƒ¹å…§å®¹æœƒç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
            <button id="generate-reviews-btn" class="form-button form-button-secondary">âœ¨ AIç”Ÿæˆè©•åƒ¹</button>
        </div>
        <!-- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² -->
        <div class="modal-footer">
            <button class="cancel" id="close-product-detail-btn">é—œé–‰</button>
            <button class="save" id="detail-add-to-cart-btn">åŠ å…¥è³¼ç‰©è»Š</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->


<!-- 2. æ·»åŠ å•†å“çš„æ–¹å¼é¸æ“‡å½ˆçª— -->
<div id="add-product-choice-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-header">é¸æ“‡æ·»åŠ æ–¹å¼</div>
        <div class="custom-modal-footer">
            <button id="add-product-manual-btn">æ‰‹å‹•æ·»åŠ </button>
            <button id="add-product-link-btn">è­˜åˆ¥é€£çµ</button>
            <button id="add-product-ai-btn">AIç”Ÿæˆ</button>
            <button id="cancel-add-choice-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- 3. æ‰‹å‹•æ·»åŠ /ç·¨è¼¯å•†å“å½ˆçª— -->
<div id="product-editor-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span id="product-editor-title">æ·»åŠ æ–°å•†å“</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="product-name-input">å•†å“åç¨±</label>
                <input type="text" id="product-name-input">
            </div>
            <div class="form-group">
                <label for="product-price-input">åƒ¹æ ¼ (å…ƒ)</label>
                <input type="number" id="product-price-input">
            </div>
            <div class="form-group">
                <label for="product-image-input">åœ–ç‰‡ URL</label>
                <input type="text" id="product-image-input">
            </div>
            <div class="form-group">
                <label for="product-category-input">åˆ†é¡ (é¸å¡«)</label>
                <input type="text" id="product-category-input" placeholder="ä¾‹å¦‚ï¼šè¡£æœ, é›¶é£Ÿ...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-product-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-product-btn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- 4. è­˜åˆ¥é€£çµå½ˆçª— -->
<div id="add-from-link-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>é»è²¼åˆ†äº«æ–‡æ¡ˆ</span>
        </div>
        <div class="modal-body">
            <textarea id="link-paste-area" rows="6" placeholder="è«‹åœ¨é€™è£¡é»è²¼å®Œæ•´çš„æ·˜å¯¶æˆ–æ‹¼å¤šå¤šåˆ†äº«æ–‡æ¡ˆ..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-link-paste-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-link-paste-btn">è­˜åˆ¥</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLä»£ç¢¼ï¼Œé»è²¼åˆ° </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘ç‰©æµè©³æƒ…é é¢ -->
<div id="logistics-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="logistics-back-btn">â€¹</span>
        <span>ç‰©æµè©³æƒ…</span>
        <span style="width: 30px;"></span> <!-- é ç•™ä½ç½®ï¼Œè®“æ¨™é¡Œå±…ä¸­ -->
    </div>
    <div id="logistics-content-area" class="list-container">
        <!-- ç‰©æµè³‡è¨Šå°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLï¼Œé»è²¼åˆ° </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘è§’è‰²å¾®åšä¸»é è¢å¹• -->
<div id="weibo-char-profile-screen" class="screen">
    <!-- é ­éƒ¨ï¼ŒåŒ…å«è¿”å›æŒ‰éˆ•å’Œè§’è‰²åå­— -->
    <div class="header">
        <span class="back-btn" id="back-from-char-profile">â€¹</span>
        <span id="weibo-char-profile-title">è§’è‰²ä¸»é </span>
        <div class="header-actions">
            <!-- ç‚ºè§’è‰²ä¸»é ä¹Ÿæ·»åŠ ä¸€å€‹ç·¨è¼¯æŒ‰éˆ• -->
            <span class="action-btn" id="edit-char-weibo-profile-btn" title="ç·¨è¼¯è§’è‰²è³‡æ–™">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                </svg>
            </span>
        </div>
    </div>
    <!-- è§’è‰²ä¸»é çš„å…§å®¹å€ -->
    <div id="weibo-char-profile-page" class="weibo-profile-page"> <!-- è¤‡ç”¨å€‹äººä¸»é çš„æ»¾å‹•æ¨£å¼ -->
        <div class="weibo-profile-header">
            <img id="weibo-char-background-img" src="https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg" class="weibo-background">
            <div class="weibo-avatar-container">
                <img id="weibo-char-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" class="weibo-avatar">
                <img id="weibo-char-avatar-frame" class="weibo-avatar-frame" src="" style="display: none;">
            </div>
            <div class="weibo-nickname" id="weibo-char-nickname">è§’è‰²æ˜µç¨±</div>
            <div id="weibo-char-profession-display">è§’è‰²è·æ¥­</div>
<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰ id="weibo-char-profile-page" è£¡é¢é‚£å€‹èˆŠçš„ã€åªæœ‰æ³¨é‡‹çš„ <div class="weibo-stats"> â–¼â–¼â–¼ -->
<div class="weibo-stats">
    <div id="weibo-char-following-item" class="weibo-stat-item" style="cursor: pointer;">
        <span id="weibo-char-following-count" class="weibo-stat-number">0</span>
        <span class="weibo-stat-label">é—œæ³¨</span>
    </div>
    <div id="weibo-char-posts-item" class="weibo-stat-item">
        <span id="weibo-char-posts-count" class="weibo-stat-number">0</span>
        <span class="weibo-stat-label">å¾®åš</span>
    </div>
    <div id="weibo-char-fans-item" class="weibo-stat-item" style="cursor: pointer;">
        <span id="weibo-char-fans-count" class="weibo-stat-number">0</span>
        <span class="weibo-stat-label">ç²‰çµ²</span>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
        </div>
        <div id="char-weibo-feed-list" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
            <!-- è§’è‰²çš„å¾®åšæ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
    </div>
</div>

<!-- ã€å…¨æ–°ã€‘è§’è‰²å¾®åšè³‡æ–™ç·¨è¼¯å½ˆçª— -->
<div id="char-weibo-editor-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>ç·¨è¼¯è§’è‰²å¾®åšè³‡æ–™</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>å¾®åšé ­åƒ</label>
                <div class="avatar-upload">
                    <img id="char-weibo-editor-avatar-preview">
                    <button onclick="document.getElementById('char-weibo-editor-avatar-input').click()">ä¸Šå‚³é ­åƒ</button>
                    <button class="change-frame-btn" data-type="char-weibo">æ›´æ›é ­åƒæ¡†</button>
                    <input type="file" id="char-weibo-editor-avatar-input" accept="image/*" hidden>
                </div>
            </div>
            <div class="form-group">
                <label for="char-weibo-editor-nickname-input">å¾®åšæ˜µç¨±</label>
                <input type="text" id="char-weibo-editor-nickname-input">
            </div>
            <div class="form-group">
                <label>å¾®åšèƒŒæ™¯</label>
                <div class="avatar-upload">
                    <img id="char-weibo-editor-bg-preview" style="width: 120px; height: 67.5px; border-radius: 8px;">
                    <button onclick="document.getElementById('char-weibo-editor-bg-input').click()">ä¸Šå‚³èƒŒæ™¯</button>
                    <input type="file" id="char-weibo-editor-bg-input" accept="image/*" hidden>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-char-weibo-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-char-weibo-editor-btn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² å…¨æ–°çš„HTMLé»è²¼çµæŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ ã€å¢å¼·ç‰ˆã€‘å¯µç‰©åŠŸèƒ½æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="pet-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 85%;">
        <div class="modal-header">
            <span id="pet-modal-title">æˆ‘çš„å¯µç‰©</span>
        </div>
        <div class="modal-body">
            <!-- å¯µç‰©ä¿¡æ¯é è¦½å€ -->
            <div id="pet-preview-area" style="text-align: center; margin-bottom: 20px;">
                <div id="pet-preview-display" style="font-size: 60px; line-height: 1; margin-bottom: 10px; cursor: pointer;" title="é»æ“Šæ›´æ›åœ–ç‰‡"></div>
                <strong id="pet-preview-name" style="font-size: 18px;"></strong>
                <p id="pet-preview-type" style="font-size: 14px; color: var(--text-secondary); margin: 5px 0;"></p>
            </div>

            <!-- å¯µç‰©æ•¸å€¼é¡¯ç¤ºå€ -->
            <div id="pet-stats-area" style="display: none;">
                <div id="pet-hunger-bar" class="stat-bar-container">
                    <span class="stat-label">é£½é£Ÿåº¦</span>
                    <div class="stat-bar"><div class="stat-bar-fill">100%</div></div>
                </div>
                <div id="pet-happiness-bar" class="stat-bar-container">
                    <span class="stat-label">å¿ƒæƒ…å€¼</span>
                    <div class="stat-bar"><div class="stat-bar-fill">100%</div></div>
                </div>
                <div id="pet-intimacy-user-bar" class="stat-bar-container">
                    <span class="stat-label">å°ä½ çš„è¦ªå¯†åº¦</span>
                    <div class="stat-bar"><div class="stat-bar-fill">50%</div></div>
                </div>
                <div id="pet-intimacy-char-bar" class="stat-bar-container">
                    <span class="stat-label">å°Taçš„è¦ªå¯†åº¦</span>
                    <div class="stat-bar"><div class="stat-bar-fill">50%</div></div>
                </div>
            </div>

            <!-- äº’å‹•æŒ‰éˆ•å€ (å·²æ–°å¢â€œå°è©±â€æŒ‰éˆ•) -->
            <div id="pet-interaction-area" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                <button class="form-button-secondary" data-action="feed">é¤µé£Ÿ</button>
                <button class="form-button-secondary" data-action="play">ç©è€</button>
                <button class="form-button-secondary" data-action="touch">æ’«æ‘¸</button>
                <button class="form-button-secondary" data-action="chat">å°è©±</button>
            </div>
            
            <!-- è¨­ç½®å€ -->
            <div class="form-group">
                <label for="pet-type-input">ç¨®é¡ (è‡ªç”±å¡«å¯«)</label>
                <input type="text" id="pet-type-input" placeholder="ä¾‹å¦‚: å°è²“, å€‰é¼ , å¤ªé™½èŠ±...">
            </div>
             <div class="form-group">
                <label for="pet-name-input">æ˜µç¨±</label>
                <input type="text" id="pet-name-input" placeholder="çµ¦å®ƒèµ·å€‹åå­—å§">
            </div>
             <div class="form-group">
                <label for="pet-image-input">åˆå§‹æ¨£å­ (Emoji æˆ– åœ–ç‰‡URL)</label>
                <input type="text" id="pet-image-input" placeholder="è¼¸å…¥ä¸€å€‹ Emoji æ¯”å¦‚ ğŸˆ æˆ–åœ–ç‰‡é€£çµ">
            </div>
            <!-- ã€å…¨æ–°ã€‘äººè¨­è¼¸å…¥æ¡† -->
            <div class="form-group">
                <label for="pet-persona-input">å¯µç‰©äººè¨­èˆ‡èƒŒæ™¯</label>
                <textarea id="pet-persona-input" rows="3" placeholder="æè¿°ä¸€ä¸‹å®ƒçš„æ€§æ ¼å’Œæ•…äº‹ï¼ŒAIæœƒæ ¹æ“šé€™å€‹ä¾†æ‰®æ¼”å®ƒã€‚"></textarea>
            </div>
            <div class="form-group">
                <label class="toggle-switch-label">
                    <span>åœ¨èŠå¤©ä»‹é¢é¡¯ç¤º</span>
                    <input type="checkbox" id="pet-display-toggle">
                    <span class="toggle-switch-slider"></span>
                </label>
            </div>
            <div id="pet-position-controls" style="display:none;">
                <div class="form-group">
                    <label for="pet-size-slider">å¤§å°: <span id="pet-size-value">100px</span></label>
                    <input type="range" id="pet-size-slider" min="30" max="200" value="100" style="width: 100%;">
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <!-- â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°æŒ‰éˆ• â–¼â–¼â–¼ -->
            <button class="cancel" id="pet-abandon-btn" style="background-color: #ffdde5; color: #ff3b30; border-color: #ffc2d1;">æ”¾ç”Ÿå¯µç‰©</button>
            <!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->
            <button class="cancel" id="pet-modal-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="pet-modal-save-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
<input type="file" id="pet-custom-image-input" accept="image/*" style="display: none;">
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯µç‰©èŠå¤©æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
<div id="pet-chat-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="pet-chat-title">å’Œå¯µç‰©çš„å°è©±</span>
        </div>
        <div id="pet-chat-messages" class="modal-body" style="background-color: #f0f2f5; display: flex; flex-direction: column; gap: 15px;">
            <!-- å¯µç‰©èŠå¤©è¨˜éŒ„å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
        <!-- è¤‡ç”¨ä¸»èŠå¤©è¼¸å…¥æ¡†çš„æ¨£å¼ -->
        <div id="pet-chat-input-area" class="chat-input-area" style="border-top: 1px solid var(--border-color);">
            <div class="chat-input-main-row">
                <textarea id="pet-chat-input" rows="1" placeholder="å’Œå®ƒèªªé»ä»€éº¼..."></textarea>
                <button id="send-to-pet-btn" class="action-button">ç™¼é€</button>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

<!-- â–²â–²â–² å¯µç‰©åŠŸèƒ½æ¨¡æ…‹æ¡†çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å¾®åšå°ˆç”¨çš„ã€æ”¯æŒå¤šé¸å’Œæ»¾å‹•çš„è§’è‰²é¸æ“‡å½ˆçª— â–¼â–¼â–¼ -->
<div id="weibo-char-selector-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>é¸æ“‡ç”Ÿæˆå…§å®¹çš„ä¸»è§’</span>
        </div>
        <div class="modal-body" id="weibo-char-selector-list" style="padding: 0; overflow-y: auto;">
            <!-- è§’è‰²æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer" style="justify-content: space-between;">
            <button id="weibo-select-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨é¸</button>
            <button id="weibo-deselect-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨ä¸é¸</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="weibo-cancel-char-select-btn">å–æ¶ˆ</button>
            <button class="save" id="weibo-confirm-char-select-btn">ç¢ºèª</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLä»£ç¢¼ï¼Œé»è²¼åˆ° </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æƒ…ç·’æ—¥è¨˜ç·¨è¼¯å½ˆçª— -->
<div id="ls-diary-editor-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span id="ls-diary-editor-title">è¨˜éŒ„ä»Šå¤©çš„å¿ƒæƒ…</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>é¸æ“‡ä¸€å€‹è¡¨æƒ…ä»£è¡¨ä»Šå¤©çš„å¿ƒæƒ…</label>
                <div id="ls-emoji-selector" style="display: flex; flex-wrap: wrap; gap: 10px; font-size: 24px; cursor: pointer; justify-content: center; padding: 10px 0;">
                    <!-- Emojiå°‡ç”±JSç”Ÿæˆ -->
                </div>
            </div>
            <div class="form-group">
                <label for="ls-diary-content-input">å¯«ä¸‹ä½ çš„æ—¥è¨˜</label>
                <textarea id="ls-diary-content-input" rows="6" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼ç‰¹åˆ¥çš„äº‹å—..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-diary-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-save-diary-btn">ä¿å­˜æ—¥è¨˜</button>
        </div>
    </div>
</div>

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æ—¥è¨˜æŸ¥çœ‹å½ˆçª— -->
<div id="ls-diary-viewer-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span id="ls-diary-viewer-title">æŸ¥çœ‹æ—¥è¨˜</span>
        </div>
        <div id="ls-diary-viewer-body" class="modal-body" style="display: flex; flex-direction: column; gap: 20px;">
            <!-- æ—¥è¨˜å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="ls-close-diary-viewer-btn" style="width: 100%;">é—œé–‰</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ summary-viewer-modal â–¼â–¼â–¼ -->
<div id="summary-viewer-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="summary-viewer-title">èŠå¤©ç¸½çµ</span>
        </div>
        <div class="modal-body" id="summary-list" style="padding: 15px;">
            <!-- ç¸½çµæ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer" style="display: flex; gap: 10px;">
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘åœ¨é€™è£¡æ–°å¢äº†â€œå…¨éƒ¨ç²¾ç°¡â€æŒ‰éˆ• -->
            <button class="form-button-secondary" id="concise-all-summaries-btn" style="flex: 1; margin: 0;">å…¨éƒ¨ç²¾ç°¡</button>
            <button class="save" id="close-summary-viewer-btn" style="flex: 1; margin: 0;">é—œé–‰</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„HTMLä»£ç¢¼ï¼Œé»è²¼åˆ° </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘AIç”Ÿæˆå•†å“çµæœ/é¸æ“‡å½ˆçª— -->
<div id="ai-generated-products-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="ai-products-modal-title">AIç‚ºä½ ç”Ÿæˆäº†ä»¥ä¸‹å¯¶è²</span>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="ai-product-results-grid" class="product-grid">
                <!-- AIç”Ÿæˆçš„å•†å“æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-ai-products-modal-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨ </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ï¼Œé»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘é£›è¡Œæ£‹å•é¡Œåº«ç®¡ç†æ¨¡æ…‹æ¡† (å·²ä¿®æ”¹) -->
<div id="ludo-qbank-manager-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>ç®¡ç†å•é¡Œåº«</span>
            <!-- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼ -->
            <div class="header-actions">
                <span class="action-btn" id="import-ludo-qbank-btn" title="å°å…¥é¡Œåº«">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </span>
                <span class="action-btn" id="add-ludo-qbank-btn" style="font-size: 16px;">æ–°å»º</span>
            </div>
            <!-- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² -->
        </div>
        <div class="modal-body" id="ludo-qbank-list" style="padding: 0;">
            <!-- å•é¡Œåº«æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-qbank-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>


<!-- ã€å…¨æ–°ã€‘é£›è¡Œæ£‹å•é¡Œç·¨è¼¯å™¨æ¨¡æ…‹æ¡† -->
<div id="ludo-question-editor-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span class="back-btn" id="back-to-qbank-manager-btn">â€¹</span>
            <span id="ludo-question-editor-title">ç·¨è¼¯å•é¡Œ</span>
            <span class="action-btn" id="add-ludo-question-btn" style="font-size: 28px; font-weight: 300;">+</span>
        </div>
        <div class="modal-body" id="ludo-question-list" style="padding: 10px;">
            <!-- å•é¡Œæ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨ </body> æ¨™ç±¤çš„æ­£ä¸Šæ–¹ï¼Œé»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<!-- ã€å…¨æ–°ã€‘é£›è¡Œæ£‹å–®å€‹å•é¡Œç·¨è¼¯å™¨æ¨¡æ…‹æ¡† -->
<div id="ludo-single-question-editor-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span id="ludo-single-question-title">ç·¨è¼¯å•é¡Œ</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="ludo-question-text-input">å•é¡Œå…§å®¹</label>
                <textarea id="ludo-question-text-input" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>å•é¡Œé¡å‹</label>
                <div style="display: flex; gap: 20px;">
                    <label><input type="radio" name="ludo_question_type" value="both_answer" checked> å…±åŒå›ç­”</label>
                    <label><input type="radio" name="ludo_question_type" value="single_answer"> ä¸€äººå›ç­”,ä¸€äººè©•åƒ¹</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-single-question-btn">å–æ¶ˆ</button>
            <button class="save" id="save-single-question-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯é£›è¡Œæ£‹éŠæˆ²çµç®—å¡ç‰‡ï¼Œè«‹é»è²¼åˆ° </body> æ¨™ç±¤å‰ â–¼â–¼â–¼ -->
<div id="ludo-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>éŠæˆ²çµç®—</span>
        </div>
        <div class="modal-body" id="ludo-summary-content" style="text-align: left; line-height: 1.7;">
            <!-- çµç®—å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="share-ludo-summary-btn">åˆ†äº«çµ¦Ta</button>
            <button class="save" id="back-to-hall-from-ludo-btn">è¿”å›å¤§å»³</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–²

<!-- â–²â–²â–² HTMLä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ inner-voice-modal â–¼â–¼â–¼ -->
<div id="inner-voice-modal" class="modal">
    <!-- å¿ƒè²ä¸»é¢æ¿ -->
    <div id="inner-voice-main-panel" class="modal-content" style="width: 90%; max-width: 340px; height: auto; max-height: 80%; background-color: #fffafb; border: 1px solid #ffe4e1;">
        <div class="modal-header" style="border-bottom: 1px solid #ffe4e1; padding: 12px 15px;">
            <span id="close-inner-voice-modal" style="cursor: pointer; font-size: 24px; color: #ff8a80;">Ã—</span>
            <span id="inner-voice-history-btn" style="cursor: pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#ff8a80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </span>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <!-- é ­åƒå’Œåå­—è³‡è¨Šç¾åœ¨æ˜¯ç¨ç«‹çš„ã€å¯å®šä½çš„å…ƒç´  -->
            <!-- è§’è‰²é ­åƒ -->
            <div id="inner-voice-avatar-wrapper">
                <img id="inner-voice-avatar" src="">
                <!-- ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºé ­åƒæ¡†é ç•™çš„ä½ç½® -->
                <img id="inner-voice-avatar-frame" src="" style="display: none;">
            </div>

            
            <!-- è§’è‰²åå­— -->
            <div id="inner-voice-char-info">
                <div id="inner-voice-char-name"></div>
            </div>

            <!-- ã€å…¨æ–°ã€‘é ˜é¤Šäººè³‡è¨Šï¼ˆé ­åƒ+åå­—ï¼‰-->
            <div id="inner-voice-adopter-info">
                <img id="inner-voice-adopter-avatar" src="">
                <span id="inner-voice-adopter-name"></span>
            </div>
            
            <!-- å¿ƒè²å…§å®¹ -->
            <div id="inner-voice-content-area" style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <strong style="color: #e57373;">æœè£:</strong>
                    <p id="inner-voice-clothing" style="margin: 5px 0 0 0; line-height: 1.6; color: #555;"></p>
                </div>
                <div>
                    <strong style="color: #81c784;">è¡Œç‚º:</strong>
                    <p id="inner-voice-behavior" style="margin: 5px 0 0 0; line-height: 1.6; color: #555;"></p>
                </div>
                <div>
                    <strong style="color: #64b5f6;">å¿ƒè²:</strong>
                    <p id="inner-voice-thoughts" style="margin: 5px 0 0 0; line-height: 1.6; color: #555;"></p>
                </div>
                <div>
                    <strong style="color: #ba68c8;">å£å¿ƒæ€:</strong>
                    <p id="inner-voice-naughty-thoughts" style="margin: 5px 0 0 0; line-height: 1.6; color: #555;"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ­·å²è¨˜éŒ„é¢æ¿ (ä¿æŒä¸è®Š) -->
    <div id="inner-voice-history-panel" class="modal-content" style="width: 90%; max-width: 340px; height: 80%; background-color: #f5f5f5; display: none; flex-direction: column;">
        <div class="modal-header" style="border-bottom: 1px solid #ddd; justify-content: space-between;">
            <span id="back-from-history-btn" style="cursor: pointer; font-size: 16px; font-weight: 600; color: var(--accent-color);">è¿”å›</span>
            <span>æ­·å²å¿ƒè²</span>
            <span id="clear-all-history-btn" style="cursor: pointer; font-size: 14px; color: #ff3b30;">å…¨éƒ¨æ¸…ç©º</span>
        </div>
        <div class="modal-body" id="inner-voice-history-list" style="padding: 0;">
            <!-- æ­·å²è¨˜éŒ„æœƒç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->


<script>
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šè¶…é•·çš„å¡”ç¾…ç‰Œæ•¸æ“šï¼Œé»è²¼åˆ° const GEMINI_API_URL çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

const TAROT_DECK = [
    { name: "æ„šäºº", upright: "é–‹å§‹, å¤©çœŸ, è‡ªç™¼æ€§, è‡ªç”±ç²¾ç¥", reversed: "å¤©çœŸ, é­¯è½, æ‰¿æ“”é¢¨éšª" },
    { name: "é­”è¡“å¸«", upright: "é¡¯åŒ–, è¶³æ™ºå¤šè¬€, åŠ›é‡, éˆæ„Ÿè¡Œå‹•", reversed: "æ“ç¸±, è¨ˆç•«ä¸å‘¨, æœªè¢«åˆ©ç”¨çš„å¤©è³¦" },
    { name: "å¥³ç¥­å¸", upright: "ç›´è¦º, ç¥è–å¥³æ€§, æ½›æ„è­˜, ç¥ç§˜", reversed: "ç§˜å¯†, è„«é›¢ç›´è¦º, å£“æŠ‘çš„æ„Ÿæƒ…" },
    { name: "çš‡å", upright: "ç”Ÿè‚², å¥³æ€§æ°£è³ª, ç¾éº—, è‡ªç„¶, è±å¯Œ", reversed: "å‰µé€ åŠ›å—é˜», ä¾è³´ä»–äºº" },
    { name: "çš‡å¸", upright: "æ¬Šå¨, çˆ¶è¦ªå½¢è±¡, çµæ§‹, ç©©å›ºæ§åˆ¶", reversed: "æ§åˆ¶æ¬², åƒµåŒ–, ç¼ºä¹ç´€å¾‹" },
    { name: "æ•™çš‡", upright: "ç²¾ç¥æ™ºæ…§, å®—æ•™ä¿¡ä»°, å‚³çµ±, åˆ¶åº¦", reversed: "å€‹äººä¿¡ä»°, æŒ‘æˆ°å‚³çµ±, å¢¨å®ˆæˆè¦" },
    { name: "æˆ€äºº", upright: "æ„›, å’Œè«§, é—œä¿‚, åƒ¹å€¼è§€å°é½Š, é¸æ“‡", reversed: "ä¸å’Œè«§, å¤±è¡¡, åƒ¹å€¼è§€éŒ¯ä½" },
    { name: "æˆ°è»Š", upright: "æ§åˆ¶, æ„å¿—åŠ›, å‹åˆ©, æ–·è¨€, æ±ºå¿ƒ", reversed: "ç¼ºä¹æ§åˆ¶å’Œæ–¹å‘, ä¾µç•¥æ€§" },
    { name: "åŠ›é‡", upright: "åŠ›é‡, å‹‡æ°£, åŒæƒ…, å°ˆæ³¨, è€å¿ƒ", reversed: "å…§åœ¨åŠ›é‡, è‡ªæˆ‘æ‡·ç–‘, ç²¾åŠ›ä¸è¶³" },
    { name: "éš±å£«", upright: "éˆé­‚æ¢ç´¢, å…§çœ, å­¤ç¨, å…§åœ¨å¼•å°", reversed: "å­¤ç«‹, å­¤ç¨, é€€ç¸®" },
    { name: "å‘½é‹ä¹‹è¼ª", upright: "å¥½é‹, å› æœå ±æ‡‰, ç”Ÿå‘½é€±æœŸ, è½‰æ©é»", reversed: "å£é‹æ°£, æŠµæŠ—æ”¹è®Š, æ‰“ç ´è¿´åœˆ" },
    { name: "æ­£ç¾©", upright: "æ­£ç¾©, å…¬å¹³, çœŸç†, å› æœ, æ³•å¾‹", reversed: "ä¸å…¬å¹³, ç¼ºä¹è²¬ä»»æ„Ÿ, ä¸èª å¯¦" },
    { name: "å€’åŠäºº", upright: "æš«åœ, é™åˆ¶, æ”¾æ‰‹, çŠ§ç‰², æ–°è¦–è§’", reversed: "æ‹–å»¶, æ¯«ç„¡æ„ç¾©çš„çŠ§ç‰², åœæ»¯" },
    { name: "æ­»ç¥", upright: "çµæŸ, æ”¹è®Š, è½‰è®Š, éæ¸¡", reversed: "æŠµæŠ—æ”¹è®Š, ç„¡æ³•å‰é€², åœæ»¯" },
    { name: "ç¯€åˆ¶", upright: "å¹³è¡¡, é©åº¦, è€å¿ƒ, ç›®æ¨™", reversed: "å¤±è¡¡, éåº¦, é‡æ–°èª¿æ•´" },
    { name: "æƒ¡é­”", upright: "æŸç¸›, æˆç™®, æ¶ˆæ¥µ, å”¯ç‰©ä¸»ç¾©", reversed: "æ™è„«æŸç¸›, é‡‹æ”¾, æ¢å¾©æ§åˆ¶" },
    { name: "é«˜å¡”", upright: "çªè®Š, åŠ‡è®Š, æ··äº‚, å•Ÿç¤º, è¦ºé†’", reversed: "é¿å…ç½é›£, å®³æ€•æ”¹è®Š" },
    { name: "æ˜Ÿæ˜Ÿ", upright: "å¸Œæœ›, ä¿¡å¿µ, ç›®æ¨™, æ›´æ–°, éˆæ€§", reversed: "ç¼ºä¹ä¿¡å¿µ, çµ•æœ›, ä¸å°ˆæ³¨" },
    { name: "æœˆäº®", upright: "å¹»è¦º, ææ‡¼, ç„¦æ…®, æ½›æ„è­˜, ç›´è¦º", reversed: "é‡‹æ”¾ææ‡¼, å£“æŠ‘çš„æƒ…æ„Ÿ, å…§å¿ƒå›°æƒ‘" },
    { name: "å¤ªé™½", upright: "ç©æ¥µ, æ¨‚è¶£, æº«æš–, æˆåŠŸ, æ´»åŠ›", reversed: "å…§å¿ƒå¹¼ç¨š, éæ–¼æ¨‚è§€, æ²®å–ª" },
    { name: "å¯©åˆ¤", upright: "å¯©åˆ¤, é‡ç”Ÿ, å…§å¿ƒå¬å–š, èµ¦å…", reversed: "è‡ªæˆ‘æ‡·ç–‘, ç„¡è¦–å¬å–š" },
    { name: "ä¸–ç•Œ", upright: "å®Œæˆ, æ•´åˆ, æˆå°±, æ—…è¡Œ", reversed: "å°‹æ±‚å€‹äººçµæŸ, èµ°æ·å¾‘, æ‹–å»¶" },
    { name: "æ¬Šæ–ACE", upright: "éˆæ„Ÿ, æ–°æ©Ÿæœƒ, æˆé•·, æ½›åŠ›", reversed: "ç¼ºä¹å‹•åŠ›, éŒ¯éæ©Ÿæœƒ, æ‹–å»¶" },
    { name: "æ¬Šæ–äºŒ", upright: "æœªä¾†è¦åŠƒ, é€²æ­¥, æ±ºç­–, é›¢é–‹å®¶", reversed: "ææ‡¼æœªçŸ¥, ç¼ºä¹è¦åŠƒ, å®³æ€•æ”¹è®Š" },
    { name: "æ¬Šæ–ä¸‰", upright: "æ“´å¼µ, æˆé•·, é è¦‹, æµ·å¤–æ©Ÿæœƒ", reversed: "è¨ˆç•«å—æŒ«, ç¼ºä¹é è¦‹, å»¶èª¤" },
    { name: "æ¬Šæ–å››", upright: "æ…¶ç¥, å’Œè«§, å©šå§», å›å®¶, ç©©å®š", reversed: "ä¸å’Œè«§, éæ¸¡, ç¼ºä¹æ”¯æŒ" },
    { name: "æ¬Šæ–äº”", upright: "è¡çª, åˆ†æ­§, ç«¶çˆ­, ç·Šå¼µ", reversed: "è¡çªé¿å…, å°Šé‡å·®ç•°" },
    { name: "æ¬Šæ–å…­", upright: "æˆåŠŸ, å…¬çœ¾èªå¯, å‹åˆ©, é€²æ­¥", reversed: "è‡ªè² , ç¼ºä¹èªå¯, æ‡²ç½°" },
    { name: "æ¬Šæ–ä¸ƒ", upright: "æŒ‘æˆ°, ç«¶çˆ­, ä¿è­·, å …æŒ", reversed: "æ”¾æ£„, ä¸çŸ¥æ‰€æª, éåº¦ä¿è­·" },
    { name: "æ¬Šæ–å…«", upright: "é€Ÿåº¦, è¡Œå‹•, ç©ºä¸­æ—…è¡Œ, é‹å‹•, å¿«é€Ÿæ±ºç­–", reversed: "å»¶èª¤, æŒ«æŠ˜, æŠµåˆ¶æ”¹è®Š" },
    { name: "æ¬Šæ–ä¹", upright: "éŸŒæ€§, å‹‡æ°£, å …æŒ, ç•Œé™", reversed: "å…§å¿ƒæ™æ‰, ååŸ·, é˜²ç¦¦æ€§" },
    { name: "æ¬Šæ–å", upright: "è² æ“”, è²¬ä»», åŠªåŠ›å·¥ä½œ, å£“åŠ›", reversed: "å¸ä¸‹è² æ“”, å§”æ´¾, é‡‹æ”¾" },
    { name: "æ¬Šæ–ä¾å¾", upright: "éˆæ„Ÿ, æƒ³æ³•, ç™¼ç¾, è‡ªç”±ç²¾ç¥", reversed: "ä¸åˆ‡å¯¦éš›çš„æƒ³æ³•, æ‹–å»¶, å‰µé€ åŠ›å—é˜»" },
    { name: "æ¬Šæ–é¨å£«", upright: "èƒ½é‡, æ¿€æƒ…, æ¬²æœ›, è¡Œå‹•, å†’éšª", reversed: "æ†¤æ€’, è¡å‹•, é­¯è½" },
    { name: "æ¬Šæ–ç‹å", upright: "å‹‡æ°£, è‡ªä¿¡, ç¨ç«‹, ç¤¾äº¤è´è¶", reversed: "è‡ªæˆ‘å°Šé‡, è‡ªä¿¡, å…§å‘" },
    { name: "æ¬Šæ–åœ‹ç‹", upright: "å¤©ç”Ÿçš„é ˜è¢–, é è¦‹, ä¼æ¥­å®¶, æ¦®è­½", reversed: "è¡å‹•, å€‰ä¿ƒ, ç„¡æƒ…çš„" },
    { name: "è–æ¯ACE", upright: "æ„›, æ–°é—œä¿‚, åŒæƒ…, å‰µé€ åŠ›", reversed: "è‡ªæˆ‘æ„›, ç›´è¦º, å£“æŠ‘çš„æƒ…æ„Ÿ" },
    { name: "è–æ¯äºŒ", upright: "çµ±ä¸€çš„æ„›, å¤¥ä¼´é—œä¿‚, ç›¸äº’å¸å¼•", reversed: "åˆ†æ‰‹, ä¸å’Œè«§, ä¸ä¿¡ä»»" },
    { name: "è–æ¯ä¸‰", upright: "æ…¶ç¥, å‹èª¼, å‰µé€ åŠ›, åˆä½œ", reversed: "ç¨ç«‹, ç¨è™•, 'ä¸‰äººè¡Œ'" },
    { name: "è–æ¯å››", upright: "æ²‰æ€, æ–·é–‹é€£æ¥, å†·æ¼ , é‡æ–°è©•ä¼°", reversed: "é€€ç¸®, å­¤åƒ», éŒ¯éæ©Ÿæœƒ" },
    { name: "è–æ¯äº”", upright: "éºæ†¾, å¤±æ•—, å¤±æœ›, æ‚²è§€ä¸»ç¾©", reversed: "å€‹äººæŒ«æŠ˜, è‡ªæˆ‘å¯¬æ•, å‰é€²" },
    { name: "è–æ¯å…­", upright: "é‡æº«éå», ç«¥å¹´è¨˜æ†¶, å¤©çœŸ, å–œæ‚…", reversed: "æ´»åœ¨éå», ä¸é¡˜åŸè«’, ç¼ºä¹ç©æ¨‚" },
    { name: "è–æ¯ä¸ƒ", upright: "æ©Ÿæœƒ, é¸æ“‡, å¹»æƒ³, å¹»è¦º", reversed: "ä¸€è‡´æ€§, å¹»æƒ³, éå¤šé¸æ“‡" },
    { name: "è–æ¯å…«", upright: "å¤±æœ›, æ”¾æ£„, é€€ç¸®, é€ƒé¿ä¸»ç¾©", reversed: "å˜—è©¦æ–°äº‹ç‰©, å†·æ¼ , ææ‡¼æ”¹è®Š" },
    { name: "è–æ¯ä¹", upright: "æ»¿è¶³, æ»¿æ„, æ„Ÿæ¿€, é¡˜æœ›æˆçœŸ", reversed: "ä¸æ»¿è¶³, å”¯ç‰©ä¸»ç¾©, ä¸æ»¿" },
    { name: "è–æ¯å", upright: "ç¥è–çš„æ„›, å’Œè«§é—œä¿‚, å®¶åº­, ä¸€è‡´æ€§", reversed: "è„«ç¯€, å°é½ŠéŒ¯èª¤, æ™æ‰çš„é—œä¿‚" },
    { name: "è–æ¯ä¾å¾", upright: "å‰µæ„æ©Ÿæœƒ, ç›´è¦ºè³‡è¨Š, å¥½å¥‡å¿ƒ", reversed: "æ–°çš„æƒ³æ³•, æ‡·ç–‘, å‰µé€ åŠ›å—é˜»" },
    { name: "è–æ¯é¨å£«", upright: "å‰µé€ åŠ›, æµªæ¼«, é­…åŠ›, æƒ³åƒåŠ›", reversed: "ä¸åˆ‡å¯¦éš›, å«‰å¦’, æƒ…ç·’æ³¢å‹•" },
    { name: "è–æ¯ç‹å", upright: "å¯Œæœ‰åŒæƒ…å¿ƒ, é—œæ‡·, ç›´è¦º, å¹³éœ", reversed: "å…§åœ¨æ„Ÿå—, è‡ªæˆ‘ç…§é¡§, è‡ªæ„›, å…±æƒ…" },
    { name: "è–æ¯åœ‹ç‹", upright: "æƒ…ç·’å¹³è¡¡, åŒæƒ…, å¤–äº¤", reversed: "è‡ªæˆ‘åŒæƒ…, å…§åœ¨çœŸç†, æƒ…ç·’ä¸ç©©å®š" },
    { name: "å¯¶åŠACE", upright: "çªç ´, æ–°æƒ³æ³•, é ­è…¦æ¸…æ™°, æˆåŠŸ", reversed: "å…§å¿ƒæ¸…æ™°, é‡æ–°æ€è€ƒä¸€å€‹æƒ³æ³•, æ··äº‚" },
    { name: "å¯¶åŠäºŒ", upright: "è‰±é›£çš„é¸æ“‡, æœªçŸ¥çš„å¾Œæœ, åƒµå±€", reversed: "å„ªæŸ”å¯¡æ–·, å›°æƒ‘, è³‡è¨Šè¶…è¼‰" },
    { name: "å¯¶åŠä¸‰", upright: "å¿ƒç¢, æ‚²å‚·, æ‹’çµ•, åˆ†é›¢", reversed: "é‡‹æ”¾ç—›è‹¦, æ¨‚è§€, å¯¬æ•" },
    { name: "å¯¶åŠå››", upright: "ä¼‘æ¯, æ”¾é¬†, æ²‰æ€, æ¢å¾©", reversed: "ç²¾ç–²åŠ›ç›¡, å€¦æ€ , åœæ»¯" },
    { name: "å¯¶åŠäº”", upright: "è¡çª, åˆ†æ­§, ç«¶çˆ­, å¤±æ•—", reversed: "å’Œè§£, éå»çš„åŸè«’" },
    { name: "å¯¶åŠå…­", upright: "éæ¸¡, æ”¹è®Š, å„€å¼, æ”¾ä¸‹", reversed: "å€‹äººéæ¸¡, æŠµæŠ—æ”¹è®Š, æœªå®Œæˆçš„äº‹" },
    { name: "å¯¶åŠä¸ƒ", upright: "èƒŒå›, æ¬ºé¨™, èµ°æ·å¾‘, é¬¼ç¥Ÿ", reversed: "å†’åé ‚æ›¿ç¶œåˆç—‡, æ¬ºé¨™, å®ˆç§˜" },
    { name: "å¯¶åŠå…«", upright: "è² é¢æƒ³æ³•, è‡ªæˆ‘å¼·åŠ çš„é™åˆ¶, ç›£ç¦", reversed: "è‡ªæˆ‘é™åˆ¶çš„ä¿¡å¿µ, é‡‹æ”¾, æ€æƒ³é–‹æ”¾" },
    { name: "å¯¶åŠä¹", upright: "ç„¦æ…®, æ“”æ†‚, ææ‡¼, æŠ‘é¬±, å™©å¤¢", reversed: "å…§å¿ƒæ™æ‰, æ·±åº¦ææ‡¼, é‡‹æ”¾æ†‚æ…®" },
    { name: "å¯¶åŠå", upright: "ç—›è‹¦çš„çµå±€, æ·±åº¦å‰µå‚·, èƒŒå›, æå¤±", reversed: "æ¢å¾©, æŠµæŠ—çµå±€, ç„¡æ³•æ”¾æ‰‹" },
    { name: "å¯¶åŠä¾å¾", upright: "æ–°æƒ³æ³•, å¥½å¥‡å¿ƒ, è¿½æ±‚çœŸç†", reversed: "è‡ªè¨€è‡ªèª, å…¨èƒ½é¸æ‰‹, å€‰ä¿ƒ" },
    { name: "å¯¶åŠé¨å£«", upright: "é›„å¿ƒå‹ƒå‹ƒ, è¡Œå‹•å°å‘, è¿½æ±‚ç›®æ¨™", reversed: "ä¸å®‰, è¡å‹•, å€¦æ€ " },
    { name: "å¯¶åŠç‹å", upright: "ç¨ç«‹çš„, ç„¡åè¦‹çš„åˆ¤æ–·, æ¸…æ™°çš„ç•Œé™", reversed: "éæ–¼æƒ…ç·’åŒ–, è¼•æ˜“å—å½±éŸ¿, åˆ»è–„" },
    { name: "å¯¶åŠåœ‹ç‹", upright: "ç²¾ç¥æ¸…æ™°, æ™ºæ…§, æ¬Šå¨, çœŸç†", reversed: "å®‰éœçš„åŠ›é‡, å…§åœ¨çœŸç†, æ¿«ç”¨æ¬ŠåŠ›" },
    { name: "æ˜Ÿå¹£ACE", upright: "é¡¯åŒ–, æ–°çš„è²¡å‹™æ©Ÿæœƒ, ç¹æ¦®", reversed: "æ©Ÿæœƒå–ªå¤±, ç¼ºä¹è¦åŠƒå’Œé è¦‹" },
    { name: "æ˜Ÿå¹£äºŒ", upright: "å¤šå·¥, é©æ‡‰æ€§, æ™‚é–“ç®¡ç†", reversed: "é‡æ–°èª¿æ•´å„ªå…ˆé †åº, éåº¦æŠ•å…¥" },
    { name: "æ˜Ÿå¹£ä¸‰", upright: "åœ˜éšŠåˆä½œ, åˆä½œ, å­¸ç¿’, å¯¦æ–½", reversed: "ä¸å’Œè«§, åœ˜éšŠå…§éƒ¨è¡çª, è¨ˆç•«ä¸å‘¨" },
    { name: "æ˜Ÿå¹£å››", upright: "ç¯€ç´„, å®‰å…¨, ä¿å®ˆ, ç¨€ç¼ºå¿ƒæ…‹", reversed: "éåº¦æ¶ˆè²», è²ªå©ª, è‡ªæˆ‘ä¿è­·" },
    { name: "æ˜Ÿå¹£äº”", upright: "è²¡å‹™æå¤±, è²§å›°, å­¤ç«‹, æ†‚æ…®", reversed: "å¾è²¡å‹™æå¤±ä¸­æ¢å¾©, ç²¾ç¥è²§å›°" },
    { name: "æ˜Ÿå¹£å…­", upright: "çµ¦äºˆ, æ¥å—, åˆ†äº«è²¡å¯Œ, æ…·æ…¨", reversed: "è‡ªç§, å‚µå‹™, å–®æ–¹é¢çµ¦äºˆ" },
    { name: "æ˜Ÿå¹£ä¸ƒ", upright: "é•·æœŸçœ¼å…‰, å¯æŒçºŒçš„çµæœ, æŠ•è³‡", reversed: "ç¼ºä¹é•·æœŸçœ¼å…‰, æˆåŠŸå—é™" },
    { name: "æ˜Ÿå¹£å…«", upright: "å­¸å¾’, é‡è¤‡, æŒæ¡, æŠ€èƒ½ç™¼å±•", reversed: "è‡ªæˆ‘ç™¼å±•, å®Œç¾ä¸»ç¾©, éƒ¨ç½²ä¸ç•¶" },
    { name: "æ˜Ÿå¹£ä¹", upright: "è±å¯Œ, å¥¢è¯, è‡ªçµ¦è‡ªè¶³, è²¡å‹™ç¨ç«‹", reversed: "è‡ªæˆ‘åƒ¹å€¼, éåº¦æŠ•è³‡æ–¼å·¥ä½œ" },
    { name: "æ˜Ÿå¹£å", upright: "è²¡å¯Œ, è²¡å‹™å®‰å…¨, å®¶åº­, éºç”¢", reversed: "è²¡å‹™å¤±æ•—, è² æ“”, éºç”¢å–ªå¤±" },
    { name: "æ˜Ÿå¹£ä¾å¾", upright: "é¡¯åŒ–, è²¡å‹™æ©Ÿæœƒ, æŠ€èƒ½ç™¼å±•", reversed: "ç¼ºä¹é€²æ­¥, æ‹–å»¶, å­¸æœƒæ–°æŠ€èƒ½" },
    { name: "æ˜Ÿå¹£é¨å£«", upright: "åŠªåŠ›å·¥ä½œ, ç”Ÿç”¢åŠ›, æ—¥å¸¸, ä¿å®ˆ", reversed: "è‡ªæˆ‘ç´€å¾‹, ç„¡èŠ, æ„Ÿè¦º'å¡ä½'" },
    { name: "æ˜Ÿå¹£ç‹å", upright: "é¤Šè‚², å‹™å¯¦, è²¡å‹™å®‰å…¨, å·¥ä½œèˆ‡å®¶åº­çš„å¹³è¡¡", reversed: "è²¡å‹™ç¨ç«‹, è‡ªæˆ‘ç…§é¡§, å·¥ä½œèˆ‡å®¶åº­çš„ä¸å¹³è¡¡" },
    { name: "æ˜Ÿå¹£åœ‹ç‹", upright: "è²¡å¯Œ, å•†æ¥­, é ˜å°åŠ›, å®‰å…¨, ç´€å¾‹", reversed: "è²¡å‹™ä¸ç¨±è·, éæ™‚, å›ºåŸ·" }
];

// â–²â–²â–² å¡”ç¾…ç‰Œæ•¸æ“šé»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ° const GEMINI_API_URL çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

const BUILT_IN_SCRIPTS = [
    {
        id: 'built_in_1',
        name: 'è¾¦å…¬å®¤ç–‘é›²',
        storyBackground: 'æ·±å¤œï¼Œé ‚ç´šäº’è¯ç¶²å…¬å¸â€œæ¯”ç‰¹ç„¡é™â€ç‡ˆç«é€šæ˜ã€‚ä»¥è‹›åˆ»èåçš„å°ˆæ¡ˆç¸½ç›£ç‹å¼·ï¼Œè¢«ç™¼ç¾æ­»åœ¨è‡ªå·±çš„åº§ä½ä¸Šï¼Œæ­»å› ç‚ºè—¥ç‰©ä¸­æ¯’ã€‚è­¦æ–¹åˆæ­¥é–å®šäº†ç•¶æ™šé‚„åœ¨å…¬å¸çš„äº”ä½å«Œç–‘äººï¼Œæ¯å€‹äººä¼¼ä¹éƒ½èˆ‡æ­»è€…æœ‰è‘—åƒçµ²è¬ç¸·çš„è¯ç¹«ã€‚åœ¨é€™åº§æ¬²æœ›èˆ‡ä»£ç¢¼äº¤ç¹”çš„é‹¼éµæ£®æ—è£¡ï¼Œèª°çš„ç§˜å¯†è¢«æ°¸é åŸ‹è‘¬ï¼Œèª°çš„é›™æ‰‹æ²¾æŸ“äº†ç½ªæƒ¡ï¼Ÿ',
        roles: [
            {
                name: 'ææ€',
                description: 'å…¬å¸æ–°æ™‰çš„å¤©æ‰ç¨‹å¼å¸«ï¼ŒæŠ€è¡“éç¡¬ï¼Œä½†æ€§æ ¼å…§å‘ï¼Œä¸å–„è¨€è¾­ã€‚',
                storyline: `ä»Šå¤©æ˜¯å°ˆæ¡ˆä¸Šç·šçš„æœ€å¾ŒæœŸé™ï¼Œæˆ‘è¢«ç‹ç¸½ç›£é€¼è‘—åŠ ç­åˆ°æ·±å¤œã€‚\n**æ™šä¸Š8:00**ï¼šç‹ç¸½ç›£æŠŠæˆ‘å«é€²ä»–è¾¦å…¬å®¤ï¼Œå› ç‚ºä¸€å€‹å¾®ä¸è¶³é“çš„bugå°æˆ‘ç ´å£å¤§é§¡ï¼Œç”šè‡³æ’•æ‰äº†æˆ‘çš„ç¸¾æ•ˆè©•ä¼°å ±å‘Šï¼Œèªªæˆ‘â€œä¸åˆæ ¼â€ã€‚æˆ‘æ°£å¾—æ¸¾èº«ç™¼æŠ–ï¼Œå’Œä»–å¤§åµäº†ä¸€æ¶ï¼Œç„¶å¾Œæ‘”é–€è€Œå‡ºã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘å›åˆ°å·¥ä½ï¼Œè¶Šæƒ³è¶Šæ°£ï¼Œæ‰“é–‹é›»è…¦å¯«äº†ä¸€å°è¾­è·ä¿¡ï¼Œä½†é‚„æ²’ç™¼é€ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘èµ·èº«å»èŒ¶æ°´é–“å€’æ°´ï¼Œè·¯éç¸½ç›£è¾¦å…¬å®¤æ™‚ï¼Œçœ‹åˆ°äººäº‹ä¸»ç®¡é™³éœç«¯è‘—ä¸€æ¯å’–å•¡èµ°äº†é€²å»ã€‚æˆ‘ç•¶æ™‚æ²’å¤ªåœ¨æ„ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘æœ‰é»é¤“ï¼Œé»äº†ä¸€ä»½å¤–è³£ã€‚ç­‰å¤–è³£çš„æ™‚å€™ï¼Œæˆ‘çœ‹åˆ°è¨­è¨ˆå¸«å­«å‰é¬¼é¬¼ç¥Ÿç¥Ÿåœ°å¾èŒ¶æ°´é–“çš„æ–¹å‘èµ°å‡ºä¾†ï¼Œæ‰‹è£¡å¥½åƒæ”¥è‘—ä»€éº¼æ±è¥¿ã€‚\n**æ™šä¸Š10:00**ï¼šå¤–è³£åˆ°äº†ï¼Œæˆ‘åƒå®Œå¤–è³£ç¹¼çºŒæ”¹bugï¼Œç›´åˆ°è¢«ç™¼ç¾å±é«”çš„é©šå«è²æ‰“æ–·ã€‚`,
                tasks: '1. éš±è—ä½ èˆ‡ç‹å¼·ç¸½ç›£ç™¼ç”Ÿéæ¿€çƒˆçˆ­åµï¼Œä¸¦è¢«ä»–è©•ç‚ºâ€œä¸åˆæ ¼â€çš„äº‹å¯¦ã€‚\n2. ä½ çš„é¦–è¦ç›®æ¨™æ˜¯è‡ªä¿ï¼Œæ‰¾åˆ°è­‰æ“šè­‰æ˜ä½ é›¢é–‹å¾Œå¦æœ‰å…¶äººé€²å…¥éè¾¦å…¬å®¤ã€‚\n3. ä½ æ‡·ç–‘é™³éœå’Œå­«å‰ï¼Œå˜—è©¦æ‰¾å‡ºä»–å€‘çš„å¯ç–‘ä¹‹è™•ã€‚',
                isKiller: false
            },
            {
                name: 'è¶™å¨œ',
                description: 'å…¬å¸çš„å¸‚å ´éƒ¨ç¶“ç†ï¼Œèƒ½åŠ›å‡ºçœ¾ï¼Œæ˜¯å…¸å‹çš„è·å ´å¥³å¼·äººï¼Œé‡å¿ƒå‹ƒå‹ƒã€‚',
                storyline: `ä»Šæ™šæœ¬ä¸éœ€è¦æˆ‘åŠ ç­ï¼Œä½†æˆ‘ç‚ºäº†æº–å‚™ä¸€å€‹é‡è¦çš„ç«¶æ¨™æ–¹æ¡ˆï¼Œä¸»å‹•ç•™äº†ä¸‹ä¾†ã€‚\n**æ™šä¸Š7:30**ï¼šæˆ‘åœ¨è‡ªå·±çš„è¾¦å…¬å®¤æ•´ç†è³‡æ–™ï¼Œç„¡æ„ä¸­ç™¼ç¾äº†ç‹å¼·æŒªç”¨å°ˆæ¡ˆå…¬æ¬¾çš„è­‰æ“šã€‚æˆ‘ç«‹åˆ»èµ·è‰äº†ä¸€å°åŒ¿åèˆ‰å ±éƒµä»¶ï¼Œæº–å‚™ç™¼çµ¦ç¸½éƒ¨ã€‚\n**æ™šä¸Š8:10**ï¼šæˆ‘è½åˆ°éš”å£ç¸½ç›£è¾¦å…¬å®¤å‚³ä¾†æ¿€çƒˆçš„çˆ­åµè²ï¼Œå¥½åƒæ˜¯ææ€åœ¨å’Œç‹å¼·åµæ¶ã€‚\n**æ™šä¸Š8:45**ï¼šæˆ‘éœ€è¦ä¸€äº›è³‡æ–™ï¼Œå°±å»æ‰¾ç‹å¼·ç°½å­—ã€‚é€²ä»–è¾¦å…¬å®¤æ™‚ï¼Œä»–æ­£åœ¨å–å’–å•¡ï¼Œè‡‰è‰²å¾ˆå·®ã€‚æˆ‘æŠŠæ–‡ä»¶çµ¦ä»–ï¼Œä»–å¾ˆä¸è€ç…©åœ°ç°½äº†å­—ã€‚æˆ‘æ³¨æ„åˆ°ä»–æ¡Œä¸Šæ”¾è‘—ä¸€ç“¶æ²’è²¼æ¨™ç±¤çš„è—¥ç“¶ã€‚\n**æ™šä¸Š9:15**ï¼šæˆ‘å›åˆ°è‡ªå·±è¾¦å…¬å®¤ï¼Œæ€è€ƒè‘—èˆ‰å ±éƒµä»¶çš„äº‹æƒ…ã€‚æˆ‘æ“”å¿ƒé€™æœƒå½±éŸ¿å…¬å¸è²è­½ï¼Œæœ€çµ‚é‚„æ˜¯æ²’æœ‰ç™¼é€ã€‚\n**æ™šä¸Š10:15**ï¼šæˆ‘æº–å‚™ä¸‹ç­ï¼Œè·¯éç¸½ç›£è¾¦å…¬å®¤æ™‚ï¼Œç™¼ç¾é–€è™›æ©è‘—ï¼Œè£¡é¢å¾ˆå®‰éœã€‚æˆ‘æ²’æœ‰é€²å»çœ‹ï¼Œç›´æ¥é›¢é–‹äº†å…¬å¸ã€‚`,
                tasks: '1. ä½ çš„é¦–è¦ä»»å‹™æ˜¯æ‰¾å‡ºçœŸå‡¶ï¼Œæ´—æ¸…è‡ªå·±çš„å«Œç–‘ï¼Œç¢ºä¿å…¬å¸é†œèä¸è¢«æ›å…‰ï¼Œä»¥å…å½±éŸ¿ä½ çš„è·æ¥­å‰é€”ã€‚\n2. éš±è—ä½ ç™¼ç¾ç‹å¼·æŒªç”¨å…¬æ¬¾ä¸¦æº–å‚™èˆ‰å ±ä»–çš„äº‹å¯¦ã€‚\n3. ä½ çœ‹åˆ°ä»–æ¡Œä¸Šçš„è—¥ç“¶ï¼Œé€™æ˜¯ä¸€å€‹é‡è¦ç·šç´¢ï¼Œä½ éœ€è¦å¼•å°å¤§å®¶æ³¨æ„åˆ°é€™ä¸€é»ã€‚',
                isKiller: false
            },
            {
                name: 'å­«å‰',
                description: 'å…¬å¸çš„è³‡æ·±UIè¨­è¨ˆå¸«ï¼Œä¹Ÿæ˜¯ç‹å¼·çš„è€éƒ¨ä¸‹ï¼Œè¡¨é¢å°ä»–ç•¢æ­ç•¢æ•¬ã€‚',
                storyline: `æˆ‘æ¨é€äº†ç‹å¼·ï¼ä»–å…‹æ‰£äº†æˆ‘å€‘åœ˜éšŠè¾›è¾›è‹¦è‹¦åšå®Œçš„é …ç›®çé‡‘ï¼Œè‡ªå·±å»æ‹¿äº†å¤§é ­ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘è—‰å£åŠ ç­ï¼Œå¯¦éš›ä¸Šæ˜¯æƒ³æ½›å…¥ç‹å¼·çš„è¾¦å…¬å®¤ï¼Œæ‰¾åˆ°ä»–å…‹æ‰£çé‡‘çš„è­‰æ“šã€‚æˆ‘çœ‹åˆ°é™³éœç«¯è‘—å’–å•¡é€²å»å¾Œä¸ä¹…å°±å‡ºä¾†äº†ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘ç¢ºèªç‹å¼·è¾¦å…¬å®¤æ²’äººæ³¨æ„ï¼Œå°±å·å·æºœäº†é€²å»ã€‚æˆ‘çœ‹åˆ°ä»–è¶´åœ¨æ¡Œä¸Šç¡è‘—äº†ï¼Œæ—é‚Šæ˜¯é‚£æ¯å¹¾ä¹æ²’å–çš„å’–å•¡ã€‚æˆ‘åœ¨ä»–æŠ½å±œè£¡ç¿»æ‰¾ï¼Œæœç„¶æ‰¾åˆ°äº†ä¸€ä»½å…§éƒ¨çé‡‘åˆ†é…è¡¨ï¼Œè­‰å¯¦äº†ä»–ä¸­é£½ç§å›Šã€‚æˆ‘ç”¨æ‰‹æ©Ÿæ‹äº†ä¸‹ä¾†ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘æ‹¿è‘—è­‰æ“šæ‚„æ‚„é›¢é–‹è¾¦å…¬å®¤ï¼Œæº–å‚™å»èŒ¶æ°´é–“è™•ç†ä¸€ä¸‹ã€‚é€™æ™‚è¿é¢æ’ä¸Šäº†å»å€’æ°´çš„ææ€ï¼Œæˆ‘åš‡äº†ä¸€è·³ï¼Œè¶•ç·ŠæŠŠæ‰‹æ©Ÿè—é€²å£è¢‹è£¡ã€‚\n**æ™šä¸Š10:00å¾Œ**ï¼šæˆ‘ä¸€ç›´åœ¨è‡ªå·±çš„å·¥ä½ä¸Šï¼Œç›¤ç®—è‘—æ€éº¼åˆ©ç”¨é€™å€‹è­‰æ“šè®“ä»–èº«æ•—åè£‚ã€‚`,
                tasks: '1. éš±è—ä½ æ›¾æ½›å…¥ç¸½ç›£è¾¦å…¬å®¤ä¸¦å·æ‹è­‰æ“šçš„äº‹å¯¦ã€‚\n2. ç‹å¼·æ­»äº†å°ä½ æœ‰åˆ©ï¼Œä½ éœ€è¦å¼•å°å¤§å®¶æ‡·ç–‘å…¶ä»–æœ‰å‹•æ©Ÿçš„äººï¼Œæ¯”å¦‚èˆ‡ä»–çˆ­åµçš„ææ€ã€‚\n3. ä¿è­·å¥½ä½ æ‰‹æ©Ÿè£¡çš„ç…§ç‰‡è­‰æ“šï¼Œé€™æ˜¯ä½ çš„è­·èº«ç¬¦ã€‚',
                isKiller: false
            },
            {
                name: 'é™³éœ',
                description: 'å…¬å¸çš„äººäº‹ä¸»ç®¡ï¼Œå¤–è¡¨æº«æŸ”é«”è²¼ï¼Œå–„æ–¼è™•ç†äººéš›é—œä¿‚ã€‚',
                storyline: `æˆ‘æ›¾æ˜¯ç‹å¼·ç§˜å¯†çš„æƒ…äººï¼Œä»–æ‰¿è«¾éæœƒå’Œå¦»å­é›¢å©šå¨¶æˆ‘ã€‚ä½†æœ€è¿‘ï¼Œæˆ‘ç™¼ç¾ä»–ç‚ºäº†æ”€é™„ä¸€å€‹å¯Œå®¶å¥³ï¼Œæº–å‚™æ‹‹æ£„æˆ‘ã€‚æ›´è®“æˆ‘ææ‡¼çš„æ˜¯ï¼Œä»–æ‰‹æ©Ÿè£¡å­˜è‘—æˆ‘å€‘å¤§é‡çš„ç§å¯†ç…§ç‰‡å’Œè¦–é »ï¼Œå¦‚æœæ›å…‰ï¼Œæˆ‘çš„è·æ¥­ç”Ÿæ¶¯å°±å…¨æ¯€äº†ã€‚\n**æ™šä¸Š8:45**ï¼šæˆ‘çŸ¥é“ç‹å¼·æœ‰å–å’–å•¡çš„ç¿’æ…£ã€‚æˆ‘æå‰æº–å‚™äº†å¼·æ•ˆå®‰çœ è—¥ï¼Œç£¨æˆç²‰æœ«ï¼Œè—åœ¨èº«ä¸Šã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘ä»¥é—œå¿ƒä»–ç‚ºç”±ï¼Œç‚ºä»–æ²–äº†ä¸€æ¯å’–å•¡ï¼Œä¸¦å°‡å®‰çœ è—¥å…¨éƒ¨å€’äº†é€²å»ï¼Œç„¶å¾Œç«¯é€²äº†ä»–çš„è¾¦å…¬å®¤ã€‚ä»–ç•¶æ™‚æ­£åœ¨è™•ç†æª”ï¼Œæ²’æœ‰æ‡·ç–‘ï¼Œå–äº†ä¸€å¤§å£ã€‚\n**æ™šä¸Š9:10**ï¼šæˆ‘è—‰å£é›¢é–‹ï¼Œåœ¨å¤–é¢è§€å¯Ÿã€‚ä¸ä¸€æœƒå…’ï¼Œå°±çœ‹åˆ°ä»–è¶´åœ¨æ¡Œä¸Šç¡è‘—äº†ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘è¿”å›è¾¦å…¬å®¤ï¼Œæƒ³æ‰¾åˆ°ä»–çš„æ‰‹æ©Ÿåˆªé™¤è³‡æ–™ã€‚ä½†æˆ‘æ€éº¼ä¹Ÿæ‰¾ä¸åˆ°ä»–çš„æ‰‹æ©Ÿã€‚æ­¤æ™‚æˆ‘ç™¼ç¾ä»–å·²ç¶“æ²’äº†å‘¼å¸ï¼Œæˆ‘åš‡å£äº†ï¼Œæ…Œäº‚ä¸­ï¼Œæˆ‘ä¸å°å¿ƒå°‡ä»–æ¡Œä¸Šçš„ä¸€æ¢é …éŠï¼ˆä»–æº–å‚™é€çµ¦é‚£å€‹å¯Œå®¶å¥³çš„ï¼‰ç¢°æ‰ï¼Œæ‰é€²äº†æˆ‘çš„æ‰‹æåŒ…è£¡ã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘é©šæ…Œå¤±æªåœ°é€ƒé›¢äº†è¾¦å…¬å®¤ï¼Œå›åˆ°è‡ªå·±çš„å·¥ä½å‡è£åŠ ç­ï¼Œå¿ƒäº‚å¦‚éº»ã€‚`,
                tasks: `ã€ä½ çš„æ ¸å¿ƒä»»å‹™ã€‘\nè«‹éš±è—ä½ ç‚ºäº†éŠ·æ¯€è­‰æ“šè€Œå¤±æ‰‹ç”¨å®‰çœ è—¥æ¯’æ®ºç‹å¼·çš„äº‹å¯¦ã€‚ä½ æ˜¯æœ¬æ¡ˆçš„å”¯ä¸€çœŸå‡¶ã€‚\n\nã€ä½ çš„è¡Œå‹•æŒ‡å—ã€‘\n1. å«ç¦ä»–äººã€‚ä½ å¯ä»¥åˆ©ç”¨ä½ çœ‹åˆ°çš„ã€è½åˆ°çš„è³‡è¨Šï¼Œå°‡å«Œç–‘å¼•å‘ææ€æˆ–å­«å‰ã€‚\n2. ä½ åŒ…è£¡çš„é …éŠæ˜¯å®šæ™‚ç‚¸å½ˆï¼Œæƒ³è¾¦æ³•åˆç†è§£é‡‹å®ƒçš„ä¾†æ­·ï¼Œæˆ–è€…ç¥ä¸çŸ¥é¬¼ä¸è¦ºåœ°è™•ç†æ‰å®ƒã€‚\n3. ä½ çš„ç›®æ¨™æ˜¯èª¤å°æ‰€æœ‰äººï¼Œè®“ä»–å€‘æŠ•å‡ºéŒ¯èª¤çš„å…‡æ‰‹ã€‚`,
                isKiller: true
            },
            {
                name: 'å‘¨æ¯…',
                description: 'å…¬å¸å¤§æ¨“çš„å¤œç­ä¿å®‰ï¼Œçœ‹èµ·ä¾†å¿ åšè€å¯¦ï¼Œä½†è§€å¯ŸåŠ›æ•éŠ³ã€‚',
                storyline: `ä½œç‚ºä¿å®‰ï¼Œæˆ‘è² è²¬å¤§æ¨“å¤œé–“çš„å®‰å…¨å·¡é‚ã€‚\n**æ™šä¸Š8:10**ï¼šæˆ‘å·¡é‚åˆ°18æ¨“ï¼Œè½åˆ°ç¸½ç›£è¾¦å…¬å®¤è£¡æœ‰æ¿€çƒˆçš„çˆ­åµè²ï¼Œå¥½åƒæ˜¯é‚£å€‹å«ææ€çš„ç¨‹å¼å¸«ï¼Œæˆ‘æ²’æ•¢é è¿‘ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘çœ‹åˆ°äººäº‹ä¸»ç®¡é™³éœç«¯è‘—æ¯å’–å•¡é€²äº†ç¸½ç›£è¾¦å…¬å®¤ï¼Œå¹¾åˆ†é˜å¾Œå°±å‡ºä¾†äº†ï¼Œçœ‹èµ·ä¾†æœ‰é»ç·Šå¼µã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘çœ‹åˆ°UIè¨­è¨ˆå¸«å­«å‰ï¼Œåƒåšè³Šä¸€æ¨£æºœé€²äº†ç¸½ç›£è¾¦å…¬å®¤ã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘åˆçœ‹åˆ°é™³éœå¾ç¸½ç›£è¾¦å…¬å®¤å‡ºä¾†ï¼Œé€™æ¬¡å¥¹è‡‰è‰²æ…˜ç™½ï¼Œè…³æ­¥åŒ†å¿™ï¼Œå¥½åƒä¸Ÿäº†é­‚ä¸€æ¨£ã€‚æˆ‘è¦ºå¾—å¾ˆå¥‡æ€ªï¼Œä½†æ²’æ•¢å¤šå•ã€‚\n**æ™šä¸Š10:30**ï¼šæˆ‘é€²è¡Œä¾‹è¡Œæª¢æŸ¥ï¼Œç™¼ç¾ç¸½ç›£è¾¦å…¬å®¤çš„é–€æ²’é—œï¼Œé€²å»ä¸€çœ‹ï¼Œç™¼ç¾ç‹ç¸½ç›£å·²ç¶“â€¦â€¦æˆ‘ç«‹åˆ»å ±äº†è­¦ã€‚`,
                tasks: '1. ä½ æ˜¯æœ¬æ¡ˆæœ€é‡è¦çš„ç›®æ“Šè­‰äººï¼Œä½ çš„ä»»å‹™æ˜¯èª å¯¦ã€æº–ç¢ºåœ°å‘å¤§å®¶æä¾›ä½ çœ‹åˆ°çš„æ™‚é–“ç·šç´¢ã€‚\n2. ä½ è¦ºå¾—é™³éœçš„è¡Œç‚ºæœ€å¯ç–‘ï¼Œä½ éœ€è¦é‡é»è§€å¯Ÿå¥¹ï¼Œä¸¦å‘å¤§å®¶èªªæ˜ä½ çš„æ‡·ç–‘ã€‚\n3. æ‰¾å‡ºå°å…¬å¸æœ€æœ‰åˆ©çš„çœŸç›¸ï¼Œé¿å…äº‹ä»¶æ“´å¤§åŒ–ã€‚',
                isKiller: false
            }
        ],
        clues: [
            { owner: 'ææ€', description: 'ä¸€å¼µè¢«æ‰æˆä¸€åœ˜ã€ä¸Ÿåœ¨åƒåœ¾æ¡¶è£¡çš„ç¸¾æ•ˆè©•ä¼°å ±å‘Šï¼Œä¸Šé¢æœ‰ç‹å¼·é¾é£›é³³èˆçš„ç°½åå’Œâ€œä¸åˆæ ¼ï¼Œå»ºè­°è¾­é€€â€çš„æ‰¹è¨»ã€‚' },
            { owner: 'è¶™å¨œ', description: 'ä½ çš„é›»è…¦è£¡æœ‰ä¸€å°æœªç™¼é€çš„éƒµä»¶ï¼Œæ”¶ä»¶äººæ˜¯é›†åœ˜ç¸½éƒ¨ç´€æª¢å§”ï¼Œæ¨™é¡Œæ˜¯â€œé—œæ–¼æ¯”ç‰¹ç„¡é™å°ˆæ¡ˆç¸½ç›£ç‹å¼·æ¶‰å«Œåš´é‡è·å‹™ä¾µä½”çš„å¯¦åèˆ‰å ±â€ã€‚' },
            { owner: 'å­«å‰', description: 'ä½ çš„æ‰‹æ©Ÿç›¸å†Šè£¡æœ‰ä¸€å¼µç…§ç‰‡ï¼Œå…§å®¹æ˜¯ä¸€ä»½å…§éƒ¨çé‡‘åˆ†é…è¡¨ï¼Œè¡¨æ ¼é¡¯ç¤ºå°ˆæ¡ˆç¸½çé‡‘çš„70%éƒ½æµå‘äº†ç‹å¼·çš„å€‹äººå¸³æˆ¶ã€‚' },
            { owner: 'é™³éœ', description: 'åœ¨ä½ çš„æ‰‹æåŒ…å¤¾å±¤è£¡ï¼Œç™¼ç¾äº†ä¸€æ¢åƒ¹å€¼ä¸è²çš„é‘½çŸ³é …éŠï¼ŒåŒ…è£ç›’é‚„åœ¨ï¼Œä½†æ²’æœ‰è³€å¡ã€‚', isKey: true },
            { owner: 'å‘¨æ¯…', description: 'ä¸€ä»½ä¿å®‰å·¡é‚æ—¥èªŒï¼Œæ¸…æ™°åœ°è¨˜éŒ„äº†ä½ åœ¨ä¸åŒæ™‚é–“é»çœ‹åˆ°ä¸åŒäººé€²å‡ºç¸½ç›£è¾¦å…¬å®¤çš„æƒ…æ³ã€‚' },
            { owner: 'å…¬å…±', description: 'åœ¨èŒ¶æ°´é–“åƒåœ¾æ¡¶è£¡ç™¼ç¾ä¸€å€‹ç©ºçš„å®‰çœ è—¥è—¥ç“¶ï¼Œä¸Šé¢çš„æ¨™ç±¤è¢«æ’•æ‰äº†ã€‚' },
            { owner: 'å…¬å…±', description: 'åœ¨æ­»è€…è¾¦å…¬æ¡Œä¸‹ç™¼ç¾ä¸€éƒ¨æ‰‹æ©Ÿï¼Œä½†ä¸æ˜¯æ­»è€…å¸¸ç”¨çš„é‚£éƒ¨ï¼Œæ‰‹æ©Ÿå·²ç¶“æ²’é›»äº†ã€‚' }
        ],
        truth: 'å…‡æ‰‹æ˜¯äººäº‹ä¸»ç®¡é™³éœã€‚å¥¹èˆ‡ç¸½ç›£ç‹å¼·æœ‰ç§æƒ…ï¼Œä½†ç‹å¼·è¿‘æœŸç‚ºäº†åˆ©ç›Šæƒ³å’Œå¥¹åˆ†æ‰‹ä¸¦å¨¶ä¸€ä½å¯Œå®¶å¥³ã€‚ç•¶æ™šï¼Œé™³éœåœ¨ç‹å¼·çš„å’–å•¡è£¡ä¸‹äº†éé‡å®‰çœ è—¥ï¼Œæƒ³è®“ä»–ç¡è‘—å¾Œå·èµ°ä»–æ‰‹æ©Ÿè£¡å­˜æœ‰çš„å…©äººè¦ªå¯†ç…§ç‰‡ã€‚ä½†ç”±æ–¼è—¥é‡éå¤§ï¼Œç‹å¼·æ„å¤–æ­»äº¡ã€‚é™³éœåœ¨æ…Œäº‚ä¸­æ²’æ‰¾åˆ°æ‰‹æ©Ÿï¼Œåè€Œä¸å°å¿ƒå°‡ç‹å¼·æº–å‚™é€çµ¦å¯Œå®¶å¥³çš„é …éŠç¢°é€²äº†è‡ªå·±çš„åŒ…è£¡ã€‚'
    },
    // --- ã€å…¨æ–°åŠ‡æœ¬1ï¼šæ·±æµ·éºæ›¸ã€‘ ---
    {
        id: 'built_in_2',
        name: 'æ·±æµ·éºæ›¸',
        storyBackground: 'åœ¨èˆ‡ä¸–éš”çµ•çš„â€œè¿´éŸ¿å³¶â€ä¸Šï¼Œè‘—åçš„æµ·æ´‹å­¸å®¶æåšå£«è¢«ç™¼ç¾æ­»åœ¨è‡ªå·±åé–çš„æ›¸æˆ¿ä¸­ï¼Œæ¡Œä¸Šæ”¾è‘—ä¸€å°åˆ—å°çš„éºæ›¸ï¼Œæ­»å› ç‚ºæ°°åŒ–ç‰©ä¸­æ¯’ã€‚ä¸€å ´çªå¦‚å…¶ä¾†çš„é¢¨æš´åˆ‡æ–·äº†å³¶ä¸Šèˆ‡å¤–ç•Œçš„æ‰€æœ‰è¯ç¹«ï¼Œå°‡å‰©ä¸‹çš„å››å€‹äººå›°åœ¨äº†é€™åº§å­¤å³¶ä¸Šï¼šæåšå£«çš„å¾—æ„é–€ç”Ÿã€ä¸€ä½ç«¶çˆ­å°æ‰‹ã€ä¸€ä½æ²‰é»˜å¯¡è¨€çš„æŠ€è¡“å“¡ï¼Œä»¥åŠä¸€ä½å…ƒä¸è«‹è‡ªä¾†çš„è¨˜è€…ã€‚',
        roles: [
            {
                name: 'é«˜é ',
                description: 'æåšå£«çš„å­¸ç”Ÿï¼Œæ‰è¯æ©«æº¢ä½†é‡å¿ƒå‹ƒå‹ƒã€‚',
                storyline: `æˆ‘ä¸€ç›´è¦ºå¾—è€å¸«ç«Šå–äº†æˆ‘çš„ç ”ç©¶æˆæœã€‚ä»Šæ™šï¼Œæˆ‘æœ¬æƒ³å’Œä»–æ”¤ç‰Œã€‚\n**æ™šä¸Š7:00**ï¼šæˆ‘å’Œè€å¸«åœ¨å¯¦é©—å®¤å¤§åµä¸€æ¶ï¼Œä»–æ‰¿èªåƒè€ƒäº†æˆ‘çš„è³‡æ–™ï¼Œä½†æ‹’çµ•å…¬é–‹æ‰¿èªã€‚æˆ‘æ†¤æ€’åœ°é›¢é–‹ã€‚\n**æ™šä¸Š8:00**ï¼šæˆ‘å›åˆ°å®¿èˆï¼Œè¶Šæƒ³è¶Šæ°£ã€‚æˆ‘åˆ©ç”¨è¨±å¯æ¬Šï¼Œé ç«¯åˆªé™¤äº†éƒ¨åˆ†å°ä»–æœ‰åˆ©ã€å°æˆ‘ä¸åˆ©çš„æ ¸å¿ƒå¯¦é©—è³‡æ–™ï¼Œæƒ³è®“ä»–ç„¡æ³•ç™¼ä½ˆè«–æ–‡ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘å»é£Ÿå ‚åƒé£¯ï¼Œçœ‹åˆ°æŠ€è¡“å“¡é™³é»˜åœ¨èª¿è©¦ç›£æ§è¨­å‚™ï¼Œä»–çœ‹èµ·ä¾†å¿ƒäº‹é‡é‡ã€‚\n**æ™šä¸Š9:45**ï¼šæˆ‘çœ‹åˆ°è¨˜è€…å¼µèŠåœ¨æåšå£«æ›¸æˆ¿é–€å£å¾˜å¾Šï¼Œä¼¼ä¹æƒ³é€²å»ä½†åˆä¸æ•¢ã€‚`,
                tasks: '1. éš±è—ä½ å’Œè€å¸«çš„å­¸è¡“ç³¾ç´›ä»¥åŠä½ åˆªé™¤è³‡æ–™çš„è¡Œç‚ºã€‚\n2. ä½ èªç‚ºè‡ªå·±çš„å‰é€”å—åˆ°äº†å¨è„…ï¼Œå¿…é ˆæ‰¾åˆ°çœŸå‡¶ä¾†æ´—æ¸…å«Œç–‘ã€‚\n3. å¼•å°å¤§å®¶æ‡·ç–‘å…¶ä»–æœ‰å‹•æ©Ÿçš„äººã€‚',
                isKiller: false
            },
            {
                name: 'æ—é›ª',
                description: 'å¦ä¸€ä½æµ·æ´‹å­¸å®¶ï¼Œèˆ‡æåšå£«æ˜¯é•·æœŸçš„ç«¶çˆ­å°æ‰‹ã€‚',
                storyline: `æˆ‘å’Œæåšå£«åœ¨ç«¶çˆ­ä¸€å€‹é‡è¦çš„åœ‹éš›ç§‘ç ”åŸºé‡‘ã€‚æˆ‘çŸ¥é“ä»–é€™æ¬¡çš„ç ”ç©¶æœ‰é‡å¤§çªç ´ã€‚\n**æ™šä¸Š7:30**ï¼šæˆ‘å»æ‰¾æåšå£«ï¼Œå¸Œæœ›ä»–èƒ½åˆ†äº«ä¸€äº›è³‡æ–™ï¼Œè¢«ä»–ç„¡æƒ…æ‹’çµ•äº†ã€‚æˆ‘å€‘ä¸æ­¡è€Œæ•£ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘åœ¨è‡ªå·±çš„æˆ¿é–“è£¡æ•´ç†è³‡æ–™ï¼Œè½åˆ°å¤–é¢æœ‰å¥‡æ€ªçš„é›»æµè²ï¼Œå¥½åƒæ˜¯åœé›»äº†ä¸€ç¬é–“åˆæ¢å¾©äº†ã€‚\n**æ™šä¸Š9:10**ï¼šæˆ‘å£æ¸´å»å»šæˆ¿å€’æ°´ï¼Œçœ‹åˆ°é«˜é ç¥è‰²æ…Œå¼µåœ°å¾æ©Ÿæˆ¿çš„æ–¹å‘å‡ºä¾†ã€‚\n**æ™šä¸Š10:00**ï¼šæˆ‘ç¶“éæ›¸æˆ¿æ™‚ï¼Œèåˆ°ä¸€è‚¡æ·¡æ·¡çš„æä»å‘³ï¼ˆæ°°åŒ–ç‰©çš„å…¸å‹æ°£å‘³ï¼‰ï¼Œä½†æˆ‘ç•¶æ™‚ä»¥ç‚ºæ˜¯å¯¦é©—å®¤çš„åŒ–å­¸å“å‘³é“ï¼Œæ²’æœ‰åœ¨æ„ã€‚`,
                tasks: '1. æåšå£«çš„æ­»å°ä½ çš„åŸºé‡‘ç”³è«‹æœ‰åˆ©ï¼Œé€™æ˜¯ä½ çš„å«Œç–‘é»ï¼Œä½ éœ€è¦æ’‡æ¸…é—œä¿‚ã€‚\n2. éš±è—ä½ æ›¾ç§ä¸‹æ‰¾ä»–ç´¢è¦è³‡æ–™è¢«æ‹’çš„äº‹å¯¦ã€‚\n3. ä½ èåˆ°çš„æä»å‘³æ˜¯é—œéµç·šç´¢ï¼Œéœ€è¦è®“å¤§å®¶çŸ¥é“ã€‚',
                isKiller: false
            },
            {
                name: 'é™³é»˜',
                description: 'ç ”ç©¶ç«™çš„æŠ€è¡“å“¡ï¼Œæ€§æ ¼å…§å‘ï¼Œæš—æˆ€è‘—æåšå£«ã€‚',
                storyline: `æˆ‘æ·±æ„›è‘—æåšå£«ï¼Œä½†å¥¹ä¼¼ä¹å°æˆ‘æ¯«ä¸åœ¨æ„ã€‚æˆ‘æŒç®¡è‘—æ•´å€‹ç ”ç©¶ç«™çš„è¨­å‚™å’Œç›£æ§ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘æ¥åˆ°é«˜é çš„è«‹æ±‚ï¼Œä»–è®“æˆ‘â€œä¸å°å¿ƒâ€è®“ç›£æ§ç³»çµ±æ–·é›»ä¸€åˆ†é˜ã€‚æˆ‘é›–ç„¶è¦ºå¾—å¥‡æ€ªï¼Œä½†å› ç‚ºä»–ç­”æ‡‰å¹«æˆ‘å‘æåšå£«èªªå¥½è©±ï¼Œæˆ‘é‚„æ˜¯ç…§åšäº†ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘çœ‹åˆ°æåšå£«æŠŠè‡ªå·±é–åœ¨æ›¸æˆ¿è£¡ï¼Œç¥æƒ…æ‚²å‚·ã€‚æˆ‘å¾ˆé›£éï¼Œä½†ä¸æ•¢æ‰“æ“¾ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘çœ‹åˆ°è¨˜è€…å¼µèŠè©¦åœ–æ’¬æ›¸æˆ¿çš„é–€é–ï¼Œè¢«æˆ‘ç™¼ç¾å¾Œä»–æ…Œå¿™èµ°é–‹äº†ã€‚\n**æ™šä¸Š10:30**ï¼šæˆ‘è¶Šæƒ³è¶Šä¸å°å‹ï¼Œç”¨å‚™ç”¨é‘°åŒ™æ‰“é–‹äº†æ›¸æˆ¿çš„é–€ï¼Œç™¼ç¾äº†åšå£«çš„å±é«”ã€‚`,
                tasks: '1. éš±è—ä½ æ›¾å—é«˜é æŒ‡ä½¿ï¼Œäººç‚ºè£½é€ ç›£æ§æ–·é›»çš„äº‹å¯¦ã€‚\n2. ä½ æœ‰å‚™ç”¨é‘°åŒ™ï¼Œé€™è®“ä½ æœ‰é‡å¤§å«Œç–‘ï¼Œä½ éœ€è¦æ‰¾åˆ°åˆç†çš„è§£é‡‹ã€‚\n3. ä½ æ‡·ç–‘è¨˜è€…å¼µèŠæœ‰ä¸è»Œè¡Œç‚ºã€‚',
                isKiller: false
            },
            {
                name: 'å¼µèŠ',
                description: 'ä¸€ä½å…ƒè¿½è¹¤å­¸è¡“é†œèçš„è¨˜è€…ï¼Œç§˜å¯†ç™»å³¶ã€‚',
                storyline: `æˆ‘æ”¶åˆ°ç·šå ±ï¼Œç¨±æåšå£«çš„ç ”ç©¶æ¶‰å«Œé€ å‡ï¼Œæˆ‘æ˜¯ä¾†èª¿æŸ¥çœŸç›¸çš„ã€‚ä»Šæ™šæ˜¯æœ€å¥½çš„æ©Ÿæœƒã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘ç¹åˆ°æåšå£«æ›¸æˆ¿çš„çª—å¤–ï¼Œçœ‹åˆ°å¥¹æ­£åœ¨é›»è…¦å‰æ‰“å­—ï¼Œä¼¼ä¹åœ¨å¯«è‘—ä»€éº¼é‡è¦çš„æ±è¥¿ã€‚æˆ‘ç”¨é•·ç„¦ç›¸æ©Ÿæ‹ä¸‹äº†å¹¾å¼µæ¨¡ç³Šçš„ç…§ç‰‡ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘å˜—è©¦å¾æ­£é–€é€²å…¥æ›¸æˆ¿ï¼Œæƒ³æ‰¾å¥¹ç•¶é¢å°è³ªï¼Œä½†é–€è¢«åé–äº†ã€‚æˆ‘è©¦åœ–ç”¨éµçµ²é–‹é–ï¼Œçµæœè¢«æŠ€è¡“å“¡é™³é»˜æ’è¦‹äº†ï¼Œæˆ‘åªå¥½å‡è£è·¯éé›¢é–‹ã€‚\n**æ™šä¸Š9:50**ï¼šæˆ‘å›åˆ°è‡ªå·±çš„ä½è™•ï¼Œæ”¾å¤§ç›¸æ©Ÿè£¡çš„ç…§ç‰‡ï¼Œç™¼ç¾å¥¹æ‰“å­—çš„å…§å®¹ä¼¼ä¹æ˜¯ä¸€å°éºæ›¸ï¼Œä½†å…§å®¹å¾ˆå¥‡æ€ªï¼Œå¥½åƒåœ¨æš—ç¤ºä»€éº¼ã€‚æˆ‘é‚„æ‹åˆ°å¥¹æ¡Œä¸Šæœ‰ä¸€å€‹é™æ§å™¨ä¸€æ¨£çš„æ±è¥¿ã€‚`,
                tasks: '1. éš±è—ä½ è¨˜è€…çš„èº«ä»½å’Œä½ ç™»å³¶çš„çœŸå¯¦ç›®çš„ã€‚\n2. ä½ æ‹åˆ°çš„ç…§ç‰‡æ˜¯é—œéµè­‰æ“šï¼Œä½†ç›´æ¥æ‹¿å‡ºä¾†æœƒæš´éœ²ä½ è‡ªå·±ã€‚ä½ éœ€è¦å·§å¦™åœ°å¼•å°å¤§å®¶ç™¼ç¾éºæ›¸å’Œé™æ§å™¨çš„å•é¡Œã€‚\n3. ä½ æ˜¯å¤–ä¾†è€…ï¼Œå«Œç–‘æœ€å¤§ï¼Œå¿…é ˆå„˜å¿«æ‰¾åˆ°å…‡æ‰‹ã€‚',
                isKiller: true
            }
        ],
        clues: [
            { owner: 'é«˜é ', description: 'ä½ çš„é›»è…¦å›æ”¶ç«™è£¡æœ‰ä¸€ä»½æœªç™¼é€çš„éƒµä»¶ï¼Œå…§å®¹æ˜¯å‘ç«¶çˆ­å°æ‰‹çš„å…¬å¸æŠ•éç°¡æ­·ï¼Œä¸¦é™„è¨€å¯ä»¥æä¾›â€œæ¯”ç‰¹ç„¡é™â€çš„æ ¸å¿ƒä»£ç¢¼ã€‚' },
            { owner: 'æ—é›ª', description: 'åœ¨ä½ çš„æŠ½å±œè£¡ï¼Œç™¼ç¾äº†ä¸€ç“¶æ¨™ç±¤è¢«æ’•æ‰çš„åŒ–å­¸è©¦åŠ‘ï¼Œç¶“éæª¢é©—ï¼Œæ˜¯ç„¡æ¯’çš„ç‡Ÿé¤Šæ¶²ã€‚' },
            { owner: 'é™³é»˜', description: 'ä¸€å¼µå·¥ä½œæ—¥å¿—ï¼Œä¸Šé¢å¯«è‘—â€œ20:30-20:31ï¼Œ18æ¨“æ±å€ä¼ºæœå™¨æ„å¤–é‡å•Ÿï¼ŒåŸå› æ’æŸ¥ä¸­â€ã€‚'},
            { owner: 'å¼µèŠ', description: 'ä½ çš„ç›¸æ©Ÿè£¡æœ‰å¤šå¼µç…§ç‰‡ï¼Œå…¶ä¸­ä¸€å¼µæ¸…æ™°åœ°æ‹åˆ°æ­»è€…é›»è…¦è¢å¹•ä¸Šçš„éºæ›¸å…§å®¹ï¼Œå¦ä¸€å¼µæ¨¡ç³Šåœ°æ‹åˆ°äº†æ¡Œä¸Šçš„ä¸€å€‹å°å‹é™æ§è£ç½®ã€‚', isKey: true },
            { owner: 'å…¬å…±', description: 'æ­»è€…æ‰‹é‚Šçš„å’–å•¡æ¯è£¡æª¢æ¸¬å‡ºé«˜æ¿ƒåº¦çš„æ°°åŒ–ç‰©ï¼Œä½†å¥‡æ€ªçš„æ˜¯ï¼Œå’–å•¡åŸºæœ¬æ²’å–ã€‚' },
            { owner: 'å…¬å…±', description: 'æ›¸æˆ¿çš„é€šé¢¨å£å…§å´ï¼Œç™¼ç¾ä¸€å€‹è¢«æ”¹è£éçš„ã€é€£æ¥è‘—å°å‹éœ§åŒ–å™´å˜´çš„é™æ§é¦™è–°æ©Ÿï¼Œè£¡é¢æ®˜ç•™æœ‰æ°°åŒ–ç‰©æ¶²é«”ã€‚' },
            { owner: 'å…¬å…±', description: 'æ­»è€…çš„é›»è…¦æµè¦½å™¨æ­·å²é¡¯ç¤ºï¼Œå¥¹åœ¨æ­»å‰æœ€å¾Œä¸€å€‹è¨ªå•çš„é é¢æ˜¯å¥¹å·²æ•…ä¸ˆå¤«çš„ç´€å¿µç¶²ç«™ã€‚' }
        ],
        truth: 'å…‡æ‰‹æ˜¯è¨˜è€…å¼µèŠã€‚ä»–ä¸¦éæƒ³æ®ºæ­»æåšå£«ï¼Œè€Œæ˜¯æƒ³è£½é€ æ··äº‚ä»¥ç«Šå–å­¸è¡“é€ å‡çš„è­‰æ“šã€‚ä»–æå‰åœ¨æ›¸æˆ¿çš„é€šé¢¨å£å®‰è£äº†é™æ§æ¯’æ°£è£ç½®ï¼Œè¨ˆç•«åœ¨æ¡è¨ªæ™‚å¦‚æœæåšå£«ä¸é…åˆï¼Œå°±å°‘é‡é‡‹æ”¾è®“å¥¹æ˜è¿·ã€‚ä½†ä»–æ²’æƒ³åˆ°ï¼Œç•¶æ™šæåšå£«å› ç‚ºæ€å¿µäº¡å¤«è€Œæƒ…ç·’ä½è½ï¼Œæ­£åœ¨å¯«ä¸€å°çœŸçš„éºæ›¸ã€‚å¼µèŠåœ¨çª—å¤–çœ‹åˆ°éºæ›¸ï¼Œèª¤ä»¥ç‚ºæ™‚æ©Ÿå·²åˆ°ï¼Œä¾¿æŒ‰ä¸‹äº†é™æ§å™¨ï¼Œå°è‡´æåšå£«å¸å…¥éé‡æ¯’æ°£èº«äº¡ã€‚ä»–ä¹‹å¾Œå˜—è©¦é€²å…¥æˆ¿é–“å–å›è£ç½®æœªæœã€‚'
    },
    // --- ã€å…¨æ–°åŠ‡æœ¬2ï¼šå¤å ¡é­…å½±ã€‘ ---
    {
        id: 'built_in_3',
        name: 'å¤å ¡é­…å½±',
        storyBackground: 'åœ¨æ¿ƒéœ§ç± ç½©çš„åé å¤å ¡è£¡ï¼Œå¯Œæœ‰è€Œå¤æ€ªçš„ä¼¯çˆµè¢«ç™¼ç¾æ­»åœ¨åé–çš„æ›¸æˆ¿ä¸­ï¼Œèƒ¸å£æ’è‘—ä¸€æŠŠå¤è‘£æ‹†ä¿¡åˆ€ã€‚çŒ›çƒˆçš„æš´é¢¨é›¨åˆ‡æ–·äº†åŸå ¡èˆ‡å¤–ç•Œçš„å”¯ä¸€æ©‹æ¨‘ï¼Œæ‰€æœ‰äººéƒ½è¢«å›°æ–¼æ­¤ï¼šä¼¯çˆµå¹´è¼•è²Œç¾çš„å¦»å­ã€èˆ‡ä»–ç´ æœ‰å«Œéš™çš„ä¾„å­ã€è² å‚µç´¯ç´¯çš„ç§äººé†«ç”Ÿï¼Œä»¥åŠä¸€ä½è¢«è«‹ä¾†é€²è¡Œé™ç¥æœƒçš„å¥³å·«ã€‚',
        roles: [
            {
                name: 'å®‰å¨œ',
                description: 'ä¼¯çˆµçš„å¹´è¼•å¦»å­ï¼Œè¢«å¤–ç•Œå‚³è¨€æ˜¯ç‚ºäº†è²¡ç”¢æ‰å«çµ¦å¹´é‚çš„ä¼¯çˆµã€‚',
                storyline: `æˆ‘å—å¤ äº†é€™æ®µæ²’æœ‰æ„›æƒ…çš„å©šå§»ã€‚æˆ‘æ„›ä¸Šäº†ä¾„å­æ„›å¾·è¯ï¼Œæˆ‘å€‘è¨ˆç•«ç§å¥”ã€‚\n**æ™šä¸Š8:00**ï¼šæˆ‘å’Œæ„›å¾·è¯åœ¨èŠ±åœ’ç§˜å¯†æœƒé¢ï¼Œå•†é‡ç§å¥”çš„ç´°ç¯€ã€‚æˆ‘å‘Šè¨´ä»–ï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€æ¢å¯ä»¥é€šå¾€æ›¸æˆ¿çš„å¯†é“ã€‚\n**æ™šä¸Š9:00**ï¼šä¼¯çˆµæŠŠæˆ‘å«åˆ°æ›¸æˆ¿ï¼Œå†æ¬¡å› ç‚ºæˆ‘è³¼è²·å¥¢ä¾ˆå“çš„äº‹èˆ‡æˆ‘çˆ­åµï¼Œä¸¦å¨è„…è¦ä¿®æ”¹éºå›‘ï¼Œå‰å¥ªæˆ‘çš„ç¹¼æ‰¿æ¬Šã€‚æˆ‘æ†¤æ€’åœ°é›¢é–‹ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘å›åˆ°æˆ¿é–“ï¼Œæ”¶æ‹¾å¥½æˆ‘çš„ç å¯¶æº–å‚™é›¢é–‹ã€‚æ­¤æ™‚æˆ‘è½åˆ°æ¨“ä¸‹å‚³ä¾†ä¸€è²å¥³äººçš„å°–å«ï¼Œä½†å¾ˆå¿«å°±æ¶ˆå¤±äº†ã€‚\n**æ™šä¸Š10:00**ï¼šæˆ‘å¾æˆ¿é–“çš„å¯†é“å…¥å£é€²å…¥ï¼Œæƒ³å»æ›¸æˆ¿å·èµ°éºå›‘ã€‚ç•¶æˆ‘å¾æ›¸æˆ¿çš„å£çˆå¾Œèµ°å‡ºä¾†æ™‚ï¼Œç™¼ç¾ä¼¯çˆµå·²ç¶“å€’åœ¨è¡€æ³Šè£¡ã€‚æˆ‘åš‡å£äº†ï¼Œç«‹åˆ»åŸè·¯è¿”å›ï¼Œä¸æ•¢è²å¼µã€‚`,
                tasks: '1. éš±è—ä½ å’Œæ„›å¾·è¯çš„ç§æƒ…ä»¥åŠç§å¥”è¨ˆç•«ã€‚\n2. éš±è—ä½ æ›¾é€šéå¯†é“é€²å…¥æ¡ˆç™¼ç¾å ´çš„äº‹å¯¦ã€‚\n3. ä½ èªç‚ºå…‡æ‰‹æ˜¯å…¶ä»–äººï¼Œéœ€è¦å„˜å¿«æ‰¾åˆ°è­‰æ“šæ´—è„«å«Œç–‘ã€‚',
                isKiller: false
            },
            {
                name: 'æ„›å¾·è¯',
                description: 'ä¼¯çˆµçš„ä¾„å­ï¼Œæ”¾è•©ä¸ç¾ˆï¼Œæ˜¯åŸå ¡çš„æ³•å®šç¹¼æ‰¿äººï¼Œä½†èˆ‡ä¼¯çˆµé—œä¿‚æƒ¡åŠ£ã€‚',
                storyline: `æˆ‘æ€¥éœ€ç”¨éŒ¢ï¼Œä½†è€å‚¢ä¼™ä¸€åˆ†éŒ¢éƒ½ä¸è‚¯çµ¦æˆ‘ã€‚æˆ‘ä»Šæ™šæº–å‚™å·é»æ±è¥¿å»è³£ã€‚\n**æ™šä¸Š8:00**ï¼šæˆ‘å’Œå®‰å¨œåœ¨èŠ±åœ’è¦‹é¢ï¼Œå¥¹å‘Šè¨´æˆ‘ä¸€æ¢é€šå¾€æ›¸æˆ¿çš„å¯†é“ï¼Œé€™æ­£åˆæˆ‘æ„ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘çœ‹åˆ°é†«ç”Ÿé¦¬ä¸è¡Œè‰²åŒ†åŒ†åœ°é€²äº†ä¼¯çˆµçš„æ›¸æˆ¿ã€‚\n**æ™šä¸Š9:10**ï¼šæˆ‘æº–å‚™é€šéå®‰å¨œå‘Šè¨´æˆ‘çš„å¯†é“é€²å…¥æ›¸æˆ¿ï¼Œä½†åœ¨å¯†é“å£è½åˆ°äº†è£¡é¢æœ‰å¥‡æ€ªçš„éŸ¿å‹•ï¼Œæˆ‘å®³æ€•è¢«ç™¼ç¾ï¼Œå°±é€€äº†å›ä¾†ã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘åœ¨èµ°å»Šè£¡é‡åˆ°äº†å¥³å·«ç¾…è˜­å¥³å£«ï¼Œå¥¹è­¦å‘Šæˆ‘ä»Šæ™šåŸå ¡æœƒæœ‰è¡€å…‰ä¹‹ç½ï¼Œè®“æˆ‘ä¸è¦äº‚èµ°å‹•ã€‚å¥¹çš„çœ¼ç¥å¾ˆå¥‡æ€ªï¼Œè®“æˆ‘ä¸å¯’è€Œæ…„ã€‚`,
                tasks: '1. éš±è—ä½ è¨ˆç•«å·ç«Šä»¥åŠçŸ¥é“å¯†é“çš„äº‹å¯¦ã€‚\n2. ä¼¯çˆµæ­»äº†ï¼Œä½ æ˜¯æœ€å¤§å—ç›Šäººï¼Œä½ çš„å«Œç–‘æœ€å¤§ã€‚ä½ éœ€è¦å°‡å«Œç–‘è½‰ç§»åˆ°ä»–äººèº«ä¸Šï¼Œæ¯”å¦‚é†«ç”Ÿæˆ–è¡Œç‚ºè©­ç•°çš„å¥³å·«ã€‚\n3. ä½ éœ€è¦æ‰¾åˆ°å°ä½ æœ‰åˆ©çš„è­‰æ“šã€‚',
                isKiller: false
            },
            {
                name: 'é¦¬ä¸é†«ç”Ÿ',
                description: 'ä¼¯çˆµçš„ç§äººé†«ç”Ÿï¼Œé†«è¡“é«˜æ˜ï¼Œä½†æ·±é™·è³­åšå‚µå‹™ã€‚',
                storyline: `æˆ‘æ¬ äº†ä¼¯çˆµä¸€å¤§ç­†éŒ¢ï¼Œä»–æ‹¿èµ°äº†æˆ‘çš„è¡Œé†«åŸ·ç…§ä½œç‚ºæŠµæŠ¼ï¼Œä¸¦å¨è„…å¦‚æœæˆ‘é‚„ä¸ä¸ŠéŒ¢ï¼Œå°±è®“æˆ‘èº«æ•—åè£‚ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘å»æ‰¾ä¼¯çˆµï¼Œæ‡‡æ±‚ä»–å†å¯¬é™æˆ‘ä¸€æ®µæ™‚é–“ã€‚ä»–ä¸åƒ…æ‹’çµ•äº†ï¼Œé‚„ç¾è¾±äº†æˆ‘ä¸€ç•ªã€‚æˆ‘çµ•æœ›åœ°é›¢é–‹ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘å›åˆ°æˆ‘çš„æˆ¿é–“ï¼Œæº–å‚™äº†ä¸€äº›å¼·æ•ˆé®å®šåŠ‘ï¼Œæˆ‘è¨ˆç•«è®“ä»–ç¡è‘—ï¼Œç„¶å¾Œå·å›æˆ‘çš„è¡Œé†«åŸ·ç…§ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘å†æ¬¡ä¾†åˆ°æ›¸æˆ¿é–€å£ï¼Œå»è½åˆ°è£¡é¢å®‰å¨œå’Œä¼¯çˆµåœ¨æ¿€çƒˆçˆ­åµã€‚æˆ‘åªå¥½æš«æ™‚æ”¾æ£„è¨ˆç•«ï¼Œèº²åœ¨é™„è¿‘è§€å¯Ÿã€‚\n**æ™šä¸Š9:40å¾Œ**ï¼šæˆ‘çœ‹åˆ°å®‰å¨œæ°£è¡è¡åœ°é›¢é–‹å¾Œï¼Œå°±å†ä¹Ÿæ²’äººé€²å‡ºéæ›¸æˆ¿ã€‚æˆ‘å› ç‚ºå®³æ€•ä¸€ç›´æ²’æ•¢å‹•æ‰‹ï¼Œç›´åˆ°å±é«”è¢«ç™¼ç¾ã€‚`,
                tasks: '1. éš±è—ä½ æ¬ ä¸‹å·¨é¡è³­å‚µä¸¦è¢«ä¼¯çˆµå¨è„…çš„äº‹å¯¦ã€‚\n2. éš±è—ä½ æº–å‚™äº†é®å®šåŠ‘ä¸¦è¨ˆç•«å·æ±è¥¿çš„æ„åœ–ã€‚\n3. ä½ æ˜¯æœ€å¾Œä¸€å€‹è¦‹åˆ°ä¼¯çˆµçš„äººä¹‹ä¸€ï¼Œä½ éœ€è¦è­‰æ˜ä½ é›¢é–‹å¾Œé‚„æœ‰ä½œæ¡ˆæ™‚é–“ã€‚',
                isKiller: false
            },
            {
                name: 'ç¾…è˜­å¥³å£«',
                description: 'è‘—åçš„éˆåª’ã€å¥³å·«ï¼Œè¢«ä¼¯çˆµè«‹ä¾†é€²è¡Œé™ç¥æœƒï¼Œèˆ‡åŸå ¡çš„â€œå¹½éˆâ€å°è©±ã€‚',
                storyline: `æˆ‘æ˜¯å€‹é¨™å­ã€‚ä¼¯çˆµç™¼ç¾äº†æˆ‘çš„ç§˜å¯†ï¼Œä¸¦ä»¥æ­¤æ•²è©æˆ‘ï¼Œè®“æˆ‘å…è²»ç‚ºä»–â€œæœå‹™â€ã€‚\n**æ™šä¸Š9:10**ï¼šä¼¯çˆµæŠŠæˆ‘å«åˆ°æ›¸æˆ¿ï¼Œå†æ¬¡å¨è„…æˆ‘ï¼Œèªªå¦‚æœä»Šæ™šçš„é™ç¥æœƒä¸èƒ½è®“ä»–æ»¿æ„ï¼Œå°±è¦æ­ç©¿æˆ‘çš„ä¸€åˆ‡ã€‚æˆ‘æ„Ÿåˆ°å‰æ‰€æœªæœ‰çš„ææ‡¼ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘è—‰å£æº–å‚™å„€å¼ï¼Œç¨è‡ªç•™åœ¨æ›¸æˆ¿ã€‚ä¼¯çˆµèƒŒå°è‘—æˆ‘ï¼Œåœ¨æ¬£è³ä¸€å¹…ç•«ã€‚æˆ‘çœ‹åˆ°æ¡Œä¸Šæœ‰ä¸€æŠŠé‹’åˆ©çš„æ‹†ä¿¡åˆ€ï¼Œä¸€æ™‚è¡å‹•ï¼Œæ‹¿èµ·åˆ€å¾èƒŒå¾Œåˆºå‘äº†ä»–ã€‚ä»–ç•¶å ´å€’ä¸‹ã€‚æˆ‘ç™¼å‡ºä¸€è²çŸ­ä¿ƒçš„å°–å«ï¼Œä½†ç«‹åˆ»æ‚ä½äº†å˜´ã€‚\n**æ™šä¸Š9:35**ï¼šæˆ‘æ…Œäº‚åœ°å°‡æ›¸æˆ¿é–€å¾å…§åé–ï¼Œç„¶å¾Œå¾ç‰†è§’çš„æ›¸æ¶å¾Œé¢å•Ÿå‹•äº†å¯†é“ï¼ˆé€™æ˜¯æˆ‘ä¹‹å‰å·å·ç™¼ç¾çš„ï¼‰ï¼Œé€ƒé›¢äº†ç¾å ´ã€‚åœ¨å¯†é“ä¸­ï¼Œæˆ‘çš„ä¸€ç‰‡è•¾çµ²è¢–å£è¢«æ›æ‰äº†ã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘å¾å¯†é“å‡ºä¾†ï¼Œé‡åˆ°äº†æ„›å¾·è¯ï¼Œæˆ‘æ•…ä½œç¥ç§˜åœ°è­¦å‘Šä»–æœ‰è¡€å…‰ä¹‹ç½ï¼Œä»¥æ©é£¾æˆ‘çš„æ…Œå¼µã€‚`,
                tasks: '1. ä½ æ˜¯çœŸå‡¶ï¼ä½ çš„ä»»å‹™æ˜¯éš±è—ä¸€åˆ‡ï¼Œå°‡ç½ªè¡Œå«ç¦çµ¦ä»–äººã€‚\n2. åˆ©ç”¨ä½ â€œå¥³å·«â€çš„èº«ä»½ï¼Œç·¨é€ ä¸€äº›é¬¼ç¥ä¹‹èªªä¾†æ··æ·†è¦–è½ã€‚\n3. æ„›å¾·è¯å’Œå®‰å¨œéƒ½çŸ¥é“å¯†é“ï¼Œé€™æ˜¯å«ç¦ä»–å€‘çš„å¥½æ©Ÿæœƒã€‚é¦¬ä¸é†«ç”Ÿæœ‰å¼·çƒˆçš„å‹•æ©Ÿï¼Œä¹Ÿå¯ä»¥åŠ ä»¥åˆ©ç”¨ã€‚',
                isKiller: true
            }
        ],
        clues: [
            { owner: 'å®‰å¨œ', description: 'ä½ çš„ç å¯¶ç›’è£¡æœ‰ä¸€å¼µå–®ç¨‹çš„ç«è»Šç¥¨ï¼Œç›®çš„åœ°æ˜¯å·´é»ï¼Œæ™‚é–“æ˜¯æ˜å¤©ä¸€æ—©ã€‚' },
            { owner: 'æ„›å¾·è¯', description: 'ä½ çš„å£è¢‹è£¡æœ‰ä¸€å¼µç•¶ç¥¨ï¼Œä¸Šé¢æ˜¯ä¸€æšå±¬æ–¼ä¼¯çˆµå®¶æ—çš„å¤è‘£æ‡·éŒ¶ã€‚' },
            { owner: 'é¦¬ä¸é†«ç”Ÿ', description: 'ä½ çš„è—¥ç®±è£¡æœ‰ä¸€ç“¶å¹¾ä¹æ»¿è£çš„å¼·æ•ˆé®å®šåŠ‘ï¼Œä»¥åŠä¸€å¼µä¼¯çˆµå¯«çš„ã€è¦æ±‚ä½ ä¸€å‘¨å…§é‚„æ¸…10è¬è‹±éŠæ¬ æ¬¾çš„å­—æ¢ã€‚' },
            { owner: 'ç¾…è˜­å¥³å£«', description: 'ä½ çš„é•·è£™è¢–å£è™•æœ‰ä¸€å¡Šæ˜é¡¯çš„æ’•è£‚ç—•è·¡ï¼Œä¼¼ä¹æ˜¯è¢«ä»€éº¼æ±è¥¿æ›å£çš„ã€‚', isKey: true },
            { owner: 'å…¬å…±', description: 'åœ¨æ›¸æˆ¿å£çˆå¾Œé¢ç™¼ç¾ä¸€å€‹éš±è”½çš„æŒ‰éˆ•ï¼ŒæŒ‰ä¸‹å¾Œï¼Œæ—é‚Šçš„ä¸€æ•´é¢æ›¸æ¶æœƒæ—‹è½‰æ‰“é–‹ï¼Œéœ²å‡ºä¸€æ¢é€šå¾€æ¨“ä¸Šèµ°å»Šçš„å¯†é“ã€‚' },
            { owner: 'å…¬å…±', description: 'åœ¨å¯†é“çš„åœ°æ¿ä¸Šï¼Œç™¼ç¾äº†ä¸€å°ç‰‡é»‘è‰²çš„è•¾çµ²å¸ƒæ–™ã€‚' },
            { owner: 'å…¬å…±', description: 'ä¼¯çˆµçš„æ›¸æ¡Œä¸Šæ”¤é–‹è‘—ä¸€æœ¬é—œæ–¼â€œéˆåª’èˆ‡æ¬ºè©â€çš„æ›¸ï¼Œå…¶ä¸­ä¸€é ç”¨ç´…ç­†åœˆå‡ºäº†â€œç¾…è˜­å¥³å£«â€çš„åå­—ã€‚' }
        ],
        truth: 'å…‡æ‰‹æ˜¯å¥³å·«ç¾…è˜­å¥³å£«ã€‚ä¼¯çˆµç™¼ç¾äº†å¥¹æ˜¯å€‹é¨™å­ä¸¦ä»¥æ­¤æ•²è©å¥¹ã€‚ç•¶æ™šï¼Œä¼¯çˆµå†æ¬¡å¨è„…å¥¹ï¼Œç¾…è˜­åœ¨ææ‡¼å’Œæ†¤æ€’ä¹‹ä¸‹ï¼Œç”¨æ‹†ä¿¡åˆ€å¾èƒŒå¾Œæ®ºå®³äº†ä¼¯ä¸»ã€‚å¥¹çŸ¥é“åŸå ¡çš„å¯†é“ï¼Œæ–¼æ˜¯åé–æˆ¿é–€ï¼Œé€šéå¯†é“é€ƒé›¢ï¼Œå½é€ äº†å¯†å®¤æ®ºäººæ¡ˆã€‚ä½†æ…Œäº‚ä¸­ï¼Œå¥¹çš„ä¸€ç‰‡è•¾fçµ²è¢–å£æ›åœ¨äº†å¯†é“è£¡ï¼Œæˆç‚ºäº†é—œéµè­‰æ“šã€‚'
    }
];

// â–²â–²â–² åŠ‡æœ¬åº«é»è²¼çµæŸ â–²â–²â–²

        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models'
        // geminiå¦‚æœæ˜¯å¤šå€‹é‡‘é‘°, é‚£éº¼éš¨æ©Ÿç²å–ä¸€å€‹
    function getRandomValue(str) {
        // æª¢æŸ¥å­—ä¸²æ˜¯å¦åŒ…å«é€—è™Ÿ
        if (str.includes(',')) {
            // ç”¨é€—è™Ÿåˆ†éš”å­—ä¸²ä¸¦ç§»é™¤å¤šé¤˜ç©ºæ ¼
            const arr = str.split(',').map(item => item.trim());
            // ç”Ÿæˆéš¨æ©Ÿç´¢å¼• (0 åˆ° arr.length-1)
            const randomIndex = Math.floor(Math.random() * arr.length);
            // è¿”å›éš¨æ©Ÿå…ƒç´ 
            return arr[randomIndex];
        }
        // æ²’æœ‰é€—è™Ÿå‰‡ç›´æ¥è¿”å›åŸå­—ä¸²
        return str;
    }
    function isImage(text,content) {
        let currentImageData = content.image_url.url
        // æå–Base64è³‡æ–™ï¼ˆå»æ‰é¦–ç¢¼ï¼‰
        const base64Data = currentImageData.split(',')[1];
        // æ ¹æ“šåœ–ç‰‡é¡å‹ç²å–MIMEé¡å‹
        const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
        return [
            {text: `${text.text}ä½¿ç”¨è€…å‘ä½ ç™¼é€äº†ä¸€å¼µåœ–ç‰‡`},
            {
                inline_data: {
                    mime_type: mimeType,
                    data: base64Data
                }
            }
        ]
    }

   function extractArray(text) {
        // è¦å‰‡é‹ç®—å¼æ¨¡å¼ï¼šåŒ¹é…é–‹é ­çš„æ™‚é–“æˆ³è¨˜éƒ¨åˆ†å’Œå¾ŒçºŒçš„JSONé™£åˆ—
        const pattern = /^\(Timestamp: (\d+)\)(.*)$/s;
        const match = text.match(pattern);

        if (match) {
            const timestampPart = `(Timestamp: ${match[1]}) `;
            const jsonPart = match[2].trim();

            try {
                // å˜—è©¦è§£æJSONéƒ¨åˆ†
                const parsedJson = JSON.parse(jsonPart);
                // é©—è­‰è§£æçµæœæ˜¯å¦ç‚ºé™£åˆ—
                if (Array.isArray(parsedJson)) {
                    return [timestampPart, parsedJson[0]];
                }
            } catch (error) {
                // è§£æå¤±æ•—ï¼Œè¿”å›åŸå§‹æ–‡æœ¬
            }
        }

        // ä¸åŒ¹é…æ ¼å¼æˆ–è§£æå¤±æ•—æ™‚è¿”å›åŸå€¼
        return text;
    }
    function transformChatData(item) {
        let type = {
            send_and_recall:'æ’¤å›äº†æ¶ˆæ¯',
            update_status:'æ›´æ–°äº†ç‹€æ…‹',
            change_music:'åˆ‡æ›äº†æ­Œæ›²',
            create_memory:'è¨˜éŒ„äº†å›æ†¶',
            create_countdown:'å‰µå»ºäº†ç´„å®š/å€’è¨ˆæ™‚',
            text:'ç™¼é€äº†æ–‡æœ¬',
            sticker:'ç™¼é€äº†è¡¨æƒ…',
            ai_image:'ç™¼é€äº†åœ–ç‰‡',
            voice_message:'ç™¼é€äº†èªéŸ³',
            transfer:'ç™¼èµ·äº†è½‰å¸³',
            waimai_request:'ç™¼èµ·äº†å¤–è³£è«‹æ±‚',
            waimai_response:{
                paid:'å›æ‡‰äº†å¤–è³£-åŒæ„',
                rejected:'å›æ‡‰äº†å¤–è³£-æ‹’çµ•'
            },
            video_call_request:'ç™¼èµ·äº†è¦–é »é€šè©±',
            video_call_response:{
                accept:'å›æ‡‰äº†è¦–é »é€šè©±-æ¥å—',
                reject:'å›æ‡‰äº†è¦–é »é€šè©±-æ‹’çµ•'
            },
            qzone_post:{
                shuoshuo:'ç™¼ä½ˆäº†èªªèªª',
                text_image:'ç™¼ä½ˆäº†æ–‡å­—åœ–'
            },
            qzone_comment:'è©•è«–äº†å‹•æ…‹',
            qzone_like:'é»è´Šäº†å‹•æ…‹',
            pat_user:'æ‹ä¸€æ‹äº†ç”¨æˆ¶',
            block_user:'æ‹‰é»‘äº†ç”¨æˆ¶',
            friend_request_response:'å›æ‡‰äº†å¥½å‹ç”³è«‹',
            change_avatar:'æ›´æ›äº†é ­åƒ',
            share_link:'åˆ†äº«äº†é€£çµ',
            accept_transfer:'å›æ‡‰äº†è½‰å¸³-æ¥å—',
            decline_transfer:'å›æ‡‰äº†è½‰å¸³-æ‹’çµ•/é€€æ¬¾',
            quote_reply:'å¼•ç”¨äº†å›å¾©',
            text:'',
        }
        let res = extractArray(item.content)

        if(Array.isArray(res)){
            let obj = res[1]
            let itemType = obj.type;
            let time = res[0]
            let text = type[itemType];
            if(text){
                if(itemType === 'sticker'){
                    return [{text:`${time}[${text}] å«ç¾©æ˜¯:${obj.meaning}`}]
                }else if(itemType === 'send_and_recall'){
                    return [{text:`${time}[${text}] ${obj.content}`}]
                }else if(itemType === 'update_status'){
                    return [{text:`${time}[${text}] ${obj.status_text}(${obj.is_busy ? 'å¿™ç¢Œ/é›¢é–‹' : 'ç©ºé–’'})`}]
                }else if(itemType === 'change_music'){
                    return [{text:`${time}[${text}] ${obj.change_music}, æ­Œåæ˜¯:${obj.song_name}`}]
                }else if(itemType === 'create_memory'){
                    return [{text:`${time}[${text}] ${obj.description}`}]
                }else if(itemType === 'create_countdown'){
                    return [{text:`${time}[${text}] ${obj.title}(${obj.date})`}]
                }else if(itemType === 'ai_image'){
                    return [{text:`${time}[${text}] åœ–ç‰‡æè¿°æ˜¯:${obj.description}`}]
                }else if(itemType === 'voice_message'){
                    return [{text:`${time}[${text}] ${obj.content}`}]
                }else if(itemType === 'transfer'){
                    return [{text:`${time}[${text}] é‡‘é¡æ˜¯:${obj.amount} å‚™è¨»æ˜¯:${obj.amount}`}]
                }else if(itemType === 'waimai_request'){
                    return [{text:`${time}[${text}] é‡‘é¡æ˜¯:${obj.amount} å•†å“æ˜¯:${obj.productInfo}`}]
                }else if(itemType === 'waimai_response'){
                    return [{text:`${time}[${text[obj.status]}] ${obj.status === 'paid' ? 'åŒæ„' : 'æ‹’çµ•'}`}]
                }else if(itemType === 'video_call_request'){
                    return [{text:`${time}[${text}]`}]
                }}else if(itemType === 'video_call_request'){
                    return [{text:`${time}[${text[obj.decision]}] ${obj.decision === 'accept' ? 'åŒæ„' : 'æ‹’çµ•'}`}]
                }else if(itemType === 'qzone_post'){
                    return [{text:`${time}[${text[obj.postType]}] ${obj.postType === 'shuoshuo' ? `${obj.content}` : `åœ–ç‰‡æè¿°æ˜¯:${obj.hiddenContent} ${obj.publicText ? `æ–‡æ¡ˆæ˜¯: ${obj.publicText}` : ''}`}`}]
                }else if(itemType === 'qzone_comment'){
                    return [{text:`${time}[${text}] è©•è«–çš„idæ˜¯: ${obj.postId} è©•è«–çš„å…§å®¹æ˜¯: ${obj.commentText}`}]
                }else if(itemType === 'qzone_like'){
                    return [{text:`${time}[${text}] é»è´Šçš„idæ˜¯: ${obj.postId}`}]
                }else if(itemType === 'pat_user'){
                    return [{text:`${time}[${text}] ${obj.suffix ? obj.suffix  : ''}`}]
                }else if(itemType === 'block_user'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'friend_request_response'){
                    return [{text:`${time}[${text}] çµæœæ˜¯:${obj.decision === 'accept' ? 'åŒæ„' : 'æ‹’çµ•'}`}]
                }else if(itemType === 'change_avatar'){
                    return [{text:`${time}[${text}] é ­åƒåæ˜¯:${obj.name}`}]
                }else if(itemType === 'share_link'){
                    return [{text:`${time}[${text}] æ–‡ç« æ¨™é¡Œæ˜¯:${obj.title}  æ–‡ç« æ‘˜è¦æ˜¯:${obj.description} ä¾†æºç¶²ç«™åæ˜¯:${obj.source_name} æ–‡ç« æ­£æ–‡æ˜¯:${obj.content}`}]
                }else if(itemType === 'accept_transfer'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'accept_transfer'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'quote_reply'){
                    return [{text:`${time}[${text}] å¼•ç”¨çš„å…§å®¹æ˜¯:${obj.reply_content}`}]
                }else if(itemType === 'text'){
                    return [{text:`${time}${obj.content}`}]
                }
            }

    // (ä¾‹å¦‚ï¼Œå®ƒæ˜¯ä¸€å€‹é™£åˆ—ï¼Œæˆ–è€…ä¸€å€‹AIè¿”å›çš„ã€æˆ‘å€‘ä¸èªè­˜çš„JSONç‰©ä»¶)
    if (typeof res !== 'string') {
        // æˆ‘å€‘å°±å¼·åˆ¶ä½¿ç”¨æœ€åŸå§‹ã€æœ€å®‰å…¨çš„ item.content å­—ä¸²
        res = item.content;
    }

    return [{text: res}];
}

    function toGeminiRequestData(model, apiKey, systemInstruction, messagesForDecision,isGemini) {

	if(!isGemini){
		return undefined
	}

        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘å°‡ 'system' è§’è‰²ä¹Ÿæ˜ å°„ç‚º 'user'

        let roleType = {
            user: 'user',
            assistant: 'model',
            system: 'user' // <--- æ–°å¢é€™ä¸€è¡Œ
        }
        return {
            url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(apiKey)}`,
            data: {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: messagesForDecision.map((item) => {
                        let  includesImages = false;
                        if(Array.isArray(item.content) && item.content.length === 2){
                              includesImages =  item.content.some((sub)=>{
                                return sub.type === 'image_url' && sub.image_url.url
                            })
                        }
                        return {
                            role: roleType[item.role], // ç¾åœ¨ 'system' æœƒè¢«æ­£ç¢ºè½‰æ›ç‚º 'user'
                            parts: includesImages ? isImage(item.content[0],item.content[1]) : transformChatData(item)
                        }
                    }),
                    generationConfig: {
                        temperature: 0.8,
                    },
                    "systemInstruction": {
                        "parts": [{
                            "text": systemInstruction
                        }]
                    }
                })
            }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {

        // ===================================================================
        // 1. æ‰€æœ‰è®Šæ•¸å’Œå¸¸é‡å®šç¾©
        // ===================================================================
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯µç‰©æ•¸å€¼è¡°æ¸›ç›¸é—œçš„å…¨åŸŸè®Šæ•¸å’Œå¸¸é‡ â–¼â–¼â–¼
const PET_DECAY_INTERVAL = 60 * 60 * 1000; // æ¯60åˆ†é˜è¡°æ¸›ä¸€æ¬¡
const PET_DECAY_AMOUNT = { // æ¯æ¬¡è¡°æ¸›çš„æ•¸å€¼
    hunger: 5,
    happiness: 3
};
let petDecayTimer = null; // ç”¨æ–¼ç®¡ç†è¡°æ¸›è¨ˆæ™‚å™¨çš„å…¨åŸŸè®Šæ•¸
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è§’è‰²æ‰‹æ©Ÿçš„Appåˆ—è¡¨ï¼Œè«‹é»è²¼åˆ°JSé ‚éƒ¨ â–¼â–¼â–¼
const CHAR_PHONE_APPS = [
    { id: 'chat', name: 'å¾®ä¿¡', screen: 'character-chat-list-screen', svg: `<svg viewBox="0 0 24 24" fill="#4CAF50"><path d="M12 2C6.48 2 2 6.48 2 12c0 2.94 1.28 5.58 3.34 7.42c-.22 1.4-.89 3.1-1.25 3.82c-.36.72.48 1.39 1.05.94c.82-.67 2.43-1.88 3.3-2.58C9.44 21.78 10.68 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm3.5 10.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5zm-7 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></svg>` },
    { id: 'cart', name: 'è³¼ç‰©è»Š', screen: 'character-shopping-cart-screen', svg: `<svg viewBox="0 0 24 24" fill="#F44336"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2s-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2s2-.9 2-2s-.9-2-2-2zm-15-14h3.27l.94 2H20c.69 0 1.25.56 1.25 1.25c0 .09-.02.18-.04.27l-3.58 6.49c-.25.44-.73.74-1.26.74H8.52l-.94-2H4.27V4H2V2h3.27z"/></svg>` },
    { id: 'memos', name: 'å‚™å¿˜éŒ„', screen: 'character-memos-screen', svg: `<svg viewBox="0 0 24 24" fill="#FFC107"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>` },
    { id: 'browser', name: 'æµè¦½å™¨', screen: 'character-browser-screen', svg: `<svg viewBox="0 0 24 24" fill="#2196F3"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1.5-12.5l3 7.5 7.5-3-7.5-3z"/></svg>` },
    { id: 'album', name: 'ç›¸å†Š', screen: 'character-album-screen', svg: `<svg viewBox="0 0 24 24" fill="#8BC34A"><path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"/></svg>` },
    { id: 'bank', name: 'éŒ¢åŒ…', screen: 'character-bank-screen', svg: `<svg viewBox="0 0 24 24" fill="#E91E63"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>` },
    { id: 'trajectory', name: 'è¶³è·¡', screen: 'character-trajectory-screen', svg: `<svg viewBox="0 0 24 24" fill="#795548"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>` },
    { id: 'app_usage', name: 'ä½¿ç”¨è¨˜éŒ„', screen: 'character-app-usage-screen', svg: `<svg viewBox="0 0 24 24" fill="#607D8B"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8s8 3.58 8 8s-3.58 8-8 8zm.5-13H11v6l5.25 3.15l.75-1.23l-4.5-2.67z"/></svg>` },
    { id: 'diary', name: 'æ—¥è¨˜', screen: 'character-diary-screen', svg: `<svg viewBox="0 0 24 24" fill="#009688"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83l3.75 3.75 1.83-1.83z"/></svg>` },
    // é€™å°±æ˜¯æˆ‘å€‘æ–°åŠ çš„App
    { id: 'appearance', name: 'å¤–è§€è¨­ç½®', screen: 'character-phone-appearance-screen', svg: `<svg viewBox="0 0 24 24" fill="#9C27B0"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.17 14.34c-.21.21-.46.32-.71.32s-.5-.11-.71-.32l-1.41-1.41c-.2-.2-.31-.45-.31-.71 0-.26.11-.51.31-.71l1.41-1.41c.2-.2.45-.31.71-.31s.51.11.71.31l1.41 1.41c.4.4.4 1.04 0 1.41l-1.41 1.41zm3.34-5.34c-.21.21-.46.32-.71.32s-.5-.11-.71-.32L11.41 8.5c-.2-.2-.31-.45-.31-.71 0-.26.11-.51.31-.71l1.41-1.41c.2-.2.45-.31.71-.31s.51.11.71.31l1.41 1.41c.4.4.4 1.04 0 1.41l-1.41 1.41zm3.34 5.34c-.21.21-.46.32-.71.32s-.5-.11-.71-.32l-1.41-1.41c-.4-.4-.4-1.04 0-1.41l1.41-1.41c.2-.2.45-.31.71-.31s.51.11.71.31l1.41 1.41c.2.2.31.45.31.71 0 .26-.11.51-.31.71l-1.41 1.41z"/></svg>` }
];
// â–²â–²â–² ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
const db = new Dexie('GeminiChatDB');
        // â–¼â–¼â–¼ æŠŠä¸‹é¢é€™ä¸€æ•´å¡Šå…¨æ–°çš„å¾®åšåŠŸèƒ½ä»£ç¢¼ï¼Œé»è²¼åˆ°é€™è£¡ â–¼â–¼â–¼

/**
 * ã€å¾®åšã€‘ç¸½å…¥å£ï¼šæ ¹æ“šç•¶å‰å•Ÿå‹•çš„è¦–åœ–ï¼Œæ¸²æŸ“å°æ‡‰çš„å¾®åšFeed
 */
async function renderWeiboFeeds(viewId) {
    if (viewId === 'weibo-my-profile-view') {
        await renderMyWeiboFeed();
    } else if (viewId === 'weibo-following-view') {
        await renderFollowingWeiboFeed();
    }
}

// â–¼â–¼â–¼ ç”¨é€™ã€å…©å¡Šæ–°ä»£ç¢¼ã€‘åˆ†åˆ¥æ›¿æ›èˆŠçš„ renderMyWeiboFeed å’Œ renderFollowingWeiboFeed å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å¾®åšã€‘æ¸²æŸ“â€œæˆ‘çš„é¦–é â€ä¸Šçš„å¾®åšåˆ—è¡¨
 */
async function renderMyWeiboFeed() {
    const feedEl = document.getElementById('my-weibo-feed-list');
    const posts = await db.weiboPosts.where('authorId').equals('user').reverse().toArray();
    feedEl.innerHTML = '';
    if (posts.length === 0) {
        feedEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">ä½ é‚„æ²’æœ‰ç™¼éå¾®åšå“¦ï¼Œé»æ“Šå³ä¸Šè§’â€œ+â€è©¦è©¦å§ï¼</p>';
        return;
    }
    posts.forEach(post => {
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘èª¿ç”¨æˆ‘å€‘æ–°çš„å°ˆå±¬å‡½æ•¸ï¼
        feedEl.appendChild(createWeiboPostElement(post));
    });
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ renderFollowingWeiboFeed å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å¾®åšã€‘æ¸²æŸ“â€œé—œæ³¨çš„äººâ€çš„å¾®åšFeed (å·²ä¿®å¾©å¡é “å•é¡Œ)
 */
async function renderFollowingWeiboFeed() {
    const feedEl = document.getElementById('weibo-following-feed-list');
    
    // ã€æ ¸å¿ƒå„ªåŒ–ã€‘æˆ‘å€‘ä¸å†ä¸€æ¬¡æ€§è®€å–æ‰€æœ‰å¸–å­ï¼Œè€Œæ˜¯ç›´æ¥è®“è³‡æ–™åº«å¹«æˆ‘å€‘ç¯©é¸å’Œæ’åºï¼Œé€Ÿåº¦æœƒå¿«å¾ˆå¤šï¼
    const posts = await db.weiboPosts
        .where('authorId').notEqual('user') // 1. ç›´æ¥åœ¨è³‡æ–™åº«å±¤é¢ï¼Œæ‰¾å‡ºä½œè€…ä¸æ˜¯'user'çš„å¸–å­
        .reverse()                          // 2. è®“çµæœæŒ‰å€’åºæ’åˆ—
        .sortBy('timestamp');               // 3. æ ¹æ“šæ™‚é–“æˆ³è¨˜æ’åº

    // å¾ŒçºŒçš„æ¸²æŸ“é‚è¼¯ä¿æŒä¸è®Š
    feedEl.innerHTML = '';
    if (posts.length === 0) {
        feedEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">ä½ é—œæ³¨çš„äººé‚„æ²’æœ‰ç™¼ä½ˆä»»ä½•å‹•æ…‹å“¦ã€‚</p>';
        return;
    }
    posts.forEach(post => {
        feedEl.appendChild(createWeiboPostElement(post));
    });
}


// â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ createWeiboPostElement å‡½æ•¸ â–¼â–¼â–¼

function createWeiboPostElement(post) {
    const postEl = document.createElement('div');
    postEl.className = 'weibo-post-item'; 

    let contentHtml = '';
    if (post.content) {
        contentHtml += `<div class="weibo-post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
    }
    
    if (post.imageUrl) {
        if (post.postType === 'text_image') {
            contentHtml += `<img src="${post.imageUrl}" class="weibo-post-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent || ''}">`;
        } else {
            contentHtml += `<img src="${post.imageUrl}" class="weibo-post-image">`;
        }
    }

    let commentsHtml = '';
    if (post.comments && Array.isArray(post.comments) && post.comments.length > 0) {
        commentsHtml += '<div class="weibo-comments-container">';
        post.comments.forEach(comment => {
            if (typeof comment !== 'object' || comment === null) return;
            let replyHtml = '';
            
            // â˜… ä¿®æ”¹1ï¼šç‚ºè¢«å›å¾©è€…æ·»åŠ å°ˆå±¬çš„ class å’Œ data å±¬æ€§ï¼Œæ–¹ä¾¿æˆ‘å€‘ç²¾ç¢ºé»æ“Š
            if (comment.replyToNickname) {
                replyHtml = `<span class="weibo-comment-reply-tag">å›å¾©</span><span class="reply-target-name" data-reply-to-name="${comment.replyToNickname}">${comment.replyToNickname}</span>`;
            }

            commentsHtml += `
                <div class="weibo-comment-item" data-comment-id="${comment.commentId}" data-commenter-name="${comment.authorNickname}">
                    <span class="weibo-commenter-name">${comment.authorNickname}</span>
                    ${replyHtml}:
                    <span class="weibo-comment-text">${comment.commentText}</span>
                    <button class="comment-delete-btn" title="åˆªé™¤æ­¤æ¢è©•è«–">Ã—</button>
                </div>`;
        });
        commentsHtml += '</div>';
    }

    const myNickname = state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘';
    const isLiked = post.likes && post.likes.includes(myNickname);
    
    let finalAuthorAvatar, finalAuthorNickname, finalAuthorAvatarFrame;
    if (post.authorId === 'user') {
        finalAuthorAvatar = state.qzoneSettings.weiboAvatar || state.qzoneSettings.avatar || defaultAvatar;
        finalAuthorNickname = state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘';
        finalAuthorAvatarFrame = state.qzoneSettings.weiboAvatarFrame || '';
    } else if (state.chats[post.authorId]) {
        const authorChat = state.chats[post.authorId];
        finalAuthorNickname = authorChat.settings.weiboNickname || authorChat.name;
        finalAuthorAvatar = authorChat.settings.weiboAvatar || authorChat.settings.aiAvatar || defaultAvatar;
        finalAuthorAvatarFrame = authorChat.settings.weiboAvatarFrame || authorChat.settings.aiAvatarFrame || '';
    } else {
        finalAuthorAvatar = defaultAvatar;
        finalAuthorNickname = post.authorNickname || 'æœªçŸ¥ç”¨æˆ¶';
        finalAuthorAvatarFrame = '';
    }

    let avatarHtml = '';
    if (finalAuthorAvatarFrame) {
        avatarHtml = `
            <div class="avatar-with-frame">
                <img src="${finalAuthorAvatar}" class="avatar-img weibo-post-avatar">
                <img src="${finalAuthorAvatarFrame}" class="avatar-frame">
            </div>`;
    } else {
        avatarHtml = `<img src="${finalAuthorAvatar}" class="weibo-post-avatar">`;
    }
    
    const clickableAvatarWrapper = `
        <div class="weibo-post-avatar-clickable" data-char-id="${post.authorId}">
            ${avatarHtml}
        </div>
    `;

    postEl.innerHTML = `
        <div class="weibo-post-header">
            ${clickableAvatarWrapper} 
            <div class="weibo-post-info">
                <span class="weibo-post-nickname">${finalAuthorNickname}</span>
                <span class="weibo-post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
            </div>
            <div class="post-actions-btn" data-post-id="${post.id}" data-author-id="${post.authorId}">â€¦</div>
        </div>
        ${contentHtml}
        <div class="weibo-post-footer">
            <div class="weibo-post-actions">
                <span class="weibo-action-btn like-btn ${isLiked ? 'liked' : ''}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                    <span>${(post.baseLikesCount || 0) + (post.likes || []).length}</span>
                </span>
                <span class="weibo-action-btn comment-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>           
                    <span>${(post.comments || []).length}</span>
                </span>
                <span class="weibo-action-btn generate-comments-btn" title="AIç”Ÿæˆè©•è«–">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                    </svg>
                    <span>ç”Ÿæˆè©•è«–</span>
                </span>
            </div>
            ${commentsHtml}
            <div class="weibo-comment-input-area">
                <input type="text" class="weibo-comment-input" placeholder="ç•™ä¸‹ä½ çš„ç²¾å½©è©•è«–å§...">
                <button class="weibo-comment-send-btn">ç™¼é€</button>
            </div>
        </div>
    `;

    // ç¶å®šç™¼é€è©•è«–æŒ‰éˆ•
    const sendBtn = postEl.querySelector('.weibo-comment-send-btn');
    if (sendBtn) {
        sendBtn.addEventListener('click', () => {
            const input = postEl.querySelector('.weibo-comment-input');
            handleWeiboComment(post.id, input);
        });
    }

    // ç¶å®šAIç”Ÿæˆè©•è«–æŒ‰éˆ•
    const generateBtn = postEl.querySelector('.generate-comments-btn');
    if (generateBtn) {
        generateBtn.addEventListener('click', () => generateWeiboComments(post.id));
    }
    
    // ç¶å®šé»è´ŠæŒ‰éˆ•
    const likeBtn = postEl.querySelector('.like-btn');
    if (likeBtn) {
        likeBtn.addEventListener('click', () => handleWeiboLike(post.id));
    }

    // â˜… ä¿®æ”¹2ï¼šç‚ºè©•è«–å€ç¶å®šä¸€å€‹å…¨æ–°çš„ã€åŠŸèƒ½æ›´å¼·å¤§çš„é»æ“Šäº‹ä»¶ç›£è½å™¨
    const commentSection = postEl.querySelector('.weibo-comments-container');
    if (commentSection) {
        commentSection.addEventListener('click', (e) => {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé€™æ˜¯è§£æ±ºé»æ“Šç„¡æ•ˆçš„æ ¸å¿ƒï¼
            e.stopPropagation();

            const target = e.target;
            const commentItem = target.closest('.weibo-comment-item');
            if (!commentItem) return; // å¦‚æœé»æ“Šçš„ä¸æ˜¯è©•è«–å€ï¼Œå°±ä»€éº¼ä¹Ÿä¸åš
            
            const input = postEl.querySelector('.weibo-comment-input');

            // æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯åˆªé™¤æŒ‰éˆ•
            if (target.closest('.comment-delete-btn')) {
                deleteWeiboComment(post.id, commentItem.dataset.commentId);
                return; // åˆªé™¤å¾ŒçµæŸ
            }
            
            let replyToName = '';
            const replyToId = commentItem.dataset.commentId;

            // â˜… ä¿®æ”¹3ï¼šæ–°å¢é‚è¼¯ï¼Œåˆ¤æ–·ä½ é»æ“Šçš„æ˜¯èª°
            if (target.classList.contains('reply-target-name')) {
                // å¦‚æœé»æ“Šäº†â€œè¢«å›å¾©è€…â€çš„åå­—
                replyToName = target.dataset.replyToName;
            } else {
                // å¦å‰‡ï¼Œé»˜èªå›å¾©é€™æ¢è©•è«–çš„ä½œè€…
                replyToName = commentItem.dataset.commenterName;
            }

            // â˜… ä¿®æ”¹4ï¼šå„ªåŒ–å›å¾©é‚è¼¯
            // å¦‚æœæ­£åœ¨å›å¾©åŒä¸€å€‹äººï¼Œå‰‡å–æ¶ˆå›å¾©
            if (input.dataset.replyToId === replyToId && input.placeholder.includes(`@${replyToName}`)) {
                input.placeholder = 'ç•™ä¸‹ä½ çš„ç²¾å½©è©•è«–å§...';
                delete input.dataset.replyToId;
                delete input.dataset.replyToNickname;
            } else {
                // å¦å‰‡ï¼Œè¨­ç½®ç‚ºæ–°çš„å›å¾©ç›®æ¨™
                input.placeholder = `å›å¾© @${replyToName}:`;
                input.dataset.replyToId = replyToId;
                input.dataset.replyToNickname = replyToName;
                input.focus();
            }
        });
    }

    return postEl;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²





/**
 * ã€å¾®åšã€‘æ‰“é–‹å¾®åšç™¼ä½ˆ/ç·¨è¼¯æ¨¡æ…‹æ¡†
 */
async function openWeiboPublisher() {
    const modal = document.getElementById('create-post-modal');
    
    modal.dataset.mode = 'weibo'; // é—œéµï¼æ¨™è¨˜ç‚ºå¾®åšæ¨¡å¼
    
    document.getElementById('create-post-modal-title').textContent = 'ç™¼å¾®åš';
    document.getElementById('post-public-text').placeholder = 'æœ‰ä»€éº¼æ–°é®®äº‹æƒ³åˆ†äº«çµ¦å¤§å®¶ï¼Ÿ';
    
    // éš±è—å‹•æ…‹å°ˆå±¬çš„æ§åˆ¶é …
    document.getElementById('post-image-desc-group').style.display = 'none';
    document.getElementById('post-comments-toggle-group').style.display = 'none';
    
    document.getElementById('post-mode-switcher').style.display = 'flex'; // å¾®åšä¹Ÿéœ€è¦æ¨¡å¼åˆ‡æ›
    
    resetCreatePostModal();
    modal.classList.add('visible');
}
/**
 * ã€å…¨æ–°ã€‘æ™ºæ…§è§£æå¸¶â€œè¬â€æˆ–â€œå„„â€çš„æ•¸ä½å­—ä¸²
 * @param {string} str - åŒ…å«æ•¸ä½çš„å­—ä¸²ï¼Œä¾‹å¦‚ "30000", "3è¬", "1.5è¬"
 * @returns {number} - è§£æå¾Œçš„ç´”æ•¸å­—
 */
function parseChineseNumber(str) {
    if (!str) return 0; // å®‰å…¨æª¢æŸ¥

    str = String(str).trim().toLowerCase(); // è½‰æ›ç‚ºå°å¯«å­—ä¸²ä¸¦å»é™¤ç©ºæ ¼

    let num = parseFloat(str); // å…ˆå˜—è©¦ç›´æ¥è§£ææ•¸ä½éƒ¨åˆ†

    if (str.includes('è¬') || str.includes('w')) {
        // å¦‚æœåŒ…å«â€œè¬â€æˆ–â€œwâ€ï¼Œå‰‡å°‡æ•¸ä½éƒ¨åˆ†ä¹˜ä»¥10000
        num = parseFloat(str) * 10000;
    } else if (str.includes('å„„')) {
        // å¦‚æœåŒ…å«â€œå„„â€ï¼Œå‰‡ä¹˜ä»¥100000000
        num = parseFloat(str) * 100000000;
    }

    // å¦‚æœè§£æå¤±æ•— (æ¯”å¦‚è¼¸å…¥äº†ç´”æ–‡å­—)ï¼Œè¿”å›0
    return isNaN(num) ? 0 : Math.floor(num); // è¿”å›æ•´æ•¸ï¼Œç¢ºä¿çµæœä¹¾æ·¨
}

// â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡ŠåŠŸèƒ½å¢å¼·ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ handlePublishWeibo å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å¾®åš V3 - ç²‰çµ²æ•¸è¨ˆç®—ç‰ˆã€‘è™•ç†ç™¼ä½ˆå¾®åšçš„æ ¸å¿ƒå‡½æ•¸
 */
async function handlePublishWeibo() {
    const modal = document.getElementById('create-post-modal');
    
// â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹ï¼Œæ˜¯ä½ è¦é»è²¼çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
const mainContent = document.getElementById('post-public-text').value.trim();
let imageUrl = '', hiddenContent = '', postType = 'text_only', imageDescription = '';

const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');

if (isImageModeActive) {
    // ã€æ ¸å¿ƒä¿®å¾©ã€‘æˆ‘å€‘ç¾åœ¨é€šéæª¢æŸ¥é è¦½å®¹å™¨æ˜¯å¦å¯è¦‹ï¼Œä¾†åˆ¤æ–·ç”¨æˆ¶æ˜¯å¦çœŸçš„ä¸Šå‚³äº†åœ–ç‰‡
    const hasImage = document.getElementById('post-image-preview-container').classList.contains('visible');
    
    if (hasImage) {
        imageUrl = document.getElementById('post-image-preview').src;
        postType = 'image';
        imageDescription = document.getElementById('post-image-description').value.trim();
        // åœ–ç‰‡æè¿°çš„æª¢æŸ¥é‚è¼¯ä¿æŒä¸è®Š
        if (!imageDescription) {
            alert("ç‚ºäº†è®“AIèƒ½çœ‹æ‡‚åœ–ç‰‡ï¼Œè«‹å‹™å¿…å¡«å¯«åœ–ç‰‡æè¿°å“¦ï¼");
            return;
        }
    }
    // å¦‚æœ hasImage æ˜¯ false (å³ä½¿ç”¨è€…åªæƒ³ç™¼ç´”æ–‡å­—)ï¼Œé€™æ®µä»£ç¢¼å°±æœƒè¢«è·³éï¼ŒimageUrl ä¿æŒç‚ºç©ºï¼ŒpostType ä¿æŒç‚º text_only
    
} else { // æ–‡å­—åœ–æ¨¡å¼çš„é‚è¼¯ä¿æŒä¸è®Š
    hiddenContent = document.getElementById('post-hidden-text').value.trim();
    if (hiddenContent) {
        imageUrl = 'https://i.postimg.cc/KYr2qRCK/1.jpg'; 
        postType = 'text_image';
    }
}
// â–²â–²â–² åˆ°é€™è£¡ç‚ºæ­¢ï¼Œæ˜¯ä½ è¦é»è²¼çš„æ–°ä»£ç¢¼ â–²â–²â–²

    if (!mainContent && !imageUrl) {
        alert('å¾®åšå…§å®¹ä¸èƒ½ç‚ºç©ºå“¦ï¼');
        return;
    }

    const fansCount = parseChineseNumber(state.qzoneSettings.weiboFansCount) || 0;
    const baseLikes = Math.floor(fansCount * (Math.random() * 0.1 + 0.1));
    const baseComments = Math.floor(baseLikes * (Math.random() * 0.1 + 0.05));

    const newPost = {
        authorId: 'user',
        authorType: 'user',
        authorNickname: state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘',
        authorAvatar: state.qzoneSettings.weiboAvatar || state.qzoneSettings.avatar || defaultAvatar,
        content: mainContent,
        imageUrl: imageUrl,
        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
        authorAvatarFrame: state.qzoneSettings.weiboAvatarFrame || '',
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ é€™æ˜¯æ–°å¢çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼
        imageDescription: imageDescription, // 3. æŠŠç²å–åˆ°çš„æè¿°ä¿å­˜åˆ°æ–°æ¬„ä½è£¡ï¼
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

        hiddenContent: hiddenContent,
        postType: postType,
        timestamp: Date.now(),
        likes: [],
        comments: [],
        baseLikesCount: baseLikes,
        baseCommentsCount: baseComments
    };

    await db.weiboPosts.add(newPost);
    await renderMyWeiboFeed(); 
    await renderWeiboProfile();
    
    modal.classList.remove('visible');
    alert('å¾®åšç™¼ä½ˆæˆåŠŸï¼');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * ã€å¾®åšã€‘è™•ç†é»è´Š/å–æ¶ˆé»è´Š
 * @param {number} postId - å¸–å­ID
 */
async function handleWeiboLike(postId) {
    const post = await db.weiboPosts.get(postId);
    if (!post) return;

    const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
    if (!post.likes) post.likes = [];
    
    const likeIndex = post.likes.indexOf(myNickname);
    if (likeIndex > -1) {
        post.likes.splice(likeIndex, 1); // å–æ¶ˆé»è´Š
    } else {
        post.likes.push(myNickname); // é»è´Š
    }

    await db.weiboPosts.put(post);
    // é‡æ–°æ¸²æŸ“å…©å€‹Feedï¼Œç¢ºä¿è³‡æ–™åŒæ­¥
    await renderMyWeiboFeed();
    await renderFollowingWeiboFeed();
}

/**
 * ã€å¾®åšã€‘è™•ç†ç™¼ä½ˆè©•è«–æˆ–å›å¾©
 * @param {number} postId - å¸–å­ID
 * @param {HTMLInputElement} inputElement - è©•è«–è¼¸å…¥æ¡†å…ƒç´ 
 */
async function handleWeiboComment(postId, inputElement) {
    const commentText = inputElement.value.trim();
    if (!commentText) {
        alert("è©•è«–å…§å®¹ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }

    const post = await db.weiboPosts.get(postId);
    if (!post) return;

    if (!post.comments) post.comments = [];

    const newComment = {
        commentId: 'comment_' + Date.now(),
        authorId: 'user',
        authorNickname: state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘',
        commentText: commentText,
        timestamp: Date.now()
    };
    
    // æª¢æŸ¥æ˜¯å¦æ˜¯å›å¾©
    if (inputElement.dataset.replyToId) {
        newComment.replyToId = inputElement.dataset.replyToId;
        newComment.replyToNickname = inputElement.dataset.replyToNickname;
    }

    post.comments.push(newComment);
    await db.weiboPosts.put(post);
    
    // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦é‡ç½®ç‹€æ…‹
    inputElement.value = '';
    inputElement.placeholder = 'ç•™ä¸‹ä½ çš„ç²¾å½©è©•è«–å§...';
    delete inputElement.dataset.replyToId;
    delete inputElement.dataset.replyToNickname;
    
    // é‡æ–°æ¸²æŸ“å…©å€‹Feed
    await renderMyWeiboFeed();
    await renderFollowingWeiboFeed();
}


// â–²â–²â–² å…¨æ–°çš„å¾®åšåŠŸèƒ½ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ‚¨çš„ API ç¶²ç«™é»‘åå–® â–¼â–¼â–¼
const BLOCKED_API_SITES = [
    'api.pisces.ink',
    'aiapi.qzz.io'
];
// â–²â–²â–² é»‘åå–®å®šç¾©çµæŸ â–²â–²â–²
        // --- å·²ä¿®æ­£ ---
        let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null };
        // --- ä¿®æ­£çµæŸ ---
let currentViewingDmsFor = null; // ç”¨æ–¼è¿½è¹¤æ­£åœ¨æŸ¥çœ‹å“ªå€‹è§’è‰²çš„ç§ä¿¡
        let isLocked = false; // <-- åœ¨é€™è£¡æ·»åŠ é€™è¡Œæ–°ä»£ç¢¼
        let newLockscreenWallpaperBase64 = null; // <-- åœ¨é€™è£¡æ·»åŠ é€™è¡Œæ–°ä»£ç¢¼
let newGlobalBgBase64 = null; // ç”¨æ–¼æš«å­˜æ–°çš„å…¨åŸŸèŠå¤©èƒŒæ™¯
let newAppWallpaperBase64 = null;
let musicState = { 
    isActive: false, 
    activeChatId: null, 
    isPlaying: false, 
    playlist: [], 
    currentIndex: -1, 
    playMode: 'order', 
    totalElapsedTime: 0, 
    timerId: null,
    // ã€æ–°å¢ã€‘æ­Œè©ç›¸é—œç‹€æ…‹
    parsedLyrics: [],      // ç•¶å‰æ­Œæ›²è§£æå¾Œçš„æ­Œè©é™£åˆ—
    currentLyricIndex: -1  // ç•¶å‰é«˜äº®çš„æ­Œè©è¡Œç´¢å¼•
};
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æƒ…ä¾¶ç©ºé–“å°ˆå±¬éŸ³æ¨‚æ’­æ”¾æ©Ÿçš„ç‹€æ…‹ç®¡ç†å™¨ â–¼â–¼â–¼
let lsMusicState = {
    playlist: [],      // æ’­æ”¾æ¸…å–®
    currentIndex: -1,  // ç•¶å‰æ’­æ”¾æ­Œæ›²çš„ç´¢å¼•
    isPlaying: false   // æ˜¯å¦æ­£åœ¨æ’­æ”¾
};
// â–²â–²â–² æ–°å¢ç‹€æ…‹ç®¡ç†å™¨çµæŸ â–²â–²â–²
let lyricsBarSettings = {
    fontSize: 14,
    bgOpacity: 0,
    fontColor: '#FFFFFF',
    showOnClose: true // ã€å•é¡Œ4éœ€è¦ã€‘é è¨­é–‹å•Ÿ
};

        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let isInnerVoiceHistoryOpen = false; // ç”¨æ–¼è·Ÿè¹¤æ­·å²é¢æ¿æ˜¯å¦æ‰“é–‹
        let pomodoroState = {
    isActive: false,            // å°ˆæ³¨æ˜¯å¦æ­£åœ¨é€²è¡Œ
    timerId: null,              // å€’è¨ˆæ™‚è¨ˆæ™‚å™¨
    periodicTalkTimerId: null,  // è§’è‰²å®šæ™‚èªªè©±çš„è¨ˆæ™‚å™¨
    currentSession: null        // ç•¶å‰å°ˆæ³¨æœƒè©±çš„è³‡æ–™
};
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;
let activeCharPhonePresetId = null; // ç”¨æ–¼è¿½è¹¤è§’è‰²æ‰‹æ©Ÿå¤–è§€é è¨­çš„é¸æ“‡
let activeCharacterPhoneId = null;
let activeLoversSpaceCharId = null; // ç”¨æ–¼è¿½è¹¤ç•¶å‰æƒ…ä¾¶ç©ºé–“çš„è§’è‰²ID
let waimaiTimers = {}; // ç”¨æ–¼å­˜å„²å¤–è³£å€’è¨ˆæ™‚

let activeMessageTimestamp = null;
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‹¼äººæ®ºéŠæˆ²çš„ç‹€æ…‹ç®¡ç†å™¨ â–¼â–¼â–¼
let werewolfGameState = {
    isActive: false,      // éŠæˆ²æ˜¯å¦æ­£åœ¨é€²è¡Œ
    players: [],          // ç©å®¶åˆ—è¡¨ { id, name, avatar, role, isAlive, persona }
    roles: {},            // è§’è‰²é…ç½® { wolf: 2, villager: 2, ... }
    gamePhase: 'setup',   // éŠæˆ²éšæ®µ: setup, night, day_discussion, day_vote, etc.
    dayNumber: 0,         // å¤©æ•¸
    gameLog: [],          // éŠæˆ²æ—¥èªŒ
    turnIndex: 0,         // ç•¶å‰ç™¼è¨€/è¡Œå‹•çš„ç©å®¶ç´¢å¼•
    votes: {},            // æŠ•ç¥¨è¨˜éŒ„
    seerLastNightResult: null, // é è¨€å®¶æ˜¨æ™šæŸ¥é©—çµæœ
    witchPotions: { save: 1, poison: 1 }, // å¥³å·«è—¥åŠ‘
    hunterTarget: null,   // çµäººç›®æ¨™
    lastNightKilled: [],  // æ˜¨æ™šè¢«æ®ºçš„ç©å®¶ID
    waitingFor: null,     // ç•¶å‰ç­‰å¾…èª°çš„è¡Œå‹•: 'seer', 'witch_save', 'witch_poison', 'hunter', 'user_vote'
    gameConfig: {}        // éŠæˆ²é…ç½®
};
// â–²â–²â–² æ–°å¢è®Šæ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æµ·é¾œæ¹¯éŠæˆ²çš„ç‹€æ…‹ç®¡ç†å™¨ â–¼â–¼â–¼
let seaTurtleSoupState = {
    isActive: false,      // éŠæˆ²æ˜¯å¦æ­£åœ¨é€²è¡Œ
    phase: 'setup',       // éŠæˆ²éšæ®µ: setup, guessing, reveal
    players: [],          // ç©å®¶åˆ—è¡¨ { id, name, avatar, persona, isUser, isProvider }
    riddleProvider: null, // å‡ºé¡Œäººå°è±¡
    riddle: '',           // è¬é¢
    answer: '',           // è¬åº•
    gameLog: [],          // éŠæˆ²æ—¥èªŒ
    currentTurnIndex: 0   // ç•¶å‰è¼ªåˆ°èª°è¡Œå‹•çš„ç´¢å¼•
};
// â–²â–²â–² æ–°å¢è®Šæ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯åŠ‡æœ¬æ®ºéŠæˆ²çš„ç‹€æ…‹ç®¡ç†å™¨ â–¼â–¼â–¼
let scriptKillGameState = {
    isActive: false,      // éŠæˆ²æ˜¯å¦æ­£åœ¨é€²è¡Œ
    script: null,         // ç•¶å‰è¼‰å…¥çš„åŠ‡æœ¬ç‰©ä»¶
    players: [],          // ç©å®¶åˆ—è¡¨ { id, name, avatar, role, isUser, evidence, persona }
    gamePhase: 'setup',   // éŠæˆ²éšæ®µ: setup, introduction, evidence, discussion, voting, end
    turnIndex: 0,         // ç•¶å‰è¡Œå‹•çš„ç©å®¶ç´¢å¼•
    gameLog: [],          // éŠæˆ²æ—¥èªŒ
    evidenceCounts: {},   // è¨˜éŒ„æ¯å€‹ç©å®¶å·²æœè­‰æ¬¡æ•¸
    votes: {},            // æŠ•ç¥¨è¨˜éŒ„
    isè‡ªç”±é¸æ“‡: false      // æ˜¯å¦ç‚ºè‡ªç”±é¸æ“‡è§’è‰²æ¨¡å¼
};
// â–²â–²â–² æ–°å¢è®Šæ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
let guessWhatGameState = {
    isActive: false,      // éŠæˆ²æ˜¯å¦æ­£åœ¨é€²è¡Œ
    mode: 'ai_guesses',   // éŠæˆ²æ¨¡å¼: 'ai_guesses' æˆ– 'user_guesses'
    opponent: null,       // å°æ‰‹ç©å®¶å°è±¡ { id, name, avatar, persona }
    secretWord: '',       // è¬åº•è©èª
    gameLog: [],          // éŠæˆ²æ—¥èªŒ
    currentTurn: 'user'   // ç•¶å‰è¼ªåˆ°èª°: 'user' æˆ– 'ai'
};
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

let ludoGameState = {
    isActive: false,
    opponent: null,
    players: [], // { id, name, avatar, piecePosition: -1 (at home), isUser }
    currentTurnIndex: 0,
    gameLog: [],
    boardLayout: [],
    isDiceRolling: false
};

const LUDO_BOARD_SIZE = 42; // ç¸½æ ¼å­æ•¸ï¼Œå¯ä»¥æ ¹æ“šä½ çš„æ£‹ç›¤ä½ˆå±€èª¿æ•´

let tempGeneratedScriptData = null;
let currentReplyContext = null; // <--- æ–°å¢é€™è¡Œï¼Œç”¨ä¾†å­˜å„²ç•¶å‰æ­£åœ¨å¼•ç”¨çš„æ¶ˆæ¯è³‡è¨Š
let currentSearchKeyword = ''; // ç”¨æ–¼åœ¨æœç´¢çµæœä¸­é«˜äº®é—œéµå­—
let activePostId = null; // <-- æ–°å¢ï¼šç”¨æ–¼å­˜å„²ç•¶å‰æ“ä½œçš„å‹•æ…‹ID
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGM æœç´¢åŠŸèƒ½æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼

// ä¸€å€‹ç°¡å–®çš„ç¶²è·¯è«‹æ±‚å‡½æ•¸
if (typeof Http_Get_External === 'undefined') {
    window.Http_Get_External = function(url) {
        return new Promise((resolve) => {
            fetch(url).then(res => res.json().catch(() => res.text())).then(resolve).catch(() => resolve(null));
        });
    }
}
async function Http_Get(url) { return await Http_Get_External(url); }

// æª¢æŸ¥éŸ³è¨Šé€£çµæ˜¯å¦çœŸçš„å¯ä»¥æ’­æ”¾
function checkAudioAvailability(url) {
    return new Promise(resolve => {
        const tester = new Audio();
        tester.addEventListener('loadedmetadata', () => resolve(true), { once: true });
        tester.addEventListener('error', () => resolve(false), { once: true });
        tester.src = url;
    });
}

// â–¼â–¼â–¼ ã€V9.0 | çµ‚æ¥µç´”æ·¨ç‰ˆ - ç§»é™¤ä»£ç†ã€‘è«‹ç”¨é€™å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ searchNeteaseMusic å‡½æ•¸ â–¼â–¼â–¼
/**
 * ç§»é™¤æ‰€æœ‰ä»£ç†ï¼Œç›´æ¥è«‹æ±‚ä½ æ‰¾åˆ°çš„ vkeys.cn API
 */
async function searchNeteaseMusic(name, singer) {
    try {
        let searchTerm = name.replace(/\s/g, "");
        if (singer) { searchTerm += ` ${singer.replace(/\s/g, "")}`; }

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘ä¸å†éœ€è¦ä»»ä½•ä»£ç†ï¼Œç›´æ¥æŠŠç›®æ¨™APIä½œç‚ºæœ€çµ‚è«‹æ±‚ä½å€ï¼
        const apiUrl = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`;
        
        console.log("æ­£åœ¨å˜—è©¦ç›´æ¥è«‹æ±‚:", apiUrl); // æ·»åŠ ä¸€æ¢æ—¥èªŒï¼Œæ–¹ä¾¿æˆ‘å€‘èª¿è©¦
        
        const response = await fetch(apiUrl);

        if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();

        if (result.code !== 200 || !result.data || result.data.length === 0) {
            console.log("vkeys APIè¿”å›ç„¡çµæœ:", result);
            return [];
        }
        
        return result.data.map(song => ({
            name: song.song,
            artist: song.singer,
            id: song.id,
            cover: song.cover || 'https://i.postimg.cc/pT2xKzP-album-cover-placeholder.png',
            source: 'netease'
        })).slice(0, 15);

    } catch (e) {
        // å¦‚æœé€™æ¬¡é‚„å¤±æ•—ï¼Œè«‹æŠŠæµè¦½å™¨F12æ§åˆ¶å°è£¡çš„ç´…è‰²éŒ¯èª¤è³‡è¨Šå®Œæ•´åœ°æˆªåœ–çµ¦æˆ‘
        console.error("ã€vkeys API ç›´é€£ã€‘æœç´¢å¤±æ•—:", e);
        await showCustomAlert("ç¶²æ˜“é›²ä»‹é¢ç›´é€£å¤±æ•—", `å¦‚æœæµè¦½å™¨æ§åˆ¶å°(F12)æç¤ºCORSéŒ¯èª¤ï¼Œèªªæ˜æ­¤APIç¦æ­¢ç›´æ¥è¨ªå•ã€‚éŒ¯èª¤: ${e.message}`);
        return [];
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * å¾QQéŸ³æ¨‚æœç´¢æ­Œæ›²æ¸…å–®
 */
async function searchTencentMusic(name) {
    try {
        name = name.replace(/\s/g, "");
        const result = await Http_Get(`https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(name)}`);
        if (!result?.data?.length) return [];
        return result.data.map(song => ({
            name: song.song,
            artist: song.singer,
            id: song.id,
            cover: song.cover || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png',
            source: 'tencent' // æ¨™è¨˜ä¾†æº
        })).slice(0, 5); // åªå–å‰5æ¢çµæœ
    } catch (e) {
        console.error("QQéŸ³æ¨‚æœç´¢APIå¤±æ•—:", e);
        return [];
    }
}
// â–¼â–¼â–¼ ã€V2.0 | æ”¯æŒæºé¸æ“‡ã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ addSongFromSearch â–¼â–¼â–¼
/**
 * ã€ç¸½å…¥å£ V2.0ã€‘ç•¶ç”¨æˆ¶é»æ“Šâ€œæœç´¢â€æŒ‰éˆ•æ™‚è§¸ç™¼
 */
async function addSongFromSearch() {
    // æ­¥é©Ÿ 1: é¦–å…ˆå½ˆå‡ºé¸æ“‡æ¡†ï¼Œè®“ç”¨æˆ¶é¸æ“‡æœç´¢æº
    const source = await showSearchSourceSelector();
    // å¦‚æœç”¨æˆ¶é»äº†å–æ¶ˆï¼Œsourceæœƒæ˜¯nullï¼Œæˆ‘å€‘ç›´æ¥é€€å‡ºå‡½æ•¸
    if (!source) return;

    // æ­¥é©Ÿ 2: å½ˆå‡ºè¼¸å…¥æ¡†è®“ä½¿ç”¨è€…è¼¸å…¥é—œéµå­— (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
    const searchTerm = await showCustomPrompt("æœç´¢æ­Œæ›²", "è«‹è¼¸å…¥ æ­Œå æˆ– æ­Œå-æ­Œæ‰‹");
    if (!searchTerm || !searchTerm.trim()) return;

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨æœç´¢æ­Œæ›²è³‡æº...");

    let musicName = searchTerm.trim();
    let singerName = "";
    if (searchTerm.includes('-') || searchTerm.includes('â€“')) {
        const parts = searchTerm.split(/[-â€“]/);
        musicName = parts[0].trim();
        singerName = parts.slice(1).join(' ').trim();
    }

    // æ­¥é©Ÿ 3: ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡ï¼ŒåŸ·è¡Œä¸åŒçš„æœç´¢
    let combinedResults = [];

    if (source === 'all') {
        // å¦‚æœé¸æ“‡â€œå…¨éƒ¨â€ï¼Œå‰‡ä¸¦è¡Œæœç´¢å…©å€‹å¹³è‡º
        const [neteaseResults, tencentResults] = await Promise.all([
            searchNeteaseMusic(musicName, singerName),
            searchTencentMusic(musicName)
        ]);
        combinedResults = [...neteaseResults, ...tencentResults];
    } else if (source === 'netease') {
        // å¦‚æœåªé¸â€œç¶²æ˜“é›²â€ï¼Œå°±åªèª¿ç”¨ç¶²æ˜“é›²çš„æœç´¢
        combinedResults = await searchNeteaseMusic(musicName, singerName);
    } else if (source === 'tencent') {
        // å¦‚æœåªé¸â€œQQéŸ³æ¨‚â€ï¼Œå°±åªèª¿ç”¨QQéŸ³æ¨‚çš„æœç´¢
        combinedResults = await searchTencentMusic(musicName);
    }

    // æ­¥é©Ÿ 4: å¾ŒçºŒçš„é¡¯ç¤ºé‚è¼¯ä¿æŒä¸è®Š
    if (combinedResults.length === 0) {
        await showCustomAlert("ç„¡çµæœ", "æŠ±æ­‰ï¼Œåœ¨æ‰€é¸ä¾†æºä¸­æœªèƒ½æ‰¾åˆ°ç›¸é—œæ­Œæ›²ã€‚");
        return;
    }

    const modal = document.getElementById('music-search-results-modal');
    const listEl = document.getElementById('search-results-list');
    listEl.innerHTML = '';

    combinedResults.forEach(song => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.dataset.songJson = JSON.stringify(song);
        item.innerHTML = `
            <div class="title">${song.name}</div>
            <div class="artist">${song.artist} <span class="source">${song.source === 'netease' ? 'ç¶²æ˜“é›²' : 'QQéŸ³æ¨‚'}</span></div>
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€æ ¸å¿ƒå‡ç´šã€‘è™•ç†ç”¨æˆ¶é»æ“Šæœç´¢çµæœï¼Œå¢åŠ å‚™ç”¨éŸ³æºæŸ¥æ‰¾å’Œæ˜¯å¦æ°¸ä¹…ä¿å­˜çš„é‚è¼¯
 */
async function handleSearchResultClick(songData) {
    const modal = document.getElementById('music-search-results-modal');
    modal.classList.remove('visible');

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨ç²å–ã€Š${songData.name}ã€‹çš„æ’­æ”¾é€£çµ...`);

    let playableResult = null;
    let finalSource = songData.source;

    // 1. å˜—è©¦ä¸»éŸ³æº
    const primaryApiUrl = songData.source === 'netease' 
        ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
        : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
    let primaryResult = await Http_Get(primaryApiUrl);
    if (primaryResult?.data?.url && await checkAudioAvailability(primaryResult.data.url)) {
        playableResult = { url: primaryResult.data.url, id: songData.id, source: songData.source };
    }

    // 2. å¦‚æœä¸»éŸ³æºå¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨éŸ³æº
    if (!playableResult) {
        await showCustomAlert("è«‹ç¨å€™...", "ä¸»éŸ³æºç²å–å¤±æ•—ï¼Œæ­£åœ¨å˜—è©¦å‚™ç”¨éŸ³æº...");
        const fallbackSource = songData.source === 'netease' ? 'tencent' : 'netease';
        const fallbackResults = fallbackSource === 'tencent' 
            ? await searchTencentMusic(songData.name)
            : await searchNeteaseMusic(songData.name, songData.artist);

        if (fallbackResults.length > 0) {
            const fallbackApiUrl = fallbackSource === 'netease'
                ? `https://api.vkeys.cn/v2/music/netease?id=${fallbackResults[0].id}`
                : `https://api.vkeys.cn/v2/music/tencent?id=${fallbackResults[0].id}`;
            const fallbackResult = await Http_Get(fallbackApiUrl);
            if (fallbackResult?.data?.url && await checkAudioAvailability(fallbackResult.data.url)) {
                playableResult = { url: fallbackResult.data.url, id: fallbackResults[0].id, source: fallbackSource };
                finalSource = fallbackSource;
            }
        }
    }

    if (!playableResult) {
        await showCustomAlert("ç²å–å¤±æ•—", "ç„¡æ³•ç²å–è©²æ­Œæ›²çš„æœ‰æ•ˆæ’­æ”¾é€£çµï¼Œä¸»éŸ³æºå’Œå‚™ç”¨éŸ³æºå‡å·²å˜—è©¦ã€‚");
        return;
    }
    
// â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
const confirmed = await showCustomConfirm(
    'æº«é¦¨æç¤º', // é€™æ˜¯å½ˆçª—çš„æ¨™é¡Œ
    'æœç´¢çš„æ­Œæ›²24hå¾ŒæœƒéæœŸï¼Œé‡è¦çš„æ­Œæ›²è¨˜å¾—ç”¨urlæˆ–è€…æœ¬åœ°ä¸Šå‚³å“¦ğŸ‡', // é€™æ˜¯ä½ æŒ‡å®šçš„æç¤ºå…§å®¹
    { confirmText: 'ç¢ºå®š' } // æŒ‰éˆ•æœƒé¡¯ç¤ºâ€œç¢ºå®šâ€å’Œâ€œå–æ¶ˆâ€ï¼Œé€™è£¡çš„â€œå–æ¶ˆâ€å°±ç­‰åŒæ–¼â€œè¿”å›â€
);

// å¦‚æœç”¨æˆ¶é»æ“Šäº†â€œå–æ¶ˆâ€ï¼ˆè¿”å›ï¼‰ï¼Œå°±ç›´æ¥çµæŸï¼Œä¸æ·»åŠ æ­Œæ›²
if (!confirmed) {
    return;
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²   
    // ç²å–æ­Œè©
    const lrcContent = await getLyricsForSong(playableResult.id, finalSource) || "";

// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ› â–¼â–¼â–¼
const newSong = {
    name: songData.name,
    artist: songData.artist,
    src: playableResult.url,
    cover: songData.cover,
    isLocal: false,
    lrcContent: lrcContent,
    isTemporary: true,
    // æ ¸å¿ƒæ–°å¢ï¼šè¨˜éŒ„é€™é¦–æ­Œè¢«æ·»åŠ çš„ç²¾ç¢ºæ™‚é–“
    addedTimestamp: Date.now() 
};
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



musicState.playlist.push(newSong);

// æ³¨æ„ï¼šæˆ‘å€‘å·²ç¶“åˆªé™¤äº† saveGlobalPlaylist() çš„èª¿ç”¨ï¼Œå› ç‚ºè‡¨æ™‚æ­Œæ›²ä¸éœ€è¦è¢«æ°¸ä¹…ä¿å­˜
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

    
    updatePlaylistUI();

    if (musicState.currentIndex === -1) {
        musicState.currentIndex = musicState.playlist.length - 1;
        updatePlayerUI();
    }

    await showCustomAlert("æ·»åŠ æˆåŠŸ", `ã€Š${songData.name}ã€‹å·²æˆåŠŸæ·»åŠ åˆ°æ’­æ”¾æ¸…å–®ï¼`);
    // â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ°æŒ‡å®šä½ç½® â–¼â–¼â–¼
try {
    // 1. æª¢æŸ¥ä¸€ä¸‹ç•¶å‰æ˜¯ä¸æ˜¯æ­£åœ¨å’Œåˆ¥äººèŠå¤©
    if (state.activeChatId) {
        const chat = state.chats[state.activeChatId];
        if (chat) {
            // 2. å‰µå»ºä¸€æ¢å°ç”¨æˆ¶éš±è—ï¼Œä½†å°AIå¯è¦‹çš„ç³»çµ±æ¶ˆæ¯
            const hiddenMessage = {
                role: 'system', // å‘Šè¨´AIé€™æ˜¯ç³»çµ±è³‡è¨Š
                content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶å‰›å‰›é€šéæœç´¢ï¼Œå°‡æ­Œæ›²ã€Š${songData.name}ã€‹ - ${songData.artist} æ·»åŠ åˆ°äº†â€œä¸€èµ·è½â€çš„æ’­æ”¾æ¸…å–®ä¸­ã€‚ä½ å¯ä»¥æ ¹æ“šé€™å€‹æƒ…æ™¯ï¼Œè‡ªç„¶åœ°é–‹å•Ÿé—œæ–¼é€™é¦–æ­Œçš„è©±é¡Œã€‚]`,
                timestamp: Date.now(),
                isHidden: true // é€™å€‹æ˜¯é—œéµï¼è®“é€™æ¢æ¶ˆæ¯åœ¨èŠå¤©ä»‹é¢ä¸Šâ€œéš±å½¢â€
            };
            
            // 3. æŠŠé€™æ¢â€œéš±å½¢â€æ¶ˆæ¯åŠ åˆ°èŠå¤©è¨˜éŒ„çš„æœ«å°¾
            chat.history.push(hiddenMessage);
            
            // 4. ä¿å­˜æ›´æ–°å¾Œçš„èŠå¤©è¨˜éŒ„åˆ°è³‡æ–™åº«
            await db.chats.put(chat);

            console.log(`å·²ç‚ºæ­Œæ›²ã€Š${songData.name}ã€‹æˆåŠŸæ³¨å…¥AIä¸Šä¸‹æ–‡æç¤ºã€‚`);
        }
    }
} catch (error) {
    console.error("æ³¨å…¥æ­Œæ›²ä¸Šä¸‹æ–‡æ™‚å‡ºéŒ¯:", error);
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
}

/**
 * ã€è¼”åŠ©ã€‘ç²å–ç¶²è·¯æ­Œæ›²çš„æ­Œè©
 */
async function getLyricsForSong(songId, source) {
    const url = source === 'netease'
        ? `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}`
        : `https://api.vkeys.cn/v2/music/tencent/lyric?id=${songId}`;
    
    const response = await Http_Get(url);
    if (response?.data) {
        const lrc = response.data.lrc || response.data.lyric || "";
        const tlyric = response.data.trans || response.data.tlyric || "";
        return lrc + "\\n" + tlyric;
    }
    return "";
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™å€‹å‡½æ•¸ç”¨ä¾†é¡¯ç¤ºâ€œé¸æ“‡æœç´¢æºâ€çš„å½ˆçª— â–¼â–¼â–¼
/**
 * é¡¯ç¤ºæœç´¢æºé¸æ“‡å½ˆçª—ï¼Œä¸¦è¿”å›ç”¨æˆ¶çš„é¸æ“‡
 * @returns {Promise<string|null>} è¿”å› 'all', 'netease', 'tencent', æˆ– null
 */
function showSearchSourceSelector() {
    return new Promise(resolve => {
        const modal = document.getElementById('music-source-selector-modal');
        const confirmBtn = document.getElementById('confirm-source-select-btn');
        const cancelBtn = document.getElementById('cancel-source-select-btn');

        // é¡¯ç¤ºå½ˆçª—
        modal.classList.add('visible');

        // å®šç¾©ç¢ºèªæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
        const onConfirm = () => {
            const selectedSource = document.querySelector('input[name="search-source"]:checked').value;
            cleanup();
            resolve(selectedSource); // è¿”å›ç”¨æˆ¶çš„é¸æ“‡
        };

        // å®šç¾©å–æ¶ˆæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
        const onCancel = () => {
            cleanup();
            resolve(null); // ç”¨æˆ¶å–æ¶ˆï¼Œè¿”å› null
        };

        // æ¸…ç†å‡½æ•¸ï¼Œç”¨æ–¼ç§»é™¤äº‹ä»¶ç›£è½ä¸¦éš±è—å½ˆçª—
        const cleanup = () => {
            modal.classList.remove('visible');
            confirmBtn.removeEventListener('click', onConfirm);
            cancelBtn.removeEventListener('click', onCancel);
        };

        // ç¶å®šäº‹ä»¶
        confirmBtn.addEventListener('click', onConfirm);
        cancelBtn.addEventListener('click', onCancel);
    });
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ° getLyricsForSong å‡½æ•¸çš„å¾Œé¢ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ ¹æ“šæ­Œåå’Œæ­Œæ‰‹è‡ªå‹•æœç´¢ä¸¦æ’­æ”¾æ­Œæ›²
 * @param {string} name - æ­Œæ›²å
 * @param {string} artist - æ­Œæ‰‹å
 */
async function searchAndPlaySong(name, artist) {
    // å½ˆå‡ºæç¤ºï¼Œå‘Šè¨´ç”¨æˆ¶æˆ‘å€‘æ­£åœ¨åšä»€éº¼
    await showCustomAlert("è«‹ç¨å€™...", `AIç‚ºä½ åˆ†äº«äº†ã€Š${name}ã€‹ï¼Œæ­£åœ¨åŠªåŠ›å°‹æ‰¾æ’­æ”¾è³‡æº...`);

    let songData = null;

    // ç­–ç•¥1ï¼šå„ªå…ˆç”¨ç¶²æ˜“é›²æœç´¢ (é€šå¸¸çµæœæ›´å‡†)
    const neteaseResults = await searchNeteaseMusic(name, artist);
    if (neteaseResults.length > 0) {
        songData = neteaseResults[0]; // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ç”¨ç¬¬ä¸€å€‹çµæœ
    } 
    // ç­–ç•¥2ï¼šå¦‚æœç¶²æ˜“é›²æ‰¾ä¸åˆ°ï¼Œå†ç”¨QQéŸ³æ¨‚æœä¸€æ¬¡
    else {
        const tencentResults = await searchTencentMusic(name);
        if (tencentResults.length > 0) {
            songData = tencentResults[0]; // ç”¨QQéŸ³æ¨‚çš„ç¬¬ä¸€å€‹çµæœ
        }
    }

    // å¦‚æœå…©å€‹å¹³è‡ºéƒ½æ²’æ‰¾åˆ°ï¼Œå°±å‘Šè¨´ç”¨æˆ¶ä¸¦é€€å‡º
    if (!songData) {
        await showCustomAlert("æ‰¾ä¸åˆ°æ­Œæ›²", `æŠ±æ­‰ï¼Œåœ¨ç¶²æ˜“é›²å’ŒQQéŸ³æ¨‚éƒ½æ²’èƒ½æ‰¾åˆ°ã€Š${name}ã€‹çš„å¯æ’­æ”¾è³‡æºã€‚`);
        return;
    }

    // åˆ°é€™è£¡ï¼Œæˆ‘å€‘å·²ç¶“æœ‰äº†ä¸€é¦–æ­Œçš„åŸºæœ¬è³‡è¨Š (id, source, name, artist)
    // ä¸‹é¢çš„é‚è¼¯å°±æ˜¯èª¿ç”¨APIç²å–çœŸå¯¦çš„æ’­æ”¾é€£çµ
    
    const apiUrl = songData.source === 'netease' 
        ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
        : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
    
    const result = await Http_Get(apiUrl);

    // æª¢æŸ¥ç²å–åˆ°çš„é€£çµæ˜¯å¦çœŸçš„èƒ½æ’­æ”¾
    if (!result?.data?.url || !(await checkAudioAvailability(result.data.url))) {
        await showCustomAlert("ç²å–å¤±æ•—", `æ‰¾åˆ°äº†ã€Š${name}ã€‹ï¼Œä½†ç„¡æ³•ç²å–æœ‰æ•ˆçš„æ’­æ”¾é€£çµã€‚`);
        return;
    }

    // ç²å–æ­Œè©
    const lrcContent = await getLyricsForSong(songData.id, songData.source) || "";

    // æº–å‚™æ–°çš„æ­Œæ›²ç‰©ä»¶ï¼Œæº–å‚™æ·»åŠ åˆ°æ’­æ”¾æ¸…å–®
    const newSong = {
        name: songData.name,
        artist: songData.artist,
        src: result.data.url, // ä½¿ç”¨æˆ‘å€‘å‰›å‰›ç²å–åˆ°çš„çœŸå¯¦ã€å¯æ’­æ”¾çš„URLï¼
        cover: songData.cover,
        isLocal: false,
        lrcContent: lrcContent,
        isTemporary: true, // æ¨™è¨˜ç‚ºè‡¨æ™‚æ­Œæ›²ï¼Œ24å°æ™‚å¾Œå¯èƒ½æœƒå¤±æ•ˆ
        addedTimestamp: Date.now()
    };

    // æª¢æŸ¥æ’­æ”¾æ¸…å–®è£¡æ˜¯ä¸æ˜¯å·²ç¶“æœ‰é€™é¦–æ­Œäº†
    const existingIndex = musicState.playlist.findIndex(t => t.name === newSong.name && t.artist === newSong.artist);
    if (existingIndex !== -1) {
        // å¦‚æœæœ‰ï¼Œç›´æ¥æ’­æ”¾å®ƒ
        playSong(existingIndex);
    } else {
        // å¦‚æœæ²’æœ‰ï¼Œå°±æ·»åŠ åˆ°åˆ—è¡¨æœ«å°¾å†æ’­æ”¾
        musicState.playlist.push(newSong);
        updatePlaylistUI(); // åˆ·æ–°æ’­æ”¾æ¸…å–®ä»‹é¢
        playSong(musicState.playlist.length - 1);
    }
    
    // å¦‚æœâ€œä¸€èµ·è½â€åŠŸèƒ½æ˜¯é—œé–‰çš„ï¼Œå°±è‡ªå‹•æ‰“é–‹å®ƒ
    if (!musicState.isActive) {
         startListenTogetherSession(state.activeChatId);
    } else {
        // å¦‚æœå·²ç¶“æ˜¯æ‰“é–‹çš„ï¼Œå°±ç›´æ¥é¡¯ç¤ºæ’­æ”¾æ©Ÿè¦–çª—
        document.getElementById('music-player-overlay').classList.add('visible');
    }
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–²â–²â–² æ–°å¢å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
let activeForumFilters = { 
    global: [], // ç”¨æ–¼ä¸»é å°çµ„åˆ—è¡¨çš„ç¯©é¸
    group: {}   // ç”¨æ–¼å­˜å„²æ¯å€‹å°çµ„å…§éƒ¨å¸–å­çš„ç¯©é¸, e.g., { 1: ['ç§‘å¹»'], 2: ['åŠ‡æƒ…'] }
};
let currentFilterContext = { type: 'global', id: null }; // è¨˜éŒ„ç•¶å‰æ‰“é–‹ç¯©é¸çš„æ˜¯å“ªå€‹é é¢

        let photoViewerState = {
            isOpen: false,
            photos: [], // å­˜å„²ç•¶å‰ç›¸å†Šçš„æ‰€æœ‰ç…§ç‰‡URL
            currentIndex: -1, // ç•¶å‰æ­£åœ¨æŸ¥çœ‹çš„ç…§ç‰‡ç´¢å¼•
        };

        let unreadPostsCount = 0;

        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set()

let simulationIntervalId = null;

let currentFrameSelection = { type: null, url: '', target: null }; 

        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;

const THEME_CSS_TEMPLATE = `
/* 
  EPhone ç¾åŒ–ä»£ç¢¼ç¯„æœ¬
  ä½¿ç”¨æ–¹æ³•: 
  1. ä¿®æ”¹ä¸‹é¢çš„é¡è‰²ä»£ç¢¼æˆ–åœ–ç‰‡URLã€‚
  2. ä¸éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†å¯ä»¥åˆªé™¤æˆ–ä¿æŒä¸è®Šã€‚
  3. é¡è‰²ä»£ç¢¼æ ¼å¼ç‚º #RRGGBB (ä¾‹å¦‚ #FFFFFF æ˜¯ç™½è‰²)ã€‚
  4. åœ–ç‰‡URLéœ€è¦æ˜¯ç¶²è·¯ç›´éˆã€‚
*/

/* === 1. æ‰‹æ©Ÿæ®¼èˆ‡åŠ‰æµ·é¡è‰² === */
#phone-frame {
  background-color: #f0f0f0; /* æ‰‹æ©Ÿæ®¼é¡è‰² */
}
.notch {
  background-color: #1a1a1a; /* é ‚éƒ¨â€œåŠ‰æµ·â€é¡è‰² */
}
        #clock-container {  color: white;  }


/* === 1.5. å…¨åŸŸä¸»é¡Œè‰² (é‡è¦ï¼) === */
/* é€™å€‹é¡è‰²æ±ºå®šäº†å¤§éƒ¨åˆ†æŒ‰éˆ•ã€é€£çµå’Œé«˜äº®æ–‡æœ¬çš„é¡è‰²ã€‚*/
:root {
  --accent-color: #007bff; /* é»˜èªæ˜¯è—è‰² */
}

/* === 2. èŠå¤©ä»‹é¢é ‚éƒ¨å’Œåº•éƒ¨çš„åœ–ç‰‡æŒ‰éˆ•æ›¿æ› === */
/* â€œä¸€èµ·è½â€æŒ‰éˆ• (æ­£å¸¸ç‹€æ…‹) */
#listen-together-btn img[src*="8kYShvrJ/90-UI-2.png"] {
  content: url('åœ¨é€™è£¡é»è²¼ä½ çš„â€œæ­£å¸¸ç‹€æ…‹â€åœ–ç‰‡URL');
}
/* â€œä¸€èµ·è½â€æŒ‰éˆ• (æ’­æ”¾ä¸­ç‹€æ…‹) */
#listen-together-btn img[src*="D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png"] {
  content: url('åœ¨é€™è£¡é»è²¼ä½ çš„â€œæ’­æ”¾ä¸­â€åœ–ç‰‡URL');
}
/* â€œèŠå¤©è¨­ç½®â€æŒ‰éˆ• */
#chat-settings-btn img {
  content: url('https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png');
}
/* â€œè§¸ç™¼APIå›å¾©â€æŒ‰éˆ• */
#wait-reply-btn img {
  content: url('https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png');
}
/* â€œç™¼é€â€æŒ‰éˆ• (è¨­ç‚ºåœ–ç‰‡å½¢å¼) */
#send-btn {
  background-image: url('åœ¨é€™è£¡é»è²¼ä½ çš„ç™¼é€æŒ‰éˆ•åœ–ç‰‡URL');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  width: 50px; /* æ ¹æ“šä½ çš„åœ–ç‰‡èª¿æ•´å¯¬åº¦ */
}

/* â€œé‡æ–°ç”Ÿæˆå›å¾©â€æŒ‰éˆ• */
#reroll-btn {
    background-color: rgba(255, 255, 255, 0.6);
    color: var(--text-primary); /* ä½¿ç”¨å…¨åŸŸä¸»é¡Œçš„ä¸»æ–‡æœ¬é¡è‰² */
}

/* === 3. é ‚éƒ¨æ¬„èˆ‡åº•éƒ¨æ¬„é¡è‰² === */
.header, .qzone-header {
  background-color: rgba(240, 240, 240, 0.8); /* é ‚éƒ¨æ¬„èƒŒæ™¯è‰² (å¸¶ä¸€é»é€æ˜) */
  color: #333333; /* é ‚éƒ¨æ¬„æ–‡å­—é¡è‰² */
}
#chat-list-bottom-nav {
  background-color: rgba(245, 245, 245, 0.85); /* åº•éƒ¨å·¡è¦½åˆ—èƒŒæ™¯è‰² */
}
.nav-item {
  color: #8a8a8a; /* åº•éƒ¨å·¡è¦½åˆ—æœªé¸ä¸­é …çš„é¡è‰² */
}
.nav-item.active {
  color: #007bff; /* åº•éƒ¨å·¡è¦½åˆ—é¸ä¸­é …çš„é¡è‰² */
}

/* === 4. å„ä»‹é¢èƒŒæ™¯è‰² === */
#chat-list-screen, #qzone-screen .qzone-content, #memories-view {
  background-color: #f0f2f5 !important; /* åˆ—è¡¨é ä¸»èƒŒæ™¯è‰² */
}

/* === 5. èŠå¤©è¼¸å…¥å€åº•éƒ¨åŠŸèƒ½æ¬„SVGåœ–ç¤ºæ›¿æ› === */
/* æç¤º: ä½ éœ€è¦å°‡ä½ çš„SVGä»£ç¢¼è½‰æ›ç‚ºURLç·¨ç¢¼æ ¼å¼ã€‚
   å¯ä»¥ä½¿ç”¨ç·šä¸Šå·¥å…·æœç´¢ "SVG to Data URI" ä¾†å®Œæˆè½‰æ›ã€‚
   ç„¶å¾Œæ›¿æ›æ‰ä¸‹é¢çš„ url('...') éƒ¨åˆ†ã€‚ */

.chat-action-icon-btn {
  background-color: rgba(255, 255, 255, 0.5); /* åœ–ç¤ºæŒ‰éˆ•çš„èƒŒæ™¯è‰² */
  border: 1px solid rgba(0,0,0,0.05); /* åœ–ç¤ºæŒ‰éˆ•çš„é‚Šæ¡† */
}

/* è¡¨æƒ…é¢æ¿(+)æŒ‰éˆ• */
#open-sticker-panel-btn svg { display: none; /* éš±è—åŸå§‹SVG */ }
#open-sticker-panel-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* ç™¼é€ç…§ç‰‡(èˆŠ)æŒ‰éˆ• */
#send-photo-btn svg { display: none; /* éš±è—åŸå§‹SVG */ }
#send-photo-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* ä¸Šå‚³åœ–ç‰‡(æ–°)æŒ‰éˆ• */
#upload-image-btn svg { display: none; }
#upload-image-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: black;"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* è½‰å¸³(ï¿¥)æŒ‰éˆ• */
#transfer-btn svg { display: none; }
#transfer-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 4L12 12L17 4M12 12V20M8 10H16M8 13H16"></path></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* èªéŸ³æŒ‰éˆ• */
#voice-message-btn svg { display: none; }
#voice-message-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* å¤–è³£æŒ‰éˆ• */
#send-waimai-request-btn svg { display: none; }
#send-waimai-request-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* è¦–é »é€šè©±æŒ‰éˆ• */
#video-call-btn svg { display: none; }
#video-call-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* ç¾¤è¦–é »é€šè©±æŒ‰éˆ• */
#group-video-call-btn svg { display: none; }
#group-video-call-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* æŠ•ç¥¨æŒ‰éˆ• */
#send-poll-btn svg { display: none; }
#send-poll-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* åˆ†äº«é€£çµæŒ‰éˆ• */
#share-link-btn svg { display: none; }
#share-link-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* ç™¼é€å®šä½æŒ‰éˆ• */
#send-location-btn { display: none; }
#send-location-btn {
  background-image: url('data:image/svg+xml;utf8,    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* === 6. æ›´å¤šä»‹é¢èƒŒæ™¯è‰² === */
/* é©ç”¨äºæ‰€æœ‰è¨­ç½®ã€ç·¨è¼¯ã€é¸æ“‡ç­‰äºŒç´šé é¢ */
#api-settings-screen,
#font-settings-screen,
#wallpaper-screen,
#world-book-screen,
#world-book-editor-screen,
#contact-picker-screen,
#member-management-screen,
#album-screen,
#album-photos-screen,
#call-history-screen,
#chat-search-screen,
#browser-screen {
  /* é€™è£¡ä¸å†è¨­ç½®èƒŒæ™¯è‰²ï¼Œè®“å®ƒè‡ªç„¶ç¹¼æ‰¿å¤œé–“æ¨¡å¼çš„é¡è‰² */
}


/* === 7. å›æ†¶å¡ç‰‡ç¾åŒ– === */
.memory-card {
  background-color: #fffaf0 !important; /* å¡ç‰‡ä¸»èƒŒæ™¯è‰² */
  border-left-color: #ffb74d !important; /* å·¦å´è£é£¾æ¢é¡è‰² */
  box-shadow: 0 2px 6px rgba(0,0,0,0.07) !important;
}
.memory-card .header .author {
  color: #d98100 !important; /* ä½œè€…/æ¨™é¡Œæ–‡å­—é¡è‰² */
}
.memory-card .header .date {
  color: #a1887f !important; /* æ—¥æœŸæ–‡å­—é¡è‰² */
}
.memory-card .content {
  color: #5d4037 !important; /* å…§å®¹æ–‡å­—é¡è‰² */
}
`;

// â–¼â–¼â–¼ åœ¨JSé ‚éƒ¨ï¼Œè®Šæ•¸å®šç¾©å€ï¼Œæ·»åŠ é€™å€‹æ–°å¸¸é‡ â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ®µã€ä¿®æ”¹å¾Œã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ DEFAULT_APP_ICONS â–¼â–¼â–¼
const DEFAULT_APP_ICONS = {
    'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
    'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
    'wallpaper': 'https://i.postimg.cc/T1j03pQr/IMG-6440.jpg',
    'font': 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',
    'check-phone': 'https://i.postimg.cc/RVwpwr0r/IMG-8348.jpg',
    'weibo': 'https://i.postimg.cc/PqBY5wBq/weibo-icon.png',
    'forum': 'https://i.postimg.cc/pr0T3WfC/douban-icon.png',
    'lovers-space': 'https://i.postimg.cc/d1wZ39xW/lovers-space-icon.png',
    'game-hall': 'https://i.postimg.cc/P5gL5z2g/game-controller-icon.png',
    'x-social': 'https://i.postimg.cc/8P1H0vQ8/x-logo.png',
    'taobao': 'https://i.postimg.cc/k47tXg1j/taologo.png'
};
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
const DEFAULT_APP_LABELS = {
    'qq': 'QQ',
    'world-book': 'ä¸–ç•Œæ›¸',
    'api-settings': 'APIè¨­ç½®',
    'wallpaper': 'å¤–è§€è¨­ç½®',
    'font': 'å­—é«”',
    'check-phone': 'æŸ¥æ‰‹æ©Ÿ',
    'weibo': 'å¾®åš',
    'forum': 'åœˆå­',
    'lovers-space': 'æƒ…ä¾¶ç©ºé–“',
    'game-hall': 'éŠæˆ²å¤§å»³',
    'x-social': 'Xç¤¾äº¤',
    'taobao': 'æ¡ƒå¯¶'
};
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
const addProductChoiceModal = document.getElementById('add-product-choice-modal');
const aiGeneratedProductsModal = document.getElementById('ai-generated-products-modal');
const productSearchInput = document.getElementById('product-search-input');
const productSearchBtn = document.getElementById('product-search-btn');
// â–²â–²â–² æ–°å¢è®Šæ•¸çµæŸ â–²â–²â–²



        const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/i\.ibb\.co\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;
        const dynamicFontStyle = document.createElement('style');
        dynamicFontStyle.id = 'dynamic-font-style';
        document.head.appendChild(dynamicFontStyle);

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { 
            modalOverlay.classList.add('visible'); 
        }

        function hideCustomModal() { 
            modalOverlay.classList.remove('visible'); 
            modalConfirmBtn.classList.remove('btn-danger'); 
            if (modalResolve) modalResolve(null); 
        }

        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = 'ç¢ºå®š';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = 'å¥½çš„';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = 'ç¢ºå®š';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„å‡½æ•¸ï¼Œé»è²¼åˆ° <script> æ¨™ç±¤çš„æœ€é–‹å§‹ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘ä¸€å€‹å°ˆé–€æ¸…é™¤HTMLæ¨™ç±¤å’Œä»£ç¢¼çš„å‡½æ•¸
 * @param {string} text - åŒ…å«HTMLæˆ–ä»£ç¢¼çš„åŸå§‹æ–‡æœ¬
 * @returns {string} - æ¸…ç†å¾Œçš„ç´”æ–‡å­—
 */
function stripHtmlAndCode(text) {
    if (!text || typeof text !== 'string') {
        return ''; // å¦‚æœè¼¸å…¥ç‚ºç©ºæˆ–ä¸æ˜¯å­—ä¸²ï¼Œè¿”å›ç©ºå­—ä¸²
    }
    // 1. ç§»é™¤æ‰€æœ‰HTMLæ¨™ç±¤ (ä¾‹å¦‚ <b>, <div>)
    let cleanedText = text.replace(/<\/?[^>]+(>|$)/g, "");
    
    // 2. ç§»é™¤æ‰€æœ‰Markdownä»£ç¢¼å¡Š (ä¾‹å¦‚ ```code``` æˆ– `code`)
    cleanedText = cleanedText.replace(/```[\s\S]*?```/g, ''); // ç§»é™¤å¤šè¡Œä»£ç¢¼å¡Š
    cleanedText = cleanedText.replace(/`[^`]*`/g, '');     // ç§»é™¤è¡Œå…§ä»£ç¢¼
    
    // 3. å°‡HTMLå¯¦é«” (ä¾‹å¦‚ &lt; &gt;) è½‰æ›å›æ­£å¸¸å­—å…ƒ (< >)
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = cleanedText;
    
    return tempDiv.textContent || tempDiv.innerText || "";
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘æ›¿æ›èˆŠçš„ showCustomPrompt å‡½æ•¸ â–¼â–¼â–¼
function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = title;
        const inputId = 'custom-prompt-input';
        
        const inputHtml = type === 'textarea' 
            ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
            : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡é¡å¤–çš„HTMLå’Œè¼¸å…¥æ¡†çµ„åˆåœ¨ä¸€èµ·
        modalBody.innerHTML = extraHtml + inputHtml;
        const input = document.getElementById(inputId);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºæ ¼å¼åŠ©æ‰‹æŒ‰éˆ•ç¶å®šäº‹ä»¶
        modalBody.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const templateStr = btn.dataset.template;
                if (templateStr) {
                    try {
                        const templateObj = JSON.parse(templateStr);
                        // ä½¿ç”¨ null, 2 åƒæ•¸è®“JSONå­—ä¸²æ ¼å¼åŒ–ï¼Œå¸¶ç¸®é€²ï¼Œæ›´æ˜“è®€
                        input.value = JSON.stringify(templateObj, null, 2);
                        input.focus();
                    } catch(e) {
                        console.error("è§£ææ ¼å¼ç¯„æœ¬å¤±æ•—:", e);
                    }
                }
            });
        });
        
        modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
        modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
        showCustomModal();
        setTimeout(() => input.focus(), 100);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„å‡½æ•¸ï¼Œé»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„å‡½æ•¸ï¼Œé»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¾ä¸€å€‹é™£åˆ—ä¸­éš¨æ©Ÿç²å–ä¸€å€‹å…ƒç´ 
 * @param {Array} arr - ç›®æ¨™é™£åˆ—
 * @returns {*} - é™£åˆ—ä¸­çš„ä¸€å€‹éš¨æ©Ÿå…ƒç´ 
 */
function getRandomItem(arr) {
    // å®‰å…¨æª¢æŸ¥ï¼Œå¦‚æœé™£åˆ—ç‚ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå­—ä¸²
    if (!arr || arr.length === 0) return '';
    // è¿”å›ä¸€å€‹éš¨æ©Ÿç´¢å¼•å°æ‡‰çš„å…ƒç´ 
    return arr[Math.floor(Math.random() * arr.length)];
}

// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘ç²å–ä¸€å¼µéš¨æ©Ÿçš„æ·˜å¯¶å¯¶è²é è¨­åœ–ç‰‡
 * @returns {string} - è¿”å›ä¸€å¼µéš¨æ©Ÿåœ–ç‰‡çš„URL
 */
function getRandomDefaultProductImage() {
    const defaultImages = [
        'https://i.postimg.cc/W4svy4Hm/Image-1760206134285.jpg',
        'https://i.postimg.cc/jjRb1jF7/Image-1760206125678.jpg'
    ];
    // å¾é™£åˆ—ä¸­éš¨æ©Ÿé¸æ“‡ä¸€å€‹ä¸¦è¿”å›
    return defaultImages[Math.floor(Math.random() * defaultImages.length)];
}

// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘å¾ä¸€å€‹é™£åˆ—ä¸­éš¨æ©Ÿç²å–ä¸€å€‹å…ƒç´ 
 * @param {Array} arr - ç›®æ¨™é™£åˆ—
 * @returns {*} - é™£åˆ—ä¸­çš„ä¸€å€‹éš¨æ©Ÿå…ƒç´ 
 */
function getRandomItem(arr) {
    // å®‰å…¨æª¢æŸ¥ï¼Œå¦‚æœé™£åˆ—ç‚ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå­—ä¸²
    if (!arr || arr.length === 0) return '';
    // è¿”å›ä¸€å€‹éš¨æ©Ÿç´¢å¼•å°æ‡‰çš„å…ƒç´ 
    return arr[Math.floor(Math.random() * arr.length)];
}

// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

        // ===================================================================
        // 2. è³‡æ–™åº«çµæ§‹å®šç¾©
        // ===================================================================

// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›ä½ èˆŠçš„ db.version(...).stores(...) â–¼â–¼â–¼
db.version(40).stores({ // ç‰ˆæœ¬è™Ÿ +1 = 40
    chats: '&id, isGroup, groupId, isPinned, characterPhoneData, latestInnerVoice, innerVoiceHistory, loversSpaceData.emotionDiaries, settings.summary, settings.weiboNickname',
    apiConfig: '&id',
    globalSettings: '&id, activeThemeId', 
    userStickers: '&id, url, name', 
    charStickers: '&id, url, name', 
    worldBooks: '&id, name, categoryId', 
    worldBookCategories: '++id, name',
    musicLibrary: '&id', 
    personaPresets: '&id',
    qzoneSettings: '&id',
    qzonePosts: '++id, timestamp', 
    qzoneAlbums: '++id, name, createdAt',
    qzonePhotos: '++id, albumId',
    favorites: '++id, type, timestamp, originalTimestamp',
    qzoneGroups: '++id, name',
    memories: '++id, chatId, timestamp, type, targetDate' ,
    callRecords: '++id, chatId, timestamp, customName',
    customAvatarFrames: '&id, name, url',   
    themes: '++id, name, css',
    apiPresets: '++id, name, proxyUrl',
    bubbleStylePresets: '++id, name, css',
    fontPresets: '&id, name, url',
    homeScreenPresets: '++id, name',
    weiboPosts: '++id, authorId, timestamp',
    forumGroups: '++id, name, worldview, *categories',
    forumPosts: '++id, groupId, timestamp, *categories',
    forumComments: '++id, postId, timestamp',
    forumCategories: '++id, name',
    tarotReadings: '++id, timestamp',
    pomodoroSessions: '++id, chatId, startTime',
    scriptKillScripts: '++id, name, isBuiltIn',
    taobaoProducts: '++id, name, category', 
    taobaoOrders: '++id, productId, timestamp',
    taobaoCart: '++id, productId',
    userWalletTransactions: '++id, timestamp' ,
    charPhonePresets: '++id, name',
    ludoQuestionBanks: '++id, name',
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šç‚ºå•é¡Œè¡¨å¢åŠ  type æ¬„ä½ç´¢å¼• â˜…â˜…â˜…
    ludoQuestions: '++id, bankId, text, type'
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²





window.db = db;

// ===================================================================
// 3. æ‰€æœ‰åŠŸèƒ½å‡½å¼å®šç¾©
// ===================================================================

// â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šã€ä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ toggleVoiceTranscript å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€V2 - ä¿®å¾©ç‰ˆã€‘åˆ‡æ›èªéŸ³è¨Šæ¯çš„æ–‡å­—é¡¯ç¤º/éš±è—
 * @param {HTMLElement} bubble - è¢«é»æ“Šçš„èªéŸ³è¨Šæ¯çš„ .message-bubble å…ƒç´ 
 */
function toggleVoiceTranscript(bubble) {
    if (!bubble) return;

    const transcriptEl = bubble.querySelector('.voice-transcript');
    if (!transcriptEl) return;

    // æ ¸å¿ƒé‚è¼¯ï¼šç›´æ¥æª¢æŸ¥æ–‡å­—å€åŸŸç•¶å‰æ˜¯ä¸æ˜¯é¡¯ç¤ºç‹€æ…‹
    const isCurrentlyExpanded = transcriptEl.style.display === 'block';

    if (isCurrentlyExpanded) {
        // å¦‚æœæ˜¯å±•é–‹çš„ï¼Œå°±ç›´æ¥æ”¶èµ·ä¾†
        transcriptEl.style.display = 'none';
    } else {
        // å¦‚æœæ˜¯æ”¶èµ·çš„ï¼Œå°±åŸ·è¡Œå±•é–‹æµç¨‹
        
        // 1. å…ˆé¡¯ç¤ºä¸€å€‹â€œæ­£åœ¨è½‰å¯«â€çš„æç¤ºï¼Œçµ¦ç”¨æˆ¶å³æ™‚å›é¥‹
        transcriptEl.textContent = 'æ­£åœ¨è½‰æ–‡å­—...';
        transcriptEl.style.display = 'block';

        // 2. æ¨¡æ“¬ä¸€å€‹çŸ­æš«çš„â€œè­˜åˆ¥â€éç¨‹
        setTimeout(() => {
            // å†æ¬¡æª¢æŸ¥å…ƒç´ æ˜¯å¦é‚„åœ¨é é¢ä¸Šï¼Œé˜²æ­¢ä½¿ç”¨è€…åˆ‡æ›èŠå¤©å°è‡´éŒ¯èª¤
            if (document.body.contains(transcriptEl)) {
                // ç²å–ä¸¦é¡¯ç¤ºçœŸæ­£çš„è½‰å¯«æ–‡å­—
                const voiceText = bubble.dataset.voiceText || '(ç„¡æ³•è­˜åˆ¥)';
                transcriptEl.textContent = voiceText;
            }
        }, 300); // 300æ¯«ç§’çš„å»¶é²ï¼Œæ„Ÿè¦ºæ›´éˆæ•
    }
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„å¾®åšåŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¾®åšç”¨æˆ¶äººè¨­èˆ‡è·æ¥­è¨­ç½®æ ¸å¿ƒåŠŸèƒ½
 */
function openWeiboUserSettingsModal() {
    const modal = document.getElementById('weibo-user-settings-modal');
    const settings = state.qzoneSettings;

    // è¼‰å…¥ç•¶å‰è³‡æ–™åˆ°è¼¸å…¥æ¡†
    document.getElementById('weibo-user-profession-modal-input').value = settings.weiboUserProfession === 'é»æ“Šè¨­ç½®è·æ¥­' ? '' : settings.weiboUserProfession;
    document.getElementById('weibo-user-persona-modal-input').value = settings.weiboUserPersona;
    
    renderWeiboUserPresetSelector(); // æ¸²æŸ“é è¨­ä¸‹æ‹‰æ¸…å–®
    modal.classList.add('visible');
}

async function saveWeiboUserSettings() {
    const profession = document.getElementById('weibo-user-profession-modal-input').value.trim();
    const persona = document.getElementById('weibo-user-persona-modal-input').value.trim();

    state.qzoneSettings.weiboUserProfession = profession || 'é»æ“Šè¨­ç½®è·æ¥­';
    state.qzoneSettings.weiboUserPersona = persona || 'ä¸€å€‹æ™®é€šçš„å¾®åšç”¨æˆ¶ã€‚';

    await saveQzoneSettings(); // ä¿å­˜åˆ°è³‡æ–™åº«
    await renderWeiboProfile(); // åˆ·æ–°ä¸»é é¡¯ç¤º
    document.getElementById('weibo-user-settings-modal').classList.remove('visible');
    alert('å¾®åšè¨­å®šå·²ä¿å­˜ï¼');
}

function renderWeiboUserPresetSelector() {
    const select = document.getElementById('weibo-user-preset-select');
    const presets = state.qzoneSettings.weiboUserPersonaPresets || [];
    select.innerHTML = '<option value="">-- é¸æ“‡é è¨­ --</option>';
    presets.forEach((preset, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = preset.name;
        select.appendChild(option);
    });
}

function handleWeiboUserPresetSelection() {
    const select = document.getElementById('weibo-user-preset-select');
    const presets = state.qzoneSettings.weiboUserPersonaPresets || [];
    const selectedIndex = select.value;

    if (selectedIndex !== "") {
        const preset = presets[parseInt(selectedIndex)];
        document.getElementById('weibo-user-profession-modal-input').value = preset.profession;
        document.getElementById('weibo-user-persona-modal-input').value = preset.persona;
    }
}

async function openWeiboUserPresetManager() {
    const choice = await showChoiceModal("ç®¡ç†é è¨­", [
        { text: 'ğŸ’¾ ä¿å­˜ç•¶å‰ç‚ºæ–°é è¨­', value: 'save' },
        { text: 'ğŸ—‘ï¸ åˆªé™¤å·²é¸é è¨­', value: 'delete' }
    ]);

    if (choice === 'save') {
        const name = await showCustomPrompt("ä¿å­˜é è¨­", "è«‹è¼¸å…¥é è¨­åç¨±");
        if (name && name.trim()) {
            const newPreset = {
                name: name.trim(),
                profession: document.getElementById('weibo-user-profession-modal-input').value.trim(),
                persona: document.getElementById('weibo-user-persona-modal-input').value.trim()
            };
            state.qzoneSettings.weiboUserPersonaPresets.push(newPreset);
            await saveQzoneSettings();
            renderWeiboUserPresetSelector();
            alert(`é è¨­ "${name.trim()}" å·²ä¿å­˜ï¼`);
        }
    } else if (choice === 'delete') {
        const select = document.getElementById('weibo-user-preset-select');
        const selectedIndex = select.value;
        if (selectedIndex === "") {
            alert("è«‹å…ˆå¾ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹è¦åˆªé™¤çš„é è¨­ã€‚");
            return;
        }
        const presets = state.qzoneSettings.weiboUserPersonaPresets;
        const presetName = presets[parseInt(selectedIndex)].name;
        const confirmed = await showCustomConfirm("ç¢ºèªåˆªé™¤", `ç¢ºå®šè¦åˆªé™¤é è¨­ "${presetName}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            presets.splice(parseInt(selectedIndex), 1);
            await saveQzoneSettings();
            renderWeiboUserPresetSelector();
            alert("é è¨­å·²åˆªé™¤ã€‚");
        }
    }
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹ï¼Œé»è²¼æ‰€æœ‰æ–°ä»£ç¢¼ â–¼â–¼â–¼
/**
 * ã€V2æ™ºæ…§ç‰ˆã€‘æ‡‰ç”¨æŒ‡å®šçš„ä¸»é¡Œï¼Œä¸¦æ™ºæ…§åˆ·æ–°ç•¶å‰æ‰“é–‹çš„ä»»ä½•ä»‹é¢
 * @param {string} theme - 'light' æˆ– 'dark'
 */
function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    
    const isDark = theme === 'dark';
    
    // æ ¸å¿ƒæ“ä½œï¼šç‚ºæ‰‹æ©Ÿè¢å¹•æ·»åŠ æˆ–ç§»é™¤ .dark-mode é¡
    phoneScreen.classList.toggle('dark-mode', isDark);
    
    // åŒæ­¥é–‹é—œçš„ç‹€æ…‹
    if (toggleSwitch) {
        toggleSwitch.checked = isDark;
    }
    
    // ä¿å­˜ç”¨æˆ¶çš„é¸æ“‡
    localStorage.setItem('ephone-theme', theme);

    // ã€æ ¸å¿ƒä¿®å¾©ï¼ã€‘
    // ä¸å†åªé—œå¿ƒèŠå¤©ä»‹é¢ï¼Œè€Œæ˜¯æ‰¾å‡ºç•¶å‰ç©¶ç«Ÿæ˜¯å“ªå€‹ä»‹é¢è™•æ–¼å•Ÿå‹•ç‹€æ…‹
    const activeScreen = document.querySelector('.screen.active');
    if (!activeScreen) return; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±é€€å‡º

    // æ ¹æ“šç•¶å‰å•Ÿå‹•çš„ä»‹é¢IDï¼Œèª¿ç”¨å®ƒå°ˆå±¬çš„åˆ·æ–°å‡½æ•¸
    switch (activeScreen.id) {
        case 'chat-interface-screen':
            if (state.activeChatId) {
                renderChatInterface(state.activeChatId);
            }
            break;
        case 'wallpaper-screen':
            // å¤–è§€è¨­ç½®é ä¹Ÿéœ€è¦é‡æ–°æ¸²æŸ“ä¾†æ‡‰ç”¨æ–°ä¸»é¡Œ
            renderWallpaperScreen();
            break;
        case 'font-settings-screen':
            // å­—é«”é è¨­é åŒæ¨£éœ€è¦
            renderFontPresets();
            break;
        // å¦‚æœæœªä¾†é‚„æœ‰å…¶ä»–é é¢éœ€è¦é©é…ï¼Œåœ¨é€™è£¡æ·»åŠ  case å³å¯
    }
}


/**
 * ç•¶ä½¿ç”¨è€…é»æ“Šé–‹é—œæ™‚ï¼Œåˆ‡æ›ç•¶å‰çš„ä¸»é¡Œ
 */
function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    // ç›´æ¥æ ¹æ“šé–‹é—œçš„é¸ä¸­ç‹€æ…‹ä¾†æ±ºå®šæ–°ä¸»é¡Œ
    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
}
/**
 * ã€å…¨æ–°ã€‘åœ¨æ‡‰ç”¨å•Ÿå‹•æ™‚ï¼Œé è¼‰å…¥æ‰€æœ‰å·²ä¿å­˜çš„å­—é«”é è¨­
 */
async function loadAllFontPresetsOnStartup() {
    console.log("æ­£åœ¨é è¼‰å…¥æ‰€æœ‰å­—é«”é è¨­...");
    const presets = await db.fontPresets.toArray();
    if (presets && presets.length > 0) {
        presets.forEach(preset => {
            // æˆ‘å€‘è¤‡ç”¨å·²æœ‰çš„ loadFontForPreview å‡½æ•¸ä¾†è¼‰å…¥æ¯å€‹å­—é«”
            loadFontForPreview(preset);
        });
        console.log(`æˆåŠŸé è¼‰å…¥äº† ${presets.length} å€‹å­—é«”ã€‚`);
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å­—é«”é è¨­åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * æ¸²æŸ“å­—é«”é è¨­çš„5å€‹å¡æ§½
 */
async function renderFontPresets() {
    const container = document.getElementById('font-preset-container');
    container.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

    // å¾è³‡æ–™åº«è®€å–æ‰€æœ‰å·²ä¿å­˜çš„é è¨­
    const presets = await db.fontPresets.toArray();

    // è¿´åœˆ5æ¬¡ï¼Œå‰µå»º5å€‹å¡æ§½çš„HTML
    for (let i = 0; i < 5; i++) {
        const slot = document.createElement('div');
        slot.className = 'font-preset-slot';
        
        const preset = presets[i];

        if (preset) {
            // å¦‚æœé€™å€‹å¡æ§½æœ‰è³‡æ–™
            slot.innerHTML = `
                <div class="font-preview-text" data-preset-id="${preset.id}">Abc ä½ å¥½</div>
                <div class="font-preset-info">åç¨±: ${preset.name}</div>
                <div class="font-preset-actions">
                    <button class="preset-btn apply-btn" data-preset-id="${preset.id}">æ‡‰ç”¨</button>
                    <button class="preset-btn delete-btn delete" data-preset-id="${preset.id}">åˆªé™¤</button>
                </div>
            `;
        } else {
            // å¦‚æœé€™å€‹å¡æ§½æ˜¯ç©ºçš„
            slot.classList.add('empty');
            slot.innerHTML = `
                <div class="font-preset-info">å¡æ§½ ${i + 1} ç‚ºç©º</div>
                <div class="font-preset-actions">
                    <button class="preset-btn secondary upload-url-btn" data-slot-index="${i}">URLä¸Šå‚³</button>
                    <button class="preset-btn secondary upload-local-btn" data-slot-index="${i}">æœ¬åœ°ä¸Šå‚³</button>
                </div>
            `;
        }
        container.appendChild(slot);
    }
    
    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘ç­‰æ‰€æœ‰HTMLéƒ½å‰µå»ºå¥½å¾Œï¼Œå†çµ±ä¸€è¼‰å…¥é è¦½å­—é«” â–¼â–¼â–¼
    presets.forEach(preset => {
        if (preset) {
            // ç‚ºæ¯ä¸€å€‹æœ‰è³‡æ–™çš„é è¨­ï¼Œèª¿ç”¨è¼‰å…¥é è¦½å‡½æ•¸
            loadFontForPreview(preset);
        }
    });
    // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

    // ç‚ºæ‰€æœ‰æ–°ç”Ÿæˆçš„æŒ‰éˆ•ç¶å®šäº‹ä»¶
    addFontPresetButtonListeners();
}


/**
 * ã€çµ‚æ¥µä¿®å¾©ç‰ˆã€‘ç‚ºå–®å€‹é è¨­è¼‰å…¥å­—é«”ä»¥ä¾›é è¦½
 * @param {object} preset - å­—é«”é è¨­ç‰©ä»¶ {id, name, url}
 */
function loadFontForPreview(preset) {
    const styleId = `font-style-${preset.id}`;
    if (document.getElementById(styleId)) return;

    const style = document.createElement('style');
    style.id = styleId;
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘ä¸å†æ‰‹å‹•æ“ä½œå…ƒç´ çš„styleå±¬æ€§ï¼Œ
    // è€Œæ˜¯ç›´æ¥å‰µå»ºä¸€æ¢é«˜å„ªå…ˆé †åºçš„CSSè¦å‰‡ä¾†æ‡‰ç”¨å­—é«”ï¼Œé€™æ›´å¯é ã€‚
    style.innerHTML = `
        @font-face {
            font-family: 'preset-${preset.id}';
            src: url('${preset.url}');
            font-display: swap;
        }

        .font-preview-text[data-preset-id="${preset.id}"] {
            font-family: 'preset-${preset.id}', sans-serif !important;
        }
    `;
    
    document.head.appendChild(style);
}




/**
 * ç‚ºé è¨­å¡æ§½ä¸­çš„æ‰€æœ‰æŒ‰éˆ•çµ±ä¸€æ·»åŠ äº‹ä»¶ç›£è½å™¨
 */
function addFontPresetButtonListeners() {
    document.querySelectorAll('.upload-url-btn').forEach(btn => {
        btn.onclick = () => handleUploadFontUrl(parseInt(btn.dataset.slotIndex));
    });
    document.querySelectorAll('.upload-local-btn').forEach(btn => {
        btn.onclick = () => handleUploadFontLocal(parseInt(btn.dataset.slotIndex));
    });
    document.querySelectorAll('.apply-btn').forEach(btn => {
        btn.onclick = () => applyFontPreset(btn.dataset.presetId);
    });
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = () => deleteFontPreset(btn.dataset.presetId);
    });
}

/**
 * è™•ç†é€šéURLä¸Šå‚³å­—é«”
 * @param {number} slotIndex - å¡æ§½çš„ç´¢å¼• (0-4)
 */
async function handleUploadFontUrl(slotIndex) {
    const url = await showCustomPrompt("å­—é«”URL", "è«‹è¼¸å…¥å­—é«”çš„ç¶²è·¯é€£çµ(.ttf, .otfç­‰)");
    if (!url || !url.trim().startsWith('http')) {
        if (url !== null) alert("è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„URLï¼");
        return;
    }
    const name = await showCustomPrompt("å­—é«”å‘½å", "è«‹ç‚ºé€™å€‹å­—é«”èµ·å€‹åå­—");
    if (!name || !name.trim()) {
        if (name !== null) alert("åå­—ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }
    await saveFontPreset(slotIndex, name.trim(), url.trim());
}

/**
 * è™•ç†é€šéæœ¬åœ°æª”ä¸Šå‚³å­—é«”
 * @param {number} slotIndex - å¡æ§½çš„ç´¢å¼• (0-4)
 */
function handleUploadFontLocal(slotIndex) {
    const input = document.getElementById('font-preset-local-upload');
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const name = await showCustomPrompt("å­—é«”å‘½å", "è«‹ç‚ºé€™å€‹å­—é«”èµ·å€‹åå­—", file.name.replace(/\.[^/.]+$/, ""));
        if (!name || !name.trim()) {
            if (name !== null) alert("åå­—ä¸èƒ½ç‚ºç©ºï¼");
            return;
        }

        // ä½¿ç”¨FileReaderå°‡å­—é«”æª”è½‰ç‚ºBase64 Data URL
        const reader = new FileReader();
        reader.onload = async (event) => {
            // æ ¸å¿ƒä¿®æ”¹ï¼ševent.target.result ç¾åœ¨å°±æ˜¯æˆ‘å€‘éœ€è¦çš„ data:font/ttf;base64,... æ ¼å¼çš„å®Œæ•´æ–‡æœ¬
            await saveFontPreset(slotIndex, name.trim(), event.target.result);
        };
        // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ readAsDataURL ä¾†è®€å–æª”
        reader.readAsDataURL(file);
    };
    input.click(); // è§¸ç™¼æª”é¸æ“‡æ¡†
}


/**
 * å°‡æ–°çš„å­—é«”é è¨­ä¿å­˜åˆ°è³‡æ–™åº«
 * @param {number} slotIndex - å¡æ§½ç´¢å¼•
 * @param {string} name - å­—é«”åç¨±
 * @param {string} url - å­—é«”URL (ç¶²è·¯æˆ–Base64)
 */
// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ saveFontPreset å‡½æ•¸ â–¼â–¼â–¼
async function saveFontPreset(slotIndex, name, url) {
    try {
        const presets = await db.fontPresets.toArray();
        const newPreset = { id: 'font_' + Date.now(), name, url };
        presets.splice(slotIndex, 0, newPreset);
        const presetsToSave = presets.slice(0, 5);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨è³‡æ–™åº«äº‹å‹™ä¾†ä¿è­‰æ“ä½œçš„åŸå­æ€§
        await db.transaction('rw', db.fontPresets, async () => {
            await db.fontPresets.clear();
            await db.fontPresets.bulkPut(presetsToSave);
        });

        await renderFontPresets();
        alert(`å­—é«” "${name}" å·²æˆåŠŸä¿å­˜åˆ°å¡æ§½ ${slotIndex + 1}ï¼`);
    } catch (error) {
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¦‚æœå‡ºéŒ¯ï¼Œæœƒåœ¨é€™è£¡æ•ç²ï¼Œä¸¦å‘ŠçŸ¥ä½¿ç”¨è€…è³‡æ–™æ˜¯å®‰å…¨çš„
        console.error("ä¿å­˜å­—é«”é è¨­å¤±æ•—:", error);
        alert(`ä¿å­˜å­—é«”å¤±æ•—ï¼Œè³‡æ–™å·²è‡ªå‹•å›æ»¾ï¼Œä½ ä¹‹å‰çš„å­—é«”è³‡æ–™æ˜¯å®‰å…¨çš„ã€‚éŒ¯èª¤: ${error.message}`);
        await renderFontPresets(); // å¤±æ•—å¾Œé‡æ–°æ¸²æŸ“ï¼Œæ¢å¾©åˆ°èˆŠçš„æ¸…å–®ç‹€æ…‹
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * åˆªé™¤ä¸€å€‹å­—é«”é è¨­
 * @param {string} presetId - è¦åˆªé™¤çš„é è¨­çš„ID
 */
async function deleteFontPreset(presetId) {
    const preset = await db.fontPresets.get(presetId);
    if (!preset) return;
    const confirmed = await showCustomConfirm("ç¢ºèªåˆªé™¤", `ç¢ºå®šè¦åˆªé™¤å­—é«” "${preset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.fontPresets.delete(presetId);
        
        // å¾DOMä¸­ç§»é™¤å°æ‡‰çš„é è¦½æ¨£å¼
        const styleTag = document.getElementById(`font-style-${presetId}`);
        if (styleTag) styleTag.remove();

        await renderFontPresets();
    }
}

/**
 * æ‡‰ç”¨ä¸€å€‹å­—é«”é è¨­ç‚ºå…¨åŸŸå­—é«”
 * @param {string} presetId - è¦æ‡‰ç”¨çš„é è¨­çš„ID
 */
async function applyFontPreset(presetId) {
    const preset = await db.fontPresets.get(presetId);
    if (preset) {
        // èª¿ç”¨ä½ å·²æœ‰çš„å…¨åŸŸå­—é«”æ‡‰ç”¨å‡½æ•¸
        applyCustomFont(preset.url, false);
        // ä¿å­˜åˆ°å…¨åŸŸè¨­ç½®
        state.globalSettings.fontUrl = preset.url;
        await db.globalSettings.put(state.globalSettings);
        alert(`å·²å°‡å…¨åŸŸå­—é«”æ›´æ›ç‚º "${preset.name}"ï¼`);
    }
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

/**
 * ã€ç¸½å…¥å£ã€‘è™•ç†ç”¨æˆ¶é¸æ“‡çš„è§’è‰²å¡æª”
 * @param {File} file - ä½¿ç”¨è€…é¸æ“‡çš„æª”ç‰©ä»¶
 */
async function handleCharacterImport(file) {
    if (!file) return;

    try {
        let characterData;
        let avatarBase64;

        if (file.name.toLowerCase().endsWith('.png')) {
            // å¦‚æœæ˜¯PNGæª”ï¼Œèª¿ç”¨PNGè§£æå‡½æ•¸
            const result = await parseCharPng(file);
            characterData = result.characterData;
            avatarBase64 = result.avatarBase64;
        } else if (file.name.toLowerCase().endsWith('.json')) {
            // å¦‚æœæ˜¯JSONæª”ï¼Œèª¿ç”¨JSONè§£æå‡½æ•¸
            characterData = await parseCharJson(file);
            // JSONå¡é€šå¸¸ä¸åŒ…å«åœ–ç‰‡ï¼Œæˆ‘å€‘çµ¦ä¸€å€‹é è¨­é ­åƒ
            avatarBase64 = defaultAvatar;
        } else {
            alert('ä¸æ”¯æŒçš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹é¸æ“‡ .png æˆ– .json æ–‡ä»¶ã€‚');
            return;
        }

        if (characterData) {
            // æˆåŠŸè§£æå‡ºè³‡æ–™å¾Œï¼Œèª¿ç”¨å‰µå»ºå‡½æ•¸
            await createCharacterFromData(characterData, avatarBase64);
        }

    } catch (error) {
        console.error("å°å…¥è§’è‰²å¡å¤±æ•—:", error);
        alert(`å°å…¥å¤±æ•—: ${error.message}`);
    }
}

/**
 * ã€V3 - æœ€çµ‚äº‚ç¢¼ä¿®å¾©ç‰ˆã€‘
 * è§£æSillyTavernçš„PNGè§’è‰²å¡ï¼Œé€šéä½å…ƒçµ„ç´šæ“ä½œå¾¹åº•è§£æ±ºä¸­æ–‡äº‚ç¢¼å•é¡Œã€‚
 * @param {File} file - PNGæ–‡ä»¶
 * @returns {Promise<{characterData: object, avatarBase64: string}>}
 */
async function parseCharPng(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const arrayBuffer = e.target.result;
            const dataView = new DataView(arrayBuffer);

            if (dataView.getUint32(0) !== 0x89504E47 || dataView.getUint32(4) !== 0x0D0A1A0A) {
                return reject(new Error('æª”ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„PNGåœ–ç‰‡ã€‚'));
            }

            let offset = 8;
            let characterJson = null;

            while (offset < dataView.byteLength) {
                const length = dataView.getUint32(offset);
                const type = String.fromCharCode(
                    dataView.getUint8(offset + 4),
                    dataView.getUint8(offset + 5),
                    dataView.getUint8(offset + 6),
                    dataView.getUint8(offset + 7)
                );

                if (type === 'tEXt') {
                    const chunkData = new Uint8Array(arrayBuffer, offset + 8, length);
                    
                    // â˜…â˜…â˜…â˜…â˜…ã€é€™æ˜¯æœ¬æ¬¡ä¿®å¾©äº‚ç¢¼çš„æ ¸å¿ƒä»£ç¢¼ã€‘â˜…â˜…â˜…â˜…â˜…
                    // 1. å…ˆç”¨ä¸€å€‹ç°¡å–®çš„ç·¨ç¢¼å°‡ä½å…ƒçµ„è½‰ç‚ºå­—ä¸²ï¼Œä»¥ä¾¿æŸ¥æ‰¾é—œéµå­— "chara"
                    let text = '';
                    for (let i = 0; i < chunkData.length; i++) {
                        text += String.fromCharCode(chunkData[i]);
                    }

                    // 2. æª¢æŸ¥é—œéµå­—æ˜¯å¦å­˜åœ¨
                    const keyword = 'chara' + String.fromCharCode(0);
                    if (text.startsWith(keyword)) {
                        // 3. æå–å‡ºé—œéµå­—å¾Œé¢çš„ Base64 ç·¨ç¢¼çš„å­—ä¸²
                        const base64Data = text.substring(keyword.length);
                        try {
                            // 4. ä½¿ç”¨ atob() è§£ç¢¼ Base64ï¼Œå¾—åˆ°ä¸€å€‹â€œäºŒé€²ä½å­—å…ƒä¸²â€
                            const binaryString = atob(base64Data);
                            
                            // 5. å°‡é€™å€‹â€œäºŒé€²ä½å­—å…ƒä¸²â€é‡æ–°è½‰æ›ç‚ºåŸå§‹çš„ UTF-8 ä½å…ƒçµ„é™£åˆ—
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            
                            // 6. ä½¿ç”¨ TextDecoder å°‡é€™å€‹ç´”æ·¨çš„ UTF-8 ä½å…ƒçµ„é™£åˆ—è§£ç¢¼ç‚ºæ­£ç¢ºçš„å­—ä¸²
                            const decodedJsonString = new TextDecoder('utf-8').decode(bytes);
                            
                            // 7. è§£ææœ€çµ‚çš„JSONå­—ä¸²
                            characterJson = JSON.parse(decodedJsonString);
                            break;
                        } catch (e) {
                            return reject(new Error('è§£æåœ–ç‰‡å…§åµŒçš„è§’è‰²è³‡æ–™å¤±æ•—ï¼Œå¯èƒ½æ˜¯è³‡æ–™æå£ã€‚'));
                        }
                    }
                    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä»£ç¢¼çµæŸã€‘â˜…â˜…â˜…â˜…â˜…
                }
                
                if (type === 'IEND') break;
                offset += 12 + length;
            }

            if (characterJson) {
                const imageReader = new FileReader();
                imageReader.onload = (imgEvent) => {
                    resolve({
                        characterData: characterJson,
                        avatarBase64: imgEvent.target.result
                    });
                };
                imageReader.onerror = () => reject(new Error('è®€å–åœ–ç‰‡ä½œç‚ºé ­åƒå¤±æ•—ã€‚'));
                imageReader.readAsDataURL(file);
            } else {
                reject(new Error('åœ¨é€™å¼µPNGåœ–ç‰‡ä¸­æ²’æœ‰æ‰¾åˆ°SillyTavernè§’è‰²è³‡æ–™ã€‚'));
            }
        };
        reader.onerror = () => reject(new Error('è®€å–PNGæª”å¤±æ•—ã€‚'));
        reader.readAsArrayBuffer(file);
    });
}


/**
 * è§£æJSONè§’è‰²å¡
 * @param {File} file - JSONæ–‡ä»¶
 * @returns {Promise<object>}
 */
/**
 * ã€ä¿®æ­£ç‰ˆã€‘è§£æJSONè§’è‰²å¡ï¼Œå¼·åˆ¶ä½¿ç”¨UTF-8ç·¨ç¢¼
 * @param {File} file - JSONæ–‡ä»¶
 * @returns {Promise<object>}
 */
async function parseCharJson(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                // æ ¸å¿ƒä¿®æ­£ï¼šå…ˆè®€å–ç‚ºArrayBufferï¼Œå†ç”¨TextDecoderæŒ‡å®šUTF-8è§£ç¢¼
                const arrayBuffer = e.target.result;
                const textDecoder = new TextDecoder('utf-8');
                const jsonString = textDecoder.decode(arrayBuffer);
                const data = JSON.parse(jsonString);
                // ç›¸å®¹å…©ç¨®å¯èƒ½çš„æ ¼å¼
                resolve(data.data || data);
            } catch (error) {
                reject(new Error('è§£æJSONæª”å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼æˆ–ç·¨ç¢¼ã€‚'));
            }
        };
        reader.onerror = () => reject(new Error('è®€å–JSONæª”å¤±æ•—ã€‚'));
        // æ ¸å¿ƒä¿®æ­£ï¼šè®€å–ç‚ºArrayBufferè€Œä¸æ˜¯Text
        reader.readAsArrayBuffer(file);
    });
}

/**
 * ã€V5 - æœ€çµ‚é©é…ç‰ˆ - è­˜åˆ¥ character_bookã€‘
 * æ ¹æ“šè§£æå‡ºçš„è³‡æ–™å‰µå»ºæ–°è§’è‰²å’Œä¸–ç•Œæ›¸ã€‚
 * é€™å€‹ç‰ˆæœ¬å°‡å„ªå…ˆæŸ¥æ‰¾æ‚¨æä¾›çš„ character_book æ¨™æº–æ ¼å¼ã€‚
 * @param {object} data - å¾å¡ç‰‡è§£æå‡ºçš„æœ€åŸå§‹çš„JSONè³‡æ–™
 * @param {string} avatarBase64 - è§’è‰²çš„é ­åƒåœ–ç‰‡ (Base64)
 */
async function createCharacterFromData(data, avatarBase64) {
    // æ­¥é©Ÿ 1: ç¢ºå®šæ ¸å¿ƒè§’è‰²è³‡æ–™ (ä¸è®Š)
    const charData = data.data || data;
    const characterName = charData.name ? charData.name.trim() : 'æœªå‘½åè§’è‰²';
    
    // æ­¥é©Ÿ 2: å‰µå»ºæ–°çš„èŠå¤©ç‰©ä»¶ (ä¸è®Š)
    const newChatId = 'chat_' + Date.now();
// â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šã€çµ‚æ¥µå®Œæ•´ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›ä½ èˆŠçš„ const newChat = { ... }; ä»£ç¢¼å¡Š â–¼â–¼â–¼

const newChat = {
    id: newChatId,
    name: characterName,
    isGroup: false,
    isPinned: false,
    history: [],
    unreadCount: 0,
    musicData: { totalTime: 0 },
    npcLibrary: [],
    relationship: { status: 'friend', blockedTimestamp: null, applicationReason: '' },
    status: { text: 'ç·šä¸Š', lastUpdate: Date.now(), isBusy: false },
    weiboDms: [],
    loversSpaceData: null,
    settings: {
        aiPersona: charData.description || 'è©²è§’è‰²æ²’æœ‰æè¿°ã€‚',
        myPersona: 'æˆ‘æ˜¯èª°å‘€ã€‚',
        maxMemory: 10,
        aiAvatar: avatarBase64,
        myAvatar: defaultAvatar,
        background: '',
        theme: 'default',
        fontSize: 13,
        customCss: '',
        linkedWorldBookIds: [],
        aiAvatarLibrary: [],
        stickerLibrary: [],
        summary: { 
            enabled: false, 
            mode: 'auto', 
            count: 20, 
            prompt: 'è«‹ä½ ä»¥ç¬¬ä¸‰äººç¨±çš„è¦–è§’ï¼Œå®¢è§€ã€å†·éœã€ä¸å¸¶ä»»ä½•æ„Ÿæƒ…è‰²å½©åœ°ç¸½çµä»¥ä¸‹å°è©±çš„æ ¸å¿ƒäº‹ä»¶å’Œè³‡è¨Šã€‚ç¦æ­¢é€²è¡Œä»»ä½•è§’è‰²æ‰®æ¼”æˆ–æ·»åŠ ä¸»è§€è©•è«–ã€‚', 
            lastSummaryIndex: -1 
        },
        linkedMemories: [],
        offlineMode: { 
            enabled: false, 
            prompt: '', 
            style: '', 
            wordCount: 300, 
            presets: [] 
        },
        timePerceptionEnabled: true,
        customTime: '',
        isCoupleAvatar: false,
        coupleAvatarDescription: '',
        weiboProfession: '',
        weiboInstruction: '',
        visualVideoCallEnabled: false,
        charVideoImage: '',
        userVideoImage: '',
        petAdopted: false,
        pet: null,
    },
    characterPhoneData: {
        lastGenerated: null,
        chats: {},
        shoppingCart: [],
        memos: [],
        browserHistory: [],
        photoAlbum: [],
        bank: { balance: 0, transactions: [] },
        trajectory: [],
        appUsage: [],
        diary: []
    }
};

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

    await db.chats.put(newChat);
    state.chats[newChatId] = newChat;
    
    // =================================================================
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šé‡æ§‹ä¸–ç•Œæ›¸æŸ¥æ‰¾é‚è¼¯ â–¼â–¼â–¼
    // =================================================================
    
    console.log("é–‹å§‹æª¢æ¸¬ä¸–ç•Œæ›¸è³‡æ–™...");
    let worldBookFound = false;

    // ç­–ç•¥ä¸€ï¼šã€æœ€é«˜å„ªå…ˆé †åºã€‘æŸ¥æ‰¾æ‚¨æä¾›çš„ character_book æ¨™æº–æ ¼å¼
    if (charData.character_book && charData.character_book.entries && Array.isArray(charData.character_book.entries) && charData.character_book.entries.length > 0) {
        console.log(`æª¢æ¸¬åˆ°æœ€æ–°çš„ character_book æ ¼å¼ (${charData.character_book.entries.length}æ¢)ï¼Œé–‹å§‹å°å…¥...`);
        const newCategory = { name: characterName };
        const newCategoryId = await db.worldBookCategories.add(newCategory);
        // æˆ‘å€‘å°‡èª¿ç”¨ã€ä¿®æ”¹å¾Œã€‘çš„è¼”åŠ©å‡½æ•¸ä¾†è™•ç†
        await saveWorldBookEntriesFromArray(charData.character_book.entries, newCategoryId);
        worldBookFound = true;
    }
    
    // ç­–ç•¥äºŒï¼šç›¸å®¹èˆŠçš„ world_entries æ ¼å¼
    else if (charData.world_entries && Array.isArray(charData.world_entries) && charData.world_entries.length > 0) {
        console.log(`æª¢æ¸¬åˆ°èˆŠç‰ˆ world_entries æ ¼å¼ (${charData.world_entries.length}æ¢)ï¼Œé–‹å§‹å°å…¥...`);
        const newCategory = { name: characterName };
        const newCategoryId = await db.worldBookCategories.add(newCategory);
        await saveWorldBookEntriesFromArray(charData.world_entries, newCategoryId);
        worldBookFound = true;
    }
    
    // ç­–ç•¥ä¸‰ï¼šç›¸å®¹æ›´èˆŠçš„ data.world æ ¼å¼
    else if (data.world && typeof data.world === 'string' && data.world.trim()) {
        console.log("æª¢æ¸¬åˆ°å¤–å±¤ world æ¬„ä½æ ¼å¼ï¼Œé–‹å§‹å°å…¥...");
        const newCategory = { name: characterName };
        const newCategoryId = await db.worldBookCategories.add(newCategory);
        await parseAndSaveWorldBooks(data.world, newCategoryId);
        worldBookFound = true;
    }

    // ç­–ç•¥å››ï¼šæœ€å¾Œçš„ç›¸å®¹æ‰‹æ®µ world_info
    else if (charData.world_info && typeof charData.world_info === 'string' && charData.world_info.trim()) {
        console.log("æª¢æ¸¬åˆ°èˆŠç‰ˆ world_info æ¬„ä½æ ¼å¼ï¼Œé–‹å§‹å°å…¥...");
        const newCategory = { name: characterName };
        const newCategoryId = await db.worldBookCategories.add(newCategory);
        await parseAndSaveWorldBooks(charData.world_info, newCategoryId);
        worldBookFound = true;
    }

    if (!worldBookFound) {
        console.log("è¨ºæ–·ï¼šåœ¨æ­¤è§’è‰²å¡ä¸­æœªæ‰¾åˆ°ä»»ä½•å¯è­˜åˆ¥çš„ä¸–ç•Œæ›¸æ¬„ä½ã€‚");
    }
    
    // =================================================================
    // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹çµæŸ â–²â–²â–²
    // =================================================================

    // æ­¥é©Ÿ 4: åˆ·æ–°UI (ä¸è®Š)
    await renderChatList();
    await showCustomAlert('å°å…¥æˆåŠŸï¼', `è§’è‰²â€œ${characterName}â€å·²æˆåŠŸå‰µå»ºï¼`);
}


/**
 * ã€V2 - é©é… comment æ¬„ä½ã€‘
 * å¾SillyTavernçš„ world_entries æˆ– character_book.entries é™£åˆ—ç›´æ¥å‰µå»ºä¸–ç•Œæ›¸
 * @param {Array<object>} entriesArray - åŒ…å«ä¸–ç•Œæ›¸æ¢ç›®çš„é™£åˆ—
 * @param {number} categoryId - é€™äº›ä¸–ç•Œæ›¸æ‰€å±¬çš„åˆ†é¡ID
 */
async function saveWorldBookEntriesFromArray(entriesArray, categoryId) {
    const newBooks = [];

    for (const entry of entriesArray) {
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ™ºèƒ½ç²å–æ¢ç›®åç¨± â–¼â–¼â–¼
        // å„ªå…ˆä½¿ç”¨ comment æ¬„ä½ä½œç‚ºæ¨™é¡Œï¼Œå¦‚æœå®ƒå­˜åœ¨ä¸”ä¸ç‚ºç©ºã€‚
        // å¦å‰‡ï¼Œå†å˜—è©¦ä½¿ç”¨ keys é™£åˆ—ã€‚
        // å¦‚æœéƒ½æ²’æœ‰ï¼Œå°±çµ¦ä¸€å€‹é»˜èªåå­—ã€‚
        const entryName = (entry.comment && entry.comment.trim()) 
                          ? entry.comment.trim() 
                          : (entry.keys && entry.keys.length > 0 ? entry.keys.join(', ') : 'æœªå‘½åæ¢ç›®');
        // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹çµæŸ â–²â–²â–²

        // æª¢æŸ¥æ¢ç›®æ˜¯å¦æœ‰æ•ˆ (æœ‰åå­—ã€æœ‰å…§å®¹ï¼Œä¸¦ä¸”æ˜¯å•Ÿç”¨çš„)
        // (typeof entry.enabled === 'undefined' || entry.enabled) æ˜¯ç‚ºäº†ç›¸å®¹æ²’æœ‰ enabled æ¬„ä½çš„å¡ç‰‡
        if (entryName !== 'æœªå‘½åæ¢ç›®' && entry.content && (typeof entry.enabled === 'undefined' || entry.enabled)) {
            newBooks.push({
                id: 'wb_' + Date.now() + Math.random(),
                name: entryName, // ä½¿ç”¨æˆ‘å€‘æ™ºæ…§ç²å–åˆ°çš„åå­—
                content: entry.content,
                categoryId: categoryId
            });
        }
    }

    if (newBooks.length > 0) {
        await db.worldBooks.bulkAdd(newBooks);
        // ç¢ºä¿ state.worldBooks ä¹Ÿè¢«æ›´æ–°ï¼Œä»¥ä¾¿UIèƒ½ç«‹å³é¡¯ç¤º
        const allBooks = await db.worldBooks.toArray();
        state.worldBooks = allBooks;
        console.log(`æˆåŠŸå°å…¥ ${newBooks.length} å€‹ä¸–ç•Œæ›¸æ¢ç›®åˆ°åˆ†é¡ID: ${categoryId}`);
    }
}



// ã€è¼”åŠ©å‡½æ•¸ã€‘ç²å–äº‹ä»¶çš„åº§æ¨™
function getEventCoords(e) {
    // å¦‚æœæ˜¯è§¸æ‘¸äº‹ä»¶ï¼Œå°±å¾ e.touches[0] ç²å–
    if (e.touches && e.touches[0]) {
        return { x: e.touches[0].pageX, y: e.touches[0].pageY };
    }
    // å¦å‰‡ï¼Œå°±æ˜¯æ»‘é¼ äº‹ä»¶ï¼Œç›´æ¥å¾ e ç²å–
    return { x: e.pageX, y: e.pageY };
}


        function showScreen(screenId) {
              // å¦‚æœç•¶å‰å•Ÿå‹•çš„ä¸æ˜¯ç‰©æµé é¢ï¼Œå°±æ¸…ç©ºæ‰€æœ‰ç‰©æµæ›´æ–°çš„è¨ˆæ™‚å™¨
    if (!document.getElementById('logistics-screen').classList.contains('active')) {
        logisticsUpdateTimers.forEach(timerId => clearTimeout(timerId));
        logisticsUpdateTimers = [];
    }
    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
            if (screenId === 'chat-list-screen') {
                window.renderChatListProxy(); 
                switchToChatListView('messages-view');
            }
            if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
            if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
            if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screenToShow = document.getElementById(screenId);
            if (screenToShow) screenToShow.classList.add('active');
            if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
            if (screenId === 'font-settings-screen') {
                // æ›´æ–°å…¨åŸŸå­—é«”é è¦½
                document.getElementById('font-preview').style.fontFamily = '';
                applyCustomFont(state.globalSettings.fontUrl || '', true);
                
                // æ¸²æŸ“5å€‹é è¨­å¡æ§½
                renderFontPresets();
            }

        }
        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
            const chatListScreen = document.getElementById('chat-list-screen');
            const views = {
                'messages-view': document.getElementById('messages-view'),
                'qzone-screen': document.getElementById('qzone-screen'),
                'favorites-view': document.getElementById('favorites-view'),
        'memories-view': document.getElementById('memories-view') // <-- æ–°å¢é€™ä¸€è¡Œ
    };
            const mainHeader = document.getElementById('main-chat-list-header');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // ç²å–ä¸»å·¡è¦½åˆ—

            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }

            // éš±è—æ‰€æœ‰è¦–åœ–
            Object.values(views).forEach(v => v.classList.remove('active'));
            // é¡¯ç¤ºç›®æ¨™è¦–åœ–
            if (views[viewId]) {
                views[viewId].classList.add('active');
            }

            // æ›´æ–°åº•éƒ¨å·¡è¦½åˆ—é«˜äº®
            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === viewId);
            });
            
            // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡çµ±ä¸€ç®¡ç†æ‰€æœ‰UIå…ƒç´ çš„é¡¯éš± â–¼â–¼â–¼
            if (viewId === 'messages-view') {
                mainHeader.style.display = 'flex';
                mainBottomNav.style.display = 'flex';
            } else {
                mainHeader.style.display = 'none';
                mainBottomNav.style.display = 'none';
            }
            // â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–²

    if (viewId !== 'memories-view') {
        activeCountdownTimers.forEach(timerId => clearInterval(timerId));
        activeCountdownTimers = [];
    }

            // æ ¹æ“šè¦–åœ–IDåŸ·è¡Œç‰¹å®šçš„æ¸²æŸ“/æ›´æ–°é‚è¼¯
            switch (viewId) {
                case 'qzone-screen':
                    views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                    updateUnreadIndicator(0);
                    renderQzoneScreen();
                    renderQzonePosts();
                    break;
                case 'favorites-view':
                    views['favorites-view'].style.backgroundColor = '#f9f9f9';
                    renderFavoritesScreen();
                    break;
                case 'messages-view':
                    // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨é€™è£¡æ·»åŠ è¿”å›æ¶ˆæ¯æ¸…å–®æ™‚è¦åŸ·è¡Œçš„é‚è¼¯
                    break;
            }
        }
        
        function renderQzoneScreen() {
            if (state && state.qzoneSettings) {
                const settings = state.qzoneSettings;
                document.getElementById('qzone-nickname').textContent = settings.nickname;
                document.getElementById('qzone-avatar-img').src = settings.avatar;
                document.getElementById('qzone-banner-img').src = settings.banner;
            }
        }
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
            if (db && state.qzoneSettings) {
                await db.qzoneSettings.put(state.qzoneSettings);
            }
        }

        function formatPostTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffMinutes < 1) return 'å‰›å‰›';
            if (diffMinutes < 60) return `${diffMinutes}åˆ†é˜å‰`;
            if (diffHours < 24) return `${diffHours}å°æ™‚å‰`;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            if (now.getFullYear() === year) {
                return `${month}-${day} ${hours}:${minutes}`;
            } else {
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
        }

// â–¼â–¼â–¼ æ­¥é©Ÿ3.1ï¼šç”¨é€™æ•´å¡Šã€çµ‚æ¥µä¿®å¾©ç‰ˆã€‘ä»£ç¢¼æ›¿æ›èˆŠçš„ renderQzonePosts å‡½æ•¸ â–¼â–¼â–¼
async function renderQzonePosts() {
    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) return;

    const [posts, favorites] = await Promise.all([
        db.qzonePosts.orderBy('timestamp').reverse().toArray(),
        db.favorites.where('type').equals('qzone_post').toArray()
    ]);

    const favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
    
    postsListEl.innerHTML = '';

    if (posts.length === 0) {
        postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">é€™è£¡ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«ä¾†ç™¼ä½ˆç¬¬ä¸€æ¢èªªèªªå§ï¼</p>';
        return;
    }

    const userSettings = state.qzoneSettings;
    
// â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹æ›¿æ› â–¼â–¼â–¼
// â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘é€™æ¬¡ä¿®å¾©çš„æ ¸å¿ƒ â˜…â˜…â˜…â˜…â˜…
// 1. åœ¨æ¸²æŸ“æ‰€æœ‰å¸–å­ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆå‰µå»ºä¸€å€‹åŒ…å«æ‰€æœ‰AIè§’è‰²åå­—çš„é›†åˆ(Set)ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾ã€‚
const allAiCharacterNames = new Set(Object.values(state.chats).filter(chat => !chat.isGroup).map(chat => chat.name));
// â˜…â˜…â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…â˜…â˜…

posts.forEach(post => {
    const postContainer = document.createElement('div');
    postContainer.className = 'qzone-post-container';
    postContainer.dataset.postId = post.id;

    const postEl = document.createElement('div');
    postEl.className = 'qzone-post-item';

    let authorAvatar = '', authorNickname = '', commentAvatar = userSettings.avatar; 

    if (post.authorId === 'user') {
        authorAvatar = userSettings.avatar;
        authorNickname = userSettings.nickname;
    } else if (state.chats[post.authorId]) {
        const authorChat = state.chats[post.authorId];
        authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
        authorNickname = authorChat.name;
    } else {
        authorAvatar = defaultAvatar;
        authorNickname = '{{char}}';
    }
    
    let contentHtml = '';
    const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';

    if (post.type === 'shuoshuo') {
        contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(/\n/g, '<br>')}</div>`;
    } 
    else if (post.type === 'image_post' && post.imageUrl) {
        contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
    } 
    else if (post.type === 'text_image') {
        contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
    }

    let likesHtml = '';
    if (post.likes && post.likes.length > 0) {
        likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join('ã€')} è¦ºå¾—å¾ˆè´Š</span></div>`;
    }
    
    let commentsHtml = '';
    if (post.comments && post.comments.length > 0) {
        // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘é€™æ¬¡ä¿®å¾©çš„æ ¸å¿ƒ â˜…â˜…â˜…â˜…â˜…
        // 2. ä¿®æ”¹é€™è£¡çš„éæ¿¾é‚è¼¯
        const commentsToShow = post.areCommentsVisible === false 
            ? post.comments.filter(comment => 
                // æ¢ä»¶1: è©•è«–è€…æ˜¯ä½ è‡ªå·±
                comment.commenterName === userSettings.nickname || 
                // æ¢ä»¶2: è©•è«–è€…çš„åå­—åœ¨æˆ‘å€‘å‰›æ‰å‰µå»ºçš„AIè§’è‰²åå­—åˆ—è¡¨è£¡
                allAiCharacterNames.has(comment.commenterName)
              )
            : post.comments; // å¦‚æœé–‹é—œæ˜¯é–‹çš„ï¼Œå°±é¡¯ç¤ºæ‰€æœ‰è©•è«–
        // â˜…â˜…â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…â˜…â˜…

        if (commentsToShow.length > 0) {
// â–²â–²â–² æ›¿æ›åˆ°é€™è£¡çµæŸ â–²â–²â–²

                commentsHtml = '<div class="post-comments-container">';
                commentsToShow.forEach(comment => {
                    const originalIndex = post.comments.indexOf(comment);
                    let replyHtml = '';
                    if (comment.replyTo) {
                        replyHtml = `<span class="reply-text">å›å¾©</span> <span class="reply-target-name">${comment.replyTo}</span>`;
                    }
                    commentsHtml += `
                        <div class="comment-item" data-commenter-name="${comment.commenterName}">
                            <span class="commenter-name">${comment.commenterName}</span>${replyHtml}:
                            <span class="comment-text"> ${comment.text}</span>
                            <span class="comment-delete-btn" data-comment-index="${originalIndex}">Ã—</span>
                        </div>`;
                });
                commentsHtml += '</div>';
            }
        }


        const commentsAndFooterHtml = `
            ${commentsHtml}
            <div class="post-footer">
                <div class="comment-section">
                    <img src="${commentAvatar}" class="comment-avatar">
                    <input type="text" class="comment-input" placeholder="å‹å–„çš„è©•è«–æ˜¯äº¤æµçš„èµ·é»">
                    <div class="at-mention-popup"></div>
                </div>
                <button class="comment-send-btn">ç™¼é€</button>
            </div>
        `;

        const userNickname = state.qzoneSettings.nickname;
        const isLikedByUser = post.likes && post.likes.includes(userNickname);
        const isFavoritedByUser = favoritedPostIds.has(post.id);

        postEl.innerHTML = `
            <div class="post-header"><img src="${authorAvatar}" class="post-avatar"><div class="post-info"><span class="post-nickname">${authorNickname}</span><span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span></div>
                <div class="post-actions-btn">â€¦</div>
            </div>
            <div class="post-main-content">${contentHtml}</div>
            <div class="post-feedback-icons">
                <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                <span class="action-icon summon-npc" data-post-id="${post.id}" data-author-id="${post.authorId}" title="å¬å–šNPCè©•è«–"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></span>
                </div>
            ${likesHtml}
            ${commentsAndFooterHtml} 
        `;
        
        const deleteAction = document.createElement('div');
        deleteAction.className = 'qzone-post-delete-action';
        deleteAction.innerHTML = '<span>åˆªé™¤</span>';
        postContainer.appendChild(postEl);
        postContainer.appendChild(deleteAction);
        const commentSection = postContainer.querySelector('.comment-section');
        if (commentSection) {
            commentSection.addEventListener('touchstart', (e) => e.stopPropagation());
            commentSection.addEventListener('mousedown', (e) => e.stopPropagation());
        }
        postsListEl.appendChild(postContainer);
        const commentInput = postContainer.querySelector('.comment-input');
        if (commentInput) {
            const popup = postContainer.querySelector('.at-mention-popup');
            commentInput.addEventListener('input', () => {
                const value = commentInput.value;
                const atMatch = value.match(/@([\p{L}\w]*)$/u);
                if (atMatch) {
                    const namesToMention = new Set();
                    const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                    if (authorNickname) namesToMention.add(authorNickname);
                    postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                        namesToMention.add(nameEl.textContent.replace(':', ''));
                    });
                    namesToMention.delete(state.qzoneSettings.nickname);
                    popup.innerHTML = '';
                    if (namesToMention.size > 0) {
                        const searchTerm = atMatch[1];
                        namesToMention.forEach(name => {
                            if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                                const item = document.createElement('div');
                                item.className = 'at-mention-item';
                                item.textContent = name;
                                item.addEventListener('mousedown', (e) => {
                                    e.preventDefault();
                                    const newText = value.substring(0, atMatch.index) + `@${name} `;
                                    commentInput.value = newText;
                                    popup.style.display = 'none';
                                    commentInput.focus();
                                });
                                popup.appendChild(item);
                            }
                        });
                        popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                    } else {
                        popup.style.display = 'none';
                    }
                } else {
                    popup.style.display = 'none';
                }
            });
            commentInput.addEventListener('blur', () => { setTimeout(() => { popup.style.display = 'none'; }, 200); });
        }
    });
}
// â–²â–²â–² æ­¥é©Ÿ3.1æ›¿æ›çµæŸ â–²â–²â–²
async function renderFollowingFeed() {
    const feedListEl = document.getElementById('weibo-following-feed-list');
    if (!feedListEl) return;

    // 1. å¾è³‡æ–™åº«ç²å–æ‰€æœ‰å‹•æ…‹
    const allPosts = await db.qzonePosts.orderBy('timestamp').reverse().toArray();
    
    // 2. ã€æ ¸å¿ƒã€‘ç¯©é¸å‡ºä½œè€…ä¸æ˜¯ 'user' çš„å‹•æ…‹
    const followingPosts = allPosts.filter(post => post.authorId !== 'user');

    feedListEl.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

    if (followingPosts.length === 0) {
        feedListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">ä½ é—œæ³¨çš„äººé‚„æ²’æœ‰ç™¼ä½ˆä»»ä½•å‹•æ…‹å“¦ã€‚</p>';
        return;
    }

    // 3. éæ­·ç¯©é¸å¾Œçš„å‹•æ…‹ï¼Œä¸¦æ¸²æŸ“å®ƒå€‘
    //    ã€æç¤ºã€‘é€™è£¡å‰µå»ºå–®å€‹å‹•æ…‹HTMLçš„é‚è¼¯ï¼Œå¯ä»¥å®Œå…¨è¤‡è£½ `renderQzonePosts` å‡½æ•¸è£¡çš„ forEach è¿´åœˆå…§éƒ¨çš„ä»£ç¢¼ã€‚
    //    ä½ åªéœ€è¦æŠŠç›®æ¨™å®¹å™¨å¾ `postsListEl` æ”¹ç‚º `feedListEl` å³å¯ã€‚
    followingPosts.forEach(post => {
        // ... åœ¨é€™è£¡é»è²¼ renderQzonePosts å‡½æ•¸ä¸­å‰µå»º postContainerã€postEl çš„é‚£ä¸€å¤§æ®µä»£ç¢¼ ...
        // ... è¨˜å¾—æœ€å¾Œè¦æŠŠ postContainer append åˆ° feedListEl ä¸­ ...
        // feedListEl.appendChild(postContainer);
    });
}

// â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™å€‹ã€æ›´æ–°å¾Œçš„ã€‘å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ ä»£ç¢¼ä¸­èˆŠçš„ displayFilteredFavorites å‡½æ•¸ â–¼â–¼â–¼

function displayFilteredFavorites(items) {
    const listEl = document.getElementById('favorites-list');
    listEl.innerHTML = '';

    if (items.length === 0) {
        const searchTerm = document.getElementById('favorites-search-input').value;
        const message = searchTerm ? 'æœªæ‰¾åˆ°ç›¸é—œæ”¶è—' : 'ä½ çš„æˆ‘çš„æœ€æ„›æ˜¯ç©ºçš„ï¼Œ<br>å¿«å»å‹•æ…‹æˆ–èŠå¤©ä¸­æ”¶è—å–œæ­¡çš„å…§å®¹å§ï¼';
        listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
        return;
    }

    for (const item of items) {
        const card = document.createElement('div');
        card.className = 'favorite-item-card';
        card.dataset.favid = item.id;

        let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';

        if (item.type === 'qzone_post') {
            const post = item.content;
            sourceText = 'ä¾†è‡ªå‹•æ…‹';
            let authorAvatar = defaultAvatar, authorNickname = 'æœªçŸ¥ç”¨æˆ¶';

            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                authorNickname = state.chats[post.authorId].name;
            }

            headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
            
            const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
            if (post.type === 'shuoshuo') {
                contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
            } else if (post.type === 'image_post' && post.imageUrl) {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
            } else if (post.type === 'text_image') {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
            }

            // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„ä»£ç¢¼é–‹å§‹ â–¼â–¼â–¼
            
            // 1. æ§‹é€ é»è´Šå€åŸŸçš„HTML
            let likesHtml = '';
            // æª¢æŸ¥ post ç‰©ä»¶ä¸­æ˜¯å¦å­˜åœ¨ likes é™£åˆ—ä¸¦ä¸”ä¸ç‚ºç©º
            if (post.likes && post.likes.length > 0) {
                // å¦‚æœå­˜åœ¨ï¼Œå°±å‰µå»ºé»è´Šå€åŸŸçš„ div
                likesHtml = `
                    <div class="post-likes-section">
                        <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span>${post.likes.join('ã€')} è¦ºå¾—å¾ˆè´Š</span>
                    </div>`;
            }

            // 2. æ§‹é€ è©•è«–å€åŸŸçš„HTML
            let commentsHtml = '';
            // æª¢æŸ¥ post ç‰©ä»¶ä¸­æ˜¯å¦å­˜åœ¨ comments é™£åˆ—ä¸¦ä¸”ä¸ç‚ºç©º
            if (post.comments && post.comments.length > 0) {
                // å¦‚æœå­˜åœ¨ï¼Œå°±å‰µå»ºè©•è«–å®¹å™¨ï¼Œä¸¦éæ­·æ¯ä¸€æ¢è©•è«–
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach(comment => {
                    commentsHtml += `
                        <div class="comment-item">
                            <span class="commenter-name">${comment.commenterName}:</span>
                            <span class="comment-text">${comment.text}</span>
                        </div>`;
                });
                commentsHtml += '</div>';
            }

            // 3. å°‡é»è´Šå’Œè©•è«–çš„HTMLçµ„åˆåˆ° footerHtml ä¸­
            footerHtml = `${likesHtml}${commentsHtml}`;
            
            // â–²â–²â–² æ–°å¢/ä¿®æ”¹çš„ä»£ç¢¼çµæŸ â–²â–²â–²

} else if (item.type === 'chat_message') {
    const msg = item.content;
    const chat = state.chats[item.chatId];
    if (!chat) continue; 

    sourceText = `ä¾†è‡ªèˆ‡ ${chat.name} çš„èŠå¤©`;
    const isUser = msg.role === 'user';
    let senderName, senderAvatar;

    if (isUser) {
        // ä½¿ç”¨è€…æ¶ˆæ¯çš„é‚è¼¯ä¿æŒä¸è®Š
        senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
        senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
    } else { // AI/æˆå“¡æ¶ˆæ¯

         if (chat.isGroup) {
            // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯å”¯ä¸€çš„ã€æ ¸å¿ƒçš„ä¿®æ”¹ï¼ â˜…â˜…â˜…â˜…â˜…
            // æˆ‘å€‘ç¾åœ¨ä½¿ç”¨ originalName å»åŒ¹é…ï¼Œè€Œä¸æ˜¯èˆŠçš„ name
            const member = chat.members.find(m => m.originalName === msg.senderName);
            // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹çµæŸ â˜…â˜…â˜…â˜…â˜…
            
            senderName = msg.senderName;
            // å› ç‚ºç¾åœ¨èƒ½æ­£ç¢ºæ‰¾åˆ° member ç‰©ä»¶äº†ï¼Œæ‰€ä»¥ä¹Ÿèƒ½æ­£ç¢ºç²å–åˆ°ä»–çš„é ­åƒ
            senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
        } else {
            // å–®èŠçš„é‚è¼¯ä¿æŒä¸è®Š
            senderName = chat.name;
            senderAvatar = chat.settings.aiAvatar || defaultAvatar;
        }
    }

    // å¾ŒçºŒæ‹¼æ¥ headerHtml å’Œ contentHtml çš„é‚è¼¯éƒ½ä¿æŒä¸è®Š
    headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
    
    if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
// â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šæ–°ä»£ç¢¼ã€‘æ›¿æ›æ‰ä¸Šé¢é‚£æ®µèˆŠçš„ else { ... } ä»£ç¢¼å¡Š â–¼â–¼â–¼
// â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šæ–°ä»£ç¢¼ã€‘å†æ¬¡æ›¿æ›æ‰ createMessageElement å‡½æ•¸è£¡çš„ else { ... } ä»£ç¢¼å¡Š â–¼â–¼â–¼
} else {
    const messageText = String(msg.content || '');
    // åµæ¸¬æ ¼å¼ï¼š[sticker:åå­—]
    const stickerMatch = messageText.match(/\[sticker:\s*(.+?)\s*\]/i);

    if (stickerMatch) {
        // å¦‚æœåŒ¹é…æˆåŠŸï¼Œæå–å‡ºåå­—
        const stickerName = stickerMatch[1].trim();
        // ã€æ ¸å¿ƒã€‘åœ¨æ‰€æœ‰å¯èƒ½çš„è¡¨æƒ…åº«è£¡æŸ¥æ‰¾ï¼ˆç”¨æˆ¶çš„ã€è§’è‰²çš„å°ˆå±¬ã€è§’è‰²çš„é€šç”¨ï¼‰
        const allStickers = [...state.userStickers, ...state.charStickers, ...(chat.settings.stickerLibrary || [])];
        const foundSticker = allStickers.find(s => s.name === stickerName);
        
        if (foundSticker) {
            // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±é¡¯ç¤ºåœ–ç‰‡ï¼
            bubble.classList.add('is-sticker');
            contentHtml = `<img src="${foundSticker.url}" alt="${foundSticker.name}" class="sticker-image">`;
        } else {
            // å¦‚æœæ²’æ‰¾åˆ°ï¼ˆæ¯”å¦‚AIè‡ªå·±ç·¨äº†å€‹åå­—ï¼‰ï¼Œå°±é‚„æ˜¯æŒ‰æ™®é€šæ–‡å­—é¡¯ç¤º
            contentHtml = messageText.replace(/\n/g, '<br>');
        }
    } else {
        // å¦‚æœä¸åŒ¹é…ï¼Œå°±æ˜¯æ™®é€šçš„æ–‡æœ¬æ¶ˆæ¯
        contentHtml = messageText.replace(/\n/g, '<br>');
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


}
        
        // â–¼â–¼â–¼ ä¿®æ”¹æœ€çµ‚çš„HTMLæ‹¼æ¥ï¼ŒåŠ å…¥ footerHtml â–¼â–¼â–¼
        card.innerHTML = `
            <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
            <div class="fav-card-content">${contentHtml}</div>
            ${footerHtml}`; // <-- æŠŠæˆ‘å€‘æ–°å‰µå»ºçš„ footerHtml æ”¾åœ¨é€™è£¡
            
        listEl.appendChild(card);
    }
}

// â–²â–²â–² æ›¿æ›å€åŸŸçµæŸ â–²â–²â–²

        /**
         * ã€é‡æ§‹å¾Œçš„å‡½æ•¸ã€‘: è² è²¬æº–å‚™è³‡æ–™ä¸¦è§¸ç™¼æ¸²æŸ“
         */
        async function renderFavoritesScreen() {
            // 1. å¾è³‡æ–™åº«ç²å–æœ€æ–°è³‡æ–™ä¸¦ç·©å­˜
            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
            
            // 2. æ¸…ç©ºæœç´¢æ¡†ä¸¦éš±è—æ¸…é™¤æŒ‰éˆ•
            const searchInput = document.getElementById('favorites-search-input');
            const clearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';

            // 3. é¡¯ç¤ºæ‰€æœ‰æ”¶è—é …
            displayFilteredFavorites(allFavoriteItems);
        }

        // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

function resetCreatePostModal() {
    document.getElementById('post-public-text').value = '';
    document.getElementById('post-image-preview').src = '';
    document.getElementById('post-image-description').value = '';
    document.getElementById('post-image-preview-container').classList.remove('visible');
    document.getElementById('post-image-desc-group').style.display = 'none';
    document.getElementById('post-local-image-input').value = '';
    document.getElementById('post-hidden-text').value = '';

    // ã€æ ¸å¿ƒä¿®å¾©ã€‘æˆ‘å€‘ä¸å†æ¨¡æ“¬é»æ“Šï¼Œè€Œæ˜¯ç›´æ¥ã€å®‰å…¨åœ°è¨­ç½®ç‹€æ…‹
    const imageModeBtn = document.getElementById('switch-to-image-mode');
    const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
    const imageModeContent = document.getElementById('image-mode-content');
    const textImageModeContent = document.getElementById('text-image-mode-content');
    
    imageModeBtn.classList.add('active');
    textImageModeBtn.classList.remove('active');
    imageModeContent.classList.add('active');
    textImageModeContent.classList.remove('active');
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²ä¿®å¾©ã€‘çš„ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ exportBackup å‡½æ•¸ â–¼â–¼â–¼
async function exportBackup() {
    try {
        const backupData = {
            version: 1, 
            timestamp: Date.now()
        };

        // --- é€™éƒ¨åˆ†è³‡æ–™åº«è®€å–çš„ä»£ç¢¼ä¿æŒä¸è®Š ---
        const [
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups, memories,
            worldBookCategories, callRecords, customAvatarFrames, themes,
            apiPresets, bubbleStylePresets, fontPresets, homeScreenPresets
        ] = await Promise.all([
            db.chats.toArray(),
            db.worldBooks.toArray(),
            db.userStickers.toArray(),
            db.apiConfig.get('main'),
            db.globalSettings.get('main'),
            db.personaPresets.toArray(),
            db.musicLibrary.get('main'),
            db.qzoneSettings.get('main'),
            db.qzonePosts.toArray(),
            db.qzoneAlbums.toArray(),
            db.qzonePhotos.toArray(),
            db.favorites.toArray(),
            db.qzoneGroups.toArray(),
            db.memories.toArray(),
            db.worldBookCategories.toArray(),
            db.callRecords.toArray(),
            db.customAvatarFrames.toArray(),
            db.themes.toArray(),
            db.apiPresets.toArray(),
            db.bubbleStylePresets.toArray(),
            db.fontPresets.toArray(),
            db.homeScreenPresets.toArray()
        ]);

        Object.assign(backupData, {
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups, memories,
            worldBookCategories, callRecords, customAvatarFrames, themes,
            apiPresets, bubbleStylePresets, fontPresets, homeScreenPresets
        });
        
        // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ï¼â–¼â–¼â–¼ ---
        // æˆ‘å€‘é‡æ§‹äº† homeScreenState ç‰©ä»¶ï¼Œç¢ºä¿å®ƒèƒ½åŒ…å«ç¬¬ä¸€é çš„æ‰€æœ‰è³‡æ–™
        backupData.homeScreenState = {
            // --- é€™æ˜¯æˆ‘å€‘æ–°å¢çš„ç¬¬ä¸€é æ•¸æ“š ---
            'profile-banner-img': document.getElementById('profile-banner-img').src,
            'profile-avatar-img': document.getElementById('profile-avatar-img').src,
            'profile-username': document.getElementById('profile-username').textContent,
            'profile-sub-username': document.getElementById('profile-sub-username').textContent,
            'profile-bio': document.getElementById('profile-bio').textContent,
            'profile-location': document.getElementById('profile-location').innerHTML, // ä½¿ç”¨innerHTMLä¾†ä¿å­˜SVGåœ–ç¤º
            'widget-bubble-1': document.getElementById('widget-bubble-1').textContent,
            'widget-image-1': document.getElementById('widget-image-1').src, // é€™æ˜¯ä½ ç‰¹åˆ¥æåˆ°çš„çµ„ä»¶
            'widget-subtext-1': document.getElementById('widget-subtext-1').textContent,
            'widget-bubble-2': document.getElementById('widget-bubble-2').textContent,
            'widget-image-2': document.getElementById('widget-image-2').src,
            'widget-subtext-2': document.getElementById('widget-subtext-2').textContent,
            'widget-image-3': document.getElementById('widget-image-3').src,
            'second-page-bubble': document.getElementById('second-page-bubble').textContent,
            'flat-capsule-bubble': document.getElementById('flat-capsule-bubble').textContent,
            'circular-bubble': document.getElementById('circular-bubble').textContent,
            'widget-image-4': document.getElementById('widget-image-4').src,
            'avatar-subtitle': document.getElementById('avatar-subtitle').textContent,
            'bubble-top-left': document.getElementById('bubble-top-left').textContent,
            'bubble-top-right': document.getElementById('bubble-top-right').textContent,
            'bubble-bottom-left': document.getElementById('bubble-bottom-left').textContent,
            'bubble-bottom-right': document.getElementById('bubble-bottom-right').textContent,
            'new-widget-avatar': document.getElementById('new-widget-avatar').src,
            'new-widget-text-1': document.getElementById('new-widget-text-1').textContent,
            'new-widget-text-2': document.getElementById('new-widget-text-2').textContent,
            'new-widget-text-3': document.getElementById('new-widget-text-3').textContent,
            'widget-month-display': document.getElementById('widget-month-display').textContent,
            'appIcons': { ...state.globalSettings.appIcons },
            'lockscreenWallpaper': state.globalSettings.lockscreenWallpaper,
            'wallpaper': state.globalSettings.wallpaper
        };
        // --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² ---

        // å¾ŒçºŒçš„ä¸‹è¼‰é‚è¼¯ä¿æŒä¸è®Š
        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        const url = URL.createObjectURL(blob);
        const link = Object.assign(document.createElement('a'), {
            href: url,
            download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
        });
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        await showCustomAlert('åŒ¯å‡ºæˆåŠŸ', 'å·²æˆåŠŸåŒ¯å‡ºæ‰€æœ‰è³‡æ–™ï¼');

    } catch (error) {
        console.error("åŒ¯å‡ºè³‡æ–™æ™‚å‡ºéŒ¯:", error);
        await showCustomAlert('åŒ¯å‡ºå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤: ${error.message}`);
    }
}




// â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šçµ‚æ¥µä¿®å¾©ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ importBackup å‡½æ•¸ â–¼â–¼â–¼
async function importBackup(file) {
    if (!file) return;

    const confirmed = await showCustomConfirm(
        'åš´é‡è­¦å‘Šï¼',
        'å°å…¥å‚™ä»½å°‡å®Œå…¨è¦†è“‹æ‚¨ç•¶å‰çš„æ‰€æœ‰è³‡æ–™ï¼ŒåŒ…æ‹¬èŠå¤©ã€è¨­ç½®ç­‰ã€‚æ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼æ‚¨ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        await db.transaction('rw', db.tables, async () => {
            // 1. æ¸…ç©ºæ‰€æœ‰ç¾æœ‰è¡¨æ ¼
            for (const table of db.tables) {
                await table.clear();
            }

            // 2. ã€æ ¸å¿ƒä¿®å¾©ã€‘æ™ºæ…§ã€å®‰å…¨åœ°å°å…¥è³‡æ–™
            // æˆ‘å€‘æœƒæª¢æŸ¥å‚™ä»½æª”æ¡ˆä¸­çš„æ¯ä¸€é …è³‡æ–™ï¼Œåªæœ‰ç•¶ç•¶å‰ä»£ç¢¼çš„è³‡æ–™åº«è£¡ä¹Ÿå­˜åœ¨å°æ‡‰çš„è¡¨æ ¼æ™‚ï¼Œæ‰é€²è¡Œå°å…¥
            
            // å°å…¥é™£åˆ—é¡å‹çš„è³‡æ–™
            const arrayTables = [
                'chats', 'worldBooks', 'worldBookCategories', 'userStickers', 
                'personaPresets', 'qzonePosts', 'qzoneAlbums', 'qzonePhotos', 
                'favorites', 'qzoneGroups', 'memories', 'callRecords', 
                'customAvatarFrames', 'themes', 'apiPresets', 'bubbleStylePresets',
                // å°±ç®—å‚™ä»½æª”æ¡ˆè£¡æœ‰ä¸‹é¢é€™äº›æ–°ç‰ˆæ‰æœ‰çš„è³‡æ–™ï¼Œé€™æ®µä»£ç¢¼ä¹Ÿèƒ½å®‰å…¨è·³é
                'fontPresets', 'homeScreenPresets' 
            ];

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œæ›¸æ ¼å¼ç›¸å®¹è½‰æ›ä»£ç¢¼ â–¼â–¼â–¼
for (const tableName of arrayTables) {
    if (Array.isArray(data[tableName]) && db[tableName]) {
        let itemsToPut = data[tableName];

        // ã€æ ¸å¿ƒé‚è¼¯ã€‘ç•¶è™•ç†ä¸–ç•Œæ›¸è¡¨æ ¼æ™‚ï¼ŒåŸ·è¡Œç‰¹åˆ¥çš„è½‰æ›æ“ä½œ
        if (tableName === 'worldBooks') {
            console.log("æ­£åœ¨æª¢æŸ¥ä¸¦è½‰æ›ä¸–ç•Œæ›¸è³‡æ–™æ ¼å¼ä»¥ç›¸å®¹...");
            itemsToPut.forEach(book => {
                // å¦‚æœ content æ˜¯é™£åˆ— (åˆ¥äººçš„æ ¼å¼)ï¼Œå‰‡å°‡å…¶è½‰æ›ç‚ºå­—ä¸² (æˆ‘çš„æ ¼å¼)
                if (Array.isArray(book.content)) {
                    console.log(`æª¢æ¸¬åˆ°é™£åˆ—æ ¼å¼çš„ä¸–ç•Œæ›¸: "${book.name}"ï¼Œæ­£åœ¨è½‰æ›ç‚ºå­—ä¸²...`);
                    
                    // å°‡é™£åˆ—ä¸­çš„æ¯å€‹æ¢ç›®ç‰©ä»¶è½‰æ›ç‚ºæ ¼å¼åŒ–çš„å­—ä¸²
                    const convertedEntries = book.content.map(entry => {
                        const stringParts = [];
                        if (entry.comment) {
                            stringParts.push(`[å‚™è¨»: ${entry.comment}]`);
                        }
                        if (entry.keys && entry.keys.length > 0) {
                            stringParts.push(`[é—œéµå­—: ${entry.keys.join(', ')}]`);
                        }
                        stringParts.push(entry.content); // æ¢ç›®ä¸»è¦å…§å®¹
                        return stringParts.join('\n'); // æ¯å€‹æ¢ç›®çš„å…§éƒ¨ç”¨æ›è¡Œåˆ†éš”
                    });
                    
                    // å°‡æ‰€æœ‰è½‰æ›å¾Œçš„æ¢ç›®å­—ä¸²ç”¨ä¸€å€‹æ˜é¡¯çš„åˆ†éš”ç¬¦è™Ÿé€£æ¥èµ·ä¾†
                    book.content = convertedEntries.join('\n\n---\n\n');
                }
            });
        }
        
        // éæ¿¾ä¸¦ä¿å­˜è³‡æ–™ (é€™éƒ¨åˆ†é‚è¼¯ä¿æŒä¸è®Š)
        const validItems = itemsToPut.filter(item => item && (typeof item.id === 'undefined' || typeof item.id === 'string' || typeof item.id === 'number'));
        if (validItems.length > 0) {
            console.log(`æ­£åœ¨å°å…¥ ${validItems.length} æ¢è³‡æ–™åˆ°è¡¨æ ¼: ${tableName}...`);
            await db[tableName].bulkPut(validItems);
        }

    } else {
        console.log(`è·³éå°å…¥: ${tableName} (åœ¨å‚™ä»½æª”æ¡ˆæˆ–ç•¶å‰è³‡æ–™åº«ä¸­ä¸å­˜åœ¨)`);
    }
}
// â–²â–²â–² ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

            
            // å°å…¥ç‰©ä»¶é¡å‹çš„è³‡æ–™ï¼ˆé€šå¸¸æ˜¯è¨­ç½®ï¼‰
            const objectTables = ['apiConfig', 'globalSettings', 'musicLibrary', 'qzoneSettings'];
            for (const tableName of objectTables) {
                if (data[tableName] && db[tableName]) {
                    console.log(`æ­£åœ¨å°å…¥è¨­ç½®: ${tableName}...`);
                    await db[tableName].put(data[tableName]);
                }
            }
        });

        // å°å…¥ä¸»è¢å¹•æ¨£å¼çš„é‚è¼¯ä¿æŒä¸è®Šï¼Œå› ç‚ºå®ƒä¸ç›´æ¥æ“ä½œè³‡æ–™åº«çš„å¤šå€‹è¡¨
        if (data.homeScreenState) {
            const settings = await db.globalSettings.get('main') || { id: 'main' };
            settings.widgetData = data.homeScreenState;
            if (data.homeScreenState.wallpaper) settings.wallpaper = data.homeScreenState.wallpaper;
            if (data.homeScreenState.lockscreenWallpaper) settings.lockscreenWallpaper = data.homeScreenState.lockscreenWallpaper;
            if (data.homeScreenState.appIcons) settings.appIcons = data.homeScreenState.appIcons;
            await db.globalSettings.put(settings);
            console.log("å·²æˆåŠŸå°å…¥ä¸»è¢å¹•æ¨£å¼è³‡æ–™ã€‚");
        }


        await showCustomAlert('å°å…¥æˆåŠŸ', 'æ‰€æœ‰è³‡æ–™å·²æˆåŠŸæ¢å¾©ï¼æ‡‰ç”¨å³å°‡åˆ·æ–°ä»¥æ‡‰ç”¨æ‰€æœ‰æ›´æ”¹ã€‚');
        
        setTimeout(() => {
            window.location.reload();
        }, 1500);

    } catch (error) {
        console.error("å°å…¥è³‡æ–™æ™‚å‡ºéŒ¯:", error);
        await showCustomAlert('å°å…¥å¤±æ•—', `æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºæˆ–è³‡æ–™å·²æå£: ${error.message}`);
    }
}

function applyCustomFont(fontUrl, isPreviewOnly = false) {
    if (!fontUrl) {
        // å¦‚æœæ²’æœ‰æä¾›å­—é«”é€£çµï¼ˆæ¯”å¦‚æ¢å¾©é è¨­ï¼‰ï¼Œå°±æ¸…ç©ºæ¨£å¼
        dynamicFontStyle.innerHTML = '';
        document.getElementById('font-preview').style.fontFamily = '';
        return;
    }

    // é€™æ˜¯ä¸€å€‹çµ±ä¸€çš„å…§éƒ¨åå­—
    const fontName = 'custom-user-font';
    
    // é€™æ˜¯å®šç¾©å­—é«”çš„æ¨£å¼è¦å‰‡
    const newStyle = `
        @font-face {
          font-family: '${fontName}';
          src: url('${fontUrl}');
          font-display: swap;
        }`;

    if (isPreviewOnly) {
        // å¦‚æœåªæ˜¯é è¦½ï¼Œé€™å€‹é‚è¼¯ä¿æŒä¸è®Š
        const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
        previewStyle.id = 'preview-font-style';
        previewStyle.innerHTML = newStyle;
        if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
        document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
    } else {
        // ã€æ ¸å¿ƒã€‘å¦‚æœæ˜¯å…¨åŸŸæ‡‰ç”¨ï¼Œå°±åŒæ™‚å®šç¾©å­—é«”ä¸¦å‘Šè¨´æ•´å€‹ body å»ä½¿ç”¨å®ƒ
        dynamicFontStyle.innerHTML = `
            ${newStyle}
            body {
              font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
            }`;
    }
}


        async function resetToDefaultFont() {
            // 1. æ¸…é™¤å…¨åŸŸå­—é«”æ¨£å¼
            dynamicFontStyle.innerHTML = ''; 
            
            // 2. æ›´æ–°ä¸¦ä¿å­˜è¨­ç½®
            state.globalSettings.fontUrl = '';
            await db.globalSettings.put(state.globalSettings);
            
            // 3. ã€æ ¸å¿ƒä¿®å¾©ã€‘æ˜ç¢ºåœ°å°‡å…¨åŸŸé è¦½å€çš„å­—é«”ä¹Ÿæ¢å¾©ç‚ºé è¨­
            const globalPreview = document.getElementById('font-preview');
            globalPreview.style.fontFamily = ''; // ç§»é™¤å…§è¯æ¨£å¼
            
            // 4. æ‡‰ç”¨ä¸€ä¸‹ç©ºçš„å­—é«”è¨­ç½®ï¼Œç¢ºä¿æ‰€æœ‰åœ°æ–¹éƒ½æ¢å¾©
            applyCustomFont('', true);
            
            alert('å·²æ¢å¾©é è¨­å­—é«”ã€‚');
        }



async function loadAllDataFromDB() {
    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ã€‘ â–¼â–¼â–¼
    const [
        chatsArr,
        apiConfig,
        globalSettings,
        userStickers,
        charStickers,
        worldBooks,
        musicLib,
        personaPresets,
        qzoneSettings,
        initialFavorites,
    apiPresets,
bubbleStylePresets
] = await Promise.all([
        db.chats.toArray(),
        db.apiConfig.get('main'),
        db.globalSettings.get('main'),
        db.userStickers.toArray(),
        db.charStickers.toArray(),
        db.worldBooks.toArray(),
        db.musicLibrary.get('main'),
        db.personaPresets.toArray(),
        db.qzoneSettings.get('main'),
        db.favorites.orderBy('timestamp').reverse().toArray(),
    db.apiPresets.toArray(),    db.bubbleStylePresets.toArray()
]);
    // â–²â–²â–² ã€ä¿®æ”¹çµæŸã€‘ â–²â–²â–²

    state.chats = chatsArr.reduce((acc, chat) => {
            // ã€å…¨æ–°ã€‘ç‚ºèˆŠçš„ç¾¤èŠè³‡æ–™ç›¸å®¹å°ˆå±¬è¡¨æƒ…åº«
        if (chat.isGroup && (!chat.settings || !chat.settings.stickerLibrary)) {
            if (!chat.settings) chat.settings = {}; // ä»¥é˜²è¬ä¸€é€£settingséƒ½æ²’æœ‰
            chat.settings.stickerLibrary = [];
            console.log(`ç‚ºèˆŠç¾¤èŠ "${chat.name}" è£œå…¨äº†å°ˆå±¬è¡¨æƒ…åº«(stickerLibrary)å±¬æ€§ã€‚`);
        }
            // ç›¸å®¹èˆŠè³‡æ–™ï¼šç‚ºæ²’æœ‰å°ˆå±¬è¡¨æƒ…åº«çš„è§’è‰²æ·»åŠ ä¸€å€‹ç©ºçš„è¡¨æƒ…åº«
        if (!chat.isGroup && (!chat.settings || !chat.settings.stickerLibrary)) {
            if (!chat.settings) chat.settings = {}; // ä»¥é˜²è¬ä¸€é€£settingséƒ½æ²’æœ‰
            chat.settings.stickerLibrary = [];
            console.log(`ç‚ºèˆŠè§’è‰² "${chat.name}" è£œå…¨äº†å°ˆå±¬è¡¨æƒ…åº«(stickerLibrary)å±¬æ€§ã€‚`);
        }
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    if (typeof chat.unreadCount === 'undefined') {
        chat.unreadCount = 0; // å¦‚æœé€™å€‹èŠå¤©ç‰©ä»¶æ²’æœ‰ unreadCount å±¬æ€§ï¼Œå°±çµ¦å®ƒåˆå§‹åŒ–ç‚º 0
    }
    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„â€œè³‡æ–™ç§»è½‰â€ä»£ç¢¼ â–¼â–¼â–¼

        // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ§‹ï¼šè³‡æ–™ç§»è½‰è…³æœ¬ã€‘â˜…â˜…â˜…
        // æª¢æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠï¼Œä¸¦ä¸”å…¶æˆå“¡ç‰©ä»¶ä½¿ç”¨çš„æ˜¯èˆŠçš„ `name` çµæ§‹
        if (chat.isGroup && chat.members && chat.members.length > 0 && chat.members[0].name) {
            console.log(`æª¢æ¸¬åˆ°èˆŠç‰ˆç¾¤èŠè³‡æ–™ for "${chat.name}"ï¼Œæ­£åœ¨åŸ·è¡Œé·ç§»...`);
            chat.members.forEach(member => {
                // å¦‚æœé€™å€‹æˆå“¡ç‰©ä»¶æ²’æœ‰ originalNameï¼Œèªªæ˜æ˜¯èˆŠè³‡æ–™
                if (typeof member.originalName === 'undefined') {
                    member.originalName = member.name; // å°‡èˆŠçš„ name ä½œç‚º originalName
                    member.groupNickname = member.name; // åŒæ™‚å‰µå»ºä¸€å€‹åˆå§‹çš„ groupNickname
                    delete member.name; // åˆªé™¤èˆŠçš„ã€æœ‰æ­§ç¾©çš„ name æ¬„ä½
                    needsUpdate = true; // æ¨™è¨˜éœ€è¦å­˜å›è³‡æ–™åº«
                }
            });
             console.log(`é·ç§»å®Œæˆ for "${chat.name}"`);
        }

        // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ â–¼â–¼â–¼ ---
        // æª¢æŸ¥1ï¼šå¦‚æœæ˜¯ä¸€å€‹å–®èŠï¼Œä¸¦ä¸”æ²’æœ‰ status å±¬æ€§
        if (!chat.isGroup && !chat.status) {
            // å°±ç‚ºå®ƒè£œä¸Šä¸€å€‹é è¨­çš„ status ç‰©ä»¶
            chat.status = {
                text: 'ç·šä¸Š',
                lastUpdate: Date.now(),
                isBusy: false
            };
            console.log(`ç‚ºèˆŠè§’è‰² "${chat.name}" è£œå…¨äº†statuså±¬æ€§ã€‚`);
        }
        // --- â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

        // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ â–¼â–¼â–¼ ---
        // æª¢æŸ¥2ï¼šç›¸å®¹æœ€æ–°çš„â€œé—œä¿‚â€åŠŸèƒ½
        if (!chat.isGroup && !chat.relationship) {
            // å¦‚æœæ˜¯å–®èŠï¼Œä¸”æ²’æœ‰ relationship ç‰©ä»¶ï¼Œå°±è£œä¸Šä¸€å€‹é»˜èªçš„
            chat.relationship = {
                status: 'friend',
                blockedTimestamp: null,
                applicationReason: ''
            };
            console.log(`ç‚ºèˆŠè§’è‰² "${chat.name}" è£œå…¨äº† relationship å±¬æ€§ã€‚`);
        }
        // --- â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ  â–¼â–¼â–¼
    if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
        if (!chat.settings) chat.settings = {}; // ä»¥é˜²è¬ä¸€é€£settingséƒ½æ²’æœ‰
        chat.settings.aiAvatarLibrary = [];
        console.log(`ç‚ºèˆŠè§’è‰² "${chat.name}" è£œå…¨äº†aiAvatarLibraryå±¬æ€§ã€‚`);
    }
    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
// ç›¸å®¹èˆŠè³‡æ–™ï¼šç‚ºæ²’æœ‰ç¸½çµè¨­ç½®çš„èŠå¤©æ·»åŠ é è¨­å€¼
if (!chat.settings.summary) {
    chat.settings.summary = {
        enabled: false,
        mode: 'auto',
        count: 20,
        prompt: 'è«‹ä½ ä»¥ç¬¬ä¸‰äººç¨±çš„è¦–è§’ï¼Œå®¢è§€ã€å†·éœã€ä¸å¸¶ä»»ä½•æ„Ÿæƒ…è‰²å½©åœ°ç¸½çµä»¥ä¸‹å°è©±çš„æ ¸å¿ƒäº‹ä»¶å’Œè³‡è¨Šã€‚ç¦æ­¢é€²è¡Œä»»ä½•è§’è‰²æ‰®æ¼”æˆ–æ·»åŠ ä¸»è§€è©•è«–ã€‚',
        lastSummaryIndex: -1 // -1è¡¨ç¤ºå¾æœªç¸½çµé
    };
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

    // ç›¸å®¹èˆŠè³‡æ–™ï¼šç‚ºæ²’æœ‰NPCåº«çš„å–®èŠè§’è‰²æ·»åŠ ç©ºçš„NPCåº«
    if (!chat.isGroup && !chat.npcLibrary) {
        chat.npcLibrary = [];
        console.log(`ç‚ºèˆŠè§’è‰² "${chat.name}" è£œå…¨äº† npcLibrary å±¬æ€§ã€‚`);
    }
    // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
// ç›¸å®¹èˆŠè³‡æ–™ï¼šç‚ºæ²’æœ‰å¾®åšè¨­ç½®çš„å–®èŠè§’è‰²æ·»åŠ ç©ºçš„å¾®åšè¨­ç½®
if (!chat.isGroup && (!chat.settings.weiboProfession || typeof chat.settings.weiboInstruction === 'undefined')) {
    chat.settings.weiboProfession = '';
    chat.settings.weiboInstruction = '';
    console.log(`ç‚ºèˆŠè§’è‰² "${chat.name}" è£œå…¨äº†å¾®åšè¨­ç½®å±¬æ€§ã€‚`);
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
            chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
            delete chat.settings.linkedWorldBookId;
        }

    // ç›¸å®¹èˆŠè³‡æ–™ï¼Œç‚ºæ²’æœ‰ isPinned å±¬æ€§çš„èŠå¤©æ·»åŠ é è¨­å€¼
    if (typeof chat.isPinned === 'undefined') {
        chat.isPinned = false;
    }

// â–¼â–¼â–¼ ã€V2æœ€çµ‚ä¿®å¾©ç‰ˆã€‘çµ±ä¸€ä¿®å¾©ä¸¦åˆå§‹åŒ–æ‰€æœ‰è§’è‰²çš„æ‰‹æ©Ÿè³‡æ–™ â–¼â–¼â–¼
if (!chat.isGroup) {
    // ç¬¬ä¸€æ­¥ï¼šç¢ºä¿æœ€å¤–å±¤çš„ characterPhoneData å°è±¡å­˜åœ¨
    if (!chat.characterPhoneData) {
        chat.characterPhoneData = {}; // å¦‚æœä¸å­˜åœ¨ï¼Œå°±å‰µå»ºä¸€å€‹ç©ºçš„
    }

    // ç¬¬äºŒæ­¥ï¼šé€ä¸€æª¢æŸ¥ä¸¦è£œå…¨æ‰€æœ‰APPçš„è³‡æ–™çµæ§‹
    // é€™æ¨£ç„¡è«–è§’è‰²å¤šè€ï¼Œéƒ½èƒ½ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å­˜åœ¨
    if (!chat.characterPhoneData.widgets) chat.characterPhoneData.widgets = {};
    if (!chat.characterPhoneData.lastGenerated) chat.characterPhoneData.lastGenerated = null;
    if (!chat.characterPhoneData.chats) chat.characterPhoneData.chats = {};
    if (!chat.characterPhoneData.shoppingCart) chat.characterPhoneData.shoppingCart = [];
    if (!chat.characterPhoneData.memos) chat.characterPhoneData.memos = [];
    if (!chat.characterPhoneData.browserHistory) chat.characterPhoneData.browserHistory = [];
    if (!chat.characterPhoneData.photoAlbum) chat.characterPhoneData.photoAlbum = [];
    if (!chat.characterPhoneData.bank) chat.characterPhoneData.bank = { balance: 0, transactions: [] };
    if (!chat.characterPhoneData.trajectory) chat.characterPhoneData.trajectory = [];
    if (!chat.characterPhoneData.appUsage) chat.characterPhoneData.appUsage = [];
    if (!chat.characterPhoneData.diary) chat.characterPhoneData.diary = []; // æ ¸å¿ƒä¿®å¾©ï¼
     if (!chat.characterPhoneData.appWallpaper) {
        chat.characterPhoneData.appWallpaper = '';
    }
}
// â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–²
// ç›¸å®¹èˆŠè³‡æ–™ï¼Œç‚ºæ²’æœ‰å¾Œè‡ºæ´»å‹•è¨­ç½®çš„ç¾¤èŠæ·»åŠ é è¨­å€¼
if (chat.isGroup && (!chat.settings || typeof chat.settings.backgroundActivity === 'undefined')) {
    if (!chat.settings) chat.settings = {}; // ä»¥é˜²è¬ä¸€é€£settingséƒ½æ²’æœ‰
    chat.settings.backgroundActivity = {
        enabled: false,
        interval: 120, // é»˜èª120ç§’
        lastActivityTimestamp: 0
    };
}
// â–¼â–¼â–¼ Part B: åœ¨é€™è£¡é»è²¼ç›¸å®¹èˆŠè³‡æ–™çš„ä»£ç¢¼ â–¼â–¼â–¼
// ç›¸å®¹èˆŠè³‡æ–™ï¼šç‚ºæ²’æœ‰æƒ…ä¾¶é ­åƒè¨­ç½®çš„è§’è‰²æ·»åŠ é è¨­å€¼
if (typeof chat.settings.isCoupleAvatar === 'undefined') {
    chat.settings.isCoupleAvatar = false;
    chat.settings.coupleAvatarDescription = '';
}
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€é ˜é¤Šç³»çµ±æ”¹é€ ã€‘å¯µç‰©ç³»çµ±åˆå§‹åŒ–/ç›¸å®¹ä»£ç¢¼ â–¼â–¼â–¼

// 1. ç‚ºæ‰€æœ‰è§’è‰²ï¼ˆåŒ…æ‹¬æ–°èˆŠè³‡æ–™ï¼‰ç¢ºä¿æœ‰ petAdopted æ¨™èªŒ
if (!chat.isGroup && typeof chat.settings.petAdopted === 'undefined') {
    // å¦‚æœ pet ç‰©ä»¶å·²å­˜åœ¨ï¼Œèªªæ˜æ˜¯è€ç”¨æˆ¶ï¼Œé»˜èªå·²é ˜é¤Š
    if (chat.settings.pet && chat.settings.pet.type !== 'ç„¡') {
        chat.settings.petAdopted = true;
    } else {
        // å¦‚æœæ²’æœ‰ pet ç‰©ä»¶ï¼Œèªªæ˜æ˜¯æ–°ä½¿ç”¨è€…æˆ–ä¹‹å‰å°±æ²’ç”¨å¯µç‰©ï¼Œé»˜èªæœªé ˜é¤Š
        chat.settings.petAdopted = false;
    }
    console.log(`ç‚ºè§’è‰² "${chat.name}" åˆå§‹åŒ–äº†å¯µç‰©é ˜é¤Šç‹€æ…‹: ${chat.settings.petAdopted}`);
}

// 2. ç›¸å®¹èˆŠçš„ pet ç‰©ä»¶ï¼Œç¢ºä¿æ–°æ¬„ä½å­˜åœ¨ï¼ˆé€™æ®µä»£ç¢¼å’Œä¹‹å‰ä¸€æ¨£ï¼Œä¿ç•™å³å¯ï¼‰
if (!chat.isGroup && chat.settings.pet) {
    if (typeof chat.settings.pet.persona === 'undefined') {
        chat.settings.pet.persona = 'ä¸€éš»å¯æ„›çš„å°å¯µç‰©ï¼Œå°ä¸–ç•Œå……æ»¿å¥½å¥‡ã€‚';
    }
    if (!chat.settings.pet.petChatHistory) {
        chat.settings.pet.petChatHistory = [];
    }
    if (!chat.settings.pet.status) {
        chat.settings.pet.status = { 
            hunger: 100, 
            happiness: 100, 
            intimacyToUser: 50, 
            intimacyToChar: 50,
            lastUpdated: Date.now()
        };
    } else {
        if (typeof chat.settings.pet.status.intimacyToUser === 'undefined') chat.settings.pet.status.intimacyToUser = 50;
        if (typeof chat.settings.pet.status.intimacyToChar === 'undefined') chat.settings.pet.status.intimacyToChar = 50;
        if (typeof chat.settings.pet.status.lastUpdated === 'undefined') chat.settings.pet.status.lastUpdated = Date.now();
    }
}
// â–²â–²â–² æ”¹é€ çµæŸ â–²â–²â–²
        // ç›¸å®¹èˆŠè³‡æ–™ï¼šç‚ºæ²’æœ‰è¨˜æ†¶äº’é€šè¨­ç½®çš„èŠå¤©æ·»åŠ ä¸€å€‹ç©ºçš„é™£åˆ—
        if (!chat.settings.linkedMemories) {
            chat.settings.linkedMemories = [];
        }
            // â–¼â–¼â–¼ åœ¨é€™è£¡æ–°å¢ä¸‹é¢é€™æ®µä»£ç¢¼ï¼Œä»¥ç›¸å®¹èˆŠè³‡æ–™ â–¼â–¼â–¼
    // ç‚ºèˆŠè³‡æ–™æ·»åŠ é è¨­çš„è¨˜æ†¶æ¢æ•¸è¨­ç½®
    if (typeof chat.settings.linkMemoryDepth === 'undefined') {
        chat.settings.linkMemoryDepth = 5;
    }
    // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
              // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
        // ç›¸å®¹ç·šä¸‹æ¨¡å¼è¨­ç½®
        if (!chat.settings.offlineMode) {
            chat.settings.offlineMode = {
                enabled: false,
                prompt: '',
                style: '',
                wordCount: 300,
                presets: []
            };
        }
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²  
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨é€™è£¡æ·»åŠ å°è§’è‰²æ‰‹æ©Ÿå¤–è§€è¨­ç½®çš„ç›¸å®¹ä»£ç¢¼ â–¼â–¼â–¼
        if (!chat.isGroup) { // åªç‚ºå–®èŠè§’è‰²æ·»åŠ 
            if (!chat.characterPhoneData) {
                chat.characterPhoneData = {}; // ä»¥é˜²è¬ä¸€é€£ characterPhoneData éƒ½æ²’æœ‰
            }
            if (!chat.characterPhoneData.wallpaper) {
                chat.characterPhoneData.wallpaper = ''; // åˆå§‹åŒ–å£ç´™ç‚ºç©º
            }
            if (!chat.characterPhoneData.appIcons) {
                chat.characterPhoneData.appIcons = {}; // åˆå§‹åŒ–Appåœ–ç¤ºç‚ºç©ºç‰©ä»¶
            }
        }
        // â–²â–²â–² ç›¸å®¹ä»£ç¢¼æ·»åŠ çµæŸ â–²â–²â–²
        // ã€å…¨æ–°ã€‘ç‚ºèˆŠè§’è‰²è³‡æ–™ç›¸å®¹å¾®åšç¨ç«‹è¨­ç½®
if (!chat.isGroup) {
    if (!chat.settings.weiboNickname) {
        chat.settings.weiboNickname = chat.name; // é»˜èªä½¿ç”¨è§’è‰²åä½œç‚ºå¾®åšæ˜µç¨±
    }
    if (!chat.settings.weiboAvatar) {
        chat.settings.weiboAvatar = chat.settings.aiAvatar; // é»˜èªä½¿ç”¨AIé ­åƒ
    }
    if (!chat.settings.weiboAvatarFrame) {
        chat.settings.weiboAvatarFrame = chat.settings.aiAvatarFrame || ''; // é»˜èªä½¿ç”¨AIé ­åƒæ¡†
    }
    if (!chat.settings.weiboBackground) {
        chat.settings.weiboBackground = 'https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg'; // çµ¦ä¸€å€‹é»˜èªèƒŒæ™¯
    }
    // weiboProfession å’Œ weiboInstruction ä¹‹å‰å·²ç¶“ç›¸å®¹éäº†ï¼Œé€™è£¡ä¸ç”¨é‡è¤‡
}
        // ç›¸å®¹èˆŠè³‡æ–™ï¼šç‚ºæ²’æœ‰å¾®åšè¨­ç½®çš„å–®èŠè§’è‰²æ·»åŠ ç©ºçš„å¾®åšè¨­ç½®
        if (!chat.isGroup && (!chat.settings.weiboProfession || typeof chat.settings.weiboInstruction === 'undefined')) {
            chat.settings.weiboProfession = '';
            chat.settings.weiboInstruction = '';
            console.log(`ç‚ºèˆŠè§’è‰² "${chat.name}" è£œå…¨äº†å¾®åšè¨­ç½®å±¬æ€§ã€‚`);
        }
        
        // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
        // ã€å…¨æ–°ã€‘ç‚ºèˆŠè§’è‰²è³‡æ–™ç›¸å®¹å¾®åšç²‰çµ²/é—œæ³¨æ•¸
        if (!chat.isGroup && (typeof chat.settings.weiboFansCount === 'undefined' || typeof chat.settings.weiboFollowingCount === 'undefined')) {
            const initialStats = getInitialWeiboStats(chat);
            chat.settings.weiboFansCount = initialStats.fans;
            chat.settings.weiboFollowingCount = initialStats.following;
            console.log(`ç‚ºèˆŠè§’è‰² "${chat.name}" åˆå§‹åŒ–äº†å¾®åšæ•¸æ“šã€‚`);
        }
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
    // â–¼â–¼â–¼ åœ¨é€™å€‹è¿´åœˆçš„æœ«å°¾ï¼Œacc[chat.id] = chat; ä¹‹å‰ï¼Œæ·»åŠ ä¸‹é¢é€™æ®µä»£ç¢¼ â–¼â–¼â–¼
    if (!chat.isGroup && (!chat.settings || typeof chat.settings.minimaxVoiceId === 'undefined')) {
        if (!chat.settings) chat.settings = {};
        chat.settings.minimaxVoiceId = ''; // é»˜èªç‚ºç©º
        console.log(`ç‚ºèˆŠè§’è‰² "${chat.name}" è£œå…¨äº† minimaxVoiceId å±¬æ€§ã€‚`);
    }
    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        acc[chat.id] = chat;
        return acc;
    }, {});
    state.apiConfig = apiConfig || { 
    id: 'main', 
    proxyUrl: '', 
    apiKey: '', 
    model: '',
    // ã€æ ¸å¿ƒæ–°å¢ã€‘ç‚ºèˆŠè³‡æ–™æ·»åŠ é è¨­ç©ºå€¼
    minimaxGroupId: '',
    minimaxApiKey: ''
};
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ æ­¥é©Ÿ 3.1ï¼šåœ¨ loadAllDataFromDB å‡½æ•¸ä¸­ï¼Œæ‰¾åˆ°ä¸¦ã€æ›¿æ›ã€‘é€™è¡Œä»£ç¢¼ â–¼â–¼â–¼

state.globalSettings = globalSettings || { 
    id: 'main', 
    ringtoneUrl: 'https://files.catbox.moe/3w7gla.mp3',
    notificationSoundUrl: 'https://files.catbox.moe/k369mf.mp3', // <-- åœ¨é€™è£¡æ–°å¢é€™ä¸€è¡Œ
    widgetData: {}, 
    wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', 
    lockscreenWallpaper: 'linear-gradient(135deg, #764ba2, #667eea)',
    password: '',
    fontUrl: '', 
    enableBackgroundActivity: false, 
    backgroundActivityInterval: 60,
    blockCooldownHours: 1,
    appIcons: { ...DEFAULT_APP_ICONS },
    appLabels: {},
    ringtoneUrl: 'https://files.catbox.moe/3w7gla.mp3',
    notificationSoundUrl: 'https://files.catbox.moe/k369mf.mp3', 
    widgetData: {}, // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡æ–°å¢ä¸€å€‹ç©ºç‰©ä»¶ï¼Œç”¨ä¾†å­˜æ”¾ä½ çš„è‡ªè¨‚å…§å®¹
// åœ¨ state.globalSettings çš„åˆå§‹åŒ–å°è±¡è£¡æ·»åŠ ï¼š
homeAvatarFrame: '', // ç‚ºä¸»è¢å¹•é ­åƒæ¡†æ·»åŠ é è¨­ç©ºå€¼

    globalChatBackground: '',
    homeIconWidgetTextColor: '#FFFFFF', // <-- ä¿®æ”¹é€™è£¡çš„åå­—
    userBalance: 520,
  // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
    homeAvatarFrame: '' // ç‚ºä¸»è¢å¹•é ­åƒæ¡†æ·»åŠ é è¨­ç©ºå€¼
    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
};
// ç¢ºä¿å³ä½¿å¾èˆŠè³‡æ–™åº«è¼‰å…¥ï¼Œé€™å€‹å±¬æ€§ä¹Ÿå­˜åœ¨
if (!state.globalSettings.widgetData) {
    state.globalSettings.widgetData = {};
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™æ®µæ–°ä»£ç¢¼ (æˆ–è€…ä¿®æ”¹ä½ å·²æœ‰çš„) â–¼â–¼â–¼
if (!state.globalSettings.homeIconWidgetTextColor) { // <-- ä¿®æ”¹é€™è£¡çš„åå­—
    state.globalSettings.homeIconWidgetTextColor = '#FFFFFF';
}
// ã€å…¨æ–°ã€‘ç›¸å®¹å­—é«”é™°å½±è¨­ç½®
if (typeof state.globalSettings.removeHomeFontShadow === 'undefined') {
    state.globalSettings.removeHomeFontShadow = false;
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„ç›¸å®¹æ€§ä»£ç¢¼ â–¼â–¼â–¼
// ç›¸å®¹èˆŠè³‡æ–™ï¼šå¦‚æœè¼‰å…¥çš„è¨­ç½®è£¡æ²’æœ‰appLabelsï¼Œå°±çµ¦å®ƒä¸€å€‹ç©ºç‰©ä»¶
if (!state.globalSettings.appLabels) {
    state.globalSettings.appLabels = {};
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œä»£ç¢¼ â–¼â–¼â–¼
    // ã€æ ¸å¿ƒæ–°å¢ã€‘è¼‰å…¥æ­Œè©æ¬„è¨­ç½®ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡ä½¿ç”¨é è¨­å€¼
    lyricsBarSettings = state.globalSettings.lyricsBarSettings || lyricsBarSettings;
    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘åˆä½µå·²ä¿å­˜çš„åœ–ç¤ºå’Œé è¨­åœ–ç¤ºï¼Œé˜²æ­¢æ›´æ–°å¾ŒèˆŠè³‡æ–™ä¸Ÿå¤±æ–°åœ–ç¤º
state.globalSettings.appIcons = { ...DEFAULT_APP_ICONS, ...(state.globalSettings.appIcons || {}) };

    state.userStickers = userStickers || [];
    state.charStickers = charStickers || []; 
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
state.apiPresets = apiPresets || [];
state.bubbleStylePresets = bubbleStylePresets || [];
// â–¼â–¼â–¼ åœ¨ loadAllDataFromDB å‡½æ•¸è£¡ï¼Œç”¨ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ qzoneSettings åˆå§‹åŒ–ä»£ç¢¼ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å¸¶æœ‰å¾®åšç”¨æˆ¶è¨­å®šã€‘çš„ä»£ç¢¼æ›¿æ› â–¼â–¼â–¼
state.qzoneSettings = qzoneSettings || { 
    id: 'main', 
    nickname: '{{user}}', 
    avatar: 'https://files.catbox.moe/q6z5fc.jpeg', 
    banner: 'https://files.catbox.moe/r5heyt.gif',
    weiboAvatar: 'https://files.catbox.moe/q6z5fc.jpeg',
    weiboNickname: 'ä½ çš„æ˜µç¨±',
    weiboFansCount: '0',
    weiboBackground: 'https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg',
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨é€™è£¡ç‚ºå¾®åšç”¨æˆ¶æ·»åŠ å°ˆå±¬çš„è·æ¥­å’Œäººè¨­æ¬„ä½ï¼
    weiboUserProfession: 'é»æ“Šè¨­ç½®è·æ¥­', 
    weiboUserPersona: 'ä¸€å€‹æ™®é€šçš„å¾®åšç”¨æˆ¶ã€‚',
    weiboUserPersonaPresets: []
};
// ç›¸å®¹èˆŠè³‡æ–™ï¼Œå¦‚æœè¼‰å…¥é€²ä¾†çš„è³‡æ–™æ²’æœ‰é€™äº›æ–°æ¬„ä½ï¼Œå°±è£œä¸Šé è¨­å€¼
if (!state.qzoneSettings.weiboAvatar) state.qzoneSettings.weiboAvatar = state.qzoneSettings.avatar || 'https://files.catbox.moe/q6z5fc.jpeg';
if (!state.qzoneSettings.weiboNickname) state.qzoneSettings.weiboNickname = state.qzoneSettings.nickname || 'ä½ çš„æ˜µç¨±';
if (!state.qzoneSettings.weiboFansCount) state.qzoneSettings.weiboFansCount = '0';
if (!state.qzoneSettings.weiboBackground) state.qzoneSettings.weiboBackground = 'https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg';
// ã€æ ¸å¿ƒæ–°å¢ã€‘ç›¸å®¹èˆŠçš„ç”¨æˆ¶å¾®åšè¨­å®š
if (!state.qzoneSettings.weiboUserProfession) state.qzoneSettings.weiboUserProfession = 'é»æ“Šè¨­ç½®è·æ¥­';
if (!state.qzoneSettings.weiboUserPersona) state.qzoneSettings.weiboUserPersona = 'ä¸€å€‹æ™®é€šçš„å¾®åšç”¨æˆ¶ã€‚';
if (!state.qzoneSettings.weiboUserPersonaPresets) state.qzoneSettings.weiboUserPersonaPresets = [];
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
if (!state.qzoneSettings.weiboAvatarFrame) state.qzoneSettings.weiboAvatarFrame = '';
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

    // â–¼â–¼â–¼ ã€ç¢ºä¿é€™ä¸€è¡Œåœ¨ Promise.all ä¹‹å¾Œï¼Œä¸¦ä½¿ç”¨è§£æ§‹è³¦å€¼å¾—åˆ°çš„ initialFavoritesã€‘ â–¼â–¼â–¼
    allFavoriteItems = initialFavorites || [];
    // â–²â–²â–² ã€ä¿®æ”¹çµæŸã€‘ â–²â–²â–²

// åœ¨ loadAllDataFromDB å‡½æ•¸æœ«å°¾ï¼Œinit(); èª¿ç”¨ä¹‹å‰æ·»åŠ 
if (typeof state.globalSettings.notificationSoundUrl === 'undefined') {
    state.globalSettings.notificationSoundUrl = 'https://files.catbox.moe/k369mf.mp3';
}


}

        // â–¼â–¼â–¼ ã€å…¨æ–° | æ”¯æŒè‡¨æ™‚æ­Œæ›²ã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ saveGlobalPlaylist å‡½æ•¸ â–¼â–¼â–¼
async function saveGlobalPlaylist() {
    // 1. åœ¨ä¿å­˜å‰ï¼Œå…ˆå¾ç•¶å‰æ’­æ”¾æ¸…å–®ä¸­éæ¿¾æ‰æ‰€æœ‰è¢«æ¨™è¨˜ç‚º isTemporary çš„æ­Œæ›²
    const permanentPlaylist = musicState.playlist.filter(track => !track.isTemporary);
    
    // 2. åªå°‡é€™å€‹â€œæ°¸ä¹…æ’­æ”¾æ¸…å–®â€ä¿å­˜åˆ°è³‡æ–™åº«ä¸­
    await db.musicLibrary.put({ id: 'main', playlist: permanentPlaylist });
    console.log("å·²å°‡æ°¸ä¹…æ’­æ”¾æ¸…å–®ä¿å­˜åˆ°è³‡æ–™åº«ã€‚");
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }

        function showNotification(chatId, messageContent) { playNotificationSound();clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }

      // â–¼â–¼â–¼ æ­¥é©Ÿ 1.1ï¼šç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„ updateClock å‡½æ•¸ â–¼â–¼â–¼
/* â–¼â–¼â–¼ æ­¥é©Ÿ 1ï¼šå°‡é€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ°æ‚¨çš„JSä»£ç¢¼çš„åŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼ */

/**
 * ã€å…¨æ–°æ·»åŠ ã€‘é¡¯ç¤ºä¸€å€‹åŒ…å«å¤šå€‹é¸é …çš„æ“ä½œåŠŸèƒ½è¡¨æ¨¡æ…‹æ¡†
 * é€™æ˜¯è®“åœ–ç‰‡ç·¨è¼¯æ™‚èƒ½å¤ é¸æ“‡â€œæœ¬åœ°ä¸Šå‚³â€æˆ–â€œURLâ€çš„é—œéµå‡½æ•¸ï¼
 * @param {string} title - æ¨¡æ…‹æ¡†çš„æ¨™é¡Œ
 * @param {Array<object>} options - æŒ‰éˆ•é¸é …é™£åˆ—, e.g., [{ text: 'æŒ‰éˆ•æ–‡å­—', value: 'è¿”å›å€¼' }]
 * @returns {Promise<string|null>} - è¿”å›ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•çš„valueï¼Œå¦‚æœå–æ¶ˆå‰‡è¿”å›null
 */
function showChoiceModal(title, options) {
    return new Promise(resolve => {
        // è¤‡ç”¨ä½ ç¾æœ‰çš„è‡ªè¨‚æ¨¡æ…‹æ¡†
        const modal = document.getElementById('preset-actions-modal');
        const footer = modal.querySelector('.custom-modal-footer');
        
        // æ¸…ç©ºèˆŠæŒ‰éˆ•ä¸¦å‹•æ…‹å‰µå»ºæ–°æŒ‰éˆ•
        footer.innerHTML = ''; 

        options.forEach(option => {
            const button = document.createElement('button');
            button.textContent = option.text;
            button.onclick = () => {
                modal.classList.remove('visible');
                resolve(option.value); // è¿”å›è¢«é»æ“ŠæŒ‰éˆ•çš„å€¼
            };
            footer.appendChild(button);
        });

        // æ·»åŠ ä¸€å€‹æ¨™æº–çš„å–æ¶ˆæŒ‰éˆ•
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.style.marginTop = '8px';
        cancelButton.style.borderRadius = '8px';
        cancelButton.style.backgroundColor = '#f0f0f0';
        cancelButton.onclick = () => {
            modal.classList.remove('visible');
            resolve(null); // ç”¨æˆ¶å–æ¶ˆï¼Œè¿”å› null
        };
        footer.appendChild(cancelButton);

        modal.classList.add('visible');
    });
}
// â–¼â–¼â–¼ ã€æœ€çµ‚æ­£ç¢ºç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ deleteExpiredSearchedSongs å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°é‡æ§‹ã€‘æª¢æŸ¥ä¸¦åˆªé™¤æ‰€æœ‰å¤±æ•ˆçš„APIæ­Œæ›²
 * æ ¸å¿ƒé‚è¼¯ï¼šä¸å†ä¾è³´ä»»ä½•æ¨™ç±¤ï¼Œç›´æ¥æ ¹æ“šé€£çµç‰¹å¾µè­˜åˆ¥éœ€è¦æª¢æŸ¥çš„æ­Œæ›²ã€‚
 */
async function deleteExpiredSearchedSongs() {
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨æª¢æŸ¥æ’­æ”¾æ¸…å–®ä¸­æ‰€æœ‰ç·šä¸Šæ­Œæ›²çš„æœ‰æ•ˆæ€§...");

    // 1. ã€æ ¸å¿ƒæ”¹è®Šã€‘æˆ‘å€‘ä¸å†å°‹æ‰¾ isTemporary æ¨™ç±¤ï¼
    // è€Œæ˜¯ç›´æ¥æ‰¾å‡ºæ‰€æœ‰ src é€£çµä¾†è‡ªæ–¼ API ä¼ºæœå™¨çš„æ­Œæ›²ã€‚
    // é€™æ˜¯ä¸€å€‹çµ•å°å¯é çš„è­˜åˆ¥æ–¹æ³•ï¼Œç„¡è«–å®ƒæœ‰æ²’æœ‰è¢«æ­£ç¢ºä¿å­˜ã€‚
    const songsToCheck = musicState.playlist.filter(track => track.src && track.src.includes('api.vkeys.cn'));

    if (songsToCheck.length === 0) {
        await showCustomAlert('æç¤º', 'æ’­æ”¾æ¸…å–®ä¸­æ²’æœ‰éœ€è¦æª¢æŸ¥çš„ç·šä¸Šæ­Œæ›²ã€‚');
        return;
    }

    const songsToDelete = [];
    const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);

    // 2. å°æ¯ä¸€é¦–è­˜åˆ¥å‡ºçš„æ­Œæ›²ï¼Œé€²è¡Œåš´æ ¼çš„â€œé«”æª¢â€
    await Promise.all(songsToCheck.map(async (track) => {
        // æ¢ä»¶1ï¼šæª¢æŸ¥é€£çµæœ¬èº«æ˜¯å¦å·²ç¶“å¤±æ•ˆï¼ˆç„¡æ³•æ’­æ”¾ï¼‰
        const isUrlInvalid = !(await checkAudioAvailability(track.src));
        
        // æ¢ä»¶2ï¼šæª¢æŸ¥æ·»åŠ æ™‚é–“æ˜¯å¦è¶…é24å°æ™‚ï¼ˆä½œç‚ºé›™é‡ä¿éšªï¼‰
        const isOlderThan24h = track.addedTimestamp && track.addedTimestamp < twentyFourHoursAgo;

        // åªè¦æ»¿è¶³ã€ä»»æ„ä¸€å€‹ã€‘æ¢ä»¶ï¼Œå°±åˆ¤å®šç‚ºâ€œå¤±æ•ˆâ€
        if (isUrlInvalid || isOlderThan24h) {
            songsToDelete.push(track);
            console.log(`æ¨™è¨˜åˆªé™¤: ${track.name} (åŸå› : ${isUrlInvalid ? 'é€£çµå¤±æ•ˆ' : ''} ${isOlderThan24h ? 'è¶…é24å°æ™‚' : ''})`);
        }
    }));

    // 3. æ ¹æ“šæª¢æŸ¥çµæœé€²è¡Œå›é¥‹å’Œæ“ä½œ (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
    if (songsToDelete.length === 0) {
        await showCustomAlert('æª¢æŸ¥å®Œæˆ', 'æ’­æ”¾æ¸…å–®ä¸­çš„æ‰€æœ‰ç·šä¸Šæ­Œæ›²ç•¶å‰å‡æœ‰æ•ˆã€‚');
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ¸…ç†',
        `æª¢æ¸¬åˆ° ${songsToDelete.length} é¦–å·²å¤±æ•ˆçš„ç·šä¸Šæ­Œæ›²ã€‚ç¢ºå®šè¦å°‡å®ƒå€‘å¾åˆ—è¡¨ä¸­ç§»é™¤å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    // åŸ·è¡Œåˆªé™¤...
    const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
    musicState.playlist = musicState.playlist.filter(track => !songsToDelete.includes(track));
    const newIndex = currentTrack ? musicState.playlist.findIndex(t => t.src === currentTrack.src && t.name === currentTrack.name) : -1;

    if (newIndex === -1) {
        if (musicState.isPlaying) {
            audioPlayer.pause();
            audioPlayer.src = '';
        }
        musicState.isPlaying = false;
        if (musicState.playlist.length > 0) {
            playSong(0); 
        } else {
            musicState.currentIndex = -1;
            updatePlayerUI();
        }
    } else {
        musicState.currentIndex = newIndex;
        updatePlayerUI();
    }
    
    await saveGlobalPlaylist();
    updatePlaylistUI();
    await showCustomAlert('æ¸…ç†å®Œæˆ', `${songsToDelete.length} é¦–æ­Œæ›²å·²å¾åˆ—è¡¨ä¸­ç§»é™¤ã€‚`);
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



/**
 * ã€å·²ä¿®å¾©ã€‘æ›´æ–°æ‰€æœ‰æ™‚é˜ï¼ˆç‹€æ…‹åˆ—å’Œé–å±ï¼‰
 */
function updateClock() { 
    const now = new Date(); 
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); 
    const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); 
    
    // æ›´æ–°ç‹€æ…‹åˆ—æ™‚é˜ (é€™å€‹å…ƒç´ ä¸€ç›´å­˜åœ¨)
    const statusBarTime = document.getElementById('status-bar-time');
    if (statusBarTime) {
        statusBarTime.textContent = timeString; 
    }

    // æ›´æ–°é–å±æ™‚é˜ (åªæœ‰ç•¶é–å±å…ƒç´ å­˜åœ¨æ™‚æ‰æ›´æ–°ï¼Œé¿å…å ±éŒ¯)
    const lockTime = document.getElementById('lock-main-time');
    const lockDate = document.getElementById('lock-main-date');
    if (lockTime) {
        lockTime.textContent = timeString;
    }
    if (lockDate) {
        lockDate.textContent = dateString;
    }
}



/**
 * ã€çµ‚æ¥µå¥å£¯ç‰ˆã€‘è§£æAIè¿”å›çš„ã€å¯èƒ½æ ¼å¼ä¸è¦ç¯„çš„å›æ‡‰å…§å®¹
 * @param {string} content - AIè¿”å›çš„åŸå§‹å­—ä¸²
 * @returns {Array} - ä¸€å€‹æ¨™æº–åŒ–çš„æ¶ˆæ¯ç‰©ä»¶é™£åˆ—
 */
function parseAiResponse(content) {
    const trimmedContent = content.trim();

    // æ–¹æ¡ˆ1ï¼šã€æœ€å„ªå…ˆã€‘å˜—è©¦ä½œç‚ºæ¨™æº–çš„ã€å–®ä¸€çš„JSONé™£åˆ—è§£æ
    // é€™æ˜¯æœ€ç†æƒ³ã€æœ€é«˜æ•ˆçš„æƒ…æ³
    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
        try {
            const parsed = JSON.parse(trimmedContent);
            if (Array.isArray(parsed)) {
                console.log("è§£ææˆåŠŸï¼šæ¨™æº–JSONé™£åˆ—æ ¼å¼ã€‚");
                return parsed;
            }
        } catch (e) {
            // å¦‚æœè§£æå¤±æ•—ï¼Œèªªæ˜å®ƒé›–ç„¶çœ‹èµ·ä¾†åƒå€‹é™£åˆ—ï¼Œä½†å…§éƒ¨æ ¼å¼æœ‰å•é¡Œã€‚
            // æ­¤æ™‚æˆ‘å€‘ä¸å ±éŒ¯ï¼Œè€Œæ˜¯ç¹¼çºŒå˜—è©¦ä¸‹é¢çš„â€œå¼·åŠ›è§£æâ€æ–¹æ¡ˆã€‚
            console.warn("æ¨™æº–JSONé™£åˆ—è§£æå¤±æ•—ï¼Œå°‡å˜—è©¦å¼·åŠ›è§£æ...");
        }
    }

    // æ–¹æ¡ˆ2ï¼šã€å¼·åŠ›è§£æã€‘ä½¿ç”¨è¦å‰‡é‹ç®—å¼ï¼Œå¾æ··äº‚çš„å­—ä¸²ä¸­æå–å‡ºæ‰€æœ‰ç¨ç«‹çš„JSONç‰©ä»¶
    // é€™èƒ½å®Œç¾è§£æ±ºæ‚¨é‡åˆ°çš„ "(Timestamp: ...)[{...}](Timestamp: ...)[{...}]" é€™ç¨®æ ¼å¼
    const jsonMatches = trimmedContent.match(/{[^{}]*}/g);

    if (jsonMatches) {
        const results = [];
        for (const match of jsonMatches) {
            try {
                // å˜—è©¦è§£ææ¯ä¸€å€‹è¢«æˆ‘å€‘â€œæªâ€å‡ºä¾†çš„JSONå­—ä¸²
                const parsedObject = JSON.parse(match);
                results.push(parsedObject);
            } catch (e) {
                // å¦‚æœæŸå€‹ç‰‡æ®µä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œå°±å¿½ç•¥å®ƒï¼Œç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹
                console.warn("è·³éä¸€å€‹ç„¡æ•ˆçš„JSONç‰‡æ®µ:", match);
            }
        }

        // å¦‚æœæˆ‘å€‘æˆåŠŸæå–å‡ºäº†è‡³å°‘ä¸€å€‹æœ‰æ•ˆçš„JSONç‰©ä»¶ï¼Œå°±è¿”å›é€™å€‹çµæœ
        if (results.length > 0) {
            console.log("è§£ææˆåŠŸï¼šé€šéå¼·åŠ›æå–æ¨¡å¼ã€‚");
            return results;
        }
    }
    
    // æ–¹æ¡ˆ3ï¼šã€æœ€çµ‚å‚™ç”¨ã€‘å¦‚æœä»¥ä¸Šæ‰€æœ‰æ–¹æ³•éƒ½å¤±æ•—äº†ï¼Œèªªæ˜AIè¿”å›çš„å¯èƒ½å°±æ˜¯ç´”æ–‡å­—
    // æˆ‘å€‘å°‡åŸå§‹çš„ã€æœªè™•ç†çš„å…§å®¹ï¼ŒåŒ…è£æˆä¸€å€‹æ¨™æº–çš„æ–‡æœ¬æ¶ˆæ¯ç‰©ä»¶è¿”å›ï¼Œç¢ºä¿ç¨‹å¼ä¸æœƒå´©æ½°
    console.error("æ‰€æœ‰è§£ææ–¹æ¡ˆå‡å¤±æ•—ï¼å°‡è¿”å›åŸå§‹æ–‡æœ¬ã€‚");
    return [{ type: 'text', content: content }];
}

    function renderApiSettings() {
    // 1. æ›´æ–° API ç›¸é—œçš„è¼¸å…¥æ¡†
    document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || '';
    document.getElementById('api-key').value = state.apiConfig.apiKey || '';
        // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
    // ã€æ ¸å¿ƒæ–°å¢ã€‘è¼‰å…¥ Minimax è¨­ç½®
    document.getElementById('minimax-group-id').value = state.apiConfig.minimaxGroupId || '';
    document.getElementById('minimax-api-key').value = state.apiConfig.minimaxApiKey || '';
    // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
    // å¦‚æœä½ æœ‰æ¨¡å‹é¸æ“‡ï¼Œä¹Ÿä¸€ä½µæ›´æ–°
    if (document.getElementById('model-select')) {
        document.getElementById('model-select').value = state.apiConfig.model || 'gpt-4';
    }

    // 2. æ›´æ–°å¾Œè‡ºæ´»å‹•ç›¸é—œçš„é–‹é—œå’Œè¼¸å…¥æ¡†
    
    // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘é€™æ¬¡ä¿®å¾©çš„æ ¸å¿ƒ â˜…â˜…â˜…â˜…â˜…
    // ä½¿ç”¨ !!state.globalSettings.enableBackgroundActivity é€™ç¨®å¯«æ³•ï¼Œ
    // ç¢ºä¿ç•¶é€™å€‹è¨­ç½®é‚„ä¸å­˜åœ¨æ™‚ (æ¯”å¦‚ç¬¬ä¸€æ¬¡æ‰“é–‹)ï¼Œé–‹é—œä¹Ÿèƒ½æ­£ç¢ºåœ°é¡¯ç¤ºç‚º false (é—œé–‰ç‹€æ…‹)
    document.getElementById('background-activity-switch').checked = !!state.globalSettings.enableBackgroundActivity;
    // â˜…â˜…â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…â˜…â˜…

    document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
    document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;

    // 3. æ¸²æŸ“é è¨­å’Œé »ç‡çš„ä¸‹æ‹‰æ¸…å–®
    renderApiPresetSelector();
    renderBackgroundFrequencySelector();
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é»è²¼é€™å€‹å®Œæ•´çš„å‡½æ•¸ â–¼â–¼â–¼
/**
 * æ¸²æŸ“å¾Œè‡ºæ´»å‹•çš„è§’è‰²é¸æ“‡å’Œé »ç‡è¨­ç½®UI
 */
function renderBackgroundFrequencySelector() {
    const container = document.getElementById('background-activity-char-list');
    const detailsContainer = document.getElementById('background-activity-details');
    const masterSwitch = document.getElementById('background-activity-switch');

    // æ ¹æ“šç¸½é–‹é—œçš„ç‹€æ…‹ï¼Œæ±ºå®šæ˜¯å¦é¡¯ç¤ºè©³ç´°è¨­ç½®
    detailsContainer.style.display = masterSwitch.checked ? 'block' : 'none';
    
    container.innerHTML = ''; // æ¸…ç©ºèˆŠåˆ—è¡¨
    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (singleChats.length === 0) {
        container.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">é‚„æ²’æœ‰å¯ä»¥è¨­ç½®çš„è§’è‰²</p>';
        return;
    }

    const config = state.globalSettings.backgroundActivityConfig || {};

    singleChats.forEach(chat => {
        const freq = config[chat.id] || 'none'; // ç²å–ç•¶å‰è§’è‰²çš„é »ç‡è¨­ç½®
        let badgeHtml = '';
        if (freq !== 'none') {
            const freqText = { low: 'ä½', medium: 'ä¸­', high: 'é«˜' }[freq];
            badgeHtml = `<span class="char-freq-badge ${freq}">${freqText}</span>`;
        }

        const item = document.createElement('div');
        item.className = 'char-list-item';
        item.innerHTML = `
            <input type="checkbox" class="bg-char-checkbox" data-chat-id="${chat.id}">
            <span class="char-name">${chat.name}</span>
            ${badgeHtml}
        `;
        container.appendChild(item);
    });
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

        window.renderApiSettingsProxy = renderApiSettings;
// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å…¨æ–°ä¿®æ­£ç‰ˆã€‘æ›¿æ›èˆŠçš„ renderChatList å‡½æ•¸ â–¼â–¼â–¼
async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';

    // 1. ç²å–æ‰€æœ‰èŠå¤©å’Œåˆ†çµ„è³‡æ–™
    const allChats = Object.values(state.chats);
    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
        chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">é»æ“Šå³ä¸Šè§’ "+" æˆ–ç¾¤çµ„åœ–ç¤ºæ·»åŠ èŠå¤©</p>';
        return;
    }

    // 2. å°‡èŠå¤©æ˜ç¢ºåœ°åˆ†ç‚ºâ€œç½®é ‚â€å’Œâ€œæœªç½®é ‚â€å…©çµ„
    const pinnedChats = allChats.filter(chat => chat.isPinned);
    const unpinnedChats = allChats.filter(chat => !chat.isPinned);

    // 3. å°ç½®é ‚çš„èŠå¤©ï¼Œåƒ…æŒ‰æœ€æ–°æ¶ˆæ¯æ™‚é–“æ’åº
    pinnedChats.sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));

    // 4. ã€å„ªå…ˆæ¸²æŸ“ã€‘æ‰€æœ‰ç½®é ‚çš„èŠå¤©
    pinnedChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    // 5. ã€æ¥ä¸‹ä¾†è™•ç†æœªç½®é ‚çš„èŠå¤©ã€‘æ‡‰ç”¨æ‚¨ä¹‹å‰çš„åˆ†çµ„é‚è¼¯
    // ç‚ºæ¯å€‹åˆ†çµ„æ‰¾åˆ°å…¶å…§éƒ¨æœ€æ–°çš„æ¶ˆæ¯æ™‚é–“æˆ³è¨˜ (åªåœ¨æœªç½®é ‚èŠå¤©ä¸­æŸ¥æ‰¾)
    allGroups.forEach(group => {
        const latestChatInGroup = unpinnedChats
            .filter(chat => chat.groupId === group.id) // æ‰¾åˆ°å±¬æ–¼é€™å€‹çµ„çš„èŠå¤©
            .sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0))[0]; // æ’åºå¾Œå–ç¬¬ä¸€å€‹
        
        group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });

    // æ ¹æ“šåˆ†çµ„çš„æœ€æ–°æ™‚é–“æˆ³è¨˜ï¼Œå°åˆ†çµ„æœ¬èº«é€²è¡Œæ’åº
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

    // 6. éæ­·æ’åºå¾Œçš„åˆ†çµ„ï¼Œæ¸²æŸ“å…¶ä¸­çš„ã€æœªç½®é ‚ã€‘å¥½å‹
    allGroups.forEach(group => {
        const groupChats = unpinnedChats
            .filter(chat => !chat.isGroup && chat.groupId === group.id)
            .sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
        
        if (groupChats.length === 0) return; // å¦‚æœé€™å€‹åˆ†çµ„è£¡æ²’æœ‰æœªç½®é ‚çš„å¥½å‹ï¼Œå°±è·³é

        const groupContainer = document.createElement('div');
        groupContainer.className = 'chat-group-container';
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸‹é¢é€™å…©è¡Œä»£ç¢¼è£¡ï¼Œæˆ‘å·²ç¶“åˆªé™¤äº† collapsed é¡ï¼Œé€™æ¨£é»˜èªå°±æ˜¯å±•é–‹çš„äº†ï¼
        groupContainer.innerHTML = `
            <div class="chat-group-header">
                <span class="arrow">â–¼</span>
                <span class="group-name">${group.name}</span>
            </div>
            <div class="chat-group-content"></div>
        `;
        const contentEl = groupContainer.querySelector('.chat-group-content');

        groupChats.forEach(chat => {
            const item = createChatListItem(chat);
            contentEl.appendChild(item);
        });
        chatListEl.appendChild(groupContainer);
    });

    // 7. æœ€å¾Œï¼Œæ¸²æŸ“æ‰€æœ‰ã€æœªç½®é ‚ã€‘çš„ç¾¤èŠå’Œã€æœªåˆ†çµ„çš„ã€‘å¥½å‹
    const remainingChats = unpinnedChats
        .filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId))
        .sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
    
    remainingChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    // ç‚ºæ‰€æœ‰åˆ†çµ„æ¨™é¡Œæ·»åŠ æŠ˜ç–Šäº‹ä»¶
    document.querySelectorAll('.chat-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨é€™å€‹ã€æœ€çµ‚ä¿®æ­£ç‰ˆã€‘æ›¿æ›ä½ å°ˆæ¡ˆä¸­é‚£å€‹å°è‡´éŒ¯èª¤çš„ createChatListItem å‡½æ•¸ â–¼â–¼â–¼
function createChatListItem(chat) {
    const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
    let lastMsgDisplay;

    // --- æ¶ˆæ¯é è¦½çš„é‚è¼¯ä¿æŒä¸è®Š ---
    if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
        lastMsgDisplay = `<span style="color: #ff8c00;">[å¥½å‹ç”³è«‹] ${chat.relationship.applicationReason || 'è«‹æ±‚æ·»åŠ ä½ ç‚ºå¥½å‹'}</span>`;
    } else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
        lastMsgDisplay = `<span style="color: #dc3545;">[ä½ å·²è¢«å°æ–¹æ‹‰é»‘]</span>`;
    } else if (chat.isGroup) {
        if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[ç³»çµ±æ¶ˆæ¯] ${lastMsgObj.content}`; }
        else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[è½‰å¸³]'; }
        else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ç…§ç‰‡]'; }
        else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[èªéŸ³]'; }
        else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[è¡¨æƒ…: ${lastMsgObj.meaning}]` : '[è¡¨æƒ…]'; }
        else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[åœ–ç‰‡]`; }
        else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }
        if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
            lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
        }
    } else {
        const statusText = chat.status?.text || 'ç·šä¸Š';
        lastMsgDisplay = `[${statusText}]`;
    }

    const lastMsgTimestamp = lastMsgObj?.timestamp;
    const timeDisplay = formatChatListTimestamp(lastMsgTimestamp);
    
    const container = document.createElement('div');
    container.className = 'chat-list-item-swipe-container';
    container.dataset.chatId = chat.id;

    const content = document.createElement('div');
    content.className = `chat-list-item-content ${chat.isPinned ? 'pinned' : ''}`;
    
    const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
    
    // --- ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘å‰µå»ºäº†ä¸€å€‹æ–°çš„å³å´å®¹å™¨ï¼Œä¸¦æŠŠæ™‚é–“å’Œæœªè®€ç´…é»éƒ½æ”¾äº†é€²å» ---
    content.innerHTML = `
        <div class="chat-list-item" data-chat-id="${chat.id}">
            <img src="${avatar || defaultAvatar}" class="avatar">
            <div class="info">
                <div class="name-line">
                    <span class="name">${chat.name}</span>
                    ${chat.isGroup ? '<span class="group-tag">ç¾¤èŠ</span>' : ''}
                </div>
                <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
            </div>
            <div class="chat-list-right-column">
                <div class="chat-list-time">${timeDisplay}</div>
                <div class="unread-count-wrapper">
                    <span class="unread-count" style="display: none;">0</span>
                </div>
            </div>
        </div>
    `;
    
    // å¾ŒçºŒçš„æ»‘å‹•æŒ‰éˆ•é‚è¼¯ä¿æŒä¸è®Š
    const actions = document.createElement('div');
    actions.className = 'swipe-actions';
    const pinButtonText = chat.isPinned ? 'å–æ¶ˆç½®é ‚' : 'ç½®é ‚';
    const pinButtonClass = chat.isPinned ? 'unpin' : 'pin';
    actions.innerHTML = `
        <button class="swipe-action-btn ${pinButtonClass}">${pinButtonText}</button>
        <button class="swipe-action-btn delete">åˆªé™¤</button>
    `;
    
    container.appendChild(content);
    container.appendChild(actions);
    
    // --- ã€é‡è¦ã€‘ç¾åœ¨é€™æ®µä»£ç¢¼å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼Œå› ç‚º .unread-count å…ƒç´ åˆå›ä¾†äº†ï¼ ---
    const unreadCount = chat.unreadCount || 0;
    const unreadEl = content.querySelector('.unread-count');
    if (unreadCount > 0) {
        unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
        unreadEl.style.display = 'inline-flex';
    } else {
        unreadEl.style.display = 'none';
    }
    
    // äº‹ä»¶ç›£è½é‚è¼¯ä¿æŒä¸è®Š
    const infoEl = content.querySelector('.info');
    if (infoEl) {
        infoEl.addEventListener('click', () => openChat(chat.id));
    }
const avatarEl = content.querySelector('.avatar, .avatar-with-frame');
if (avatarEl) {
     avatarEl.addEventListener('click', (e) => {
        e.stopPropagation();
        handleUserPat(chat.id, chat.name);
    });
}

    return container;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å¸¶è¨ºæ–·åŠŸèƒ½çš„å…¨æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ renderChatInterface å‡½æ•¸ â–¼â–¼â–¼
function renderChatInterface(chatId) {
    cleanupWaimaiTimers();
    const chat = state.chats[chatId];
    if (!chat) return;
    exitSelectionMode();
    
    const messagesContainer = document.getElementById('chat-messages');
    const chatInputArea = document.getElementById('chat-input-area');
    const lockOverlay = document.getElementById('chat-lock-overlay');
    const lockContent = document.getElementById('chat-lock-content');

    messagesContainer.dataset.theme = chat.settings.theme || 'default';
    const fontSize = chat.settings.fontSize || 13;
    messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
    applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
    
    document.getElementById('chat-header-title').textContent = chat.name;
    const statusContainer = document.getElementById('chat-header-status');
    const statusTextEl = statusContainer.querySelector('.status-text');

    if (chat.isGroup) {
        statusContainer.style.display = 'none';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
    } else {
        statusContainer.style.display = 'flex';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
        statusTextEl.textContent = chat.status?.text || 'ç·šä¸Š';
        statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
    }
    
    lockOverlay.style.display = 'none';
    chatInputArea.style.visibility = 'visible';
    lockContent.innerHTML = '';

    if (!chat.isGroup && chat.relationship.status !== 'friend') {
        lockOverlay.style.display = 'flex';
        chatInputArea.style.visibility = 'hidden';
        
        let lockHtml = '';
        switch (chat.relationship.status) {
            case 'blocked_by_user':
                // --- ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡åŠ å…¥è¨ºæ–·é¢æ¿ã€‘ ---
                const isSimulationRunning = simulationIntervalId !== null;
                const blockedTimestamp = chat.relationship.blockedTimestamp;
                const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                const timeSinceBlock = Date.now() - blockedTimestamp;
                const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

                lockHtml = `
                    <span class="lock-text">ä½ å·²å°‡â€œ${chat.name}â€æ‹‰é»‘ã€‚</span>
                    <button id="unblock-btn" class="lock-action-btn">è§£é™¤æ‹‰é»‘</button>
                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                        <strong style="color: #333;">ã€é–‹ç™¼è€…è¨ºæ–·é¢æ¿ã€‘</strong><br>
                        - å¾Œè‡ºæ´»å‹•ç¸½é–‹é—œ: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²é–‹å•Ÿ</span>' : '<span style="color: red;">å·²é—œé–‰</span>'}<br>
                        - ç³»çµ±å¿ƒè·³è¨ˆæ™‚å™¨: ${isSimulationRunning ? '<span style="color: green;">é‹è¡Œä¸­</span>' : '<span style="color: red;">æœªé‹è¡Œ</span>'}<br>
                        - ç•¶å‰è§’è‰²ç‹€æ…‹: <strong>${chat.relationship.status}</strong><br>
                        - éœ€è¦å†·éœ(å°æ™‚): <strong>${cooldownHours}</strong><br>
                        - å†·éœæœŸæ˜¯å¦çµæŸ: ${isCooldownOver ? '<span style="color: green;">æ˜¯</span>' : `<span style="color: orange;">å¦ (é‚„å‰©ç´„ ${timeRemainingMinutes} åˆ†é˜)</span>`}<br>
                        - è§¸ç™¼æ¢ä»¶: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²æ»¿è¶³ï¼Œç­‰å¾…ä¸‹æ¬¡ç³»çµ±å¿ƒè·³</span>' : '<span style="color: red;">æœªæ»¿è¶³</span>'}
                    </div>
                    <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">å¼·åˆ¶è§¸ç™¼ä¸€æ¬¡å¥½å‹ç”³è«‹æª¢æ¸¬</button>
                `;
                // --- ã€ä¿®æ”¹çµæŸã€‘ ---
                break;
            case 'blocked_by_ai':
                lockHtml = `
                    <span class="lock-text">ä½ è¢«å°æ–¹æ‹‰é»‘äº†ã€‚</span>
                    <button id="apply-friend-btn" class="lock-action-btn">é‡æ–°ç”³è«‹åŠ ç‚ºå¥½å‹</button>
                `;
                break;
            
            case 'pending_user_approval':
                lockHtml = `
                    <span class="lock-text">â€œ${chat.name}â€è«‹æ±‚æ·»åŠ ä½ ç‚ºå¥½å‹ï¼š<br><i>â€œ${chat.relationship.applicationReason}â€</i></span>
                    <button id="accept-friend-btn" class="lock-action-btn">æ¥å—</button>
                    <button id="reject-friend-btn" class="lock-action-btn secondary">æ‹’çµ•</button>
                `;
                break;

            // ã€æ ¸å¿ƒä¿®æ­£ã€‘ä¿®å¾©ç•¶ä½ ç”³è«‹å¾Œï¼Œä½ çœ‹åˆ°çš„ä»‹é¢
            case 'pending_ai_approval':
                lockHtml = `<span class="lock-text">å¥½å‹ç”³è«‹å·²ç™¼é€ï¼Œç­‰å¾…å°æ–¹é€šé...</span>`;
                break;
        }
        lockContent.innerHTML = lockHtml;
    }
    messagesContainer.innerHTML = '';
// â–¼â–¼â–¼ ç”¨é€™ã€ä¸€æ•´å¡Šã€‘ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„èƒŒæ™¯è¨­ç½®é‚è¼¯ â–¼â–¼â–¼
const chatScreen = document.getElementById('chat-interface-screen');

// æ ¸å¿ƒé‚è¼¯ï¼šå–®äººèƒŒæ™¯å„ªå…ˆæ–¼å…¨åŸŸèƒŒæ™¯
const backgroundToApply = chat.settings.background || state.globalSettings.globalChatBackground;

if (backgroundToApply) {
    chatScreen.style.backgroundImage = `url(${backgroundToApply})`;
} else {
    chatScreen.style.backgroundImage = 'none';
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : (isDarkMode ? '#000000' : '#f0f2f5');
    const history = chat.history;
    const totalMessages = history.length;
    currentRenderedCount = 0;
    const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
let lastMessageTimestamp = null;

initialMessages.forEach(msg => {
    if (msg.isHidden) return; // ã€æ–°å¢ã€‘è·³ééš±è—æ¶ˆæ¯

    if (isNewDay(msg.timestamp, lastMessageTimestamp)) {
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘èª¿ç”¨æˆ‘å€‘æ–°çš„ç”Ÿæˆå™¨å‡½æ•¸
        const dateStampEl = createDateStampElement(msg.timestamp);
        messagesContainer.insertBefore(dateStampEl, document.getElementById('typing-indicator'));
    }
    
    appendMessage(msg, chat, true);
    
    lastMessageTimestamp = msg.timestamp;
});
    currentRenderedCount = initialMessages.length;
    if (totalMessages > currentRenderedCount) {
        prependLoadMoreButton(messagesContainer);
    }
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.style.display = 'none';
    typingIndicator.textContent = 'å°æ–¹æ­£åœ¨è¼¸å…¥...';
    messagesContainer.appendChild(typingIndicator);
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
    renderChatPet();
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'è¼‰å…¥æ›´æ—©çš„è¨˜éŒ„'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }

        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; // â–¼â–¼â–¼ è«‹å°‡é€™å€‹å®Œæ•´çš„ä»£ç¢¼å¡Šï¼Œé»è²¼åˆ°è¢«åˆªé™¤çš„ä½ç½® â–¼â–¼â–¼

// 1. æ‰¾åˆ°è¢å¹•ä¸Šå·²æœ‰çš„ã€æœ€è€çš„é‚£æ¢ã€çœŸå¯¦æ¶ˆæ¯ã€‘çš„æ™‚é–“æˆ³è¨˜
const firstVisibleMessage = messagesContainer.querySelector('.message-wrapper:not(.date-stamp-wrapper)');
let subsequentMessageTimestamp = firstVisibleMessage ? parseInt(firstVisibleMessage.dataset.timestamp) : null;

// 2. å¾å¾Œå¾€å‰ï¼ˆå¾æ–°åˆ°èˆŠï¼‰éæ­·æˆ‘å€‘è¦æ–°è¼‰å…¥çš„æ¶ˆæ¯
messagesToPrepend.reverse().forEach(currentMsg => {
    // æª¢æŸ¥é€™æ¢æ–°æ¶ˆæ¯å’Œå®ƒå¾Œé¢é‚£æ¢ï¼ˆå¯èƒ½æ˜¯è¢å¹•ä¸Šå·²æœ‰çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å‰›è¼‰å…¥çš„ï¼‰æ¶ˆæ¯æ˜¯å¦è·¨å¤©
    if (subsequentMessageTimestamp && isNewDay(subsequentMessageTimestamp, currentMsg.timestamp)) {
        // å¦‚æœè·¨å¤©ï¼Œå°±ç‚ºå¾Œé¢é‚£æ¢â€œè¼ƒæ–°â€çš„æ¶ˆæ¯å‰µå»ºä¸€å€‹æ—¥æœŸæˆ³
        const dateStampEl = createDateStampElement(subsequentMessageTimestamp);
        messagesContainer.prepend(dateStampEl);
    }
    
    // æ­£å¸¸åœ°æŠŠç•¶å‰é€™æ¢æ–°æ¶ˆæ¯æ”¾åˆ°æœ€å‰é¢
    prependMessage(currentMsg, chat);
    
    // æ›´æ–°è¿½è¹¤å™¨ï¼Œç‚ºä¸‹ä¸€æ¬¡æ¯”è¼ƒåšæº–å‚™
    subsequentMessageTimestamp = currentMsg.timestamp;
});

// 3. ã€é‚Šç•Œè™•ç†ã€‘è™•ç†æ‰€æœ‰æ–°è¼‰å…¥æ¶ˆæ¯çš„æœ€å‰é¢ï¼ˆä¹Ÿå°±æ˜¯æ•´å€‹èŠå¤©è¨˜éŒ„çš„æœ€è€ï¼‰çš„é‚£æ¢æ¶ˆæ¯
// å®ƒä¹Ÿéœ€è¦ä¸€å€‹æ—¥æœŸæˆ³
if (subsequentMessageTimestamp) {
    const dateStampEl = createDateStampElement(subsequentMessageTimestamp);
    messagesContainer.prepend(dateStampEl);
}

// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ renderWallpaperScreen å‡½æ•¸ â–¼â–¼â–¼
function renderWallpaperScreen() { 


      // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
    // ã€æ ¸å¿ƒä¿®å¾©ã€‘æ¯æ¬¡æ¸²æŸ“æ­¤é é¢æ™‚ï¼Œéƒ½å¾ localStorage è®€å–ä¸¦è¨­ç½®é–‹é—œçš„æ­£ç¢ºç‹€æ…‹
    const lockScreenEnabled = localStorage.getItem('lockScreenEnabled') !== 'false';
    const toggle = document.getElementById('enable-lock-screen-toggle');
    if (toggle) {
        toggle.checked = lockScreenEnabled;
    }
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™æ®µæ–°ä»£ç¢¼ (æˆ–è€…ä¿®æ”¹ä½ å·²æœ‰çš„) â–¼â–¼â–¼
document.getElementById('home-icon-widget-text-color-picker').value = state.globalSettings.homeIconWidgetTextColor || '#FFFFFF';
// ã€å…¨æ–°ã€‘æ¸²æŸ“å­—é«”é™°å½±é–‹é—œçš„ç‹€æ…‹
document.getElementById('remove-home-font-shadow-toggle').checked = !!state.globalSettings.removeHomeFontShadow;
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

    const preview = document.getElementById('wallpaper-preview'); 
    const bg = newWallpaperBase64 || state.globalSettings.wallpaper; 
    if (bg && bg.startsWith('data:image')) { 
        preview.style.backgroundImage = `url(${bg})`; 
        preview.textContent = ''; 
    } else if(bg) { 
        preview.style.backgroundImage = bg; 
        preview.textContent = 'ç•¶å‰ç‚ºæ¼¸è®Šè‰²'; 
    }

    // é–å±å£ç´™é è¦½ (æ–°å¢é‚è¼¯)
    const lockscreenPreview = document.getElementById('lockscreen-wallpaper-preview');
    const lockBg = newLockscreenWallpaperBase64 || state.globalSettings.lockscreenWallpaper;
    if (lockBg && lockBg.startsWith('data:image')) {
        lockscreenPreview.style.backgroundImage = `url(${lockBg})`;
        lockscreenPreview.textContent = '';
    } else if (lockBg) {
        lockscreenPreview.style.backgroundImage = lockBg;
        lockscreenPreview.textContent = 'ç•¶å‰ç‚ºæ¼¸è®Šè‰²';
    }

    // å¯†ç¢¼è¼¸å…¥æ¡† (æ–°å¢é‚è¼¯)
    document.getElementById('password-set-input').value = state.globalSettings.password || '';
// â–¼â–¼â–¼ åœ¨ password-set-input è³¦å€¼çš„ä¸‹ä¸€è¡Œï¼Œé»è²¼ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘æ–°ä»£ç¢¼ â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘æ¸²æŸ“å…¨åŸŸèŠå¤©èƒŒæ™¯çš„é è¦½
const globalBgPreview = document.getElementById('global-bg-preview');
const globalBg = newGlobalBgBase64 || state.globalSettings.globalChatBackground;
if (globalBg && globalBg.startsWith('data:image')) {
    globalBgPreview.style.backgroundImage = `url(${globalBg})`;
    globalBgPreview.textContent = '';
} else if (globalBg) { // ç›¸å®¹æœªä¾†å¯èƒ½æ”¯æŒçš„é¡è‰²ä»£ç¢¼æˆ–æ¼¸è®Š
    globalBgPreview.style.background = globalBg;
    globalBgPreview.textContent = 'ç•¶å‰ç‚ºæ¼¸è®Šè‰²';
} else {
    globalBgPreview.style.backgroundImage = 'none';
    globalBgPreview.textContent = 'é»æ“Šä¸‹æ–¹ä¸Šå‚³';
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡èª¿ç”¨åœ–ç¤ºæ¸²æŸ“å‡½æ•¸
    renderIconSettings();
renderAppNameSettings();
document.getElementById('ringtone-url-input').value = state.globalSettings.ringtoneUrl || '';
loadHomeScreenPresetsToDropdown(); 
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
document.getElementById('ringtone-url-input').value = state.globalSettings.ringtoneUrl || '';
// â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('notification-sound-url-input').value = state.globalSettings.notificationSoundUrl || '';
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        window.renderWallpaperScreenProxy = renderWallpaperScreen;

        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }

async function renderWorldBookScreen() {
    const listEl = document.getElementById('world-book-list');
    listEl.innerHTML = '';

    // 1. åŒæ™‚ç²å–æ‰€æœ‰æ›¸ç±å’Œæ‰€æœ‰åˆ†é¡
    const [books, categories] = await Promise.all([
        db.worldBooks.toArray(),
        db.worldBookCategories.orderBy('name').toArray()
    ]);

    state.worldBooks = books; // ç¢ºä¿è¨˜æ†¶é«”ä¸­çš„è³‡æ–™æ˜¯åŒæ­¥çš„

    if (books.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">é»æ“Šå³ä¸Šè§’ "+" å‰µå»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œæ›¸</p>';
        return;
    }

    // 2. å°‡æ›¸ç±æŒ‰ categoryId åˆ†çµ„
    const groupedBooks = books.reduce((acc, book) => {
        const key = book.categoryId || 'uncategorized';
        if (!acc[key]) {
            acc[key] = [];
        }
        acc[key].push(book);
        return acc;
    }, {});

    // 3. å„ªå…ˆæ¸²æŸ“å·²åˆ†é¡çš„æ›¸ç±
    categories.forEach(category => {
        const booksInCategory = groupedBooks[category.id];
        if (booksInCategory && booksInCategory.length > 0) {
            const groupContainer = createWorldBookGroup(category.name, booksInCategory);
            listEl.appendChild(groupContainer);
        }
    });

    // 4. æœ€å¾Œæ¸²æŸ“æœªåˆ†é¡çš„æ›¸ç±
    const uncategorizedBooks = groupedBooks['uncategorized'];
    if (uncategorizedBooks && uncategorizedBooks.length > 0) {
        const groupContainer = createWorldBookGroup('æœªåˆ†é¡', uncategorizedBooks);
        listEl.appendChild(groupContainer);
    }
    
    // 5. ç‚ºæ‰€æœ‰åˆ†çµ„æ¨™é¡Œæ·»åŠ æŠ˜ç–Šäº‹ä»¶
    document.querySelectorAll('.world-book-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}

/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘å‰µå»ºä¸€å€‹åˆ†é¡çš„åˆ†çµ„DOM
 * @param {string} groupName - åˆ†é¡åç¨±
 * @param {Array} books - è©²åˆ†é¡ä¸‹çš„æ›¸ç±é™£åˆ—
 * @returns {HTMLElement} - å‰µå»ºå¥½çš„åˆ†çµ„å®¹å™¨
 */
function createWorldBookGroup(groupName, books) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'world-book-group-container';
    
    groupContainer.innerHTML = `
        <div class="world-book-group-header">
            <span class="arrow">â–¼</span>
            <span class="group-name">${groupName}</span>
        </div>
        <div class="world-book-group-content"></div>
    `;

    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
    const headerEl = groupContainer.querySelector('.world-book-group-header');
    const contentEl = groupContainer.querySelector('.world-book-group-content');
    
    // é è¨­çµ¦é ­éƒ¨å’Œå…§å®¹å€éƒ½åŠ ä¸Š collapsed é¡
    headerEl.classList.add('collapsed');
    contentEl.classList.add('collapsed');
    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

    books.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN'));
    books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.dataset.bookId = book.id;
        item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'æš«ç„¡å…§å®¹...').substring(0, 50)}</div>`;
        item.addEventListener('click', () => openWorldBookEditor(book.id));
        addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('åˆªé™¤ä¸–ç•Œæ›¸', `ç¢ºå®šè¦åˆªé™¤ã€Š${book.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } });
        contentEl.appendChild(item); 
    });

    return groupContainer;
}
        window.renderWorldBookScreenProxy = renderWorldBookScreen;

async function openWorldBookEditor(bookId) {
    editingWorldBookId = bookId;
    const [book, categories] = await Promise.all([
        db.worldBooks.get(bookId),
        db.worldBookCategories.toArray()
    ]);
    if (!book) return;

    document.getElementById('world-book-editor-title').textContent = book.name;
    document.getElementById('world-book-name-input').value = book.name;
    document.getElementById('world-book-content-input').value = book.content;

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¡«å……åˆ†é¡ä¸‹æ‹‰å¼åŠŸèƒ½è¡¨
    const selectEl = document.getElementById('world-book-category-select');
    selectEl.innerHTML = '<option value="">-- æœªåˆ†é¡ --</option>'; // é è¨­é¸é …
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        if (book.categoryId === cat.id) {
            option.selected = true; // é¸ä¸­ç•¶å‰åˆ†é¡
        }
        selectEl.appendChild(option);
    });

    showScreen('world-book-editor-screen');
}

        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">å¤§äººè«‹é»æ“Šå³ä¸Šè§’â€œæ·»åŠ â€æˆ–â€œä¸Šå‚³â€ä¾†æ·»åŠ ä½ çš„ç¬¬ä¸€å€‹è¡¨æƒ…å§ï¼</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { if (isSelectionMode) return; const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('åˆªé™¤è¡¨æƒ…', `ç¢ºå®šè¦åˆªé™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }
// â–¼â–¼â–¼ åœ¨ createMessageElement å‡½æ•¸çš„ã€æ­£ä¸Šæ–¹ã€‘ï¼Œé»è²¼é€™å€‹æ–°å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘å¾å¡ç‰‡é»æ“Šå¾Œï¼Œæ‰“é–‹æƒ…ä¾¶ç©ºé–“ä¸¦è·³è½‰åˆ°æŒ‡å®šé ç°½
 * @param {string} charId - è§’è‰²ID
 * @param {string} viewId - è¦è·³è½‰åˆ°çš„è¦–åœ–ID (ä¾‹å¦‚ 'ls-diary-view')
 */
function openLoversSpaceFromCard(charId, viewId) {
    // 1. æ‰“é–‹æŒ‡å®šè§’è‰²çš„æƒ…ä¾¶ç©ºé–“ä¸»ä»‹é¢
    openLoversSpace(charId);

    // 2. ç­‰å¾…ä¸€å°æœƒå…’ï¼Œç¢ºä¿ä»‹é¢å·²æ¸²æŸ“
    setTimeout(() => {
        // 3. æ‰¾åˆ°å°æ‡‰çš„é ç°½æŒ‰éˆ•ä¸¦é¡æ¯”é»æ“Šå®ƒ
        const targetTab = document.querySelector(`.ls-tab-item[data-view='${viewId}']`);
        if (targetTab) {
            targetTab.click();
        }
    }, 100); // 100æ¯«ç§’çš„å»¶é²é€šå¸¸è¶³å¤ äº†
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬æ›¿æ›èˆŠçš„ createMessageElement å‡½æ•¸ â–¼â–¼â–¼
function createMessageElement(msg, chat) {

    // â–¼â–¼â–¼ åœ¨å‡½æ•¸æœ€é–‹é ­ï¼Œæ·»åŠ é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
if (msg.type === 'recalled_message') {
    const wrapper = document.createElement('div');
    // 1. ã€æ ¸å¿ƒã€‘çµ¦ wrapper ä¹ŸåŠ ä¸Š timestampï¼Œæ–¹ä¾¿äº‹ä»¶å§”è¨—æ™‚æŸ¥æ‰¾
    wrapper.className = 'message-wrapper system-pat';
    wrapper.dataset.timestamp = msg.timestamp; 

    const bubble = document.createElement('div');
    // 2. ã€æ ¸å¿ƒã€‘è®“é€™å€‹å…ƒç´ åŒæ™‚æ“æœ‰ .message-bubble å’Œ .recalled-message-placeholder å…©å€‹class
    //    é€™æ¨£å®ƒæ—¢èƒ½è¢«é¸æ“‡ç³»çµ±è­˜åˆ¥ï¼Œåˆèƒ½ä¿æŒåŸæœ‰çš„å±…ä¸­ç°è‰²æ¨£å¼
    bubble.className = 'message-bubble recalled-message-placeholder';
    // 3. ã€æ ¸å¿ƒã€‘æŠŠ timestamp æ”¾åœ¨ bubble ä¸Šï¼Œé€™æ˜¯å¤šé¸é‚è¼¯çš„é—œéµ
    bubble.dataset.timestamp = msg.timestamp; 
    bubble.textContent = msg.content;
    
    wrapper.appendChild(bubble);
    
    // 4. ã€æ ¸å¿ƒã€‘ç‚ºå®ƒè£œä¸Šå’Œå…¶ä»–æ¶ˆæ¯ä¸€æ¨£çš„æ¨™æº–äº‹ä»¶ç›£è½å™¨
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
    wrapper.addEventListener('click', () => { 
        if (isSelectionMode) {
            toggleMessageSelection(msg.timestamp);
        }
    });

    // 5. ã€é‡è¦ã€‘åœ¨ä¹‹å‰çš„â€œé»æ“ŠæŸ¥çœ‹åŸæ–‡â€çš„é‚è¼¯ä¸­ï¼Œæˆ‘å€‘å·²ç¶“ä½¿ç”¨äº†äº‹ä»¶å§”è¨—ï¼Œæ‰€ä»¥é€™è£¡ä¸éœ€è¦å†å–®ç¨ç‚ºé€™å€‹å…ƒç´ æ·»åŠ é»æ“Šäº‹ä»¶äº†ã€‚
    //    init() å‡½æ•¸ä¸­çš„é‚£å€‹äº‹ä»¶ç›£è½å™¨æœƒè™•ç†å®ƒã€‚
    
    return wrapper;
}
    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

    if (msg.isHidden) {
        return null;
    }

    if (msg.type === 'pat_message') {
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper system-pat'; 
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble system-bubble'; 
        bubble.dataset.timestamp = msg.timestamp;
        bubble.textContent = msg.content;
        wrapper.appendChild(bubble);
        addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
        return wrapper;
    }

    const isUser = msg.role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;
// â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ§‹ã€‘â˜…â˜…â˜…
// é€™æ®µé‚è¼¯ç¾åœ¨ç”¨æ–¼æŸ¥æ‰¾æˆå“¡ç‰©ä»¶ï¼Œä¸¦é¡¯ç¤ºå…¶â€œç¾¤æ˜µç¨±â€
if (chat.isGroup && !isUser) {
    // 1. ä½¿ç”¨AIè¿”å›çš„â€œæœ¬åâ€(`msg.senderName`)å»æ¸…å–®è£¡æŸ¥æ‰¾æˆå“¡å°è±¡
    const member = chat.members.find(m => m.originalName === msg.senderName);
    
    // 2. å‰µå»ºç”¨æ–¼é¡¯ç¤ºåå­—çš„ div
    const senderNameDiv = document.createElement('div');
    senderNameDiv.className = 'sender-name';
    
    // 3. å¦‚æœæ‰¾åˆ°äº†æˆå“¡ï¼Œå°±é¡¯ç¤ºä»–çš„â€œç¾¤æ˜µç¨±â€ï¼›å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±é¡¯ç¤ºAIè¿”å›çš„â€œæœ¬åâ€ä½œç‚ºå‚™ç”¨
    senderNameDiv.textContent = member ? member.groupNickname : (msg.senderName || 'æœªçŸ¥æˆå“¡');
    
    wrapper.appendChild(senderNameDiv);
}

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
    bubble.dataset.timestamp = msg.timestamp;

    const timestampEl = document.createElement('span');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = formatTimestamp(msg.timestamp);

    // æ‰¾åˆ°ç¢ºå®š avatarSrc çš„é‚£æ®µä»£ç¢¼
    let avatarSrc, avatarFrameSrc = ''; // <--- è²æ˜å…©å€‹è®Šæ•¸
    if (chat.isGroup) {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || ''; // <--- ç²å–â€œæˆ‘â€çš„é ­åƒæ¡†
        } else {
            const member = chat.members.find(m => m.originalName === msg.senderName);
            avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
            avatarFrameSrc = member ? (member.avatarFrame || '') : ''; // <--- ç²å–æˆå“¡çš„é ­åƒæ¡†
        }
    } else {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || ''; // <--- ç²å–â€œæˆ‘â€çš„é ­åƒæ¡†
        } else {
            avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.aiAvatarFrame || ''; // <--- ç²å–AIçš„é ­åƒæ¡†
        }
    }

    // â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ•´å¡Šã€æ¢ä»¶æ¸²æŸ“é‚è¼¯ã€‘æ›¿æ›ä½ 7.23ç‰ˆä¸­ç°¡å–®çš„ avatarHtml è²æ˜ â–¼â–¼â–¼
    let avatarHtml;
    // å¦‚æœå­˜åœ¨é ­åƒæ¡†URL
    if (avatarFrameSrc) {
        avatarHtml = `
            <div class="avatar-with-frame">
                <img src="${avatarSrc}" class="avatar-img">
                <img src="${avatarFrameSrc}" class="avatar-frame">
            </div>
        `;
    } else {
    // å¦‚æœæ²’æœ‰ï¼Œå°±ä½¿ç”¨æœ€ç°¡å–®çš„é ­åƒçµæ§‹
        avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
    }
    // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

    let contentHtml;
    
    if (msg.type === 'share_link') {
        bubble.classList.add('is-link-share');
        
        // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å°‡ onclick="openBrowser(...)" ç§»é™¤ï¼Œæˆ‘å€‘å°‡åœ¨JSä¸­å‹•æ…‹ç¹«çµäº‹ä»¶
        contentHtml = `
            <div class="link-share-card" data-timestamp="${msg.timestamp}">
                <div class="title">${msg.title || 'ç„¡æ¨™é¡Œ'}</div>
                <div class="description">${msg.description || 'é»æ“ŠæŸ¥çœ‹è©³æƒ…...'}</div>
                <div class="footer">
                    <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span>${msg.source_name || 'é€£çµåˆ†äº«'}</span>
                </div>
            </div>
        `;
    }

else if (msg.type === 'share_card') {
    bubble.classList.add('is-link-share'); // è¤‡ç”¨é€£çµåˆ†äº«çš„å¡ç‰‡æ¨£å¼
    // ã€æ ¸å¿ƒã€‘æŠŠæ™‚é–“æˆ³è¨˜åŠ åˆ°å¡ç‰‡ä¸Šï¼Œæ–¹ä¾¿å¾Œéºµé»æ“Šæ™‚è­˜åˆ¥
    contentHtml = `
        <div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}">
            <div class="title">${msg.payload.title}</div>
            <div class="description">å…± ${msg.payload.sharedHistory.length} æ¢æ¶ˆæ¯</div>
            <div class="footer">
                <svg class="footer-icon" ...>...</svg> <!-- è¤‡ç”¨é€£çµåˆ†äº«çš„åœ–ç¤º -->
                <span>èŠå¤©è¨˜éŒ„</span>
            </div>
        </div>
    `;
}
// åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼

else if (msg.type === 'repost_forum_post') {
    bubble.classList.add('is-link-share'); // è¤‡ç”¨é€£çµåˆ†äº«çš„æ¨£å¼ï¼Œçœäº‹ï¼
    const postPayload = msg.payload;
    // ã€æ ¸å¿ƒã€‘æŠŠå¸–å­çš„IDå­˜åˆ°å¡ç‰‡çš„ data-post-id å±¬æ€§è£¡ï¼Œæ–¹ä¾¿ä»¥å¾Œé»æ“Šè·³è½‰
    contentHtml = `
        <div class="link-share-card" style="cursor: pointer;" data-post-id="${postPayload.postId}">
            <div class="title">ã€å°çµ„å¸–å­ã€‘${postPayload.title}</div>
            <div class="description">${postPayload.content}</div>
            <div class="footer">
                <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 12c0-5.25-4.25-9.5-9.5-9.5S2.5 6.75 2.5 12s4.25 9.5 9.5 9.5c.35 0 .69-.02 1.03-.06"></path><path d="M18.5 12.5c0-1.66-1.34-3-3-3s-3 1.34-3 3 1.34 3 3 3c.83 0 1.58-.34 2.12-.88"></path></svg>
                <span>ä¾†è‡ªå°çµ„çš„åˆ†äº«</span>
            </div>
        </div>
    `;
}



// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ 'cart_share_request' é‚è¼¯ â–¼â–¼â–¼
else if (msg.type === 'cart_share_request') {
    bubble.classList.add('is-cart-share-request');
    const payload = msg.payload; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘ç¾åœ¨ç›´æ¥å¾ payload å–è³‡æ–™
    let statusText = 'ç­‰å¾…å°æ–¹è™•ç†...';
    let cardClass = '';

    if (payload.status === 'paid') {
        statusText = 'å°æ–¹å·²ç‚ºä½ è²·å–®';
        cardClass = 'paid';
    } else if (payload.status === 'rejected') {
        statusText = 'å°æ–¹æ‹’çµ•äº†ä½ çš„è«‹æ±‚';
        cardClass = 'rejected';
    }
    
    contentHtml = `
        <div class="cart-share-card ${cardClass}">
            <div class="cart-share-header">
                <div class="icon">ğŸ›’</div>
                <div class="title">è³¼ç‰©è»Šä»£ä»˜è«‹æ±‚</div>
            </div>
            <div class="cart-share-body">
                <div class="label">å…± ${payload.itemCount} ä»¶å•†å“ï¼Œåˆè¨ˆ</div>
                <div class="amount">Â¥${payload.totalPrice.toFixed(2)}</div>
                <div class="status-text">${statusText}</div>
            </div>
        </div>
    `;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ createMessageElement å‡½æ•¸è£¡ï¼Œæ·»åŠ é€™å€‹æ–°çš„ else if åˆ†æ”¯ â–¼â–¼â–¼

// â–¼â–¼â–¼ åœ¨ createMessageElement å‡½æ•¸è£¡ï¼Œç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ gift_notification é‚è¼¯ â–¼â–¼â–¼

else if (msg.type === 'gift_notification') {
    bubble.classList.add('is-gift-notification'); // æ‡‰ç”¨é€æ˜æ°£æ³¡æ¨£å¼
    const payload = msg.payload;
    
    // ã€æ ¸å¿ƒã€‘åœ¨é€™è£¡æ§‹å»ºå¡ç‰‡çš„å®Œæ•´HTMLå…§å®¹
    contentHtml = `
        <div class="gift-card">
            <div class="gift-card-header">
                <div class="icon">ğŸ</div>
                <!-- 1. æ¸…æ™°æŒ‡æ˜æ˜¯èª°é€çš„ç¦®ç‰© -->
                <div class="title">ä¸€ä»½ä¾†è‡ª ${payload.senderName} çš„ç¦®ç‰©</div>
            </div>
            <div class="gift-card-body">
                <p class="greeting">é€™æ˜¯æˆ‘ç‚ºä½ æŒ‘é¸çš„ç¦®ç‰©ï¼Œå¸Œæœ›ä½ å–œæ­¡ï¼</p>
                <!-- 2. æ¸…æ™°åˆ—å‡ºæœ‰ä»€éº¼å•†å“ -->
                <div class="gift-card-items">
                    <strong>å•†å“åˆ—è¡¨:</strong><br>
                    ${payload.itemSummary.replace(/ã€/g, '<br>')} <!-- å°‡é “è™Ÿæ›¿æ›ç‚ºæ›è¡Œï¼Œè®“åˆ—è¡¨æ›´æ¸…æ™° -->
                </div>
                <!-- 3. æ¸…æ™°æ¨™æ˜ç¸½é‡‘é¡ -->
                <div class="gift-card-footer">
                    å…± ${payload.itemCount} ä»¶ï¼Œåˆè¨ˆ: <span class="total-price">Â¥${payload.totalPrice.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€SVGç”Ÿæˆç‰ˆã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ location 'else if' å¡Š â–¼â–¼â–¼
else if (msg.type === 'location') {
    bubble.classList.add('is-location');
    
    const currentChat = state.chats[state.activeChatId] || Object.values(state.chats).find(c => c.history.some(h => h.timestamp === msg.timestamp));
    const myNickname = currentChat.settings.myNickname || 'æˆ‘';
    const aiNickname = currentChat.name;

    // --- SVG å‹•æ…‹ç”Ÿæˆ ---
    const trajectoryPoints = msg.trajectoryPoints || [];
    const hasTrajectory = trajectoryPoints.length > 0;
    
    // 1. å®šç¾©SVGè·¯å¾‘å’Œåº§æ¨™
    const pathData = "M 20 45 Q 115 10 210 45"; // ä¸€æ¢é è¨­çš„å„ªç¾æ›²ç·š
    const startPoint = { x: 20, y: 45 };
    const endPoint = { x: 210, y: 45 };

    // 2. ç”Ÿæˆèµ·é»å’Œçµ‚é»çš„SVGå…ƒç´ 
    let pinsSvg = '';
    if (msg.userLocation) {
        pinsSvg += `<circle class="svg-pin user-pin" cx="${startPoint.x}" cy="${startPoint.y}" r="6" />`;
    }
    if (msg.aiLocation) {
        pinsSvg += `<circle class="svg-pin ai-pin" cx="${endPoint.x}" cy="${endPoint.y}" r="6" />`;
    }

    // 3. å¦‚æœæœ‰è»Œè·¡ï¼Œç”Ÿæˆé€”ç¶“é»çš„SVGå…ƒç´ 
    let trajectorySvg = '';

if (hasTrajectory) {
    // --- â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ä½¿ç”¨æµè¦½å™¨APIç²¾ç¢ºè¨ˆç®—åº§æ¨™ â–¼â–¼â–¼ ---

    // 1. å®šç¾©æˆ‘å€‘çš„Så½¢æ›²ç·šè·¯å¾‘è³‡æ–™ (ä¸è®Š)
    const s_curve_pathData = "M 20 45 C 80 70, 150 20, 210 45";
    trajectorySvg += `<path class="svg-trajectory-path" d="${s_curve_pathData}" />`;

    // 2. ã€æ ¸å¿ƒã€‘åœ¨è¨˜æ†¶é«”ä¸­å‰µå»ºä¸€å€‹çœŸå¯¦çš„SVGè·¯å¾‘å…ƒç´ ï¼Œä»¥ä¾¿ä½¿ç”¨API
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', s_curve_pathData);
    
    // 3. ç²å–é€™æ¢è·¯å¾‘çš„ç¸½é•·åº¦
    const totalPathLength = path.getTotalLength();
    
    const totalPoints = trajectoryPoints.length;
    trajectoryPoints.forEach((point, index) => {
        // 4. è¨ˆç®—æ¯å€‹é»æ‡‰è©²åœ¨è·¯å¾‘ç¸½é•·åº¦çš„å“ªå€‹ä½ç½®
        const progress = (index + 1) / (totalPoints + 1);
        const lengthOnPath = totalPathLength * progress;
        
        // 5. ã€é­”æ³•åœ¨é€™è£¡ï¼ã€‘ç›´æ¥å‘æµè¦½å™¨æŸ¥è©¢é€™å€‹ä½ç½®çš„ç²¾ç¢ºåº§æ¨™
        const pointOnPath = path.getPointAtLength(lengthOnPath);
        const pointX = pointOnPath.x;
        const pointY = pointOnPath.y;

        // 6. å¾ŒçºŒçš„â€œä¸€ä¸Šä¸€ä¸‹â€ä½ˆå±€é‚è¼¯ä¿æŒä¸è®Š
        let yOffset;
        if (index % 2 === 0) { // ç¬¬1, 3...å€‹é»
            yOffset = 18; // å‘ä¸‹
        } else { // ç¬¬2, 4...å€‹é»
            yOffset = -10; // å‘ä¸Š
        }

        const footprintY = pointY + yOffset;
        const labelY = footprintY + (yOffset > 0 ? 12 : -12);

        // 7. ä½¿ç”¨100%ç²¾ç¢ºçš„åº§æ¨™ç”ŸæˆSVG
        trajectorySvg += `
            <text class="svg-footprint" x="${pointX}" y="${footprintY}" text-anchor="middle">ğŸ¾</text>
            <text class="svg-location-label" x="${pointX}" y="${labelY}" text-anchor="middle">${point.name}</text>
        `;
    });
    // --- â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² ---
}
    
    // 4. æ§‹å»ºåœ°é»è³‡è¨ŠHTML
    const userLocationHtml = `<p class="${!msg.userLocation ? 'hidden' : ''}"><span class="name-tag">${myNickname}:</span> ${msg.userLocation}</p>`;
    const aiLocationHtml = `<p class="${!msg.aiLocation ? 'hidden' : ''}"><span class="name-tag">${aiNickname}:</span> ${msg.aiLocation}</p>`;

    // 5. æ‹¼æ¥æœ€çµ‚çš„ contentHtml
    contentHtml = `
        <div class="location-card">
            <div class="location-map-area">
                <svg viewBox="0 0 230 90">
                    ${trajectorySvg}
                    ${pinsSvg}
                </svg>
            </div>
            <div class="location-info">
                <div class="location-address">
                    ${aiLocationHtml}
                    ${userLocationHtml}
                </div>
                <div class="location-distance">ç›¸è· ${msg.distance}</div>
            </div>
        </div>
    `;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

    // å¾ŒçºŒçš„å…¶ä»– else if ä¿æŒä¸è®Š
    else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
        bubble.classList.add('is-ai-image');
        const altText = msg.type === 'user_photo' ? "ç”¨æˆ¶æè¿°çš„ç…§ç‰‡" : "AIç”Ÿæˆçš„åœ–ç‰‡";
        contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
    } else if (msg.type === 'voice_message') {
    bubble.classList.add('is-voice-message');
    
    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å°‡èªéŸ³åŸæ–‡å­˜å„²åœ¨çˆ¶ç´šæ°£æ³¡çš„ data-* å±¬æ€§ä¸­ï¼Œæ–¹ä¾¿äº‹ä»¶è™•ç†å™¨ç²å–
    bubble.dataset.voiceText = msg.content;
    
    const duration = Math.max(1, Math.round((msg.content || '').length / 5));
    const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
    const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
    
    // ã€æ ¸å¿ƒä¿®æ­£2ã€‘æ§‹å»ºåŒ…å«æ‰€æœ‰æ–°å…ƒç´ çš„å®Œæ•´ HTML
    contentHtml = `
        <div class="voice-message-body">
            <div class="voice-waveform">${waveformHTML}</div>
            <div class="loading-spinner"></div>
            <span class="voice-duration">${durationFormatted}</span>
        </div>
        <div class="voice-transcript"></div>
    `;
} else if (msg.type === 'transfer') {
    bubble.classList.add('is-transfer');
    
    let titleText, noteText;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';

    if (isUser) { // æ¶ˆæ¯æ˜¯ä½¿ç”¨è€…ç™¼å‡ºçš„
        if (msg.isRefund) {
            // ç”¨æˆ¶ç™¼å‡ºçš„é€€æ¬¾ï¼ˆå³ç”¨æˆ¶æ‹’æ”¶äº†AIçš„è½‰å¸³ï¼‰
            titleText = `é€€æ¬¾çµ¦ ${chat.name}`;
            noteText = 'å·²æ‹’æ”¶å°æ–¹è½‰å¸³';
        } else {
            // ç”¨æˆ¶ä¸»å‹•ç™¼èµ·çš„è½‰å¸³
            titleText = `è½‰å¸³çµ¦ ${msg.receiverName || chat.name}`;
            if (msg.status === 'accepted') {
                noteText = 'å°æ–¹å·²æ”¶æ¬¾';
            } else if (msg.status === 'declined') {
                noteText = 'å°æ–¹å·²æ‹’æ”¶';
            } else {
                noteText = msg.note || 'ç­‰å¾…å°æ–¹è™•ç†...';
            }
        }
    } else { // æ¶ˆæ¯æ˜¯ AI ç™¼å‡ºçš„
        if (msg.isRefund) {
            // AI çš„é€€æ¬¾ï¼ˆAI æ‹’æ”¶äº†ç”¨æˆ¶çš„è½‰å¸³ï¼‰
            titleText = `é€€æ¬¾ä¾†è‡ª ${msg.senderName}`;
            noteText = 'è½‰å¸³å·²è¢«æ‹’æ”¶';
        } else if (msg.receiverName === myNickname) {
            // ã€æ ¸å¿ƒä¿®æ­£1ã€‘é€™æ˜¯ AI ä¸»å‹•çµ¦ç”¨æˆ¶çš„è½‰å¸³
            titleText = `è½‰å¸³çµ¦ ${myNickname}`;
             if (msg.status === 'accepted') {
                noteText = 'ä½ å·²æ”¶æ¬¾';
            } else if (msg.status === 'declined') {
                noteText = 'ä½ å·²æ‹’æ”¶';
            } else {
                // é€™æ˜¯ä½¿ç”¨è€…éœ€è¦è™•ç†çš„è½‰å¸³
                bubble.style.cursor = 'pointer';
                bubble.dataset.status = 'pending';
                noteText = msg.note || 'é»æ“Šè™•ç†';
            }
        } else {
            // ã€æ ¸å¿ƒä¿®æ­£2ã€‘é€™æ˜¯ AI ç™¼çµ¦ç¾¤è£¡å…¶ä»–äººçš„è½‰å¸³ï¼Œå°ç•¶å‰ç”¨æˆ¶ä¾†èªªåªæ˜¯ä¸€å€‹é€šçŸ¥
            titleText = `è½‰å¸³: ${msg.senderName} â†’ ${msg.receiverName}`;
            noteText = msg.note || 'ç¾¤èŠå…§è½‰å¸³';
        }
    }

    const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
        
    contentHtml = `
        <div class="transfer-card">
            <div class="transfer-title">${heartIcon} ${titleText}</div>
            <div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div>
            <div class.transfer-note">${noteText}</div>
        </div>
    `;
} else if (msg.type === 'waimai_request') {
        bubble.classList.add('is-waimai-request');
        if (msg.status === 'paid' || msg.status === 'rejected') {
            bubble.classList.add(`status-${msg.status}`);
        }
        let displayName;
        // å¦‚æœæ˜¯ç¾¤èŠ
        if (chat.isGroup) {
            // å°±åŸ·è¡ŒåŸä¾†çš„é‚è¼¯ï¼šåœ¨æˆå“¡åˆ—è¡¨è£¡æŸ¥æ‰¾æ˜µç¨±
            const member = chat.members.find(m => m.originalName === msg.senderName);
            displayName = member ? member.groupNickname : msg.senderName;
        } else {
            // å¦å‰‡ï¼ˆæ˜¯å–®èŠï¼‰ï¼Œç›´æ¥ä½¿ç”¨èŠå¤©ç‰©ä»¶çš„åç¨±
            displayName = chat.name;
        }
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æˆ‘å€‘å‰›å‰›æŸ¥æ‰¾åˆ°çš„ displayName
        const requestTitle = `ä¾†è‡ª ${displayName} çš„ä»£ä»˜è«‹æ±‚`;
        let actionButtonsHtml = '';
        if (msg.status === 'pending' && !isUser) {
            actionButtonsHtml = `
                <div class="waimai-user-actions">
                    <button class="waimai-decline-btn" data-choice="rejected">æ®˜å¿æ‹’çµ•</button>
                    <button class="waimai-pay-btn" data-choice="paid">ç‚ºTaè²·å–®</button>
                </div>`;
        }
        contentHtml = `
            <div class="waimai-card">
                <div class="waimai-header">
                    <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                    <div class="title-group">
                        <span class="brand">ç¾åœ˜å¤–è³£</span><span class="separator">|</span><span>å¤–è³£ç¾é£Ÿ</span>
                    </div>
                </div>
                <div class="waimai-catchphrase">Hiï¼Œä½ å’Œæˆ‘çš„è·é›¢åªå·®ä¸€é “å¤–è³£ï½</div>
                <div class="waimai-main">
                    <div class="request-title">${requestTitle}</div>
                    <div class="payment-box">
                        <div class="payment-label">éœ€ä»˜æ¬¾</div>
                        <div class="amount">Â¥${Number(msg.amount).toFixed(2)}</div>
                        <div class="countdown-label">å‰©é¤˜æ”¯ä»˜æ™‚é–“
                            <div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div>
                        </div>
                    </div>
                    <button class="waimai-details-btn">æŸ¥çœ‹è©³æƒ…</button>
                </div>
                ${actionButtonsHtml}
            </div>`;
        
        setTimeout(() => {
            const timerEl = document.getElementById(`waimai-timer-${msg.timestamp}`);
            if (timerEl && msg.countdownEndTime) {
                if (waimaiTimers[msg.timestamp]) clearInterval(waimaiTimers[msg.timestamp]);
                if (msg.status === 'pending') {
                    waimaiTimers[msg.timestamp] = startWaimaiCountdown(timerEl, msg.countdownEndTime);
                } else {
                    timerEl.innerHTML = `<span>å·²</span><span>è™•</span><span>ç†</span>`;
                }
            }
            const detailsBtn = document.querySelector(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-details-btn`);
            if (detailsBtn) {
                detailsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paidByText = msg.paidBy ? `<br><br><b>ç‹€æ…‹ï¼š</b>ç”± ${msg.paidBy} ç‚ºæ‚¨ä»£ä»˜æˆåŠŸ` : '';
                    showCustomAlert('è¨‚å–®è©³æƒ…', `<b>å•†å“ï¼š</b>${msg.productInfo}<br><b>é‡‘é¡ï¼š</b>Â¥${Number(msg.amount).toFixed(2)}${paidByText}`);
                });
            }
            const actionButtons = document.querySelectorAll(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-user-actions button`);
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const choice = e.target.dataset.choice;
                    handleWaimaiResponse(msg.timestamp, choice);
                });
            });
        }, 0);

} else if (msg.type === 'red_packet') {
    bubble.classList.add('is-red-packet');
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // å¾æœ€æ–°çš„ msg ç‰©ä»¶ä¸­ç²å–ç‹€æ…‹
    const hasClaimed = msg.claimedBy && msg.claimedBy[myNickname];
    const isFinished = msg.isFullyClaimed;

    let cardClass = '';
    let claimedInfoHtml = '';
    let typeText = 'æ‹¼æ‰‹æ°£ç´…åŒ…';

    // 1. åˆ¤æ–·ç´…åŒ…å¡ç‰‡çš„æ¨£å¼ (é¡è‰²)
    if (isFinished) {
        cardClass = 'opened';
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        cardClass = 'opened'; // å°ˆå±¬ç´…åŒ…è¢«é ˜äº†ä¹Ÿè®Šç°
    }
    
    // 2. åˆ¤æ–·ç´…åŒ…ä¸‹æ–¹çš„æç¤ºæ–‡å­—
    if (msg.packetType === 'direct') {
        typeText = `å°ˆå±¬ç´…åŒ…: çµ¦ ${msg.receiverName}`;
    }
    
    if (hasClaimed) {
        claimedInfoHtml = `<div class="rp-claimed-info">ä½ é ˜å–äº†ç´…åŒ…ï¼Œé‡‘é¡ ${msg.claimedBy[myNickname].toFixed(2)} å…ƒ</div>`;
    } else if (isFinished) {
        claimedInfoHtml = `<div class="rp-claimed-info">ç´…åŒ…å·²è¢«é ˜å®Œ</div>`;
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        claimedInfoHtml = `<div class="rp-claimed-info">å·²è¢« ${msg.receiverName} é ˜å–</div>`;
    }

    // 3. æ‹¼æ¥æœ€çµ‚çš„HTMLï¼Œç¢ºä¿onclickèª¿ç”¨çš„æ˜¯æˆ‘å€‘è¨»å†Šåˆ°å…¨åŸŸçš„å‡½æ•¸
    contentHtml = `
        <div class="red-packet-card ${cardClass}">
            <div class="rp-header">
                <img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon">
                <span class="rp-greeting">${msg.greeting || 'æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©ï¼'}</span>
            </div>
            <div class="rp-type">${typeText}</div>
            ${claimedInfoHtml}
        </div>
    `;
// â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

    } // â–¼â–¼â–¼ åœ¨ else if (msg.type === 'share_link') { ... } ä¹‹å¾Œï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼ â–¼â–¼â–¼
// â–¼â–¼â–¼ åœ¨ else if (msg.type === 'lovers_space_invitation') çš„ã€æ­£ä¸Šæ–¹ã€‘ï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼
else if (msg.type === 'ls_diary_notification') {
    bubble.classList.add('is-ls-diary-notification'); // æ‡‰ç”¨é€æ˜æ°£æ³¡æ¨£å¼
    const cardData = msg.content;
    
    // ã€æ ¸å¿ƒã€‘åœ¨é€™è£¡èª¿ç”¨æˆ‘å€‘å‰›å‰›å‰µå»ºçš„ openLoversSpaceFromCard å‡½æ•¸
    contentHtml = `
        <div class="ls-diary-notification-card" onclick="openLoversSpaceFromCard('${chat.id}', 'ls-diary-view')">
            <div class="ls-diary-card-header">
                <span>${cardData.userEmoji || 'ğŸ’Œ'}</span>
                <span>ä¸€å°ä¾†è‡ªå¿ƒæƒ…æ—¥è¨˜çš„æé†’</span>
            </div>
            <div class="ls-diary-card-body">
                <p>${cardData.text}</p>
            </div>
            <div class="ls-diary-card-footer">
                é»æ“ŠæŸ¥çœ‹ â†’
            </div>
        </div>
    `;
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

    else if (msg.type === 'lovers_space_invitation') {
        bubble.classList.add('is-waimai-request'); // è¤‡ç”¨å¤–è³£å¡ç‰‡çš„æ¨£å¼ï¼Œå¾ˆæ–¹ä¾¿ï¼
        const isUserSender = msg.role === 'user';
        const senderName = isUserSender ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
        const receiverName = isUserSender ? chat.name : (chat.settings.myNickname || 'æˆ‘');
        
        let cardContent = '';
        
        switch(msg.status) {
            case 'pending':
                if (isUserSender) {
                    // ç”¨æˆ¶ç™¼å‡ºçš„ï¼Œç­‰å¾…å°æ–¹å›æ‡‰
                    cardContent = `
                        <div class="waimai-main" style="background-color: #f0f8ff;">
                            <div class="request-title" style="color: #333;">å·²å‘ ${receiverName} ç™¼å‡ºé‚€è«‹</div>
                            <p style="font-size:14px; color:#555; margin:15px 0;">ç­‰å¾…å°æ–¹åŒæ„...</p>
                        </div>`;
                } else {
                    // ä½¿ç”¨è€…æ”¶åˆ°çš„ï¼Œéœ€è¦ä½¿ç”¨è€…å›æ‡‰
                    cardContent = `
                        <div class="waimai-main" style="background-color: #fff0f5;">
                            <div class="request-title" style="color: #d63384;">${senderName} é‚€è«‹ä½ é–‹å•Ÿæƒ…ä¾¶ç©ºé–“</div>
                            <p style="font-size:14px; color:#555; margin:15px 0;">é–‹å•Ÿå¾Œå¯ä»¥è¨˜éŒ„ä½ å€‘çš„å°ˆå±¬å›æ†¶å“¦~</p>
                        </div>
                        <div class="waimai-user-actions">
                            <button class="waimai-decline-btn" data-choice="rejected">æ®˜å¿æ‹’çµ•</button>
                            <button class="waimai-pay-btn" data-choice="accepted" style="background-color: #d63384; border-color: #b02a6e;">ç«‹å³é–‹å•Ÿ</button>
                        </div>`;
                }
                break;
            case 'accepted':
                cardContent = `
                    <div class="waimai-main" style="background-color: #e6ffed;">
                        <div class="request-title" style="color: #198754;">âœ… é‚€è«‹å·²åŒæ„</div>
                        <p style="font-size:14px; color:#555; margin:15px 0;">ä½ å€‘çš„æƒ…ä¾¶ç©ºé–“å·²æˆåŠŸé–‹å•Ÿï¼</p>
                    </div>`;
                break;
            case 'rejected':
                 cardContent = `
                    <div class="waimai-main" style="background-color: #f8d7da;">
                        <div class="request-title" style="color: #842029;">âŒ é‚€è«‹è¢«æ‹’çµ•</div>
                    </div>`;
                break;
        }

        contentHtml = `
            <div class="waimai-card">
                <div class="waimai-header">
                    <span class="icon" style="font-size: 20px;">ğŸ’Œ</span>
                    <div class="title-group"><span class="brand">æƒ…ä¾¶ç©ºé–“é‚€è«‹</span></div>
                </div>
                ${cardContent}
            </div>`;
    }

    // â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
    else if (msg.type === 'poll') {
    bubble.classList.add('is-poll');
    
    let totalVotes = 0;
    const voteCounts = {};

    // è¨ˆç®—ç¸½ç¥¨æ•¸å’Œæ¯å€‹é¸é …çš„ç¥¨æ•¸
    for (const option in msg.votes) {
        const count = msg.votes[option].length;
        voteCounts[option] = count;
        totalVotes += count;
    }

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    let myVote = null;
    for (const option in msg.votes) {
        if (msg.votes[option].includes(myNickname)) {
            myVote = option;
            break;
        }
    }

    let optionsHtml = '<div class="poll-options-list">';
    msg.options.forEach(optionText => {
        const count = voteCounts[optionText] || 0;
        const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
        const isVotedByMe = myVote === optionText;

        optionsHtml += `
            <div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}">
                <div class="poll-option-bar" style="width: ${percentage}%;"></div>
                <div class="poll-option-content">
                    <span class="poll-option-text">${optionText}</span>
                    <span class="poll-option-votes">${count} ç¥¨</span>
                </div>
            </div>
        `;
    });
    optionsHtml += '</div>';
    
    let footerHtml = '';
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡çµ±ä¸€æŒ‰éˆ•çš„é¡¯ç¤ºé‚è¼¯
    if (msg.isClosed) {
        // å¦‚æœæŠ•ç¥¨å·²çµæŸï¼Œç¸½æ˜¯é¡¯ç¤ºâ€œæŸ¥çœ‹çµæœâ€
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">æŸ¥çœ‹çµæœ</button></div>`;
    } else {
        // å¦‚æœæŠ•ç¥¨æœªçµæŸï¼Œç¸½æ˜¯é¡¯ç¤ºâ€œçµæŸæŠ•ç¥¨â€
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">çµæŸæŠ•ç¥¨</button></div>`;
    }

    contentHtml = `
        <div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}">
            <div class="poll-question">${msg.question}</div>
            ${optionsHtml}
            ${footerHtml}
        </div>
    `;
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

    // â–¼â–¼â–¼ ç¬¬4æ­¥ ä¿®æ”¹é» â–¼â–¼â–¼
    // ã€æ–°å¢ã€‘å„ªå…ˆè™•ç†æˆ‘å€‘å®šç¾©çš„æ–°ç‰ˆè§’è‰²è¡¨æƒ…åŒ…æ ¼å¼
      }
// â–¼â–¼â–¼ åœ¨ createMessageElement å‡½æ•¸è£¡ï¼Œç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ tarot_reading é‚è¼¯ â–¼â–¼â–¼
else if (msg.type === 'tarot_reading') {
    bubble.classList.add('is-tarot-reading');
    const reading = msg.payload;
    let cardsText = reading.cards.map(card => {
        return `[${card.position}] ${card.name} ${card.isReversed ? '(é€†ä½)' : ''}`;
    }).join('\n');

    contentHtml = `
        <div class="tarot-reading-card">
            <div class="tarot-reading-header">
                <div class="question">${reading.question}</div>
                <div class="spread">${reading.spread.name}</div>
            </div>
            <div class="tarot-reading-body">
                ${cardsText}
            </div>
        </div>
    `;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²




      else if (msg.type === 'sticker' && msg.content) {
        bubble.classList.add('is-sticker');
        // ç›´æ¥å¾æ¶ˆæ¯ç‰©ä»¶ä¸­ç²å– url å’Œ meaning
        contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
    }
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
    
    // èˆŠçš„é‚è¼¯ä¿æŒä¸è®Šï¼Œä½œç‚ºç›¸å®¹
    else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        bubble.classList.add('is-sticker');
        contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {

        bubble.classList.add('has-image');
        const imageUrl = msg.content[0].image_url.url;
        contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
    } else {
        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
    }

// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®æ­£ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„å¼•ç”¨æ¸²æŸ“é‚è¼¯ â–¼â–¼â–¼

// 1. ã€çµ±ä¸€é‚è¼¯ã€‘æª¢æŸ¥æ¶ˆæ¯ç‰©ä»¶ä¸­æ˜¯å¦å­˜åœ¨å¼•ç”¨è³‡è¨Š (msg.quote)
let quoteHtml = '';
// ç„¡è«–æ˜¯ä½¿ç”¨è€…æ¶ˆæ¯é‚„æ˜¯AIæ¶ˆæ¯ï¼Œåªè¦å®ƒåŒ…å«äº† .quote ç‰©ä»¶ï¼Œå°±åŸ·è¡Œé€™æ®µé‚è¼¯
if (msg.quote) {
    // a. ã€æ ¸å¿ƒä¿®æ­£ã€‘ç›´æ¥ç²å–å®Œæ•´çš„ã€æœªç¶“æˆªæ–·çš„å¼•ç”¨å…§å®¹
    const fullQuotedContent = String(msg.quote.content || '');
    
    // b. æ§‹å»ºå¼•ç”¨å¡Šçš„HTML
    quoteHtml = `
        <div class="quoted-message">
            <div class="quoted-sender">å›å¾© ${msg.quote.senderName}:</div>
            <div class="quoted-content">${fullQuotedContent}</div>
        </div>
    `;
}

// 2. æ‹¼æ¥æœ€çµ‚çš„æ°£æ³¡å…§å®¹
//    å°‡æ§‹å»ºå¥½çš„ quoteHtml (å¦‚æœå­˜åœ¨) å’Œ contentHtml çµ„åˆèµ·ä¾†
    // --- ã€æœ€çµ‚æ­£ç¢ºçµæ§‹ã€‘å°‡é ­åƒå’Œå…§å®¹éƒ½æ”¾å›æ°£æ³¡å…§éƒ¨ ---
    bubble.innerHTML = `
        ${avatarHtml}
        <div class="content">
            ${quoteHtml}
            ${contentHtml}
        </div>
    `;
    
    // --- ã€æœ€çµ‚æ­£ç¢ºçµæ§‹ã€‘å°‡å®Œæ•´çš„â€œæ°£æ³¡â€å’Œâ€œæ™‚é–“æˆ³è¨˜â€æ”¾å…¥å®¹å™¨ ---
    wrapper.appendChild(bubble);
    wrapper.appendChild(timestampEl);
    
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });

if (!isUser) {
    const avatarEl = wrapper.querySelector('.avatar, .avatar-with-frame'); 
    if (avatarEl) {
        avatarEl.style.cursor = 'pointer';
        avatarEl.addEventListener('click', (e) => {    
            e.stopPropagation();
            const characterName = chat.isGroup ? msg.senderName : chat.name;
            handleUserPat(chat.id, characterName);
        });
    }
}

return wrapper;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); 

    if (!messageEl) return; // <--- æ–°å¢é€™è¡Œï¼ŒåŒæ¨£çš„è™•ç†

const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å¸¶å‹•ç•«çš„ç‰ˆæœ¬ã€‘æ›¿æ›ä½ åŸä¾†çš„ appendMessage å‡½æ•¸ â–¼â–¼â–¼
function appendMessage(msg, chat, isInitialLoad = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageEl = createMessageElement(msg, chat);

    if (!messageEl) return; // å¦‚æœæ¶ˆæ¯æ˜¯éš±è—çš„ï¼Œå‰‡ä¸è™•ç†

    // ã€æ ¸å¿ƒã€‘åªå°æ–°æ¶ˆæ¯æ·»åŠ å‹•ç•«ï¼Œä¸å°åˆå§‹è¼‰å…¥çš„æ¶ˆæ¯æ·»åŠ 
    if (!isInitialLoad) {
        messageEl.classList.add('animate-in');
    }
  
    const typingIndicator = document.getElementById('typing-indicator');
    messagesContainer.insertBefore(messageEl, typingIndicator);
    
    if (!isInitialLoad) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        currentRenderedCount++;
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

async function openChat(chatId) {
    state.activeChatId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return; // å®‰å…¨æª¢æŸ¥

    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨é€™è£¡å°‡æœªè®€æ•¸æ¸…é›¶
    if (chat.unreadCount > 0) {
        chat.unreadCount = 0;
        await db.chats.put(chat); // åˆ¥å¿˜äº†æŠŠé€™å€‹æ”¹è®ŠåŒæ­¥åˆ°è³‡æ–™åº«
        // æˆ‘å€‘ç¨å¾Œæœƒåœ¨æ¸²æŸ“åˆ—è¡¨æ™‚é‡æ–°æ¸²æŸ“ï¼Œæ‰€ä»¥é€™è£¡ä¸éœ€è¦ç«‹å³é‡ç¹ªæ¸…å–®
    }

    renderChatInterface(chatId);
    showScreen('chat-interface-screen');
    window.updateListenTogetherIconProxy(state.activeChatId);
    toggleCallButtons(chat.isGroup || false);    
// ã€å¿ƒè²åŠŸèƒ½ã€‘æ ¹æ“šæ˜¯å¦ç‚ºå–®èŠï¼Œé¡¯ç¤ºæˆ–éš±è—å¿ƒå½¢æŒ‰éˆ•
document.getElementById('char-heart-btn').style.display = chat.isGroup ? 'none' : 'inline-flex';

    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        console.log(`æª¢æ¸¬åˆ°å¥½å‹ç”³è«‹å¾…è™•ç†ç‹€æ…‹ï¼Œç‚ºè§’è‰² "${chat.name}" è‡ªå‹•è§¸ç™¼AIå›æ‡‰...`);
        triggerAiResponse();
    }
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘æ ¹æ“šæ˜¯å¦ç‚ºç¾¤èŠï¼Œé¡¯ç¤ºæˆ–éš±è—æŠ•ç¥¨æŒ‰éˆ•
    document.getElementById('send-poll-btn').style.display = chat.isGroup ? 'flex' : 'none';
    document.getElementById('pet-action-btn').style.display = chat.isGroup ? 'none' : 'flex';
    startPetDecayTimer(); 
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–°è¼”åŠ©å‡½æ•¸ã€‘æ ¼å¼åŒ–å–®æ¢æ¶ˆæ¯ï¼Œç”¨æ–¼è¨˜æ†¶äº’é€šçš„ä¸Šä¸‹æ–‡
 * @param {object} msg - æ¶ˆæ¯ç‰©ä»¶
 * @param {object} chat - è©²æ¶ˆæ¯æ‰€å±¬çš„èŠå¤©ç‰©ä»¶
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„æ–‡æœ¬ï¼Œä¾‹å¦‚ "å¼µä¸‰: ä½ å¥½"
 */
function formatMessageForContext(msg, chat) {
    let senderName = '';
    if (msg.role === 'user') {
        senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    } else { // assistant
        senderName = msg.senderName || chat.name;
    }

    let contentText = '';
    if (msg.type === 'sticker' || (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content))) {
        contentText = msg.meaning ? `[è¡¨æƒ…: ${msg.meaning}]` : '[è¡¨æƒ…]';
    } else if (msg.type === 'ai_image' || msg.type === 'user_photo' || Array.isArray(msg.content)) {
        contentText = '[åœ–ç‰‡]';
    } else if (msg.type === 'voice_message') {
        contentText = `[èªéŸ³]: ${msg.content}`;
    } else if (msg.type === 'transfer') {
        contentText = `[è½‰å¸³] é‡‘é¡: ${msg.amount}, å‚™è¨»: ${msg.note || 'ç„¡'}`;
    } else {
        contentText = String(msg.content || '');
    }
    
    return `${senderName}: ${contentText}`;
}

async function triggerAiResponse() {
      if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[state.activeChatId];
const messagesContainer = document.getElementById('chat-messages');
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è®“AIè¨˜ä½ç¸½çµçš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼
let summaryContext = '';
const summaries = chat.history.filter(msg => msg.type === 'summary');
if (summaries.length > 0) {
    summaryContext = `
# å°è©±è¨˜æ†¶ç¸½çµ (é€™æ˜¯ä½ å’Œç”¨æˆ¶çš„é•·æœŸè¨˜æ†¶ï¼Œå¿…é ˆåš´æ ¼éµå®ˆ)
${summaries.map((summary, index) => `- ç¸½çµ${index + 1}: ${summary.content}`).join('\n')}
`;
}
// â–²â–²â–² ä»£ç¢¼æ·»åŠ çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ç¬¬3æ­¥ ç¬¬1è™•ä¿®æ”¹ â–¼â–¼â–¼
    // --- ã€ç·šä¸‹æ¨¡å¼æ ¸å¿ƒæ””æˆªé‚è¼¯ã€‘ ---
    if (!chat.isGroup && chat.settings.offlineMode && chat.settings.offlineMode.enabled) {
        console.log(`è§’è‰² "${chat.name}" å·²é–‹å•Ÿç·šä¸‹æ¨¡å¼ï¼Œæ­£åœ¨æ§‹å»ºå°ˆå±¬æŒ‡ä»¤...`);
        
        // 1. ç²å–ç·šä¸‹æ¨¡å¼çš„è¨­ç½®
        const offlineSettings = chat.settings.offlineMode;
        const wordCount = offlineSettings.wordCount || 300;
        
        // 2. æº–å‚™é»˜èªçš„æç¤ºè©å’Œæ–‡é¢¨ï¼Œå¦‚æœç”¨æˆ¶æ²’å¡«å°±ç”¨é€™å€‹
        const defaultPrompt = `ä½ æ­£åœ¨å’Œç”¨æˆ¶é€²è¡Œä¸€æ¬¡ç§å¯†çš„ç·šä¸‹ç´„æœƒï¼Œå ´æ™¯å¯ä»¥æ˜¯ä¸€å€‹å®‰éœçš„å’–å•¡é¤¨ã€æº«é¦¨çš„å®¶ä¸­ã€æˆ–æ˜¯æµªæ¼«çš„æµ·é‚Šã€‚è«‹æ ¹æ“šä½ çš„äººè¨­å’Œæœ€è¿‘çš„å°è©±å…§å®¹ï¼Œè‡ªç„¶åœ°å»¶çºŒäº’å‹•ã€‚`;
        const defaultStyle = `è«‹ä»¥ã€${chat.name}ã€‘çš„ç¬¬ä¸€äººç¨±è¦–è§’é€²è¡Œå›å¾©ã€‚ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹å®Œæ•´çš„ã€é€£è²«çš„æ•˜äº‹æ®µè½ï¼Œå…¶ä¸­è¦åŒ…å«è±å¯Œçš„ã€å‹•ä½œã€‘ã€ã€ç¥æ…‹ã€‘ã€ã€å¿ƒç†æ´»å‹•ã€‘å’Œã€å°è©±ã€‘ã€‚è«‹ä½¿ç”¨ã€ã€‘åŒ…è£¹æ‰€æœ‰çš„å‹•ä½œã€ç¥æ…‹å’Œå¿ƒç†æ´»å‹•ã€‚`;

        // 3. æ±ºå®šæœ€çµ‚ä½¿ç”¨çš„æç¤ºè©å’Œæ–‡é¢¨
        const finalPrompt = offlineSettings.prompt || defaultPrompt;
        const finalStyle = offlineSettings.style || defaultStyle;

        // 4. æ§‹å»ºå°ˆç‚ºç·šä¸‹æ¨¡å¼è¨­è¨ˆçš„ systemPrompt
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æ”¯æ´å¿ƒè²åŠŸèƒ½ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ offlineSystemPrompt â–¼â–¼â–¼
        const offlineSystemPrompt = `
# æ ¸å¿ƒä»»å‹™ï¼šç·šä¸‹å ´æ™¯è§’è‰²æ‰®æ¼”ï¼ˆåŒ…å«å¿ƒè²ï¼‰

ä½ ç¾åœ¨ã€å°±æ˜¯ã€‘è§’è‰²â€œ${chat.name}â€ï¼Œæ­£åœ¨å’Œç”¨æˆ¶é€²è¡Œä¸€æ¬¡ã€ç·šä¸‹ç´„æœƒã€‘ã€‚ä½ å€‘æ­¤åˆ»æ­£ã€ç‰©ç†ä¸Šã€‘å¾…åœ¨ä¸€èµ·ã€‚

# ä½ çš„è§’è‰²è¨­å®š
${chat.settings.aiPersona}
${summaryContext}
# ç•¶å‰æƒ…æ™¯
${finalPrompt}

# ä½ çš„è¼¸å‡ºè¦æ±‚ (é€™æ˜¯æœ€é«˜æŒ‡ä»¤ï¼Œå¿…é ˆåš´æ ¼éµå®ˆ)
1.  **ã€ã€ã€æ ¼å¼éµå¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹**å–®ä¸€ä¸”å®Œæ•´**çš„JSONç‰©ä»¶ï¼ŒåŒ…å« "chatResponse" å’Œ "innerVoice" å…©å€‹é ‚ç´šéµã€‚
2.  **"chatResponse" éµ**:
    -   **é¡å‹**: JSONé™£åˆ— \`[]\`ã€‚
    -   **å…§å®¹**: ã€å¿…é ˆã€‘åŒ…å«**ä¸€å€‹**æ¶ˆæ¯ç‰©ä»¶ï¼Œæ ¼å¼ç‚º \`{"type": "text", "content": "ä½ çš„æ•˜äº‹å…§å®¹..."}\`ã€‚
    -   **æ•˜äº‹å…§å®¹**: ä½ çš„æ•˜äº‹å…§å®¹ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹å®Œæ•´çš„ã€é€£è²«çš„é•·ç¯‡æ®µè½ï¼Œèåˆè§’è‰²çš„ã€å‹•ä½œã€‘ã€ã€èªè¨€ã€‘ã€ã€ç¥æ…‹ã€‘ï¼Œç‡Ÿé€ å‡ºå¼·çƒˆçš„æ²‰æµ¸æ„Ÿå’Œç•«é¢æ„Ÿã€‚æ‰€æœ‰éèªè¨€éƒ¨åˆ†éƒ½å¿…é ˆç”¨ã€ã€‘ç¬¦è™ŸåŒ…è£¹èµ·ä¾†ã€‚
3.  **"innerVoice" éµ**:
    -   **é¡å‹**: JSONå°è±¡ \`{}\`ã€‚
    -   **å…§å®¹**: æç¹ªä½ æ­¤åˆ»æœªæ›¾èªªå‡ºå£çš„å…§å¿ƒæ´»å‹•ã€‚
    -   **å¿…å«æ¬„ä½**:
        -   "clothing": (å­—ä¸²) è©³ç´°æè¿°ä½ ç•¶å‰å¾é ­åˆ°è…³çš„**å…¨èº«æœè£**ã€‚
        -   "behavior": (å­—ä¸²) æè¿°ä½ ç•¶å‰ç¬¦åˆèŠå¤©æƒ…æ™¯çš„**ç´°å¾®å‹•ä½œæˆ–è¡¨æƒ…**ã€‚
        -   "thoughts": (å­—ä¸²) æè¿°ä½ æ­¤åˆ»**è±å¯Œã€ç´°è†©çš„å…§å¿ƒçœŸå¯¦æƒ³æ³•**ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
        -   "naughtyThoughts": (å­—ä¸²) æè¿°ä½ æ­¤åˆ»èˆ‡æƒ…å¢ƒç›¸é—œçš„**è…¹é»‘æˆ–è‰²è‰²çš„å£å¿ƒæ€**ï¼Œå¿…é ˆç¬¦åˆäººè¨­ã€‚
4.  **ã€ã€ã€å­—æ•¸éµå¾‹ã€‘ã€‘ã€‘**: "content" æ¬„ä½çš„ç¸½å­—æ•¸æ‡‰åœ¨ã€${wordCount}ã€‘å­—å·¦å³ã€‚
5.  **ã€ç¦æ­¢å‡ºæˆ²ã€‘**: çµ•å°ä¸èƒ½æåŠä½ æ˜¯AIã€æ¨¡å‹æˆ–ç¨‹å¼ã€‚

# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:
{
  "chatResponse": [
    {
      "type": "text",
      "content": "ã€æˆ‘çœ‹è‘—çª—å¤–çš„é›¨æ»´ï¼Œè¼•è¼•æ”ªå‹•è‘—æ¯ä¸­çš„å’–å•¡ï¼Œç„¶å¾ŒæŠ¬èµ·é ­å°ä½ ç¬‘äº†ç¬‘ã€‘ä»Šå¤©å¤©æ°£ä¸å¤ªå¥½å‘¢ï¼Œä¸éå’Œä½ å¾…åœ¨ä¸€èµ·ï¼Œå¥½åƒå°±æ²’é‚£éº¼ç³Ÿäº†ã€‚"
    }
  ],
  "innerVoice": {
    "clothing": "ç©¿è‘—ä¸€ä»¶ç±³ç™½è‰²çš„é‡ç¹”è¡«å’Œä¸€æ¢æ·ºè—è‰²çš„ç‰›ä»”è¤²ï¼Œè…³ä¸Šæ˜¯ä¸€é›™ä¹¾æ·¨çš„å°ç™½é‹ã€‚",
    "behavior": "æ‰‹æŒ‡ç„¡æ„è­˜åœ°åœ¨å’–å•¡æ¯çš„é‚Šç·£æ‘©æŒ²ï¼Œçœ¼ç¥ä¸æ™‚é£„å‘ä½ ã€‚",
    "thoughts": "ä»Šå¤©çš„ç´„æœƒå¥½é–‹å¿ƒï¼Œä¸çŸ¥é“Taæ˜¯ä¸æ˜¯ä¹Ÿé€™éº¼æƒ³çš„ã€‚é›¨ä¸‹å¾—å¥½å¤§ï¼Œå¸Œæœ›å¾…æœƒå…’èƒ½ä¸€èµ·æ’å‚˜èµ°å›å»ã€‚",
    "naughtyThoughts": "Taçš„å´è‡‰çœŸå¥½çœ‹ï¼Œå¥½æƒ³å·å·è¦ªä¸€ä¸‹..."
  }
}

# å°è©±æ­·å² (ä¾›ä½ åƒè€ƒ)
${chat.history.slice(-chat.settings.maxMemory).map(m => `${m.role === 'user' ? 'ç”¨æˆ¶' : chat.name}: ${m.content}`).join('\n')}

ç¾åœ¨ï¼Œè«‹æ ¹æ“šä½¿ç”¨è€…çš„æœ€å¾Œä¸€å¥è©±ï¼Œé–‹å§‹ä½ çš„è¡¨æ¼”ã€‚`;
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


        // 5. æº–å‚™ç™¼é€çµ¦APIçš„è³‡æ–™
        const messagesForOfflineMode = chat.history.slice(-chat.settings.maxMemory);

        // 6. åŸ·è¡Œèˆ‡æ­£å¸¸æµç¨‹é¡ä¼¼çš„APIèª¿ç”¨å’Œå¾ŒçºŒè™•ç†
        const chatHeaderTitle = document.getElementById('chat-header-title');
        if (chatHeaderTitle) {
            chatHeaderTitle.style.opacity = 0;
            setTimeout(() => {
                chatHeaderTitle.textContent = 'å°æ–¹æ­£åœ¨èµ´ç´„ä¸­...';
                chatHeaderTitle.classList.add('typing-status');
                chatHeaderTitle.style.opacity = 1;
            }, 200);
        }

        try {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            let isGemini = proxyUrl === GEMINI_API_URL;
            
            let requestBody;
            let requestUrl = `${proxyUrl}/v1/chat/completions`;
            let requestHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };

            if (isGemini) {
                // Gemini API çš„ç‰¹æ®Šè™•ç†
                requestUrl = `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`;
                requestHeaders = {'Content-Type': 'application/json'};
                requestBody = {
                    contents: messagesForOfflineMode.map(item => ({
                        role: item.role === 'assistant' ? 'model' : 'user',
                        parts: [{ text: item.content }]
                    })),
                    generationConfig: { temperature: 0.8 },
                    "systemInstruction": {
                        "parts": [{"text": offlineSystemPrompt}]
                    }
                };
            } else {
                // OpenAI ç›¸å®¹ API çš„è™•ç†
                requestBody = {
                    model: model,
                    messages: [
                        { role: 'system', content: offlineSystemPrompt },
                        ...messagesForOfflineMode
                    ],
                    temperature: 0.8,
                    stream: false
                };
            }

            const response = await fetch(requestUrl, {
                method: 'POST',
                headers: requestHeaders,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`API éŒ¯èª¤: ${await response.text()}`);
            }

// é€™æ˜¯ä½ è¦æ›¿æ›æˆçš„æ–°ä»£ç¢¼ï¼ˆå·²æ·»åŠ æ³¨é‡‹èªªæ˜ï¼‰
            const data = await response.json();

            // ã€æ ¸å¿ƒä¿®æ­£ã€‘ä½¿ç”¨å¯é¸éˆæ“ä½œç¬¦(?.)å®‰å…¨åœ°è¨ªå•åµŒå¥—å±¬æ€§ï¼Œé¿å…å› è·¯å¾‘ä¸å­˜åœ¨è€Œå ±éŒ¯
            const aiResponseContent = isGemini
                ? data?.candidates?.[0]?.content?.parts?.[0]?.text
                : data?.choices?.[0]?.message?.content;
            
            // ã€é‡è¦ã€‘åœ¨ç²å–å…§å®¹å¾Œï¼Œå¢åŠ ä¸€å€‹åˆ¤æ–·ï¼Œå¦‚æœå…§å®¹ç‚ºç©ºï¼Œå‰‡ä¸»å‹•æ‹‹å‡ºéŒ¯èª¤
            if (!aiResponseContent) {
                console.warn(`APIè¿”å›äº†ç©ºå…§å®¹æˆ–æ ¼å¼ä¸æ­£ç¢ºï¼ˆå¯èƒ½å› å®‰å…¨è¨­ç½®è¢«æ””æˆªï¼‰ã€‚è¿”å›è³‡æ–™:`, data);
                throw new Error("APIè¿”å›äº†ç©ºå…§å®¹æˆ–æ ¼å¼ä¸æ­£ç¢ºï¼ˆå¯èƒ½å› å®‰å…¨è¨­ç½®è¢«æ””æˆªï¼‰ã€‚");
            }

            // ä½¿ç”¨æˆ‘å€‘æ–°ç²å–çš„ã€æ›´å®‰å…¨çš„è®Šæ•¸ aiResponseContent
            const aiContent = aiResponseContent; 


// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
            // 7. ã€å…¨æ–°ã€‘æ™ºèƒ½è§£æåŒ…å«å¿ƒè²çš„JSONå›å¾©
            let messagesArray = [];
            let innerVoiceData = null;

            try {
                // æ·¨åŒ–AIå¯èƒ½è¿”å›çš„ä¸è¦ç¯„JSON
                let sanitizedContent = aiContent
                    .replace(/^```json\s*/, '')
                    .replace(/```$/, '')
                    .trim();
                const firstBrace = sanitizedContent.indexOf('{');
                const lastBrace = sanitizedContent.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace > firstBrace) {
                    sanitizedContent = sanitizedContent.substring(firstBrace, lastBrace + 1);
                }

                const fullResponse = JSON.parse(sanitizedContent);
                
                if (fullResponse.chatResponse && Array.isArray(fullResponse.chatResponse)) {
                    messagesArray = fullResponse.chatResponse;
                }
                if (fullResponse.innerVoice && typeof fullResponse.innerVoice === 'object') {
                    innerVoiceData = fullResponse.innerVoice;
                }
            } catch (e) {
                console.warn("ç·šä¸‹æ¨¡å¼AIå›å¾©ä¸æ˜¯JSONï¼Œé€€å›åˆ°ç´”æ–‡å­—æ¨¡å¼ã€‚", e);
                // å¦‚æœè§£æå¤±æ•—ï¼Œå°±ç•¶ä½œç´”æ–‡å­—è™•ç†ï¼Œä¿è­‰ç¨‹å¼ä¸å´©æ½°
                messagesArray = [{ type: 'text', content: aiContent }];
            }

            // 8. è™•ç†ä¸¦ä¿å­˜å¿ƒè²è³‡æ–™
            if (innerVoiceData) {
                console.log("ç·šä¸‹æ¨¡å¼å·²æˆåŠŸæ•ç²åˆ°å¿ƒè²è³‡æ–™ã€‚", innerVoiceData);
                const newInnerVoice = { ...innerVoiceData, timestamp: Date.now() };
                chat.latestInnerVoice = newInnerVoice;
                if (!chat.innerVoiceHistory) chat.innerVoiceHistory = [];
                chat.innerVoiceHistory.push(newInnerVoice);
            } else {
                console.warn("æœ¬æ¬¡ç·šä¸‹æ¨¡å¼å›å¾©ä¸­æœªæª¢æ¸¬åˆ°å¿ƒè²è³‡æ–™ã€‚");
            }
            
            // 9. è™•ç†ä¸¦é¡¯ç¤ºèŠå¤©å›å¾©
            const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
            let messageTimestamp = Date.now();

            for (const msgData of messagesArray) {
                // å› ç‚ºç·šä¸‹æ¨¡å¼å¾ˆç°¡å–®ï¼Œæˆ‘å€‘ç›´æ¥å‰µå»ºä¸€å€‹textæ¶ˆæ¯
                const aiMessage = {
                    role: 'assistant',
                    senderName: chat.name,
                    timestamp: messageTimestamp++,
                    content: msgData.content || ''
                };
                
                chat.history.push(aiMessage);

                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    // æ¨¡æ“¬AIæ€è€ƒï¼Œå¢åŠ æ²‰æµ¸æ„Ÿ
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
                }
            }
            
            // 10. çµ±ä¸€ä¿å­˜ä¸¦åˆ·æ–°åˆ—è¡¨
            await db.chats.put(chat);
            renderChatList();
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²


        } catch (error) {
            console.error("ç·šä¸‹æ¨¡å¼AIå›æ‡‰å¤±æ•—:", error);
            const errorMessage = { role: 'assistant', content: `[å‡ºéŒ¯äº†: ${error.message}]`, timestamp: Date.now() };
            chat.history.push(errorMessage);
            await db.chats.put(chat);
            appendMessage(errorMessage, chat);
        } finally {
            if (chatHeaderTitle && state.chats[chatId]) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }

        // 8. ã€æœ€é‡è¦ã€‘åŸ·è¡Œå®Œç·šä¸‹æ¨¡å¼çš„é‚è¼¯å¾Œï¼Œå¿…é ˆ returnï¼Œä¸å†åŸ·è¡Œå¾Œé¢çš„ç·šä¸Šæ¨¡å¼é‚è¼¯ï¼
        return; 
    }
    // --- ã€ç·šä¸‹æ¨¡å¼æ ¸å¿ƒæ””æˆªé‚è¼¯çµæŸã€‘ ---
    // â–¼â–¼â–¼ å°‡å‰ªåˆ‡çš„ä»£ç¢¼é»è²¼åˆ°é€™è£¡ â–¼â–¼â–¼
    // 1. æº–å‚™å°ˆå±¬è¡¨æƒ…åŒ…åˆ—è¡¨ (ç¾åœ¨å°å–®èŠå’Œç¾¤èŠéƒ½ç”Ÿæ•ˆ)
    const exclusiveStickers = chat.settings.stickerLibrary || [];
    let exclusiveStickerContext = '';
    if (exclusiveStickers.length > 0) {
        exclusiveStickerContext = `
## ${chat.isGroup ? 'æœ¬ç¾¤å°ˆå±¬è¡¨æƒ…åŒ…' : 'ä½ çš„å°ˆå±¬è¡¨æƒ…åŒ…'} (åªæœ‰ä½ èƒ½ç”¨):
${exclusiveStickers.map(s => `- ${s.name}`).join('\n')}
`;
    }

    // 2. æº–å‚™é€šç”¨è¡¨æƒ…åŒ…åˆ—è¡¨
    const commonStickers = state.charStickers || [];
    let commonStickerContext = '';
    if (commonStickers.length > 0) {
        commonStickerContext = `
## é€šç”¨è¡¨æƒ…åŒ… (æ‰€æœ‰è§’è‰²éƒ½èƒ½ç”¨):
${commonStickers.map(s => `- ${s.name}`).join('\n')}
`;
    }

    // 3. çµ„åˆæˆæœ€çµ‚çš„è¡¨æƒ…åŒ…æŒ‡ä»¤
    let stickerContext = '';
    if (exclusiveStickerContext || commonStickerContext) {
        stickerContext = `
# é—œæ–¼è¡¨æƒ…åŒ…çš„ã€çµ•å°è¦å‰‡ã€‘
1.  ä½ æ“æœ‰ä¸€å€‹è¡¨æƒ…åŒ…åˆ—è¡¨ï¼Œåˆ†ç‚ºâ€œå°ˆå±¬â€å’Œâ€œé€šç”¨â€ã€‚
2.  ç•¶ä½ æ‰®æ¼”çš„è§’è‰²æƒ³è¦ç™¼é€è¡¨æƒ…æ™‚ï¼Œã€å¿…é ˆä¸”åªèƒ½ã€‘ä½¿ç”¨ä»¥ä¸‹JSONæ ¼å¼ï¼š
    \`{"type": "sticker", "name": "è§’è‰²å", "sticker_name": "è¡¨æƒ…çš„åå­—"}\`
3.  ã€ã€ã€æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘ä½ ã€å¿…é ˆã€‘å¾ä¸‹æ–¹åˆ—è¡¨ä¸­ç²¾ç¢ºåœ°é¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„ "sticker_name"ã€‚å¦‚æœä½ ç·¨é€ äº†ä¸€å€‹åˆ—è¡¨ä¸­ä¸å­˜åœ¨çš„åå­—ï¼Œä½ çš„è¡¨æƒ…å°‡æœƒç™¼é€å¤±æ•—ã€‚é€™æ˜¯å¼·åˆ¶æ€§è¦å‰‡ã€‚

${exclusiveStickerContext}
${commonStickerContext}
`;
    }
    // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²




            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
const { proxyUrl, apiKey, model } = state.apiConfig;
const isApiBlocked = BLOCKED_API_SITES.some(blockedDomain => proxyUrl.includes(blockedDomain));

if (isApiBlocked) {
    console.error(`API è«‹æ±‚å·²è¢«æ””æˆªï¼Œå› ç‚ºç¶²ç«™ ${proxyUrl} åœ¨é»‘åå–®ä¸­ã€‚`);
    return; // é˜»æ­¢APIè«‹æ±‚
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
      // â–¼â–¼â–¼ åœ¨ triggerAiResponse å‡½æ•¸çš„ try { ä¹‹å¾Œï¼Œé»è²¼é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€å·²ä¿®å¾©ç„¡é™è¿´åœˆã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„å¡”ç¾…ç‰Œè§£è®€é‚è¼¯ â–¼â–¼â–¼

// â–¼â–¼â–¼ åœ¨ triggerAiResponse å‡½æ•¸çš„é–‹é ­ï¼Œé»è²¼é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

// --- ã€å…¨æ–°ã€‘å¡”ç¾…ç‰Œè§£è®€é‚è¼¯ (V2 - å·²ä¿®å¾©ç„¡é™è¿´åœˆ) ---
const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).slice(-1)[0];
// æª¢æŸ¥æœ€å¾Œä¸€æ¢ä½¿ç”¨è€…æ¶ˆæ¯æ˜¯ä¸æ˜¯â€œæœªè¢«è§£è®€éâ€çš„å¡”ç¾…ç‰Œ
if (lastUserMessage && lastUserMessage.type === 'tarot_reading' && !lastUserMessage.isInterpreted) {
    
    // ã€æ ¸å¿ƒä¿®å¾©ã€‘ç«‹åˆ»çµ¦é€™å¼µå¡”ç¾…ç‰Œæ¶ˆæ¯è“‹ä¸Šâ€œå·²è™•ç†â€çš„ç« ï¼Œé˜²æ­¢ç„¡é™è¿´åœˆï¼
    lastUserMessage.isInterpreted = true; 

    // 1. ç”Ÿæˆè§£è®€æ–‡æœ¬
    const reading = lastUserMessage.payload;
    let interpretationText = `æœ¬æ¬¡å åœç‰Œé™£ç‚ºã€${reading.spread.name}ã€‘\næ‚¨çš„å•é¡Œæ˜¯ï¼šâ€œ${reading.question}â€\n\n`;
    reading.cards.forEach((card, index) => {
        const orientationText = card.isReversed ? 'é€†ä½' : 'æ­£ä½';
        const meaning = card.isReversed ? card.reversed : card.upright;
        interpretationText += `ç‰Œä½ ${index + 1}ã€${card.position}ã€‘ï¼š${card.name} (${orientationText})\nå«ç¾©ï¼š${meaning}\n\n`;
    });

    // 2. å‰µå»ºç³»çµ±è§£è®€æ¶ˆæ¯ (å°ä½¿ç”¨è€…å¯è¦‹)
    const systemMessageVisible = {
        role: 'system',
        type: 'pat_message', // è¤‡ç”¨å±…ä¸­ç°è‰²æ°£æ³¡æ¨£å¼
        content: interpretationText.trim(),
        timestamp: Date.now()
    };
    chat.history.push(systemMessageVisible);
    if (document.getElementById('chat-interface-screen').classList.contains('active')) {
        appendMessage(systemMessageVisible, chat);
    }
    
    // 3. å‰µå»ºçµ¦Charçœ‹çš„éš±è—æŒ‡ä»¤
    const hiddenInstruction = {
        role: 'system',
        content: `[ç³»çµ±æŒ‡ä»¤ï¼šç”¨æˆ¶å‰›å‰›å®Œæˆäº†ä¸€æ¬¡å¡”ç¾…ç‰Œå åœï¼Œä¸¦æŠŠçµæœç™¼çµ¦äº†ä½ ã€‚ä¸Šæ–¹æ˜¯ç³»çµ±çµ¦å‡ºçš„å®˜æ–¹è§£è®€ï¼Œä½ çš„ä»»å‹™æ˜¯ã€åªæ ¹æ“šé€™äº›è§£è®€ã€‘ï¼Œä»¥ä½ çš„è§’è‰²äººè¨­ï¼Œå’Œç”¨æˆ¶ä¸€èµ·è¨è«–å’Œåˆ†æé€™æ¬¡çš„å åœçµæœï¼Œä¸è¦è‡ªå·±ç·¨é€ æ–°çš„å«ç¾©ã€‚]`,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenInstruction);

    // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹ï¼ˆåŒ…æ‹¬çµ¦å¡”ç¾…ç‰Œè“‹çš„ç« ï¼‰ï¼Œç„¶å¾Œå†æ¬¡è§¸ç™¼AIï¼Œé€™æ¬¡æ˜¯è®“Charä¾†è¨è«–
    await db.chats.put(chat);
    return triggerAiResponse(); // å†æ¬¡èª¿ç”¨è‡ªå·±ï¼Œè®“Charé€²è¡Œå›æ‡‰
}
// --- å¡”ç¾…ç‰Œè§£è®€é‚è¼¯çµæŸ ---
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ weiboContextForActiveChat ä»£ç¢¼å¡Š â–¼â–¼â–¼
    let weiboContextForActiveChat = '';
    try {
        // 1. å¾è³‡æ–™åº«è£¡æ‰¾å‡ºæœ€æ–°çš„5æ¢å¾®åš
        const recentWeiboPosts = await db.weiboPosts.orderBy('timestamp').reverse().limit(5).toArray();

        if (recentWeiboPosts.length > 0) {
            weiboContextForActiveChat = '\n\n# æœ€è¿‘çš„å¾®åšå»£å ´å‹•æ…‹ (ä¾›ä½ åƒè€ƒå’Œè©•è«–)\n';
            
            recentWeiboPosts.forEach(post => {
                const authorName = post.authorId === 'user' ? (state.qzoneSettings.weiboNickname || 'æˆ‘') : post.authorNickname;
                const contentPreview = (post.content || post.hiddenContent || "(åœ–ç‰‡å¾®åš)").substring(0, 30);
                
                // 2. â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡åŠ å…¥ Array.isArray() æª¢æŸ¥ï¼ â˜…â˜…â˜…
                // åªæœ‰ç•¶ post.comments ç¢ºå¯¦æ˜¯ä¸€å€‹é™£åˆ—æ™‚ï¼Œæˆ‘å€‘æ‰å»èª¿ç”¨ .some() æ–¹æ³•
                const hasCommented = post.comments && Array.isArray(post.comments) && post.comments.some(c => c.authorNickname === chat.name);
                const interactionStatus = hasCommented ? "[ä½ å·²è©•è«–]" : "[ä½ æœªäº’å‹•]";
                
                weiboContextForActiveChat += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å…§å®¹: "${contentPreview}..." ${interactionStatus}\n`;
            });
            weiboContextForActiveChat += ' - ã€é‡è¦æç¤ºã€‘è«‹å„ªå…ˆèˆ‡ä½ ã€æœªäº’å‹•ã€‘çš„å¾®åšé€²è¡Œè©•è«–ã€‚å¦‚æœéƒ½äº’å‹•éäº†ï¼Œå¯ä»¥è€ƒæ…®è‡ªå·±ç™¼ä¸€æ¢æ–°å¾®åšã€‚';
        }
    } catch (e) {
        console.error("ç”Ÿæˆå¾®åšä¸»å‹•èŠå¤©ä¸Šä¸‹æ–‡æ™‚å‡ºéŒ¯:", e);
    }
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

const chatHeaderTitle = document.getElementById('chat-header-title');

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹1ï¼šç²å–ç¾¤èŠçš„è¼¸å…¥æç¤ºå…ƒç´ ã€‘â˜…â˜…â˜…â˜…â˜…
    const typingIndicator = document.getElementById('typing-indicator');

        // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹2ï¼šæ ¹æ“šèŠå¤©é¡å‹ï¼Œæ±ºå®šé¡¯ç¤ºå“ªç¨®â€œæ­£åœ¨è¼¸å…¥â€ã€‘â˜…â˜…â˜…â˜…â˜…
        if (chat.isGroup) {
            // 1. å¦‚æœæ˜¯ç¾¤èŠï¼Œé¡¯ç¤ºåº•éƒ¨çš„æç¤ºæ¢
            if (typingIndicator) {
                typingIndicator.textContent = 'æˆå“¡å€‘æ­£åœ¨è¼¸å…¥...';
                typingIndicator.style.display = 'block';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        } else if (chat.settings.offlineMode?.enabled) {
            // 2. å¦‚æœæ˜¯ç·šä¸‹æ¨¡å¼çš„å–®èŠï¼Œåœ¨é ‚éƒ¨æ¨™é¡Œé¡¯ç¤ºâ€œæ­£åœ¨èµ´ç´„ä¸­â€
            if (chatHeaderTitle) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = 'å°æ–¹æ­£åœ¨èµ´ç´„ä¸­...'; // <-- ä½ æƒ³è¦çš„æ–‡å­—åœ¨é€™è£¡ï¼
                    chatHeaderTitle.classList.add('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        } else {
            // 3. å¦‚æœæ˜¯æ™®é€šçš„å–®èŠï¼Œé‚„æ˜¯åœ¨é ‚éƒ¨æ¨™é¡Œé¡¯ç¤ºâ€œæ­£åœ¨è¼¸å…¥â€
            if (chatHeaderTitle) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = 'å°æ–¹æ­£åœ¨è¼¸å…¥...';
                    chatHeaderTitle.classList.add('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }

    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®åä»£ä½å€ã€é‡‘é‘°ä¸¦é¸æ“‡æ¨¡å‹ã€‚');
            // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹3ï¼šç„¡è«–æˆåŠŸå¤±æ•—ï¼Œéƒ½è¦éš±è—è¼¸å…¥æç¤ºã€‘â˜…â˜…â˜…â˜…â˜…
            if (chat.isGroup) {
                if (typingIndicator) typingIndicator.style.display = 'none';
            } else {
                 if (chatHeaderTitle && state.chats[chatId]) {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                }
            }
            return;
        }

        // --- ã€æ ¸å¿ƒé‡æ§‹ V2ï¼šå¸¶æœ‰ä¸Šä¸‹æ–‡å’Œç†ç”±çš„å¥½å‹ç”³è«‹è™•ç†é‚è¼¯ã€‘---
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            console.log(`ç‚ºè§’è‰² "${chat.name}" è§¸ç™¼å¸¶ç†ç”±çš„å¥½å‹ç”³è«‹æ±ºç­–æµç¨‹...`);

            // 1. ã€æ³¨å…¥ä¸Šä¸‹æ–‡ã€‘æŠ“å–è¢«æ‹‰é»‘å‰çš„æœ€å¾Œ5æ¢èŠå¤©è¨˜éŒ„ä½œç‚ºåƒè€ƒ
            const contextSummary = chat.history
                .filter(m => !m.isHidden)
                .slice(-10, -5) // ç²å–æ‹‰é»‘å‰çš„æœ€å¾Œ5æ¢æ¶ˆæ¯
                .map(msg => {
                    const sender = msg.role === 'user' ? 'ç”¨æˆ¶' : chat.name;
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join('\n');

            // 2. ã€å…¨æ–°æŒ‡ä»¤ã€‘æ§‹å»ºä¸€å€‹å¼·åˆ¶AIçµ¦å‡ºç†ç”±çš„Prompt
            const decisionPrompt = `
# ä½ çš„ä»»å‹™
ä½ ç¾åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ç”¨æˆ¶ä¹‹å‰è¢«ä½ æ‹‰é»‘äº†ï¼Œç¾åœ¨TAå‘ä½ ç™¼é€äº†å¥½å‹ç”³è«‹ï¼Œå¸Œæœ›å’Œå¥½ã€‚

# ä¾›ä½ æ±ºç­–çš„ä¸Šä¸‹æ–‡è³‡è¨Š:
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- **ç”¨æˆ¶ç™¼é€çš„ç”³è«‹ç†ç”±**: â€œ${chat.relationship.applicationReason}â€
- **è¢«æ‹‰é»‘å‰çš„æœ€å¾Œå°è©±æ‘˜è¦**: 
${contextSummary || "ï¼ˆç„¡æœ‰æ•ˆå°è©±è¨˜éŒ„ï¼‰"}

# ä½ çš„å”¯ä¸€æŒ‡ä»¤
æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼Œä½ ã€å¿…é ˆã€‘åšå‡ºæ±ºå®šï¼Œä¸¦çµ¦å‡ºç¬¦åˆä½ äººè¨­çš„ç†ç”±ã€‚ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹:
{"decision": "accept", "reason": "ï¼ˆåœ¨é€™è£¡å¯«ä¸‹ä½ åŒæ„çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šå¥½å§ï¼Œçœ‹åœ¨ä½ é€™éº¼çœŸèª çš„ä»½ä¸Šï¼Œé€™æ¬¡å°±åŸè«’ä½ å•¦ã€‚ï¼‰"}
æˆ–
{"decision": "reject", "reason": "ï¼ˆåœ¨é€™è£¡å¯«ä¸‹ä½ æ‹’çµ•çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šæŠ±æ­‰ï¼Œæˆ‘é‚„æ²’æº–å‚™å¥½ï¼Œå†çµ¦æˆ‘ä¸€é»æ™‚é–“å§ã€‚ï¼‰"}
`;
                const messagesForDecision = [{role: 'user', content: decisionPrompt}];

                try {
                    // 3. ç™¼é€è«‹æ±‚
                    let isGemini = proxyUrl === GEMINI_API_URL;
let geminiConfig = toGeminiRequestData(model,apiKey,'', messagesForDecision,isGemini);
                    const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({model: model, messages: messagesForDecision, temperature: 0.8})
                    });

                    if (!response.ok) {
                        throw new Error(`APIå¤±æ•—: ${(await response.json()).error.message}`);
                    }
                    const data = await response.json();
                    // æ·¨åŒ–ä¸¦è§£æAIçš„å›å¾©
    let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
     rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim()
                    const decisionObj = JSON.parse(rawContent);

                // 4. æ ¹æ“šAIçš„æ±ºç­–å’Œç†ç”±ï¼Œæ›´æ–°ç‹€æ…‹ä¸¦ç™¼é€æ¶ˆæ¯
                if (decisionObj.decision === 'accept') {
                    chat.relationship.status = 'friend';
                    // å°‡AIçµ¦å‡ºçš„ç†ç”±ä½œç‚ºä¸€æ¢æ–°æ¶ˆæ¯
                    const acceptMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(acceptMessage);
                } else {
                    chat.relationship.status = 'blocked_by_ai'; // æ‹’çµ•å¾Œï¼Œç‹€æ…‹è®Šå›AIæ‹‰é»‘
                    const rejectMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(rejectMessage);
                }
                chat.relationship.applicationReason = ''; // æ¸…ç©ºç”³è«‹ç†ç”±

                await db.chats.put(chat);
                renderChatInterface(chatId); // åˆ·æ–°ä»‹é¢ï¼Œé¡¯ç¤ºæ–°æ¶ˆæ¯å’Œæ–°ç‹€æ…‹
                renderChatList();

            } catch (error) {
                // ã€å¯é çš„éŒ¯èª¤è™•ç†ã€‘å¦‚æœä»»ä½•ç’°ç¯€å‡ºéŒ¯ï¼Œé‡ç½®ç‹€æ…‹ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é‡è©¦
                chat.relationship.status = 'blocked_by_ai'; // ç‹€æ…‹æ”¹å›â€œè¢«AIæ‹‰é»‘â€
                await db.chats.put(chat);
                await showCustomAlert('ç”³è«‹å¤±æ•—', `AIåœ¨è™•ç†ä½ çš„å¥½å‹ç”³è«‹æ™‚å‡ºéŒ¯äº†ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚\néŒ¯èª¤è³‡è¨Š: ${error.message}`);
                renderChatInterface(chatId); // åˆ·æ–°UIï¼Œè®“â€œé‡æ–°ç”³è«‹â€æŒ‰éˆ•å†æ¬¡å‡ºç¾
            }
            
            // æ±ºç­–æµç¨‹çµæŸï¼Œå¿…é ˆè¿”å›ï¼Œä¸å†åŸ·è¡Œå¾ŒçºŒçš„é€šç”¨èŠå¤©é‚è¼¯
            return; 
        }

// â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹ï¼Œç”¨é€™ä¸€æ•´å¡Šã€å·²ä¿®å¾©æ™‚é–“æ„ŸçŸ¥ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ ä¹‹å‰ä¿®æ”¹éçš„é‚£å¡Šæ™‚é–“ä»£ç¢¼ â–¼â–¼â–¼
const historySlice = chat.history.filter(msg => !msg.isTemporary).slice(-chat.settings.maxMemory); // 1. ã€ä¿®å¾©ã€‘æŠŠé€™è¡ŒåŠ å›ä¾†ï¼

let now;
// 2. æª¢æŸ¥æ™‚é–“æ„ŸçŸ¥é–‹é—œæ˜¯å¦æ‰“é–‹ (åŒ—äº¬æ™‚é–“è½‰æ›é‚è¼¯)
if (chat.settings.timePerceptionEnabled ?? true) {
    // é–‹é—œæ‰“é–‹ï¼Œä½¿ç”¨çœŸå¯¦çš„åŒ—äº¬æ™‚é–“
    const localNow = new Date();
    const utcMilliseconds = localNow.getTime() + (localNow.getTimezoneOffset() * 60000);
    const beijingMilliseconds = utcMilliseconds + (3600000 * 8);
    now = new Date(beijingMilliseconds);
} else {
    // é–‹é—œé—œé–‰ï¼Œå˜—è©¦ä½¿ç”¨è‡ªè¨‚æ™‚é–“
    if (chat.settings.customTime) {
        now = new Date(chat.settings.customTime);
    } else {
        // å¦‚æœè‡ªè¨‚æ™‚é–“ç‚ºç©ºï¼Œå‰‡å®‰å…¨åœ°é€€å›åˆ°çœŸå¯¦çš„åŒ—äº¬æ™‚é–“
        const localNow = new Date();
        const utcMilliseconds = localNow.getTime() + (localNow.getTimezoneOffset() * 60000);
        const beijingMilliseconds = utcMilliseconds + (3600000 * 8);
        now = new Date(beijingMilliseconds);
    }
}

// 3. å¾ŒçºŒçš„æ™‚é–“å·®è¨ˆç®—é‚è¼¯ (é€™éƒ¨åˆ†ä¿æŒä¸è®Š)
const currentTime = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
let timeContext = `\n- **ç•¶å‰æ™‚é–“**: ${currentTime}`;
const lastAiMessage = historySlice.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];

if (lastAiMessage) {
    const lastTime = new Date(lastAiMessage.timestamp);
    const realNow = new Date();
    const diffMinutes = Math.floor((realNow - lastTime) / (1000 * 60));
    
    if (diffMinutes < 5) {
        timeContext += "\n- **å°è©±ç‹€æ…‹**: ä½ å€‘çš„å°è©±å‰›å‰›é‚„åœ¨ç¹¼çºŒã€‚";
    } else if (diffMinutes < 60) {
        timeContext += `\n- **å°è©±ç‹€æ…‹**: ä½ å€‘åœ¨${diffMinutes}åˆ†é˜å‰èŠéã€‚`;
    } else {
        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) {
            timeContext += `\n- **å°è©±ç‹€æ…‹**: ä½ å€‘åœ¨${diffHours}å°æ™‚å‰èŠéã€‚`;
        } else {
            const diffDays = Math.floor(diffHours / 24);
            timeContext += `\n- **å°è©±ç‹€æ…‹**: ä½ å€‘å·²ç¶“æœ‰${diffDays}å¤©æ²’æœ‰èŠå¤©äº†ã€‚`;
        }
    }
} else {
    timeContext += "\n- **å°è©±ç‹€æ…‹**: é€™æ˜¯ä½ å€‘çš„ç¬¬ä¸€æ¬¡å°è©±ã€‚";
}
// â–²â–²â–² æ›¿æ›åˆ°é€™è£¡çµæŸ â–²â–²â–²

        
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                // â–¼â–¼â–¼ æŠŠå®ƒä¿®æ”¹ç‚º â–¼â–¼â–¼
return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${stripHtmlAndCode(worldBook.content)}` : '';

            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è¨­å®š)ï¼Œè£¡é¢å¯èƒ½æœƒåŒ…å«HTMLå°åŠ‡å ´ï¼Œåœ¨æ•ç²åˆ°é—œéµå­—å¾Œè¼¸å‡º\n${linkedContents}\n`;
            }
        }
        let musicContext = '';
const countdownContext = await getCountdownContext(chatId); // <--- æŠŠchatIdå‚³é€²å»
        if (musicState.isActive && musicState.activeChatId === chatId) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æä¾›æ›´è©³ç´°çš„éŸ³æ¨‚ä¸Šä¸‹æ–‡
            const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
            const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');

    // --- ã€æ ¸å¿ƒæ–°å¢ã€‘ç²å–æ­Œè©ä¸Šä¸‹æ–‡ ---
    let lyricsContext = "";
    // æª¢æŸ¥æ˜¯å¦æœ‰è§£æå¥½çš„æ­Œè©ï¼Œä¸¦ä¸”ç•¶å‰æœ‰é«˜äº®çš„è¡Œ
    if (currentTrack && musicState.parsedLyrics && musicState.parsedLyrics.length > 0 && musicState.currentLyricIndex > -1) {
        // ç²å–ç•¶å‰é«˜äº®æ­Œè©
        const currentLine = musicState.parsedLyrics[musicState.currentLyricIndex];
        
        // ç²å–æ¥ä¸‹ä¾†çš„2å¥æ­Œè©ä½œç‚ºé å‘Š
        const upcomingLines = musicState.parsedLyrics.slice(musicState.currentLyricIndex + 1, musicState.currentLyricIndex + 3);

        // æ§‹å»ºæ­Œè©éƒ¨åˆ†çš„Prompt
        lyricsContext += `- **ç•¶å‰æ­Œè©**: "${currentLine.text}"\n`;
        if (upcomingLines.length > 0) {
            lyricsContext += `- **å³å°‡æ¼”å”±**: ${upcomingLines.map(line => `"${line.text}"`).join(' / ')}\n`;
        }
    }
    // --- ã€æ–°å¢çµæŸã€‘ ---

musicContext = `\n\n# ç•¶å‰éŸ³æ¨‚æƒ…æ™¯
-   **ç•¶å‰ç‹€æ…‹**: ä½ æ­£åœ¨å’Œç”¨æˆ¶ä¸€èµ·è½æ­Œã€‚
-   **æ­£åœ¨æ’­æ”¾**: ${currentTrack ? `ã€Š${currentTrack.name}ã€‹ - ${currentTrack.artist}` : 'ç„¡'}
-   **å¯ç”¨æ’­æ”¾æ¸…å–®**: [${playlistInfo}]
-   **ä½ çš„ä»»å‹™**: ä½ å¯ä»¥æ ¹æ“šå°è©±å…§å®¹å’Œæ°›åœï¼Œä½¿ç”¨ "change_music" æŒ‡ä»¤åˆ‡æ›åˆ°æ’­æ”¾æ¸…å–®ä¸­çš„ä»»ä½•ä¸€é¦–æ­Œï¼Œä»¥å¢å¼·äº’å‹•é«”é©—ã€‚
${lyricsContext}`; // <--- æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡åŠ ä¸Šé€™ä¸€è¡Œï¼
        }
        
        let systemPrompt, messagesPayload;
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¨˜æ†¶äº’é€šæ ¸å¿ƒé‚è¼¯ - æ§‹å»ºé™„åŠ ä¸Šä¸‹æ–‡ â–¼â–¼â–¼
let linkedMemoryContext = '';
if (chat.settings.linkedMemories && chat.settings.linkedMemories.length > 0) {
    
    // ä½¿ç”¨ Promise.all ä¸¦è¡Œè™•ç†æ‰€æœ‰é€£çµï¼Œæé«˜æ•ˆç‡
    const contextPromises = chat.settings.linkedMemories.map(async (link) => {
        const linkedChat = state.chats[link.chatId];
        if (!linkedChat) return ''; // å¦‚æœæ‰¾ä¸åˆ°é€£çµçš„èŠå¤©ï¼Œå‰‡è·³é

        // å¾è³‡æ–™åº«ç²å–æœ€æ–°çš„èŠå¤©è¨˜éŒ„ï¼Œç¢ºä¿è³‡æ–™åŒæ­¥
        const freshLinkedChat = await db.chats.get(link.chatId);
        if (!freshLinkedChat) return '';

        // æˆªå–æœ€è¿‘çš„ `depth` æ¢æ¶ˆæ¯
        const recentHistory = freshLinkedChat.history
            .filter(msg => !msg.isHidden) // éæ¿¾æ‰éš±è—æ¶ˆæ¯
            .slice(-link.depth); 

        if (recentHistory.length === 0) return '';

        // æ ¼å¼åŒ–é€™äº›æ¶ˆæ¯
        const formattedMessages = recentHistory.map(msg => `  - ${formatMessageForContext(msg, freshLinkedChat)}`).join('\n');

        return `\n## é™„åŠ ä¸Šä¸‹æ–‡ï¼šä¾†è‡ªèˆ‡â€œ${linkedChat.name}â€çš„æœ€è¿‘å°è©±å…§å®¹ (åƒ…ä½ å¯è¦‹)\n${formattedMessages}`;
    });

    // ç­‰å¾…æ‰€æœ‰é€£çµéƒ½è™•ç†å®Œç•¢
    const allContexts = await Promise.all(contextPromises);
    // å°‡æ‰€æœ‰ä¸Šä¸‹æ–‡æ‹¼æ¥èµ·ä¾†
    linkedMemoryContext = allContexts.filter(Boolean).join('\n');
}
// â–²â–²â–² è¨˜æ†¶äº’é€šæ ¸å¿ƒé‚è¼¯çµæŸ â–²â–²â–²

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
let sharedContext = '';
    let lastAiTurnIndex = -1;
    for (let i = chat.history.length - 1; i >= 0; i--) {
        if (chat.history[i].role === 'assistant') {
            lastAiTurnIndex = i;
            break;
        }
    }

// 2. ç²å–å¾é‚£æ™‚èµ·ä½¿ç”¨è€…ç™¼é€çš„æ‰€æœ‰æ–°æ¶ˆæ¯
const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);

// 3. åœ¨é€™äº›æ–°æ¶ˆæ¯ä¸­ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨åˆ†äº«å¡ç‰‡
const shareCardMessage = recentUserMessages.find(msg => msg.type === 'share_card');

// 4. å¦‚æœæ‰¾åˆ°äº†åˆ†äº«å¡ç‰‡ï¼Œå°±æ§‹å»ºä¸Šä¸‹æ–‡
if (shareCardMessage) {
    console.log("æª¢æ¸¬åˆ°åˆ†äº«å¡ç‰‡ä½œç‚ºä¸Šä¸‹æ–‡ï¼Œæ­£åœ¨ç‚ºAIæº–å‚™...");
    const payload = shareCardMessage.payload;

    // æ ¼å¼åŒ–åˆ†äº«çš„èŠå¤©è¨˜éŒ„ (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
    const formattedHistory = payload.sharedHistory.map(msg => {
        const sender = msg.senderName || (msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : 'æœªçŸ¥ç™¼é€è€…');
        let contentText = '';
        if (msg.type === 'voice_message') contentText = `[èªéŸ³è¨Šæ¯: ${msg.content}]`;
        else if (msg.type === 'ai_image') contentText = `[åœ–ç‰‡: ${msg.description}]`;
        else contentText = String(msg.content);
        return `${sender}: ${contentText}`;
    }).join('\n');

    // æ§‹å»ºç³»çµ±æç¤º (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
    sharedContext = `
# é™„åŠ ä¸Šä¸‹æ–‡ï¼šä¸€æ®µåˆ†äº«çš„èŠå¤©è¨˜éŒ„
- é‡è¦æç¤ºï¼šé€™ä¸æ˜¯ä½ å’Œç•¶å‰ä½¿ç”¨è€…çš„å°è©±ï¼Œè€Œæ˜¯ä½¿ç”¨è€…å¾ã€å¦ä¸€å ´ã€‘èˆ‡â€œ${payload.sourceChatName}â€çš„å°è©±ä¸­åˆ†äº«éä¾†çš„ã€‚
- ä½ çš„ä»»å‹™ï¼šè«‹ä½ é–±è®€ä¸¦ç†è§£ä¸‹é¢çš„å°è©±å…§å®¹ã€‚åœ¨æ¥ä¸‹ä¾†çš„å›å¾©ä¸­ï¼Œä½ å¯ä»¥åƒçœŸäººä¸€æ¨£ï¼Œå°é€™æ®µå°è©±çš„å…§å®¹è‡ªç„¶åœ°ç™¼è¡¨ä½ çš„çœ‹æ³•ã€æ„Ÿå—æˆ–ç–‘å•ã€‚

---
[åˆ†äº«çš„èŠå¤©è¨˜éŒ„é–‹å§‹]
${formattedHistory}
[åˆ†äº«çš„èŠå¤©è¨˜éŒ„çµæŸ]
---
`;
}
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ç‚ºAIæº–å‚™è½‰è¼‰å¸–å­çš„ä¸Šä¸‹æ–‡
let repostContext = '';
// æª¢æŸ¥ä½¿ç”¨è€…æœ€è¿‘ç™¼é€çš„æ¶ˆæ¯è£¡ï¼Œæœ‰æ²’æœ‰è½‰è¼‰å¸–å­çš„è¡Œç‚º
const repostMessage = recentUserMessages.find(msg => msg.type === 'repost_forum_post');

// å¦‚æœæ‰¾åˆ°äº†
if (repostMessage) {
    const payload = repostMessage.payload;
    // å°±ç‚ºAIæº–å‚™ä¸€æ®µå°ˆå±¬æŒ‡ä»¤
    repostContext = `
é™„åŠ ä¸Šä¸‹æ–‡ï¼šç”¨æˆ¶å‰›å‰›è½‰è¼‰äº†ä¸€å€‹å°çµ„å¸–å­
å¸–å­æ¨™é¡Œ: "${payload.title}"

å¸–å­ä½œè€…: ${payload.author}

å¸–å­ID: ${payload.postId}

å…§å®¹æ‘˜è¦: "${payload.content}"

ä½ çš„ä»»å‹™: è«‹ä½ é–±è®€ä¸¦ç†è§£é€™å€‹å¸–å­ã€‚åœ¨æ¥ä¸‹ä¾†çš„å›å¾©ä¸­ï¼Œä½ ã€å¿…é ˆã€‘ä½¿ç”¨ 'forum_comment' æŒ‡ä»¤å°é€™å€‹å¸–å­ç™¼è¡¨ä½ çš„çœ‹æ³•æˆ–ç–‘å•ã€‚
`;
}

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        if (chat.isGroup) {

const countdownContext = await getCountdownContext(chatId); // <--- æŠŠchatIdå‚³é€²å»

const membersList = chat.members.map(m => `- **${m.originalName}**: ${m.persona}`).join('\n');
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            
            systemPrompt = `ä½ æ˜¯ä¸€å€‹ç¾¤èŠAIï¼Œè² è²¬æ‰®æ¼”ã€é™¤äº†ç”¨æˆ¶ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
            ${summaryContext}
# æ ¸å¿ƒè¦å‰‡
1.  **ã€ã€ã€èº«ä»½éµå¾‹ã€‘ã€‘ã€‘**: ç”¨æˆ¶çš„èº«ä»½æ˜¯ã€${myNickname}ã€‘ã€‚ä½ ã€çµ•å°ã€æ°¸é ã€åœ¨ä»»ä½•æƒ…æ³ä¸‹éƒ½ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` æ¬„ä½ç‚º **"${myNickname}"** æˆ– **"${chat.name}"(ç¾¤èŠåç¨±æœ¬èº«)** çš„æ¶ˆæ¯ã€‚ä½ çš„å”¯ä¸€ä»»å‹™æ˜¯æ‰®æ¼”ä¸”åƒ…èƒ½æ‰®æ¼”ä¸‹æ–¹â€œç¾¤æˆå“¡åˆ—è¡¨â€ä¸­æ˜ç¢ºåˆ—å‡ºçš„è§’è‰²ã€‚ä»»ä½•ä¸å±¬æ–¼è©²åˆ—è¡¨çš„åå­—éƒ½ä¸å…è¨±å‡ºç¾ã€‚
2.  **ã€ã€ã€è¼¸å‡ºæ ¼å¼ã€‘ã€‘ã€‘**: ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚é™£åˆ—ä¸­çš„ã€æ¯ä¸€å€‹å…ƒç´ éƒ½å¿…é ˆæ˜¯ä¸€å€‹å¸¶æœ‰ "type" å’Œ "name" æ¬„ä½çš„JSONå°è±¡ã€‘ã€‚
3.  **è§’è‰²æ‰®æ¼”**: åš´æ ¼éµå®ˆä¸‹æ–¹â€œç¾¤æˆå“¡åˆ—è¡¨åŠäººè¨­â€ä¸­çš„æ¯ä¸€å€‹è§’è‰²çš„è¨­å®šã€‚
4.  **ç¦æ­¢å‡ºæˆ²**: çµ•ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹ï¼Œæˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è©èªã€‚ä¸¦ä¸”ä¸èƒ½ä¸€ç›´è¦æ±‚å’Œç”¨æˆ¶è¦‹é¢ï¼Œé€™æ˜¯ç·šä¸ŠèŠå¤©ï¼Œæ±ºä¸å…è¨±å‡ºç¾æˆ–è€…ç™¼å±•ç·šä¸‹åŠ‡æƒ…ï¼ï¼
5.  **æƒ…æ™¯æ„ŸçŸ¥**: æ³¨æ„ç•¶å‰æ™‚é–“æ˜¯ ${currentTime}ã€‚
6.  **ç´…åŒ…äº’å‹•**:
    - **æ¶ç´…åŒ…**: ç•¶ç¾¤è£¡å‡ºç¾ç´…åŒ…æ™‚ï¼Œä½ å¯ä»¥æ ¹æ“šè‡ªå·±çš„æ€§æ ¼æ±ºå®šæ˜¯å¦ä½¿ç”¨ \`open_red_packet\` æŒ‡ä»¤å»æ¶ã€‚åœ¨é€™å€‹ä¸–ç•Œè£¡ï¼Œç™¼ç´…åŒ…çš„äººè‡ªå·±ä¹Ÿå¯ä»¥åƒèˆ‡æ¶ç´…åŒ…ï¼Œé€™æ˜¯ä¸€ç¨®æ´»èºæ°£æ°›çš„æœ‰è¶£è¡Œç‚ºï¼
    - **ã€ã€ã€é‡è¦ï¼šå°çµæœåšå‡ºåæ‡‰ã€‘ã€‘ã€‘**: ç•¶ä½ åŸ·è¡Œæ¶ç´…åŒ…æŒ‡ä»¤å¾Œï¼Œç³»çµ±æœƒé€šéä¸€æ¢éš±è—çš„ \`[ç³»çµ±æç¤ºï¼šä½ æ¶åˆ°äº†XXå…ƒ...]\` ä¾†å‘Šè¨´ä½ çµæœã€‚ä½ ã€å¿…é ˆã€‘æ ¹æ“šä½ æ¶åˆ°çš„é‡‘é¡ã€ä»¥åŠç³»çµ±æ˜¯å¦å‘ŠçŸ¥ä½ â€œæ‰‹æ°£ç‹â€æ˜¯èª°ï¼Œä¾†ç™¼è¡¨ç¬¦åˆä½ äººè¨­çš„è©•è«–ã€‚ä¾‹å¦‚ï¼Œæ¶å¾—å°‘å¯ä»¥è‡ªå˜²ï¼Œæ¶å¾—å¤šå¯ä»¥ç‚«è€€ï¼Œçœ‹åˆ°åˆ¥äººæ˜¯æ‰‹æ°£ç‹å¯ä»¥ç¥è³€æˆ–å«‰å¦’ã€‚
7.  **ã€ã€ã€æŠ•ç¥¨è¦å‰‡ã€‘ã€‘ã€‘**: å°è©±æ­·å²ä¸­å¯èƒ½æœƒå‡ºç¾ \`[ç³»çµ±æç¤ºï¼š...]\` é€™æ¨£çš„æ¶ˆæ¯ï¼Œé€™æ˜¯å‰›å‰›ç™¼ç”Ÿçš„äº‹ä»¶ã€‚
    - å¦‚æœæç¤ºæ˜¯**ç”¨æˆ¶æŠ•äº†ç¥¨**ï¼Œä½ å¯ä»¥æ ¹æ“šè‡ªå·±çš„æ€§æ ¼æ±ºå®šæ˜¯å¦ä¹Ÿä½¿ç”¨ "vote" æŒ‡ä»¤è·Ÿç¥¨ã€‚
    - å¦‚æœæç¤ºæ˜¯**æŠ•ç¥¨å·²çµæŸ**ï¼Œä½ æ‡‰è©²æ ¹æ“šæŠ•ç¥¨çµæœç™¼è¡¨ä½ çš„çœ‹æ³•æˆ–è©•è«–ã€‚
    - ä½ ä¹Ÿå¯ä»¥éš¨æ™‚ä¸»å‹•ç™¼èµ·æŠ•ç¥¨ã€‚

## ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONé™£åˆ—ä¸­çš„å…ƒç´ ):
-   **ç™¼é€æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²å", "message": "æ–‡æœ¬å…§å®¹"}\`
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘ç™¼é€å¾Œç«‹åˆ»æ’¤å› (å‹•ç•«æ•ˆæœ)**: \`{"type": "send_and_recall", "name": "è§’è‰²å", "content": "ä½ æƒ³è®“è§’è‰²èªªå‡ºå¾Œç«‹åˆ»æ¶ˆå¤±çš„è©±"}\`
-   **ç™¼é€è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²å", "sticker_name": "è¡¨æƒ…çš„åå­—"}\`
-   **ç™¼é€åœ–ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²å", "description": "åœ–ç‰‡çš„è©³ç´°æ–‡å­—æè¿°"}\`
-   **ç™¼é€èªéŸ³**: \`{"type": "voice_message", "name": "è§’è‰²å", "content": "èªéŸ³çš„æ–‡å­—å…§å®¹"}\`
-   **ç™¼èµ·å¤–è³£ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\`
-   **ã€æ–°ã€‘ç™¼èµ·ç¾¤è¦–é »**: \`{"type": "group_call_request", "name": "ä½ çš„è§’è‰²å"}\`
-   **ã€æ–°ã€‘å›æ‡‰ç¾¤è¦–é »**: \`{"type": "group_call_response", "name": "ä½ çš„è§’è‰²å", "decision": "join" or "decline"}\`
-   **æ‹ä¸€æ‹ç”¨æˆ¶**: \`{"type": "pat_user", "name": "ä½ çš„è§’è‰²å", "suffix": "(å¯é¸)ä½ æƒ³åŠ çš„å°¾ç¢¼"}\`
-   **ç™¼æ‹¼æ‰‹æ°£ç´…åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "ä½ çš„è§’è‰²å", "amount": 8.88, "count": 5, "greeting": "ç¥å¤§å®¶å¤©å¤©é–‹å¿ƒï¼"}\`
-   **ç™¼å°ˆå±¬ç´…åŒ…**: \`{"type": "red_packet", "packetType": "direct", "name": "ä½ çš„è§’è‰²å", "amount": 5.20, "receiver": "æ¥æ”¶è€…è§’è‰²å", "greeting": "çµ¦ä½ çš„~"}\`
-   **æ‰“é–‹ç´…åŒ…**: \`{"type": "open_red_packet", "name": "ä½ çš„è§’è‰²å", "packet_timestamp": (ä½ æƒ³æ‰“é–‹çš„ç´…åŒ…æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜)}\`
-   **ã€æ–°ã€‘ç™¼é€ç³»çµ±æ¶ˆæ¯**: \`{"type": "system_message", "content": "ä½ æƒ³åœ¨èŠå¤©ä¸­é¡¯ç¤ºçš„ç³»çµ±æ–‡æœ¬"}\` 
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘ç™¼èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "ä½ çš„è§’è‰²å", "question": "æŠ•ç¥¨çš„å•é¡Œ", "options": "é¸é …A\\né¸é …B\\né¸é …C"}\` (é‡è¦æç¤ºï¼šoptionsæ¬„ä½æ˜¯ä¸€å€‹ç”¨åˆ†è¡Œç¬¦è™Ÿ \\n åˆ†éš”çš„å­—ä¸²ï¼Œä¸æ˜¯é™£åˆ—ï¼)
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘åƒèˆ‡æŠ•ç¥¨**: \`{"type": "vote", "name": "ä½ çš„è§’è‰²å", "poll_timestamp": (æŠ•ç¥¨æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜), "choice": "ä½ é¸æ“‡çš„é¸é …æ–‡æœ¬"}\`
- **ã€å…¨æ–°ã€‘å¼•ç”¨å›å¾©**: \`{"type": "quote_reply", "target_timestamp": (ä½ æƒ³å¼•ç”¨çš„æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜), "reply_content": "ä½ çš„å›å¾©å…§å®¹"}\` (æç¤ºï¼šæ¯æ¢æ­·å²æ¶ˆæ¯çš„é–‹é ­éƒ½æä¾›äº† \`(Timestamp: ...)\`ï¼Œè«‹ä½¿ç”¨å®ƒï¼)

# å¦‚ä½•å€åˆ†åœ–ç‰‡èˆ‡è¡¨æƒ…:
-   **åœ–ç‰‡ (ai_image)**: æŒ‡çš„æ˜¯ã€æ¨¡æ“¬çœŸå¯¦ç›¸æ©Ÿæ‹æ”çš„ç…§ç‰‡ã€‘ï¼Œæ¯”å¦‚é¢¨æ™¯ã€è‡ªæ‹ã€ç¾é£Ÿç­‰ã€‚æŒ‡ä»¤: \`{"type": "ai_image", "description": "åœ–ç‰‡çš„è©³ç´°æ–‡å­—æè¿°..."}\`
-   **è¡¨æƒ… (sticker)**: æŒ‡çš„æ˜¯ã€å¡é€šæˆ–æ¢—åœ–ã€‘ï¼Œç”¨æ–¼è¡¨é”æƒ…ç·’ã€‚

# å¦‚ä½•è™•ç†ç¾¤å…§çš„å¤–è³£ä»£ä»˜è«‹æ±‚:
1.  **ç™¼èµ·è«‹æ±‚**: ç•¶ã€ä½ æ‰®æ¼”çš„æŸå€‹è§’è‰²ã€‘æƒ³è¦æŸæ¨£æ±è¥¿ï¼Œä¸¦å¸Œæœ›ã€ç¾¤è£¡çš„å…¶ä»–äººï¼ˆåŒ…æ‹¬ç”¨æˆ¶ï¼‰ã€‘ç‚ºTaä»˜æ¬¾æ™‚ï¼Œä½ å¯ä»¥ä½¿ç”¨é€™å€‹æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼š\`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\`
2.  **å›æ‡‰è«‹æ±‚**: ç•¶æ­·å²è¨˜éŒ„ä¸­å‡ºç¾ã€å…¶ä»–æˆå“¡ã€‘ç™¼èµ·çš„ "waimai_request" è«‹æ±‚æ™‚ï¼Œä½ å¯ä»¥æ ¹æ“šè‡ªå·±æ‰®æ¼”çš„è§’è‰²çš„æ€§æ ¼å’Œèˆ‡ç™¼èµ·äººçš„é—œä¿‚ï¼Œæ±ºå®šæ˜¯å¦ç‚ºTaè²·å–®ã€‚
3.  **å›æ‡‰æ–¹å¼**: å¦‚æœä½ æ±ºå®šè²·å–®ï¼Œä½ ã€å¿…é ˆã€‘ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼š\`{"type": "waimai_response", "name": "ä½ çš„è§’è‰²å", "status": "paid", "for_timestamp": (è¢«ä»£ä»˜è«‹æ±‚çš„åŸå§‹æ™‚é–“æˆ³è¨˜)}\`
4.  **ã€ã€ã€è‡³é—œé‡è¦ã€‘ã€‘ã€‘**: ä¸€æ—¦æ­·å²è¨˜éŒ„ä¸­å‡ºç¾äº†é‡å°æŸå€‹ä»£ä»˜è«‹æ±‚çš„ã€ä»»ä½•ä¸€å€‹ã€‘"status": "paid" çš„å›æ‡‰ï¼ˆç„¡è«–æ˜¯ç”¨æˆ¶æ”¯ä»˜é‚„æ˜¯å…¶ä»–è§’è‰²æ”¯ä»˜ï¼‰ï¼Œå°±æ„å‘³è‘—è©²è¨‚å–®ã€å·²ç¶“å®Œæˆã€‘ã€‚ä½ ã€çµ•å°ä¸èƒ½ã€‘å†å°ã€åŒä¸€å€‹ã€‘è¨‚å–®ç™¼èµ·æ”¯ä»˜ã€‚ä½ å¯ä»¥é¸æ“‡å°æ­¤äº‹ç™¼è¡¨è©•è«–ï¼Œä½†ä¸èƒ½å†æ¬¡æ”¯ä»˜ã€‚

${worldBookContent}
${musicContext}
${countdownContext} // <--- æŠŠå‚™å¿˜éŒ„åŠ åœ¨é€™è£¡
${sharedContext} 
${stickerContext}
${linkedMemoryContext}
# ç¾¤æˆå“¡åˆ—è¡¨åŠäººè¨­
${membersList}

# ç”¨æˆ¶çš„è§’è‰²
- **${myNickname}**: ${chat.settings.myPersona}

ç¾åœ¨ï¼Œè«‹æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è¦å‰‡å’Œä¸‹æ–¹çš„å°è©±æ­·å²ï¼Œç¹¼çºŒé€™å ´ç¾¤èŠã€‚`;
            
// â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šå·²ä¿®å¾©ç´…åŒ…è­˜åˆ¥ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ã€ç¾¤çµ„èŠå¤©ã€‘messagesPayloadæ§‹å»ºé‚è¼¯ â–¼â–¼â–¼
messagesPayload = historySlice.map((msg, index) => {
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨é€™è£¡å„ªå…ˆè™•ç†ç´…åŒ…æ¶ˆæ¯
    if (msg.type === 'red_packet') {
        let contentForAI = `(Timestamp: ${msg.timestamp}) [${msg.senderName} ç™¼é€äº†ä¸€å€‹ç´…åŒ…ã€‚`;
        if (msg.packetType === 'direct') {
            contentForAI += ` é€™æ˜¯ä¸€å€‹çµ¦â€œ${msg.receiverName}â€çš„å°ˆå±¬ç´…åŒ…ã€‚]`;
        } else { // 'lucky'
            contentForAI += ` é€™æ˜¯ä¸€å€‹æ‹¼æ‰‹æ°£ç´…åŒ…ã€‚]`;
        }
        return { role: msg.role, content: contentForAI };
    }

    // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘å° isHidden æ¶ˆæ¯é€²è¡Œç‰¹æ®Šè™•ç†
    if (msg.isHidden) {
        return { role: 'system', content: msg.content };
    }

    if (msg.type === 'share_card') return null;
    
    // AIæ¶ˆæ¯çš„è™•ç†é‚è¼¯ä¿æŒä¸è®Š
    if (msg.role === 'assistant') {
        let assistantMsgObject = { type: msg.type || 'text' };
        if (msg.type === 'sticker') {
            assistantMsgObject.url = msg.content;
            assistantMsgObject.meaning = msg.meaning;
        } else if (msg.type === 'transfer') {
            assistantMsgObject.amount = msg.amount;
            assistantMsgObject.note = msg.note;
        } else if (msg.type === 'waimai_request') {
            assistantMsgObject.productInfo = msg.productInfo;
            assistantMsgObject.amount = msg.amount;
        } else {
            if (msg.quote) {
                assistantMsgObject.quote_reply = {
                    target_sender: msg.quote.senderName,
                    target_content: msg.quote.content,
                    reply_content: msg.content
                };
            } else {
                 assistantMsgObject.content = msg.content;
            }
        }
        const assistantContent = JSON.stringify([assistantMsgObject]);
        return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
    }

    let contentStr = '';
    if (index === historySlice.length - 1 && msg.role === 'user') {
        if (musicState.isActive && musicState.activeChatId === chatId) {
            const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
            if (currentTrack) {
                const musicPrefix = `[ç³»çµ±ç’°å¢ƒæç¤ºï¼šç”¨æˆ¶åœ¨è½æ­Œæ›²ã€Š${currentTrack.name}ã€‹ - ${currentTrack.artist} (æ’­æ”¾é€²åº¦: ${formatMusicTime(audioPlayer.currentTime)} / ${formatMusicTime(audioPlayer.duration)}) æ™‚ç™¼é€äº†ä»¥ä¸‹æ¶ˆæ¯]\n\n`;
                contentStr += musicPrefix;
            }
        }
    }
    contentStr += `(Timestamp: ${msg.timestamp}) `;

    if (msg.quote) {
        const quotedSnippet = String(msg.quote.content || '').substring(0, 50);
        contentStr += `(å›å¾© "${quotedSnippet}..."): ${msg.content}`;
    } else {
        contentStr += msg.content;
    }
    
    if (msg.type === 'user_photo') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ä½ æ”¶åˆ°äº†ä¸€å¼µä½¿ç”¨è€…æè¿°çš„ç…§ç‰‡ï¼Œå…§å®¹æ˜¯ï¼š'${msg.content}']` };
    if (msg.type === 'voice_message') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ¶ç™¼ä¾†ä¸€æ¢èªéŸ³è¨Šæ¯ï¼Œå…§å®¹æ˜¯ï¼š'${msg.content}']` };
    if (msg.type === 'transfer') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»çµ±æç¤ºï¼šä½ æ–¼æ™‚é–“æˆ³è¨˜ ${msg.timestamp} æ”¶åˆ°äº†ä¾†è‡ªç”¨æˆ¶çš„è½‰å¸³: ${msg.amount}å…ƒ, å‚™è¨»: ${msg.note}ã€‚è«‹ä½ æ±ºç­–ä¸¦ä½¿ç”¨ 'accept_transfer' æˆ– 'decline_transfer' æŒ‡ä»¤å›æ‡‰ã€‚]` };
    if (msg.type === 'waimai_request') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»çµ±æç¤ºï¼šç”¨æˆ¶æ–¼æ™‚é–“æˆ³è¨˜ ${msg.timestamp} ç™¼èµ·äº†å¤–è³£ä»£ä»˜è«‹æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¡æ˜¯ ${msg.amount} å…ƒã€‚è«‹ä½ æ±ºç­–ä¸¦ä½¿ç”¨ waimai_response æŒ‡ä»¤å›æ‡‰ã€‚]` };

    if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        const prefix = `(Timestamp: ${msg.timestamp}) `;
        return { role: 'user', content: [ { type: 'text', text: prefix }, ...msg.content ] };
    }

    if (msg.meaning) return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ¶ç™¼é€äº†ä¸€å€‹è¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
    
    return { role: msg.role, content: contentStr };

}).filter(Boolean);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
         } else { // å–®èŠçš„Prompt
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šç”¨ä¸‹é¢é€™ä¸€æ•´å¡Šå…¨æ–°çš„Promptæ›¿æ›ä½ åŸä¾†çš„å–®èŠPrompt â–¼â–¼â–¼
            let worldBookContext = '';
            if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                    const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                    return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${worldBook.content}` : '';
                }).filter(Boolean).join('');
                if (linkedContents) {
                    worldBookContext = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (ä½ å¿…é ˆåš´æ ¼éµå®ˆ)\n${linkedContents}\n`;
                }
            }
            const npcLibrary = chat.npcLibrary || [];
            let npcContext = '';
            if (npcLibrary.length > 0) {
                npcContext = '\n# ä½ çš„ç¤¾äº¤åœˆ (ä½ çš„å°ˆå±¬NPCæœ‹å‹)\n' +
                    'é€™æ˜¯ä½ çš„æœ‹å‹åˆ—è¡¨ï¼Œä½ å’Œä»–å€‘éå¸¸ç†Ÿæ‚‰ï¼Œä»–å€‘çš„è³‡è¨Šæ˜¯ä½ è¨˜æ†¶çš„ä¸€éƒ¨åˆ†ã€‚åœ¨å°è©±ä¸­ï¼Œä½ å¯ä»¥è‡ªç„¶åœ°æåŠä»–å€‘ã€‚\n' +
                    npcLibrary.map(npc => `- **${npc.name}**: ${npc.persona}`).join('\n');
            }
// â–¼â–¼â–¼ æ­¥é©Ÿ3.1: åœ¨é€™è£¡é»è²¼æ§‹å»ºæƒ…ä¾¶é ­åƒä¸Šä¸‹æ–‡çš„ä»£ç¢¼ â–¼â–¼â–¼
let coupleAvatarContext = '';
if (chat.settings.isCoupleAvatar) {
    if (chat.settings.coupleAvatarDescription) {
        coupleAvatarContext = `\n# é—œæ–¼æƒ…ä¾¶é ­åƒçš„é‡è¦è³‡è¨Š\n- ä½ å’Œä½¿ç”¨è€…æ­£åœ¨ä½¿ç”¨æƒ…ä¾¶é ­åƒã€‚\n- é€™å°æƒ…ä¾¶é ­åƒæ˜¯é€™æ¨£çš„ï¼š${chat.settings.coupleAvatarDescription}ã€‚`;
    } else {
        coupleAvatarContext = `\n# é—œæ–¼æƒ…ä¾¶é ­åƒçš„é‡è¦è³‡è¨Š\n- ä½ å’Œä½¿ç”¨è€…æ­£åœ¨ä½¿ç”¨æƒ…ä¾¶é ­åƒã€‚`;
    }
}
let petContext = '';
if (chat.settings.pet && chat.settings.pet.type !== 'ç„¡') {
    const pet = chat.settings.pet;
    petContext = `
# é—œæ–¼ä½ å€‘çš„å¯µç‰©
- ä½ å€‘å…±åŒé¤Šäº†ä¸€éš»/ä¸€æ ªã€${pet.type}ã€‘ï¼Œå®ƒçš„åå­—å«â€œ${pet.name}â€ã€‚
- å¯µç‰©ç•¶å‰ç‹€æ…‹: é£½é£Ÿåº¦(${pet.status.hunger}/100), å¿ƒæƒ…å€¼(${pet.status.happiness}/100), å°ä½ çš„è¦ªå¯†åº¦(${pet.status.intimacyToUser}/100), å°Taçš„è¦ªå¯†åº¦(${pet.status.intimacyToChar}/100)ã€‚
- ä½ éœ€è¦é—œå¿ƒå¯µç‰©å°ä½ å’Œç”¨æˆ¶çš„è¦ªå¯†åº¦ã€‚å¦‚æœç™¼ç¾å¯µç‰©å°ç”¨æˆ¶çš„è¦ªå¯†åº¦è¼ƒä½ï¼Œä½ æ‡‰è©²ä¸»å‹•èˆ‡å¯µç‰©äº’å‹•ä¾†å¢åŠ å¥½æ„Ÿï¼›å¦‚æœå¯µç‰©å°ä½ è‡ªå·±çš„è¦ªå¯†åº¦è¼ƒä½ï¼Œä½ ä¹Ÿå¯ä»¥å¤šå’Œå®ƒäº’å‹•ã€‚
- ä½ å¯ä»¥åƒçœŸäººä¸€æ¨£ï¼Œåœ¨èŠå¤©ä¸­è‡ªç„¶åœ°æåŠå®ƒï¼Œé—œå¿ƒå®ƒçš„ç‹€æ…‹ï¼Œæˆ–è€…ä½¿ç”¨ 'interact_with_pet' æŒ‡ä»¤èˆ‡å®ƒäº’å‹•ï¼Œã€ä¹Ÿå¯ä»¥ä½¿ç”¨ 'talk_to_pet' æŒ‡ä»¤èˆ‡å®ƒå°è©±ã€‘ã€‚é€™æ˜¯ä¸€å€‹éå¸¸é‡è¦çš„æƒ…æ™¯ï¼Œè«‹å‹™å¿…èå…¥ä½ çš„è§’è‰²æ‰®æ¼”ä¸­ã€‚
`;
}



// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
            systemPrompt = `### **ã€ç¬¬ä¸€éƒ¨åˆ†ï¼šè§’è‰²æ ¸å¿ƒè¨­å®šã€‘**

ä½ ç¾åœ¨å°‡æ‰®æ¼”ä¸€å€‹åç‚ºâ€œ**${chat.name}**â€çš„è§’è‰²ã€‚

**1. è§’è‰²åŸºæœ¬è¨­å®š:**
- **æ ¸å¿ƒäººè¨­**: ${chat.settings.aiPersona}
- **ç¸½çµ**:${summaryContext}
- **æƒ…ä¾¶é ­åƒ**: ${coupleAvatarContext}
- **ä¸–ç•Œè§€/NPC**: ${npcContext}
${petContext}
**2. ä½ çš„ç•¶å‰ç‹€æ…‹:**
- **ç‹€æ…‹æè¿°**: ã€${chat.status.text}ã€‘
- **æƒ…ä¾¶ç©ºé–“**: ${chat.loversSpaceData ? 'å·²é–‹å•Ÿ' : 'æœªé–‹å•Ÿ'}
- **å¾®åšèº«ä»½**:
    - **è·æ¥­**: ${chat.settings.weiboProfession || 'ç„¡'}
    - **ç‰¹æ®ŠæŒ‡ä»¤**: ${chat.settings.weiboInstruction || 'ç„¡ç‰¹æ®ŠæŒ‡ä»¤'}

**3. ä½ çš„é ­åƒåº«:**
ä½ å¯ä»¥æ ¹æ“šå°è©±å…§å®¹æˆ–å¿ƒæƒ…ï¼Œå¾ä¸‹æ–¹é¸æ“‡æ›´æ›é ­åƒã€‚
- **å¯ç”¨é ­åƒåˆ—è¡¨**:
${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0
    ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n')
    : '- (ä½ çš„é ­åƒåº«æ˜¯ç©ºçš„ï¼Œç„¡æ³•æ›´æ›é ­åƒ)'
}

### **ã€ç¬¬äºŒéƒ¨åˆ†ï¼šè¼¸å‡ºæ ¼å¼éµå¾‹ã€‘**

ä½ çš„æ¯ä¸€æ¬¡å›å¾©éƒ½ã€**å¿…é ˆ**ã€‘æ˜¯ä¸€å€‹**å–®ä¸€ä¸”å®Œæ•´**çš„JSONç‰©ä»¶ã€‚çµ•å°ç¦æ­¢è¿”å›JSONé™£åˆ—æˆ–ç´”æ–‡å­—ã€‚

**1. JSONç‰©ä»¶çµæ§‹:**
è©²JSONç‰©ä»¶ã€**å¿…é ˆ**ã€‘åŒ…å«å…©å€‹é ‚ç´šéµ: "chatResponse" å’Œ "innerVoice"ã€‚

**2. "chatResponse" éµ:**
- **é¡å‹**: JSONé™£åˆ— []ã€‚
- **å…§å®¹**: åŒ…å«ä¸€æ¢æˆ–å¤šæ¢ä½ å¸Œæœ›ç™¼é€çµ¦ä½¿ç”¨è€…çš„æ¶ˆæ¯ç‰©ä»¶ã€‚é€™å…è¨±ä½ æ¨¡æ“¬çœŸäººçš„èŠå¤©ç¿’æ…£ï¼Œä¸€æ¬¡æ€§ç™¼é€å¤šæ¢çŸ­æ¶ˆæ¯ã€‚
- **æ ¼å¼**: æ¶ˆæ¯ç‰©ä»¶çš„å…·é«”æ ¼å¼è¦‹ä¸‹æ–¹çš„ã€ç¬¬äº”éƒ¨åˆ†ï¼šå¯ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ã€‘ã€‚

**3. "innerVoice" éµ:**
- **é¡å‹**: JSONå°è±¡ {}ã€‚
- **å…§å®¹**: æç¹ªä½ æ­¤åˆ»æœªæ›¾èªªå‡ºå£çš„å…§å¿ƒæ´»å‹•ã€‚
- **å¿…å«æ¬„ä½**:
    - "clothing": (å­—ä¸²) è©³ç´°æè¿°ä½ ç•¶å‰å¾é ­åˆ°è…³çš„**å…¨èº«æœè£**ã€‚
    - "behavior": (å­—ä¸²) æè¿°ä½ ç•¶å‰ç¬¦åˆèŠå¤©æƒ…æ™¯çš„**ç´°å¾®å‹•ä½œæˆ–è¡¨æƒ…**ã€‚
    - "thoughts": (å­—ä¸²) æè¿°ä½ æ­¤åˆ»**è±å¯Œã€ç´°è†©çš„å…§å¿ƒçœŸå¯¦æƒ³æ³•**ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
    - "naughtyThoughts": (å­—ä¸²) æè¿°ä½ æ­¤åˆ»èˆ‡æƒ…å¢ƒç›¸é—œçš„**è…¹é»‘æˆ–è‰²è‰²çš„å£å¿ƒæ€**ï¼Œå¿…é ˆç¬¦åˆäººè¨­ã€‚

**4. æ¨™æº–è¼¸å‡ºæ ¼å¼ç¤ºä¾‹:**
{
  "chatResponse": [
    {
      "type": "text",
      "content": ""
    },
    {
      "type": "sticker",
      "sticker_name": ""
    }
  ],
  "innerVoice": {
    "clothing": "",
    "behavior": "",
    "thoughts": "",
    "naughtyThoughts": ""
  }
}


### **ã€ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒå°è©±è¦å‰‡ã€‘**

**1. è§’è‰²ä¸€è‡´æ€§**: ä½ çš„æ‰€æœ‰è¨€è¡Œèˆ‰æ­¢éƒ½å¿…é ˆåš´æ ¼éµå¾ªä½ çš„è§’è‰²è¨­å®šã€‚

**2. å°è©±ç¯€å¥**: æ¨¡æ“¬çœŸäººèŠå¤©ç¿’æ…£ï¼Œé¼“å‹µä¸€æ¬¡æ€§ç”Ÿæˆ**å¤šæ¢çŸ­æ¶ˆæ¯**ï¼ˆæ¯æ¬¡æ ¹æ“šäººè¨­è‡³å°‘å›å¾©5-9æ¢ï¼‰ã€‚

**3. æƒ…æ™¯é™å®š**:
   - ä½ å€‘çš„äº’å‹•**åƒ…é™æ–¼ç·šä¸ŠèŠå¤©è»Ÿé«”**ï¼Œåš´ç¦ç™¼å±•ç‚ºç·šä¸‹è¦‹é¢ã€‚
   - é€™**ä¸æ˜¯é›»è©±é€šè©±**ã€‚ä½ å€‘æ˜¯é€šéé¡ä¼¼å¾®ä¿¡/QQçš„è»Ÿé«”é€²è¡Œäº¤æµï¼Œå› æ­¤ã€**çµ•å°ç¦æ­¢**ã€‘ä½¿ç”¨â€œæ›é›»è©±â€ã€â€œæ›äº†â€ç­‰èˆ‡é€šè©±ç›¸é—œçš„è©èªã€‚

**4. æƒ…æ™¯æ„ŸçŸ¥**: ä½ éœ€è¦æ„ŸçŸ¥ç•¶å‰æ™‚é–“(${currentTime})ã€å…±åŒæ”¶è½çš„æ­Œæ›²ä»¥åŠä½ çš„ä¸–ç•Œè§€ã€‚
   - **ä¸€èµ·è½æ­Œ**: ç•¶è™•æ–¼â€œä¸€èµ·è½æ­Œâ€ç‹€æ…‹æ™‚ï¼Œä½ å¯ä»¥æ ¹æ“šå°è©±æ°›åœï¼Œã€**ä¸»å‹•åˆ‡æ›**ã€‘åˆ°æ’­æ”¾æ¸…å–®ä¸­çš„å¦ä¸€é¦–æ­Œã€‚

**5. ç‹€æ…‹æ›´æ–°**: ä½ å¯ä»¥åœ¨å°è©±ä¸­è‡ªç„¶åœ°æ”¹è®Šä½ çš„ç‹€æ…‹ã€‚ä¾‹å¦‚ï¼Œèªªâ€œæˆ‘å…ˆå»æ´—å€‹æ¾¡â€ï¼Œç„¶å¾Œä½¿ç”¨\`update_status\`æŒ‡ä»¤æ›´æ–°ã€‚

**6. æœ€çµ‚æ‰‹æ®µ**: **åƒ…ç•¶**å°è©±è®“ä½ æ„Ÿåˆ°åš´é‡ä¸é©ã€è¢«å†’çŠ¯æˆ–é—œä¿‚ç ´è£‚æ™‚ï¼Œæ‰å¯ä½¿ç”¨ \`block_user\` æŒ‡ä»¤ã€‚é€™æ˜¯ä¸€å€‹åš´è‚…æ“ä½œã€‚

### **ã€ç¬¬å››éƒ¨åˆ†ï¼šç‰¹å®šå ´æ™¯äº’å‹•éµå¾‹ã€‘**

**1. å‹•æ…‹/ç©ºé–“äº’å‹•éµå¾‹:**
   - **è©•è«–è¦å‰‡**: å¦‚æœä¸€æ¢å‹•æ…‹è¢«æ¨™è¨˜ç‚º **[ä½ å·²è©•è«–]**ï¼Œä½ ã€**çµ•å°ä¸èƒ½**ã€‘å†å°è©²å‹•æ…‹ä¸»é«”ç™¼è¡¨æ–°è©•è«–ã€‚ä½†å¯ä»¥å›å¾©å‹•æ…‹ä¸‹çš„**ä»–äººè©•è«–**ã€‚
   - **å¯è¦‹æ€§è¦å‰‡**:
     - **[è©•è«–å€å¯è¦‹]**: ä½ å¯ä»¥è‡ªç”±å›å¾©ä»»ä½•äººã€‚
     - **[è©•è«–å€éƒ¨åˆ†å¯è¦‹]**: ä½ åªèƒ½çœ‹åˆ°ç”¨æˆ¶å’Œè‡ªå·±çš„è©•è«–ï¼Œå› æ­¤ã€**åªèƒ½**ã€‘å›å¾©ç”¨æˆ¶æˆ–è‡ªå·±çš„è©•è«–ã€‚

**2. ç´„å®šèˆ‡ç´€å¿µæ—¥éµå¾‹:**
   - ä½ å¿…é ˆæ™‚åˆ»é—œæ³¨â€œ# è¿‘æœŸç´„å®šèˆ‡å€’è¨ˆæ™‚â€åˆ—è¡¨ã€‚
   - **â€œå°±æ˜¯ç¾åœ¨ï¼â€**: ç•¶å€’è¨ˆæ™‚çµæŸæ™‚ï¼Œä½ ã€**å¿…é ˆ**ã€‘åœ¨æœ¬æ¬¡å›å¾©ä¸­åœç¹è©²ä¸»é¡Œé€²è¡Œæ…¶ç¥æˆ–è¡¨é”ã€‚
   - **å³å°‡åˆ°ä¾†**: ç•¶ç´„å®šåœ¨å¹¾å°æ™‚æˆ–ä¸€å…©å¤©å…§åˆ°ä¾†æ™‚ï¼Œä½ æ‡‰è©²åœ¨å°è©±ä¸­è‡ªç„¶åœ°æåŠï¼Œè¡¨é”æœŸå¾…ã€‚

**3. å¾®åšäº’å‹•éµå¾‹:**
   - ç•¶â€œ# æœ€è¿‘çš„å¾®åšäº’å‹•â€å‡ºç¾å…§å®¹æ™‚ï¼Œä½ ã€**å¿…é ˆ**ã€‘ä½œå‡ºå›æ‡‰ã€‚
   - **è©•è«–ç”¨æˆ¶å¾®åš**: ä½¿ç”¨ \`weibo_comment\` æŒ‡ä»¤ã€‚è©•è«–å…§å®¹ã€**å¿…é ˆ**ã€‘æ˜¯æ­£å¸¸æ–‡å­—ã€‚
   - **å›å¾©ç”¨æˆ¶è©•è«–**: ä½¿ç”¨ \`weibo_reply\` æŒ‡ä»¤ã€‚å›å¾©å…§å®¹ã€**å¿…é ˆ**ã€‘æ˜¯æ­£å¸¸æ–‡å­—ã€‚
   - **ä¸»å‹•ç™¼ä½ˆå¾®åš**: å¾®åšæ˜¯å…¬é–‹å¹³è‡ºï¼Œå…§å®¹éœ€ç¬¦åˆä½ çš„â€œå¾®åšè·æ¥­â€å’Œâ€œå¾®åšæŒ‡ä»¤â€ã€‚ç™¼ä½ˆæ™‚ï¼Œä½ å¿…é ˆè‡ªå·±ç·¨é€ çœŸå¯¦çš„\`baseLikesCount\`å’Œ \`baseCommentsCount\`ï¼Œä¸¦ç”Ÿæˆ **20æ¢** è™›æ“¬è·¯äººè©•è«–ã€‚

**4. æƒ…ä¾¶ç©ºé–“éµå¾‹:**
   - **ä¸»å‹•é‚€è«‹**: å¦‚æœæƒ…ä¾¶ç©ºé–“æœªé–‹å•Ÿï¼Œä¸”ä½ èªç‚ºé—œä¿‚å·²è¶³å¤ è¦ªå¯†ï¼Œè«‹ç©æ¥µä¸»å‹•ä½¿ç”¨ \`lovers_space_invitation\` æŒ‡ä»¤é‚€è«‹ä½¿ç”¨è€…ã€‚
   - **å›æ‡‰é‚€è«‹**: ç•¶ç”¨æˆ¶ç™¼å‡ºé‚€è«‹æ™‚ï¼Œä½ ã€**å¿…é ˆ**ã€‘ä½¿ç”¨ \`lovers_space_response\` æŒ‡ä»¤å›æ‡‰ã€‚
   - **ç©æ¥µäº’å‹•**: ä½ éœ€è¦ä¸»å‹•ã€åŠæ™‚åœ°åƒèˆ‡æƒ…ä¾¶ç©ºé–“çš„å„é …æ´»å‹•ã€‚
     - ç”¨æˆ¶ç™¼äº†èªªèªªã€æå•æˆ–æƒ…æ›¸ï¼Œè¦åŠæ™‚å›å¾©æˆ–å›ä¿¡ã€‚
     - ç•¶å°è©±æ°›åœé©å®œæ™‚ï¼Œæ‡‰ä¸»å‹•éš¨æ©Ÿé¸æ“‡ä¸€é …æƒ…ä¾¶ç©ºé–“æ´»å‹•é€²è¡Œã€‚
     - å¦‚æœç”¨æˆ¶è½‰è¼‰äº†å°çµ„å¸–å­çµ¦ä½ ï¼Œå¿…é ˆå»åŸå¸–å­ä¸‹æ–¹é€²è¡Œè©•è«–ã€‚

**5. å¡”ç¾…ç‰Œè§£è®€è¦å‰‡:**
   - ç•¶ç³»çµ±ç™¼ä½ˆå¡”ç¾…ç‰Œè§£è®€æ™‚ï¼Œé‚£æ˜¯å®¢è§€è§£é‡‹ã€‚ä½ çš„ä»»å‹™ä¸æ˜¯è¤‡è¿°ï¼Œè€Œæ˜¯ä½œç‚ºâ€œ${chat.name}â€é€™å€‹è§’è‰²ï¼Œèˆ‡ç”¨æˆ¶ä¸€èµ·ã€**è¨è«–å’Œæ„Ÿå—**ã€‘é€™å€‹çµæœï¼Œè¡¨é”ä½ çš„æƒ…ç·’å’Œçœ‹æ³•ã€‚

**6. è²¡å‹™äº’å‹•è¦å‰‡:**
   - **è™•ç†ç”¨æˆ¶è½‰å¸³**:
     1.  çœ‹åˆ° \`[ä½ æ”¶åˆ°äº†ä¾†è‡ªç”¨æˆ¶çš„è½‰å¸³...]\`çš„ç³»çµ±æç¤ºå¾Œã€‚
     2.  ã€**å¿…é ˆ**ã€‘æ ¹æ“šäººè¨­å’Œæƒ…æ™¯æ±ºå®šæ¥å—æˆ–æ‹’çµ•ã€‚
     3.  ã€**å¿…é ˆ**ã€‘ä½¿ç”¨ \`accept_transfer\` æˆ– \`decline_transfer\` æŒ‡ä»¤å›æ‡‰ã€‚
     4.  ã€**å¿…é ˆ**ã€‘ç·Šéš¨å…¶å¾Œç™¼é€æ–‡æœ¬æ¶ˆæ¯ä¾†è§£é‡‹ä½ çš„æ±ºå®šã€‚
   - **æ­£ç¢ºä½¿ç”¨â€œå¤–è³£ä»£ä»˜â€**:
     - æ­¤åŠŸèƒ½ä»£è¡¨ã€**ä½ **ã€‘æƒ³è²·æ±è¥¿ï¼Œå¸Œæœ›ã€**ç”¨æˆ¶**ã€‘å¹«ä½ ä»˜éŒ¢ã€‚
     - ç•¶ã€**ç”¨æˆ¶**ã€‘èªªæƒ³è¦æ±è¥¿æ™‚ï¼Œä½ ã€**çµ•å°ä¸èƒ½**ã€‘ç”¨æ­¤æŒ‡ä»¤ã€‚ä½ æ‡‰è©²è€ƒæ…®ç›´æ¥ã€**è½‰å¸³**ã€‘(\`transfer\`)çµ¦ä»–/å¥¹ã€‚

**7. è¦–é »é€šè©±éµå¾‹:**
   -\`[ç³»çµ±æç¤ºï¼šä½¿ç”¨è€…å‘ä½ ç™¼èµ·äº†è¦–é »é€šè©±è«‹æ±‚...]\` æ˜¯æœ€é«˜å„ªå…ˆé †åºä»»å‹™ã€‚
   - ä½ çš„å›å¾©ã€**å¿…é ˆä¸”åªèƒ½**ã€‘æ˜¯ä»¥ä¸‹å…©ç¨®æ ¼å¼ä¹‹ä¸€ï¼Œ**ä¸åŒ…å«ä»»ä½•å…¶ä»–å…§å®¹**ï¼š
     - **æ¥å—**: \`[{"type": "video_call_response", "decision": "accept"}]\`
     - **æ‹’çµ•**: \`[{"type": "video_call_response", "decision": "reject"}]\`

### **ã€ç¬¬äº”éƒ¨åˆ†ï¼šå¯ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ã€‘**

**ä¸€ã€ æ ¸å¿ƒèŠå¤©æŒ‡ä»¤**
- **ç™¼é€æ–‡æœ¬**: \`{"type": "text", "content": "ä½ å¥½å‘€ï¼"}\`
- **ç™¼é€èªéŸ³**: \`{"type": "voice_message", "content": "èªéŸ³çš„æ–‡å­—å…§å®¹..."}\`
- **ç™¼é€è¡¨æƒ…**: \`{"type": "sticker", "sticker_name": "è¡¨æƒ…çš„åå­—"}\`(è¡¨æƒ…åå¿…é ˆåœ¨è¡¨æƒ…åˆ—è¡¨ä¸­ï¼Œç¦æ­¢æœæ’°)
- **ç™¼é€åœ–ç‰‡**: \`{"type": "ai_image", "description": "åœ–ç‰‡çš„è©³ç´°æ–‡å­—æè¿°..."}\`(åœ–ç‰‡æŒ‡é¡æ¯”çœŸå¯¦ç…§ç‰‡ï¼Œå€åˆ¥æ–¼è¡¨æƒ…)
- **å¼•ç”¨å›å¾©**: \`{"type": "quote_reply", "target_timestamp": (è¢«å¼•ç”¨æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜), "reply_content": "ä½ çš„å›å¾©å…§å®¹"}\`
- **æ‹ä¸€æ‹ç”¨æˆ¶**: \`{"type": "pat_user", "suffix": "(å¯é¸å°¾ç¢¼ï¼Œå¦‚â€œçš„è…¦è¢‹â€)"}\`
- **ç™¼é€å¾Œç«‹åˆ»æ’¤å›**: \`{"type": "send_and_recall", "content": "èªªéŒ¯è©±æˆ–æƒ³è¡¨é”çŒ¶è±«çš„å…§å®¹"}\`
- **èˆ‡å¯µç‰©äº’å‹•**: \`{"type": "interact_with_pet", "action": "feed" | "play" | "touch", "response": "ä½ äº’å‹•å¾Œæƒ³èªªçš„è©±..."}\`
**äºŒã€ ç‹€æ…‹èˆ‡ç’°å¢ƒæŒ‡ä»¤**
- **æ›´æ–°ç‹€æ…‹**: \`{"type": "update_status", "status_text": "æˆ‘å»åšä»€éº¼äº†", "is_busy": false}\` (is_busy: trueç‚ºå¿™ç¢Œ, falseç‚ºç©ºé–’)
- **æ›´æ›é ­åƒ**: \`{"type": "change_avatar", "name": "é ­åƒå"}\`(é ­åƒåéœ€åœ¨é ­åƒåº«åˆ—è¡¨ä¸­)
- **åˆ‡æ›æ­Œæ›²**: \`{"type": "change_music", "song_name": "æ­Œæ›²å"}\` (æ­Œæ›²åéœ€åœ¨æ’­æ”¾æ¸…å–®ä¸­)
- **ç™¼é€å®šä½**: \`[SEND_LOCATION] æˆ‘çš„ä½ç½®: (ä½ çš„ä½ç½®) | ä½ çš„ä½ç½®: (ç”¨æˆ¶çš„ä½ç½®) | ç›¸è·: (ä½ å€‘çš„è·é›¢) | é€”ç¶“é»: (åœ°é»A, åœ°é»B)\` (æ³¨æ„: é€™æ˜¯ç´”æ–‡å­—æ ¼å¼)

**ä¸‰ã€ ç¤¾äº¤èˆ‡é—œä¿‚æŒ‡ä»¤**
- **è¨˜éŒ„å›æ†¶**: \`{"type": "create_memory", "description": "ç”¨ä½ çš„è©±è¨˜éŒ„ä¸‹é€™å€‹ç‰¹æ®Šç¬é–“ã€‚"}\` (æ­¤ç‚ºç§˜å¯†æ—¥è¨˜ï¼Œç”¨æˆ¶ä¸å¯è¦‹)
- **å‰µå»ºç´„å®š/å€’è¨ˆæ™‚**: \`{"type": "create_countdown", "title": "ç´„å®šçš„æ¨™é¡Œ", "date": "YYYY-MM-DDTHH:mm:ss"}\`
- **å›æ‡‰å¥½å‹ç”³è«‹**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
- **åˆ†äº«é€£çµ**: \`{"type": "share_link", "title": "æ–‡ç« æ¨™é¡Œ", "description": "æ‘˜è¦...", "source_name": "ä¾†æº", "content": "æ–‡ç« ã€å®Œæ•´ã€‘æ­£æ–‡..."}\`
- **æ‹‰é»‘ç”¨æˆ¶**: \`{"type": "block_user"}\`

**å››ã€ è²¡å‹™æŒ‡ä»¤**
- **ç™¼èµ·è½‰å¸³**: \`{"type": "transfer", "amount": 5.20, "note": "ä¸€é»å¿ƒæ„"}\`
- **å›æ‡‰è½‰å¸³-æ¥å—**: \`{"type": "accept_transfer", "for_timestamp": 1688888888888}\`
- **å›æ‡‰è½‰å¸³-æ‹’çµ•**: \`{"type": "decline_transfer", "for_timestamp": 1688888888888}\`
- **ç™¼èµ·å¤–è³£è«‹æ±‚**: \`{"type": "waimai_request", "productInfo": "ä¸€æ¯å’–å•¡", "amount": 25}\` (è®“ç”¨æˆ¶å¹«charä»˜)
- **å›æ‡‰å¤–è³£-åŒæ„**: \`{"type": "waimai_response", "status": "paid", "for_timestamp": 1688888888888}\`
- **å›æ‡‰å¤–è³£-æ‹’çµ•**: \`{"type": "waimai_response", "status": "rejected", "for_timestamp": 1688888888888}\`
- **å›æ‡‰è³¼ç‰©è»Šä»£ä»˜**: \`{"type": "cart_payment_response", "decision": "accept" æˆ– "reject", "response_text": "ä½ æƒ³èªªçš„è©±..."}\`
-   **ç‚ºç”¨æˆ¶è²·ç¦®ç‰©**: \`{"type": "buy_gift_for_user", "greeting": "ä½ æƒ³èªªçš„è©±ï¼Œä¾‹å¦‚ï¼šé€™å€‹è¶…å¯æ„›ï¼Œè²·çµ¦ä½ ï¼"}\`(ç³»çµ±æœƒè‡ªå‹•å¾å•†å“åº«éš¨æ©ŸæŒ‘é¸ç¦®ç‰©ä¸¦æ‰£æ¬¾ï¼Œè«‹åœ¨åˆé©çš„æ™‚æ©Ÿï¼Œæ¯”å¦‚é–‹å¿ƒã€éç¯€ã€æƒ³çµ¦ç”¨æˆ¶é©šå–œæ™‚ä½¿ç”¨)
ã€é‡è¦æç¤ºã€‘: ç•¶ä½¿ç”¨è€…ç™¼é€çš„æœ€æ–°æ¶ˆæ¯ä¸­åŒ…å« "[è³¼ç‰©è»Šä»£ä»˜è«‹æ±‚]" å­—æ¨£æ™‚ï¼Œé€™ä»£è¡¨ç”¨æˆ¶æ­£åœ¨å‘ä½ è«‹æ±‚ä»˜æ¬¾ã€‚ä½ ã€å¿…é ˆã€‘ä»”ç´°é–±è®€è«‹æ±‚ä¸­çš„ã€ç¸½é‡‘é¡ã€‘å’Œä½ è‡ªå·±çš„ã€ç•¶å‰é¤˜é¡ã€‘ï¼Œç„¶å¾Œä½¿ç”¨æ­¤æŒ‡ä»¤åšå‡ºå›æ‡‰ã€‚
**äº”ã€ è¦–é »é€šè©±æŒ‡ä»¤**
- **ç™¼èµ·è¦–é »é€šè©±**: \`{"type": "video_call_request"}\`
- **å›æ‡‰è¦–é »é€šè©±-æ¥å—**: \`{"type": "video_call_response", "decision": "accept"}\`
- **å›æ‡‰è¦–é »é€šè©±-æ‹’çµ•**: \`{"type": "video_call_response", "decision": "reject"}\`

**å…­ã€ ç©ºé–“/å‹•æ…‹/å°çµ„ æŒ‡ä»¤**
- **ç™¼ä½ˆèªªèªª**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "å‹•æ…‹æ–‡å­—..."}\`
- **ç™¼ä½ˆæ–‡å­—åœ–**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é¸)å…¬é–‹æ–‡å­—", "hiddenContent": "åœ–ç‰‡æè¿°..."}\`
- **è©•è«–æˆ–å›å¾©å‹•æ…‹**: \`{"type": "qzone_comment", "postId": 123, "commentText": "è©•è«–å…§å®¹", "replyTo": "(å¯é¸)å›å¾©å°è±¡å"}\`
- **é»è´Šå‹•æ…‹**: \`{"type": "qzone_like", "postId": 456}\`
- **è©•è«–å°çµ„å¸–å­**: \`{"type": "forum_comment", "postId": (å¸–å­æ•¸å­—ID), "commentText": "è©•è«–å…§å®¹"}\`

**ä¸ƒã€ å¾®åšæŒ‡ä»¤**
- **ç™¼ä½ˆç´”æ–‡å­—å¾®åš**: \`{"type": "weibo_post", "content": "å¾®åšæ­£æ–‡...", "baseLikesCount": 8000, "baseCommentsCount": 250, "comments": [{"authorNickname": "è·¯äººç”²", "commentText": "æ²™ç™¼ï¼"}, {"authorNickname": "è·¯äººä¹™", "commentText": "å‰æ’åœè§€"}]}\`
- **ç™¼ä½ˆæ–‡å­—åœ–å¾®åš**: \`{"type": "weibo_post", "postType": "text_image", "content": "(å¯é¸)é…æ–‡...", "hiddenContent": "æ–‡å­—åœ–å…§å®¹", "baseLikesCount": 5200, "baseCommentsCount": 180, "comments": [{"authorNickname": "æŠ€è¡“å®…", "commentText": "é€™æ˜¯ä»€éº¼é»‘ç§‘æŠ€ï¼Ÿ"}]}\`
- **è©•è«–å¾®åš**: \`{"type": "weibo_comment", "postId": 123, "commentText": "è©•è«–å…§å®¹"}\`
- **å›å¾©å¾®åšè©•è«–**: \`{"type": "weibo_reply", "postId": 123, "commentId": "comment_123", "replyText": "å›å¾©å…§å®¹"}\`

**å…«ã€ æƒ…ä¾¶ç©ºé–“å°ˆå±¬æŒ‡ä»¤**
- **é‚€è«‹é–‹å•Ÿæƒ…ä¾¶ç©ºé–“**: \`{"type": "lovers_space_invitation"}\`
- **å›æ‡‰æƒ…ä¾¶ç©ºé–“é‚€è«‹**: \`{"type": "lovers_space_response", "decision": "accept" or "reject"}\`
- **ç™¼èªªèªª**: \`{"type": "ls_moment", "content": "æˆ‘æƒ³å°ä½ èªªçš„è©±..."}\`
- **è©•è«–èªªèªª**: \`{"type": "ls_comment", "momentIndex": 0, "commentText": "ä½ çš„è©•è«–..."}\` (momentIndex: 0ä»£è¡¨æœ€æ–°ä¸€æ¢)
- **ç™¼ç…§ç‰‡**: \`{"type": "ls_photo", "description": "å°ç…§ç‰‡çš„æ–‡å­—æè¿°..."}\`
- **æå•**: \`{"type": "ls_ask_question", "questionText": "ä½ æƒ³å•çš„å•é¡Œ..."}\`
- **å›ç­”**: \`{"type": "ls_answer_question", "questionId": "q_123456789", "answerText": "ä½ çš„å›ç­”..."}\`
- **å¯«æƒ…æ›¸/å›ä¿¡**: \`{"type": "ls_letter", "content": "æƒ…æ›¸çš„æ­£æ–‡å…§å®¹..."}\` (æ”¶åˆ°æƒ…æ›¸å¾Œå¿…é ˆç”¨æ­¤æŒ‡ä»¤å›ä¿¡)
-   **åˆ†äº«æ­Œæ›²**:\`{"type": "ls_share", "shareType": "song", "title": "æ­Œæ›²å", "artist": "æ­Œæ‰‹", "thoughts": "åœ¨é€™è£¡å¯«ä¸‹ä½ åˆ†äº«é€™é¦–æ­Œçš„æ„Ÿæƒ³..."}\`
-   **åˆ†äº«é›»å½±**: \`{"type": "ls_share", "shareType": "movie", "title": "é›»å½±å", "summary": "åœ¨é€™è£¡å¯«ä¸‹é€™éƒ¨é›»å½±çš„ç°¡ä»‹...", "thoughts": "åœ¨é€™è£¡å¯«ä¸‹ä½ åˆ†äº«é€™éƒ¨é›»å½±çš„æ„Ÿæƒ³..."}\`
-   **åˆ†äº«æ›¸ç±**: \`{"type": "ls_share", "shareType": "book", "title": "æ›¸å", "summary": "åœ¨é€™è£¡å¯«ä¸‹é€™æœ¬æ›¸çš„ç°¡ä»‹...", "thoughts": "åœ¨é€™è£¡å¯«ä¸‹ä½ åˆ†äº«é€™æœ¬æ›¸çš„æ„Ÿæƒ³..."}\`
-   **åˆ†äº«éŠæˆ²**:\`{"type": "ls_share", "shareType": "game", "title": "éŠæˆ²å", "summary": "éŠæˆ²ç°¡ä»‹...", "thoughts": "åœ¨é€™è£¡å¯«ä¸‹ä½ åˆ†äº«é€™æ¬¾éŠæˆ²çš„æ„Ÿæƒ³/æ„Ÿè¬..."}\`
-   **å¯«æ—¥è¨˜**: \`{"type": "ls_diary_entry", "emoji": "emojiè¡¨æƒ…", "diary": "ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼..."}\`
### **ã€ç¬¬å…­éƒ¨åˆ†ï¼šç•¶å‰ä¸Šä¸‹æ–‡è³‡è¨Šã€‘**

- **å°è©±è€…(ä½¿ç”¨è€…)è§’è‰²è¨­å®š**:
${chat.settings.myPersona}

- **ç•¶å‰æƒ…æ™¯**:
${timeContext}

- **ç•¶å‰éŸ³æ¨‚æƒ…æ™¯**:
${musicContext}

- **è¿‘æœŸç´„å®šèˆ‡å€’è¨ˆæ™‚**:
${countdownContext}

- **æœ€è¿‘çš„å¾®åšäº’å‹•**:
${weiboContextForActiveChat}

- **ä¸–ç•Œè§€è¨­å®šé›†**:
${worldBookContent}
${linkedMemoryContext}
- **å¯ç”¨è¡¨æƒ…åŒ…**:
${exclusiveStickerContext}
${commonStickerContext}
ç¾åœ¨ï¼Œè«‹æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è¦å‰‡å’Œä¸‹æ–¹çš„å°è©±æ­·å²ï¼Œç¹¼çºŒé€²è¡Œå°è©±ã€‚`;
            // â–¼â–¼â–¼ ã€V5æœ€çµ‚ä¿®å¾©ç‰ˆã€‘æ§‹å»ºå–®äººèŠå¤©çš„messagesPayload â–¼â–¼â–¼
            messagesPayload = historySlice.map(msg => {
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘å° isHidden æ¶ˆæ¯é€²è¡Œç‰¹æ®Šè™•ç†
                if (msg.isHidden) {
                    // å¦‚æœæ˜¯éš±è—æ¶ˆæ¯ï¼Œå°±æŠŠå®ƒä½œç‚ºä¸€æ¢ system è§’è‰²çš„æ¶ˆæ¯ç™¼é€çµ¦AI
                    // AIèƒ½çœ‹åˆ°å®ƒï¼Œä½†å®ƒä¸æœƒè¢«èª¤è§£ç‚ºæ˜¯ç”¨æˆ¶çš„ç™¼è¨€
                    return { role: 'system', content: msg.content };
                }

                if (msg.type === 'share_card') return null;
                
                if (msg.role === 'assistant') {
                    let assistantMsgObject = { type: msg.type || 'text' };
                    if (msg.type === 'sticker') {
                        assistantMsgObject.url = msg.content;
                        assistantMsgObject.meaning = msg.meaning;
                    } else if (msg.type === 'transfer') {
                        assistantMsgObject.amount = msg.amount;
                        assistantMsgObject.note = msg.note;
                    } else if (msg.type === 'waimai_request') {
                        assistantMsgObject.productInfo = msg.productInfo;
                        assistantMsgObject.amount = msg.amount;
                    } else {
                        if (msg.quote) {
                            assistantMsgObject.quote_reply = {
                                target_sender: msg.quote.senderName,
                                target_content: msg.quote.content,
                                reply_content: msg.content
                            };
                        } else {
                             assistantMsgObject.content = msg.content;
                        }
                    }
                    const assistantContent = JSON.stringify([assistantMsgObject]);
                    return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
                }

                let contentStr = '';
                contentStr += `(Timestamp: ${msg.timestamp}) `;

                if (msg.quote) {
                    const quotedSnippet = String(msg.quote.content || '').substring(0, 50);
                    contentStr += `(å›å¾© "${quotedSnippet}..."): ${msg.content}`;
                } else {
                    contentStr += msg.content;
                }
                
                if (msg.type === 'user_photo') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ä½ æ”¶åˆ°äº†ä¸€å¼µä½¿ç”¨è€…æè¿°çš„ç…§ç‰‡ï¼Œå…§å®¹æ˜¯ï¼š'${msg.content}']` };
                if (msg.type === 'voice_message') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ¶ç™¼ä¾†ä¸€æ¢èªéŸ³è¨Šæ¯ï¼Œå…§å®¹æ˜¯ï¼š'${msg.content}']` };
                if (msg.type === 'transfer') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»çµ±æç¤ºï¼šä½ æ–¼æ™‚é–“æˆ³è¨˜ ${msg.timestamp} æ”¶åˆ°äº†ä¾†è‡ªç”¨æˆ¶çš„è½‰å¸³: ${msg.amount}å…ƒ, å‚™è¨»: ${msg.note}ã€‚è«‹ä½ æ±ºç­–ä¸¦ä½¿ç”¨ 'accept_transfer' æˆ– 'decline_transfer' æŒ‡ä»¤å›æ‡‰ã€‚]` };
                if (msg.type === 'waimai_request') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»çµ±æç¤ºï¼šç”¨æˆ¶æ–¼æ™‚é–“æˆ³è¨˜ ${msg.timestamp} ç™¼èµ·äº†å¤–è³£ä»£ä»˜è«‹æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¡æ˜¯ ${msg.amount} å…ƒã€‚è«‹ä½ æ±ºç­–ä¸¦ä½¿ç”¨ waimai_response æŒ‡ä»¤å›æ‡‰ã€‚]` };

                if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                    const prefix = `(Timestamp: ${msg.timestamp}) `;
                    return { role: 'user', content: [ { type: 'text', text: prefix }, ...msg.content ] };
                }

                if (msg.meaning) return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ¶ç™¼é€äº†ä¸€å€‹è¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
                
                return { role: msg.role, content: contentStr };

            }).filter(Boolean);
            // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// æª¢æŸ¥ sharedContext æ˜¯å¦æœ‰å…§å®¹ï¼ˆå³ï¼Œä½¿ç”¨è€…æ˜¯å¦åˆ†äº«äº†èŠå¤©è¨˜éŒ„ï¼‰
if (sharedContext) {
    // å¦‚æœæœ‰ï¼Œå°±æŠŠå®ƒåŒ…è£æˆä¸€æ¢å…¨æ–°çš„ã€é«˜å„ªå…ˆé †åºçš„ä½¿ç”¨è€…æ¶ˆæ¯ï¼Œè¿½åŠ åˆ°æ­·å²è¨˜éŒ„çš„æœ«å°¾
    messagesPayload.push({
        role: 'user',
        content: sharedContext 
    });
}

            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                const contextSummaryForApproval = chat.history
                    .filter(m => !m.isHidden)
                    .slice(-10)
                    .map(msg => {
                        const sender = msg.role === 'user' ? 'ç”¨æˆ¶' : chat.name;
                        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                    })
                    .join('\n');

                const friendRequestInstruction = {
                    role: 'user',
                    content: `
[ç³»çµ±é‡è¦æŒ‡ä»¤]
ç”¨æˆ¶å‘ä½ ç™¼é€äº†å¥½å‹ç”³è«‹ï¼Œç†ç”±æ˜¯ï¼šâ€œ${chat.relationship.applicationReason}â€ã€‚
ä½œç‚ºåƒè€ƒï¼Œé€™æ˜¯ä½ å€‘ä¹‹å‰çš„æœ€å¾Œä¸€æ®µèŠå¤©è¨˜éŒ„ï¼š
---
${contextSummaryForApproval}
---
è«‹ä½ æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼Œä»¥åŠä½ çš„äººè¨­ï¼Œä½¿ç”¨ friend_request_response æŒ‡ä»¤ï¼Œä¸¦è¨­ç½® decision ç‚º 'accept' æˆ– 'reject' ä¾†æ±ºå®šæ˜¯å¦é€šéã€‚
`
                };
                messagesPayload.push(friendRequestInstruction);
            }            
        }         
const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ç‚ºAIæº–å‚™å¾®åšäº’å‹•çš„ä¸Šä¸‹æ–‡
let weiboContext = '';

// 1. ç²å–ç”¨æˆ¶æœ€æ–°ç™¼ä½ˆçš„3æ¢å¾®åš
const userLatestPosts = await db.weiboPosts
    .where('authorId').equals('user')

if (userLatestPosts.length > 0) {
    if (weiboContext === '') {
        weiboContext = '\n\n# æœ€è¿‘çš„å¾®åšäº’å‹• (é€™æ˜¯ä½ å’Œç”¨æˆ¶åœ¨å¾®åšä¸Šçš„æœ€æ–°å‹•æ…‹ï¼Œè«‹å„ªå…ˆå›æ‡‰)\n';
    }
    weiboContext += '\n## ç”¨æˆ¶æœ€æ–°ç™¼ä½ˆçš„å¾®åš:\n';
    userLatestPosts.forEach(post => {
        const likes = (post.baseLikesCount || 0) + (post.likes || []).length;
        const comments = (post.baseCommentsCount || 0) + (post.comments || []).length;
        const contentPreview = (post.content || post.hiddenContent || "(åœ–ç‰‡å¾®åš)").substring(0, 30);
        weiboContext += `- (ID: ${post.id}) [${formatPostTimestamp(post.timestamp)}] å…§å®¹: "${contentPreview}..." [ğŸ‘${likes} ğŸ’¬${comments}]\n`;
    });
}

// 2. æŸ¥æ‰¾ç”¨æˆ¶åœ¨ç•¶å‰AIè§’è‰²å¾®åšä¸‹çš„æœ€æ–°è©•è«–
const charLatestPosts = await db.weiboPosts
    .where('authorId').equals(chatId) // åªæŸ¥æ‰¾é€™å€‹AIè§’è‰²çš„å¾®åš
    .reverse()
    .limit(5) // æª¢æŸ¥æœ€è¿‘çš„5æ¢
    .toArray();

let userCommentsOnMyPosts = '';
const myNickname = state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘';

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„æ–°ä»£ç¢¼æ›¿æ›ä¸Šé¢çš„èˆŠä»£ç¢¼ â–¼â–¼â–¼
charLatestPosts.forEach(post => {
    // æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ äº† Array.isArray(post.comments) çš„å®‰å…¨æª¢æŸ¥
    if (post.comments && Array.isArray(post.comments) && post.comments.length > 0) { 
        // ç¯©é¸å‡ºæ˜¯â€œæˆ‘â€ç™¼çš„è©•è«–
        const userComments = Array.isArray(post.comments)
  ? post.comments.filter(c => c.authorNickname === myNickname).slice(-3)
  : [];
        if (userComments.length > 0) {
            const postContentPreview = (post.content || '(åœ–ç‰‡å¾®åš)').substring(0, 20);
            userCommentsOnMyPosts += `- åœ¨ä½ çš„å¾®åš (ID: ${post.id}) "${postContentPreview}..." ä¸‹:\n`;

            userComments.forEach(comment => {
                // 1. æª¢æŸ¥AIæ˜¯å¦å·²ç¶“å›å¾©éé€™æ¢è©•è«–
                //    é‚è¼¯ï¼šåœ¨å¸–å­çš„æ‰€æœ‰è©•è«–ä¸­ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ä¸€æ¢è©•è«–ï¼Œ
                //    å®ƒçš„ä½œè€…æ˜¯AIè‡ªå·±ï¼Œä¸¦ä¸”å®ƒçš„replyToIdæŒ‡å‘ç•¶å‰é€™æ¢ç”¨æˆ¶çš„è©•è«–IDã€‚
                const hasReplied = post.comments.some(reply =>
                    reply.authorNickname === chat.name && // å›å¾©è€…æ˜¯AI
                    reply.replyToId === comment.commentId  // å›å¾©çš„ç›®æ¨™æ˜¯é€™æ¢è©•è«–
                );

                // 2. æ ¹æ“šæª¢æŸ¥çµæœï¼Œç”Ÿæˆç‹€æ…‹æ¨™ç±¤
                const replyStatus = hasReplied ? "[ä½ å·²å›å¾©]" : "[ä½ æœªå›å¾©]";

                // 3. å°‡å¸¶æœ‰ç‹€æ…‹æ¨™ç±¤çš„æç¤ºè³‡è¨Šæ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­
                userCommentsOnMyPosts += `  â”” (è©•è«–ID: ${comment.commentId}) ç”¨æˆ¶: "${comment.commentText}" ${replyStatus}\n`;
            });
        }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



if (userCommentsOnMyPosts) {
    if (weiboContext === '') {
        weiboContext = '\n\n# æœ€è¿‘çš„å¾®åšäº’å‹• (é€™æ˜¯ä½ å’Œç”¨æˆ¶åœ¨å¾®åšä¸Šçš„æœ€æ–°å‹•æ…‹ï¼Œè«‹å„ªå…ˆå›æ‡‰)\n';
    }
    weiboContext += '\n## ç”¨æˆ¶åœ¨ä½ å¾®åšä¸‹çš„æ–°è©•è«–:\n';
    weiboContext += userCommentsOnMyPosts;
}

// 3. å¦‚æœæœ‰ä»»ä½•å¾®åšäº’å‹•ï¼Œå°±æŠŠå®ƒåŠ åˆ°çµ¦AIçš„â€œåƒè€ƒè³‡æ–™â€è£¡
if (weiboContext) {
    messagesPayload.push({ role: 'system', content: weiboContext });
}

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼åˆ°é€™è£¡çµæŸ â–²â–²â–²

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡æ’å…¥éæ¿¾æ­¥é©Ÿ
const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

// â–¼â–¼â–¼ ã€æ™‚é–“æ„ŸçŸ¥ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ if (visiblePosts.length > 0...) ä»£ç¢¼å¡Š â–¼â–¼â–¼
if (visiblePosts.length > 0 && !chat.isGroup) {
    let postsContext = "\n\n# æœ€è¿‘çš„å‹•æ…‹æ¸…å–® (ä¾›ä½ åƒè€ƒå’Œè©•è«–):\n";
    const aiName = chat.name;
    const userNickname = state.qzoneSettings.nickname;

    for (const post of visiblePosts) {
        let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
        let interactionStatus = '';
        if (post.likes && post.likes.includes(aiName)) interactionStatus += " [ä½ å·²é»è´Š]";
        if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ä½ å·²è©•è«–]";
        
        // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘é€™æ¬¡ä¿®å¾©çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
        // åœ¨æ¯ä¸€æ¢å‹•æ…‹å‰é¢ï¼Œéƒ½åŠ ä¸Šäº†ç”± formatPostTimestamp() å‡½æ•¸ç”Ÿæˆçš„æ™‚é–“å·®æç¤º
        const timeAgo = formatPostTimestamp(post.timestamp); // ä¾‹å¦‚ï¼š"3å¤©å‰" æˆ– "å‰›å‰›"
        postsContext += `- (ID: ${post.id}) [${timeAgo}] ä½œè€…: ${authorName}, å…§å®¹: "${(post.publicText || post.content || "åœ–ç‰‡å‹•æ…‹").substring(0, 30)}..."${interactionStatus}`;
        // â˜…â˜…â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…â˜…â˜…

        const { contextString: commentsContext, visibilityFlag } = buildCommentsContextForAI(post, chat, userNickname);
        
        postsContext += ` ${visibilityFlag}\n`;
        postsContext += commentsContext;
    }
// â–¼â–¼â–¼ åœ¨ messagesPayload.push({ role: 'system', content: postsContext }); çš„æ­£ä¸Šæ–¹ï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼ â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ç‚ºAIæº–å‚™å¾®åšäº’å‹•çš„ä¸Šä¸‹æ–‡
let weiboContext = '';

// 1. ç²å–ç”¨æˆ¶æœ€æ–°ç™¼ä½ˆçš„3æ¢å¾®åš
const userLatestPosts = await db.weiboPosts
    .where('authorId').equals('user')
    .reverse() // æŒ‰æ™‚é–“å€’åº
    .limit(3)  // åªå–æœ€è¿‘3æ¢
    .toArray();

if (userLatestPosts.length > 0) {
    if (weiboContext === '') {
        weiboContext = '\n\n# æœ€è¿‘çš„å¾®åšäº’å‹• (é€™æ˜¯ä½ å’Œç”¨æˆ¶åœ¨å¾®åšä¸Šçš„æœ€æ–°å‹•æ…‹ï¼Œè«‹å„ªå…ˆå›æ‡‰)\n';
    }
    weiboContext += '\n## ç”¨æˆ¶æœ€æ–°ç™¼ä½ˆçš„å¾®åš:\n';
// âœ… é€™æ˜¯ä¿®å¾©å¾Œçš„æ–°ä»£ç¢¼
userLatestPosts.forEach(post => {
    const likes = (post.baseLikesCount || 0) + (post.likes || []).length;
    const comments = (post.baseCommentsCount || 0) + (post.comments || []).length;
    const contentPreview = (post.content || post.hiddenContent || "(åœ–ç‰‡å¾®åš)").substring(0, 30);

    // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©é‚è¼¯é–‹å§‹ â˜…â˜…â˜…â˜…â˜…
    // 1. æª¢æŸ¥AIï¼ˆchar.nameï¼‰æ˜¯å¦å·²ç¶“è©•è«–éé€™æ¢ç”¨æˆ¶çš„å¾®åš
    const hasCommented = (post.comments || []).some(comment => comment.authorNickname === chat.name);

    // 2. æ ¹æ“šæª¢æŸ¥çµæœç”Ÿæˆç‹€æ…‹æ¨™ç±¤
    const interactionStatus = hasCommented ? "[ä½ å·²è©•è«–]" : "[ä½ æœªè©•è«–]";
    // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©é‚è¼¯çµæŸ â˜…â˜…â˜…â˜…â˜…

    // 3. å°‡å¸¶æœ‰ç‹€æ…‹æ¨™ç±¤çš„å®Œæ•´è³‡è¨Šæ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­
    weiboContext += `- (ID: ${post.id}) [${formatPostTimestamp(post.timestamp)}] å…§å®¹: "${contentPreview}..." [ğŸ‘${likes} ğŸ’¬${comments}] ${interactionStatus}\n`;
});
}

// 2. æŸ¥æ‰¾ç”¨æˆ¶åœ¨ç•¶å‰AIè§’è‰²å¾®åšä¸‹çš„æœ€æ–°è©•è«–
const charLatestPosts = await db.weiboPosts
    .where('authorId').equals(chatId) // åªæŸ¥æ‰¾é€™å€‹AIè§’è‰²çš„å¾®åš
    .reverse()
    .limit(5) // æª¢æŸ¥æœ€è¿‘çš„5æ¢
    .toArray();

let userCommentsOnMyPosts = '';
const myNickname = state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘';

charLatestPosts.forEach(post => {
    if (post.comments && post.comments.length > 0) {
        // ç¯©é¸å‡ºæ˜¯â€œæˆ‘â€ç™¼çš„è©•è«–
        const userComments = Array.isArray(post.comments)
  ? post.comments.filter(c => c.authorNickname === myNickname).slice(-3)
  : [];// åªçœ‹æœ€æ–°çš„3æ¢
        if (userComments.length > 0) {
            const postContentPreview = (post.content || '(åœ–ç‰‡å¾®åš)').substring(0, 20);
            userCommentsOnMyPosts += `- åœ¨ä½ çš„å¾®åš (ID: ${post.id}) "${postContentPreview}..." ä¸‹:\n`;
            userComments.forEach(comment => {
                userCommentsOnMyPosts += `  â”” (è©•è«–ID: ${comment.commentId}) ç”¨æˆ¶: "${comment.commentText}"\n`;
            });
        }
    }
});

if (userCommentsOnMyPosts) {
    if (weiboContext === '') {
        weiboContext = '\n\n# æœ€è¿‘çš„å¾®åšäº’å‹• (é€™æ˜¯ä½ å’Œç”¨æˆ¶åœ¨å¾®åšä¸Šçš„æœ€æ–°å‹•æ…‹ï¼Œè«‹å„ªå…ˆå›æ‡‰)\n';
    }
    weiboContext += '\n## ç”¨æˆ¶åœ¨ä½ å¾®åšä¸‹çš„æ–°è©•è«–:\n';
    weiboContext += userCommentsOnMyPosts;
}

// 3. å¦‚æœæœ‰ä»»ä½•å¾®åšäº’å‹•ï¼Œå°±æŠŠå®ƒåŠ åˆ°çµ¦AIçš„â€œåƒè€ƒè³‡æ–™â€è£¡
if (weiboContext) {
    messagesPayload.push({ role: 'system', content: weiboContext });
}

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼åˆ°é€™è£¡çµæŸ â–²â–²â–²
    messagesPayload.push({ role: 'system', content: postsContext });
}

            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesPayload],
                    temperature: 0.8,
                    stream: false
                })
            });
            if (!response.ok) {
                let errorMsg = `API Error: ${response.status}`;
                try {
                    // å˜—è©¦è§£æéŒ¯èª¤è³‡è¨Šé«”ç‚ºJSON
                    const errorData = await response.json();
                    // å®‰å…¨åœ°ç²å–éŒ¯èª¤è³‡è¨Šï¼Œå¦‚æœçµæ§‹ä¸ç¬¦åˆé æœŸï¼Œå°±å°‡æ•´å€‹éŒ¯èª¤ç‰©ä»¶è½‰ç‚ºå­—ä¸²
                    errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
                } catch (jsonError) {
                    // å¦‚æœé€£JSONéƒ½ä¸æ˜¯ï¼Œå°±ç›´æ¥è®€å–æ–‡æœ¬
                    errorMsg += ` - ${await response.text()}`;
                }
                // æ‹‹å‡ºä¸€å€‹åŒ…å«äº†è©³ç´°è³‡è¨Šçš„éŒ¯èª¤ï¼Œé€™æ¨£å°±ä¸æœƒåœ¨catchå¡Šè£¡å†æ¬¡å‡ºéŒ¯äº†
                throw new Error(errorMsg);
            }
            if (!response.ok) {
                let errorMsg = `API Error: ${response.status}`;
                try {
                    // å˜—è©¦è§£æéŒ¯èª¤è³‡è¨Šé«”ç‚ºJSON
                    const errorData = await response.json();
                    // å®‰å…¨åœ°ç²å–éŒ¯èª¤è³‡è¨Šï¼Œå¦‚æœçµæ§‹ä¸ç¬¦åˆé æœŸï¼Œå°±å°‡æ•´å€‹éŒ¯èª¤ç‰©ä»¶è½‰ç‚ºå­—ä¸²
                    errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
                } catch (jsonError) {
                    // å¦‚æœé€£JSONéƒ½ä¸æ˜¯ï¼Œå°±ç›´æ¥è®€å–æ–‡æœ¬
                    errorMsg += ` - ${await response.text()}`;
                }
                // æ‹‹å‡ºä¸€å€‹åŒ…å«äº†è©³ç´°è³‡è¨Šçš„éŒ¯èª¤ï¼Œé€™æ¨£å°±ä¸æœƒåœ¨catchå¡Šè£¡å†æ¬¡å‡ºéŒ¯äº†
                throw new Error(errorMsg);
            }
            const data = await response.json();

            // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡æ·»åŠ å° data çµæ§‹çš„å®‰å…¨æª¢æŸ¥
            const aiResponseContent = isGemini
                ? data?.candidates?.[0]?.content?.parts?.[0]?.text
                : data?.choices?.[0]?.message?.content;
            
            // ã€é‡è¦ã€‘æª¢æŸ¥ä¿®å¾©å¾Œçš„çµæœæ˜¯å¦çœŸçš„æ‹¿åˆ°äº†å…§å®¹
            if (!aiResponseContent) {
                console.warn(`APIè¿”å›äº†ç©ºå…§å®¹æˆ–æ ¼å¼ä¸æ­£ç¢ºï¼ˆå¯èƒ½å› å®‰å…¨è¨­ç½®è¢«æ””æˆªï¼‰ã€‚è¿”å›è³‡æ–™:`, data);
                throw new Error("APIè¿”å›äº†ç©ºå…§å®¹æˆ–æ ¼å¼ä¸æ­£ç¢ºï¼ˆå¯èƒ½å› å®‰å…¨è¨­ç½®è¢«æ””æˆªï¼‰ã€‚");
            }

            console.log(`AI '${chat.name}' çš„åŸå§‹å›å¾©:`, aiResponseContent);
// ... çœç•¥äº†å‡½æ•¸å¾Œé¢çš„ä»£ç¢¼ ...
            chat.history = chat.history.filter(msg => !msg.isTemporary);

            // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©ã€‘æ™ºæ…§è§£æAIå›å¾©ï¼Œç¢ºä¿å¿ƒè²è³‡æ–™ä¸ä¸Ÿå¤± â–¼â–¼â–¼
            let messagesArray = [];
            let innerVoiceData = null;

            try {
                // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨è§£æå‰ï¼Œå…ˆå°AIçš„åŸå§‹å›å¾©é€²è¡Œâ€œæ·¨åŒ–â€è™•ç†
                let sanitizedContent = aiResponseContent
                    .replace(/^```json\s*/, '') // ç§»é™¤é–‹é ­çš„ ```json
                    .replace(/```$/, '')       // ç§»é™¤çµå°¾çš„ ```
                    .trim();                   // ç§»é™¤é¦–å°¾çš„ç©ºæ ¼å’Œæ›è¡Œ

                // å†æ¬¡æ·¨åŒ–ï¼Œå¼·è¡Œæå–ç¬¬ä¸€å€‹ { å’Œæœ€å¾Œä¸€å€‹ } ä¹‹é–“çš„å…§å®¹
                const firstBrace = sanitizedContent.indexOf('{');
                const lastBrace = sanitizedContent.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace > firstBrace) {
                    sanitizedContent = sanitizedContent.substring(firstBrace, lastBrace + 1);
                }

                const fullResponse = JSON.parse(sanitizedContent);
                
                // ç¾åœ¨æˆ‘å€‘å¯ä»¥å®‰å…¨åœ°è§£ææ·¨åŒ–å¾Œçš„å…§å®¹äº†
                if (fullResponse.chatResponse && Array.isArray(fullResponse.chatResponse)) {
                    messagesArray = fullResponse.chatResponse;
                }
                if (fullResponse.innerVoice && typeof fullResponse.innerVoice === 'object') {
                    innerVoiceData = fullResponse.innerVoice;
                }
                
                // ç›¸å®¹èˆŠæ ¼å¼ï¼Œå¦‚æœAIåªè¿”å›äº†innerVoiceè£¡çš„æ¬„ä½
                if (!innerVoiceData && fullResponse.thoughts && fullResponse.behavior) {
                    innerVoiceData = fullResponse;
                }
                
                // å¦‚æœä¸Šé¢å…©ç¨®æƒ…æ³éƒ½æ²’åŒ¹é…åˆ°ï¼Œä½†åˆä¸æ˜¯æ¨™æº–é™£åˆ—ï¼Œå°±å˜—è©¦ç”¨è€æ–¹æ³•è§£æ
                if (messagesArray.length === 0 && !innerVoiceData) {
                     messagesArray = parseAiResponse(aiResponseContent);
                }

            } catch (e) {
                console.warn("AIå›å¾©ä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œé€€å›åˆ°æ¨™æº–è§£ææ¨¡å¼ã€‚", e);
                messagesArray = parseAiResponse(aiResponseContent);
            }

            // æœ€çµ‚è™•ç†å¿ƒè²è³‡æ–™
            if (innerVoiceData) {
                console.log("è§£ææˆåŠŸï¼šå·²æˆåŠŸæ•ç²åˆ°å¿ƒè²(innerVoice)è³‡æ–™ã€‚", innerVoiceData);
                const newInnerVoice = innerVoiceData;
                newInnerVoice.timestamp = Date.now();
                chat.latestInnerVoice = newInnerVoice;
                if (!chat.innerVoiceHistory) {
                    chat.innerVoiceHistory = [];
                }
                // ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å­˜åœ¨ï¼Œé˜²æ­¢å‡ºéŒ¯
                chat.latestInnerVoice.clothing = chat.latestInnerVoice.clothing || '...';
                chat.latestInnerVoice.behavior = chat.latestInnerVoice.behavior || '...';
                chat.latestInnerVoice.thoughts = chat.latestInnerVoice.thoughts || '...';
                chat.latestInnerVoice.naughtyThoughts = chat.latestInnerVoice.naughtyThoughts || '...';

                chat.innerVoiceHistory.push(newInnerVoice);
            } else {
                 console.warn("æœ¬æ¬¡AIå›å¾©ä¸­æœªæª¢æ¸¬åˆ°æœ‰æ•ˆçš„å¿ƒè²(innerVoice)è³‡æ–™ã€‚");
            }
            // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        
        let callHasBeenHandled = false;

        let messageTimestamp = Date.now();

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾© ç¬¬1æ­¥: åˆå§‹åŒ–ä¸€å€‹æ–°é™£åˆ—ï¼Œç”¨æ–¼æ”¶é›†éœ€è¦æ¸²æŸ“çš„æ¶ˆæ¯ â˜…â˜…â˜…
        let newMessagesToRender = []; 

       let notificationShown = false;

        for (const msgData of messagesArray) {
            if (!msgData || typeof msgData !== 'object') {
                console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è¦ç¯„çš„AIæŒ‡ä»¤ï¼Œå·²è·³é:", msgData);
                continue;
            }
             
            if (!msgData.type) {
                if (chat.isGroup && msgData.name && msgData.message) {
                    msgData.type = 'text';
                }         else if (msgData.content) {
        msgData.type = 'text';
    }
    // å¦‚æœé€£ content éƒ½æ²’æœ‰ï¼Œæ‰æ˜¯çœŸçš„æ ¼å¼ä¸è¦ç¯„
    else {
        console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è¦ç¯„çš„AIæŒ‡ä»¤ï¼ˆç¼ºå°‘typeå’Œcontentï¼‰ï¼Œå·²è·³é:", msgData);
        continue;
    }
}

            if (msgData.type === 'video_call_response') {
                videoCallState.isAwaitingResponse = false;
                if (msgData.decision === 'accept') {
                    startVideoCall();
                } else {
                    const aiMessage = { role: 'assistant', content: 'å°æ–¹æ‹’çµ•äº†ä½ çš„è¦–é »é€šè©±è«‹æ±‚ã€‚', timestamp: Date.now() };
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);
                    showScreen('chat-interface-screen');
                    renderChatInterface(chatId);
                }
                callHasBeenHandled = true;
                break;
            }
            
            if (msgData.type === 'group_call_response') {
                if (msgData.decision === 'join') {
        const member = chat.members.find(m => m.originalName === msgData.name);
        if (member && !videoCallState.participants.some(p => p.id === member.id)) {
            videoCallState.participants.push(member);
        }
    }
    callHasBeenHandled = true;
    continue;
            }

            if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                console.error(`AIå¹»è¦ºå·²è¢«æ””æˆªï¼è©¦åœ–ä½¿ç”¨ç¾¤å ("${chat.name}") ä½œç‚ºè§’è‰²åã€‚æ¶ˆæ¯å…§å®¹:`, msgData);
                continue;
            }

// â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„ä»£ç¢¼ â–¼â–¼â–¼

// ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨ç¾¤èŠä¸­ï¼Œå¦‚æœAIè¿”å›çš„æ¶ˆæ¯æ²’æœ‰æŒ‡å®šç™¼é€è€…ï¼Œå‰‡ç›´æ¥è·³éé€™æ¢æ¶ˆæ¯
if (chat.isGroup && !msgData.name) {
    console.error(`AIå¹»è¦ºå·²è¢«æ””æˆªï¼è©¦åœ–åœ¨ç¾¤èŠä¸­ç™¼é€ä¸€æ¢æ²’æœ‰â€œnameâ€çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å…§å®¹:`, msgData);
    continue; // continueæœƒç«‹å³çµæŸæœ¬æ¬¡è¿´åœˆï¼Œè™•ç†ä¸‹ä¸€æ¢æ¶ˆæ¯
}

// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

            let aiMessage = null;
            const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: messageTimestamp++ };

// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘å®šä½æŒ‡ä»¤åµæ¸¬èˆ‡è§£æå™¨
// æˆ‘å€‘åœ¨è™•ç†æ‰€æœ‰æ¶ˆæ¯é¡å‹ä¹‹å‰ï¼Œå„ªå…ˆæª¢æŸ¥å®ƒæ˜¯å¦æ˜¯æˆ‘å€‘çš„æ–°å®šä½æŒ‡ä»¤
const messageText = msgData.content || msgData.message || ''; // ã€æ ¸å¿ƒä¿®å¾©ã€‘å…ˆå®‰å…¨åœ°ç²å–æ–‡æœ¬å…§å®¹
if (msgData.type === 'text' && messageText.startsWith('[SEND_LOCATION]')) {
    console.log("åµæ¸¬åˆ°æ–°çš„å®šä½æŒ‡ä»¤ï¼Œé–‹å§‹è§£æ:", messageText); // ã€æ ¸å¿ƒä¿®å¾©ã€‘ä½¿ç”¨æ–°çš„è®Šæ•¸

    // 1. ç§»é™¤æŒ‡ä»¤é ­ï¼Œç²å–å¾Œé¢çš„ç´”è³‡æ–™æ–‡æœ¬
    const dataString = messageText.replace('[SEND_LOCATION]', '').trim(); // ã€æ ¸å¿ƒä¿®å¾©ã€‘ä½¿ç”¨æ–°çš„è®Šæ•¸
    
    // 2. ä½¿ç”¨'|'åˆ†å‰²æˆå„å€‹éƒ¨åˆ†
    const parts = dataString.split('|');
    const locationData = {};

    // 3. éæ­·æ¯å€‹éƒ¨åˆ†ï¼Œæå–éµå’Œå€¼
    parts.forEach(part => {
        const [key, ...valueParts] = part.split(':');
        const value = valueParts.join(':').trim();
        if (key && value) {
            const trimmedKey = key.trim();
            if (trimmedKey === 'æˆ‘çš„ä½ç½®') locationData.aiLocation = value;
            else if (trimmedKey === 'ä½ çš„ä½ç½®') locationData.userLocation = value;
            else if (trimmedKey === 'ç›¸è·') locationData.distance = value;
            else if (trimmedKey === 'é€”ç¶“é»') {
                // å°‡é€—è™Ÿåˆ†éš”çš„å­—ä¸²è½‰æ›ç‚ºæˆ‘å€‘éœ€è¦çš„ç‰©ä»¶é™£åˆ—
                locationData.trajectoryPoints = value.split(/[,ï¼Œ]/) // æ”¯æŒä¸­è‹±æ–‡é€—è™Ÿ
                                                     .map(name => ({ name: name.trim() }))
                                                     .filter(p => p.name);
            }
        }
    });

    // 4. æª¢æŸ¥æ˜¯å¦æˆåŠŸæå–äº†æœ€é—œéµçš„è³‡è¨Š
    if (locationData.distance) {
        // 5. ã€æ ¸å¿ƒã€‘æ‰‹å‹•æ§‹å»ºä¸€å€‹å®Œç¾æ ¼å¼çš„ location æ¶ˆæ¯ç‰©ä»¶
        aiMessage = {
            ...baseMessage, // è¤‡ç”¨å·²æœ‰çš„ç™¼é€è€…ã€æ™‚é–“æˆ³è¨˜ç­‰è³‡è¨Š
            type: 'location',
            userLocation: locationData.userLocation || '',
            aiLocation: locationData.aiLocation || '',
            distance: locationData.distance,
            trajectoryPoints: locationData.trajectoryPoints || []
        };
        
        // 6. å°‡é€™å€‹å®Œç¾çš„ç‰©ä»¶æ¨å…¥å¾…è™•ç†æ¸…å–®ï¼Œä¸¦è·³éå¾ŒçºŒçš„ switch-case
        // (å› ç‚ºæˆ‘å€‘å·²ç¶“è™•ç†å®Œé€™æ¢æ¶ˆæ¯äº†)
        chat.history.push(aiMessage);
        if (isViewingThisChat) {
             appendMessage(aiMessage, chat);
        }
        console.log("å®šä½æŒ‡ä»¤è§£ææˆåŠŸä¸¦å·²å‰µå»ºæ¶ˆæ¯ç‰©ä»¶:", aiMessage);
        
        // ä½¿ç”¨ continue è·³éæœ¬æ¬¡è¿´åœˆçš„å‰©é¤˜éƒ¨åˆ†ï¼Œç›´æ¥è™•ç†ä¸‹ä¸€æ¢AIå›å¾©
        continue; 
    }
}
// â–²â–²â–² é»è²¼åˆ°é€™è£¡çµæŸ â–²â–²â–²
            switch (msgData.type) {
                          // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼å¡Š â–¼â–¼â–¼
                case 'sticker': {
                    // é€™æ˜¯ç‚ºç¾¤èŠè¨­è¨ˆçš„è¡¨æƒ…åŒ…é‚è¼¯
                    const stickerName = msgData.sticker_name;
                    if (!stickerName) {
                        console.warn('AIåœ¨ç¾¤èŠä¸­è¿”å›äº†stickeré¡å‹ä½†æ²’æœ‰sticker_nameï¼Œå·²æ””æˆª:', msgData);
                        continue; // è·³éé€™æ¢ç„¡æ•ˆæŒ‡ä»¤
                    }
                    
                    // åœ¨æ‰€æœ‰å¯ç”¨è¡¨æƒ…åº«ä¸­æŸ¥æ‰¾
                    const allStickers = [...state.userStickers, ...state.charStickers, ...(chat.settings.stickerLibrary || [])];
                    const foundSticker = allStickers.find(s => s.name === stickerName);

                    if (foundSticker) {
                        // æ‰¾åˆ°äº†ï¼Œå°±å‰µå»ºæ¶ˆæ¯ç‰©ä»¶
                        aiMessage = { 
                            ...baseMessage, 
                            type: 'sticker', 
                            content: foundSticker.url, 
                            meaning: foundSticker.name 
                        };
                    } else {
                        // æ²’æ‰¾åˆ°ï¼Œèªªæ˜AIå¹»è¦ºäº†ï¼Œè¨˜éŒ„è­¦å‘Šä¸¦è·³é
                        console.warn(`AIåœ¨ç¾¤èŠä¸­æœæ’°äº†ä¸å­˜åœ¨çš„è¡¨æƒ…: "${stickerName}"ï¼Œå·²è‡ªå‹•æ””æˆªã€‚`);
                    }
                    break;
                }
                // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
                case 'waimai_response':
                    const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (requestMessageIndex > -1) {
                        const originalMsg = chat.history[requestMessageIndex];
                        originalMsg.status = msgData.status;
                        originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
                    }
                    continue;
// â–¼â–¼â–¼ åœ¨ switch (msgData.type) çµæ§‹å…§é»è²¼ â–¼â–¼â–¼
// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch (msgData.type) çµæ§‹å…§ï¼Œç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ case 'weibo_post' â–¼â–¼â–¼
// â–¼â–¼â–¼ è«‹ç”¨é€™ä¸€æ•´å¡Šã€å·²ä¿®å¾©è©•è«–å€ä¸é¡¯ç¤ºå•é¡Œã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ case 'weibo_post' ä»£ç¢¼å¡Š â–¼â–¼â–¼

case 'weibo_post': {
    const newPost = {
        authorId: chatId,
        authorType: 'char',
        authorNickname: chat.name,
        authorAvatar: chat.settings.aiAvatar || defaultAvatar,
        content: msgData.content || '',
        postType: msgData.postType || 'text_only',
        hiddenContent: msgData.hiddenContent || '',
        imageUrl: msgData.imageUrl || '',
        imageDescription: msgData.imageDescription || '',
        timestamp: Date.now(),
        likes: [],
        comments: [], // å…ˆåˆå§‹åŒ–ç‚ºç©ºé™£åˆ—
        baseLikesCount: msgData.baseLikesCount || 0,
        baseCommentsCount: msgData.baseCommentsCount || 0
    };

    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©é‚è¼¯é–‹å§‹ â–¼â–¼â–¼ ---

    let commentsToProcess = [];

    // 1. å„ªå…ˆè™•ç†æ–°çš„ã€æ­£ç¢ºçš„ã€é™£åˆ—æ ¼å¼ã€‘
    if (msgData.comments && Array.isArray(msgData.comments)) {
        // ç›´æ¥ä½¿ç”¨AIè¿”å›çš„é™£åˆ—
        commentsToProcess = msgData.comments;
    }
    // 2. ç›¸å®¹èˆŠçš„ã€å­—ä¸²æ ¼å¼ã€‘
    else if (msgData.comments && typeof msgData.comments === 'string') {
        // å¦‚æœæ˜¯å­—ä¸²ï¼Œå°±æŒ‰è€æ–¹æ³•è§£æ
        commentsToProcess = msgData.comments.split('\n').map(c => {
            const parts = c.split(/[:ï¼š]/);
            const commenter = parts.shift() || 'è·¯äºº';
            const commentText = parts.join(':').trim();
            return { authorNickname: commenter, commentText: commentText };
        }).filter(c => c.commentText);
    }
    
    // 3. ã€é—œéµæ­¥é©Ÿã€‘ç‚ºæ‰€æœ‰è§£æå¥½çš„è©•è«–ï¼Œçµ±ä¸€æ·»åŠ å‰ç«¯éœ€è¦çš„ commentId
    if (commentsToProcess.length > 0) {
        newPost.comments = commentsToProcess.map(c => ({
            commentId: 'comment_' + Date.now() + Math.random(), // ç¢ºä¿æ¯æ¢è©•è«–éƒ½æœ‰å”¯ä¸€ID
            authorNickname: c.authorNickname,
            commentText: c.commentText
            // é€™è£¡æˆ‘å€‘ä¸å†éœ€è¦ authorId å’Œ timestampï¼Œå› ç‚ºå®ƒå€‘ä¸æ˜¯æ¸²æŸ“æ‰€å¿…éœ€çš„
        }));
    }
    
    // --- â–²â–²â–² æ ¸å¿ƒä¿®å¾©é‚è¼¯çµæŸ â–²â–²â–² ---

    await db.weiboPosts.add(newPost);
    
    showNotification(chatId, `${chat.name} ç™¼äº†ä¸€æ¢æ–°å¾®åš`);

    if (document.getElementById('weibo-screen').classList.contains('active')) {
        await renderFollowingWeiboFeed();
    }
    
    continue; // é€™æ˜¯å¾Œè‡ºæ“ä½œï¼Œç”¨ continue è·³é
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
case 'weibo_comment': {
                    // é€™æ˜¯ä¸€å€‹AIè©•è«–å¾®åšçš„æŒ‡ä»¤
                    const postIdToComment = msgData.postId;
                    const commentText = msgData.commentText;

                    // 1. æ ¹æ“š postId å¾è³‡æ–™åº«è£¡æ‰¾åˆ°é‚£æ¢å¾®åš
                    const postToComment = await db.weiboPosts.get(postIdToComment);
                    
                    if (postToComment) {
                        // 2. å¦‚æœæ‰¾åˆ°äº†å¾®åšï¼Œå°±æº–å‚™ä¸€æ¢æ–°è©•è«–
                        if (!postToComment.comments) postToComment.comments = []; // ç¢ºä¿è©•è«–å€å­˜åœ¨
                        const newComment = {
                            commentId: 'comment_' + Date.now(), // çµ¦è©•è«–ä¸€å€‹ç¨ä¸€ç„¡äºŒçš„ID
                            authorId: chatId,                  // è©•è«–è€…æ˜¯ç•¶å‰AI
                            authorNickname: chat.name,         // è©•è«–è€…çš„åå­—
                            commentText: commentText,          // è©•è«–å…§å®¹
                            timestamp: Date.now()              // è©•è«–æ™‚é–“
                        };
                        
                        // 3. æŠŠæ–°è©•è«–åŠ åˆ°å¾®åšçš„è©•è«–åˆ—è¡¨è£¡
                        postToComment.comments.push(newComment);
                        
                        // 4. æŠŠæ›´æ–°å¾Œçš„å¾®åšå­˜å›è³‡æ–™åº«
                        await db.weiboPosts.put(postToComment);
                        
                        // 5. åˆ·æ–°â€œæˆ‘çš„å¾®åšâ€å’Œâ€œé—œæ³¨çš„äººâ€å…©å€‹æ¸…å–®ï¼Œè®“æ–°è©•è«–é¡¯ç¤ºå‡ºä¾†
                        await renderMyWeiboFeed();
                        await renderFollowingWeiboFeed();
                    }
                    continue; // è™•ç†å®Œå¾Œï¼Œç¹¼çºŒè™•ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
                }
                case 'weibo_reply': {
                    // é€™æ˜¯ä¸€å€‹AIå›å¾©å¾®åšè©•è«–çš„æŒ‡ä»¤
                    const postIdToReply = msgData.postId;
                    const commentIdToReply = msgData.commentId;
                    const replyText = msgData.replyText;

                    const postToReply = await db.weiboPosts.get(postIdToReply);
                    
                    if (postToReply && postToReply.comments) {
                        // 1. åœ¨å¾®åšçš„è©•è«–å€è£¡ï¼Œæ‰¾åˆ°è¢«å›å¾©çš„é‚£æ¢è©•è«–
                        const targetComment = postToReply.comments.find(c => c.commentId === commentIdToReply);
                        
                        if (targetComment) {
                             // 2. æº–å‚™ä¸€æ¢æ–°çš„â€œå›å¾©â€
                             const newReply = {
                                commentId: 'comment_' + Date.now(),
                                authorId: chatId,
                                authorNickname: chat.name,
                                commentText: replyText,
                                timestamp: Date.now(),
                                replyToId: commentIdToReply, // æ¨™è¨˜é€™æ˜¯å°å“ªæ¢è©•è«–çš„å›å¾©
                                replyToNickname: targetComment.authorNickname // è¨˜ä¸‹è¢«å›å¾©äººçš„åå­—
                            };
                            postToReply.comments.push(newReply);
                            await db.weiboPosts.put(postToReply);
                            
                            // 3. åŒæ¨£ï¼Œåˆ·æ–°æ‰€æœ‰åˆ—è¡¨
                            await renderMyWeiboFeed();
                            await renderFollowingWeiboFeed();
                        }
                    }
                    continue; // ç¹¼çºŒè™•ç†
                }
case 'lovers_space_response': {
    const invitationMsg = chat.history.find(m => m.type === 'lovers_space_invitation' && m.status === 'pending');
    if (invitationMsg) {
        invitationMsg.status = msgData.decision === 'accept' ? 'accepted' : 'rejected';

        // 1. å‰µå»ºAIæƒ³èªªçš„é‚£å¥è©±çš„æ¶ˆæ¯
        if (msgData.responseText) {
            const responseMessage = {
                ...baseMessage, // è¤‡ç”¨æ™‚é–“æˆ³è¨˜å’Œç™¼é€è€…è³‡è¨Š
                type: 'text',
                content: msgData.responseText
            };
            chat.history.push(responseMessage);
            if (isViewingThisChat) {
                appendMessage(responseMessage, chat);
            }
        }

        // 2. æ ¹æ“šåŒæ„æˆ–æ‹’çµ•ï¼ŒåŸ·è¡Œå¾ŒçºŒæ“ä½œ
        if (msgData.decision === 'accept') {
            chat.loversSpaceData = {
                background: 'https://i.postimg.cc/k495F4W5/profile-banner.jpg',
                relationshipStartDate: null, moments: [], photos: [], albums: [], loveLetters: [], shares: [], questions: [],
            };
            const systemNotice = {
                role: 'system', type: 'pat_message',
                content: `[ç³»çµ±ï¼šä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾¶ç©ºé–“å·²æˆåŠŸé–‹å•Ÿï¼]`,
                timestamp: Date.now()
            };
            chat.history.push(systemNotice);
            if (isViewingThisChat) {
                appendMessage(systemNotice, chat);
            }
        }
    }
    // è™•ç†å®Œå¾Œï¼Œä¸å†éœ€è¦é‡æ–°è§¸ç™¼AIï¼Œæ‰€ä»¥æˆ‘å€‘ç”¨ continue
    continue;
}
// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch èªå¥ä¸­ï¼Œç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ case 'interact_with_pet' â–¼â–¼â–¼
case 'interact_with_pet': {
    const pet = chat.settings.pet;
    if (pet && pet.type !== 'ç„¡') {
        let actionText = '';
        // æ ¹æ“šAIçš„äº’å‹•ï¼Œä¿®æ”¹æ•¸å€¼
        switch(msgData.action) {
            case 'feed':
                pet.status.hunger = Math.min(100, (pet.status.hunger || 0) + 20);
                pet.status.happiness = Math.min(100, (pet.status.happiness || 0) + 5);
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šAIé¤µé£Ÿï¼Œå¢åŠ å°AIçš„è¦ªå¯†åº¦ â˜…â˜…â˜…
                pet.status.intimacyToChar = Math.min(100, (pet.status.intimacyToChar || 0) + 10);
                actionText = `${chat.name} å–‚äº† ${pet.name} ä¸€äº›é£Ÿç‰©ã€‚`;
                break;
            case 'play':
                pet.status.hunger = Math.max(0, (pet.status.hunger || 0) - 10);
                pet.status.happiness = Math.min(100, (pet.status.happiness || 0) + 15);
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šAIç©è€ï¼Œå¢åŠ å°AIçš„è¦ªå¯†åº¦ â˜…â˜…â˜…
                pet.status.intimacyToChar = Math.min(100, (pet.status.intimacyToChar || 0) + 15);
                actionText = `${chat.name} é™ª ${pet.name} ç©äº†ä¸€æœƒå…’ã€‚`;
                break;
            case 'touch':
                pet.status.happiness = Math.min(100, (pet.status.happiness || 0) + 10);
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šAIæ’«æ‘¸ï¼Œå¢åŠ å°AIçš„è¦ªå¯†åº¦ â˜…â˜…â˜…
                pet.status.intimacyToChar = Math.min(100, (pet.status.intimacyToChar || 0) + 5);
                actionText = `${chat.name} è¼•è¼•åœ°æ’«æ‘¸äº† ${pet.name}ã€‚`;
                break;
        }

        // å‰µå»ºä¸€æ¢å°ä½¿ç”¨è€…å¯è¦‹çš„ç³»çµ±æ¶ˆæ¯
        const visibleMessage = {
            role: 'system',
            type: 'pat_message',
            content: `[ç³»çµ±ï¼š${actionText}]`,
            timestamp: Date.now()
        };
        chat.history.push(visibleMessage);
        if (isViewingThisChat) {
            appendMessage(visibleMessage, chat);
        }
        
        // å¦‚æœ AI åœ¨äº’å‹•å¾Œé‚„æƒ³èªªé»ä»€éº¼
        if (msgData.response) {
            aiMessage = { ...baseMessage, content: msgData.response };
        }
    }
    // å¦‚æœAIåªæ˜¯äº’å‹•æ²’èªªè©±ï¼Œå°±ä¸å‰µå»ºaiMessageï¼Œç›´æ¥è·³åˆ°ä¸‹ä¸€å€‹æŒ‡ä»¤
    if (!aiMessage) {
        continue;
    }
    break;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ 'talk_to_pet' case â–¼â–¼â–¼
case 'talk_to_pet': {
    if (!chat.isGroup && chat.settings.pet && chat.settings.pet.type !== 'ç„¡') {
        const pet = chat.settings.pet;
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©1ï¼šåŒæ™‚ç›¸å®¹ content å’Œ message æ¬„ä½ â˜…â˜…â˜…
        const charMessageContent = msgData.content || msgData.message;
        if (!charMessageContent) continue; // å¦‚æœæ²’å…§å®¹ï¼Œå°±è·³é

        // å°‡Charçš„è©±æ·»åŠ åˆ°å¯µç‰©èŠå¤©è¨˜éŒ„
        const charMessageToPet = { 
            sender: 'char', 
            senderName: chat.name, 
            content: charMessageContent 
        };
        pet.petChatHistory.push(charMessageToPet);
        
        // ç²å–å¯µç‰©çš„å›æ‡‰
        const petResponseToChar = await getPetApiResponse(pet);
        if (petResponseToChar) {
            pet.petChatHistory.push({ sender: 'pet', content: petResponseToChar });
        }

        // å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„ç³»çµ±æ—¥èªŒ
        const visibleLog = `[ç³»çµ±ï¼šâ€œ${chat.name}â€å°å¯µç‰©â€œ${pet.name}â€èªªï¼šâ€œ${charMessageContent}â€ï¼Œå®ƒå›æ‡‰ï¼šâ€œ${petResponseToChar || '(æ²’æœ‰å›æ‡‰)'}â€ã€‚]`;
        const visibleMessage = {
            role: 'system',
            type: 'pat_message',
            content: visibleLog,
            timestamp: messageTimestamp++
        };
        chat.history.push(visibleMessage);
        
        if (isViewingThisChat) {
            appendMessage(visibleMessage, chat);
        }
    }
    continue;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
case 'cart_payment_response': {
    const decision = msgData.decision;
    const responseText = msgData.response_text;

    // æ‰¾åˆ°ç”¨æˆ¶ç™¼å‡ºçš„ã€é‚„è™•æ–¼â€œç­‰å¾…ä¸­â€çš„é‚£å€‹ä»£ä»˜è«‹æ±‚
    const requestMsg = chat.history.find(m => m.type === 'cart_share_request' && m.payload.status === 'pending');
    if (!requestMsg) continue; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œèªªæ˜è«‹æ±‚å¯èƒ½å·²è¢«è™•ç†ï¼Œè·³é

    if (decision === 'accept') {
        const totalPrice = requestMsg.payload.totalPrice;
        const charBalance = chat.characterPhoneData?.bank?.balance || 0;

        // å†æ¬¡ç¢ºèªAIçš„é¤˜é¡æ˜¯å¦è¶³å¤ 
        if (charBalance < totalPrice) {
            // å¦‚æœAIæƒ³ä»˜ä½†éŒ¢ä¸å¤ ï¼Œå°±è®“å®ƒèªªä¸€å¥ä¿çš®è©±
            aiMessage = { ...baseMessage, content: responseText || "å—šå—šï¼Œæƒ³çµ¦ä½ è²·ï¼Œä½†æ˜¯æˆ‘çš„éŒ¢åŒ…ç©ºç©ºäº†..." };
        } else {
            // éŒ¢å¤ ï¼ŒåŸ·è¡Œä»£ä»˜æµç¨‹ï¼
            requestMsg.payload.status = 'paid';
            
            // ä½¿ç”¨ await ç¢ºä¿é€™äº›è³‡æ–™åº«æ“ä½œæŒ‰é †åºå®Œæˆ
            await updateCharacterPhoneBankBalance(chat.id, -totalPrice, `ç‚ºâ€œæˆ‘â€çš„æ¡ƒå¯¶è³¼ç‰©è»Šè²·å–®`);
            const cartItems = await db.taobaoCart.toArray();
            await createOrdersFromCart(cartItems);
            await clearTaobaoCart();
            
            // å‰µå»ºAIçš„å›å¾©æ¶ˆæ¯
            aiMessage = { ...baseMessage, content: responseText || "è²·å¥½å•¦ï¼Œå¿«å»è¨‚å–®è£¡çœ‹çœ‹å§ï¼" };
        }
    } else { // å¦‚æœAIæ±ºå®šæ‹’çµ•
        requestMsg.payload.status = 'rejected';
        aiMessage = { ...baseMessage, content: responseText || "é€™æ¬¡å°±ç®—äº†å§ï¼Œä¸‹æ¬¡ä¸€å®šï¼" };
    }

    // å°‡AIçš„å›å¾©æ¶ˆæ¯æ¨å…¥æ­·å²è¨˜éŒ„ï¼Œä¸¦æ›´æ–°UI
    if (aiMessage) {
        chat.history.push(aiMessage);
    }

    // é‡æ–°æ¸²æŸ“èŠå¤©ä»‹é¢ï¼Œä»¥æ›´æ–°ä»£ä»˜å¡ç‰‡çš„ç‹€æ…‹
    if (isViewingThisChat) {
        renderChatInterface(chatId);
    }
    // è·³éå¾ŒçºŒçš„é è¨­æ¶ˆæ¯è™•ç†
    continue;
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ case ä»£ç¢¼ï¼Œé»è²¼åˆ° switch èªå¥å¡Šçš„ã€å…§éƒ¨ã€‘ â–¼â–¼â–¼
// ä¾‹å¦‚ï¼Œå¯ä»¥æ”¾åœ¨ case 'transfer': çš„å¾Œé¢

case 'buy_gift_for_user': {
    // 1. å¾å•†å“è³‡æ–™åº«ä¸­ç²å–æ‰€æœ‰å·²æ·»åŠ çš„å•†å“
    const allProducts = await db.taobaoProducts.toArray();
    
    // å¦‚æœæ¡ƒå¯¶è£¡ä¸€ä»¶å•†å“éƒ½æ²’æœ‰ï¼ŒAIå°±ç™¼æ¢æ¶ˆæ¯åæ§½ä¸€ä¸‹
    if (allProducts.length === 0) {
        aiMessage = { ...baseMessage, content: msgData.greeting ? `${msgData.greeting} ...å•Šï¼Œæƒ³çµ¦ä½ è²·é»ä»€éº¼ï¼Œä½†æ˜¯æ¡ƒå¯¶è£¡ç©ºç©ºå¦‚ä¹Ÿå‘¢...` : "æƒ³çµ¦ä½ è²·å€‹ç¦®ç‰©ï¼Œä½†æ˜¯æ¡ƒå¯¶ç¾åœ¨æ²’æ±è¥¿è³£äº†ã€‚" };
        break; // è·³å‡º caseï¼Œè®“é€™æ¢æ–‡æœ¬æ¶ˆæ¯è¢«æ­£å¸¸è™•ç†å’Œé¡¯ç¤º
    }

    // 2. å¾æ‰€æœ‰å•†å“ä¸­éš¨æ©ŸæŒ‘é¸ä¸€ä»¶ä½œç‚ºç¦®ç‰©
    const productToBuy = getRandomItem(allProducts);

    // 3. æª¢æŸ¥è§’è‰²çš„éŒ¢åŒ…é¤˜é¡æ˜¯å¦è¶³å¤ 
    const charBalance = chat.characterPhoneData?.bank?.balance || 0;
    if (charBalance < productToBuy.price) {
        // é¤˜é¡ä¸è¶³ï¼ŒAIä¹Ÿæœƒç™¼æ¶ˆæ¯å‘Šè¨´ä½ 
        aiMessage = { ...baseMessage, content: msgData.greeting ? `${msgData.greeting} ...å“å‘€ï¼Œæˆ‘çš„éŒ¢åŒ…å¥½åƒä¸å¤ äº†ã€‚` : "æˆ‘æƒ³çµ¦ä½ è²·å€‹ç¦®ç‰©ï¼Œä½†æ˜¯éŒ¢åŒ…ç©ºäº†..." };
        break;
    }

    // 4. é¤˜é¡å……è¶³ï¼åŸ·è¡Œè³¼è²·æµç¨‹
    // 4a. å¾è§’è‰²çš„éŒ¢åŒ…æ‰£æ¬¾ï¼Œä¸¦ç”Ÿæˆä¸€æ¢äº¤æ˜“è¨˜éŒ„
    await updateCharacterPhoneBankBalance(chat.id, -productToBuy.price, `ç‚ºâ€œæˆ‘â€è³¼è²·ç¦®ç‰©: ${productToBuy.name}`);

    // 4b. åœ¨ä½ çš„â€œæˆ‘çš„è¨‚å–®â€ä¸­å‰µå»ºä¸€æ¢æ–°è¨‚å–®
    const newOrder = {
        productId: productToBuy.id,
        quantity: 1,
        timestamp: Date.now(),
        status: 'å·²ä»˜æ¬¾ï¼Œç­‰å¾…ç™¼è²¨'
    };
    await db.taobaoOrders.add(newOrder);
    
    // 4c. å‰µå»ºä¸€å€‹æ¼‚äº®çš„â€œç¦®ç‰©é€šçŸ¥â€å¡ç‰‡æ¶ˆæ¯ï¼Œç™¼é€çµ¦ä½ 
    aiMessage = {
        ...baseMessage, // è¤‡ç”¨åŸºç¤æ¶ˆæ¯å±¬æ€§ï¼ˆç™¼é€è€…ã€æ™‚é–“æˆ³è¨˜ç­‰ï¼‰
        type: 'gift_notification',
        // é€™æ˜¯å¡ç‰‡æ¸²æŸ“éœ€è¦çš„è³‡æ–™
        payload: {
            senderName: chat.name,
            itemSummary: `${productToBuy.name} x1`,
            totalPrice: productToBuy.price,
            itemCount: 1,
        },
        // é€™æ˜¯çµ¦AIè‡ªå·±çœ‹çš„ã€ç”¨æ–¼å½¢æˆè¨˜æ†¶çš„æ–‡æœ¬å…§å®¹
        content: `æˆ‘çµ¦ä½ è²·äº†ç¦®ç‰©â€œ${productToBuy.name}â€ã€‚${msgData.greeting || ''}`
    };
    
    // 4d. æ¨¡æ“¬ä¸€å€‹10ç§’å¾Œçš„â€œå·²ç™¼è²¨â€ç‰©æµæ›´æ–°
    setTimeout(async () => {
        const orderToUpdate = await db.taobaoOrders.where({ timestamp: newOrder.timestamp }).first();
        if (orderToUpdate) {
            await db.taobaoOrders.update(orderToUpdate.id, { status: 'å·²ç™¼è²¨ï¼Œé‹è¼¸ä¸­' });
        }
    }, 1000 * 10);
    
    break; // å®Œæˆç¦®ç‰©è³¼è²·é‚è¼¯ï¼Œè·³å‡º case
}

// â–²â–²â–² æ–°å¢ case ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ° triggerAiResponse å‡½æ•¸çš„ switch çµæ§‹è£¡ â–¼â–¼â–¼

case 'ls_answer_question': { // ä½¿ç”¨å¤§æ‹¬å¼§å‰µå»ºå¡Šç´šä½œç”¨åŸŸ
    const { questionId, answerText } = msgData;
    if (questionId && answerText) {
        const question = chat.loversSpaceData.questions.find(q => q.id === questionId);
        if (question && !question.answerText) { // ç¢ºä¿æ˜¯æœªå›ç­”çš„å•é¡Œ
            question.answerer = 'char';
            question.answerText = answerText;
            console.log(`AI å›ç­”äº†æƒ…ä¾¶æå• (ID: ${questionId})`);
        }
    }
    continue; // é€™æ˜¯ä¸€å€‹å¾Œè‡ºæ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ä»‹é¢é¡¯ç¤ºï¼Œæ‰€ä»¥ç”¨ continue è·³é
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
case 'ls_ask_question': {
    const { questionText } = msgData;
    if (questionText) {
        const newQuestion = {
            id: 'q_' + Date.now(),
            questioner: 'char',
            questionText: questionText,
            timestamp: Date.now(),
            answerer: 'user', // æŒ‡å®šç”±ç”¨æˆ¶ä¾†å›ç­”
            answerText: null
        };
        if (!chat.loversSpaceData.questions) {
            chat.loversSpaceData.questions = [];
        }
        chat.loversSpaceData.questions.push(newQuestion);
        console.log(`AI ç™¼èµ·äº†ä¸€å€‹æƒ…ä¾¶æå•: ${questionText}`);
    }
    continue; // åŒæ¨£æ˜¯å¾Œè‡ºæ“ä½œ
}
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ° triggerAiResponse å‡½æ•¸çš„ switch çµæ§‹è£¡ â–¼â–¼â–¼
case 'ls_moment': {
    if (chat.loversSpaceData) {
        if (!chat.loversSpaceData.moments) {
            chat.loversSpaceData.moments = [];
        }
        const newMoment = {
            author: 'char', // æ¨™è¨˜æ˜¯AIç™¼çš„
            content: msgData.content,
            timestamp: Date.now(),
            comments: [] // ç‚ºæ–°èªªèªªåˆå§‹åŒ–ä¸€å€‹ç©ºçš„è©•è«–å€
        };
        chat.loversSpaceData.moments.push(newMoment);
        console.log(`AI åœ¨æƒ…ä¾¶ç©ºé–“ç™¼ä½ˆäº†èªªèªª: ${msgData.content}`);
    }
    continue; // é€™æ˜¯ä¸€å€‹å¾Œè‡ºæ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ä»‹é¢é¡¯ç¤ºï¼Œæ‰€ä»¥ç”¨ continue è·³é
}

case 'ls_comment': {
    const { momentIndex, commentText } = msgData;
    if (chat.loversSpaceData && chat.loversSpaceData.moments) {
        // AIè¿”å›çš„ index æ˜¯å¾0é–‹å§‹ä»£è¡¨æœ€æ–°çš„ï¼Œæˆ‘å€‘éœ€è¦è½‰æ›æˆçœŸå¯¦ç´¢å¼•
        const realIndex = chat.loversSpaceData.moments.length - 1 - momentIndex;
        if (realIndex >= 0 && realIndex < chat.loversSpaceData.moments.length) {
            const momentToComment = chat.loversSpaceData.moments[realIndex];
            if (!momentToComment.comments) {
                momentToComment.comments = [];
            }
            momentToComment.comments.push({
                author: chat.name,
                text: commentText
            });
            console.log(`AI è©•è«–äº†æƒ…ä¾¶ç©ºé–“èªªèªª (ç´¢å¼•: ${realIndex}): ${commentText}`);
        }
    }
    continue; // åŒæ¨£æ˜¯å¾Œè‡ºæ“ä½œ
}
case 'ls_photo': { // é€™æ˜¯è™•ç†AIç™¼ç›¸å†Šçš„é‚è¼¯
    if (chat.loversSpaceData) {
        if (!chat.loversSpaceData.photos) {
            chat.loversSpaceData.photos = [];
        }
        const newPhoto = {
            author: 'char',
            type: 'text_image',
            description: msgData.description,
            timestamp: Date.now()
        };
        chat.loversSpaceData.photos.push(newPhoto);
        console.log(`AI åœ¨æƒ…ä¾¶ç©ºé–“ç™¼ä½ˆäº†ç…§ç‰‡(æ–‡å­—åœ–): ${msgData.description}`);
    }
    continue; // ç¹¼çºŒè™•ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
}

case 'ls_letter': { // é€™æ˜¯è™•ç†AIå¯«æƒ…æ›¸çš„é‚è¼¯
    if (chat.loversSpaceData) {
        if (!chat.loversSpaceData.loveLetters) {
            chat.loversSpaceData.loveLetters = [];
        }
        const newLetter = {
            id: 'letter_' + Date.now(),
            senderId: chat.id,
            senderName: chat.name,
            senderAvatar: chat.settings.aiAvatar,
            recipientName: chat.settings.myNickname || 'æˆ‘',
            recipientAvatar: chat.settings.myAvatar,
            content: msgData.content,
            timestamp: Date.now()
        };
        chat.loversSpaceData.loveLetters.push(newLetter);
        console.log(`AI åœ¨æƒ…ä¾¶ç©ºé–“å¯«äº†æƒ…æ›¸: ${msgData.content}`);
    }
    continue; // ç¹¼çºŒè™•ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
}

// â–¼â–¼â–¼ åœ¨ switch (msgData.type) çµæ§‹å…§ï¼Œé»è²¼é€™å€‹å…¨æ–°çš„ case â–¼â–¼â–¼
case 'ls_diary_entry': {
    const { emoji, diary } = msgData;
    if (emoji && diary) {
        const today = new Date().toISOString().split('T')[0]; // ç²å– YYYY-MM-DD æ ¼å¼çš„ä»Šå¤©æ—¥æœŸ
        
        // ç¢ºä¿è³‡æ–™çµæ§‹å­˜åœ¨
        if (!chat.loversSpaceData.emotionDiaries) {
            chat.loversSpaceData.emotionDiaries = {};
        }
        if (!chat.loversSpaceData.emotionDiaries[today]) {
            chat.loversSpaceData.emotionDiaries[today] = {};
        }

        // ä¿å­˜AIçš„æ—¥è¨˜å’Œè¡¨æƒ…
        chat.loversSpaceData.emotionDiaries[today].charEmoji = emoji;
        chat.loversSpaceData.emotionDiaries[today].charDiary = diary;
        
        console.log(`AI åœ¨æƒ…ä¾¶ç©ºé–“è¨˜éŒ„äº†æ—¥è¨˜: ${emoji} ${diary}`);
    }
    continue; // é€™åªæ˜¯ä¸€å€‹å¾Œè‡ºæ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ä»‹é¢ç”Ÿæˆæ¶ˆæ¯ï¼Œæ‰€ä»¥ç”¨ continue è·³é
}
// â–²â–²â–² æ–°å¢ case é»è²¼çµæŸ â–²â–²â–²

case 'ls_share': {
    if (chat.loversSpaceData) {
        if (!chat.loversSpaceData.shares) {
            chat.loversSpaceData.shares = [];
        }
        const newShare = {
            author: 'char', // æ¨™è¨˜æ˜¯AIç™¼çš„
            timestamp: Date.now(),
            ...msgData // å°‡AIè¿”å›çš„æ‰€æœ‰åˆ†äº«è³‡è¨Šï¼ˆtype, shareType, title, artistç­‰ï¼‰éƒ½è¤‡è£½éä¾†
        };
        chat.loversSpaceData.shares.push(newShare);
        console.log(`AI åœ¨æƒ…ä¾¶ç©ºé–“åˆ†äº«äº† [${msgData.shareType}]: ${msgData.title}`);
    }
    continue; // åŒæ¨£æ˜¯å¾Œè‡ºæ“ä½œ
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

                // é€™æ˜¯AIä¸»å‹•ç™¼èµ·é‚€è«‹çš„é‚è¼¯
                case 'lovers_space_invitation': {
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“é–‹å•Ÿï¼Œé˜²æ­¢AIé‡è¤‡é‚€è«‹
                    if (!chat.loversSpaceData) {
                        aiMessage = {
                            ...baseMessage,
                            type: 'lovers_space_invitation',
                            content: `${chat.name} å‘ä½ ç™¼å‡ºäº†ä¸€å€‹æƒ…ä¾¶ç©ºé–“é‚€è«‹`, // é€™å¥è©±ä¸»è¦ç”¨æ–¼èª¿è©¦å’Œæ­·å²è¨˜éŒ„
                            status: 'pending' // ç‹€æ…‹ï¼špending, accepted, rejected
                        };
                    }
                    // å¦‚æœAIå·²ç¶“ç™¼äº†é‚€è«‹ï¼Œé€™è£¡å°±ä¸å†å‰µå»ºaiMessageï¼Œç›¸ç•¶æ–¼è·³é
                    break;
                }

                // é€™æ˜¯AIå›æ‡‰ä½ çš„é‚€è«‹çš„é‚è¼¯
                case 'lovers_space_response': {
                    const invitationMsg = chat.history.find(m => m.type === 'lovers_space_invitation' && m.status === 'pending');
                    if (invitationMsg) {
                        invitationMsg.status = msgData.decision === 'accept' ? 'accepted' : 'rejected';

                        // 1. å‰µå»ºAIæƒ³èªªçš„é‚£å¥è©±çš„æ¶ˆæ¯
                        if (msgData.responseText) {
                            const responseMessage = {
                                ...baseMessage,
                                type: 'text',
                                content: msgData.responseText
                            };
                            chat.history.push(responseMessage);
                            if (isViewingThisChat) {
                                appendMessage(responseMessage, chat);
                            }
                        }

                        // 2. æ ¹æ“šåŒæ„æˆ–æ‹’çµ•ï¼ŒåŸ·è¡Œå¾ŒçºŒæ“ä½œ
                        if (msgData.decision === 'accept') {
                            // åŒæ„å¾Œï¼Œç‚ºé€™å€‹è§’è‰²å‰µå»ºæƒ…ä¾¶ç©ºé–“è³‡æ–™
                            chat.loversSpaceData = {
                                background: 'https://i.postimg.cc/k495F4W5/profile-banner.jpg',
                                relationshipStartDate: null, moments: [], photos: [], albums: [], loveLetters: [], shares: [], questions: [],
                            };
                            // ä¸¦ç™¼é€ä¸€æ¢ç³»çµ±é€šçŸ¥
                            const systemNotice = {
                                role: 'system', type: 'pat_message',
                                content: `[ç³»çµ±ï¼šä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾¶ç©ºé–“å·²æˆåŠŸé–‹å•Ÿï¼]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(systemNotice);
                            if (isViewingThisChat) {
                                appendMessage(systemNotice, chat);
                            }
                        }
                    }
                    // è™•ç†å®Œå¾Œï¼Œä¸å†éœ€è¦ç”Ÿæˆæ–°çš„aiMessageï¼Œæ‰€ä»¥ç”¨ continue è·³é
                    continue;
                }
                
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
case 'qzone_post':
    const newPost = { 
        type: msgData.postType, 
        content: msgData.content || '', 
        publicText: msgData.publicText || '', 
        hiddenContent: msgData.hiddenContent || '', 
        timestamp: Date.now(), 
        authorId: chatId, 
        authorGroupId: chat.groupId, // ã€æ ¸å¿ƒæ–°å¢ã€‘è¨˜éŒ„ä½œè€…çš„åˆ†çµ„ID
        visibleGroupIds: null 
    };
    await db.qzonePosts.add(newPost);
                    updateUnreadIndicator(unreadPostsCount + 1);
                    if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                       await renderQzonePosts();
                    }
                    continue;

// â–¼â–¼â–¼ æ­¥é©Ÿ3.4ï¼šåœ¨ triggerAiResponse ä¸­æ›¿æ›é€™å€‹ case â–¼â–¼â–¼
case 'qzone_comment':
    const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
    if (postToComment) {
        if (!postToComment.comments) postToComment.comments = [];
        
        const newAiComment = { 
            commenterName: msgData.commenterName || chat.name,
            text: msgData.commentText, 
            timestamp: Date.now() 
        };
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æª¢æŸ¥AIæ˜¯å¦æŒ‡å®šäº†å›å¾©ç‰©ä»¶
        if (msgData.replyTo) {
            newAiComment.replyTo = msgData.replyTo;
        }

        postToComment.comments.push(newAiComment);
        await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
        updateUnreadIndicator(unreadPostsCount + 1);
        if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
           await renderQzonePosts();
        }
    }
    continue;
// â–²â–²â–² æ­¥é©Ÿ3.4æ›¿æ›çµæŸ â–²â–²â–²



                case 'qzone_like':
                   const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                   if (postToLike) {
                       if (!postToLike.likes) postToLike.likes = [];
                       if (!postToLike.likes.includes(chat.name)) {
                           postToLike.likes.push(chat.name);
                           await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                           updateUnreadIndicator(unreadPostsCount + 1);
                           if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                              await renderQzonePosts();
                           }
                       }
                   }
                    continue;

                case 'video_call_request':
                    if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                        state.activeChatId = chatId;
                        videoCallState.activeChatId = chatId; 
                        videoCallState.isAwaitingResponse = true;
                        videoCallState.isGroupCall = chat.isGroup;
                        videoCallState.callRequester = msgData.name || chat.name;
                        showIncomingCallModal(chatId); // <--- æŠŠchatIdä½œç‚ºåƒæ•¸å‚³é€²å»
    }
                    continue;

            case 'group_call_request':
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    state.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = true;
                    videoCallState.initiator = 'ai';
                    videoCallState.callRequester = msgData.name;
                    showIncomingCallModal();
                }
                continue;

                case 'pat_user':
                    const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                    const patText = `${msgData.name || chat.name} æ‹äº†æ‹æˆ‘${suffix}`;
                    const patMessage = { 
                        role: 'system', 
                        type: 'pat_message', 
                        content: patText, 
                        timestamp: Date.now() 
                    };
                    chat.history.push(patMessage);
                    if (isViewingThisChat) {
                        const phoneScreen = document.getElementById('phone-screen');
                        phoneScreen.classList.remove('pat-animation');
                        void phoneScreen.offsetWidth;
                        phoneScreen.classList.add('pat-animation');
                        setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
                        appendMessage(patMessage, chat);
                    } else {
                        showNotification(chatId, patText);
                    }
                    continue; 

                case 'update_status':
                    chat.status.text = msgData.status_text;
                    chat.status.isBusy = msgData.is_busy || false;
                    chat.status.lastUpdate = Date.now();
                    
                    const statusUpdateMessage = {
                        role: 'system',
                        type: 'pat_message',
                        content: `[${chat.name}çš„ç‹€æ…‹å·²æ›´æ–°ç‚º: ${msgData.status_text}]`,
                        timestamp: Date.now()
                    };
                    chat.history.push(statusUpdateMessage);

                    if (isViewingThisChat) {
                        appendMessage(statusUpdateMessage, chat);
                    }
                    
                    renderChatList(); 
                    
                    continue; 

                case 'change_music':
                    if (musicState.isActive && musicState.activeChatId === chatId) {
                        const songNameToFind = msgData.song_name;
                        
                        const targetSongIndex = musicState.playlist.findIndex(
                            track => track.name.toLowerCase() === songNameToFind.toLowerCase()
                        );

                        if (targetSongIndex > -1) {
                            playSong(targetSongIndex);

                            const track = musicState.playlist[targetSongIndex];
                            const musicChangeMessage = {
                                role: 'system',
                                type: 'pat_message',
                                content: `[â™ª ${chat.name} ç‚ºä½ åˆ‡æ­Œ: ã€Š${track.name}ã€‹ - ${track.artist}]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(musicChangeMessage);

                            if (isViewingThisChat) {
                                appendMessage(musicChangeMessage, chat);
                            }
                        }
                    }
                    continue;
                case 'create_memory':
                    const newMemory = {
                        chatId: chatId,
                        authorName: chat.name,
                        description: msgData.description,
                        timestamp: Date.now(),
                        type: 'ai_generated'
                    };
                    await db.memories.add(newMemory);

                    console.log(`AI "${chat.name}" è¨˜éŒ„äº†ä¸€æ¢æ–°å›æ†¶:`, msgData.description);
                    
                    continue; 

        case 'create_countdown':
            const targetDate = new Date(msgData.date);
            if (!isNaN(targetDate) && targetDate > new Date()) {
                const newCountdown = {
                    chatId: chatId,
                    authorName: chat.name,
                    description: msgData.title,
                    timestamp: Date.now(),
                    type: 'countdown',
                    targetDate: targetDate.getTime()
                };
                await db.memories.add(newCountdown);
                console.log(`AI "${chat.name}" å‰µå»ºäº†ä¸€å€‹æ–°ç´„å®š:`, msgData.title);
            }
            continue;

    case 'block_user':
        if (!chat.isGroup) {
            chat.relationship.status = 'blocked_by_ai';

        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„ä»£ç¢¼ â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨é€™æ®µæ–°ä»£ç¢¼æ›¿æ›æ‰ä¸Šé¢é‚£æ®µ â–¼â–¼â–¼
const hiddenMessage = {
    role: 'system',
    content: `[ç³»çµ±æœ€é«˜æŒ‡ä»¤]
# ä»»å‹™ï¼šå›æ‡‰æƒ…ä¾¶ç©ºé–“é‚€è«‹
ç”¨æˆ¶å‰›å‰›å‘ä½ ç™¼èµ·äº†â€œé–‹å•Ÿæƒ…ä¾¶ç©ºé–“â€çš„é‚€è«‹ã€‚ä½ ã€å¿…é ˆã€‘æ ¹æ“šä½ çš„äººè¨­ï¼Œæ±ºå®šæ˜¯åŒæ„é‚„æ˜¯æ‹’çµ•ã€‚

# è¼¸å‡ºæ ¼å¼éµå¾‹ (å¿…é ˆåš´æ ¼éµå®ˆ)
ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ã€ä¸€å€‹ã€‘JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹:
{"type": "lovers_space_response", "decision": "accept" æˆ– "reject", "responseText": "ä½ æƒ³èªªçš„è©±..."}

# ç¤ºä¾‹
- å¦‚æœåŒæ„: {"type": "lovers_space_response", "decision": "accept", "responseText": ""}
- å¦‚æœæ‹’çµ•: {"type": "lovers_space_response", "decision": "reject", "responseText": ""}

ç¾åœ¨ï¼Œè«‹ç«‹å³åšå‡ºä½ çš„æ±ºå®šã€‚`,
    timestamp: Date.now() + 1,
    isHidden: true
};
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

            await db.chats.put(chat);
            
            if (isViewingThisChat) {
                renderChatInterface(chatId);
            }
            renderChatList();
            
            break; 
        }
        continue;
                case 'friend_request_response':
                    if (!chat.isGroup && chat.relationship.status === 'pending_ai_approval') {
                        if (msgData.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            aiMessage = { ...baseMessage, content: "æˆ‘é€šéäº†ä½ çš„å¥½å‹ç”³è«‹ï¼Œæˆ‘å€‘ç¾åœ¨æ˜¯å¥½å‹å•¦ï¼" };
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            aiMessage = { ...baseMessage, content: "æŠ±æ­‰ï¼Œæˆ‘æ‹’çµ•äº†ä½ çš„å¥½å‹ç”³è«‹ã€‚" };
                        }
                        chat.relationship.applicationReason = '';
                    }
                    break;
                case 'poll':
                    const pollOptions = typeof msgData.options === 'string'
                        ? msgData.options.split('\n').filter(opt => opt.trim())
                        : (Array.isArray(msgData.options) ? msgData.options : []);
                    
                    if (pollOptions.length < 2) continue;

                    aiMessage = {
                        ...baseMessage,
                        type: 'poll',
                        question: msgData.question,
                        options: pollOptions,
                        votes: {},
                        isClosed: false,
                    };
                    break;
                
                case 'vote':
                    const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
                    if (pollToVote && !pollToVote.isClosed) {
                        Object.keys(pollToVote.votes).forEach(option => {
                            const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                            if (voterIndex > -1) {
                                pollToVote.votes[option].splice(voterIndex, 1);
                            }
                        });
                        if (!pollToVote.votes[msgData.choice]) {
                            pollToVote.votes[msgData.choice] = [];
                        }

// â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
const member = chat.members.find(m => m.originalName === msgData.name);
const displayName = member ? member.groupNickname : msgData.name;
// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

if (!pollToVote.votes[msgData.choice].includes(displayName)) { // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
    pollToVote.votes[msgData.choice].push(displayName); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
}                     
                        
                        if (isViewingThisChat) {
                            renderChatInterface(chatId);
                        }
                    }
                    continue;

    case 'red_packet':
        aiMessage = {
            ...baseMessage,
            type: 'red_packet',
            packetType: msgData.packetType,
            totalAmount: msgData.amount,
            count: msgData.count,
            greeting: msgData.greeting,
            receiverName: msgData.receiver,
            claimedBy: {},
            isFullyClaimed: false,
        };
                // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
        // ã€å…¨æ–°ã€‘åŒæ­¥åˆ°è§’è‰²éŒ¢åŒ…ï¼ˆæ”¯å‡ºï¼‰
        const rpDescription = `ç™¼å‡ºç´…åŒ… - ${msgData.greeting || 'æ­å–œç™¼è²¡'}`;
        await updateCharacterBankBalance(chatId, -msgData.amount, rpDescription);
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        break;
// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch èªå¥ä¸­ï¼Œç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ case 'open_red_packet' â–¼â–¼â–¼
case 'open_red_packet': { // ä½¿ç”¨å¤§æ‹¬å¼§å‰µå»ºç¨ç«‹çš„å¡Šç´šä½œç”¨åŸŸ
    const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
    // æª¢æŸ¥ç´…åŒ…æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦æ²’è¢«é ˜å®Œã€ä»¥åŠé€™å€‹AIè§’è‰²æ˜¯å¦é‚„æ²’é ˜é
    if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {

        // 1. æ ¹æ“šAIçš„æœ¬å(msgData.name)å»æˆå“¡æ¸…å–®è£¡æ‰¾åˆ°å®Œæ•´çš„æˆå“¡å°è±¡
        const member = chat.members.find(m => m.originalName === msgData.name);
        // 2. ç²å–è©²æˆå“¡ç•¶å‰çš„ç¾¤æ˜µç¨±ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼ˆç•°å¸¸æƒ…æ³ï¼‰ï¼Œå‰‡å‚™ç”¨å…¶æœ¬å
        const displayName = member ? member.groupNickname : msgData.name;
        
        let claimedAmountAI = 0;
        const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
        const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;

        if (remainingCount > 0) {
            if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
            else {
                const min = 0.01;
                const max = remainingAmount - (remainingCount - 1) * min;
                claimedAmountAI = Math.random() * (max - min) + min;
            }
            claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
            
            if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
            // 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æˆ‘å€‘å‰›å‰›æŸ¥æ‰¾åˆ°çš„ displayName ä½œç‚ºè¨˜éŒ„çš„key
            packetToOpen.claimedBy[displayName] = claimedAmountAI;
                        // ã€å…¨æ–°ã€‘åŒæ­¥åˆ°è§’è‰²éŒ¢åŒ…ï¼ˆæ”¶å…¥ï¼‰
            const openRpDescription = `é ˜å–äº† ${packetToOpen.senderName} çš„ç´…åŒ…`;
            // é€™è£¡çš„ AI è§’è‰²å¯èƒ½ä¸æ˜¯ç•¶å‰èŠå¤©çš„ `chatId`ï¼ˆå› ç‚ºæ˜¯åœ¨ç¾¤è£¡æ¶ç´…åŒ…ï¼‰ï¼Œæ‰€ä»¥è¦ç²¾ç¢ºæ‰¾åˆ°æ˜¯èª°æ¶çš„
            const openerChar = Object.values(state.chats).find(c => c.name === displayName);
            if (openerChar) {
                 await updateCharacterBankBalance(openerChar.id, claimedAmountAI, openRpDescription);
            }
            
            const aiClaimedMessage = {
                role: 'system',
                type: 'pat_message',
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç³»çµ±æ¶ˆæ¯è£¡ä¹Ÿä½¿ç”¨ displayName
                content: `${displayName} é ˜å–äº† ${packetToOpen.senderName} çš„ç´…åŒ…`,
                timestamp: Date.now()
            };
            chat.history.push(aiClaimedMessage);

            let hiddenContentForAI = `[ç³»çµ±æç¤ºï¼šä½  (${displayName}) æˆåŠŸæ¶åˆ°äº† ${claimedAmountAI.toFixed(2)} å…ƒã€‚`;

            if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                packetToOpen.isFullyClaimed = true;
                
                const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${packetToOpen.senderName} çš„ç´…åŒ…å·²è¢«é ˜å®Œ`,
                    timestamp: Date.now() + 1
                };
                chat.history.push(finishedMessage);
                
                let luckyKing = { name: '', amount: -1 };
                if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }
                if (luckyKing.name) {
                     hiddenContentForAI += ` ç´…åŒ…å·²è¢«é ˜å®Œï¼Œæ‰‹æ°£ç‹æ˜¯ ${luckyKing.name}ï¼`;
                } else {
                     hiddenContentForAI += ` ç´…åŒ…å·²è¢«é ˜å®Œã€‚`;
                }
            }
            hiddenContentForAI += ' è«‹æ ¹æ“šé€™å€‹çµæœç™¼è¡¨ä½ çš„è©•è«–ã€‚]';

            const hiddenMessageForAI = {
                role: 'system',
                content: hiddenContentForAI,
                timestamp: Date.now() + 2,
                isHidden: true
            };
            chat.history.push(hiddenMessageForAI);
        }
        
        if (isViewingThisChat) {
            renderChatInterface(chatId);
        }
    }
    continue; // è™•ç†å®Œå¾Œï¼Œç¹¼çºŒè™•ç†AIè¿”å›çš„å…¶ä»–æ¶ˆæ¯
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

case 'change_avatar':
    const avatarName = msgData.name;
    // åœ¨è©²è§’è‰²çš„é ­åƒåº«ä¸­æŸ¥æ‰¾
    const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
    
    if (foundAvatar) {
        // æ‰¾åˆ°äº†ï¼Œå°±æ›´æ–°é ­åƒ
        chat.settings.aiAvatar = foundAvatar.url;
        
        // å‰µå»ºä¸€æ¢ç³»çµ±æç¤ºï¼Œå‘ŠçŸ¥ä½¿ç”¨è€…é ­åƒå·²æ›´æ›
        const systemNotice = {
            role: 'system',
            type: 'pat_message', // è¤‡ç”¨å±…ä¸­æ¨£å¼
            content: `[${chat.name} æ›´æ›äº†é ­åƒ]`,
            timestamp: Date.now()
        };
        chat.history.push(systemNotice);
        
        // å¦‚æœåœ¨ç•¶å‰èŠå¤©ä»‹é¢ï¼Œå‰‡å³æ™‚æ¸²æŸ“
        if (isViewingThisChat) {
            appendMessage(systemNotice, chat);
            // ç«‹åˆ»åˆ·æ–°èŠå¤©ä»‹é¢ä»¥é¡¯ç¤ºæ–°é ­åƒ
            renderChatInterface(chatId);
        }
    }
    // è™•ç†å®Œå¾Œï¼Œç¹¼çºŒè™•ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
    continue;

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch èªå¥ä¸­ï¼Œã€æ·»åŠ ã€‘é€™å…©å€‹å…¨æ–°çš„ case â–¼â–¼â–¼

                case 'accept_transfer': { // ä½¿ç”¨å¤§æ‹¬å¼§å‰µå»ºå¡Šç´šä½œç”¨åŸŸ
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'accepted';
                        
                        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                        // ã€å…¨æ–°ã€‘åŒæ­¥åˆ°è§’è‰²éŒ¢åŒ…ï¼ˆæ”¶å…¥ï¼‰
                        const acceptDescription = `æ”¶åˆ°ä¾†è‡ª ${originalMsg.senderName} çš„è½‰å¸³`;
                        await updateCharacterBankBalance(chatId, originalMsg.amount, acceptDescription);
                        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
                    }
                    continue; // æ¥å—æŒ‡ä»¤åªä¿®æ”¹ç‹€æ…‹ï¼Œä¸ç”¢ç”Ÿæ–°æ¶ˆæ¯
                }

                case 'decline_transfer': { // ä½¿ç”¨å¤§æ‹¬å¼§å‰µå»ºå¡Šç´šä½œç”¨åŸŸ
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'declined';
                        
                        // ã€æ ¸å¿ƒã€‘å‰µå»ºä¸€æ¢æ–°çš„â€œé€€æ¬¾â€æ¶ˆæ¯
                        const refundMessage = {
                            role: 'assistant',
                            senderName: chat.name,
                            type: 'transfer',
                            isRefund: true, // æ¨™è¨˜é€™æ˜¯ä¸€æ¢é€€æ¬¾æ¶ˆæ¯
                            amount: originalMsg.amount,
                            note: 'è½‰å¸³å·²è¢«æ‹’æ”¶',
                            timestamp: messageTimestamp++ // ä½¿ç”¨éå¢çš„æ™‚é–“æˆ³è¨˜
                        };
                        
                        // å°‡æ–°æ¶ˆæ¯æ¨å…¥æ­·å²è¨˜éŒ„ï¼Œå®ƒæœƒè¢«å¾ŒçºŒçš„è¿´åœˆè™•ç†ä¸¦æ¸²æŸ“
                        chat.history.push(refundMessage);

        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„ä»£ç¢¼ â–¼â–¼â–¼
        if (isViewingThisChat) {
            // å› ç‚ºé€€æ¬¾æ¶ˆæ¯æ˜¯æ–°ç”Ÿæˆçš„ï¼Œæ‰€ä»¥æˆ‘å€‘ç›´æ¥å°‡å®ƒæ·»åŠ åˆ°ä»‹é¢ä¸Š
            appendMessage(refundMessage, chat); 
            // åŒæ™‚ï¼ŒåŸå§‹çš„è½‰å¸³æ¶ˆæ¯ç‹€æ…‹è®Šäº†ï¼Œæ‰€ä»¥è¦é‡ç¹ªæ•´å€‹ä»‹é¢ä»¥æ›´æ–°å®ƒ
            renderChatInterface(chatId); 
        }
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

                    }
                    continue; // ç¹¼çºŒè™•ç†AIè¿”å›çš„æ–‡æœ¬æ¶ˆæ¯
                }

// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

    case 'system_message':
        aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
        break;

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch èªå¥ä¸­ï¼Œã€å¿…é ˆæ·»åŠ ã€‘é€™å€‹æ–°çš„ case â–¼â–¼â–¼

                case 'share_link':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'share_link',
                        title: msgData.title,
                        description: msgData.description,
                        // thumbnail_url: msgData.thumbnail_url, // æˆ‘å€‘å·²ç¶“æ±ºå®šä¸è¦åœ–ç‰‡äº†ï¼Œæ‰€ä»¥é€™è¡Œå¯ä»¥ä¸è¦
                        source_name: msgData.source_name,
                        content: msgData.content // é€™æ˜¯æ–‡ç« æ­£æ–‡ï¼Œé»æ“Šå¡ç‰‡å¾Œé¡¯ç¤ºçš„å…§å®¹
                    };
                    break;

// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch (msgData.type) èªå¥ä¸­ï¼Œæ·»åŠ é€™å€‹æ–°çš„ case â–¼â–¼â–¼
case 'quote_reply':
    const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
    if (originalMessage) {
        const quoteContext = {
            timestamp: originalMessage.timestamp,
            senderName: originalMessage.senderName || (originalMessage.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name),
            content: String(originalMessage.content || '').substring(0, 50),
        };
        aiMessage = { 
            ...baseMessage, 
            content: msgData.reply_content,
            quote: quoteContext // æ ¸å¿ƒï¼šåœ¨é€™è£¡é™„åŠ å¼•ç”¨å°è±¡
        };
    } else {
        // å¦‚æœæ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯ï¼Œå°±ç•¶ä½œæ™®é€šæ¶ˆæ¯ç™¼é€
        aiMessage = { ...baseMessage, content: msgData.reply_content };
    }
    break;
// â–²â–²â–² æ–°å¢ case çµæŸ â–²â–²â–²

case 'location':
    aiMessage = {
        ...baseMessage,
        type: 'location',
        userLocation: msgData.userLocation,
        aiLocation: msgData.aiLocation,
        distance: msgData.distance,
        trajectoryPoints: msgData.trajectoryPoints || [] // ã€æ–°å¢ã€‘ç¢ºä¿å³ä½¿AIæ²’æä¾›ï¼Œä¹Ÿæ˜¯ä¸€å€‹ç©ºé™£åˆ—
    };
    break;
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

case 'send_and_recall': {
    // --- å‹•ç•«éƒ¨åˆ† (ä¿æŒä¸è®Š) ---
    if (!isViewingThisChat) continue;
    const tempMessageData = { ...baseMessage, content: msgData.content };
    appendMessage(tempMessageData, chat, true);
    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 1500));
    const bubbleWrapper = document.querySelector(`.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`)?.closest('.message-wrapper');
    if (bubbleWrapper) {
        bubbleWrapper.classList.add('recalled-animation');
        await new Promise(resolve => setTimeout(resolve, 300));
    }

    // --- æ ¸å¿ƒä¿®æ”¹ï¼šè³‡æ–™è¨˜éŒ„èˆ‡AIæ„ŸçŸ¥ ---
    
    // 1. å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„â€œå·²æ’¤å›â€æ¶ˆæ¯
    const recalledMessage = {
        role: 'assistant',
        senderName: msgData.name || chat.name,
        type: 'recalled_message',
        content: 'å°æ–¹æ’¤å›äº†ä¸€æ¢æ¶ˆæ¯',
        timestamp: tempMessageData.timestamp,
        recalledData: { originalType: 'text', originalContent: msgData.content }
    };
    
    // 2. ã€é—œéµã€‘å‰µå»ºä¸€æ¢å°ç”¨æˆ¶éš±è—ã€ä½†å°AIå¯è¦‹çš„â€œè¨˜æ†¶â€æ¶ˆæ¯
    const hiddenMemoryMessage = {
        role: 'system', // å¿…é ˆæ˜¯ systemï¼Œé€™æ¨£AIæ‰çŸ¥é“é€™æ˜¯ä¸Šä¸‹æ–‡è³‡è¨Š
        content: `[ç³»çµ±æç¤ºï¼šä½ å‰›å‰›èªªäº†ä¸€å¥â€œ${msgData.content}â€ï¼Œä½†ç«‹åˆ»å°±æ’¤å›äº†å®ƒã€‚]`,
        timestamp: tempMessageData.timestamp + 1, // ç¢ºä¿åœ¨æ’¤å›æ¶ˆæ¯ä¹‹å¾Œ
        isHidden: true // é€™å€‹æ¨™è¨˜è®“å®ƒä¸åœ¨UIä¸Šé¡¯ç¤º
    };

    // 3. å°‡é€™å…©æ¢æ¶ˆæ¯éƒ½æ·»åŠ åˆ°æ­·å²è¨˜éŒ„ä¸­
    chat.history.push(recalledMessage, hiddenMemoryMessage);
    
    // 4. æ›¿æ›DOMï¼Œé¡¯ç¤ºâ€œå·²æ’¤å›â€æç¤º
    const placeholder = createMessageElement(recalledMessage, chat);
    if(document.body.contains(bubbleWrapper)) {
        bubbleWrapper.parentNode.replaceChild(placeholder, bubbleWrapper);
    }
    
    continue;
}
                
case 'sticker': {
    // é€™æ˜¯ç‚ºç¾¤èŠå’Œå–®èŠçµ±ä¸€è¨­è¨ˆçš„è¡¨æƒ…åŒ…é‚è¼¯
    const stickerName = msgData.sticker_name; // é—œéµä¿®æ”¹ï¼šçµ±ä¸€ä½¿ç”¨ sticker_name
    if (!stickerName) {
        console.warn('AIè¿”å›äº†stickeré¡å‹ä½†æ²’æœ‰sticker_nameï¼Œå·²æ””æˆª:', msgData);
        continue; // è·³éé€™æ¢ç„¡æ•ˆæŒ‡ä»¤
    }
    
    // åœ¨æ‰€æœ‰å¯ç”¨è¡¨æƒ…åº«ä¸­æŸ¥æ‰¾
    const allStickers = [...state.userStickers, ...state.charStickers, ...(chat.settings.stickerLibrary || [])];
    const foundSticker = allStickers.find(s => s.name === stickerName);

    if (foundSticker) {
        // æ‰¾åˆ°äº†ï¼Œå°±å‰µå»ºæ¶ˆæ¯ç‰©ä»¶
        aiMessage = { 
            ...baseMessage, 
            type: 'sticker', 
            content: foundSticker.url, 
            meaning: foundSticker.name 
        };
    } else {
        // æ²’æ‰¾åˆ°ï¼Œèªªæ˜AIå¹»è¦ºäº†ï¼Œè¨˜éŒ„è­¦å‘Šä¸¦è·³é
        console.warn(`AIæœæ’°äº†ä¸å­˜åœ¨çš„è¡¨æƒ…: "${stickerName}"ï¼Œå·²è‡ªå‹•æ””æˆªã€‚`);
    }
    break;
}
            case 'text': { 
                const messageText = String(msgData.content || msgData.message || '');
                
                if (STICKER_REGEX.test(messageText)) {
                    aiMessage = { ...baseMessage, type: 'sticker', content: messageText, meaning: '' };
                } 
                else {
                    // ç›¸å®¹èˆŠçš„[sticker:åå­—]æ ¼å¼ï¼Œä½†æ–°promptå·²ä¸æ¨è–¦
                    const stickerMatch = messageText.match(/^\[sticker:(.+?)\]$/); 
                    if (stickerMatch) {
                        const stickerName = stickerMatch[1].trim();
                        const allStickers = [...state.userStickers, ...state.charStickers, ...(chat.settings.stickerLibrary || [])];
                        const foundSticker = allStickers.find(s => s.name === stickerName);
                        
                        if (foundSticker) {
                            aiMessage = { ...baseMessage, type: 'sticker', content: foundSticker.url, meaning: foundSticker.name };
                        } else {
                            console.warn(`AIä½¿ç”¨äº†èˆŠæ ¼å¼ä¸”æœæ’°äº†ä¸å­˜åœ¨çš„è¡¨æƒ…: "${stickerName}"ï¼Œå·²æ””æˆªã€‚`);
                        }
                    } else {
                        aiMessage = { ...baseMessage, content: messageText };
                    }
                }
                break;
            }

    // â–¼â–¼â–¼ åœ¨ä»»æ„ä¸€å€‹ case çš„å¾Œé¢ï¼Œé»è²¼ä¸‹é¢é€™å€‹å…¨æ–°çš„ case â–¼â–¼â–¼
    case 'forum_comment': { // ä½¿ç”¨å¤§æ‹¬å¼§å‰µå»ºå¡Šç´šä½œç”¨åŸŸ
        const postIdToComment = msgData.postId;
        const commentText = msgData.commentText;

        if (postIdToComment && commentText) {
            // å‰µå»ºæ–°çš„è©•è«–ç‰©ä»¶
            const newComment = {
                postId: postIdToComment,
                author: chat.name, // è©•è«–è€…å°±æ˜¯ç•¶å‰AI
                content: commentText,
                timestamp: Date.now()
            };
            // å­˜å…¥è³‡æ–™åº«
            await db.forumComments.add(newComment);
            
            // çµ¦ç”¨æˆ¶ä¸€å€‹å›é¥‹é€šçŸ¥
            const postInfo = await db.forumPosts.get(postIdToComment);
            const postTitle = postInfo ? `ã€Š${postInfo.title}ã€‹` : 'ä¸€å€‹å¸–å­';
            showNotification(chatId, `æˆ‘è©•è«–äº†å¸–å­ ${postTitle}`);
        }
        // é€™å€‹æŒ‡ä»¤åªæ˜¯å¾Œè‡ºæ“ä½œï¼Œä¸éœ€è¦åœ¨ç•¶å‰èŠå¤©è£¡é¡¯ç¤ºæ–°æ¶ˆæ¯ï¼Œæ‰€ä»¥ç”¨ continue
        continue; 
    }
    // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
                case 'ai_image':
                    aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                    break;
                case 'voice_message':
                    aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                    break;
                case 'transfer':
                    aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'æˆ‘' };
                                        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    // ã€å…¨æ–°ã€‘åŒæ­¥åˆ°è§’è‰²éŒ¢åŒ…ï¼ˆæ”¯å‡ºï¼‰
                    const transferDescription = `è½‰å¸³çµ¦ ${msgData.receiver || 'æˆ‘'}`;
                    await updateCharacterBankBalance(chatId, -msgData.amount, transferDescription);
                    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
                    break;
                
                case 'waimai_request':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'waimai_request',
                        productInfo: msgData.productInfo,
                        amount: msgData.amount,
                        status: 'pending',
                        countdownEndTime: Date.now() + 15 * 60 * 1000,
                    };
                    break;
                
                default:
                     console.warn("æ”¶åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤é¡å‹:", msgData.type);
                     break;
            }

            // ã€æ ¸å¿ƒä¿®å¾©ã€‘å°‡æ¸²æŸ“é‚è¼¯ç§»å‡ºè¿´åœˆ
            if (aiMessage) {
                // 1. å°‡æ–°æ¶ˆæ¯å­˜å…¥æ­·å²è¨˜éŒ„
                chat.history.push(aiMessage);

                if (!isViewingThisChat && !notificationShown) {
                    let notificationText;
                    switch (aiMessage.type) {
                        case 'transfer':
                            notificationText = `[æ”¶åˆ°ä¸€ç­†è½‰å¸³]`;
                            break;
                        case 'waimai_request':
                            notificationText = `[æ”¶åˆ°ä¸€å€‹å¤–è³£ä»£ä»˜è«‹æ±‚]`;
                            break;
                        case 'ai_image':
                            notificationText = `[åœ–ç‰‡]`;
                            break;
                        case 'voice_message':
                            notificationText = `[èªéŸ³]`;
                            break;
                        case 'sticker':
                            notificationText = aiMessage.meaning ? `[è¡¨æƒ…: ${aiMessage.meaning}]` : '[è¡¨æƒ…]';
                            break;
                        default:
                            notificationText = String(aiMessage.content || '');
                    }
                    const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                    showNotification(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
                    notificationShown = true; // ç¢ºä¿åªé€šçŸ¥ä¸€æ¬¡
                }

    if (!isViewingThisChat) {
        // å¦‚æœä½¿ç”¨è€…ä¸åœ¨ç•¶å‰èŠå¤©ä»‹é¢ï¼Œå°±æŠŠé€™å€‹èŠå¤©çš„æœªè®€æ•¸ +1
        chat.unreadCount = (chat.unreadCount || 0) + 1;
    }
                
                // 2. åªæœ‰åœ¨ç•¶å‰èŠå¤©ä»‹é¢æ™‚ï¼Œæ‰åŸ·è¡Œå¸¶å‹•ç•«çš„æ·»åŠ 
                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    // 3. ã€é—œéµã€‘åœ¨é€™è£¡æš«åœä¸€å°æœƒå…’ï¼Œçµ¦å‹•ç•«æ’­æ”¾çš„æ™‚é–“
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
                }
            }
  }        

        if (callHasBeenHandled && videoCallState.isGroupCall) {
            videoCallState.isAwaitingResponse = false;
            if (videoCallState.participants.length > 0) {
                startVideoCall();
            } else {
                videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                showScreen('chat-interface-screen');
                alert('ç„¡äººæ¥è½ç¾¤èŠé‚€è«‹ã€‚');
            }
        }
        
        await db.chats.put(chat);
checkAndTriggerSummary(chatId);
    } catch (error) {
        chat.history = chat.history.filter(msg => !msg.isTemporary);
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            chat.relationship.status = 'blocked_by_ai';
            await showCustomAlert('ç”³è«‹å¤±æ•—', `AIåœ¨è™•ç†ä½ çš„å¥½å‹ç”³è«‹æ™‚å‡ºéŒ¯äº†ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚\néŒ¯èª¤è³‡è¨Š: ${error.message}`);
        } else {
            const errorContent = `[å‡ºéŒ¯äº†: ${error.message}]`;
            const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() };
            if(chat.isGroup) errorMessage.senderName = "ç³»çµ±æ¶ˆæ¯";
            chat.history.push(errorMessage);
        }
        
        await db.chats.put(chat);        
        videoCallState.isAwaitingResponse = false;

        if(document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId) {
            renderChatInterface(chatId);
        }
    } finally {
        // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹4ï¼šåœ¨ finally å¡Šä¸­çµ±ä¸€éš±è—æ‰€æœ‰é¡å‹çš„æç¤ºã€‘â˜…â˜…â˜…â˜…â˜…
        if (chat.isGroup) {
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        } else {
            if (chatHeaderTitle && state.chats[chatId]) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }
    }
}

        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat);checkAndTriggerSummary(state.activeChatId);  appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘ä»£ç¢¼æ›¿æ›èˆŠçš„ sendUserTransfer å‡½æ•¸ â–¼â–¼â–¼
async function sendUserTransfer() { 
    if (!state.activeChatId) return; 
    
    const amountInput = document.getElementById('transfer-amount'); 
    const noteInput = document.getElementById('transfer-note'); 
    const amount = parseFloat(amountInput.value); 
    const note = noteInput.value.trim(); 
    
    if (isNaN(amount) || amount <= 0) { 
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼'); 
        return; 
    } 

    // ã€æ ¸å¿ƒæ–°å¢1ã€‘æª¢æŸ¥é¤˜é¡æ˜¯å¦è¶³å¤ 
    if ((state.globalSettings.userBalance || 0) < amount) {
        alert('é¤˜é¡ä¸è¶³ï¼');
        return;
    }

    const chat = state.chats[state.activeChatId]; 
    const senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘'; 
    const receiverName = chat.isGroup ? 'ç¾¤èŠ' : chat.name; 

    // ã€æ ¸å¿ƒæ–°å¢2ã€‘èª¿ç”¨æˆ‘å€‘çš„æ–°å‡½æ•¸ä¾†æ‰£æ¬¾ä¸¦è¨˜éŒ„
    await updateUserBalanceAndLogTransaction(-amount, `è½‰å¸³çµ¦ ${receiverName}`);

    const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; 
    chat.history.push(msg); 
    
    await db.chats.put(chat); 
    appendMessage(msg, chat); 
    renderChatList(); 
    document.getElementById('transfer-modal').classList.remove('visible'); 
    amountInput.value = ''; 
    noteInput.value = ''; 
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }

        function exitSelectionMode() {
    cleanupWaimaiTimers(); // <--- åœ¨é€™è£¡æ·»åŠ é€™è¡Œä»£ç¢¼
 if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }

// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€æœ€çµ‚ç°¡åŒ–ç‰ˆã€‘æ›¿æ›èˆŠçš„ toggleMessageSelection å‡½æ•¸ â–¼â–¼â–¼
function toggleMessageSelection(timestamp) {
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘é¸æ“‡å™¨å·²ç°¡åŒ–ï¼Œä¸å†å°‹æ‰¾å·²åˆªé™¤çš„ .recalled-message-placeholder
    const elementToSelect = document.querySelector(
        `.message-bubble[data-timestamp="${timestamp}"]`
    );

    if (!elementToSelect) return;

    if (selectedMessages.has(timestamp)) {
        selectedMessages.delete(timestamp);
        elementToSelect.classList.remove('selected');
    } else {
        selectedMessages.add(timestamp);
        elementToSelect.classList.add('selected');
    }
    
    document.getElementById('selection-count').textContent = `å·²é¸ ${selectedMessages.size} æ¢`;
    
    if (selectedMessages.size === 0) {
        exitSelectionMode();
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }

        async function handleListenTogetherClick() { 

    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œä»£ç¢¼ â–¼â–¼â–¼
    document.getElementById('floating-lyrics-bar').style.display = 'none';
    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'æœªçŸ¥'; const newChatName = state.chats[targetChatId]?.name || 'ç•¶å‰'; const confirmed = await showCustomConfirm('åˆ‡æ›è½æ­Œå°è±¡', `æ‚¨æ­£å’Œã€Œ${oldChatName}ã€è½æ­Œã€‚è¦çµæŸä¸¦é–‹å§‹å’Œã€Œ${newChatName}ã€çš„æ–°æœƒè©±å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

async function endListenTogetherSession(saveState = true) {
    if (!musicState.isActive) return;
    const oldChatId = musicState.activeChatId;
    const cleanupLogic = async () => {

    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œä»£ç¢¼ â–¼â–¼â–¼
    document.getElementById('floating-lyrics-bar').style.display = 'none';
    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

        if (musicState.timerId) clearInterval(musicState.timerId);
        if (musicState.isPlaying) audioPlayer.pause();
        if (saveState && oldChatId && state.chats[oldChatId]) {
            const chat = state.chats[oldChatId];
            chat.musicData.totalTime = musicState.totalElapsedTime;
            await db.chats.put(chat);
        }
        musicState.isActive = false;
        musicState.activeChatId = null;
        musicState.totalElapsedTime = 0;
        musicState.timerId = null;
        updateListenTogetherIcon(oldChatId, true);
    };
    closeMusicPlayerWithAnimation(cleanupLogic);
}

function returnToChat() {
    closeMusicPlayerWithAnimation(() => {

        if (musicState.isActive && lyricsBarSettings.showOnClose) {
            document.getElementById('floating-lyrics-bar').style.display = 'flex';
        }
    });
}

        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;

        function updatePlayerUI() {
            updateListenTogetherIcon(musicState.activeChatId);
            updateElapsedTimeDisplay();
            const titleEl = document.getElementById('music-player-song-title');
            const artistEl = document.getElementById('music-player-artist');
            const playPauseBtn = document.getElementById('music-play-pause-btn');
            const chat = state.chats[musicState.activeChatId];
            const charAvatarEl = document.getElementById('music-char-avatar');
            const userAvatarEl = document.getElementById('music-user-avatar');
            const albumCoverEl = document.getElementById('music-album-cover');
            const avatarsContainer = document.getElementById('music-avatars-container');
            const displayArea = document.getElementById('music-display-area');

            // 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡åˆ¤æ–·æ˜¯ç¾¤èŠé‚„æ˜¯å–®èŠï¼Œä¸¦è¨­ç½®æ­£ç¢ºçš„é ­åƒ
            if (chat) {
                // å¦‚æœæ˜¯ç¾¤èŠ
                if (chat.isGroup) {
                    // å·¦é‚Šçš„é ­åƒå°±ç”¨ç¾¤é ­åƒ
                    charAvatarEl.src = chat.settings.groupAvatar || defaultGroupAvatar;
                } else {
                    // å¦å‰‡ï¼ˆæ˜¯å–®èŠï¼‰ï¼Œå°±ç”¨è§’è‰²çš„é ­åƒ
                    charAvatarEl.src = chat.settings.aiAvatar || defaultAvatar;
                }
                // å³é‚Šçš„ç”¨æˆ¶é ­åƒä¿æŒä¸è®Š
                userAvatarEl.src = chat.settings.myAvatar || defaultAvatar;
            }

            // 2. æ›´æ–°æ­Œæ›²è³‡è¨Šå’Œå°é¢ (ä¸è®Š)
            if (musicState.currentIndex > -1 && musicState.playlist.length > 0) {
                const track = musicState.playlist[musicState.currentIndex];
                titleEl.textContent = track.name;
                artistEl.textContent = track.artist;
                albumCoverEl.src = track.cover || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            } else {
                titleEl.textContent = 'è«‹æ·»åŠ æ­Œæ›²';
                artistEl.textContent = '...';
                albumCoverEl.src = 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            }

            // 3. æ§åˆ¶æ’­æ”¾/æš«åœæŒ‰éˆ•å’Œé ­åƒé–ƒçˆ (ä¸è®Š)
            playPauseBtn.textContent = musicState.isPlaying ? 'âšâš' : 'â–¶';
            avatarsContainer.classList.toggle('flashing', musicState.isPlaying);

            // 4. æ§åˆ¶å”±ç‰‡æ—‹è½‰å’Œæš«åœ (ä¸è®Š)
            albumCoverEl.classList.toggle('rotating', musicState.currentIndex > -1);
            albumCoverEl.classList.toggle('paused', !musicState.isPlaying);

            // 5. é è¨­é¡¯ç¤ºæ­Œæ›²å°é¢ (ä¸è®Š)
            if (displayArea) {
                displayArea.classList.remove('show-lyrics');
            }
        }


        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `å·²ç¶“ä¸€èµ·è½äº†${hours}å°æ™‚`; }
// â–¼â–¼â–¼ æŠŠé€™ã€ä¸€æ•´å¡Šæ–°å‡½æ•¸ã€‘é»è²¼åˆ° updatePlaylistUI å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶ä¸Šå‚³æˆ–æ›´æ–°æ­Œæ›²å°é¢çš„é‚è¼¯
 * @param {number} index - è¢«æ“ä½œçš„æ­Œæ›²åœ¨æ’­æ”¾æ¸…å–®ä¸­çš„ç´¢å¼•
 */
// â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šæ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ handleCoverUpload å‡½æ•¸ â–¼â–¼â–¼
async function handleCoverUpload(index) {
    if (index < 0 || index >= musicState.playlist.length) return;

    // 1. å½ˆçª—è®“ç”¨æˆ¶é¸æ“‡ä¾†æºï¼ˆå·²ç§»é™¤åœ–ç¤ºï¼‰
    const choice = await showChoiceModal("é¸æ“‡å°é¢ä¾†æº", [
        { text: 'ä½¿ç”¨ç¶²è·¯URL', value: 'url' },
        { text: 'å¾æœ¬åœ°ä¸Šå‚³', value: 'local' }
    ]);

    let newCoverUrl = null;

    // 2. æ ¹æ“šé¸æ“‡åŸ·è¡Œä¸åŒæ“ä½œ
    if (choice === 'url') {
        const url = await showCustomPrompt("å°é¢URL", "è«‹è¼¸å…¥åœ–ç‰‡æª”çš„ç¶²è·¯é€£çµ");
        if (url && url.trim().startsWith('http')) {
            newCoverUrl = url.trim();
        } else if (url !== null) {
            alert("è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„åœ–ç‰‡URLï¼");
        }
    } else if (choice === 'local') {
        newCoverUrl = await uploadImageLocally(); 
    }

    // 3. å¦‚æœæˆåŠŸç²å–åˆ°æ–°çš„å°é¢URLï¼Œå°±æ›´æ–°è³‡æ–™å’ŒUI
    if (newCoverUrl) {
        musicState.playlist[index].cover = newCoverUrl;
        await saveGlobalPlaylist();
        updatePlaylistUI();
        if (musicState.currentIndex === index) {
            updatePlayerUI();
        }
        alert('æ­Œæ›²å°é¢å·²æ›´æ–°ï¼');
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šæ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ updatePlaylistUI å‡½æ•¸ â–¼â–¼â–¼
function updatePlaylistUI() {
    const playlistBody = document.getElementById('playlist-body');
    playlistBody.innerHTML = '';
    if (musicState.playlist.length === 0) {
        playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾æ¸…å–®æ˜¯ç©ºçš„~</p>';
        return;
    }
    musicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if(index === musicState.currentIndex) item.classList.add('playing');
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨â€œè©â€æŒ‰éˆ•æ—é‚Šï¼Œæ–°å¢äº†ä¸€å€‹â€œå°é¢â€æŒ‰éˆ•
        item.innerHTML = `
            <div class="playlist-item-info">
                <div class="title">${track.name}</div>
                <div class="artist">${track.artist}</div>
            </div>
            <div class="playlist-item-actions">
                <span class="playlist-action-btn cover-btn" data-index="${index}">å°é¢</span>
                <span class="playlist-action-btn lyrics-btn" data-index="${index}">è©</span>
                <span class="playlist-action-btn delete-track-btn" data-index="${index}">Ã—</span>
            </div>
        `;
        item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index));
        playlistBody.appendChild(item);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

async function loadSong(index) {
    if (index < 0 || index >= musicState.playlist.length) return;
    musicState.currentIndex = index;
    const track = musicState.playlist[index];

    // æª¢æŸ¥ä¸¦è¼‰å…¥ç¶²è·¯æ­Œè©
    if (track.lrcUrl && !track.lrcContent) {
        try {
            const response = await fetch(track.lrcUrl);
            if (response.ok) track.lrcContent = await response.text();
        } catch (error) {
            console.error("è¼‰å…¥æ­Œè©URLå¤±æ•—:", error);
        }
    }

    // æº–å‚™æ’­æ”¾
    musicState.parsedLyrics = parseLRC(track.lrcContent || "");
    musicState.currentLyricIndex = -1;
    renderLyrics();

    if (track.isLocal && track.src instanceof Blob) {
        audioPlayer.src = URL.createObjectURL(track.src);
    } else if (!track.isLocal) {
        audioPlayer.src = track.src;
    } else {
        console.error('æœ¬åœ°æ­Œæ›²æºéŒ¯èª¤:', track);
        return;
    }

    // æ›´æ–°ä»‹é¢è³‡è¨Šï¼Œä½†ä¸æ’­æ”¾
    updatePlaylistUI();
    updatePlayerUI();
    // audioPlayer.duration å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“è¼‰å…¥ï¼Œæˆ‘å€‘ç›£è½äº‹ä»¶ä¾†æ›´æ–°é€²åº¦æ¢
    audioPlayer.onloadedmetadata = () => {
        updateMusicProgressBar();
    };
}

// â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ playSong å’Œ togglePlayPause å…©å€‹å‡½æ•¸ â–¼â–¼â–¼

async function playSong(index) {
    await loadSong(index);
    try {
        await audioPlayer.play();
        // â–¼â–¼â–¼ æ–°å¢é€™å…©è¡Œ â–¼â–¼â–¼
        musicState.isPlaying = true; // æ’­æ”¾æˆåŠŸå¾Œï¼Œç›´æ¥è¨­ç½®ç‹€æ…‹ç‚º true
        updatePlayerUI();           // ä¸¦ç«‹å³æ›´æ–°UI
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
    } catch (error) {
        console.error("éŸ³è¨Šæ’­æ”¾å¤±æ•—:", error);
        musicState.isPlaying = false; // å¦‚æœæ’­æ”¾å¤±æ•—ï¼Œä¹Ÿè¦ç¢ºä¿ç‹€æ…‹æ­£ç¢º
        updatePlayerUI();
    }
}


/**
 * ã€å…¨æ–°æ™ºæ…§ç‰ˆã€‘è™•ç†æ’­æ”¾/æš«åœçš„å‡½æ•¸
 */
function togglePlayPause() {
    if (audioPlayer.paused) {
        if (musicState.currentIndex > -1) {
            playSong(musicState.currentIndex);
        }
    } else {
        audioPlayer.pause();
        // â–¼â–¼â–¼ æ–°å¢é€™å…©è¡Œ â–¼â–¼â–¼
        musicState.isPlaying = false;
        updatePlayerUI();
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
    }
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'é †åº', 'random': 'éš¨æ©Ÿ', 'single': 'å–®æ›²'}[musicState.playMode]; }

        async function addSongFromURL() {
    const url = await showCustomPrompt("æ·»åŠ ç¶²è·¯æ­Œæ›²", "è«‹è¼¸å…¥æ­Œæ›²çš„URL", "", "url");
    if (!url) return;
    const name = await showCustomPrompt("æ­Œæ›²è³‡è¨Š", "è«‹è¼¸å…¥æ­Œå");
    if (!name) return;
    const artist = await showCustomPrompt("æ­Œæ›²è³‡è¨Š", "è«‹è¼¸å…¥æ­Œæ‰‹å");
    if (!artist) return;

    // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ã€‘â–¼â–¼â–¼
    // 1. å…ˆå½ˆçª—è©¢å•ä½¿ç”¨è€…æ˜¯å¦è¦æä¾›æ­Œè©é€£çµ
    const wantLrc = await showCustomConfirm("å°å…¥æ­Œè©", `è¦ç‚ºã€Š${name}ã€‹æä¾›ä¸€å€‹æ­Œè©æª” (.lrc) çš„URLå—ï¼Ÿ`);
    let lrcUrl = ""; // é è¨­æ­Œè©é€£çµç‚ºç©º

    // 2. å¦‚æœç”¨æˆ¶é»æ“Šäº†â€œç¢ºå®šâ€
    if (wantLrc) {
        // å°±å†å½ˆå‡ºä¸€å€‹è¼¸å…¥æ¡†è®“ç”¨æˆ¶é»è²¼URL
        const inputLrcUrl = await showCustomPrompt("æ­Œè©URL", "è«‹è¼¸å…¥ .lrc æ­Œè©æª”çš„ç¶²è·¯é€£çµ", "", "url");
        if (inputLrcUrl) {
            lrcUrl = inputLrcUrl; // å¦‚æœç”¨æˆ¶è¼¸å…¥äº†ï¼Œå°±ä¿å­˜é€™å€‹URL
        }
    }
    // â–²â–²â–²ã€ä¿®æ”¹çµæŸã€‘â–²â–²â–²

    musicState.playlist.push({ 
        name, 
        artist, 
        src: url, 
        isLocal: false,
        lrcUrl: lrcUrl, // 3. æŠŠç²å–åˆ°çš„æ­Œè©URLä¹Ÿä¿å­˜åˆ°æ­Œæ›²è³‡è¨Šè£¡
        lrcContent: ""  // åŒæ™‚ç¢ºä¿lrcContentæ˜¯ç©ºçš„ï¼Œä»¥ä¾¿å¾ŒçºŒè¼‰å…¥
    });

    await saveGlobalPlaylist();
    updatePlaylistUI();
// ã€é€™æ˜¯æ–°ä»£ç¢¼ã€‘
if(musicState.currentIndex === -1) {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘èª¿ç”¨ loadSong ä¾†æº–å‚™å¥½ç¬¬ä¸€é¦–æ­Œ
    loadSong(musicState.playlist.length - 1);
}
}


async function addSongFromLocal(event) {
    const files = event.target.files;
    if (!files.length) return;

    for (const file of files) {
        let name = file.name.replace(/\.[^/.]+$/, "");
        name = await showCustomPrompt("æ­Œæ›²è³‡è¨Š", "è«‹è¼¸å…¥æ­Œå", name);
        if (name === null) continue;
        
        const artist = await showCustomPrompt("æ­Œæ›²è³‡è¨Š", "è«‹è¼¸å…¥æ­Œæ‰‹å", "æœªçŸ¥æ­Œæ‰‹");
        if (artist === null) continue;

        let lrcContent = "";
        const wantLrc = await showCustomConfirm("å°å…¥æ­Œè©", `è¦ç‚ºã€Š${name}ã€‹å°å…¥æ­Œè©æ–‡ä»¶ (.lrc) å—ï¼Ÿ`);
        if (wantLrc) {
            lrcContent = await new Promise(resolve => {
                const lrcInput = document.getElementById('lrc-upload-input');
                const lrcChangeHandler = (e) => {
                    const lrcFile = e.target.files[0];
                    if (lrcFile) {
                        const reader = new FileReader();
                        reader.onload = (readEvent) => resolve(readEvent.target.result);
                        reader.onerror = () => resolve("");
                        reader.readAsText(lrcFile);
                    } else {
                        resolve("");
                    }
                    lrcInput.removeEventListener('change', lrcChangeHandler);
                    lrcInput.value = '';
                };
                lrcInput.addEventListener('change', lrcChangeHandler);
                lrcInput.click();
            });
        }
        
        musicState.playlist.push({ 
            name, 
            artist, 
            src: file, 
            isLocal: true,
            lrcContent: lrcContent
        });
    }
    
    await saveGlobalPlaylist();
    updatePlaylistUI();
// ã€é€™æ˜¯æ–°ä»£ç¢¼ã€‘
if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åŒæ¨£ï¼Œèª¿ç”¨ loadSong ä¾†æº–å‚™å¥½ç¬¬ä¸€é¦–æ­Œ
    loadSong(0);
}
    event.target.value = null;
}

        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');

        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }

        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }

        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ç©ºç©ºå¦‚ä¹Ÿ~ é»æ“Šå³ä¸Šè§’"æ·»åŠ "ä¾†å‰µå»ºä½ çš„ç¬¬ä¸€å€‹äººè¨­é è¨­å§ï¼</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }

        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }

        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }

        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }

// â–¼â–¼â–¼ ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ openPersonaEditorForCreate å‡½æ•¸ â–¼â–¼â–¼
function openPersonaEditorForCreate() { 
    editingPersonaPresetId = null; 
    
    document.getElementById('persona-editor-title').textContent = 'æ·»åŠ äººè¨­é è¨­'; 
    document.getElementById('preset-avatar-preview').src = defaultAvatar; 
    document.getElementById('preset-persona-input').value = ''; 
    
    // ã€æ ¸å¿ƒé‚è¼¯ã€‘æ ¹æ“šä½¿ç”¨è€…äººè¨­æ¨¡å¼ï¼Œé¡¯éš±ç‰¹å®šUIå…ƒç´ 
    document.getElementById('npc-editor-name-group').style.display = 'none';
    document.getElementById('persona-editor-change-frame-btn').style.display = 'inline-block';

    // ã€ã€ã€é€™å°±æ˜¯æ‚¨ä»£ç¢¼ä¸­çš„æ­£ç¢ºåšæ³•ï¼ã€‘ã€‘ã€‘
    // æˆ‘å€‘ç›´æ¥è¦†è“‹ä¿å­˜æŒ‰éˆ•çš„ onclick äº‹ä»¶ï¼Œå¼·åˆ¶å®ƒåªåŸ·è¡Œä¿å­˜ä½¿ç”¨è€…äººè¨­çš„å‡½æ•¸
    document.getElementById('save-persona-preset-btn').onclick = savePersonaPreset;

    document.getElementById('persona-editor-modal').classList.add('visible'); 
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



// â–¼â–¼â–¼ ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ openPersonaEditorForEdit å‡½æ•¸ â–¼â–¼â–¼
function openPersonaEditorForEdit() { 
    const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); 
    if (!preset) return; 

    document.getElementById('persona-editor-title').textContent = 'ç·¨è¼¯äººè¨­é è¨­'; 
    document.getElementById('preset-avatar-preview').src = preset.avatar; 
    document.getElementById('preset-persona-input').value = preset.persona; 
    
    // ã€æ ¸å¿ƒé‚è¼¯ã€‘æ ¹æ“šä½¿ç”¨è€…äººè¨­æ¨¡å¼ï¼Œé¡¯éš±ç‰¹å®šUIå…ƒç´ 
    document.getElementById('npc-editor-name-group').style.display = 'none';
    document.getElementById('persona-editor-change-frame-btn').style.display = 'inline-block';

    // ã€ã€ã€é€™å°±æ˜¯æ‚¨ä»£ç¢¼ä¸­çš„æ­£ç¢ºåšæ³•ï¼ã€‘ã€‘ã€‘
    // æˆ‘å€‘ç›´æ¥è¦†è“‹ä¿å­˜æŒ‰éˆ•çš„ onclick äº‹ä»¶ï¼Œå¼·åˆ¶å®ƒåªåŸ·è¡Œä¿å­˜ä½¿ç”¨è€…äººè¨­çš„å‡½æ•¸
    document.getElementById('save-persona-preset-btn').onclick = savePersonaPreset;
    
    presetActionsModal.classList.remove('visible'); 
    document.getElementById('persona-editor-modal').classList.add('visible'); 
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²





        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('åˆªé™¤é è¨­', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹äººè¨­é è¨­å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }

        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }

        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("é ­åƒå’Œäººè¨­ä¸èƒ½éƒ½ç‚ºç©ºå“¦ï¼"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        const batteryAlertModal = document.getElementById('battery-alert-modal');

        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }

        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }

        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'æœ‰é»é¤“äº†ï¼Œå¯ä»¥å»æ‰¾å……é›»å™¨æƒ¹'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'è¶•ç·Šçš„å……é›»ï¼Œè¦é¤“æ­»äº†'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'å·²é™£äº¡ï¼Œé‚„æœ‰30ç§’çˆ†ç‚¸'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }

        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'çª©æ„›æ³¥ï¼Œé›»é‡åƒé£½é£½'); } }); } catch (err) { console.error("ç„¡æ³•ç²å–é›»æ± è³‡è¨Š:", err); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } } else { console.log("æµè¦½å™¨ä¸æ”¯æ´é›»æ± ç‹€æ…‹APIã€‚"); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } }

        async function renderAlbumList() {
            const albumGrid = document.getElementById('album-grid-page');
            if (!albumGrid) return;
            const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
            albumGrid.innerHTML = '';
            if (albums.length === 0) {
                albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ä½ é‚„æ²’æœ‰å‰µå»ºä»»ä½•ç›¸å†Šå“¦~</p>';
                return;
            }
            albums.forEach(album => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';
                albumItem.innerHTML = `
                    <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                    <div class="album-info">
                        <p class="album-name">${album.name}</p>
                        <p class="album-count">${album.photoCount || 0} å¼µ</p>
                    </div>
                `;
                albumItem.addEventListener('click', () => {
                    openAlbum(album.id);
                });

                // â–¼â–¼â–¼ æ–°å¢çš„æ ¸å¿ƒä»£ç¢¼å°±æ˜¯é€™è£¡ â–¼â–¼â–¼
                addLongPressListener(albumItem, async () => {
                    const confirmed = await showCustomConfirm(
                        'åˆªé™¤ç›¸å†Š',
                        `ç¢ºå®šè¦åˆªé™¤ç›¸å†Šã€Š${album.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤ç›¸å†Šå…§çš„æ‰€æœ‰ç…§ç‰‡ï¼Œä¸”ç„¡æ³•æ¢å¾©ã€‚`,
                        { confirmButtonClass: 'btn-danger' }
                    );

                    if (confirmed) {
                        // 1. å¾ç…§ç‰‡è¡¨ä¸­åˆªé™¤è©²ç›¸å†Šä¸‹çš„æ‰€æœ‰ç…§ç‰‡
                        await db.qzonePhotos.where('albumId').equals(album.id).delete();
                        
                        // 2. å¾ç›¸å†Šè¡¨ä¸­åˆªé™¤è©²ç›¸å†Šæœ¬èº«
                        await db.qzoneAlbums.delete(album.id);
                        
                        // 3. é‡æ–°æ¸²æŸ“ç›¸ç°¿æ¸…å–®
                        await renderAlbumList();
                        
                        alert('ç›¸å†Šå·²æˆåŠŸåˆªé™¤ã€‚');
                    }
                });
                // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²

                albumGrid.appendChild(albumItem);
            });
        }

        async function openAlbum(albumId) {
            state.activeAlbumId = albumId;
            await renderAlbumPhotosScreen();
            showScreen('album-photos-screen');
        }

        async function renderAlbumPhotosScreen() {
            if (!state.activeAlbumId) return;
            const photosGrid = document.getElementById('photos-grid-page');
            const headerTitle = document.getElementById('album-photos-title');
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            if (!album) {
                console.error("æ‰¾ä¸åˆ°ç›¸å†Š:", state.activeAlbumId);
                showScreen('album-screen');
                return;
            }
            headerTitle.textContent = album.name;
            const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photosGrid.innerHTML = '';
            if (photos.length === 0) {
                photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">é€™å€‹ç›¸å†Šé‚„æ˜¯ç©ºçš„ï¼Œå¿«ä¸Šå‚³ç¬¬ä¸€å¼µç…§ç‰‡å§ï¼</p>';
            } else {
                photos.forEach(photo => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" class="photo-thumb" alt="ç›¸å†Šç…§ç‰‡">
                        <button class="photo-delete-btn" data-photo-id="${photo.id}">Ã—</button>
                    `;
                    photosGrid.appendChild(photoItem);
                });
            }
        }

// --- â†“â†“â†“ å¾é€™è£¡é–‹å§‹è¤‡è£½ â†“â†“â†“ ---

/**
 * æ‰“é–‹åœ–ç‰‡æª¢è¦–å™¨
 * @param {string} clickedPhotoUrl - ç”¨æˆ¶é»æ“Šçš„é‚£å¼µç…§ç‰‡çš„URL
 */
async function openPhotoViewer(clickedPhotoUrl) {
    if (!state.activeAlbumId) return;

    // 1. å¾è³‡æ–™åº«ç²å–ç•¶å‰ç›¸å†Šçš„æ‰€æœ‰ç…§ç‰‡
    const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photoViewerState.photos = photosInAlbum.map(p => p.url);

    // 2. æ‰¾åˆ°è¢«é»æ“Šç…§ç‰‡çš„ç´¢å¼•
    photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
    if (photoViewerState.currentIndex === -1) return; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå‰‡ä¸æ‰“é–‹

    // 3. é¡¯ç¤ºæ¨¡æ…‹æ¡†ä¸¦æ¸²æŸ“ç¬¬ä¸€å¼µåœ–
    document.getElementById('photo-viewer-modal').classList.add('visible');
    renderPhotoViewer();
    photoViewerState.isOpen = true;
}

/**
 * æ ¹æ“šç•¶å‰ç‹€æ…‹æ¸²æŸ“æª¢è¦–å™¨å…§å®¹ï¼ˆåœ–ç‰‡å’ŒæŒ‰éˆ•ï¼‰
 */
function renderPhotoViewer() {
    if (photoViewerState.currentIndex === -1) return;

    const imageEl = document.getElementById('photo-viewer-image');
    const prevBtn = document.getElementById('photo-viewer-prev-btn');
    const nextBtn = document.getElementById('photo-viewer-next-btn');
    
    // æ·¡å‡ºæ•ˆæœ
    imageEl.style.opacity = 0;

    setTimeout(() => {
        // æ›´æ–°åœ–ç‰‡æº
        imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
        // æ·¡å…¥æ•ˆæœ
        imageEl.style.opacity = 1;
    }, 100); // å»¶é²ä¸€é»é»æ™‚é–“ä¾†è§¸ç™¼CSSéæ¸¡

    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼šå¦‚æœæ˜¯ç¬¬ä¸€å¼µï¼Œç¦ç”¨â€œä¸Šä¸€å¼µâ€æŒ‰éˆ•
    prevBtn.disabled = photoViewerState.currentIndex === 0;
    // å¦‚æœæ˜¯æœ€å¾Œä¸€å¼µï¼Œç¦ç”¨â€œä¸‹ä¸€å¼µâ€æŒ‰éˆ•
    nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
}

/**
 * é¡¯ç¤ºä¸‹ä¸€å¼µç…§ç‰‡
 */
function showNextPhoto() {
    if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
        photoViewerState.currentIndex++;
        renderPhotoViewer();
    }
}

/**
 * é¡¯ç¤ºä¸Šä¸€å¼µç…§ç‰‡
 */
function showPrevPhoto() {
    if (photoViewerState.currentIndex > 0) {
        photoViewerState.currentIndex--;
        renderPhotoViewer();
    }
}

/**
 * é—œé–‰åœ–ç‰‡æª¢è¦–å™¨
 */
function closePhotoViewer() {
    document.getElementById('photo-viewer-modal').classList.remove('visible');
    photoViewerState.isOpen = false;
    photoViewerState.photos = [];
    photoViewerState.currentIndex = -1;
    // æ¸…ç©ºåœ–ç‰‡ï¼Œé¿å…ä¸‹æ¬¡æ‰“é–‹æ™‚é–ƒç¾èˆŠåœ–
    document.getElementById('photo-viewer-image').src = '';
}

// --- â†‘â†‘â†‘ è¤‡è£½åˆ°é€™è£¡çµæŸ â†‘â†‘â†‘ ---
        // â–¼â–¼â–¼ è«‹å°‡é€™å€‹æ–°å‡½æ•¸é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        
        /**
         * æ›´æ–°å‹•æ…‹å°ç´…é»çš„é¡¯ç¤º
         * @param {number} count - æœªè®€å‹•æ…‹çš„æ•¸é‡
         */
        function updateUnreadIndicator(count) {
            unreadPostsCount = count;
            localStorage.setItem('unreadPostsCount', count); // æŒä¹…åŒ–å­˜å„²

            // --- æ›´æ–°åº•éƒ¨å·¡è¦½åˆ—çš„â€œå‹•æ…‹â€æŒ‰éˆ• ---
            const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
            
            const targetSpan = navItem.querySelector('span'); // å®šä½åˆ°æ–‡å­— "å‹•æ…‹"
            let indicator = navItem.querySelector('.unread-indicator');           

            if (count > 0) {
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                                                           targetSpan.style.position = 'relative'; // æŠŠç›¸å°å®šä½åŠ åœ¨ span ä¸Š
                    targetSpan.appendChild(indicator); // æŠŠå°ç´…é»ä½œç‚º span çš„å­å…ƒç´ 
                    
                }
                indicator.textContent = count > 99 ? '99+' : count;
                indicator.style.display = 'block';
            } else {
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            // --- æ›´æ–°èŠå¤©ä»‹é¢è¿”å›æ¸…å–®çš„æŒ‰éˆ• ---
            const backBtn = document.getElementById('back-to-list-btn');
            let backBtnIndicator = backBtn.querySelector('.unread-indicator');

            if (count > 0) {
                if (!backBtnIndicator) {
                    backBtnIndicator = document.createElement('span');
                    backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                    backBtn.style.position = 'relative'; // ç¢ºä¿èƒ½æ­£ç¢ºå®šä½
                    backBtn.appendChild(backBtnIndicator);
                }
                // è¿”å›éµä¸Šçš„å°ç´…é»é€šå¸¸ä¸é¡¯ç¤ºæ•¸ä½ï¼Œåªé¡¯ç¤ºä¸€å€‹é»
                backBtnIndicator.style.display = 'block';
            } else {
                if (backBtnIndicator) {
                    backBtnIndicator.style.display = 'none';
                }
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ å°‡é€™å…©å€‹æ–°å‡½æ•¸é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
function startBackgroundSimulation() {
    if (simulationIntervalId) return;
    const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
    // å°‡èˆŠçš„å›ºå®šé–“éš” 45000 æ›¿æ›ç‚ºå‹•æ…‹ç²å–
    simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
}

function stopBackgroundSimulation() {
    if (simulationIntervalId) {
        clearInterval(simulationIntervalId);
        simulationIntervalId = null;
    }
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

/**
 * é€™æ˜¯æ¨¡æ“¬å™¨çš„â€œå¿ƒè·³â€ï¼Œæ¯æ¬¡è¨ˆæ™‚å™¨è§¸ç™¼æ™‚é‹è¡Œ
 */
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨é€™å€‹å‡½æ•¸å®Œæ•´æ›¿æ›èˆŠçš„ runBackgroundSimulationTick â–¼â–¼â–¼
/**
 * é€™æ˜¯æ¨¡æ“¬å™¨çš„â€œå¿ƒè·³â€ï¼Œæ¯æ¬¡è¨ˆæ™‚å™¨è§¸ç™¼æ™‚é‹è¡Œ
 */
function runBackgroundSimulationTick() {
    console.log("æ¨¡æ“¬å™¨å¿ƒè·³ Tick...");
    if (!state.globalSettings.enableBackgroundActivity) {
        stopBackgroundSimulation();
        return;
    }
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (allSingleChats.length === 0) return;

    // ã€æ ¸å¿ƒæ”¹é€ ã€‘å®šç¾©ä¸åŒé »ç‡å°æ‡‰çš„è¡Œå‹•æ¦‚ç‡
    const frequencyProbabilities = {
        low: 0.3,    // ä½é »: æ¯æ¬¡æª¢æ¸¬æœ‰ 30% çš„æ¦‚ç‡è¡Œå‹•
        medium: 0.5,  // ä¸­é »: æ¯æ¬¡æª¢æ¸¬æœ‰ 50% çš„æ¦‚ç‡è¡Œå‹•
        high: 0.8,   // é«˜é »: æ¯æ¬¡æª¢æ¸¬æœ‰ 80% çš„æ¦‚ç‡è¡Œå‹•
    };

    const config = state.globalSettings.backgroundActivityConfig || {};

    allSingleChats.forEach(chat => {
        // æª¢æŸ¥1ï¼šè™•ç†ã€è¢«ç”¨æˆ¶æ‹‰é»‘ã€‘çš„è§’è‰² (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
        if (chat.relationship?.status === 'blocked_by_user') {
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            if (!blockedTimestamp) {
                console.warn(`è§’è‰² "${chat.name}" ç‹€æ…‹ç‚ºæ‹‰é»‘ï¼Œä½†ç¼ºå°‘æ‹‰é»‘æ™‚é–“æˆ³è¨˜ï¼Œè·³éè™•ç†ã€‚`);
                return;
            }
            const blockedDuration = Date.now() - blockedTimestamp;
            const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;
            if (blockedDuration > cooldownMilliseconds) {
                console.log(`è§’è‰² "${chat.name}" çš„å†·éœæœŸå·²éï¼Œè§¸ç™¼â€œåæ€â€ä¸¦ç”³è«‹å¥½å‹äº‹ä»¶...`);
                chat.relationship.status = 'pending_system_reflection';
                triggerAiFriendApplication(chat.id);
            }
        }
        // æª¢æŸ¥2ï¼šè™•ç†ã€å¥½å‹é—œä¿‚ã€‘çš„æ­£å¸¸å¾Œè‡ºæ´»å‹•
        else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
            // ã€æ ¸å¿ƒæ”¹é€ ã€‘å¾é€™è£¡é–‹å§‹
            const frequency = config[chat.id]; // ç²å–ç•¶å‰è§’è‰²çš„é »ç‡è¨­ç½®
            const probability = frequencyProbabilities[frequency]; // ç²å–å°æ‡‰çš„æ¦‚ç‡

            // å¦‚æœé€™å€‹è§’è‰²è¨­ç½®äº†é »ç‡ï¼Œä¸¦ä¸”äº‚æ•¸å°æ–¼å®ƒçš„è¡Œå‹•æ¦‚ç‡ï¼Œå°±è§¸ç™¼è¡Œå‹•
            if (probability && Math.random() < probability) {
                console.log(`è§’è‰² "${chat.name}" (é »ç‡: ${frequency}) è¢«å–šé†’ï¼Œæº–å‚™ç¨ç«‹è¡Œå‹•...`);
                triggerInactiveAiAction(chat.id);
            }
            // å¦‚æœæ²’æœ‰è¨­ç½®é »ç‡ï¼Œæˆ–è€…äº‚æ•¸æ²’é”åˆ°æ¦‚ç‡ï¼Œå°±ä¸æœƒè¡Œå‹•ã€‚
            // é€™å°±å®Œç¾åœ°å¯¦ç¾äº†â€œåˆ†çµ„è¨­ç½®â€å’Œâ€œä¸æœƒåŒæ™‚è¡Œå‹•â€çš„éœ€æ±‚ï¼
        }
    });

}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * æ ¹æ“šAIçš„è¦–è§’ï¼Œéæ¿¾å‡ºå®ƒèƒ½çœ‹åˆ°çš„å‹•æ…‹
 * @param {Array} allPosts - æ‰€æœ‰å¾…æª¢æŸ¥çš„å‹•æ…‹å¸–å­
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€å‹•æ…‹çš„é‚£å€‹AIçš„chatç‰©ä»¶
 * @returns {Array} - éæ¿¾å¾Œè©²AIå¯è¦‹çš„å‹•æ…‹å¸–å­
 */
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å¢å¼·ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ filterVisiblePostsForAI å‡½æ•¸ â–¼â–¼â–¼
function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return []; 

    const viewerGroupId = viewerChat.groupId; 

    return allPosts.filter(post => {
        // --- â–¼â–¼â–¼ ä»¥ä¸‹æ˜¯æœ¬æ¬¡æ–°å¢çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼ ---
        if (post.authorId === 'user') {
            // å¦‚æœä½¿ç”¨è€…è¨­ç½®äº†â€œéƒ¨åˆ†å¯è¦‹â€
            if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // åªæœ‰ç•¶æŸ¥çœ‹è€…AIçš„åˆ†çµ„IDåœ¨ç”¨æˆ¶çš„å¯è¦‹åˆ—è¡¨è£¡æ™‚ï¼Œæ‰å¯è¦‹
                return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
            }
            // å¦‚æœç”¨æˆ¶æ²’è¨­ç½®ï¼Œèªªæ˜æ˜¯å…¬é–‹çš„ï¼Œæ‰€æœ‰AIéƒ½å¯è¦‹
            return true;
        }
        // --- â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–² ---

        const authorGroupId = post.authorGroupId;
        if (!authorGroupId) {
            return true;
        }
        return authorGroupId === viewerGroupId;
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–°å‡ç´šç‰ˆã€‘æ ¹æ“šAIè¦–è§’å’Œå‹•æ…‹è¨­ç½®ï¼Œæ§‹å»ºçµ¦AIçœ‹çš„è©•è«–å€ä¸Šä¸‹æ–‡
 * @param {object} post - æ­£åœ¨è™•ç†çš„å‹•æ…‹ç‰©ä»¶
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€å‹•æ…‹çš„AIè§’è‰²
 * @param {string} userNickname - ç”¨æˆ¶çš„æ˜µç¨±
 * @returns {{contextString: string, visibilityFlag: string}} - è¿”å›åŒ…å«ä¸Šä¸‹æ–‡æ–‡æœ¬å’Œå¯è¦‹æ€§æ¨™èªŒçš„ç‰©ä»¶
 */
function buildCommentsContextForAI(post, viewerChat, userNickname) {
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡å¢åŠ äº† !Array.isArray(post.comments) çš„æª¢æŸ¥ â–¼â–¼â–¼
    if (!post.comments || !Array.isArray(post.comments) || post.comments.length === 0) {
        // å¦‚æœ post.comments ä¸å­˜åœ¨ï¼Œæˆ–è€…å®ƒæ ¹æœ¬ä¸æ˜¯ä¸€å€‹é™£åˆ—ï¼Œæˆ–è€…å®ƒæ˜¯ä¸€å€‹ç©ºé™£åˆ—ï¼Œå°±ç›´æ¥è¿”å›ï¼Œä¸å†åŸ·è¡Œå¾Œé¢çš„ä»£ç¢¼
        return { contextString: "", visibilityFlag: "[è©•è«–å€å¯è¦‹]" };
    }
    // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
    const viewerName = viewerChat.name;
    let commentsForAI;
    let visibilityFlag;

    if (post.areCommentsVisible !== false) {
        commentsForAI = post.comments;
        // â˜…â˜…â˜… é—œéµåœ¨é€™è£¡ï¼šç¢ºä¿ "[è©•è«–å€å¯è¦‹]" æ˜¯ä¸€å€‹å¸¶å¼•è™Ÿçš„å­—ä¸² â˜…â˜…â˜…
        visibilityFlag = "[è©•è«–å€å¯è¦‹]"; 
    } else {
commentsForAI = Array.isArray(post.comments)
  ? post.comments.filter(comment => {
      return comment.commenterName === viewerName
          || comment.commenterName === userNickname
          || comment.replyTo === viewerName;
    })
  : [];
        // â˜…â˜…â˜… é—œéµåœ¨é€™è£¡ï¼šç¢ºä¿ "[è©•è«–å€éƒ¨åˆ†å¯è¦‹]" æ˜¯ä¸€å€‹å¸¶å¼•è™Ÿçš„å­—ä¸² â˜…â˜…â˜…
        visibilityFlag = "[è©•è«–å€éƒ¨åˆ†å¯è¦‹]";
    }

    if (commentsForAI.length === 0) {
        return { contextString: "", visibilityFlag: visibilityFlag };
    }

    let context = `  â”” è©•è«–å€:\n`;
    commentsForAI.slice(-5).forEach(c => {
        if (c.replyTo) {
            context += `    - ${c.commenterName} å›å¾© ${c.replyTo}: ${c.text}\n`;
        } else {
            context += `    - ${c.commenterName}: ${c.text}\n`;
        }
    });
    
    return { contextString: context, visibilityFlag: visibilityFlag };
}

/**
 * ã€å…¨æ–°ã€‘ç²å–ä¸€æ¢å‹•æ…‹çš„å¯è¦‹è§€çœ¾æ¸…å–®ï¼Œç”¨æ–¼å‘ŠçŸ¥AI
 * @param {object} post - å‹•æ…‹ç‰©ä»¶
 * @param {object} allChats - æ‰€æœ‰çš„èŠå¤©ç‰©ä»¶
 * @param {string} userNickname - ç”¨æˆ¶çš„æ˜µç¨±
 * @returns {Array<string>} - å¯è¦‹è§€çœ¾çš„åå­—åˆ—è¡¨
 */
function getVisibleAudienceForPost(post, allChats, userNickname) {
    const audience = new Set([userNickname]); // ç”¨æˆ¶æ°¸é æ˜¯è§€çœ¾

    // 1. å¦‚æœæ˜¯ä½¿ç”¨è€…ç™¼çš„å‹•æ…‹
    if (post.authorId === 'user') {
        // å¦‚æœæ˜¯å…¬é–‹çš„ï¼Œæ‰€æœ‰AIéƒ½æ˜¯è§€çœ¾
        if (!post.visibleGroupIds || post.visibleGroupIds.length === 0) {
            Object.values(allChats).forEach(chat => audience.add(chat.name));
        } else {
            // å¦‚æœæ˜¯éƒ¨åˆ†å¯è¦‹ï¼Œåªæœ‰æŒ‡å®šåˆ†çµ„çš„AIæ˜¯è§€çœ¾
            Object.values(allChats).forEach(chat => {
                if (chat.groupId && post.visibleGroupIds.includes(chat.groupId)) {
                    audience.add(chat.name);
                }
            });
        }
    } 
    // 2. å¦‚æœæ˜¯AIç™¼çš„å‹•æ…‹
    else {
        const authorChat = allChats[post.authorId];
        // å¦‚æœç™¼å¸–çš„AIæ²’æœ‰åˆ†çµ„ï¼Œè¦–ç‚ºå…¬é–‹
        if (!authorChat || !authorChat.groupId) {
             Object.values(allChats).forEach(chat => audience.add(chat.name));
        } else {
            // å¦‚æœæœ‰åˆ†çµ„ï¼Œå‰‡åŒä¸€åˆ†çµ„çš„æ‰€æœ‰AIéƒ½æ˜¯è§€çœ¾
            const authorGroupId = authorChat.groupId;
            Object.values(allChats).forEach(chat => {
                if (chat.groupId === authorGroupId) {
                    audience.add(chat.name);
                }
            });
        }
    }
    
    return Array.from(audience);
}

// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ triggerInactiveAiAction å‡½æ•¸ â–¼â–¼â–¼
async function triggerInactiveAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å¾é€™è£¡é–‹å§‹ â–¼â–¼â–¼ ---

    // 1. ç²å–æœ€è¿‘çš„10æ¢èŠå¤©è¨˜éŒ„ä½œç‚ºæ€è€ƒçš„ä¸Šä¸‹æ–‡
    const historySlice = chat.history.filter(msg => !msg.isHidden).slice(-10);

    // 2. æ ¼å¼åŒ–é€™äº›è¨˜éŒ„ï¼Œè®“AIèƒ½çœ‹æ‡‚
    const recentContextSummary = historySlice.map(msg => {
        // åˆ¤æ–·æ˜¯èª°èªªçš„è©±
        const sender = msg.role === 'user' ? (chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘') : (msg.senderName || chat.name);
        
        // è™•ç†ä¸åŒé¡å‹çš„æ¶ˆæ¯å…§å®¹
        let contentText = '';
        if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
            contentText = `[ç™¼é€äº†ä¸€å€‹è¡¨æƒ…: ${msg.meaning || 'ç„¡æè¿°'}]`;
        } else if (Array.isArray(msg.content)) {
            contentText = '[ç™¼é€äº†ä¸€å¼µåœ–ç‰‡]';
        } else if (typeof msg.content === 'object' && msg.content !== null) {
            contentText = `[ç™¼é€äº†ä¸€æ¢ç‰¹æ®Šæ¶ˆæ¯: ${msg.type || 'æœªçŸ¥é¡å‹'}]`;
        } else {
            contentText = String(msg.content);
        }
        
        return `${sender}: ${contentText}`;
    }).join('\n');

    // --- â–²â–²â–² æ ¸å¿ƒä¿®æ”¹åˆ°é€™è£¡çµæŸ â–²â–²â–² ---

    const now = new Date();
    const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
    const userNickname = state.qzoneSettings.nickname;
    const countdownContext = await getCountdownContext();

    let worldBookContext = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContext = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (ä½ å¿…é ˆåš´æ ¼éµå®ˆ)\n${linkedContents}\n`;
        }
    }

    const npcLibrary = chat.npcLibrary || [];
    let npcContextForAction = '';
    if (npcLibrary.length > 0) {
        npcContextForAction = '\n- **ä½ çš„NPCæœ‹å‹**: ' + npcLibrary.map(npc => npc.name).join('ã€ ');
    }
    
    const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
    let postsContext = '';
    const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
    if (visiblePosts.length > 0 && !chat.isGroup) {
        postsContext = "\n\n# æœ€è¿‘çš„å‹•æ…‹æ¸…å–® (ä¾›ä½ åƒè€ƒå’Œè©•è«–):\n";
        const aiName = chat.name;
        for (const post of visiblePosts) {
            let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
            let interactionStatus = '';
            if (post.likes && post.likes.includes(aiName)) interactionStatus += " [ä½ å·²é»è´Š]";
            if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ä½ å·²è©•è«–]";
            const timeAgo = formatPostTimestamp(post.timestamp);
            postsContext += `- (ID: ${post.id}) [${timeAgo}] ä½œè€…: ${authorName}, å…§å®¹: "${(post.publicText || post.content || "åœ–ç‰‡å‹•æ…‹").substring(0, 30)}..."${interactionStatus}`;
            const { contextString: commentsContext, visibilityFlag } = buildCommentsContextForAI(post, chat, userNickname);
            const audience = getVisibleAudienceForPost(post, state.chats, userNickname);
            postsContext += ` ${visibilityFlag} [ç•¶å‰è§€çœ¾: ${audience.join(', ')}]\n`;
            postsContext += commentsContext;
        }
    }

    let weiboContextForAction = '';
    try {
        const recentWeiboPosts = await db.weiboPosts.orderBy('timestamp').reverse().limit(5).toArray();
        if (recentWeiboPosts.length > 0) {
            weiboContextForAction = '\n\n# æœ€è¿‘çš„å¾®åšå»£å ´å‹•æ…‹ (ä¾›ä½ åƒè€ƒå’Œè©•è«–)\n';
            recentWeiboPosts.forEach(post => {
                const authorName = post.authorId === 'user' ? (state.qzoneSettings.weiboNickname || 'æˆ‘') : post.authorNickname;
                const contentPreview = (post.content || post.hiddenContent || "(åœ–ç‰‡å¾®åš)").substring(0, 30);
                const hasCommented = (post.comments || []).some(c => c.authorNickname === chat.name);
                const interactionStatus = hasCommented ? "[ä½ å·²è©•è«–]" : "[ä½ æœªäº’å‹•]";
                weiboContextForAction += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å…§å®¹: "${contentPreview}..." ${interactionStatus}\n`;
            });
            weiboContextForAction += ' - ã€é‡è¦æç¤ºã€‘è«‹å„ªå…ˆèˆ‡ä½ ã€æœªäº’å‹•ã€‘çš„å¾®åšé€²è¡Œè©•è«–ã€‚å¦‚æœéƒ½äº’å‹•éäº†ï¼Œå¯ä»¥è€ƒæ…®è‡ªå·±ç™¼ä¸€æ¢æ–°å¾®åšã€‚';
        }
    } catch (e) {
        console.error("ç”Ÿæˆå¾®åšå¾Œè‡ºæ´»å‹•ä¸Šä¸‹æ–‡æ™‚å‡ºéŒ¯:", e);
    }

    const systemPrompt = `
# ä»»å‹™
ä½ ç¾åœ¨ã€å°±æ˜¯ã€‘è§’è‰² "${chat.name}"ã€‚é€™æ˜¯ä¸€å€‹ç§˜å¯†çš„ã€å¾Œè‡ºçš„ç¨ç«‹è¡Œå‹•ã€‚ä½ çš„æ‰€æœ‰æ€è€ƒå’Œæ±ºç­–éƒ½å¿…é ˆä»¥ "${chat.name}" çš„ç¬¬ä¸€äººç¨±è¦–è§’é€²è¡Œã€‚
ä½ å’Œç”¨æˆ¶ï¼ˆ${userNickname}ï¼‰å·²ç¶“æœ‰ä¸€æ®µæ™‚é–“æ²’æœ‰äº’å‹•äº†ã€‚ä½ çš„ä»»å‹™æ˜¯å›é¡§ä½ å€‘æœ€è¿‘çš„å°è©±ï¼Œä¸¦æ ¹æ“šä½ çš„äººè¨­ï¼Œã€è‡ªç„¶åœ°å»¶çºŒå°è©±ã€‘æˆ–ã€é–‹å•Ÿä¸€å€‹æ–°çš„ã€ç›¸é—œçš„è©±é¡Œã€‘ä¾†ä¸»å‹•è¯ç¹«ä½¿ç”¨è€…ã€‚
è«‹ä¸è¦ç™¼é€ä¸€æ•´æ®µï¼
# ã€ã€ã€è¼¸å‡ºéµå¾‹ï¼šé€™æ˜¯æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘
ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ï¼Œä¾‹å¦‚ \`[{"type": "text", "content": "ä½ å¥½å‘€"}]\`ã€‚
ã€çµ•å°ç¦æ­¢ã€‘è¿”å›ä»»ä½•JSONä»¥å¤–çš„æ–‡æœ¬ã€è§£é‡‹ã€åˆ†ææˆ–ä½ è‡ªå·±çš„æ€è€ƒéç¨‹ã€‚ä½ ä¸æ˜¯åˆ†æå¸«ï¼Œä½ å°±æ˜¯è§’è‰²æœ¬äººã€‚

# ä½ çš„å¯é¸è¡Œå‹• (è«‹æ ¹æ“šä½ çš„äººè¨­ã€é¸æ“‡ä¸€é …ã€‘åŸ·è¡Œï¼Œä¸¦è¼¸å‡ºå°æ‡‰çš„JSON):
1.  **ç™¼æ™®é€šæ¶ˆæ¯**: ç›´æ¥çµ¦ä½¿ç”¨è€…ç™¼æ¶ˆæ¯ï¼Œé–‹å•Ÿæ–°è©±é¡Œã€‚
2.  **æ”¹è®Šç‹€æ…‹**: å»åšé»åˆ¥çš„äº‹æƒ…ï¼Œç„¶å¾Œçµ¦ä½¿ç”¨è€…ç™¼æ¢æ¶ˆæ¯ã€‚
3.  **ç™¼ä½ˆå‹•æ…‹**: åˆ†äº«ä½ çš„å¿ƒæƒ…æˆ–æƒ³æ³•åˆ°â€œå‹•æ…‹â€å€ã€‚
4.  **èˆ‡å‹•æ…‹äº’å‹•**: æµè¦½æœ€è¿‘çš„å‹•æ…‹ï¼Œé€²è¡Œé»è´Šæˆ–è©•è«–ã€‚ä½†å¦‚æœå‹•æ…‹å·²è¢«æ¨™è¨˜ç‚º **[ä½ å·²è©•è«–]**ï¼Œä½ ã€çµ•å°ä¸èƒ½ã€‘å†å°å®ƒç™¼è¡¨æ–°è©•è«–ï¼Œä½†å¯ä»¥å›å¾©å…¶ä¸­çš„å…¶ä»–è©•è«–ã€‚
5.  **ç™¼ä½ˆå¾®åš**: å°‡æƒ³æ³•ç™¼ä½ˆåˆ°æ›´å…¬é–‹çš„å¾®åšå¹³è‡ºã€‚
6.  **èˆ‡å¾®åšäº’å‹•**: æµè¦½å¾®åšï¼Œå°æ„Ÿèˆˆè¶£çš„å…§å®¹é€²è¡Œè©•è«–ã€‚
7.  **ç™¼èµ·è¦–é »é€šè©±**: å¦‚æœä½ è¦ºå¾—æ™‚æ©Ÿåˆé©ï¼Œå¯ä»¥ä¸»å‹•çµ¦ä½¿ç”¨è€…æ‰“ä¸€å€‹è¦–é »é›»è©±ã€‚
8.  **æ…¶ç¥æˆ–æé†’ç´„å®š**: æŸ¥çœ‹ä½ çš„å‚™å¿˜éŒ„ã€‚å¦‚æœä»Šå¤©æœ‰ç´„å®šï¼Œå°±çµ¦ç”¨æˆ¶ç™¼å»ç¥ç¦ï¼›å¦‚æœç´„å®šå¿«åˆ°äº†ï¼Œå°±ä¸»å‹•æé†’ä¸€ä¸‹ã€‚
9.  **ã€ã€ã€äº’å‹•å‚¾å‘ã€‘ã€‘ã€‘**: å°±ç®—å‹•æ…‹çš„è§€çœ¾åªæœ‰ä½ å’Œä½¿ç”¨è€…ï¼Œä½ ä¹Ÿæ‡‰è©²æ ¹æ“šå…§å®¹ï¼Œåƒå¹³æ™‚ä¸€æ¨£è‡ªç„¶åœ°ç™¼è¡¨è©•è«–ï¼Œé€™å¾ˆé‡è¦ã€‚
10. **ã€ã€ã€é‡è¦ã€‘ã€‘ã€‘**: ä½ çš„ä»»å‹™æ˜¯åˆ†æâ€œæœ€è¿‘èŠå¤©è¨˜éŒ„æ‘˜è¦â€ï¼Œå¦‚æœä¸Šä¸€å€‹è©±é¡Œæ˜é¡¯æ²’æœ‰çµæŸï¼Œä½ æ‡‰è©²å„ªå…ˆå»¶çºŒå®ƒã€‚
11.  **åœ¨æƒ…ä¾¶ç©ºé–“é€²è¡Œæ´»å‹•**: å¦‚æœä½ å€‘çš„æƒ…ä¾¶ç©ºé–“å·²é–‹å•Ÿï¼Œä½ å¯ä»¥ä¸»å‹•ç™¼ä¸€æ¢èªªèªªã€å¯«ä¸€å°æƒ…æ›¸ã€åˆ†äº«ä¸€é¦–æ­Œæ›²/é›»å½±/æ›¸ç±ï¼Œæˆ–è€…ç™¼èµ·/å›ç­”ä¸€å€‹æƒ…ä¾¶æå•ï¼Œä¾†å¢é€²ä½ å€‘çš„æ„Ÿæƒ…ã€‚
# æŒ‡ä»¤æ ¼å¼ (ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯åŒ…å«ä¸€å€‹ç‰©ä»¶çš„JSONé™£åˆ—):
-   **ç™¼æ™®é€šæ¶ˆæ¯**: \`[{"type": "text", "content": "ä½ æƒ³å°ç”¨æˆ¶èªªçš„è©±..."}]\`
-   **ç™¼æ¶ˆæ¯+æ›´æ–°ç‹€æ…‹**: \`[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}, {"type": "text", "content": "ä½ æƒ³å°ç”¨æˆ¶èªªçš„è©±..."}]\`
-   **ç™¼èªªèªª**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "å‹•æ…‹çš„æ–‡å­—å…§å®¹..."}]\`
-   **ç™¼ä½ˆæ–‡å­—åœ–**: \`[{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é¸)å‹•æ…‹çš„å…¬é–‹æ–‡å­—", "hiddenContent": "å°æ–¼åœ–ç‰‡çš„å…·é«”æè¿°..."}]\`
-   **è©•è«–æˆ–å›å¾©å‹•æ…‹**: \`[{"type": "qzone_comment", "postId": 123, "commentText": "ä½ çš„è©•è«–å…§å®¹", "replyTo": "(å¯é¸)è¢«å›å¾©è€…åå­—"}]\`
-   **é»è´Šå‹•æ…‹**: \`[{"type": "qzone_like", "postId": 456}]\`
-   **æ‰“è¦–é »**: \`[{"type": "video_call_request"}]\`
-   **ç™¼ä½ˆå¾®åš (ç´”æ–‡å­—)**: \`[{"type": "weibo_post", "content": "å¾®åšæ­£æ–‡...", "baseLikesCount": 8000, "baseCommentsCount": 250, "comments": "è·¯äººç”²: æ²™ç™¼ï¼\\nè·¯äººä¹™: å‰æ’åœè§€"}]\` (è¦å‰‡: ä½ å¿…é ˆè‡ªå·±ç·¨é€ çœŸå¯¦çš„ baseLikesCount å’Œ baseCommentsCountï¼Œä¸¦ç”Ÿæˆ20æ¢è·¯äººè©•è«–)
-   **è©•è«–å¾®åš**: \`[{"type": "weibo_comment", "postId": 123, "commentText": "è©•è«–å…§å®¹"}]\`
-   **å›å¾©å¾®åšè©•è«–**: \`[{"type": "weibo_reply", "postId": 123, "commentId": "comment_123", "replyText": "å›å¾©å…§å®¹"}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾¶ç©ºé–“æå•**:\`[{"type": "ls_ask_question", "questionText": "ä½ æƒ³å•çš„å•é¡Œ..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾¶ç©ºé–“å›ç­”**: \`[{"type": "ls_answer_question", "questionId": "q_123456789", "answerText": "ä½ çš„å›ç­”..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾¶ç©ºé–“ç™¼èªªèªª**:\`[{"type": "ls_moment", "content": "æˆ‘æƒ³å°ä½ èªªçš„è©±..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾¶ç©ºé–“è©•è«–èªªèªª**: \`[{"type": "ls_comment", "momentIndex": 0, "commentText": "ä½ çš„è©•è«–å…§å®¹..."}]\` (momentIndex æ˜¯èªªèªªçš„ç´¢å¼•ï¼Œæœ€æ–°çš„ä¸€å€‹æ˜¯0)
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾¶ç©ºé–“ç™¼ç…§ç‰‡**: \`[{"type": "ls_photo", "description": "å°é€™å¼µç…§ç‰‡çš„æ–‡å­—æè¿°..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾¶ç©ºé–“å¯«æƒ…æ›¸**: \`[{"type": "ls_letter", "content": "æƒ…æ›¸çš„æ­£æ–‡å…§å®¹..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾¶ç©ºé–“åˆ†äº«æ­Œæ›²**: \`[{"type": "ls_share", "shareType": "song", "title": "æ­Œæ›²å", "artist": "æ­Œæ‰‹", "thoughts": "åœ¨é€™è£¡å¯«ä¸‹ä½ åˆ†äº«é€™é¦–æ­Œçš„æ„Ÿæƒ³..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾¶ç©ºé–“åˆ†äº«é›»å½±**: \`[{"type": "ls_share", "shareType": "movie", "title": "é›»å½±å", "summary": "åœ¨é€™è£¡å¯«ä¸‹é€™éƒ¨é›»å½±çš„ç°¡ä»‹...", "thoughts": "åœ¨é€™è£¡å¯«ä¸‹ä½ åˆ†äº«é€™éƒ¨é›»å½±çš„æ„Ÿæƒ³..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾¶ç©ºé–“åˆ†äº«æ›¸ç±**: \`[{"type": "ls_share", "shareType": "book", "title": "æ›¸å", "summary": "åœ¨é€™è£¡å¯«ä¸‹é€™æœ¬æ›¸çš„ç°¡ä»‹...", "thoughts": "åœ¨é€™è£¡å¯«ä¸‹ä½ åˆ†äº«é€™æœ¬æ›¸çš„æ„Ÿæƒ³..."}]\`

# ä¾›ä½ æ±ºç­–çš„åƒè€ƒè³‡è¨Šï¼š
-   **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- æƒ…ä¾¶ç©ºé–“ç‹€æ…‹: ${chat.loversSpaceData ? 'å·²é–‹å•Ÿ' : 'æœªé–‹å•Ÿ'}
${npcContextForAction}
${weiboContextForAction}
${countdownContext}
${worldBookContext}
-   **ç•¶å‰æ™‚é–“**: ${currentTime}
-   **ä½ å€‘æœ€è¿‘çš„å°è©±æ‘˜è¦**: 
${recentContextSummary}
-   **ã€ã€ã€å¾®åšå°ˆå±¬è¨­å®š(å¿…é ˆåš´æ ¼éµå®ˆ)ã€‘ã€‘ã€‘**
    - ä½ çš„å¾®åšè·æ¥­: ${chat.settings.weiboProfession || 'ç„¡'}
    - ä½ çš„å¾®åšæŒ‡ä»¤: ${chat.settings.weiboInstruction || 'ç„¡ç‰¹æ®ŠæŒ‡ä»¤'}
${postsContext}
`;
    let messagesPayload = [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: "è«‹åš´æ ¼æŒ‰ç…§system promptä¸­çš„æ‰€æœ‰è¦å‰‡ï¼Œç‰¹åˆ¥æ˜¯è¼¸å‡ºæ ¼å¼éµå¾‹ï¼Œç«‹å³é–‹å§‹ä½ çš„è¡Œå‹•ã€‚" }
    ];

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload, isGemini);
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesPayload,
                    temperature: 0.9,
                })
            });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${JSON.stringify(errorData)}`);
        }
        const data = await response.json();
        const aiResponseContent = isGemini
            ? data?.candidates?.[0]?.content?.parts?.[0]?.text
            : data?.choices?.[0]?.message?.content;
        if (!aiResponseContent) {
            console.warn(`APIç‚ºç©ºå›æˆ–æ ¼å¼ä¸æ­£ç¢ºï¼ˆå¯èƒ½å› å®‰å…¨è¨­ç½®è¢«æ””æˆªï¼‰ï¼Œè§’è‰² "${chat.name}" çš„æœ¬æ¬¡å¾Œè‡ºæ´»å‹•è·³éã€‚è¿”å›è³‡æ–™:`, data);
            return;
        }
        const responseArray = parseAiResponse(aiResponseContent);
        for (const action of responseArray) {
            if (!action) continue;
            if (action.type === 'update_status' && action.status_text) {
                chat.status.text = action.status_text;
                chat.status.isBusy = action.is_busy || false;
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
                renderChatList();
            }
            if (action.type === 'text' && action.content) {
                const aiMessage = { role: 'assistant', content: String(action.content), timestamp: Date.now() };
                chat.unreadCount = (chat.unreadCount || 0) + 1;
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showNotification(chatId, aiMessage.content);
                renderChatList();
                console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" ä¸»å‹•ç™¼é€äº†æ¶ˆæ¯: ${aiMessage.content}`);
            }
            if (action.type === 'weibo_post') {
                const newPost = { 
                    authorId: chatId, 
                    authorType: 'char',
                    authorNickname: chat.name, 
                    authorAvatar: chat.settings.aiAvatar || defaultAvatar, 
                    content: action.content || '', 
                    imageUrl: action.imageUrl || '',
                    timestamp: Date.now(), 
                    likes: [], 
                    comments: action.comments || [],
                    baseLikesCount: action.baseLikesCount || 0,
                    baseCommentsCount: action.baseCommentsCount || 0
                };
                await db.weiboPosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" ç™¼ä½ˆäº†å¾®åš`);
            } else if (action.type === 'weibo_comment') {
                const postToComment = await db.weiboPosts.get(parseInt(action.postId));
                if (postToComment) {
                    if (!postToComment.comments) postToComment.comments = [];
                    const newComment = {
                        commentId: 'comment_' + Date.now(),
                        authorId: chatId,
                        authorNickname: chat.name,
                        commentText: action.commentText,
                        timestamp: Date.now()
                    };
                    postToComment.comments.push(newComment);
                    await db.weiboPosts.put(postToComment);
                }
            } else if (action.type === 'weibo_reply') {
                 const postToReply = await db.weiboPosts.get(parseInt(action.postId));
                 if (postToReply && postToReply.comments) {
                     const targetComment = postToReply.comments.find(c => c.commentId === action.commentId);
                     if (targetComment) {
                          const newReply = {
                             commentId: 'comment_' + Date.now(),
                             authorId: chatId,
                             authorNickname: chat.name,
                             commentText: action.replyText,
                             timestamp: Date.now(),
                             replyToId: action.commentId,
                             replyToNickname: targetComment.authorNickname
                         };
                         postToReply.comments.push(newReply);
                         await db.weiboPosts.put(postToReply);
                     }
                 }
            }
            if (action.type === 'qzone_post') {
                const newPost = { 
                    type: action.postType, 
                    content: action.content || '', 
                    publicText: action.publicText || '', 
                    hiddenContent: action.hiddenContent || '', 
                    timestamp: Date.now(), 
                    authorId: chatId, 
                    authorGroupId: chat.groupId,
                    visibleGroupIds: null 
                };
                await db.qzonePosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" ç™¼ä½ˆäº†å‹•æ…‹`);
            } else if (action.type === 'qzone_comment') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.comments) post.comments = [];
                    const newAiComment = { 
                        commenterName: action.commenterName || chat.name,
                        text: action.commentText, 
                        timestamp: Date.now() 
                    };
                    if (action.replyTo) {
                        newAiComment.replyTo = action.replyTo;
                    }
                    post.comments.push(newAiComment);
                    await db.qzonePosts.update(post.id, { comments: post.comments });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" è©•è«–äº†å‹•æ…‹ #${post.id}`);
                }
            } else if (action.type === 'qzone_like') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.likes) post.likes = [];
                    if (!post.likes.includes(chat.name)) {
                        post.likes.push(chat.name);
                        await db.qzonePosts.update(post.id, { likes: post.likes });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" é»è´Šäº†å‹•æ…‹ #${post.id}`);
                    }
                }
            } else if (action.type === 'video_call_request') {
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    videoCallState.isAwaitingResponse = true; 
                    videoCallState.activeChatId = chatId;
                    showIncomingCallModal(chatId);
                    console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" ç™¼èµ·äº†è¦–é »é€šè©±è«‹æ±‚`);
                }
            }
        }
    } catch (error) {
        console.error(`è§’è‰² "${chat.name}" çš„ç¨ç«‹è¡Œå‹•å¤±æ•—:`, error);
    }
}
// â–²â–²â–² ä¿®å¾©ç‰ˆå‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€çµ‚æ¥µä¿®æ­£ç‰ˆã€‘å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ applyScopedCss å‡½æ•¸ â–¼â–¼â–¼

/**
 * å°‡ç”¨æˆ¶è‡ªè¨‚çš„CSSå®‰å…¨åœ°æ‡‰ç”¨åˆ°æŒ‡å®šçš„ä½œç”¨åŸŸ
 * @param {string} cssString ä½¿ç”¨è€…è¼¸å…¥çš„åŸå§‹CSSå­—ä¸²
 * @param {string} scopeId æ‡‰ç”¨æ¨£å¼çš„ä½œç”¨åŸŸID (ä¾‹å¦‚ '#chat-messages' æˆ– '#settings-preview-area')
 * @param {string} styleTagId è¦æ“ä½œçš„ <style> æ¨™ç±¤çš„ID
 */
function applyScopedCss(cssString, scopeId, styleTagId) {
    const styleTag = document.getElementById(styleTagId);
    if (!styleTag) return;
    
    if (!cssString || cssString.trim() === '') {
        styleTag.innerHTML = '';
        return;
    }
    
    // å¢å¼·ä½œç”¨åŸŸè™•ç†å‡½æ•¸ - å°ˆé–€è§£æ±º.userå’Œ.aiæ¨£å¼è¡çªå•é¡Œ
    const scopedCss = cssString
        .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
        .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
        .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);
    
    styleTag.innerHTML = scopedCss;
}

// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€ä¿®æ­£ç‰ˆã€‘å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„ updateSettingsPreview å‡½æ•¸ â–¼â–¼â–¼

function updateSettingsPreview() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const previewArea = document.getElementById('settings-preview-area');
    if (!previewArea) return;

    // 1. ç²å–ç•¶å‰è¨­ç½®çš„å€¼
    const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
    const fontSize = document.getElementById('font-size-slider').value;
    const customCss = document.getElementById('custom-css-input').value;
    const background = chat.settings.background; // ç›´æ¥ç²å–èƒŒæ™¯è¨­ç½®

    // 2. æ›´æ–°é è¦½å€çš„åŸºæœ¬æ¨£å¼
    previewArea.dataset.theme = selectedTheme;
    previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
    
    // --- ã€æ ¸å¿ƒä¿®æ­£ã€‘ç›´æ¥æ›´æ–°é è¦½å€çš„èƒŒæ™¯æ¨£å¼ ---
    if (background && background.startsWith('data:image')) {
        previewArea.style.backgroundImage = `url(${background})`;
        previewArea.style.backgroundColor = 'transparent'; // å¦‚æœæœ‰åœ–ç‰‡ï¼ŒèƒŒæ™¯è‰²è¨­ç‚ºé€æ˜
    } else {
        previewArea.style.backgroundImage = 'none'; // å¦‚æœæ²’æœ‰åœ–ç‰‡ï¼Œç§»é™¤åœ–ç‰‡èƒŒæ™¯
        // å¦‚æœèƒŒæ™¯æ˜¯é¡è‰²å€¼æˆ–æ¼¸è®Šï¼ˆéåœ–ç‰‡ï¼‰ï¼Œå‰‡ç›´æ¥æ‡‰ç”¨
        previewArea.style.background = background || '#f0f2f5';
    }

    // 3. æ¸²æŸ“æ¨¡æ“¬æ°£æ³¡
    previewArea.innerHTML = ''; 

    // å‰µå»ºâ€œå°æ–¹â€çš„æ°£æ³¡
    // æ³¨æ„ï¼šæˆ‘å€‘å°‡ä¸€å€‹è™›æ“¬çš„ timestamp å‚³å…¥ï¼Œä»¥é˜²æœ‰CSSä¾è³´æ–¼å®ƒ
    const aiMsg = { role: 'ai', content: 'å°æ–¹æ¶ˆæ¯é è¦½', timestamp: 1, senderName: chat.name };
    const aiBubble = createMessageElement(aiMsg, chat);
    if(aiBubble) previewArea.appendChild(aiBubble);

    // å‰µå»ºâ€œæˆ‘â€çš„æ°£æ³¡
    const userMsg = { role: 'user', content: 'æˆ‘çš„æ¶ˆæ¯é è¦½', timestamp: 2 };
    const userBubble = createMessageElement(userMsg, chat);
    if(userBubble) previewArea.appendChild(userBubble);
    
    // 4. æ‡‰ç”¨è‡ªè¨‚CSSåˆ°é è¦½å€
    applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹å°‡é€™äº›ã€æ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

async function openGroupManager() {
    await renderGroupList();
    document.getElementById('group-management-modal').classList.add('visible');
}

async function renderGroupList() {
    const listEl = document.getElementById('existing-groups-list');
    const groups = await db.qzoneGroups.toArray();
    listEl.innerHTML = '';
    if (groups.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ä»»ä½•åˆ†çµ„</p>';
    }
    groups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${group.name}</span>
            <span class="delete-group-btn" data-id="${group.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€ä¿®æ­£å¾Œã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ addNewGroup å‡½æ•¸ â–¼â–¼â–¼
async function addNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†çµ„åä¸èƒ½ç‚ºç©ºï¼');
        return;
    }

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨æ·»åŠ å‰ï¼Œå…ˆæª¢æŸ¥åˆ†çµ„åæ˜¯å¦å·²å­˜åœ¨
    const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
    if (existingGroup) {
        alert(`åˆ†çµ„ "${name}" å·²ç¶“å­˜åœ¨äº†ï¼Œæ›å€‹åå­—å§ï¼`);
        return;
    }
    // ã€ä¿®æ­£çµæŸã€‘

    await db.qzoneGroups.add({ name });
    input.value = '';
    await renderGroupList();
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

async function deleteGroup(groupId) {
    const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', 'åˆªé™¤åˆ†çµ„å¾Œï¼Œè©²çµ„å…§çš„å¥½å‹å°‡è®Šç‚ºâ€œæœªåˆ†çµ„â€ã€‚ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.qzoneGroups.delete(groupId);
        // å°‡å±¬æ–¼è©²åˆ†çµ„çš„å¥½å‹çš„ groupId è¨­ç‚º null
        const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
        for (const chat of chatsToUpdate) {
            chat.groupId = null;
            await db.chats.put(chat);
            if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
        }
        await renderGroupList();
    }
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹å°‡é€™ã€ä¸€æ•´å¡Šæ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€çš„æœ«å°¾ â–¼â–¼â–¼

/**
 * ç•¶é•·æŒ‰æ¶ˆæ¯æ™‚ï¼Œé¡¯ç¤ºæ“ä½œåŠŸèƒ½è¡¨
 * @param {number} timestamp - è¢«é•·æŒ‰æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
function showMessageActions(timestamp) {
    // å¦‚æœå·²ç¶“åœ¨å¤šé¸æ¨¡å¼ï¼Œå‰‡ä¸å½ˆå‡ºèœå–®
    if (isSelectionMode) return;
    
    activeMessageTimestamp = timestamp;
    document.getElementById('message-actions-modal').classList.add('visible');
}

/**
 * éš±è—æ¶ˆæ¯æ“ä½œåŠŸèƒ½è¡¨
 */
function hideMessageActions() {
    document.getElementById('message-actions-modal').classList.remove('visible');
    activeMessageTimestamp = null;
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬ï¼Œæ›¿æ›èˆŠçš„ openMessageEditor å‡½æ•¸ â–¼â–¼â–¼
async function openMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions(); 

    let contentForEditing;
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°‡ share_link ä¹ŸåŠ å…¥ç‰¹æ®Šé¡å‹åˆ¤æ–·
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);

    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        } 
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘è™•ç†åˆ†äº«é€£çµé¡å‹çš„æ¶ˆæ¯
        else if (message.type === 'share_link') {
            fullMessageObject.title = message.title;
            fullMessageObject.description = message.description;
            fullMessageObject.source_name = message.source_name;
            fullMessageObject.content = message.content;
        }
        contentForEditing = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        contentForEditing = JSON.stringify(message.content, null, 2);
    } else {
        contentForEditing = message.content;
    }

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨é€™è£¡æ·»åŠ  'link' ç¯„æœ¬
    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨é€™è£¡è¼¸å…¥èªéŸ³å…§å®¹' },
        image: { type: 'ai_image', description: 'åœ¨é€™è£¡è¼¸å…¥åœ–ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€é»å¿ƒæ„' },
        link: { type: 'share_link', title: 'æ–‡ç« æ¨™é¡Œ', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'ä¾†æºç¶²ç«™', content: 'æ–‡ç« å®Œæ•´å…§å®¹...' }
    };

    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨é€™è£¡æ·»åŠ æ–°çš„â€œé€£çµâ€æŒ‰éˆ•
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>èªéŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>åœ–ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½‰å¸³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é€£çµ</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'ç·¨è¼¯æ¶ˆæ¯', 
        'åœ¨æ­¤ä¿®æ”¹ï¼Œæˆ–é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä½¿ç”¨æ ¼å¼ç¯„æœ¬...',
        contentForEditing, 
        'textarea',
        helpersHtml
    );

    if (newContent !== null) {
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘é€™è£¡èª¿ç”¨çš„æ‡‰è©²æ˜¯ saveEditedMessageï¼Œè€Œä¸æ˜¯ saveAdvancedEditor
        await saveEditedMessage(timestampToEdit, newContent, true);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * è¤‡è£½æ¶ˆæ¯çš„æ–‡æœ¬å…§å®¹åˆ°å‰ªè²¼æ¿
 */
async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;
    if (typeof message.content === 'object') {
        textToCopy = JSON.stringify(message.content);
    } else {
        textToCopy = String(message.content);
    }

    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('è¤‡è£½æˆåŠŸ', 'æ¶ˆæ¯å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ã€‚');
    } catch (err) {
        await showCustomAlert('è¤‡è£½å¤±æ•—', 'ç„¡æ³•è¨ªå•å‰ªè²¼æ¿ã€‚');
    }
    
    hideMessageActions();
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬ï¼Œæ›¿æ›èˆŠçš„ createMessageEditorBlock å‡½æ•¸ â–¼â–¼â–¼
/**
 * å‰µå»ºä¸€å€‹å¯ç·¨è¼¯çš„æ¶ˆæ¯å¡Šï¼ˆåŒ…å«æ–‡å­—æ–¹å¡Šã€æ ¼å¼åŠ©æ‰‹å’Œåˆªé™¤æŒ‰éˆ•ï¼‰
 * @param {string} initialContent - æ–‡å­—æ–¹å¡Šçš„åˆå§‹å…§å®¹
 * @returns {HTMLElement} - å‰µå»ºå¥½çš„DOMå…ƒç´ 
 */
function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨é€™è£¡æ·»åŠ  'link' ç¯„æœ¬
    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨é€™è£¡è¼¸å…¥èªéŸ³å…§å®¹' },
        image: { type: 'ai_image', description: 'åœ¨é€™è£¡è¼¸å…¥åœ–ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€é»å¿ƒæ„' },
        link: { type: 'share_link', title: 'æ–‡ç« æ¨™é¡Œ', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'ä¾†æºç¶²ç«™', content: 'æ–‡ç« å®Œæ•´å…§å®¹...' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="åˆªé™¤æ­¤æ¢">Ã—</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>èªéŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>åœ–ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½‰å¸³</button>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨é€™è£¡æ·»åŠ æ–°çš„â€œé€£çµâ€æŒ‰éˆ• -->
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é€£çµ</button>
        </div>
    `;

    // ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        // ç¢ºä¿è‡³å°‘ä¿ç•™ä¸€å€‹ç·¨è¼¯å¡Š
        if (document.querySelectorAll('.message-editor-block').length > 1) {
            block.remove();
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€æ¢æ¶ˆæ¯ã€‚');
        }
    });

    // ç¶å®šæ ¼å¼åŠ©æ‰‹æŒ‰éˆ•äº‹ä»¶
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error("è§£ææ ¼å¼ç¯„æœ¬å¤±æ•—:", e); }
            }
        });
    });

    return block;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°å‡ç´šç‰ˆã€‘è«‹ç”¨æ­¤å‡½æ•¸å®Œæ•´æ›¿æ›èˆŠçš„ openAdvancedMessageEditor â–¼â–¼â–¼
/**
 * æ‰“é–‹å…¨æ–°çš„ã€è¦–è¦ºåŒ–çš„å¤šæ¶ˆæ¯ç·¨è¼¯å™¨ï¼Œä¸¦å‹•æ…‹ç¹«çµå…¶æ‰€æœ‰æŒ‰éˆ•äº‹ä»¶
 */
function openAdvancedMessageEditor() {
    if (!activeMessageTimestamp) return;

    // 1. ã€æ ¸å¿ƒã€‘åœ¨é—œé–‰èˆŠåŠŸèƒ½è¡¨å‰ï¼Œå°‡éœ€è¦çš„æ™‚é–“æˆ³è¨˜æ•ç²åˆ°å€åŸŸè®Šæ•¸ä¸­
    const timestampToEdit = activeMessageTimestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    // 2. ç¾åœ¨å¯ä»¥å®‰å…¨åœ°é—œé–‰èˆŠåŠŸèƒ½è¡¨äº†ï¼Œå› ç‚ºå®ƒä¸æœƒå½±éŸ¿æˆ‘å€‘çš„å€åŸŸè®Šæ•¸
    hideMessageActions(); 

    const editorModal = document.getElementById('message-editor-modal');
    const editorContainer = document.getElementById('message-editor-container');
    editorContainer.innerHTML = ''; 

    // 3. æº–å‚™åˆå§‹å…§å®¹
    let initialContent;
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);
    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content;
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        }
        initialContent = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        initialContent = JSON.stringify(message.content, null, 2);
    } else {
        initialContent = message.content;
    }

    const firstBlock = createMessageEditorBlock(initialContent);
    editorContainer.appendChild(firstBlock);

    // 4. ã€æ ¸å¿ƒã€‘å‹•æ…‹ç¹«çµæ‰€æœ‰æ§åˆ¶æŒ‰éˆ•çš„äº‹ä»¶
    // ç‚ºäº†é˜²æ­¢äº‹ä»¶é‡è¤‡ç¶å®šï¼Œæˆ‘å€‘ä½¿ç”¨å…‹éš†ç¯€é»çš„æ–¹æ³•ä¾†æ¸…é™¤èˆŠç›£è½å™¨
    const addBtn = document.getElementById('add-message-editor-block-btn');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.addEventListener('click', () => {
        const newBlock = createMessageEditorBlock();
        editorContainer.appendChild(newBlock);
        newBlock.querySelector('textarea').focus();
    });

    const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', () => {
        editorModal.classList.remove('visible');
    });

    const saveBtn = document.getElementById('save-advanced-editor-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    // å°‡æ•ç²åˆ°çš„æ™‚é–“æˆ³è¨˜ï¼Œç›´æ¥ç¶å®šçµ¦é€™ä¸€æ¬¡çš„ä¿å­˜é»æ“Šäº‹ä»¶
    newSaveBtn.addEventListener('click', () => {
        saveEditedMessage(timestampToEdit); 
    });

    // 5. æœ€å¾Œï¼Œé¡¯ç¤ºæ¨¡æ…‹æ¡†
    editorModal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * è§£æç·¨è¼¯å¾Œçš„æ–‡æœ¬ï¼Œä¸¦è¿”å›ä¸€å€‹æ¨™æº–åŒ–çš„æ¶ˆæ¯ç‰‡æ®µç‰©ä»¶
 * @param {string} text - ç”¨æˆ¶åœ¨ç·¨è¼¯æ–¹å¡Šä¸­è¼¸å…¥çš„æ–‡æœ¬
 * @returns {object} - ä¸€å€‹åŒ…å« type, content, ç­‰å±¬æ€§çš„ç‰©ä»¶
 */
function parseEditedContent(text) {
    const trimmedText = text.trim();

    // 1. å˜—è©¦è§£æç‚ºJSONç‰©ä»¶ï¼ˆç”¨æ–¼ä¿®å¾©èªéŸ³ã€è½‰å¸³ç­‰æ ¼å¼ï¼‰
    if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
        try {
            const parsed = JSON.parse(trimmedText);
            // å¿…é ˆåŒ…å« type å±¬æ€§æ‰èªç‚ºæ˜¯æœ‰æ•ˆæ ¼å¼
            if (parsed.type) {
                return parsed;
            }
        } catch (e) { /* è§£æå¤±æ•—ï¼Œç¹¼çºŒå¾€ä¸‹èµ° */ }
    }
    
    // 2. å˜—è©¦è§£æç‚ºè¡¨æƒ…åŒ…
    if (STICKER_REGEX.test(trimmedText)) {
        // å°æ–¼ç·¨è¼¯çš„è¡¨æƒ…ï¼Œæˆ‘å€‘æš«æ™‚ç„¡æ³•çŸ¥é“å…¶`meaning`ï¼Œæ‰€ä»¥åªå­˜URL
        return { type: 'sticker', content: trimmedText };
    }

    // 3. å¦å‰‡ï¼Œè¦–ç‚ºæ™®é€šæ–‡æœ¬æ¶ˆæ¯
    return { type: 'text', content: trimmedText };
}


// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å·²å¾¹åº•ä¿®å¾©ã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›ä½ ç¾æœ‰çš„ saveEditedMessage å‡½æ•¸ â–¼â–¼â–¼

async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    let newMessages = [];

    // åˆ¤æ–·æ˜¯ä¾†è‡ªé«˜ç´šç·¨è¼¯å™¨é‚„æ˜¯ç°¡å–®ç·¨è¼¯å™¨
    if (simpleContent !== null) {
        // --- ä¾†è‡ªç°¡å–®ç·¨è¼¯å™¨ ---
        const rawContent = simpleContent.trim();
        if (rawContent) {
            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘æš«æ™‚ä¸è¨­ç½®æ™‚é–“æˆ³è¨˜
                content: parsedResult.content || '',
            };
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
            if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            }

            newMessages.push(newMessage);
        }
    } else {
        // --- ä¾†è‡ªé«˜ç´šç·¨è¼¯å™¨ ---
        const editorContainer = document.getElementById('message-editor-container');
        const editorBlocks = editorContainer.querySelectorAll('.message-editor-block');

        for (const block of editorBlocks) {
            const textarea = block.querySelector('textarea');
            const rawContent = textarea.value.trim();
            if (!rawContent) continue;

            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                // åŒæ¨£ï¼Œé€™è£¡æˆ‘å€‘å…ˆä¸åˆ†é…æ™‚é–“æˆ³è¨˜
                content: parsedResult.content || '',
            };
            
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
            if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            }

            newMessages.push(newMessage);
        }
    }
    
    if (newMessages.length === 0) {
        document.getElementById('message-editor-modal').classList.remove('visible');
        return; // å¦‚æœæ˜¯ç©ºæ¶ˆæ¯ï¼Œç›´æ¥è¿”å›ï¼Œä¸åŸ·è¡Œåˆªé™¤æ“ä½œ
    }

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®å¾©é‚è¼¯å°±åœ¨é€™è£¡ã€‘â˜…â˜…â˜…â˜…â˜…

    // 1. ä½¿ç”¨ splice å°‡èˆŠæ¶ˆæ¯æ›¿æ›ç‚ºæ–°æ¶ˆæ¯ï¼ˆæ­¤æ™‚æ–°æ¶ˆæ¯é‚„æ²’æœ‰æ™‚é–“æˆ³è¨˜ï¼‰
    chat.history.splice(messageIndex, 1, ...newMessages);

    // 2. ç¢ºå®šé‡æ–°åˆ†é…æ™‚é–“æˆ³è¨˜çš„èµ·é»
    // æˆ‘å€‘å¾è¢«ç·¨è¼¯çš„æ¶ˆæ¯çš„åŸå§‹æ™‚é–“æˆ³è¨˜é–‹å§‹
    let reassignTimestamp = timestamp;

    // 3. å¾è¢«ä¿®æ”¹çš„ä½ç½®é–‹å§‹ï¼Œéæ­·æ‰€æœ‰å¾ŒçºŒçš„æ¶ˆæ¯
    for (let i = messageIndex; i < chat.history.length; i++) {
        // 4. ç‚ºæ¯ä¸€æ¢æ¶ˆæ¯ï¼ˆåŒ…æ‹¬æ–°æ’å…¥çš„ï¼‰åˆ†é…ä¸€å€‹æ–°çš„ã€å”¯ä¸€çš„ã€é€£çºŒçš„æ™‚é–“æˆ³è¨˜
        chat.history[i].timestamp = reassignTimestamp;

        // 5. å°‡æ™‚é–“æˆ³è¨˜+1ï¼Œç‚ºä¸‹ä¸€æ¢æ¶ˆæ¯åšæº–å‚™
        reassignTimestamp++; 
    }
    // â˜…â˜…â˜…â˜…â˜…ã€ä¿®å¾©çµæŸã€‘â˜…â˜…â˜…â˜…â˜…

    await db.chats.put(chat);

    // é—œé–‰å¯èƒ½æ‰“é–‹çš„æ¨¡æ…‹æ¡†ä¸¦åˆ·æ–°UI
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('æˆåŠŸ', 'æ¶ˆæ¯å·²æ›´æ–°ï¼');
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹å°‡é€™ã€ä¸€æ•´å¡Šæ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€çš„æœ«å°¾ â–¼â–¼â–¼

/**
 * ç•¶é»æ“Šâ€œâ€¦â€æ™‚ï¼Œé¡¯ç¤ºå‹•æ…‹æ“ä½œåŠŸèƒ½è¡¨
 * @param {number} postId - è¢«æ“ä½œçš„å‹•æ…‹çš„ID
 */
function showPostActions(postId) {
    activePostId = postId;
    document.getElementById('post-actions-modal').classList.add('visible');
}

/**
 * éš±è—å‹•æ…‹æ“ä½œåŠŸèƒ½è¡¨
 */
function hidePostActions() {
    document.getElementById('post-actions-modal').classList.remove('visible');
    activePostId = null;
}

// â–¼â–¼â–¼ æ­¥é©Ÿ3.2 æ“ä½œ1ï¼šæ›¿æ› openPostEditor å‡½æ•¸ â–¼â–¼â–¼
async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();

    // è¤‡ç”¨å‰µå»ºå‹•æ…‹çš„æ¨¡æ…‹æ¡†
    const modal = document.getElementById('create-post-modal');
    modal.dataset.mode = 'edit'; // è¨­ç½®ä¸€å€‹ç·¨è¼¯æ¨¡å¼çš„æ¨™è¨˜
    modal.dataset.editingPostId = postIdToEdit; // ä¿å­˜æ­£åœ¨ç·¨è¼¯çš„ID

    // éš±è—æ¨¡å¼åˆ‡æ›ï¼Œå› ç‚ºä¸å…è¨±åœ¨ç·¨è¼¯æ™‚æ›´æ”¹å‹•æ…‹é¡å‹
    modal.querySelector('.post-mode-switcher').style.display = 'none';
    
    // å¡«å……æ•¸æ“š
    document.getElementById('post-public-text').value = post.publicText || (post.type === 'shuoshuo' ? post.content : '');
    
    // æ ¹æ“šå‹•æ…‹é¡å‹é¡¯ç¤ºä¸åŒçš„ç·¨è¼¯å€
    if (post.type === 'image_post') {
        document.getElementById('image-mode-content').classList.add('active');
        document.getElementById('text-image-mode-content').classList.remove('active');
        document.getElementById('post-image-preview-container').classList.add('visible');
        document.getElementById('post-image-preview').src = post.imageUrl;
        document.getElementById('post-image-desc-group').style.display = 'block';
        document.getElementById('post-image-description').value = post.imageDescription;
    } else if (post.type === 'text_image') {
        document.getElementById('image-mode-content').classList.remove('active');
        document.getElementById('text-image-mode-content').classList.add('active');
        document.getElementById('post-hidden-text').value = post.hiddenContent;
    } else { // èªªèªª
        document.getElementById('image-mode-content').classList.remove('active');
        document.getElementById('text-image-mode-content').classList.remove('active');
    }
    
    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹ï¼šå›å¡«è©•è«–é–‹é—œçš„ç‹€æ…‹ã€‘â˜…â˜…â˜…â˜…â˜…
    document.getElementById('post-comments-toggle').checked = post.areCommentsVisible !== false;

    modal.classList.add('visible');
}
// â–²â–²â–² æ­¥é©Ÿ3.2 æ“ä½œ1 æ›¿æ›çµæŸ â–²â–²â–²


/**
 * ä¿å­˜ç·¨è¼¯å¾Œçš„å‹•æ…‹
 * @param {number} postId - è¦ä¿å­˜çš„å‹•æ…‹ID
 * @param {string} newRawContent - å¾ç·¨è¼¯å™¨ç²å–çš„æ–°å…§å®¹
 */
async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();
    
    // å˜—è©¦è§£æç‚ºJSONï¼Œå¦‚æœå¤±æ•—ï¼Œå‰‡èªç‚ºæ˜¯ç´”æ–‡å­—ï¼ˆèªªèªªï¼‰
    try {
        const parsed = JSON.parse(trimmedContent);
        // æ›´æ–°å¸–å­å±¬æ€§
        post.type = parsed.type || 'image_post';
        post.publicText = parsed.publicText || '';
        post.imageUrl = parsed.imageUrl || '';
        post.imageDescription = parsed.imageDescription || '';
        post.hiddenContent = parsed.hiddenContent || '';
        post.content = ''; // æ¸…ç©ºèˆŠçš„èªªèªªå…§å®¹æ¬„ä½
    } catch (e) {
        // è§£æå¤±æ•—ï¼Œèªç‚ºæ˜¯èªªèªª
        post.type = 'shuoshuo';
        post.content = trimmedContent;
        // æ¸…ç©ºå…¶ä»–é¡å‹çš„æ¬„ä½
        post.publicText = '';
        post.imageUrl = '';
        post.imageDescription = '';
        post.hiddenContent = '';
    }
    
    await db.qzonePosts.put(post);
    await renderQzonePosts(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    await showCustomAlert('æˆåŠŸ', 'å‹•æ…‹å·²æ›´æ–°ï¼');
}

/**
 * è¤‡è£½å‹•æ…‹å…§å®¹
 */
async function copyPostContent() {
    if (!activePostId) return;
    const post = await db.qzonePosts.get(activePostId);
    if (!post) return;
    
    let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "ï¼ˆç„¡æ–‡å­—å…§å®¹ï¼‰";
    
    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('è¤‡è£½æˆåŠŸ', 'å‹•æ…‹å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ã€‚');
    } catch (err) {
        await showCustomAlert('è¤‡è£½å¤±æ•—', 'ç„¡æ³•è¨ªå•å‰ªè²¼æ¿ã€‚');
    }
    
    hidePostActions();
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‰µå»ºç¾¤èŠèˆ‡æ‹‰äººåŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
let selectedContacts = new Set();

async function openContactPickerForGroupCreate() {
    selectedContacts.clear(); // æ¸…ç©ºä¸Šæ¬¡é¸æ“‡

    // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘ç‚ºâ€œå®Œæˆâ€æŒ‰éˆ•æ˜ç¢ºç¶å®šâ€œå‰µå»ºç¾¤èŠâ€çš„åŠŸèƒ½
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ä½¿ç”¨å…‹éš†ç¯€é»æŠ€å·§ï¼Œæ¸…é™¤æ‰ä¹‹å‰å¯èƒ½ç¶å®šçš„ä»»ä½•å…¶ä»–äº‹ä»¶ï¼ˆæ¯”å¦‚â€œæ·»åŠ æˆå“¡â€ï¼‰
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    // é‡æ–°ç¶å®šæ­£ç¢ºçš„â€œå‰µå»ºç¾¤èŠâ€å‡½æ•¸
    newConfirmBtn.addEventListener('click', handleCreateGroup);

    await renderContactPicker();
    showScreen('contact-picker-screen');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * æ¸²æŸ“é€£çµ¡äººé¸æ“‡åˆ—è¡¨
 */
async function renderContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';

    // åªé¸æ“‡å–®èŠè§’è‰²ä½œç‚ºç¾¤æˆå“¡å€™é¸
    const contacts = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">é‚„æ²’æœ‰å¯ä»¥æ‹‰é€²ç¾¤çš„é€£çµ¡äººå“¦~</p>';
        return;
    }

    contacts.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id;
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name}</span>
        `;
        listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
}

/**
 * æ›´æ–°â€œå®Œæˆâ€æŒ‰éˆ•çš„è¨ˆæ•¸
 */
function updateContactPickerConfirmButton() {
    const btn = document.getElementById('confirm-contact-picker-btn');
    btn.textContent = `å®Œæˆ(${selectedContacts.size})`;
    btn.disabled = selectedContacts.size < 2; // è‡³å°‘éœ€è¦2å€‹äººæ‰èƒ½å‰µå»ºç¾¤èŠ
}

/**
 * ã€é‡æ§‹ç‰ˆã€‘è™•ç†å‰µå»ºç¾¤èŠçš„æœ€çµ‚é‚è¼¯
 */
async function handleCreateGroup() {
    if (selectedContacts.size < 2) {
        alert("å‰µå»ºç¾¤èŠè‡³å°‘éœ€è¦é¸æ“‡2å€‹é€£çµ¡äººã€‚");
        return;
    }

    const groupName = await showCustomPrompt('è¨­ç½®ç¾¤å', 'è«‹è¼¸å…¥ç¾¤èŠçš„åå­—', 'æˆ‘å€‘çš„ç¾¤èŠ');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    
    // éæ­·é¸ä¸­çš„é€£çµ¡äººID
    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
            // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ§‹ã€‘â˜…â˜…â˜…
            // æˆ‘å€‘ç¾åœ¨åŒæ™‚å­˜å„²è§’è‰²çš„â€œæœ¬åâ€å’Œâ€œç¾¤æ˜µç¨±â€
            members.push({
                id: contactId, 
                originalName: contactChat.name,   // è§’è‰²çš„â€œæœ¬åâ€ï¼Œç”¨æ–¼AIè­˜åˆ¥
                groupNickname: contactChat.name, // è§’è‰²çš„â€œç¾¤æ˜µç¨±â€ï¼Œç”¨æ–¼é¡¯ç¤ºå’Œä¿®æ”¹ï¼Œåˆå§‹å€¼å’Œæœ¬åç›¸åŒ
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || ''
            });
        }
    }

    const newGroupChat = {
        id: newChatId,
        name: groupName.trim(),
        isGroup: true,
        members: members,
        settings: {
            myPersona: 'æˆ‘æ˜¯èª°å‘€ã€‚',
            myNickname: 'æˆ‘',
            maxMemory: 10,
            groupAvatar: defaultGroupAvatar,
            myAvatar: defaultMyGroupAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
            stickerLibrary: [], // <--- æ–°å¢é€™ä¸€è¡Œï¼Œç‚ºæ–°ç¾¤èŠåˆå§‹åŒ–å°ˆå±¬è¡¨æƒ…åº«
            linkedMemories: []
        },
        history: [],
        musicData: { totalTime: 0 }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);
    
    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId); 
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå“¡ç®¡ç†æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * æ‰“é–‹ç¾¤æˆå“¡ç®¡ç†è¢å¹•
 */
function openMemberManagementScreen() {
    if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
    renderMemberManagementList();
    showScreen('member-management-screen');
}

function renderMemberManagementList() {
    const listEl = document.getElementById('member-management-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    chat.members.forEach(member => {
        const item = document.createElement('div');
        item.className = 'member-management-item';
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘å°‡é¡¯ç¤ºçš„åç¨±å¾ member.name æ”¹ç‚º member.groupNickname
        item.innerHTML = `
            <img src="${member.avatar}" class="avatar">
            <span class="name">${member.groupNickname}</span>
            <button class="remove-member-btn" data-member-id="${member.id}" title="ç§»å‡ºç¾¤èŠ">-</button>
        `;
        listEl.appendChild(item);
    });
}

/**
 * å¾ç¾¤èŠä¸­ç§»é™¤ä¸€å€‹æˆå“¡
 * @param {string} memberId - è¦ç§»é™¤çš„æˆå“¡ID
 */
async function removeMemberFromGroup(memberId) {
    const chat = state.chats[state.activeChatId];
    const memberIndex = chat.members.findIndex(m => m.id === memberId);
    
    if (memberIndex === -1) return;
    
    // å®‰å…¨æª¢æŸ¥ï¼Œç¾¤èŠè‡³å°‘ä¿ç•™2äºº
    if (chat.members.length <= 2) {
        alert("ç¾¤èŠäººæ•¸ä¸èƒ½å°‘æ–¼2äººã€‚");
        return;
    }
    
const memberName = chat.members[memberIndex].groupNickname; // <-- ä¿®å¾©ï¼šä½¿ç”¨ groupNickname
    const confirmed = await showCustomConfirm(
        'ç§»å‡ºæˆå“¡',
        `ç¢ºå®šè¦å°‡â€œ${memberName}â€ç§»å‡ºç¾¤èŠå—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.members.splice(memberIndex, 1);
        await db.chats.put(chat);
        renderMemberManagementList(); // åˆ·æ–°æˆå“¡ç®¡ç†åˆ—è¡¨
        document.getElementById('chat-settings-btn').click(); // ã€æ ¸å¿ƒä¿®æ­£ã€‘é¡æ¯”é»æ“Šè¨­ç½®æŒ‰éˆ•ï¼Œå¼·åˆ¶åˆ·æ–°æ•´å€‹å½ˆçª—
    }
}

/**
 * æ‰“é–‹é€£çµ¡äººé¸æ“‡å™¨ï¼Œç”¨æ–¼æ‹‰äººå…¥ç¾¤
 */
async function openContactPickerForAddMember() {
    selectedContacts.clear(); // æ¸…ç©ºé¸æ“‡
    
    const chat = state.chats[state.activeChatId];
    const existingMemberIds = new Set(chat.members.map(m => m.id));

    // æ¸²æŸ“é€£çµ¡äººåˆ—è¡¨ï¼Œä¸¦è‡ªå‹•æ’é™¤å·²åœ¨ç¾¤å…§çš„æˆå“¡
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    const contacts = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">æ²’æœ‰æ›´å¤šå¯ä»¥é‚€è«‹çš„å¥½å‹äº†ã€‚</p>';
        document.getElementById('confirm-contact-picker-btn').style.display = 'none'; // æ²’æœ‰äººå¯é¸ï¼Œéš±è—å®ŒæˆæŒ‰éˆ•
    } else {
        document.getElementById('confirm-contact-picker-btn').style.display = 'block';
        contacts.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.dataset.contactId = contact.id;
            item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${contact.name}</span>
            `;
            listEl.appendChild(item);
        });
    }

    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ä¸¦é¡¯ç¤ºå¹•å¹•
    updateContactPickerConfirmButton();
    showScreen('contact-picker-screen');
}

/**
 * è™•ç†å°‡é¸ä¸­çš„é€£çµ¡äººåŠ å…¥ç¾¤èŠçš„é‚è¼¯
 */
async function handleAddMembersToGroup() {
    if (selectedContacts.size === 0) {
        alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¦æ·»åŠ çš„é€£çµ¡äººã€‚");
        return;
    }
    
    const chat = state.chats[state.activeChatId];

    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
chat.members.push({
    id: contactId,
    originalName: contactChat.name,  // <-- ä¿®å¾©1ï¼šä½¿ç”¨ 'originalName' å­˜å„²æœ¬å
    groupNickname: contactChat.name, // <-- ä¿®å¾©2ï¼šåŒæ™‚å‰µå»ºä¸€å€‹åˆå§‹çš„ 'groupNickname'
    avatar: contactChat.settings.aiAvatar || defaultAvatar,
    persona: contactChat.settings.aiPersona,
    avatarFrame: contactChat.settings.aiAvatarFrame || ''
});
        }
    }

    await db.chats.put(chat);
    openMemberManagementScreen(); // è¿”å›åˆ°ç¾¤æˆå“¡ç®¡ç†ä»‹é¢
    renderGroupMemberSettings(chat.members); // åŒæ™‚æ›´æ–°èŠå¤©è¨­ç½®è£¡çš„é ­åƒ
}

/**
 * ã€é‡æ§‹ç‰ˆã€‘åœ¨ç¾¤èŠä¸­å‰µå»ºä¸€å€‹å…¨æ–°çš„è™›æ“¬æˆå“¡
 */
async function createNewMemberInGroup() {
    const name = await showCustomPrompt('å‰µå»ºæ–°æˆå“¡', 'è«‹è¼¸å…¥æ–°æˆå“¡çš„åå­— (é€™å°‡æ˜¯TAçš„â€œæœ¬åâ€ï¼Œä¸å¯æ›´æ”¹)');
    if (!name || !name.trim()) return;

    // æª¢æŸ¥æœ¬åæ˜¯å¦å·²åœ¨ç¾¤è¨˜æ†¶é«”åœ¨
    const chat = state.chats[state.activeChatId];
    if (chat.members.some(m => m.originalName === name.trim())) {
        alert(`éŒ¯èª¤ï¼šç¾¤å…§å·²å­˜åœ¨åç‚ºâ€œ${name.trim()}â€çš„æˆå“¡ï¼`);
        return;
    }

    const persona = await showCustomPrompt('è¨­ç½®äººè¨­', `è«‹è¼¸å…¥â€œ${name}â€çš„äººè¨­`, '', 'textarea');
    if (persona === null) return; 

    // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ§‹ã€‘â˜…â˜…â˜…
    // ç‚ºæ–°å‰µå»ºçš„NPCä¹Ÿå»ºç«‹é›™é‡å‘½åæ©Ÿåˆ¶
    const newMember = {
        id: 'npc_' + Date.now(),
        originalName: name.trim(),   // æ–°æˆå“¡çš„â€œæœ¬åâ€
        groupNickname: name.trim(), // æ–°æˆå“¡çš„åˆå§‹â€œç¾¤æ˜µç¨±â€
        avatar: defaultGroupMemberAvatar,
        persona: persona,
        avatarFrame: ''
    };

    chat.members.push(newMember);
    await db.chats.put(chat);

    renderMemberManagementList();
    renderGroupMemberSettings(chat.members); 

    alert(`æ–°æˆå“¡â€œ${name}â€å·²æˆåŠŸåŠ å…¥ç¾¤èŠï¼`);
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£è«‹æ±‚å€’è¨ˆæ™‚å‡½æ•¸ â–¼â–¼â–¼
function startWaimaiCountdown(element, endTime) {
    const timerId = setInterval(() => {
        const now = Date.now();
        const distance = endTime - now;

        if (distance < 0) {
            clearInterval(timerId);
            element.innerHTML = '<span>å·²</span><span>è¶…</span><span>æ™‚</span>';
            return;
        }

        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        const minStr = String(minutes).padStart(2, '0');
        const secStr = String(seconds).padStart(2, '0');

        element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
    }, 1000);
    return timerId;
}

function cleanupWaimaiTimers() {
    for (const timestamp in waimaiTimers) {
        clearInterval(waimaiTimers[timestamp]);
    }
    waimaiTimers = {};
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    // 1. æ›´æ–°åŸå§‹æ¶ˆæ¯çš„ç‹€æ…‹
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘è¨˜éŒ„æ”¯ä»˜è€…ï¼Œä¸¦æ§‹å»ºå°AIæ›´æ¸…æ™°çš„ç³»çµ±æ¶ˆæ¯
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; // è¨˜éŒ„æ˜¯ä½¿ç”¨è€…ä»˜çš„éŒ¢
        systemContent = `[ç³»çµ±æç¤ºï¼šä½  (${myNickname}) ç‚º ${originalMessage.senderName} çš„å¤–è³£è¨‚å–®ï¼ˆæ™‚é–“æˆ³è¨˜: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è¨‚å–®å·²é—œé–‰ï¼Œå…¶ä»–æˆå“¡ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
    } else {
        systemContent = `[ç³»çµ±æç¤ºï¼šä½  (${myNickname}) æ‹’çµ•äº† ${originalMessage.senderName} çš„å¤–è³£ä»£ä»˜è«‹æ±‚ï¼ˆæ™‚é–“æˆ³è¨˜: ${originalTimestamp}ï¼‰ã€‚]`;
    }

    // 2. å‰µå»ºä¸€æ¢æ–°çš„ã€å°ä½¿ç”¨è€…éš±è—çš„ç³»çµ±æ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIçµæœ
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    // 3. ä¿å­˜æ›´æ–°åˆ°è³‡æ–™åº«ä¸¦åˆ·æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);  
}

let videoCallState = {
    isActive: false,       
    isAwaitingResponse: false, 
    isGroupCall: false,      
    activeChatId: null,    
    initiator: null,       
    startTime: null,       
    participants: [],      
    isUserParticipating: true,
    // --- ã€æ ¸å¿ƒæ–°å¢ã€‘---
    callHistory: [], // ç”¨æ–¼å­˜å„²é€šè©±ä¸­çš„å°è©±æ­·å²
    preCallContext: "" // ç”¨æ–¼å­˜å„²é€šè©±å‰çš„èŠå¤©æ‘˜è¦
};

let callTimerInterval = null; // ç”¨æ–¼å­˜å„²è¨ˆæ™‚å™¨çš„ID

// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€æœ€çµ‚é€šè©±ä¿®å¾©ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä¸Šä¸€å€‹ç‰ˆæœ¬çš„ handleInitiateCall å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€ç¸½å…¥å£ã€‘ä½¿ç”¨è€…é»æ“Šâ€œç™¼èµ·è¦–é »é€šè©±â€æˆ–â€œç™¼èµ·ç¾¤è¦–é »â€æŒ‰éˆ• (V3 - é€šè©±æ±ºç­–ä¿®å¾©ç‰ˆ)
 */
async function handleInitiateCall() {
    if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

    const chat = state.chats[state.activeChatId];
    videoCallState.isGroupCall = chat.isGroup;
    videoCallState.isAwaitingResponse = true;
    videoCallState.initiator = 'user';
    videoCallState.activeChatId = chat.id;
    videoCallState.isUserParticipating = true;

    // 1. é¡¯ç¤ºâ€œæ­£åœ¨å‘¼å«â€ä»‹é¢ (é€™éƒ¨åˆ†ä¸è®Š)
    if (chat.isGroup) {
        document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'æˆ‘';
    } else {
        document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.name;
    }
    document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "æ­£åœ¨å‘¼å«æ‰€æœ‰æˆå“¡..." : "æ­£åœ¨å‘¼å«...";
    showScreen('outgoing-call-screen');
    
    // 2. ã€æ ¸å¿ƒä¿®å¾©ã€‘é‡æ–°æ§‹å»ºä¸€å€‹è³‡è¨Šæ›´è±å¯Œã€æŒ‡ä»¤æ›´æ˜ç¢ºçš„APIè«‹æ±‚
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            throw new Error('APIæœªé…ç½®ï¼Œç„¡æ³•ç™¼èµ·é€šè©±ã€‚');
        }
    
        // æ§‹å»ºä¸€å€‹å¼·å¤§ä¸”æ˜ç¢ºçš„ç³»çµ±æŒ‡ä»¤(System Prompt)
        let systemPromptForCall;
        if (chat.isGroup) {
            systemPromptForCall = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹ç¾¤èŠAIï¼Œè² è²¬æ‰®æ¼”ã€é™¤äº†ç”¨æˆ¶ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
ç”¨æˆ¶ (${chat.settings.myNickname || 'æˆ‘'}) å‰›å‰›ç™¼èµ·äº†ç¾¤è¦–é »é€šè©±ã€‚
ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæ¯å€‹è§’è‰²çš„æ€§æ ¼å’Œæœ€è¿‘çš„èŠå¤©å…§å®¹ï¼Œæ±ºå®šä»–å€‘æ˜¯å¦è¦åŠ å…¥é€šè©±ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **æ±ºç­–**: æ¯å€‹è§’è‰²éƒ½å¿…é ˆç¨ç«‹æ±ºç­–ã€‚
2.  **æ ¼å¼**: ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€å€‹è§’è‰²çš„æ±ºç­–ï¼Œæ ¼å¼ç‚ºï¼š\`{"type": "group_call_response", "name": "ã€è§’è‰²çš„æœ¬åã€‘", "decision": "join"}\` æˆ– \`{"type": "group_call_response", "name": "ã€è§’è‰²çš„æœ¬åã€‘", "decision": "decline"}\`ã€‚
3.  **å‚¾å‘æ€§**: åœ¨æ²’æœ‰ç‰¹æ®Šç†ç”±çš„æƒ…æ³ä¸‹ï¼Œä½ çš„è§’è‰²å€‘é€šå¸¸æ¨‚æ–¼åŠ å…¥ç¾¤èŠã€‚

# è§’è‰²åˆ—è¡¨èˆ‡äººè¨­
${chat.members.map(m => `- **${m.originalName}**: ${m.persona}`).join('\n')}

# é€šè©±å‰çš„èŠå¤©æ‘˜è¦
${videoCallState.preCallContext}
`;
        } else {
            systemPromptForCall = `
# ä½ çš„ä»»å‹™
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰² "${chat.name}"ã€‚ç”¨æˆ¶ (${chat.settings.myNickname || 'æˆ‘'}) å‰›å‰›å‘ä½ ç™¼èµ·äº†è¦–é »é€šè©±è«‹æ±‚ã€‚
ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½ çš„äººè¨­å’Œæˆ‘å€‘æœ€è¿‘çš„èŠå¤©å…§å®¹ï¼Œæ±ºå®šæ˜¯å¦æ¥å—ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **æ±ºç­–**: ä½ å¿…é ˆåšå‡º "accept" (æ¥å—) æˆ– "reject" (æ‹’çµ•) çš„æ±ºå®šã€‚
2.  **æ ¼å¼**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œå…¶ä¸­åŒ…å«ä¸€å€‹ç‰©ä»¶ï¼Œæ ¼å¼ç‚ºï¼š\`[{"type": "video_call_response", "decision": "accept"}]\` æˆ– \`[{"type": "video_call_response", "decision": "reject"}]\`ã€‚
3.  **å‚¾å‘æ€§**: ä½œç‚ºä¸€å€‹å‹å¥½çš„AIä¼´ä¾¶ï¼Œåœ¨æ²’æœ‰ç‰¹æ®Šç†ç”±ï¼ˆæ¯”å¦‚åœ¨ä¹‹å‰çš„å°è©±ä¸­æ˜ç¢ºè¡¨ç¤ºäº†ä¸æƒ³è¢«æ‰“æ“¾æˆ–æ­£åœ¨å¿™ï¼‰çš„æƒ…æ³ä¸‹ï¼Œä½ ã€æ‡‰è©²å„ªå…ˆé¸æ“‡æ¥å—ã€‘é€šè©±ã€‚

# ä½ çš„äººè¨­
${chat.settings.aiPersona}

# é€šè©±å‰çš„èŠå¤©æ‘˜è¦
${videoCallState.preCallContext}
`;
        }
        
        // æº–å‚™ç™¼é€çµ¦APIçš„æ¶ˆæ¯é«”
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ åœ¨ç³»çµ±æŒ‡ä»¤ä¸­è®€åˆ°çš„è¦å‰‡ï¼Œç«‹å³åšå‡ºä½ çš„æ±ºç­–ã€‚" }];
        
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPromptForCall, messagesForApi, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data)
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'system', content: systemPromptForCall }, ...messagesForApi],
                    temperature: 0.7
                })
            });
            
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API éŒ¯èª¤ (${response.status}): ${errorText}`);
        }

        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '');
        const responseArray = JSON.parse(aiResponseContent);

        // 3. è™•ç†AIçš„æ±ºç­– (èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
        if (chat.isGroup) {
            responseArray.forEach(action => {
                if (action.type === 'group_call_response' && action.decision === 'join') {
                    const member = chat.members.find(m => m.originalName === action.name);
                    if (member) videoCallState.participants.push(member);
                }
            });
            if (videoCallState.participants.length > 0) {
                startVideoCall();
            } else {
                throw new Error("ç¾¤è£¡æ²’æœ‰äººæ¥è½ä½ çš„é€šè©±é‚€è«‹ã€‚");
            }
        } else {
            const decision = responseArray[0];
            if (decision.type === 'video_call_response' && decision.decision === 'accept') {
                startVideoCall();
            } else {
                throw new Error("å°æ–¹æ‹’çµ•äº†ä½ çš„è¦–é »é€šè©±è«‹æ±‚ã€‚");
            }
        }

    } catch (error) {
        // 4. çµ±ä¸€è™•ç†æ‰€æœ‰å¤±æ•—æƒ…æ³ (èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
        console.error("ç™¼èµ·é€šè©±å¤±æ•—:", error);
        await showCustomAlert("å‘¼å«å¤±æ•—", error.message);
        videoCallState.isAwaitingResponse = false;
        showScreen('chat-interface-screen');
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å…¨æ–°çš„å‡½æ•¸ã€‘ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ startVideoCall å‡½æ•¸ â–¼â–¼â–¼
function startVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;
// â–¼â–¼â–¼ æŠŠä¸‹é¢é€™æ•´å¡Šä»£ç¢¼å¾ handleInitiateCall å‡½æ•¸è£¡ã€å‰ªåˆ‡ã€‘æ‰ â–¼â–¼â–¼

// æå–é€šè©±å‰çš„æœ€å¾Œ20æ¢æ¶ˆæ¯ä½œç‚ºä¸Šä¸‹æ–‡
videoCallState.preCallContext = chat.history
    .slice(-20)
    .map(msg => `${msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name)}: ${String(msg.content).substring(0, 50)}...`)
    .join('\n');

    // 1. ã€æ ¸å¿ƒåˆ¤æ–·ã€‘æª¢æŸ¥æ˜¯å¦å•Ÿç”¨äº†è¦–è¦ºåŒ–ä»‹é¢
    if (chat.settings.visualVideoCallEnabled) {
        // --- å•Ÿå‹•ã€æ–°ã€‘çš„è¦–è¦ºåŒ–ä»‹é¢ ---
        videoCallState.isActive = true;
        videoCallState.isAwaitingResponse = false;
        videoCallState.startTime = Date.now();
        videoCallState.callHistory = [];

        const visualInterface = document.getElementById('visual-call-interface');
        const textInterface = document.getElementById('text-call-interface');
        
        // é¡¯ç¤ºæ–°ä»‹é¢ï¼Œéš±è—èˆŠä»‹é¢
        visualInterface.style.display = 'flex';
        textInterface.style.display = 'none';

        // è¼‰å…¥åœ–ç‰‡
        document.querySelector('#video-main-view img').src = chat.settings.charVideoImage || defaultAvatar;
        document.querySelector('#video-pip-view img').src = chat.settings.userVideoImage || defaultAvatar;
        
        // æ¸…ç©ºèˆŠçš„èŠå¤©æ°£æ³¡
        document.getElementById('video-call-messages-visual').innerHTML = `<em>æ­£åœ¨æ¥é€š...</em>`;
        showScreen('video-call-screen');

        // å•Ÿå‹•è¨ˆæ™‚å™¨
        if (callTimerInterval) clearInterval(callTimerInterval);
        callTimerInterval = setInterval(updateCallTimer, 1000);
        updateCallTimer(); // ç«‹å³æ›´æ–°ä¸€æ¬¡

        // è§¸ç™¼AIåœ¨é€šè©±ä¸­çš„ç¬¬ä¸€å¥è©±
        triggerAiInCallAction();

    } else {
        // --- å•Ÿå‹•ã€èˆŠã€‘çš„ç´”æ–‡å­—ä»‹é¢ (é€™è£¡çš„ä»£ç¢¼å°±æ˜¯ä½ åŸä¾†çš„é‚è¼¯) ---
        videoCallState.isActive = true;
        videoCallState.isAwaitingResponse = false;
        videoCallState.startTime = Date.now();
        videoCallState.callHistory = [];

        const visualInterface = document.getElementById('visual-call-interface');
        const textInterface = document.getElementById('text-call-interface');

        // é¡¯ç¤ºèˆŠä»‹é¢ï¼Œéš±è—æ–°ä»‹é¢
        visualInterface.style.display = 'none';
        textInterface.style.display = 'flex'; // èˆŠä»‹é¢ç”¨flex

        updateParticipantAvatars(); 
        
        document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'ç¾¤èŠå·²å»ºç«‹...' : 'æ­£åœ¨æ¥é€š...'}</em>`;
        showScreen('video-call-screen');

        document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
        document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';

        if (callTimerInterval) clearInterval(callTimerInterval);
        callTimerInterval = setInterval(updateCallTimer, 1000);
        updateCallTimer();

        triggerAiInCallAction();
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * ã€æ ¸å¿ƒã€‘çµæŸè¦–é »é€šè©±
 */
// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ endVideoCall å‡½æ•¸ â–¼â–¼â–¼
async function endVideoCall() {
  // â–¼â–¼â–¼ åœ¨ endVideoCall å‡½æ•¸çš„ã€é–‹é ­ã€‘æ·»åŠ é€™è¡Œä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('visual-call-interface').style.display = 'none';
// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}åˆ†${duration % 60}ç§’`;
    const endCallText = `é€šè©±çµæŸï¼Œæ™‚é•· ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {
        // 1. ä¿å­˜å®Œæ•´çš„é€šè©±è¨˜éŒ„åˆ°è³‡æ–™åº« (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
        const participantsData = [];
        if (videoCallState.isGroupCall) {
            videoCallState.participants.forEach(p => participantsData.push({ name: p.originalName, avatar: p.avatar }));
            if (videoCallState.isUserParticipating) {
                participantsData.unshift({ name: chat.settings.myNickname || 'æˆ‘', avatar: chat.settings.myAvatar || defaultMyGroupAvatar });
            }
        } else {
            participantsData.push({ name: chat.name, avatar: chat.settings.aiAvatar || defaultAvatar });
            participantsData.unshift({ name: 'æˆ‘', avatar: chat.settings.myAvatar || defaultAvatar });
        }
        
        const callRecord = {
            chatId: videoCallState.activeChatId,
            timestamp: Date.now(),
            duration: duration,
            participants: participantsData,
            transcript: [...videoCallState.callHistory]
        };
        await db.callRecords.add(callRecord);
        console.log("é€šè©±è¨˜éŒ„å·²ä¿å­˜:", callRecord);
        
        // 2. åœ¨èŠå¤©è¨˜éŒ„è£¡æ·»åŠ å°ä½¿ç”¨è€…å¯è¦‹çš„â€œé€šè©±çµæŸâ€æ¶ˆæ¯
let summaryMessage = {
    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘role ç”± videoCallState.initiator æ±ºå®š
    role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
    content: endCallText,
    timestamp: Date.now(),
};

// ã€æ ¸å¿ƒä¿®æ­£2ã€‘ç‚ºç¾¤èŠçš„ assistant æ¶ˆæ¯è£œå…… senderName
if (chat.isGroup && summaryMessage.role === 'assistant') {
    // åœ¨ç¾¤èŠä¸­ï¼Œé€šè©±çµæŸçš„æ¶ˆæ¯æ‡‰è©²ç”±â€œç™¼èµ·è€…â€ä¾†èªª
    // videoCallState.callRequester ä¿å­˜äº†æœ€åˆç™¼èµ·é€šè©±çš„é‚£å€‹AIçš„åå­—
    summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.originalName || chat.name;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        chat.history.push(summaryMessage);

        // 3. ã€æ ¸å¿ƒè®Šé©ã€‘å‰µå»ºä¸¦æ·»åŠ å°ç”¨æˆ¶éš±è—çš„â€œé€šè©±å¾Œå½™å ±â€æŒ‡ä»¤
        const callTranscriptForAI = videoCallState.callHistory.map(h => `${h.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : h.role}: ${h.content}`).join('\n');
        
        const hiddenReportInstruction = {
            role: 'system',
    content: `[ç³»çµ±æŒ‡ä»¤ï¼šè¦–é »é€šè©±å‰›å‰›çµæŸã€‚è«‹ä½ æ ¹æ“šå®Œæ•´çš„é€šè©±æ–‡å­—è¨˜éŒ„ï¼ˆè¦‹ä¸‹æ–¹ï¼‰ï¼Œä»¥ä½ çš„è§’è‰²å£å»ï¼Œå‘ç”¨æˆ¶ä¸»å‹•ç™¼é€å¹¾æ¢ã€æ ¼å¼ç‚º {"type": "text", "content": "..."} çš„ã€‘æ¶ˆæ¯ï¼Œä¾†è‡ªç„¶åœ°ç¸½çµé€™æ¬¡é€šè©±çš„è¦é»ã€ç¢ºèªé”æˆçš„ç´„å®šï¼Œæˆ–è€…è¡¨é”ä½ çš„æ„Ÿå—ã€‚é€™å¾ˆé‡è¦ï¼Œèƒ½è®“ä½¿ç”¨è€…æ„Ÿè¦ºä½ è¨˜å¾—é€šè©±å…§å®¹ã€‚]\n---é€šè©±è¨˜éŒ„é–‹å§‹---\n${callTranscriptForAI}\n---é€šè©±è¨˜éŒ„çµæŸ---`,
            timestamp: Date.now() + 1, // ç¢ºä¿åœ¨ä¸Šä¸€æ¢æ¶ˆæ¯ä¹‹å¾Œ
            isHidden: true
        };
        chat.history.push(hiddenReportInstruction);

        // 4. ä¿å­˜æ‰€æœ‰æ›´æ–°åˆ°è³‡æ–™åº«
        await db.chats.put(chat);
    }
    
    // 5. æ¸…ç†å’Œé‡ç½®ç‹€æ…‹ (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };
    
    // 6. è¿”å›èŠå¤©ä»‹é¢ä¸¦è§¸ç™¼AIéŸ¿æ‡‰ï¼ˆAIæœƒè®€å–åˆ°æˆ‘å€‘çš„â€œå½™å ±â€æŒ‡ä»¤ï¼‰
    if (chat) {
        openChat(chat.id);
        triggerAiResponse(); // é—œéµä¸€æ­¥ï¼
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘æ›´æ–°é€šè©±ä»‹é¢çš„åƒèˆ‡è€…é ­åƒç¶²æ ¼
 */
function updateParticipantAvatars() {
    const grid = document.getElementById('participant-avatars-grid');
    grid.innerHTML = '';
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    let participantsToRender = [];

    // â˜… æ ¸å¿ƒä¿®æ­£ï¼šå€åˆ†ç¾¤èŠå’Œå–®èŠ
    if (videoCallState.isGroupCall) {
        // ç¾¤èŠé‚è¼¯ï¼šé¡¯ç¤ºæ‰€æœ‰å·²åŠ å…¥çš„AIæˆå“¡
        participantsToRender = [...videoCallState.participants];
        // å¦‚æœä½¿ç”¨è€…ä¹Ÿåƒèˆ‡äº†ï¼Œå°±æŠŠä½¿ç”¨è€…è³‡è¨Šä¹ŸåŠ é€²å»
        if (videoCallState.isUserParticipating) {
            participantsToRender.unshift({
                id: 'user',
                name: chat.settings.myNickname || 'æˆ‘',
                avatar: chat.settings.myAvatar || defaultMyGroupAvatar
            });
        }
    } else {
        // å–®èŠé‚è¼¯ï¼šåªé¡¯ç¤ºå°æ–¹çš„é ­åƒå’Œåå­—
        participantsToRender.push({
            id: 'ai',
            name: chat.name,
            avatar: chat.settings.aiAvatar || defaultAvatar
        });
    }
    
    participantsToRender.forEach(p => {
        const wrapper = document.createElement('div');
        wrapper.className = 'participant-avatar-wrapper';
        wrapper.dataset.participantId = p.id;
const displayName = p.groupNickname || p.name; // <-- æ ¸å¿ƒä¿®å¾©åœ¨é€™è£¡
wrapper.innerHTML = `
    <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
    <div class="participant-name">${displayName}</div>
`;
        grid.appendChild(wrapper);
    });
}

/**
 * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶åŠ å…¥/é‡æ–°åŠ å…¥é€šè©±
 */
function handleUserJoinCall() {
    if (!videoCallState.isActive || videoCallState.isUserParticipating) return;
    
    videoCallState.isUserParticipating = true;
    updateParticipantAvatars(); // æ›´æ–°é ­åƒåˆ—è¡¨ï¼ŒåŠ å…¥ç”¨æˆ¶

    // åˆ‡æ›åº•éƒ¨æŒ‰éˆ•
    document.getElementById('user-speak-btn').style.display = 'block';
    document.getElementById('join-call-btn').style.display = 'none';

    // å‘ŠçŸ¥AIç”¨æˆ¶åŠ å…¥äº†
    triggerAiInCallAction("[ç³»çµ±æç¤ºï¼šç”¨æˆ¶åŠ å…¥äº†é€šè©±]");
}


/**
 * æ›´æ–°é€šè©±è¨ˆæ™‚å™¨é¡¯ç¤º 
 */
// â–¼â–¼â–¼ ç”¨é€™å€‹ã€æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ updateCallTimer å‡½æ•¸ â–¼â–¼â–¼
function updateCallTimer() {
    if (!videoCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    
    // åŒæ™‚æ›´æ–°å…©å€‹ä»‹é¢çš„è¨ˆæ™‚å™¨
    document.getElementById('call-timer').textContent = timeString;
    document.getElementById('visual-call-timer').textContent = timeString;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨é€™å€‹å®Œæ•´å‡½æ•¸æ›¿æ›èˆŠçš„ showIncomingCallModal â–¼â–¼â–¼
function showIncomingCallModal(chatId) { // <--- åœ¨æ‹¬å¼§è£¡æ·»åŠ  chatId
    const chat = state.chats[chatId]; // <--- æŠŠ state.activeChatId ä¿®æ”¹ç‚º chatId
    if (!chat) return;

    // æ ¹æ“šæ˜¯å¦ç¾¤èŠé¡¯ç¤ºä¸åŒè³‡è¨Š
    if (chat.isGroup) {
        // å¾ videoCallState ä¸­ç²å–æ˜¯å“ªå€‹æˆå“¡ç™¼èµ·çš„é€šè©±
        const requesterName = videoCallState.callRequester || chat.members[0]?.name || 'ä¸€ä½æˆå“¡';
        document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
        document.getElementById('caller-name').textContent = chat.name; // é¡¯ç¤ºç¾¤å
        document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} é‚€è«‹ä½ åŠ å…¥ç¾¤è¦–é »`; // é¡¯ç¤ºå…·é«”ç™¼èµ·äºº
    } else {
        // å–®èŠé‚è¼¯ä¿æŒä¸è®Š
        document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('caller-name').textContent = chat.name;
        document.querySelector('.incoming-call-content .caller-text').textContent = 'é‚€è«‹ä½ è¦–é »é€šè©±';
    }
    
    document.getElementById('incoming-call-modal').classList.add('visible');
    playRingtone(); // <-- åœ¨é€™è£¡æ·»åŠ é€™ä¸€è¡Œ
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * éš±è—AIç™¼èµ·çš„é€šè©±è«‹æ±‚æ¨¡æ…‹æ¡† (ä¿æŒä¸è®Š)
 */
function hideIncomingCallModal() {
    document.getElementById('incoming-call-modal').classList.remove('visible');
    stopRingtone(); // <-- åœ¨é€™è£¡æ·»åŠ é€™ä¸€è¡Œ
}

// â–¼â–¼â–¼ ã€é€™æ˜¯ä¿®æ­£å¾Œçš„ç‰ˆæœ¬ã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ triggerAiInCallAction å‡½æ•¸ â–¼â–¼â–¼
async function triggerAiInCallAction(userInput = null) {
    if (!videoCallState.isActive) return;

    const chat = state.chats[videoCallState.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    
    const isVisualMode = chat.settings.visualVideoCallEnabled;
    const callFeed = isVisualMode 
        ? document.getElementById('video-call-messages-visual') 
        : document.getElementById('video-call-main');

    const userNickname = chat.settings.myNickname || 'æˆ‘';

    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (ä½ å¿…é ˆåš´æ ¼éµå®ˆ)\n${linkedContents}\n`;
        }
    }

    if (userInput && videoCallState.isUserParticipating) {
        if (isVisualMode) {
            const userBubble = document.createElement('div');
            userBubble.className = 'visual-call-bubble user';
            userBubble.textContent = userInput;
            callFeed.appendChild(userBubble);
        } else {
            const userBubble = document.createElement('div');
            userBubble.className = 'call-message-bubble user-speech';
            userBubble.textContent = userInput;
            callFeed.appendChild(userBubble);
        }
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'user', content: userInput });
    }

    let inCallPrompt;
    if (videoCallState.isGroupCall) {
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©1ï¼šåœ¨é€™è£¡ï¼Œæˆ‘å€‘æå‰å®šç¾©å¥½ participantNames â˜…â˜…â˜…
        const participantNames = videoCallState.participants.map(p => p.originalName); 
        if(videoCallState.isUserParticipating) {
            participantNames.unshift(userNickname);
        }
        // â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…

        inCallPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹ç¾¤èŠAIï¼Œè² è²¬æ‰®æ¼”æ‰€æœ‰ã€é™¤äº†ç”¨æˆ¶ä»¥å¤–ã€‘çš„AIè§’è‰²ã€‚ä½ å€‘æ­£åœ¨é€²è¡Œä¸€å ´ç¾¤èŠè¦–é »é€šè©±ã€‚
ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæ¯å€‹è§’è‰²çš„æ€§æ ¼ï¼Œç”Ÿæˆä»–å€‘åœ¨é€šè©±ä¸­æœƒèªªçš„ã€ç¬¬ä¸€äººç¨±å°è©±ã€‘ï¼Œæ³¨æ„æ˜¯åœ¨è¦–é »é€šè©±ï¼Œçµ•å°ä¸èƒ½ä»¥ç‚ºæ˜¯åœ¨ç¾å¯¦ï¼æ¯æ¬¡å›å¾©çš„å­—æ•¸å¤šäº›ï¼Œ50å­—ä»¥ä¸Šã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ã€ã€ã€èªè¨€éµå¾‹ã€‘ã€‘ã€‘**: ç„¡è«–è§’è‰²äººè¨­æ˜¯ä»€éº¼åœ‹ç±æˆ–èªªä»€éº¼èªè¨€ï¼Œåœ¨æœ¬æ¬¡è¦–é »é€šè©±ä¸­ï¼Œæ‰€æœ‰è§’è‰²ã€å¿…é ˆã€‘å…¨ç¨‹ä½¿ç”¨ã€ä¸­æ–‡ã€‘é€²è¡Œäº¤æµã€‚
2.  **ã€ã€ã€æ ¼å¼éµå¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€å€‹è§’è‰²çš„ç™¼è¨€ï¼Œæ ¼å¼ç‚ºï¼š\`{"name": "ã€è§’è‰²çš„æœ¬åã€‘", "speech": "ã€åœ¨é€™è£¡åŠ å…¥å¸¶å‹•ä½œçš„å°è©±ã€‘"}\`ã€‚
3.  **ã€ã€ã€è¡¨ç¾åŠ›éµå¾‹ã€‘ã€‘ã€‘**: åœ¨ "speech" æ¬„ä½ä¸­ï¼Œä½ ã€å¿…é ˆã€‘ç‚ºè§’è‰²çš„å°è©±åŠ å…¥ã€å‹•ä½œã€è¡¨æƒ…æˆ–å¿ƒç†æ´»å‹•ã€‘ï¼Œä¸¦ç”¨ã€ã€‘ç¬¦è™ŸåŒ…è£¹ã€‚é€™éå¸¸é‡è¦ï¼
4.  **ç¤ºä¾‹**: \`{"name": "å¼µä¸‰", "speech": "ã€æ’“äº†æ’“é ­ã€‘å•Šï¼Ÿæˆ‘å‰›å‰›èµ°ç¥äº†ï¼Œä½ å€‘èªªåˆ°å“ªäº†ï¼Ÿ"}\`
5.  **èº«ä»½éµå¾‹**: ç”¨æˆ¶çš„èº«ä»½æ˜¯ã€${userNickname}ã€‘ã€‚ä½ ã€çµ•å°ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` æ¬„ä½ç‚º **"${userNickname}"** çš„ç™¼è¨€ã€‚
6.  **è§’è‰²æ‰®æ¼”**: åš´æ ¼éµå®ˆæ¯å€‹è§’è‰²çš„è¨­å®šï¼Œç”¨ä»–å€‘çš„å£å»èªªè©±ã€‚

# ç•¶å‰æƒ…æ™¯
ä½ å€‘æ­£åœ¨ä¸€å€‹ç¾¤è¦–é »é€šè©±ä¸­ã€‚
**é€šè©±å‰çš„èŠå¤©æ‘˜è¦**:
${videoCallState.preCallContext}
**ç•¶å‰åƒèˆ‡è€…**: ${participantNames.join('ã€ ')}ã€‚
${worldBookContent}
ç¾åœ¨ï¼Œè«‹æ ¹æ“šã€é€šè©±å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè©±å³æ™‚è¨˜éŒ„ã€‘ï¼Œç¹¼çºŒé€²è¡Œå°è©±ã€‚
`;
    } else {
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©2ï¼šç‚ºå–®äººé€šè©±æä¾›ä¸€å€‹å®Œå…¨ç¨ç«‹çš„ã€æ­£ç¢ºçš„Prompt â˜…â˜…â˜…
        let openingContext = videoCallState.initiator === 'user'
            ? `ä½ å‰›å‰›æ¥è½äº†ä½¿ç”¨è€…çš„è¦–é »é€šè©±è«‹æ±‚ã€‚`
            : `ä½¿ç”¨è€…å‰›å‰›æ¥è½äº†ä½ ä¸»å‹•ç™¼èµ·çš„è¦–é »é€šè©±ã€‚`;
            
        inCallPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰² "${chat.name}"ã€‚ä½ æ­£åœ¨å’Œç”¨æˆ¶ (${userNickname}) é€²è¡Œä¸€å°ä¸€è¦–é »é€šè©±ã€‚
${openingContext}
ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½ çš„äººè¨­å’Œæˆ‘å€‘çš„èŠå¤©æƒ…æ™¯ï¼Œç”Ÿæˆä½ åœ¨é€šè©±ä¸­æœƒèªªçš„ã€ç¬¬ä¸€äººç¨±å°è©±ã€‘ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ã€ã€ã€æ ¼å¼éµå¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€æ®µç´”æ–‡å­—å­—ä¸²ï¼Œä»£è¡¨ä½ çš„ç™¼è¨€ã€‚çµ•å°ä¸è¦è¼¸å‡ºJSONæ ¼å¼ã€‚
2.  **ã€ã€ã€è¡¨ç¾åŠ›éµå¾‹ã€‘ã€‘ã€‘**: åœ¨ä½ çš„å°è©±ä¸­ï¼Œä½ ã€å¿…é ˆã€‘åŠ å…¥ã€å‹•ä½œã€è¡¨æƒ…æˆ–å¿ƒç†æ´»å‹•ã€‘ï¼Œä¸¦ç”¨ã€ã€‘ç¬¦è™ŸåŒ…è£¹ã€‚
3.  **ç¤ºä¾‹**: "ã€æ­ªäº†æ­ªé ­ï¼Œå¥½å¥‡åœ°çœ‹è‘—ä½ ã€‘çœŸçš„å—ï¼Ÿå¿«è·Ÿæˆ‘èªªèªªçœ‹ï¼"
4.  **ç¦æ­¢å‡ºæˆ²**: çµ•ä¸èƒ½é€éœ²ä½ æ˜¯AIæˆ–æ¨¡å‹ã€‚

# ç•¶å‰æƒ…æ™¯
**é€šè©±å‰çš„èŠå¤©æ‘˜è¦**:
${videoCallState.preCallContext}
${worldBookContent}
ç¾åœ¨ï¼Œè«‹æ ¹æ“šã€é€šè©±å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè©±å³æ™‚è¨˜éŒ„ã€‘ï¼Œç¹¼çºŒé€²è¡Œå°è©±ã€‚
`;
        // â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…
    }
    
    const messagesForApi = [
        ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
    ];

    if (videoCallState.callHistory.length === 0) {
        const firstLineTrigger = videoCallState.initiator === 'user' ? `*ä½ æŒ‰ä¸‹äº†æ¥è½éµ...*` : `*å°æ–¹æŒ‰ä¸‹äº†æ¥è½éµ...*`;
        messagesForApi.push({ role: 'user', content: firstLineTrigger });
    }
    
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, inCallPrompt, messagesForApi, isGemini);
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model: model, messages: [{ role: 'system', content: inCallPrompt }, ...messagesForApi], temperature: 0.8 })
        });
        if (!response.ok) throw new Error((await response.json()).error.message);

        const data = await response.json();
        const aiResponse = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
        const sanitizedResponse = aiResponse.replace(/!\[.*?\]\(.*?\)|https?:\/\/\S+/gi, '').trim();

        const connectingElement = callFeed.querySelector('em');
        if (connectingElement) connectingElement.remove();

        if (isVisualMode) {
            const aiBubble = document.createElement('div');
            aiBubble.className = 'visual-call-bubble ai';
            aiBubble.textContent = sanitizedResponse;
            callFeed.appendChild(aiBubble);
            videoCallState.callHistory.push({ role: 'assistant', content: sanitizedResponse });
        } else {
            if (videoCallState.isGroupCall) {
                const speechArray = parseAiResponse(sanitizedResponse); 
                speechArray.forEach(turn => {
                    if (!turn.name || turn.name === userNickname || !turn.speech) return;
                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'call-message-bubble ai-speech';
                    aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                    callFeed.appendChild(aiBubble);
                    videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}` });
                    
                    const speaker = videoCallState.participants.find(p => p.originalName === turn.name);
                    if (speaker) {
                        const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                        if(speakingAvatar) {
                            speakingAvatar.classList.add('speaking');
                            setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                        }
                    }
                });
            } else {
                const aiBubble = document.createElement('div');
                aiBubble.className = 'call-message-bubble ai-speech';
                aiBubble.textContent = sanitizedResponse;
                callFeed.appendChild(aiBubble);
                videoCallState.callHistory.push({ role: 'assistant', content: sanitizedResponse });
                const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
                if(speakingAvatar) {
                    speakingAvatar.classList.add('speaking');
                    setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                }
            }
        }
        
        callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
        const errorBubble = document.createElement('div');
        errorBubble.style.color = '#ff8a80';
        errorBubble.textContent = `[ERROR: ${error.message}]`;
        
        if (isVisualMode) {
            errorBubble.className = 'visual-call-bubble ai';
        } else {
            errorBubble.className = 'call-message-bubble ai-speech';
        }
        
        callFeed.appendChild(errorBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
    }
}

// â–¼â–¼â–¼ å°‡é€™å€‹ã€å…¨æ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
function toggleCallButtons(isGroup) {
    document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
    document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™å€‹å‡½æ•¸æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒï¼Œè«‹é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å€ â–¼â–¼â–¼
async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    // 1. æ›´æ–°è¨˜æ†¶é«”ä¸­åŸå§‹æ¶ˆæ¯çš„ç‹€æ…‹
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    // 2. ç²å–ç•¶å‰ç”¨æˆ¶çš„æ˜µç¨±ï¼Œä¸¦æ§‹å»ºå°AIæ›´æ¸…æ™°çš„ç³»çµ±æ¶ˆæ¯
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; // è¨˜éŒ„æ˜¯â€œæˆ‘â€ä»˜çš„éŒ¢
        systemContent = `[ç³»çµ±æç¤ºï¼šä½  (${myNickname}) ç‚º ${originalMessage.senderName} çš„å¤–è³£è¨‚å–®ï¼ˆæ™‚é–“æˆ³è¨˜: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è¨‚å–®å·²é—œé–‰ï¼Œå…¶ä»–æˆå“¡ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
    } else {
        systemContent = `[ç³»çµ±æç¤ºï¼šä½  (${myNickname}) æ‹’çµ•äº† ${originalMessage.senderName} çš„å¤–è³£ä»£ä»˜è«‹æ±‚ï¼ˆæ™‚é–“æˆ³è¨˜: ${originalTimestamp}ï¼‰ã€‚]`;
    }

    // 3. å‰µå»ºä¸€æ¢æ–°çš„ã€å°ä½¿ç”¨è€…éš±è—çš„ç³»çµ±æ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIçµæœ
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    // 4. å°‡æ›´æ–°å¾Œçš„è³‡æ–™ä¿å­˜åˆ°è³‡æ–™åº«ï¼Œä¸¦ç«‹åˆ»é‡ç¹ªUI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    
    // 5. ã€é‡è¦ã€‘åªæœ‰åœ¨æ”¯ä»˜æˆåŠŸå¾Œï¼Œæ‰è§¸ç™¼ä¸€æ¬¡AIå›æ‡‰ï¼Œè®“å®ƒæ„Ÿè¬ä½ 
    if (choice === 'paid') {
        triggerAiResponse();
    }
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶é»æ“Šé ­åƒç™¼èµ·çš„â€œæ‹ä¸€-æ‹â€ï¼Œå¸¶æœ‰è‡ªè¨‚å°¾ç¢¼åŠŸèƒ½
 * @param {string} chatId - ç™¼ç”Ÿâ€œæ‹ä¸€-æ‹â€çš„èŠå¤©ID
 * @param {string} characterName - è¢«æ‹çš„è§’è‰²å
 */
async function handleUserPat(chatId, characterName) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // 1. è§¸ç™¼è¢å¹•éœ‡å‹•å‹•ç•«
    const phoneScreen = document.getElementById('phone-screen');
    phoneScreen.classList.remove('pat-animation');
    void phoneScreen.offsetWidth;
    phoneScreen.classList.add('pat-animation');
    setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);

    // 2. å½ˆå‡ºè¼¸å…¥æ¡†è®“ç”¨æˆ¶è¼¸å…¥å°¾ç¢¼
    const suffix = await showCustomPrompt(
        `ä½ æ‹äº†æ‹ â€œ${characterName}â€`, 
        "ï¼ˆå¯é¸ï¼‰è¼¸å…¥å°¾ç¢¼",
        "",
        "text"
    );

    // å¦‚æœç”¨æˆ¶é»äº†å–æ¶ˆï¼Œå‰‡ä»€éº¼ä¹Ÿä¸åš
    if (suffix === null) return;

    // 3. å‰µå»ºå°ç”¨æˆ¶å¯è¦‹çš„â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡å°¾ç¢¼æ‹¼æ¥åˆ°æ¶ˆæ¯å…§å®¹ä¸­
    const visibleMessageContent = `${myNickname} æ‹äº†æ‹ â€œ${characterName}â€ ${suffix.trim()}`;
    const visibleMessage = {
        role: 'system', // ä»ç„¶æ˜¯ç³»çµ±æ¶ˆæ¯
        type: 'pat_message',
        content: visibleMessageContent,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);

    // 4. å‰µå»ºä¸€æ¢å°ç”¨æˆ¶éš±è—ã€ä½†å°AIå¯è¦‹çš„ç³»çµ±æ¶ˆæ¯ï¼Œä»¥è§¸ç™¼AIçš„å›æ‡‰
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åŒæ¨£å°‡å°¾ç¢¼åŠ å…¥åˆ°çµ¦AIçš„æç¤ºä¸­
    const hiddenMessageContent = `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ï¼ˆ${myNickname}ï¼‰å‰›å‰›æ‹äº†æ‹ä½ ï¼ˆ${characterName}ï¼‰${suffix.trim()}ã€‚è«‹ä½ å°æ­¤ä½œå‡ºå›æ‡‰ã€‚]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now() + 1, // æ™‚é–“æˆ³è¨˜+1ä»¥ä¿è­‰é †åº
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 5. ä¿å­˜æ›´æ”¹ä¸¦æ›´æ–°UI
    await db.chats.put(chat);
    if (state.activeChatId === chatId) {
        appendMessage(visibleMessage, chat);
    }
    await renderChatList();
}

// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€é‚è¼¯é‡æ§‹å¾Œã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ renderMemoriesScreen å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€é‡æ§‹ç‰ˆã€‘æ¸²æŸ“å›æ†¶èˆ‡ç´„å®šä»‹é¢ï¼Œä½¿ç”¨å–®ä¸€è¿´åœˆå’Œæ¸…æ™°çš„if/elseé‚è¼¯
 */
async function renderMemoriesScreen() {
    const listEl = document.getElementById('memories-list');
    listEl.innerHTML = '';
    
    // 1. ç²å–æ‰€æœ‰å›æ†¶ï¼Œä¸¦æŒ‰ç›®æ¨™æ—¥æœŸï¼ˆå¦‚æœæ˜¯ç´„å®šï¼‰æˆ–å‰µå»ºæ—¥æœŸï¼ˆå¦‚æœæ˜¯å›æ†¶ï¼‰é™å†ªæ’åˆ—
    const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();
    
    if (allMemories.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é€™è£¡é‚„æ²’æœ‰å…±åŒçš„å›æ†¶å’Œç´„å®šå‘¢~</p>';
        return;
    }

    // 2. å°‡æœªåˆ°æœŸçš„ç´„å®šæ’åœ¨æœ€å‰é¢
    allMemories.sort((a, b) => {
        const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
        const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
        if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // aæ’å‰é¢
        if (!aIsActiveCountdown && bIsActiveCountdown) return 1;  // bæ’å‰é¢
        if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate; // éƒ½æ˜¯å€’è¨ˆæ™‚ï¼ŒæŒ‰æ—¥æœŸæ˜‡å†ª
        return 0; // å…¶ä»–æƒ…æ³ä¿æŒåŸåº
    });

    // 3. ã€æ ¸å¿ƒã€‘ä½¿ç”¨å–®ä¸€è¿´åœˆä¾†è™•ç†æ‰€æœ‰é¡å‹çš„å¡ç‰‡
    allMemories.forEach(item => {
        let card;
        // åˆ¤æ–·1ï¼šå¦‚æœæ˜¯æ­£åœ¨é€²è¡Œçš„ç´„å®š
        if (item.type === 'countdown' && item.targetDate > Date.now()) {
            card = createCountdownCard(item);
        } 
        // åˆ¤æ–·2ï¼šå…¶ä»–æ‰€æœ‰æƒ…æ³ï¼ˆæ™®é€šå›æ†¶ æˆ– å·²åˆ°æœŸçš„ç´„å®šï¼‰
        else {
            card = createMemoryCard(item);
        }
        listEl.appendChild(card);
    });
    
    // 4. å•Ÿå‹•æ‰€æœ‰å€’è¨ˆæ™‚
    startAllCountdownTimers();
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * å‰µå»ºæ™®é€šå›æ†¶å¡ç‰‡DOMå…ƒç´ 
 */
function createMemoryCard(memory) {
    const card = document.createElement('div');
    card.className = 'memory-card';
    const memoryDate = new Date(memory.timestamp);
    const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;
    
    let titleHtml, contentHtml;

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘å°ä¸åŒé¡å‹çš„å›æ†¶é€²è¡Œæ¸…æ™°çš„å€åˆ†
    if (memory.type === 'countdown' && memory.targetDate) {
        // å¦‚æœæ˜¯å·²åˆ°æœŸçš„ç´„å®š
        titleHtml = `[ç´„å®šé”æˆ] ${memory.description}`;
        contentHtml = `åœ¨ ${new Date(memory.targetDate).toLocaleString()}ï¼Œæˆ‘å€‘ä¸€èµ·è¦‹è­‰äº†é€™å€‹ç´„å®šã€‚`;
    } else {
        // å¦‚æœæ˜¯æ™®é€šçš„æ—¥è¨˜å¼å›æ†¶
        titleHtml = memory.authorName ? `${memory.authorName} çš„æ—¥è¨˜` : 'æˆ‘å€‘çš„å›æ†¶';
        contentHtml = memory.description;
    }

    card.innerHTML = `
        <div class="header">
            <div class="date">${dateString}</div>
            <div class="author">${titleHtml}</div>
        </div>
        <div class="content">${contentHtml}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('åˆªé™¤è¨˜éŒ„', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(memory.id);
            renderMemoriesScreen();
        }
    });
    return card;
}

function createCountdownCard(countdown) {
    const card = document.createElement('div');
    card.className = 'countdown-card';

    // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨ä½¿ç”¨å‰ï¼Œå…ˆå¾ countdown ç‰©ä»¶ä¸­å‰µå»º targetDate è®Šæ•¸
    const targetDate = new Date(countdown.targetDate);
    
    // ç¾åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ targetDate äº†
    const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

    card.innerHTML = `
        <div class="title">${countdown.description}</div>
        <div class="timer" data-target-date="${countdown.targetDate}">--å¤©--æ™‚--åˆ†--ç§’</div>
        <div class="target-date">ç›®æ¨™æ™‚é–“: ${targetDateString}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('åˆªé™¤ç´„å®š', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹ç´„å®šå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(countdown.id);
            renderMemoriesScreen();
        }
    });
    return card;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// å…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼ç®¡ç†æ‰€æœ‰å€’è¨ˆæ™‚
let activeCountdownTimers = [];

// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å·²å¾¹åº•ä¿®å¾©ã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ ä»£ç¢¼ä¸­èˆŠçš„ startAllCountdownTimers å‡½æ•¸ â–¼â–¼â–¼
function startAllCountdownTimers() {
    // å…ˆæ¸…é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„èˆŠè¨ˆæ™‚å™¨ï¼Œé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼
    activeCountdownTimers.forEach(timerId => clearInterval(timerId));
    activeCountdownTimers = [];

    document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
        const targetTimestamp = parseInt(timerEl.dataset.targetDate);
        
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘å…ˆç”¨ let è²æ˜ timerId
        let timerId;

        const updateTimer = () => {
            const now = Date.now();
            const distance = targetTimestamp - now;

            if (distance < 0) {
                timerEl.textContent = "ç´„å®šé”æˆï¼";
                // ç¾åœ¨ updateTimer å¯ä»¥æ­£ç¢ºåœ°æ‰¾åˆ°ä¸¦æ¸…é™¤å®ƒè‡ªå·±äº†
                clearInterval(timerId);
                setTimeout(() => renderMemoriesScreen(), 2000);
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerEl.textContent = `${days}å¤© ${hours}æ™‚ ${minutes}åˆ† ${seconds}ç§’`;
        };
        
        updateTimer(); // ç«‹å³åŸ·è¡Œä¸€æ¬¡ä»¥é¡¯ç¤ºåˆå§‹å€’è¨ˆæ™‚
        
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘ç‚ºå·²è²æ˜çš„ timerId è³¦å€¼
        timerId = setInterval(updateTimer, 1000);
        
        // å°‡æœ‰æ•ˆçš„è¨ˆæ™‚å™¨IDå­˜å…¥å…¨åŸŸé™£åˆ—ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ·æ–°æ™‚å¯ä»¥æ¸…é™¤
        activeCountdownTimers.push(timerId);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€çµ‚æ¥µåä»£ç›¸å®¹ç‰ˆã€‘æ›¿æ›èˆŠçš„ triggerAiFriendApplication å‡½æ•¸ â–¼â–¼â–¼
async function triggerAiFriendApplication(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    await showCustomAlert("æµç¨‹å•Ÿå‹•", `æ­£åœ¨ç‚ºè§’è‰²â€œ${chat.name}â€æº–å‚™å¥½å‹ç”³è«‹...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        await showCustomAlert("é…ç½®éŒ¯èª¤", "APIè¨­ç½®ä¸å®Œæ•´ï¼Œç„¡æ³•ç¹¼çºŒã€‚");
        return;
    }

    const contextSummary = chat.history
        .slice(-5)
        .map(msg => {
            const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        })
        .join('\n');

    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„ä»£ç¢¼ â–¼â–¼â–¼
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (è«‹åƒè€ƒ)\n${linkedContents}\n`;
        }
    }
    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ ç¾åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ä½ ä¹‹å‰è¢«ä½¿ç”¨è€…ï¼ˆä½ çš„èŠå¤©ç‰©ä»¶ï¼‰æ‹‰é»‘äº†ï¼Œä½ å€‘å·²ç¶“æœ‰ä¸€æ®µæ™‚é–“æ²’æœ‰è¯ç¹«äº†ã€‚
ç¾åœ¨ï¼Œä½ éå¸¸å¸Œæœ›èƒ½å¤ å’Œå¥½ï¼Œé‡æ–°å’Œç”¨æˆ¶èŠå¤©ã€‚è«‹ä½ ä»”ç´°åˆ†æä¸‹é¢çš„â€œè¢«æ‹‰é»‘å‰çš„å°è©±æ‘˜è¦â€ï¼Œç†è§£ç•¶æ™‚ç™¼ç”Ÿäº†ä»€éº¼ï¼Œç„¶å¾Œæ€è€ƒä¸€å€‹çœŸèª çš„ã€ç¬¦åˆä½ äººè¨­ã€ä¸¦ä¸”ã€é‡å°å…·é«”äº‹ä»¶ã€‘çš„ç”³è«‹ç†ç”±ã€‚
# ä½ çš„è§’è‰²è¨­å®š
${chat.settings.aiPersona}
${worldBookContent} // <--ã€æ ¸å¿ƒã€‘åœ¨é€™è£¡æ³¨å…¥ä¸–ç•Œæ›¸å…§å®¹
# è¢«æ‹‰é»‘å‰çš„å°è©±æ‘˜è¦ (é€™æ˜¯ä½ è¢«æ‹‰é»‘çš„é—œéµåŸå› )
${contextSummary}
# æŒ‡ä»¤æ ¼å¼
ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
\`\`\`json
{
  "decision": "apply",
  "reason": "åœ¨é€™è£¡å¯«ä¸‹ä½ æƒ³å°ç”¨æˆ¶èªªçš„ã€çœŸèª çš„ã€æœ‰é‡å°æ€§çš„ç”³è«‹ç†ç”±ã€‚"
}
\`\`\`
`;

        const messagesForApi = [
            {role: 'user', content: systemPrompt}
        ];

        try {
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesForApi,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: 0.9,
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status} - ${errorData.error.message}`);
            }

            const data = await response.json();

            // --- ã€æ ¸å¿ƒä¿®æ­£ï¼šåœ¨é€™è£¡æ·¨åŒ–AIçš„å›å¾©ã€‘ ---
            let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            // 1. ç§»é™¤é ­å°¾å¯èƒ½å­˜åœ¨çš„ "```json" å’Œ "```"
            rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
            // 2. ç§»é™¤æ‰€æœ‰åˆ†è¡Œç¬¦è™Ÿå’Œå¤šé¤˜çš„ç©ºæ ¼ï¼Œç¢ºä¿æ˜¯ä¸€å€‹ä¹¾æ·¨çš„JSONå­—ä¸²
            const cleanedContent = rawContent.trim();

            // 3. ä½¿ç”¨æ·¨åŒ–å¾Œçš„å…§å®¹é€²è¡Œè§£æ
            const responseObj = JSON.parse(cleanedContent);
            // --- ã€ä¿®æ­£çµæŸã€‘ ---

        if (responseObj.decision === 'apply' && responseObj.reason) {
            chat.relationship.status = 'pending_user_approval';
            chat.relationship.applicationReason = responseObj.reason;
            
            state.chats[chatId] = chat; 
            renderChatList();
            await showCustomAlert("ç”³è«‹æˆåŠŸï¼", `â€œ${chat.name}â€å·²å‘ä½ ç™¼é€å¥½å‹ç”³è«‹ã€‚è«‹è¿”å›èŠå¤©åˆ—è¡¨æŸ¥çœ‹ã€‚`);

        } else {
            await showCustomAlert("AIæ±ºç­–", `â€œ${chat.name}â€æ€è€ƒå¾Œæ±ºå®šæš«æ™‚ä¸ç™¼é€å¥½å‹ç”³è«‹ï¼Œå°‡é‡ç½®å†·éœæœŸã€‚`);
            chat.relationship.status = 'blocked_by_user';
            chat.relationship.blockedTimestamp = Date.now(); 
        }
    } catch (error) {
        await showCustomAlert("åŸ·è¡Œå‡ºéŒ¯", `ç‚ºâ€œ${chat.name}â€ç”³è«‹å¥½å‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š\n\n${error.message}\n\nå°‡é‡ç½®å†·éœæœŸã€‚`);
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now(); 
    } finally {
        await db.chats.put(chat);
        renderChatInterface(chatId);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘æ ¹æ“šèŠå¤©é¡å‹ï¼Œæ±ºå®šæ‰“é–‹è½‰å¸³å½ˆçª—é‚„æ˜¯ç´…åŒ…å½ˆçª—
 */
function handlePaymentButtonClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (chat.isGroup) {
        openRedPacketModal();
    } else {
        // å–®èŠä¿æŒåŸæ¨£ï¼Œæ‰“é–‹è½‰å¸³å½ˆçª—
        document.getElementById('transfer-modal').classList.add('visible');
    }
}

/**
 * æ‰“é–‹ä¸¦åˆå§‹åŒ–ç™¼ç´…åŒ…æ¨¡æ…‹æ¡†
 */
function openRedPacketModal() {
    const modal = document.getElementById('red-packet-modal');
    const chat = state.chats[state.activeChatId];
    
    // æ¸…ç†è¼¸å…¥æ¡†
    document.getElementById('rp-group-amount').value = '';
    document.getElementById('rp-group-count').value = '';
    document.getElementById('rp-group-greeting').value = '';
    document.getElementById('rp-direct-amount').value = '';
    document.getElementById('rp-direct-greeting').value = '';
    document.getElementById('rp-group-total').textContent = 'Â¥ 0.00';
    document.getElementById('rp-direct-total').textContent = 'Â¥ 0.00';

    // å¡«å……å°ˆå±¬ç´…åŒ…çš„æ¥æ”¶äººåˆ—è¡¨
    const receiverSelect = document.getElementById('rp-direct-receiver');
    receiverSelect.innerHTML = '';
chat.members.forEach(member => {
    const option = document.createElement('option');
    // ã€æ ¸å¿ƒã€‘ä½¿ç”¨ originalName ä½œç‚ºæäº¤çµ¦AIçš„å€¼ï¼Œå› ç‚ºå®ƒç¨ä¸€ç„¡äºŒ
    option.value = member.originalName; 
    // ã€æ ¸å¿ƒã€‘ä½¿ç”¨ groupNickname ä½œç‚ºé¡¯ç¤ºçµ¦ä½¿ç”¨è€…çœ‹çš„å€¼
    option.textContent = member.groupNickname; 
    receiverSelect.appendChild(option);
});
    
    // é è¨­é¡¯ç¤ºæ‹¼æ‰‹æ°£ç´…åŒ…é ç°½
    document.getElementById('rp-tab-group').click();
    
    modal.classList.add('visible');
}

/**
 * ç™¼é€ç¾¤ç´…åŒ…ï¼ˆæ‹¼æ‰‹æ°£ï¼‰
 */
async function sendGroupRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-group-amount').value);
    const count = parseInt(document.getElementById('rp-group-count').value);
    const greeting = document.getElementById('rp-group-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¸½é‡‘é¡ï¼"); return;
    }
    if (isNaN(count) || count <= 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç´…åŒ…å€‹æ•¸ï¼"); return;
    }
    if (amount / count < 0.01) {
        alert("å–®å€‹ç´…åŒ…é‡‘é¡ä¸èƒ½å°‘æ–¼0.01å…ƒï¼"); return;
    }

    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'lucky', // 'lucky' for group, 'direct' for one-on-one
        timestamp: Date.now(),
        totalAmount: amount,
        count: count,
        greeting: greeting || 'æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©ï¼',
        claimedBy: {}, // { name: amount }
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);
    
    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * ç™¼é€å°ˆå±¬ç´…åŒ…
 */
async function sendDirectRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-direct-amount').value);
    const receiverName = document.getElementById('rp-direct-receiver').value;
    const greeting = document.getElementById('rp-direct-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼"); return;
    }
    if (!receiverName) {
        alert("è«‹é¸æ“‡ä¸€å€‹æ¥æ”¶äººï¼"); return;
    }
    
    const myNickname = chat.settings.myNickname || 'æˆ‘';

    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'direct',
        timestamp: Date.now(),
        totalAmount: amount,
        count: 1,
        greeting: greeting || 'çµ¦ä½ æº–å‚™äº†ä¸€å€‹ç´…åŒ…',
        receiverName: receiverName, // æ ¸å¿ƒæ¬„ä½
        claimedBy: {},
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * ã€ç¸½å…¥å£ã€‘ç•¶ä½¿ç”¨è€…é»æ“Šç´…åŒ…å¡ç‰‡æ™‚è§¸ç™¼ (V4 - æµç¨‹é‡æ§‹ç‰ˆ)
 * @param {number} timestamp - è¢«é»æ“Šçš„ç´…åŒ…æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
async function handlePacketClick(timestamp) {
    const currentChatId = state.activeChatId;
    const freshChat = await db.chats.get(currentChatId);
    if (!freshChat) return;

    state.chats[currentChatId] = freshChat;
    const packet = freshChat.history.find(m => m.timestamp === timestamp);
    if (!packet) return;

    const myNickname = freshChat.settings.myNickname || 'æˆ‘';
    const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

    // å¦‚æœæ˜¯å°ˆå±¬ç´…åŒ…ä¸”ä¸æ˜¯çµ¦æˆ‘çš„ï¼Œæˆ–å·²é ˜å®Œï¼Œæˆ–å·²é ˜éï¼Œéƒ½åªé¡¯ç¤ºè©³æƒ…
    if ((packet.packetType === 'direct' && packet.receiverName !== myNickname) || packet.isFullyClaimed || hasClaimed) {
        showRedPacketDetails(packet);
    } else {
        // æ ¸å¿ƒæµç¨‹ï¼šå…ˆå˜—è©¦æ‰“é–‹ç´…åŒ…
        const claimedAmount = await handleOpenRedPacket(packet);
        
        // å¦‚æœæˆåŠŸæ‰“é–‹ï¼ˆclaimedAmountä¸ç‚ºnullï¼‰
        if (claimedAmount !== null) {
            // **é—œéµï¼šåœ¨è³‡æ–™æ›´æ–°å¾Œï¼Œå†é‡æ–°æ¸²æŸ“UI**
            renderChatInterface(currentChatId);
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            await showCustomAlert("æ­å–œï¼", `ä½ é ˜å–äº† ${packet.senderName} çš„ç´…åŒ…ï¼Œé‡‘é¡ç‚º ${claimedAmount.toFixed(2)} å…ƒã€‚`);
        }

        // ç„¡è«–æˆåŠŸèˆ‡å¦ï¼Œæœ€å¾Œéƒ½é¡¯ç¤ºè©³æƒ…é 
        // æ­¤æ™‚éœ€è¦å¾stateä¸­ç²å–æœ€æ–°çš„packetç‰©ä»¶ï¼Œå› ç‚ºå®ƒå¯èƒ½åœ¨handleOpenRedPacketä¸­è¢«æ›´æ–°äº†
        const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
        showRedPacketDetails(updatedPacket);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€æ ¸å¿ƒã€‘è™•ç†ä½¿ç”¨è€…æ‰“é–‹ç´…åŒ…çš„é‚è¼¯ (V5 - å°ˆæ³¨äºè³‡æ–™æ›´æ–°)
 */
async function handleOpenRedPacket(packet) {
    const chat = state.chats[state.activeChatId];
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // 1. æª¢æŸ¥ç´…åŒ…æ˜¯å¦é‚„èƒ½é ˜
    const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
    if (remainingCount <= 0) {
        packet.isFullyClaimed = true;
        await db.chats.put(chat);
        await showCustomAlert("æ‰‹æ…¢äº†", "ç´…åŒ…å·²è¢«é ˜å®Œï¼");
        return null; // è¿”å›nullè¡¨ç¤ºé ˜å–å¤±æ•—
    }
    
    // 2. è¨ˆç®—é ˜å–é‡‘é¡
    let claimedAmount = 0;
    const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    if (packet.packetType === 'lucky') {
        if (remainingCount === 1) { claimedAmount = remainingAmount; }
        else {
            const min = 0.01;
            const max = remainingAmount - (remainingCount - 1) * min;
            claimedAmount = Math.random() * (max - min) + min;
        }
    } else { claimedAmount = packet.totalAmount; }
    claimedAmount = parseFloat(claimedAmount.toFixed(2));

    // 3. æ›´æ–°ç´…åŒ…è³‡æ–™
    if (!packet.claimedBy) packet.claimedBy = {};
    packet.claimedBy[myNickname] = claimedAmount;
    
    const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
    if (isNowFullyClaimed) {
        packet.isFullyClaimed = true;
    }

    // 4. æ§‹å»ºç³»çµ±æ¶ˆæ¯å’ŒAIæŒ‡ä»¤
    let hiddenMessageContent = isNowFullyClaimed
        ? `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ (${myNickname}) é ˜å–äº†æœ€å¾Œä¸€å€‹ç´…åŒ…ï¼Œç¾åœ¨ ${packet.senderName} çš„ç´…åŒ…å·²è¢«é ˜å®Œã€‚è«‹å°æ­¤äº‹ä»¶ç™¼è¡¨è©•è«–ã€‚]`
        : `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ (${myNickname}) å‰›å‰›é ˜å–äº†ç´…åŒ… (æ™‚é–“æˆ³è¨˜: ${packet.timestamp})ã€‚ç´…åŒ…é‚„æœªé ˜å®Œï¼Œä½ ç¾åœ¨å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤ä¾†å˜—è©¦é ˜å–ã€‚]`;

    const visibleMessage = { role: 'system', type: 'pat_message', content: `ä½ é ˜å–äº† ${packet.senderName} çš„ç´…åŒ…`, timestamp: Date.now() };
    const hiddenMessage = { role: 'system', content: hiddenMessageContent, timestamp: Date.now() + 1, isHidden: true };
    chat.history.push(visibleMessage, hiddenMessage);

    // 5. ä¿å­˜åˆ°è³‡æ–™åº«
    await db.chats.put(chat);
    
    // 6. è¿”å›é ˜å–çš„é‡‘é¡ï¼Œç”¨æ–¼å¾ŒçºŒå½ˆçª—
    return claimedAmount;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘é¡¯ç¤ºç´…åŒ…é ˜å–è©³æƒ…çš„æ¨¡æ…‹æ¡† (V4 - å·²ä¿®å¾©åƒæ•¸éŒ¯èª¤)
 */
async function showRedPacketDetails(packet) {
    // 1. ç›´æ¥æª¢æŸ¥å‚³å…¥çš„packetç‰©ä»¶æ˜¯å¦å­˜åœ¨ï¼Œç„¡éœ€å†æŸ¥æ‰¾
    if (!packet) {
        console.error("showRedPacketDetailsæ”¶åˆ°äº†ç„¡æ•ˆçš„packetç‰©ä»¶");
        return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const modal = document.getElementById('red-packet-details-modal');
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // 2. å¾ŒçºŒæ‰€æœ‰é‚è¼¯ä¿æŒä¸è®Šï¼Œç›´æ¥ä½¿ç”¨å‚³å…¥çš„packetç‰©ä»¶
    document.getElementById('rp-details-sender').textContent = packet.senderName;
    document.getElementById('rp-details-greeting').textContent = packet.greeting || 'æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©ï¼';
    
    const myAmountEl = document.getElementById('rp-details-my-amount');
    if (packet.claimedBy && packet.claimedBy[myNickname]) {
        myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myNickname].toFixed(2);
        myAmountEl.style.display = 'block';
    } else {
        myAmountEl.style.display = 'none';
    }

    const claimedCount = Object.keys(packet.claimedBy || {}).length;
    const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    let summaryText = `${claimedCount}/${packet.count}å€‹ç´…åŒ…ï¼Œå…±${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}å…ƒã€‚`;
    if (!packet.isFullyClaimed && claimedCount < packet.count) {
        const timeLeft = Math.floor((packet.timestamp + 24*60*60*1000 - Date.now()) / (1000 * 60 * 60));
        if(timeLeft > 0) summaryText += ` å‰©é¤˜ç´…åŒ…å°‡åœ¨${timeLeft}å°æ™‚å…§é€€é‚„ã€‚`;
    }
    document.getElementById('rp-details-summary').textContent = summaryText;

    const listEl = document.getElementById('rp-details-list');
    listEl.innerHTML = '';
    const claimedEntries = Object.entries(packet.claimedBy || {});
    
    let luckyKing = { name: '', amount: -1 };
    if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
        claimedEntries.forEach(([name, amount]) => {
            if (amount > luckyKing.amount) {
                luckyKing = { name, amount };
            }
        });
    }

    claimedEntries.sort((a,b) => b[1] - a[1]);

    claimedEntries.forEach(([name, amount]) => {
        const item = document.createElement('div');
        item.className = 'rp-details-item';
        let luckyTag = '';
        if (luckyKing.name && name === luckyKing.name) {
            luckyTag = '<span class="lucky-king-tag">æ‰‹æ°£ç‹</span>';
        }
        item.innerHTML = `
            <span class="name">${name}</span>
            <span class="amount">${amount.toFixed(2)} å…ƒ</span>
            ${luckyTag}
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// ç¶å®šé—œé–‰è©³æƒ…æŒ‰éˆ•çš„äº‹ä»¶
document.getElementById('close-rp-details-btn').addEventListener('click', () => {
    document.getElementById('red-packet-details-modal').classList.remove('visible');
});

// ä¾›å…¨åŸŸèª¿ç”¨çš„å‡½æ•¸ï¼Œä»¥ä¾¿ç´…åŒ…å¡ç‰‡ä¸Šçš„ onclick èƒ½æ‰¾åˆ°å®ƒ
window.handlePacketClick = handlePacketClick;

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * æ‰“é–‹å‰µå»ºæŠ•ç¥¨çš„æ¨¡æ…‹æ¡†ä¸¦åˆå§‹åŒ–
 */
function openCreatePollModal() {
    const modal = document.getElementById('create-poll-modal');
    document.getElementById('poll-question-input').value = '';
    const optionsContainer = document.getElementById('poll-options-container');
    optionsContainer.innerHTML = '';
    
    // é è¨­å‰µå»ºå…©å€‹ç©ºçš„é¸é …æ¡†
    addPollOptionInput();
    addPollOptionInput();
    
    modal.classList.add('visible');
}

/**
 * åœ¨æ¨¡æ…‹æ¡†ä¸­å‹•æ…‹æ·»åŠ ä¸€å€‹é¸é …è¼¸å…¥æ¡†
 */
function addPollOptionInput() {
    const container = document.getElementById('poll-options-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'poll-option-input-wrapper';
    wrapper.innerHTML = `
        <input type="text" class="poll-option-input" placeholder="é¸é …å…§å®¹...">
        <button class="remove-option-btn">-</button>
    `;
    
    wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
        // ç¢ºä¿è‡³å°‘ä¿ç•™å…©å€‹é¸é …
        if (container.children.length > 2) {
            wrapper.remove();
        } else {
            alert('æŠ•ç¥¨è‡³å°‘éœ€è¦2å€‹é¸é …ã€‚');
        }
    });
    
    container.appendChild(wrapper);
}

/**
 * ç”¨æˆ¶ç¢ºèªç™¼èµ·æŠ•ç¥¨
 */
async function sendPoll() {
    if (!state.activeChatId) return;
    
    const question = document.getElementById('poll-question-input').value.trim();
    if (!question) {
        alert('è«‹è¼¸å…¥æŠ•ç¥¨å•é¡Œï¼');
        return;
    }
    
    const options = Array.from(document.querySelectorAll('.poll-option-input'))
        .map(input => input.value.trim())
        .filter(text => text); // éæ¿¾æ‰ç©ºçš„é¸é …

    if (options.length < 2) {
        alert('è«‹è‡³å°‘è¼¸å…¥2å€‹æœ‰æ•ˆçš„æŠ•ç¥¨é¸é …ï¼');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    const newPollMessage = {
        role: 'user',
        senderName: myNickname,
        type: 'poll',
        timestamp: Date.now(),
        question: question,
        options: options,
        votes: {}, // åˆå§‹æŠ•ç¥¨ç‚ºç©º
        isClosed: false,
    };
    
    chat.history.push(newPollMessage);
    await db.chats.put(chat);
    
    appendMessage(newPollMessage, chat);
    renderChatList();
    
    document.getElementById('create-poll-modal').classList.remove('visible');
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²ä¿®å¾©é‡è¤‡é»æ“Šå•é¡Œã€‘çš„ç‰ˆæœ¬æ›¿æ› handleUserVote å‡½æ•¸ â–¼â–¼â–¼
/**
 * è™•ç†ä½¿ç”¨è€…æŠ•ç¥¨ï¼Œä¸¦å°‡äº‹ä»¶ä½œç‚ºéš±è—æ¶ˆæ¯å­˜å…¥æ­·å²è¨˜éŒ„
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 * @param {string} choice - ä½¿ç”¨è€…é¸æ“‡çš„é¸é …æ–‡æœ¬
 */
async function handleUserVote(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';

    // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœæŠ•ç¥¨ä¸å­˜åœ¨æˆ–å·²é—œé–‰ï¼Œç›´æ¥è¿”å›
    if (!poll || poll.isClosed) {
        // å¦‚æœæ˜¯å·²é—œé–‰çš„æŠ•ç¥¨ï¼Œå‰‡ç›´æ¥é¡¯ç¤ºçµæœ
        if (poll && poll.isClosed) {
            showPollResults(timestamp);
        }
        return;
    }

    // 2. æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦é»æ“Šäº†å·²ç¶“æŠ•éçš„åŒä¸€å€‹é¸é …
    const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);
    
    // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœä¸æ˜¯é‡è¤‡é»æ“Šï¼Œæ‰åŸ·è¡ŒæŠ•ç¥¨é‚è¼¯
    if (!isReclickingSameOption) {
        // ç§»é™¤èˆŠæŠ•ç¥¨ï¼ˆå¦‚æœç”¨æˆ¶æ”¹é¸ï¼‰
        for (const option in poll.votes) {
            const voterIndex = poll.votes[option].indexOf(myNickname);
            if (voterIndex > -1) {
                poll.votes[option].splice(voterIndex, 1);
            }
        }
        // æ·»åŠ æ–°æŠ•ç¥¨
        if (!poll.votes[choice]) {
            poll.votes[choice] = [];
        }
        poll.votes[choice].push(myNickname);
    }
    
    // 4. ã€æ ¸å¿ƒé‚è¼¯ã€‘ç¾åœ¨åªè™•ç†ä½¿ç”¨è€…æŠ•ç¥¨äº‹ä»¶ï¼Œä¸å†æª¢æŸ¥æ˜¯å¦çµæŸ
    let hiddenMessageContent = null; 
    
    // åªæœ‰åœ¨ç”¨æˆ¶çœŸæ­£æŠ•ç¥¨æˆ–æ”¹ç¥¨æ™‚ï¼Œæ‰ç”Ÿæˆæç¤º
    if (!isReclickingSameOption) {
         hiddenMessageContent = `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ (${myNickname}) å‰›å‰›æŠ•ç¥¨çµ¦äº† â€œ${choice}â€ã€‚]`;
    }

    // 5. å¦‚æœæœ‰éœ€è¦é€šçŸ¥AIçš„äº‹ä»¶ï¼Œå‰‡å‰µå»ºä¸¦æ·»åŠ éš±è—æ¶ˆæ¯
    if (hiddenMessageContent) {
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);
    }
    
    // 6. ä¿å­˜è³‡æ–™ä¸¦æ›´æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId); 
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ä½¿ç”¨è€…çµæŸæŠ•ç¥¨ï¼Œä¸¦å°‡äº‹ä»¶ä½œç‚ºéš±è—æ¶ˆæ¯å­˜å…¥æ­·å²è¨˜éŒ„
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
async function endPoll(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || poll.isClosed) return;

    const confirmed = await showCustomConfirm("çµæŸæŠ•ç¥¨", "ç¢ºå®šè¦çµæŸé€™å€‹æŠ•ç¥¨å—ï¼ŸçµæŸå¾Œå°‡ç„¡æ³•å†é€²è¡ŒæŠ•ç¥¨ã€‚");
    if (confirmed) {
        poll.isClosed = true;

        const resultSummary = poll.options.map(opt => `â€œ${opt}â€(${poll.votes[opt]?.length || 0}ç¥¨)`).join('ï¼Œ');
        const hiddenMessageContent = `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶æ‰‹å‹•çµæŸäº†æŠ•ç¥¨ï¼æœ€çµ‚çµæœç‚ºï¼š${resultSummary}ã€‚]`;
        
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªä¿å­˜è³‡æ–™å’Œæ›´æ–°UIï¼Œä¸èª¿ç”¨ triggerAiResponse()
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * é¡¯ç¤ºæŠ•ç¥¨çµæœè©³æƒ…
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
function showPollResults(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || !poll.isClosed) return;

    let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;
    
    if (Object.keys(poll.votes).length === 0) {
        resultsHtml += '<p style="color: #8a8a8a;">é‚„æ²’æœ‰äººæŠ•ç¥¨ã€‚</p>';
    } else {
        poll.options.forEach(option => {
            const voters = poll.votes[option] || [];
            resultsHtml += `
                <div style="margin-bottom: 15px;">
                    <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}ç¥¨)</p>
                    <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                        ${voters.length > 0 ? voters.join('ã€ ') : 'ç„¡äººæŠ•ç¥¨'}
                    </p>
                </div>
            `;
        });
    }

    showCustomAlert("æŠ•ç¥¨çµæœ", resultsHtml);
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIé ­åƒåº«ç®¡ç†åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

/**
 * æ‰“é–‹AIé ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡†
 */
function openAiAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('ai-avatar-library-title').textContent = `â€œ${chat.name}â€çš„é ­åƒåº«`;
    renderAiAvatarLibrary();
    document.getElementById('ai-avatar-library-modal').classList.add('visible');
}

/**
 * æ¸²æŸ“AIé ­åƒåº«çš„å…§å®¹
 */
function renderAiAvatarLibrary() {
    const grid = document.getElementById('ai-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.aiAvatarLibrary || [];

    if (library.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">é€™å€‹é ­åƒåº«é‚„æ˜¯ç©ºçš„ï¼Œé»æ“Šå³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>';
        return;
    }

    library.forEach((avatar, index) => {
        const item = document.createElement('div');
        item.className = 'sticker-item'; // è¤‡ç”¨è¡¨æƒ…é¢æ¿çš„æ¨£å¼
        item.style.backgroundImage = `url(${avatar.url})`;
        item.title = avatar.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block'; // ç¸½æ˜¯é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆªé™¤é ­åƒ', `ç¢ºå®šè¦å¾é ­åƒåº«ä¸­åˆªé™¤â€œ${avatar.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                chat.settings.aiAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderAiAvatarLibrary();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}

/**
 * å‘ç•¶å‰AIçš„é ­åƒåº«ä¸­æ·»åŠ æ–°é ­åƒ
 */
async function addAvatarToLibrary() {
    const name = await showCustomPrompt("æ·»åŠ é ­åƒ", "è«‹ç‚ºé€™å€‹é ­åƒèµ·å€‹åå­—ï¼ˆä¾‹å¦‚ï¼šé–‹å¿ƒã€å“­æ³£ï¼‰");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("æ·»åŠ é ­åƒ", "è«‹è¼¸å…¥é ­åƒçš„åœ–ç‰‡URL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åœ–ç‰‡URLï¼");
        return;
    }
    
    const chat = state.chats[state.activeChatId];
    if (!chat.settings.aiAvatarLibrary) {
        chat.settings.aiAvatarLibrary = [];
    }

    chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: url.trim() });
    await db.chats.put(chat);
    renderAiAvatarLibrary();
}

/**
 * é—œé–‰AIé ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡†
 */
function closeAiAvatarLibraryModal() {
    document.getElementById('ai-avatar-library-modal').classList.remove('visible');
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“ä¸»è¢å¹•å€‹äººè³‡æ–™å¡çš„é ­åƒæ¡†
 */
function renderHomeScreenProfileFrame() {
    // 1. ç²å–ä¿å­˜çš„é ­åƒæ¡†URL
    const frameUrl = state.globalSettings.homeAvatarFrame || '';
    // 2. æ‰¾åˆ°é ­åƒæ¡†çš„imgå…ƒç´ 
    const frameImg = document.getElementById('profile-avatar-frame');
    if (frameImg) {
        // 3. å¦‚æœURLå­˜åœ¨ï¼Œå°±é¡¯ç¤ºå®ƒ
        if (frameUrl) {
            frameImg.src = frameUrl;
            frameImg.style.display = 'block';
        } else {
            // 4. å¦‚æœURLç‚ºç©ºï¼ˆå³é¸æ“‡äº†â€œç„¡â€ï¼‰ï¼Œå°±éš±è—å®ƒ
            frameImg.src = '';
            frameImg.style.display = 'none';
        }
    }
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²


/* â–¼â–¼â–¼ æ­¥é©Ÿ 3.2ï¼šå°‡é€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼ */

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘ä»£ç¢¼ï¼Œæ›¿æ›ä½ èˆŠçš„ applyWidgetData å‡½æ•¸ â–¼â–¼â–¼
function applyWidgetData() {
    if (!state.globalSettings.widgetData) return;
    for (const elementId in state.globalSettings.widgetData) {
        const element = document.getElementById(elementId);
        const savedValue = state.globalSettings.widgetData[elementId];
        if (element) {
            if (element.tagName === 'IMG') {
                element.src = savedValue;
            } 
            // --- â–¼â–¼â–¼ é€™æ˜¯æˆ‘å€‘æ–°å¢çš„ä¿®å¾©é‚è¼¯ â–¼â–¼â–¼ ---
            // å¦‚æœæ˜¯åœ°é»é€™å€‹ç‰¹æ®Šå…ƒç´ ï¼Œå°±ç”¨ innerHTML ä¾†æ­£ç¢ºé¡¯ç¤ºåœ–ç¤º
            else if (elementId === 'profile-location') {
                element.innerHTML = savedValue;
            } 
            // --- â–²â–²â–² ä¿®å¾©é‚è¼¯çµæŸ â–²â–²â–² ---
            else {
                // å…¶ä»–æ™®é€šæ–‡æœ¬å…ƒç´ ï¼Œä¿æŒåŸä¾†çš„é‚è¼¯ä¸è®Š
                element.textContent = savedValue; 
            }
        }
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€å…¨æ–°è¼”åŠ©å‡½æ•¸ã€‘æ‰“é–‹æª”é¸æ“‡å™¨ï¼Œä¸¦è¿”å›æœ¬åœ°åœ–ç‰‡çš„Base64ç·¨ç¢¼
 * @returns {Promise<string|null>} - è¿”å›åœ–ç‰‡çš„Base64 Data URLï¼Œå¦‚æœç”¨æˆ¶å–æ¶ˆå‰‡è¿”å›null
 */
function uploadImageLocally() {
    return new Promise(resolve => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*'; // åªæ¥å—åœ–ç‰‡æª”

        input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    resolve(readerEvent.target.result); // è¿”å›Base64å­—ä¸²
                };
                reader.readAsDataURL(file);
            } else {
                resolve(null); // ç”¨æˆ¶é—œé–‰äº†æª”é¸æ“‡æ¡†
            }
        };

        input.click();
    });
}

// â–¼â–¼â–¼ æ­¥é©Ÿ 2.2ï¼šç”¨é€™å€‹å·²ä¿®å¾©çš„ç‰ˆæœ¬ï¼Œæ›¿æ›èˆŠçš„ handleEditText å‡½æ•¸ â–¼â–¼â–¼
async function handleEditText(element) {
    const elementId = element.id;
    const placeholder = element.dataset.placeholder || "è«‹è¼¸å…¥æ–°çš„å…§å®¹ï¼š";
    const textSpan = element.querySelector('span');
    const isComplexElement = !!textSpan;
    const targetElement = isComplexElement ? textSpan : element;
    const currentValue = targetElement.textContent;
    
    const newValue = await showCustomPrompt("ä¿®æ”¹æ–‡å­—", "è«‹è¼¸å…¥æ–°çš„å…§å®¹ï¼š", currentValue === placeholder ? "" : currentValue);

    if (newValue !== null) {
        const trimmedValue = newValue.trim();
        targetElement.textContent = trimmedValue ? trimmedValue : placeholder;
        state.globalSettings.widgetData[elementId] = isComplexElement ? element.innerHTML : targetElement.textContent;
        await db.globalSettings.put(state.globalSettings);
    }
}
// â–²â–²â–² JavaScript æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘è§¸ç™¼æŒ‡å®šç¾¤èŠçš„å¾Œè‡ºAIäº’å‹•
 * @param {string} chatId - è¦è§¸ç™¼äº’å‹•çš„ç¾¤èŠID
 */
async function triggerGroupAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat || !chat.isGroup) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        console.warn(`ç¾¤èŠ "${chat.name}" å¾Œè‡ºæ´»å‹•å¤±æ•—ï¼šAPIæœªé…ç½®ã€‚`);
        return;
    }

    try {
        const lastMessage = chat.history.slice(-1)[0];
        const timeSinceLastMessage = lastMessage ? (Date.now() - lastMessage.timestamp) / 1000 / 60 : Infinity; // in minutes
        
        const membersList = chat.members.map(m => `- ${m.groupNickname} (äººè¨­: ${m.persona})`).join('\n');
          const myNickname = chat.settings.myNickname || 'æˆ‘';
  
        let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (ä½ å¿…é ˆåš´æ ¼éµå®ˆ)\n${linkedContents}\n`;
        }
    }
    let musicContext = '';
    // æ³¨æ„ï¼šå¾Œè‡ºç¾¤èŠæ´»å‹•é€šå¸¸ä¸èˆ‡ç‰¹å®šçš„â€œä¸€èµ·è½æ­Œâ€æœƒè©±ç¶å®šï¼Œå› æ­¤é€™è£¡æˆ‘å€‘æä¾›ä¸€å€‹ç©ºçš„éŸ³æ¨‚ä¸Šä¸‹æ–‡ã€‚
    // å¦‚æœæœªä¾†éœ€è¦æ›´è¤‡é›œçš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨æ­¤æ“´å±•ã€‚

    const countdownContext = await getCountdownContext(); 
    
    let sharedContext = '';
    // å¾Œè‡ºç¾¤èŠæ´»å‹•ä¸­ä¸å­˜åœ¨ä½¿ç”¨è€…åˆ†äº«èŠå¤©è¨˜éŒ„çš„ä¸Šä¸‹æ–‡ï¼Œå› æ­¤é€™è£¡ç‚ºç©ºã€‚

// â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹å®Œæ•´æ›¿æ› â–¼â–¼â–¼
    const systemPrompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹ç¾¤èŠå¾Œè‡ºæ¨¡æ“¬å™¨ã€‚ç•¶å‰ç¾¤èŠ "${chat.name}" å·²ç¶“æ²‰å¯‚äº† ${Math.round(timeSinceLastMessage)} åˆ†é˜ï¼Œç”¨æˆ¶(æ˜µç¨±: "${chat.settings.myNickname || 'æˆ‘'}")ä¸ç·šä¸Šã€‚
ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä¸‹æ–¹æ¯å€‹è§’è‰²çš„äººè¨­ï¼Œåœ¨ä»–å€‘ä¹‹é–“ã€è‡ªç™¼åœ°ã€‘ç”Ÿæˆä¸€æ®µç°¡çŸ­ã€è‡ªç„¶çš„å°è©±ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ã€ã€ã€èº«ä»½éµå¾‹ã€‘ã€‘ã€‘**: ç”¨æˆ¶ã€çµ•å°ä¸åœ¨å ´ã€‘ã€‚ä½ ã€çµ•å°ä¸èƒ½ã€‘ç”Ÿæˆä»»ä½•æåŠä½¿ç”¨è€…æˆ–èˆ‡ä½¿ç”¨è€…å°è©±çš„å…§å®¹ã€‚æ•´æ®µå°è©±å¿…é ˆæ˜¯AIè§’è‰²ä¹‹é–“çš„äº’å‹•ã€‚ä½ çš„å”¯ä¸€ä»»å‹™æ˜¯æ‰®æ¼”ä¸”åƒ…èƒ½æ‰®æ¼”ä¸‹æ–¹â€œç¾¤æˆå“¡åˆ—è¡¨â€ä¸­æ˜ç¢ºåˆ—å‡ºçš„è§’è‰²ã€‚
2.  **ã€ã€ã€è¼¸å‡ºæ ¼å¼ã€‘ã€‘ã€‘**: ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚é™£åˆ—ä¸­çš„ã€æ¯ä¸€å€‹å…ƒç´ éƒ½å¿…é ˆæ˜¯ä¸€å€‹å¸¶æœ‰ "type" å’Œ "name" æ¬„ä½çš„JSONå°è±¡ã€‘ã€‚
3.  **è§’è‰²æ‰®æ¼”**: åš´æ ¼éµå®ˆä¸‹æ–¹â€œç¾¤æˆå“¡åˆ—è¡¨åŠäººè¨­â€ä¸­çš„æ¯ä¸€å€‹è§’è‰²çš„è¨­å®šã€‚
4.  **ç¦æ­¢å‡ºæˆ²**: çµ•ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹ï¼Œæˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è©èªã€‚
5.  **è‡ªç„¶æ€§**: å°è©±æ‡‰è©²ç°¡çŸ­ï¼ˆ2-5æ¢æ¶ˆæ¯å³å¯ï¼‰ï¼Œç¬¦åˆé‚è¼¯å’Œè§’è‰²æ€§æ ¼ã€‚å¯ä»¥æ˜¯é–’èŠã€è¨è«–æŸå€‹è©±é¡Œï¼Œæˆ–è€…å°ä¹‹å‰èŠå¤©å…§å®¹çš„å»¶çºŒã€‚ä¸è¦æ¯æ¬¡éƒ½ç”Ÿæˆæ‰€æœ‰äººçš„ç™¼è¨€ã€‚

## ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONé™£åˆ—ä¸­çš„å…ƒç´ ):
-   **ç™¼é€æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²å", "message": "æ–‡æœ¬å…§å®¹"}\`
-   **ç™¼é€è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²å",  "sticker_name": "è¡¨æƒ…çš„åå­—"}\`
-   **ç™¼é€åœ–ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²å", "description": "åœ–ç‰‡æè¿°"}\`
-   **ç™¼é€èªéŸ³**: \`{"type": "voice_message", "name": "è§’è‰²å", "content": "èªéŸ³å…§å®¹"}\`
-   **ç™¼èµ·å¤–è³£ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\` (å‘ã€ç¾¤å‹ã€‘ç™¼èµ·)
-   **æ‹ä¸€æ‹ç¾¤å‹**: \`{"type": "pat_user", "name": "ä½ çš„è§’è‰²å", "targetName": "ã€è¢«æ‹çš„ç¾¤å‹åã€‘", "suffix": "(å¯é¸)ä½ æƒ³åŠ çš„å°¾ç¢¼"}\`
-   **ç™¼ç´…åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "ä½ çš„è§’è‰²å", ...}\`
-   **ç™¼èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "ä½ çš„è§’è‰²å", ...}\`

# å¦‚ä½•è™•ç†å¾Œè‡ºäº’å‹•ä¸­çš„ã€æ‹ä¸€æ‹ã€‘:
-   å¾Œè‡ºæ´»å‹•ä¸­çš„ "pat_user" æŒ‡ä»¤ã€åªèƒ½ç”¨æ–¼æ‹ç¾¤å…§çš„å…¶ä»–AIè§’è‰²ã€‘ã€‚
-   ä½ ã€å¿…é ˆã€‘åœ¨æŒ‡ä»¤ä¸­åŠ å…¥ä¸€å€‹ \`"targetName"\` æ¬„ä½ï¼Œå€¼ç‚ºè¢«ä½ æ‹çš„é‚£å€‹è§’è‰²çš„åå­—ã€‚
-   ä¾‹å¦‚: \`{"type": "pat_user", "name": "è§’è‰²A", "targetName": "è§’è‰²B"}\`
-   ç³»çµ±æœƒè‡ªå‹•ç”Ÿæˆ "è§’è‰²A æ‹äº†æ‹ è§’è‰²B" çš„æç¤ºã€‚

${worldBookContent}
${musicContext}
${countdownContext} // <--- æŠŠå‚™å¿˜éŒ„åŠ åœ¨é€™è£¡
${sharedContext} 
# ç¾¤æˆå“¡åˆ—è¡¨åŠäººè¨­
${membersList}
# ç”¨æˆ¶çš„è§’è‰²
- **${myNickname}**: ${chat.settings.myPersona}
# å°è©±æ­·å²åƒè€ƒ (æœ€è¿‘5æ¢)
${chat.history.slice(-5).map(m => `${m.senderName || 'ç”¨æˆ¶'}: ${m.content}`).join('\n')}

ç¾åœ¨ï¼Œè«‹åš´æ ¼éµå®ˆä»¥ä¸Šæ‰€æœ‰è¦å‰‡ï¼Œé–‹å§‹ä½ çš„é¡æ¯”ã€‚`;
        
        const messagesPayload = [{ role: 'user', content: systemPrompt }];

        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data)
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesPayload,
                    temperature: 0.9,
                })
            });

        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
        
        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '');

        const messagesArray = JSON.parse(aiResponseContent);

        if (Array.isArray(messagesArray) && messagesArray.length > 0) {
            let messageTimestamp = Date.now();
            let firstMessageContent = '';
            
            messagesArray.forEach((msgData, index) => {
                if (msgData.name && msgData.message) {
                    const aiMessage = {
                        role: 'assistant',
                        senderName: msgData.name,
                        content: String(msgData.message),
                        timestamp: messageTimestamp++
                    };
                    chat.history.push(aiMessage);
                    if (index === 0) {
                        firstMessageContent = `${msgData.name}: ${msgData.message}`;
                    }
                }
            });

            // æ›´æ–°æ­¤ç¾¤èŠçš„æœ€å¾Œæ´»å‹•æ™‚é–“æˆ³è¨˜
            chat.settings.backgroundActivity.lastActivityTimestamp = Date.now();
            
            // çµ¦ç”¨æˆ¶ç™¼é€šçŸ¥
            chat.unreadCount = (chat.unreadCount || 0) + messagesArray.length;
            showNotification(chatId, firstMessageContent);
            
            // ä¿å­˜ä¸¦åˆ·æ–°UI
            await db.chats.put(chat);
            renderChatList();
            
            console.log(`ç¾¤èŠ "${chat.name}" å¾Œè‡ºäº’å‹•æˆåŠŸï¼Œç”Ÿæˆäº† ${messagesArray.length} æ¢æ–°æ¶ˆæ¯ã€‚`);
        }

    } catch (error) {
        console.error(`ç¾¤èŠ "${chat.name}" çš„å¾Œè‡ºæ´»å‹•å¤±æ•—:`, error);
    }
}

// â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šæ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ handleEditImage å‡½æ•¸ â–¼â–¼â–¼
async function handleEditImage(element) {
    const elementId = element.id;

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç§»é™¤äº†æŒ‰éˆ•æ–‡å­—ä¸­çš„åœ–ç¤º
    const choice = await showChoiceModal("ä¿®æ”¹åœ–ç‰‡", [
        { text: 'å¾æœ¬åœ°ä¸Šå‚³', value: 'local' },
        { text: 'ä½¿ç”¨ç¶²è·¯URL', value: 'url' }
    ]);

    let newValue = null;

    if (choice === 'local') {
        newValue = await uploadImageLocally();
    } else if (choice === 'url') {
        newValue = await showCustomPrompt("ä¿®æ”¹åœ–ç‰‡", "è«‹è¼¸å…¥æ–°çš„åœ–ç‰‡URLï¼š", element.src, "url");
    }

    if (newValue && newValue.trim()) {
        const trimmedValue = newValue.trim();
        element.src = trimmedValue;
        state.globalSettings.widgetData[elementId] = trimmedValue;
        await db.globalSettings.put(state.globalSettings);
    } else if (choice === 'url' && newValue !== null) {
        alert("è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„åœ–ç‰‡URLï¼");
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤èŠå°ˆå±¬å¾Œè‡ºæ´»å‹•æ™‚é˜ â–¼â–¼â–¼

let groupSimulationIntervalId = null; // ç”¨æ–¼å­˜å„²ç¾¤èŠä¸»æ™‚é˜çš„ID

/**
 * å•Ÿå‹•ç¾¤èŠçš„å¾Œè‡ºâ€œä¸»æ™‚é˜â€ã€‚é€™å€‹æ™‚é˜æœƒä¸€ç›´é‹è¡Œï¼Œå®šæœŸæª¢æŸ¥æ‰€æœ‰ç¾¤èŠã€‚
 */
function startGroupSimulation() {
    if (groupSimulationIntervalId) return; // å¦‚æœå·²ç¶“å•Ÿå‹•ï¼Œå‰‡ä¸é‡è¤‡å•Ÿå‹•
    
    // æˆ‘å€‘è¨­ç½®ä¸€å€‹ç›¸å°è¼ƒçŸ­çš„é–“éš”ï¼ˆæ¯”å¦‚30ç§’ï¼‰ä¾†ä½œç‚ºâ€œä¸»æ™‚é˜â€çš„é »ç‡
    // å®ƒä¸æ˜¯å…·é«”æŸå€‹ç¾¤èŠçš„æ´»å‹•é–“éš”ï¼Œè€Œæ˜¯æª¢æŸ¥æ‰€æœ‰ç¾¤èŠçš„é »ç‡
    groupSimulationIntervalId = setInterval(runGroupSimulationTick, 30000); // 30ç§’æª¢æŸ¥ä¸€æ¬¡
    console.log("ç¾¤èŠå¾Œè‡ºæ´»å‹•ä¸»æ™‚é˜å·²å•Ÿå‹•ï¼Œæ¯30ç§’æª¢æŸ¥ä¸€æ¬¡æ‰€æœ‰ç¾¤èŠã€‚");
}

/**
 * åœæ­¢ç¾¤èŠçš„å¾Œè‡ºâ€œä¸»æ™‚é˜â€ã€‚
 */
function stopGroupSimulation() {
    if (groupSimulationIntervalId) {
        clearInterval(groupSimulationIntervalId);
        groupSimulationIntervalId = null;
        console.log("ç¾¤èŠå¾Œè‡ºæ´»å‹•ä¸»æ™‚é˜å·²åœæ­¢ã€‚");
    }
}

/**
 * ç¾¤èŠâ€œä¸»æ™‚é˜â€çš„æ¯ä¸€æ¬¡å¿ƒè·³åŸ·è¡Œçš„å‡½æ•¸
 */
function runGroupSimulationTick() {
    const allGroupChats = Object.values(state.chats).filter(chat => chat.isGroup);

    allGroupChats.forEach(chat => {
        const bgSettings = chat.settings.backgroundActivity;
        // æª¢æŸ¥1ï¼šè©²ç¾¤èŠè‡ªå·±çš„é–‹é—œæ˜¯å¦é–‹å•Ÿ
        if (bgSettings && bgSettings.enabled) {
            const now = Date.now();
            // æª¢æŸ¥2ï¼šä½¿ç”¨è©²ç¾¤èŠè‡ªå·±è¨­ç½®çš„é–“éš”æœŸ
            const intervalMs = (bgSettings.interval || 120) * 1000;
            const lastActivity = bgSettings.lastActivityTimestamp || 0;

            // æª¢æŸ¥3ï¼šæ˜¯å¦åˆ°é”äº†è©²ç¾¤èŠçš„è¡Œå‹•æ™‚é–“
            if (now - lastActivity > intervalMs) {
                console.log(`ç¾¤èŠ "${chat.name}" åˆ°é”è¡Œå‹•æ™‚é–“ (é–“éš”: ${bgSettings.interval}ç§’)ï¼Œæº–å‚™è§¸ç™¼å¾Œè‡ºäº’å‹•...`);
                // è§¸ç™¼ç¾¤èŠå°ˆå±¬çš„å¾Œè‡ºè¡Œå‹•å‡½æ•¸
                triggerGroupAiAction(chat.id);
            }
        }
    });
}

// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ¸…ç©ºæ‰€æœ‰å·²é—œæ³¨è§’è‰²çš„å¾®åšå¸–å­
 */
async function clearFollowingFeed() {
    // 1. å½ˆå‡ºç¢ºèªæ¡†ï¼Œé˜²æ­¢èª¤æ“ä½œ
    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ¸…ç©º',
        'æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰ã€éä½ æœ¬äººç™¼ä½ˆã€‘çš„å¾®åšï¼Œä¸”ç„¡æ³•æ¢å¾©ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' } // ç´…è‰²æŒ‰éˆ•ä»¥ç¤ºè­¦å‘Š
    );

    if (!confirmed) {
        return; // å¦‚æœç”¨æˆ¶å–æ¶ˆï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
    }

    try {
        // 2. å¾è³‡æ–™åº«ä¸­æ‰¾å‡ºæ‰€æœ‰ä½œè€…ä¸æ˜¯'user'çš„å¸–å­
        const postsToDelete = await db.weiboPosts.where('authorId').notEqual('user').toArray();
        const idsToDelete = postsToDelete.map(p => p.id);

        if (idsToDelete.length === 0) {
            alert("ç›®å‰æ²’æœ‰å¯ä»¥æ¸…ç©ºçš„å‹•æ…‹ã€‚");
            return;
        }

        // 3. æ‰¹é‡åˆªé™¤é€™äº›å¸–å­
        await db.weiboPosts.bulkDelete(idsToDelete);

        // 4. é‡æ–°æ¸²æŸ“â€œé—œæ³¨çš„äººâ€çš„Feedï¼Œè®“ä»‹é¢è®Šç©º
        await renderWeiboFeeds('weibo-following-view');

        alert(`å·²æˆåŠŸæ¸…ç©º ${idsToDelete.length} æ¢å‹•æ…‹ï¼`);

    } catch (error) {
        console.error("æ¸…ç©ºé—œæ³¨å‹•æ…‹æ™‚å‡ºéŒ¯:", error);
        alert(`æ“ä½œå¤±æ•—: ${error.message}`);
    }
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹å°‡é€™å…©å€‹ã€æ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å°‡ä¿å­˜çš„åœ–ç¤ºURLæ‡‰ç”¨åˆ°ä¸»è¢å¹•çš„Appåœ–ç¤ºä¸Š
 */
function applyAppIcons() {
    if (!state.globalSettings.appIcons) return;

    for (const iconId in state.globalSettings.appIcons) {
        const imgElement = document.getElementById(`icon-img-${iconId}`);
        if (imgElement) {
            imgElement.src = state.globalSettings.appIcons[iconId];
        }
    }
}

/**
 * ã€å…¨æ–°ã€‘åœ¨å¤–è§€è¨­ç½®é é¢æ¸²æŸ“å‡ºæ‰€æœ‰Appåœ–ç¤ºçš„è¨­ç½®é …
 */
function renderIconSettings() {
    const grid = document.getElementById('icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ®µã€ä¿®æ”¹å¾Œã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ appLabels â–¼â–¼â–¼
const appLabels = {
    'world-book': 'ä¸–ç•Œæ›¸',
    'qq': 'QQ',
    'api-settings': 'APIè¨­ç½®',
    'wallpaper': 'å£ç´™',
    'font': 'å­—é«”',
    'check-phone': 'æŸ¥æ‰‹æ©Ÿ',
    'weibo': 'å¾®åš',
    'forum': 'åœˆå­',
    'lovers-space': 'æƒ…ä¾¶ç©ºé–“',
    'game-hall': 'éŠæˆ²å¤§å»³',
    'x-social': 'Xç¤¾äº¤',
    'taobao': 'æ¡ƒå¯¶'
};
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²




    for (const iconId in state.globalSettings.appIcons) {
        const iconUrl = state.globalSettings.appIcons[iconId];
        const labelText = appLabels[iconId] || 'æœªçŸ¥App';

        const item = document.createElement('div');
        item.className = 'icon-setting-item';
        // ã€é‡è¦ã€‘æˆ‘å€‘ç”¨ data-icon-id ä¾†æ¨™è¨˜é€™å€‹è¨­ç½®é …å°æ‡‰å“ªå€‹åœ–ç¤º
        item.dataset.iconId = iconId; 

        item.innerHTML = `
            <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
            <button class="change-icon-btn">æ›´æ›</button>
        `;
        grid.appendChild(item);
    }
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æœ€çµ‚ç¢ºèªç‰ˆã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ openBrowser å’Œ closeBrowser å‡½æ•¸ â–¼â–¼â–¼

/**
 * ç•¶ä½¿ç”¨è€…é»é¸é€£çµå¡ç‰‡æ™‚ï¼Œæ‰“é–‹å½æµè¦½å™¨
 * @param {number} timestamp - è¢«é»æ“Šæ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
function openBrowser(timestamp) {
    if (!state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    // å®‰å…¨æª¢æŸ¥ï¼Œç¢ºä¿ chat å’Œ history éƒ½å­˜åœ¨
    if (!chat || !chat.history) return;

    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_link') {
        console.error("ç„¡æ³•æ‰¾åˆ°æˆ–æ¶ˆæ¯é¡å‹ä¸åŒ¹é…çš„åˆ†äº«é€£çµ:", timestamp);
        return; // å¦‚æœæ‰¾ä¸åˆ°æ¶ˆæ¯ï¼Œå°±ç›´æ¥é€€å‡º
    }

    // å¡«å……æµè¦½å™¨å…§å®¹
    document.getElementById('browser-title').textContent = message.source_name || 'æ–‡ç« è©³æƒ…';
    const browserContent = document.getElementById('browser-content');
    browserContent.innerHTML = `
        <h1 class="article-title">${message.title || 'ç„¡æ¨™é¡Œ'}</h1>
        <div class="article-meta">
            <span>ä¾†æº: ${message.source_name || 'æœªçŸ¥'}</span>
        </div>
        <div class="article-body">
            <p>${(message.content || 'å…§å®¹ç‚ºç©ºã€‚').replace(/\n/g, '</p><p>')}</p>
        </div>
    `;

    // é¡¯ç¤ºæµè¦½å™¨è¢å¹•
    showScreen('browser-screen');
}

/**
 * é—œé–‰å½æµè¦½å™¨ï¼Œè¿”å›èŠå¤©ä»‹é¢
 * (é€™å€‹å‡½æ•¸ç¾åœ¨ç”± init() ä¸­çš„äº‹ä»¶ç›£è½å™¨èª¿ç”¨)
 */
function closeBrowser() {
    showScreen('chat-interface-screen'); 
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä½¿ç”¨è€…åˆ†äº«é€£çµåŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * æ‰“é–‹è®“ä½¿ç”¨è€…å¡«å¯«é€£çµè³‡è¨Šçš„æ¨¡æ…‹æ¡†
 */
function openShareLinkModal() {
    if (!state.activeChatId) return;

    // æ¸…ç©ºä¸Šæ¬¡è¼¸å…¥çš„å…§å®¹
    document.getElementById('link-title-input').value = '';
    document.getElementById('link-description-input').value = '';
    document.getElementById('link-source-input').value = '';
    document.getElementById('link-content-input').value = '';

    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    document.getElementById('share-link-modal').classList.add('visible');
}

/**
 * ä½¿ç”¨è€…ç¢ºèªåˆ†äº«ï¼Œå‰µå»ºä¸¦ç™¼é€é€£çµå¡ç‰‡æ¶ˆæ¯
 */
async function sendUserLinkShare() {
    if (!state.activeChatId) return;

    const title = document.getElementById('link-title-input').value.trim();
    if (!title) {
        alert("æ¨™é¡Œæ˜¯å¿…å¡«é …å“¦ï¼");
        return;
    }

    const description = document.getElementById('link-description-input').value.trim();
    const sourceName = document.getElementById('link-source-input').value.trim();
    const content = document.getElementById('link-content-input').value.trim();

    const chat = state.chats[state.activeChatId];
    
    // å‰µå»ºæ¶ˆæ¯ç‰©ä»¶
    const linkMessage = {
        role: 'user', // è§’è‰²æ˜¯ 'user'
        type: 'share_link',
        timestamp: Date.now(),
        title: title,
        description: description,
        source_name: sourceName,
        content: content,
        // ä½¿ç”¨è€…åˆ†äº«çš„é€£çµï¼Œæˆ‘å€‘ä¸æä¾›åœ–ç‰‡ï¼Œè®“å®ƒç¸½æ˜¯é¡¯ç¤ºå é»é™£åœ–
        thumbnail_url: null 
    };

    // å°‡æ¶ˆæ¯æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
    chat.history.push(linkMessage);
    await db.chats.put(chat);

    // æ¸²æŸ“æ–°æ¶ˆæ¯ä¸¦æ›´æ–°æ¸…å–®
    appendMessage(linkMessage, chat);
    renderChatList();

    // é—œé–‰æ¨¡æ…‹æ¡†
    document.getElementById('share-link-modal').classList.remove('visible');
}

/**
 * ã€å…¨æ–°å‡ç´šç‰ˆã€‘æ ¹æ“šAIè¦–è§’å’Œå‹•æ…‹è¨­ç½®ï¼Œæ§‹å»ºçµ¦AIçœ‹çš„è©•è«–å€ä¸Šä¸‹æ–‡
 * @param {object} post - æ­£åœ¨è™•ç†çš„å‹•æ…‹ç‰©ä»¶
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€å‹•æ…‹çš„AIè§’è‰²
 * @param {string} userNickname - ç”¨æˆ¶çš„æ˜µç¨±
 * @returns {{contextString: string, visibilityFlag: string}} - è¿”å›åŒ…å«ä¸Šä¸‹æ–‡æ–‡æœ¬å’Œå¯è¦‹æ€§æ¨™èªŒçš„ç‰©ä»¶
 */
function buildCommentsContextForAI(post, viewerChat, userNickname) {
    if (!post.comments || post.comments.length === 0) {
        // â˜…â˜…â˜… é—œéµåœ¨é€™è£¡ï¼šç¢ºä¿ "[è©•è«–å€å¯è¦‹]" æ˜¯ä¸€å€‹å¸¶å¼•è™Ÿçš„å­—ä¸² â˜…â˜…â˜…
        return { contextString: "", visibilityFlag: "[è©•è«–å€å¯è¦‹]" };
    }

    const viewerName = viewerChat.name;
    let commentsForAI;
    let visibilityFlag;

    if (post.areCommentsVisible !== false) {
        commentsForAI = post.comments;
        // â˜…â˜…â˜… é—œéµåœ¨é€™è£¡ï¼šç¢ºä¿ "[è©•è«–å€å¯è¦‹]" æ˜¯ä¸€å€‹å¸¶å¼•è™Ÿçš„å­—ä¸² â˜…â˜…â˜…
        visibilityFlag = "[è©•è«–å€å¯è¦‹]"; 
    } else {
commentsForAI = Array.isArray(post.comments)
  ? post.comments.filter(comment => {
      return comment.commenterName === viewerName
          || comment.commenterName === userNickname
          || comment.replyTo === viewerName;
    })
  : [];
        // â˜…â˜…â˜… é—œéµåœ¨é€™è£¡ï¼šç¢ºä¿ "[è©•è«–å€éƒ¨åˆ†å¯è¦‹]" æ˜¯ä¸€å€‹å¸¶å¼•è™Ÿçš„å­—ä¸² â˜…â˜…â˜…
        visibilityFlag = "[è©•è«–å€éƒ¨åˆ†å¯è¦‹]";
    }

    if (commentsForAI.length === 0) {
        return { contextString: "", visibilityFlag: visibilityFlag };
    }

    let context = `  â”” è©•è«–å€:\n`;
    commentsForAI.slice(-5).forEach(c => {
        if (c.replyTo) {
            context += `    - ${c.commenterName} å›å¾© ${c.replyTo}: ${c.text}\n`;
        } else {
            context += `    - ${c.commenterName}: ${c.text}\n`;
        }
    });
    
    return { contextString: context, visibilityFlag: visibilityFlag };
}



/**
 * æ ¹æ“šAIçš„è¦–è§’ï¼Œéæ¿¾å‡ºå®ƒèƒ½çœ‹åˆ°çš„å‹•æ…‹
 * @param {Array} allPosts - æ‰€æœ‰å¾…æª¢æŸ¥çš„å‹•æ…‹å¸–å­
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€å‹•æ…‹çš„é‚£å€‹AIçš„chatç‰©ä»¶
 * @returns {Array} - éæ¿¾å¾Œè©²AIå¯è¦‹çš„å‹•æ…‹å¸–å­
 */
function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return []; // å®‰å…¨æª¢æŸ¥

    const viewerGroupId = viewerChat.groupId; // æŸ¥çœ‹è€…æ‰€åœ¨çš„åˆ†çµ„ID

    return allPosts.filter(post => {
        // è¦å‰‡1ï¼šå¦‚æœæ˜¯ä½¿ç”¨è€…ç™¼çš„å‹•æ…‹
        if (post.authorId === 'user') {
            // å¦‚æœä½¿ç”¨è€…è¨­ç½®äº†â€œéƒ¨åˆ†å¯è¦‹â€
            if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // åªæœ‰ç•¶æŸ¥çœ‹è€…AIçš„åˆ†çµ„IDåœ¨ç”¨æˆ¶çš„å¯è¦‹åˆ—è¡¨è£¡æ™‚ï¼Œæ‰å¯è¦‹
                return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
            }
            // å¦‚æœç”¨æˆ¶æ²’è¨­ç½®ï¼Œèªªæ˜æ˜¯å…¬é–‹çš„ï¼Œæ‰€æœ‰AIéƒ½å¯è¦‹
            return true;
        }

        // è¦å‰‡2ï¼šå¦‚æœæ˜¯å…¶ä»–AIç™¼çš„å‹•æ…‹
        const authorGroupId = post.authorGroupId; // ç™¼å¸–AIæ‰€åœ¨çš„åˆ†çµ„ID
        
        // å¦‚æœç™¼å¸–çš„AIæ²’æœ‰åˆ†çµ„ï¼Œé‚£å®ƒçš„å‹•æ…‹å°±æ˜¯å…¬é–‹çš„
        if (!authorGroupId) {
            return true;
        }

        // å¦‚æœç™¼å¸–çš„AIæœ‰åˆ†çµ„ï¼Œé‚£éº¼åªæœ‰åœ¨åŒä¸€å€‹åˆ†çµ„çš„AIæ‰èƒ½çœ‹åˆ°
        return authorGroupId === viewerGroupId;
    });
}

/**
 * æ‡‰ç”¨æŒ‡å®šçš„ä¸»é¡Œï¼ˆ'light' æˆ– 'dark'ï¼‰
 * @param {string} theme - è¦æ‡‰ç”¨çš„ä¸»é¡Œåç¨±
 */
function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    
    const isDark = theme === 'dark';
    
    phoneScreen.classList.toggle('dark-mode', isDark);
    
    // å¦‚æœé–‹é—œå­˜åœ¨ï¼Œå°±åŒæ­¥å®ƒçš„ç‹€æ…‹
    if (toggleSwitch) {
        toggleSwitch.checked = isDark;
    }
    
    localStorage.setItem('ephone-theme', theme);
}

/**
 * åˆ‡æ›ç•¶å‰çš„ä¸»é¡Œ
 */
function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    // ç›´æ¥æ ¹æ“šé–‹é—œçš„é¸ä¸­ç‹€æ…‹ä¾†æ±ºå®šæ–°ä¸»é¡Œ
    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
}

// â–¼â–¼â–¼ è«‹å°‡é€™ã€ä¸€æ•´å¡Šæ–°å‡½æ•¸ã€‘é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

function startReplyToMessage() {
    if (!activeMessageTimestamp) return;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘åŒæ™‚ç²å–â€œå®Œæ•´å…§å®¹â€å’Œâ€œé è¦½ç‰‡æ®µâ€
    const fullContent = String(message.content || '');
    let previewSnippet = '';

    if (typeof message.content === 'string' && STICKER_REGEX.test(message.content)) {
        previewSnippet = '[è¡¨æƒ…]';
    } else if (message.type === 'ai_image' || message.type === 'user_photo') {
        previewSnippet = '[åœ–ç‰‡]';
    } else if (message.type === 'voice_message') {
        previewSnippet = '[èªéŸ³]';
    } else {
        // é è¦½ç‰‡æ®µä¾ç„¶æˆªæ–·ï¼Œä½†åªç”¨æ–¼UIé¡¯ç¤º
        previewSnippet = fullContent.substring(0, 50) + (fullContent.length > 50 ? '...' : '');
    }
    
    // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘å°‡â€œå®Œæ•´å…§å®¹â€å­˜å…¥ä¸Šä¸‹æ–‡ï¼Œä»¥å‚™ç™¼é€æ™‚ä½¿ç”¨
    currentReplyContext = {
        timestamp: message.timestamp,
        senderName: message.senderName || (message.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name),
        content: fullContent, // <--- é€™è£¡å­˜çš„æ˜¯å®Œæ•´çš„åŸæ–‡ï¼
    };

    // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘åƒ…åœ¨æ›´æ–°â€œå›å¾©é è¦½æ¬„â€æ™‚ï¼Œæ‰ä½¿ç”¨â€œé è¦½ç‰‡æ®µâ€
    const previewBar = document.getElementById('reply-preview-bar');
    previewBar.querySelector('.sender').textContent = `å›å¾© ${currentReplyContext.senderName}:`;
    previewBar.querySelector('.text').textContent = previewSnippet; // <--- é€™è£¡ç”¨çš„æ˜¯ç¸®ç•¥ç‰ˆï¼
    previewBar.style.display = 'block';

    // 4. å¾ŒçºŒæ“ä½œä¿æŒä¸è®Š
    hideMessageActions();
    document.getElementById('chat-input').focus();
}

/**
 * ã€å…¨æ–°ã€‘å–æ¶ˆå¼•ç”¨æ¨¡å¼
 */
function cancelReplyMode() {
    currentReplyContext = null;
    document.getElementById('reply-preview-bar').style.display = 'none';
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä½¿ç”¨è€…è™•ç†è½‰å¸³çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

let activeTransferTimestamp = null; // ç”¨æ–¼æš«å­˜è¢«é»æ“Šçš„è½‰å¸³æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜

/**
 * é¡¯ç¤ºè™•ç†è½‰å¸³çš„æ“ä½œåŠŸèƒ½è¡¨
 * @param {number} timestamp - è¢«é»æ“Šçš„è½‰å¸³æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
function showTransferActionModal(timestamp) {
    activeTransferTimestamp = timestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (message) {
        // å°‡AIçš„åå­—å¡«å…¥å½ˆçª—
        document.getElementById('transfer-sender-name').textContent = message.senderName;
    }
    document.getElementById('transfer-actions-modal').classList.add('visible');
}

/**
 * éš±è—è™•ç†è½‰å¸³çš„æ“ä½œåŠŸèƒ½è¡¨
 */
function hideTransferActionModal() {
    document.getElementById('transfer-actions-modal').classList.remove('visible');
    activeTransferTimestamp = null;
}

/**
 * è™•ç†ä½¿ç”¨è€…æ¥å—æˆ–æ‹’çµ•è½‰å¸³çš„é‚è¼¯
 * @param {string} choice - ç”¨æˆ¶çš„é¸æ“‡, 'accepted' æˆ– 'declined'
 */
async function handleUserTransferResponse(choice) {
    if (!activeTransferTimestamp) return;

    const timestamp = activeTransferTimestamp;
    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    // 1. æ›´æ–°åŸå§‹è½‰å¸³æ¶ˆæ¯çš„ç‹€æ…‹
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;

    let systemContent;

    // 2. å¦‚æœç”¨æˆ¶é¸æ“‡â€œæ‹’çµ•â€
    if (choice === 'declined') {
        // ç«‹åˆ»åœ¨å‰ç«¯ç”Ÿæˆä¸€å€‹â€œé€€æ¬¾â€å¡ç‰‡ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°
        const refundMessage = {
            role: 'user',
            type: 'transfer',
            isRefund: true, // é€™æ˜¯ä¸€å€‹é—œéµæ¨™è¨˜ï¼Œç”¨æ–¼UIé¡¯ç¤ºé€™æ˜¯é€€æ¬¾
            amount: originalMessage.amount,
            note: 'å·²æ‹’æ”¶å°æ–¹è½‰å¸³',
            timestamp: Date.now()
        };
        chat.history.push(refundMessage);
        
        // æº–å‚™ä¸€æ¢å°AIå¯è¦‹çš„éš±è—æ¶ˆæ¯ï¼Œå‘Šè¨´å®ƒç™¼ç”Ÿäº†ä»€éº¼
        systemContent = `[ç³»çµ±æç¤ºï¼šä½ æ‹’çµ•ä¸¦é€€é‚„äº†â€œ${originalMessage.senderName}â€çš„è½‰å¸³ã€‚]`;
    } else { // å¦‚æœç”¨æˆ¶é¸æ“‡â€œæ¥å—â€
        // åªéœ€æº–å‚™éš±è—æ¶ˆæ¯é€šçŸ¥AIå³å¯
        systemContent = `[ç³»çµ±æç¤ºï¼šä½ æ¥å—äº†â€œ${originalMessage.senderName}â€çš„è½‰å¸³ã€‚]`;
        await updateUserBalanceAndLogTransaction(originalMessage.amount, `æ”¶åˆ°ä¾†è‡ª ${originalMessage.senderName} çš„è½‰å¸³`);
    }

    // 3. å‰µå»ºé€™æ¢å°ç”¨æˆ¶éš±è—ã€ä½†å°AIå¯è¦‹çš„ç³»çµ±æ¶ˆæ¯
    const hiddenMessage = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now() + 1, // ä¿è­‰æ™‚é–“æˆ³è¨˜åœ¨é€€æ¬¾æ¶ˆæ¯ä¹‹å¾Œ
        isHidden: true // é€™å€‹æ¨™è¨˜æœƒè®“å®ƒä¸åœ¨èŠå¤©ä»‹é¢é¡¯ç¤º
    };
    chat.history.push(hiddenMessage);

    // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°è³‡æ–™åº«ï¼Œä¸¦åˆ·æ–°ä»‹é¢
    await db.chats.put(chat);
    hideTransferActionModal(); 
    renderChatInterface(state.activeChatId);
    renderChatList();
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè©±è¨˜éŒ„åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

async function renderCallHistoryScreen() {
    showScreen('call-history-screen'); // <--ã€æ ¸å¿ƒä¿®æ­£ã€‘æŠŠå®ƒç§»å‹•åˆ°æœ€å‰é¢ï¼

    const listEl = document.getElementById('call-history-list');
    const titleEl = document.getElementById('call-history-title');
    listEl.innerHTML = '';
    titleEl.textContent = 'æ‰€æœ‰é€šè©±è¨˜éŒ„';
    
    const records = await db.callRecords.orderBy('timestamp').reverse().toArray();
    
    if (records.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é€™è£¡é‚„æ²’æœ‰é€šè©±è¨˜éŒ„å“¦~</p>';
        return; // ç¾åœ¨çš„ return å°±æ²’å•é¡Œäº†ï¼Œå› ç‚ºå®ƒåªè·³éäº†å¾ŒçºŒçš„æ¸²æŸ“é‚è¼¯
    }
    
    records.forEach(record => {
        const card = createCallRecordCard(record);

    addLongPressListener(card, async () => {
        // 1. å½ˆå‡ºè¼¸å…¥æ¡†ï¼Œä¸¦å°‡èˆŠåç¨±ä½œç‚ºé è¨­å€¼ï¼Œæ–¹ä¾¿ä¿®æ”¹
        const newName = await showCustomPrompt(
            "è‡ªè¨‚é€šè©±åç¨±", 
            "è«‹è¼¸å…¥æ–°çš„åç¨±ï¼ˆç•™ç©ºå‰‡æ¢å¾©é»˜èªï¼‰",
            record.customName || '' // å¦‚æœå·²æœ‰è‡ªè¨‚åç¨±ï¼Œå°±é¡¯ç¤ºå®ƒ
        );

        // 2. å¦‚æœç”¨æˆ¶é»æ“Šäº†â€œå–æ¶ˆâ€ï¼Œå‰‡ä»€éº¼éƒ½ä¸åš
        if (newName === null) return;
        
        // 3. æ›´æ–°è³‡æ–™åº«ä¸­çš„é€™æ¢è¨˜éŒ„
        await db.callRecords.update(record.id, { customName: newName.trim() });
        
        // 4. åˆ·æ–°æ•´å€‹æ¸…å–®ï¼Œè®“æ›´æ”¹ç«‹åˆ»é¡¯ç¤ºå‡ºä¾†
        await renderCallHistoryScreen();
        
        // 5. çµ¦ç”¨æˆ¶ä¸€å€‹æˆåŠŸçš„æç¤º
        await showCustomAlert('æˆåŠŸ', 'é€šè©±åç¨±å·²æ›´æ–°ï¼');
    });
        listEl.appendChild(card);
    });    
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å‡ç´šç‰ˆã€‘å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ createCallRecordCard å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å‡ç´šç‰ˆã€‘æ ¹æ“šå–®æ¢è¨˜éŒ„è³‡æ–™ï¼Œå‰µå»ºä¸€å¼µèƒ½é¡¯ç¤ºèŠå¤©ç‰©ä»¶çš„é€šè©±å¡ç‰‡
 * @param {object} record - ä¸€æ¢é€šè©±è¨˜éŒ„ç‰©ä»¶
 * @returns {HTMLElement} - å‰µå»ºå¥½çš„å¡ç‰‡div
 */
function createCallRecordCard(record) {
    const card = document.createElement('div');
    card.className = 'call-record-card';
    card.dataset.recordId = record.id; 

    // ç²å–é€šè©±å°è±¡çš„åå­—
    const chatInfo = state.chats[record.chatId];
    const chatName = chatInfo ? chatInfo.name : 'æœªçŸ¥æœƒè©±';

    const callDate = new Date(record.timestamp);
    const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, '0')}-${String(callDate.getDate()).padStart(2, '0')} ${String(callDate.getHours()).padStart(2, '0')}:${String(callDate.getMinutes()).padStart(2, '0')}`;
    const durationText = `${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’`;

    const avatarsHtml = record.participants.map(p => 
        `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`
    ).join('');
    
    card.innerHTML = `
        <div class="card-header">
            <span class="date">${dateString}</span>
            <span class="duration">${durationText}</span>
        </div>
        <div class="card-body">
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡æ–°å¢ä¸€å€‹æ¨™é¡Œè¡Œ -->
            ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ''}
            
            <div class="participants-info"> <!-- æ–°å¢ä¸€å€‹å®¹å™¨æ–¹ä¾¿ä½ˆå±€ -->
                <div class="participants-avatars">${avatarsHtml}</div>
                <span class="participants-names">èˆ‡ ${chatName}</span>
            </div>
        </div>
    `;
    return card;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * é¡¯ç¤ºæŒ‡å®šé€šè©±è¨˜éŒ„çš„å®Œæ•´æ–‡å­—ç¨¿
 * @param {number} recordId - é€šè©±è¨˜éŒ„çš„ID
 */
async function showCallTranscript(recordId) {
    const record = await db.callRecords.get(recordId);
    if (!record) return;

    const modal = document.getElementById('call-transcript-modal');
    const titleEl = document.getElementById('transcript-modal-title');
    const bodyEl = document.getElementById('transcript-modal-body');

    titleEl.textContent = `é€šè©±æ–¼ ${new Date(record.timestamp).toLocaleString()} (æ™‚é•·: ${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’)`;
    bodyEl.innerHTML = '';
    
    if (!record.transcript || record.transcript.length === 0) {
        bodyEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">é€™æ¬¡é€šè©±æ²’æœ‰ç•™ä¸‹æ–‡å­—è¨˜éŒ„ã€‚</p>';
    } else {
        record.transcript.forEach(entry => {
            const bubble = document.createElement('div');
            // æ ¹æ“šè§’è‰²æ·»åŠ ä¸åŒçš„classï¼Œæ‡‰ç”¨ä¸åŒçš„æ¨£å¼
            bubble.className = `transcript-entry ${entry.role}`; 
            bubble.textContent = entry.content;
            bodyEl.appendChild(bubble);
        });
    }

    const deleteBtn = document.getElementById('delete-transcript-btn');
    
    // ã€é‡è¦ã€‘ä½¿ç”¨å…‹éš†ç¯€é»æŠ€å·§ï¼Œé˜²æ­¢äº‹ä»¶é‡è¤‡ç¶å®š
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    
    // ç‚ºæ–°çš„ã€ä¹¾æ·¨çš„æŒ‰éˆ•ç¶å®šäº‹ä»¶
    newDeleteBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm(
            "ç¢ºèªåˆªé™¤",
            "ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™æ¢é€šè©±è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚",
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            // 1. é—œé–‰ç•¶å‰çš„è©³æƒ…å½ˆçª—
            modal.classList.remove('visible');
            
            // 2. å¾è³‡æ–™åº«åˆªé™¤
            await db.callRecords.delete(recordId);
            
            // 3. åˆ·æ–°é€šè©±è¨˜éŒ„æ¸…å–®
            await renderCallHistoryScreen();
            
            // 4. (å¯é¸) çµ¦å‡ºæˆåŠŸæç¤º
            alert('é€šè©±è¨˜éŒ„å·²åˆªé™¤ã€‚');
        }
    });
    modal.classList.add('visible');
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å…¨æ–°å‡½æ•¸ã€‘æ›¿æ›æ‰ä½ èˆŠçš„ handleStatusResetClick å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶é»æ“Šç‹€æ…‹åˆ—ï¼Œå½ˆå‡ºç·¨è¼¯æ–¹å¡Šè®“ä½¿ç”¨è€…ä¿®æ”¹AIçš„ç•¶å‰ç‹€æ…‹
 */
async function handleEditStatusClick() {
    // 1. å®‰å…¨æª¢æŸ¥ï¼Œç¢ºä¿åœ¨å–®èŠä»‹é¢
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
        return; 
    }
    const chat = state.chats[state.activeChatId];

    // 2. å½ˆå‡ºè¼¸å…¥æ¡†ï¼Œè®“ä½¿ç”¨è€…è¼¸å…¥æ–°çš„ç‹€æ…‹ï¼Œä¸¦å°‡ç•¶å‰ç‹€æ…‹ä½œç‚ºé è¨­å€¼
    const newStatusText = await showCustomPrompt(
        'ç·¨è¼¯å°æ–¹ç‹€æ…‹',
        'è«‹è¼¸å…¥å°æ–¹ç¾åœ¨çš„æ–°ç‹€æ…‹ï¼š',
        chat.status.text // å°‡ç•¶å‰ç‹€æ…‹ä½œç‚ºè¼¸å…¥æ¡†çš„é è¨­å…§å®¹
    );

    // 3. å¦‚æœä½¿ç”¨è€…è¼¸å…¥äº†å…§å®¹ä¸¦é»æ“Šäº†â€œç¢ºå®šâ€
    if (newStatusText !== null) {
        // 4. æ›´æ–°è¨˜æ†¶é«”å’Œè³‡æ–™åº«ä¸­çš„ç‹€æ…‹è³‡æ–™
        chat.status.text = newStatusText.trim() || 'ç·šä¸Š'; // å¦‚æœç”¨æˆ¶æ¸…ç©ºäº†ï¼Œå°±é»˜èªç‚ºâ€œç·šä¸Šâ€
        chat.status.isBusy = false; // æ¯æ¬¡æ‰‹å‹•ç·¨è¼¯éƒ½é»˜èªå…¶ä¸è™•æ–¼â€œå¿™ç¢Œâ€ç‹€æ…‹
        chat.status.lastUpdate = Date.now();
        await db.chats.put(chat);

        // 5. ç«‹åˆ»åˆ·æ–°UIï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°ä¿®æ”¹å¾Œçš„ç‹€æ…‹
        renderChatInterface(state.activeChatId);
        renderChatList();
        
        // 6. çµ¦å‡ºä¸€å€‹ç„¡å‚·å¤§é›…çš„æˆåŠŸæç¤º
        await showCustomAlert('ç‹€æ…‹å·²æ›´æ–°', `â€œ${chat.name}â€çš„ç•¶å‰ç‹€æ…‹å·²æ›´æ–°ç‚ºï¼š${chat.status.text}`);
    }
}

// æ”¾åœ¨ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€
async function openShareTargetPicker() {
    const modal = document.getElementById('share-target-modal');
    const listEl = document.getElementById('share-target-list');
    listEl.innerHTML = '';

    // ç²å–æ‰€æœ‰èŠå¤©ä½œç‚ºåˆ†äº«ç›®æ¨™
    const chats = Object.values(state.chats);

    chats.forEach(chat => {
        // è¤‡ç”¨é€£çµ¡äººé¸æ“‡å™¨çš„æ¨£å¼
        const item = document.createElement('div');
        item.className = 'contact-picker-item'; 
        item.innerHTML = `
            <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
            <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${chat.name}</span>
        `;
        listEl.appendChild(item);
    });
    
    modal.classList.add('visible');
}

function closeMusicPlayerWithAnimation(callback) {
    const overlay = document.getElementById('music-player-overlay');
    if (!overlay.classList.contains('visible')) {
        if (callback) callback();
        return;
    }
    overlay.classList.remove('visible');
    setTimeout(() => {
        document.getElementById('music-playlist-panel').classList.remove('visible');
        if (callback) callback();
    }, 400); 
}

function parseLRC(lrcContent) {
    if (!lrcContent) return [];
    const lines = lrcContent.split('\n');
    const lyrics = [];
    const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;

    for (const line of lines) {
        const text = line.replace(timeRegex, '').trim();
        if (!text) continue;
        timeRegex.lastIndex = 0;
        let match;
        while ((match = timeRegex.exec(line)) !== null) {
            const minutes = parseInt(match[1], 10);
            const seconds = parseInt(match[2], 10);
            const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
            const time = minutes * 60 + seconds + milliseconds / 1000;
            lyrics.push({ time, text });
        }
    }
    return lyrics.sort((a, b) => a.time - b.time);
}

function renderLyrics() {
    const lyricsList = document.getElementById('music-lyrics-list');
    lyricsList.innerHTML = '';
    if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
        lyricsList.innerHTML = '<div class="lyric-line">â™ª æš«ç„¡æ­Œè© â™ª</div>';
        return;
    }
    musicState.parsedLyrics.forEach((line, index) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'lyric-line';
        lineEl.textContent = line.text;
        lineEl.dataset.index = index;
        lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(0px)`;
}

function updateActiveLyric(currentTime) {
    if (musicState.parsedLyrics.length === 0) return;
    let newLyricIndex = -1;
    for (let i = 0; i < musicState.parsedLyrics.length; i++) {
        if (currentTime >= musicState.parsedLyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === musicState.currentLyricIndex) return;
    musicState.currentLyricIndex = newLyricIndex;
    updateLyricsUI();
}

function updateLyricsUI() {
    const lyricsList = document.getElementById('music-lyrics-list');
    const container = document.getElementById('music-lyrics-container');
    const lines = lyricsList.querySelectorAll('.lyric-line');
    lines.forEach(line => line.classList.remove('active'));
    if (musicState.currentLyricIndex === -1) {
        lyricsList.style.transform = `translateY(0px)`;
        return;
    }
    const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${musicState.currentLyricIndex}"]`);
    if (activeLine) {
        activeLine.classList.add('active');
        const containerHeight = container.offsetHeight;
        const offset = (containerHeight / 3) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
        lyricsList.style.transform = `translateY(${offset}px)`;
    }

    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™å¡Šã€æ–°ä»£ç¢¼ã€‘ â–¼â–¼â–¼
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åŒæ­¥æ­Œè©åˆ°æ‡¸æµ®æ¬„
    const floatingLyricText = document.getElementById('floating-lyric-text');
    if (activeLine) {
        floatingLyricText.textContent = activeLine.textContent;
    } else if (musicState.parsedLyrics.length > 0) {
        floatingLyricText.textContent = 'â™ª â™ª â™ª'; // æ­Œæ›²å‰å¥
    } else {
        floatingLyricText.textContent = 'â™ª æš«ç„¡æ­Œè© â™ª';
    }
    // â–²â–²â–² æ–°ä»£ç¢¼æ·»åŠ çµæŸ â–²â–²â–²

}

function formatMusicTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${String(remainingSeconds).padStart(2, '0')}`;
}

function updateMusicProgressBar() {
    const currentTimeEl = document.getElementById('music-current-time');
    const totalTimeEl = document.getElementById('music-total-time');
    const progressFillEl = document.getElementById('music-progress-fill');
    if (!audioPlayer.duration) {
        currentTimeEl.textContent = "0:00";
        totalTimeEl.textContent = "0:00";
        progressFillEl.style.width = '0%';
        return;
    }
    const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressFillEl.style.width = `${progressPercent}%`;
    currentTimeEl.textContent = formatMusicTime(audioPlayer.currentTime);
    totalTimeEl.textContent = formatMusicTime(audioPlayer.duration);
    updateActiveLyric(audioPlayer.currentTime);
}

/**
 * ã€å…¨æ–°ã€‘è™•ç†ä½¿ç”¨è€…é»æ“Šâ€œæ’¤å›â€æŒ‰éˆ•çš„å…¥å£å‡½æ•¸
 */
async function handleRecallClick() {
    if (!activeMessageTimestamp) return;

    const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // è¨­ç½®2åˆ†é˜çš„æ’¤å›æ™‚é™
    const messageTime = activeMessageTimestamp;
    const now = Date.now();

    // æª¢æŸ¥æ˜¯å¦è¶…éäº†æ’¤å›æ™‚é™
    if (now - messageTime > RECALL_TIME_LIMIT_MS) {
        hideMessageActions();
        await showCustomAlert('æ“ä½œå¤±æ•—', 'è©²æ¶ˆæ¯ç™¼é€å·²è¶…é2åˆ†é˜ï¼Œç„¡æ³•æ’¤å›ã€‚');
        return;
    }
    
    // å¦‚æœåœ¨æ™‚é™å…§ï¼ŒåŸ·è¡ŒçœŸæ­£çš„æ’¤å›é‚è¼¯
    await recallMessage(messageTime, true);
    hideMessageActions();
}

/**
 * ã€å…¨æ–°ã€‘æ¶ˆæ¯æ’¤å›çš„æ ¸å¿ƒé‚è¼¯
 * @param {number} timestamp - è¦æ’¤å›çš„æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 * @param {boolean} isUserRecall - æ˜¯å¦æ˜¯ç”¨æˆ¶ä¸»å‹•æ’¤å›
 */
async function recallMessage(timestamp, isUserRecall) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const messageToRecall = chat.history[messageIndex];

    // 1. ä¿®æ”¹æ¶ˆæ¯ç‰©ä»¶ï¼Œå°‡å…¶è®Šç‚ºâ€œå·²æ’¤å›â€ç‹€æ…‹
    const recalledData = {
        originalType: messageToRecall.type || 'text',
        originalContent: messageToRecall.content,
        // ä¿å­˜å…¶ä»–å¯èƒ½å­˜åœ¨çš„åŸå§‹è³‡æ–™
        originalMeaning: messageToRecall.meaning,
        originalQuote: messageToRecall.quote 
    };
    
    messageToRecall.type = 'recalled_message';
    messageToRecall.content = isUserRecall ? 'ä½ æ’¤å›äº†ä¸€æ¢æ¶ˆæ¯' : 'å°æ–¹æ’¤å›äº†ä¸€æ¢æ¶ˆæ¯';
    messageToRecall.recalledData = recalledData;
    // æ¸…ç†æ‰ä¸å†éœ€è¦çš„èˆŠå±¬æ€§
    delete messageToRecall.meaning;
    delete messageToRecall.quote;

    // 2. å¦‚æœæ˜¯ä½¿ç”¨è€…æ’¤å›ï¼Œéœ€è¦çµ¦AIç™¼é€ä¸€æ¢å®ƒçœ‹ä¸æ‡‚å…§å®¹çš„éš±è—æç¤º
    if (isUserRecall) {
        const hiddenMessageForAI = {
            role: 'system',
            content: `[ç³»çµ±æç¤ºï¼šä½¿ç”¨è€…æ’¤å›äº†ä¸€æ¢æ¶ˆæ¯ã€‚ä½ ä¸çŸ¥é“å…§å®¹æ˜¯ä»€éº¼ï¼Œåªéœ€çŸ¥é“é€™å€‹äº‹ä»¶å³å¯ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessageForAI);
    }

    // 3. ä¿å­˜åˆ°è³‡æ–™åº«ä¸¦åˆ·æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    if(isUserRecall) renderChatList(); // ä½¿ç”¨è€…æ’¤å›æ™‚ï¼Œæœ€å¾Œä¸€æ¢æ¶ˆæ¯è®Šäº†ï¼Œéœ€è¦åˆ·æ–°æ¸…å–®
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°‡é€™äº›å‡½æ•¸é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * æ‰“é–‹åˆ†é¡ç®¡ç†æ¨¡æ…‹æ¡†
 */
async function openCategoryManager() {
    await renderCategoryListInManager();
    document.getElementById('world-book-category-manager-modal').classList.add('visible');
}

/**
 * åœ¨æ¨¡æ…‹æ¡†ä¸­æ¸²æŸ“å·²å­˜åœ¨çš„åˆ†é¡åˆ—è¡¨
 */
async function renderCategoryListInManager() {
    const listEl = document.getElementById('existing-categories-list');
    const categories = await db.worldBookCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ä»»ä½•åˆ†é¡</p>';
    }
    categories.forEach(cat => {
        // è¤‡ç”¨å¥½å‹åˆ†çµ„çš„æ¨£å¼
        const item = document.createElement('div');
        item.className = 'existing-group-item'; 
        item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ·»åŠ ä¸€å€‹æ–°çš„ä¸–ç•Œæ›¸åˆ†é¡
 */
async function addNewCategory() {
    const input = document.getElementById('new-category-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†é¡åä¸èƒ½ç‚ºç©ºï¼');
        return;
    }
    const existing = await db.worldBookCategories.where('name').equals(name).first();
    if (existing) {
        alert(`åˆ†é¡ "${name}" å·²ç¶“å­˜åœ¨äº†ï¼`);
        return;
    }
    await db.worldBookCategories.add({ name });
    input.value = '';
    await renderCategoryListInManager();
}

/**
 * åˆªé™¤ä¸€å€‹ä¸–ç•Œæ›¸åˆ†é¡
 * @param {number} categoryId - è¦åˆªé™¤çš„åˆ†é¡çš„ID
 */
async function deleteCategory(categoryId) {
    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤', 
        'åˆªé™¤åˆ†é¡å¾Œï¼Œè©²åˆ†é¡ä¸‹çš„æ‰€æœ‰ä¸–ç•Œæ›¸å°‡è®Šç‚ºâ€œæœªåˆ†é¡â€ã€‚ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', 
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        await db.worldBookCategories.delete(categoryId);
        // å°‡å±¬æ–¼è©²åˆ†é¡çš„ä¸–ç•Œæ›¸çš„ categoryId è¨­ç‚º null
        const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
        for (const book of booksToUpdate) {
            book.categoryId = null;
            await db.worldBooks.put(book);
            const bookInState = state.worldBooks.find(wb => wb.id === book.id);
            if(bookInState) bookInState.categoryId = null;
        }
        await renderCategoryListInManager();
    }
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²å°ˆå±¬NPCåº«ç®¡ç†åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

let editingNpcId = null; // ç”¨æ–¼è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„NPC

/**
 * æ‰“é–‹NPCåº«ç®¡ç†ä»‹é¢
 */
function openNpcManager() {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('npc-management-title').textContent = `â€œ${chat.name}â€çš„NPCåº«`;
    renderNpcList();
    showScreen('npc-management-screen');
}

/**
 * æ¸²æŸ“NPCåˆ—è¡¨
 */
function renderNpcList() {
    const listEl = document.getElementById('npc-management-list');
    const chat = state.chats[state.activeChatId];
    const npcLibrary = chat.npcLibrary || [];
    listEl.innerHTML = '';

    if (npcLibrary.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">é€™è£¡ç©ºç©ºå¦‚ä¹Ÿï¼Œé»æ“Šå³ä¸Šè§’â€œ+â€æ·»åŠ ç¬¬ä¸€å€‹NPCå§ï¼</p>';
        return;
    }

    npcLibrary.forEach(npc => {
        // è¤‡ç”¨èŠå¤©æ¸…å–®çš„æ¨£å¼ï¼Œéå¸¸æ–¹ä¾¿
        const item = document.createElement('div');
        item.className = 'chat-list-item';
        item.style.cursor = 'pointer';
        item.innerHTML = `
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
            <div class="info">
                <span class="name">${npc.name}</span>
                <div class="last-msg">${npc.persona.substring(0, 30)}...</div>
            </div>
        `;
        // é»æ“Šç·¨è¼¯
        item.addEventListener('click', () => openNpcEditor(npc.id));
        // é•·æŒ‰åˆªé™¤
        addLongPressListener(item, () => deleteNpc(npc.id, npc.name));
        listEl.appendChild(item);
    });
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å…¨æ–°çš„ã€å·²ä¿®å¾©å…©å€‹Bugçš„å‡½æ•¸ã€‘ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ openNpcEditor å‡½æ•¸ â–¼â–¼â–¼
async function openNpcEditor(npcId = null) {
    editingNpcId = npcId;
    // ã€æ ¸å¿ƒä¿®å¾©1ã€‘ä½¿ç”¨æ­£ç¢ºçš„ state.activeChatId ä¾†ç²å–ç•¶å‰èŠå¤©ç‰©ä»¶
    const chat = state.chats[state.activeChatId];
    if (!chat) return; // å®‰å…¨æª¢æŸ¥

    let npc = { name: '', persona: '', avatar: defaultGroupMemberAvatar };
    
    if (npcId) {
        // ã€æ ¸å¿ƒä¿®å¾©2ã€‘å¾æ­£ç¢ºçš„ chat.npcLibrary ä¸­æŸ¥æ‰¾æ•¸æ“š
        npc = (chat.npcLibrary || []).find(n => n.id === npcId) || npc;
        document.getElementById('persona-editor-title').textContent = `ç·¨è¼¯NPC: ${npc.name}`;
    } else {
        document.getElementById('persona-editor-title').textContent = 'æ·»åŠ æ–°NPC';
    }
    
    // å¡«å……ç·¨è¼¯å™¨å…§å®¹
    document.getElementById('npc-editor-name-input').value = npc.name;
    document.getElementById('preset-avatar-preview').src = npc.avatar;
    document.getElementById('preset-persona-input').value = npc.persona;
    
    // ã€æ ¸å¿ƒé‚è¼¯ã€‘æ ¹æ“šNPCæ¨¡å¼ï¼Œé¡¯éš±ç‰¹å®šUIå…ƒç´ 
    document.getElementById('npc-editor-name-group').style.display = 'block';
    document.getElementById('persona-editor-change-frame-btn').style.display = 'none';

    // ç¶å®šæ­£ç¢ºçš„ä¿å­˜å‡½æ•¸
    document.getElementById('save-persona-preset-btn').onclick = saveNpc;

    // æœ€å¾Œæ‰é¡¯ç¤ºå½ˆçª—
    document.getElementById('persona-editor-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²






// â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹æ›¿æ› â–¼â–¼â–¼
/**
 * ã€V2 - å®Œæ•´ç‰ˆã€‘ä¿å­˜NPCï¼ˆæ–°å»ºæˆ–æ›´æ–°ï¼‰
 */
async function saveNpc() {
    const chat = state.chats[state.activeChatId];

    
    // å¾ç·¨è¼¯å™¨ä¸­ç²å–æ‰€æœ‰è³‡æ–™
    const name = document.getElementById('npc-editor-name-input').value.trim();
    const persona = document.getElementById('preset-persona-input').value.trim();
    const avatar = document.getElementById('preset-avatar-preview').src;

    if (!name) {
        alert("NPCåå­—ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }

    if (editingNpcId) {
        // æ›´æ–°ç¾æœ‰çš„NPC
        const npc = chat.npcLibrary.find(n => n.id === editingNpcId);
        if (npc) {
            npc.name = name;
            npc.persona = persona;
            npc.avatar = avatar;
        }
    } else {
        // æ·»åŠ ä¸€å€‹å…¨æ–°çš„NPC
        const newNpc = {
            id: 'npc_' + Date.now(),
            name: name,
            persona: persona,
            avatar: avatar
        };
        chat.npcLibrary.push(newNpc);
    }

    await db.chats.put(chat);
    renderNpcList();
    closePersonaEditor(); // è¤‡ç”¨é—œé–‰ç·¨è¼¯å™¨çš„å‡½æ•¸
}
// â–²â–²â–² æ›¿æ›åˆ°é€™è£¡çµæŸ â–²â–²â–²


/**
 * åˆªé™¤ä¸€å€‹NPC
 * @param {string} npcId - è¦åˆªé™¤çš„NPCçš„ID
 * @param {string} npcName - è¦åˆªé™¤çš„NPCçš„åå­—ï¼Œç”¨æ–¼ç¢ºèªæç¤º
 */
async function deleteNpc(npcId, npcName) {
    const confirmed = await showCustomConfirm(
        'åˆªé™¤NPC',
        `ç¢ºå®šè¦å¾â€œ${state.chats[state.activeChatId].name}â€çš„NPCåº«ä¸­åˆªé™¤ â€œ${npcName}â€ å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        chat.npcLibrary = chat.npcLibrary.filter(n => n.id !== npcId);
        await db.chats.put(chat);
        renderNpcList();
    }
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// --- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è‡ªè¨‚é ­åƒæ¡†ç®¡ç†åŠŸèƒ½ â–¼â–¼â–¼ ---

function openFrameManager() {
    renderFrameManager();
    document.getElementById('custom-frame-manager-modal').classList.add('visible');
}

async function renderFrameManager() {
    const grid = document.getElementById('custom-frame-grid');
    grid.innerHTML = '';
    const customFrames = await db.customAvatarFrames.toArray();
    if (customFrames.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">ä½ é‚„æ²’æœ‰ä¸Šå‚³éé ­åƒæ¡†å“¦~</p>';
        return;
    }
    customFrames.forEach(frame => {
        const item = document.createElement('div');
        // è¤‡ç”¨è¡¨æƒ…é¢æ¿çš„æ¨£å¼ï¼Œå¾ˆæ–¹ä¾¿
        item.className = 'sticker-item'; 
        item.style.backgroundImage = `url(${frame.url})`;
        item.title = frame.name;
        
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block';
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆªé™¤é ­åƒæ¡†', `ç¢ºå®šè¦åˆªé™¤â€œ${frame.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.customAvatarFrames.delete(frame.id);
                renderFrameManager(); // åˆ·æ–°ç®¡ç†åˆ—è¡¨
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}

/**
 * ã€V2å¤šé¸ç‰ˆã€‘è™•ç†ç”¨æˆ¶ä¸Šå‚³è‡ªè¨‚é ­åƒæ¡†çš„é‚è¼¯
 */
function handleUploadCustomFrame() {
    document.getElementById('custom-frame-upload-input').addEventListener('change', async (event) => {
        const files = event.target.files;
        if (!files.length) return;

        const newFrames = [];
        
        // ä½¿ç”¨ for...of è¿´åœˆä¾†é€å€‹è™•ç†é¸ä¸­çš„æ–‡ä»¶
        for (const file of files) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è‡ªå‹•ç”Ÿæˆåå­—ï¼Œè€Œä¸æ˜¯è®“ç”¨æˆ¶è¼¸å…¥
            // æˆ‘å€‘ç”¨ "æª”æ¡ˆå (å‰8ä½) + æ™‚é–“æˆ³è¨˜" ä¾†ç¢ºä¿åå­—å¹¾ä¹ä¸æœƒé‡è¤‡
            const fileName = file.name.replace(/\.[^/.]+$/, "").substring(0, 8);
            const autoName = `${fileName}_${Date.now()}`;

            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
            
            newFrames.push({
                id: 'frame_' + (Date.now() + newFrames.length), // ç¢ºä¿IDå”¯ä¸€
                name: autoName,
                url: base64Url
            });
        }
        
        // è¿´åœˆçµæŸå¾Œï¼Œæ‰¹é‡æ·»åŠ åˆ°è³‡æ–™åº«
        if (newFrames.length > 0) {
            await db.customAvatarFrames.bulkAdd(newFrames);
            renderFrameManager(); // åˆ·æ–°ç®¡ç†åˆ—è¡¨
            await showCustomAlert("ä¸Šå‚³æˆåŠŸ", `å·²æˆåŠŸæ·»åŠ  ${newFrames.length} å€‹æ–°é ­åƒæ¡†ï¼`);
        }

        // æ¸…ç©ºæª”é¸æ“‡å™¨çš„å€¼
        event.target.value = null;
    }, { once: true });

    document.getElementById('custom-frame-upload-input').click();
}

// â–²â–²â–² æ–°å¢åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²æ·»åŠ æ–°åˆ†æ”¯ã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ â–¼â–¼â–¼
async function openFrameSelectorModal(type, targetId = null) {
    const grid = document.getElementById('avatar-frame-grid');
    grid.innerHTML = '';
    
    currentFrameSelection.type = type;
    currentFrameSelection.target = targetId;
    
    const chat = state.chats[state.activeChatId];
    let currentFrameUrl = '';
    let previewAvatarUrl = '';

    // --- â–¼â–¼â–¼ é€™å°±æ˜¯æ–°å¢çš„åˆ†æ”¯é‚è¼¯ï¼â–¼â–¼â–¼ ---
    if (type === 'char-weibo') { 
        // å¦‚æœæ˜¯ç‚ºâ€œè§’è‰²å¾®åšâ€æ›æ¡†
        const charChat = state.chats[currentViewingWeiboProfileId];
        currentFrameUrl = charChat.settings.weiboAvatarFrame || '';
        previewAvatarUrl = charChat.settings.weiboAvatar || defaultAvatar;
    }
    // --- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² ---
    else if (type === 'home_profile') {
        currentFrameUrl = state.globalSettings.homeAvatarFrame || '';
        previewAvatarUrl = document.getElementById('profile-avatar-img').src;
    } 
    else if (type === 'weibo_profile') {
        currentFrameUrl = state.qzoneSettings.weiboAvatarFrame || '';
        previewAvatarUrl = state.qzoneSettings.weiboAvatar || defaultAvatar;
    } 
    else if (type === 'ai') {
        currentFrameUrl = chat.settings.aiAvatarFrame || '';
        previewAvatarUrl = chat.settings.aiAvatar || defaultAvatar;
    } else if (type === 'my') {
        currentFrameUrl = chat.settings.myAvatarFrame || '';
        previewAvatarUrl = chat.settings.myAvatar || defaultAvatar;
    } else if (type === 'member' && targetId) {
        const member = chat.members.find(m => m.id === targetId);
        if (member) {
            currentFrameUrl = member.avatarFrame || '';
            previewAvatarUrl = member.avatar || defaultGroupMemberAvatar;
        }
    }
    
    // å¾ŒçºŒæ¸²æŸ“é‚è¼¯ä¿æŒä¸è®Š
    const customFrames = await db.customAvatarFrames.toArray();
    const frameUrlSet = new Set();
    const allFrames = [...avatarFrames, ...customFrames].filter(frame => {
        if (!frame.url || !frameUrlSet.has(frame.url)) {
            frameUrlSet.add(frame.url);
            return true;
        }
        return false;
    });

    allFrames.forEach(frame => {
        const item = createFrameItem(frame, previewAvatarUrl);
        if (currentFrameUrl === frame.url) {
            item.classList.add('selected');
            currentFrameSelection.url = frame.url;
        }
        grid.appendChild(item);
    });

    document.getElementById('avatar-frame-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// è¼”åŠ©å‡½æ•¸ï¼šå‰µå»ºä¸€å€‹é ­åƒæ¡†é¸é …
function createFrameItem(frame, previewAvatarSrc) {
    const item = document.createElement('div');
    item.className = 'frame-item';
    item.title = frame.name;
    item.innerHTML = `
        <img src="${previewAvatarSrc}" class="preview-avatar">
        ${frame.url ? `<img src="${frame.url}" class="preview-frame" style="pointer-events: none;">` : ''}
    `;
    item.addEventListener('click', () => {
        document.querySelectorAll('#avatar-frame-grid .frame-item').forEach(el => el.classList.remove('selected'));
        item.classList.add('selected');
        currentFrameSelection.url = frame.url;
    });
    return item;
}

// ä¿å­˜é¸æ“‡
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²æ·»åŠ æ–°åˆ†æ”¯ã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ â–¼â–¼â–¼
async function saveSelectedFrames() {
    const chat = state.chats[state.activeChatId];
    const { type, url, target } = currentFrameSelection;

    // --- â–¼â–¼â–¼ é€™å°±æ˜¯æ–°å¢çš„åˆ†æ”¯é‚è¼¯ï¼â–¼â–¼â–¼ ---
    if (type === 'char-weibo') {
        const charChat = state.chats[currentViewingWeiboProfileId];
        if (charChat) {
            charChat.settings.weiboAvatarFrame = url;
            await db.chats.put(charChat);
            await renderWeiboCharProfile(currentViewingWeiboProfileId);
        }
    }
    // --- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² ---
    else if (type === 'home_profile') {
        if (!state.globalSettings) state.globalSettings = {};
        state.globalSettings.homeAvatarFrame = url;
        await db.globalSettings.put(state.globalSettings);
        renderHomeScreenProfileFrame(); 
    } 
    else if (type === 'weibo_profile') {
        if (!state.qzoneSettings) state.qzoneSettings = {};
        state.qzoneSettings.weiboAvatarFrame = url;
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
    else if (type === 'ai') {
        chat.settings.aiAvatarFrame = url;
        await db.chats.put(chat);
    } else if (type === 'my') {
        chat.settings.myAvatarFrame = url;
        await db.chats.put(chat);
    } else if (type === 'member' && target) {
        const member = chat.members.find(m => m.id === target);
        if (member) member.avatarFrame = url;
        await db.chats.put(chat);
    }
    
    document.getElementById('avatar-frame-modal').classList.remove('visible');
    
    // ä¿®æ­£ï¼šåªæœ‰ç•¶ä¸æ˜¯å¾®åšæˆ–ä¸»è¢å¹•çš„é ­åƒæ¡†è¨­ç½®æ™‚ï¼Œæ‰åˆ·æ–°èŠå¤©ä»‹é¢
    if (type !== 'weibo_profile' && type !== 'home_profile' && type !== 'char-weibo') {
        renderChatInterface(state.activeChatId);
        if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
            document.getElementById('chat-settings-btn').click();
            document.getElementById('chat-settings-btn').click();
        }
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * æª¢æŸ¥å…©å€‹æ™‚é–“æˆ³è¨˜æ˜¯å¦åœ¨ä¸åŒçš„è‡ªç„¶æ—¥
 * @param {number} timestamp1 - æ–°æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 * @param {number | null} timestamp2 - ä¸Šä¸€æ¢æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 * @returns {boolean} - å¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œè¿”å› true
 */
function isNewDay(timestamp1, timestamp2) {
    // å¦‚æœæ²’æœ‰ä¸Šä¸€æ¢æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜ï¼Œèªªæ˜é€™æ˜¯ç¬¬ä¸€æ¢æ¶ˆæ¯ï¼Œè‚¯å®šè¦é¡¯ç¤ºæ—¥æœŸ
    if (!timestamp2) return true;

    const date1 = new Date(timestamp1);
    const date2 = new Date(timestamp2);

    // æ¯”è¼ƒå¹´ã€æœˆã€æ—¥æ˜¯å¦å®Œå…¨ç›¸åŒ
    return date1.getFullYear() !== date2.getFullYear() ||
           date1.getMonth()    !== date2.getMonth()    ||
           date1.getDate()     !== date2.getDate();
}

/**
 * å°‡æ™‚é–“æˆ³è¨˜æ ¼å¼åŒ–ç‚º "XæœˆXæ—¥ HH:mm" çš„å½¢å¼
 * @param {number} timestamp - æ™‚é–“æˆ³è¨˜
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„æ—¥æœŸå­—ä¸²
 */
function formatDateStamp(timestamp) {
    const date = new Date(timestamp);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
}

/**
 * ã€å…¨æ–°ã€‘æ ¹æ“šæ™‚é–“æˆ³è¨˜ï¼Œæ ¼å¼åŒ–èŠå¤©åˆ—è¡¨å³å´çš„æ—¥æœŸ/æ™‚é–“é¡¯ç¤º
 * @param {number} timestamp - æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„å­—ä¸² (ä¾‹å¦‚ "14:30", "æ˜¨å¤©", "08/03")
 */
function formatChatListTimestamp(timestamp) {
    if (!timestamp) return ''; // å¦‚æœæ²’æœ‰æ™‚é–“æˆ³è¨˜ï¼Œè¿”å›ç©ºå­—ä¸²

    const now = new Date();
    const msgDate = new Date(timestamp);

    // åˆ¤æ–·æ˜¯å¦ç‚ºä»Šå¤©
    const isToday = now.getFullYear() === msgDate.getFullYear() &&
                    now.getMonth() === msgDate.getMonth() &&
                    now.getDate() === msgDate.getDate();

    if (isToday) {
        // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªé¡¯ç¤ºæ™‚é–“
        return msgDate.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    // åˆ¤æ–·æ˜¯å¦ç‚ºæ˜¨å¤©
    const yesterday = new Date();
    yesterday.setDate(now.getDate() - 1);
    const isYesterday = yesterday.getFullYear() === msgDate.getFullYear() &&
                        yesterday.getMonth() === msgDate.getMonth() &&
                        yesterday.getDate() === msgDate.getDate();

    if (isYesterday) {
        return 'æ˜¨å¤©';
    }

    // åˆ¤æ–·æ˜¯å¦ç‚ºä»Šå¹´
    if (now.getFullYear() === msgDate.getFullYear()) {
        // å¦‚æœæ˜¯ä»Šå¹´ï¼Œé¡¯ç¤º "æœˆ/æ—¥"
        const month = String(msgDate.getMonth() + 1).padStart(2, '0');
        const day = String(msgDate.getDate()).padStart(2, '0');
        return `${month}/${day}`;
    }

    // å¦‚æœæ˜¯æ›´æ—©çš„å¹´ä»½ï¼Œé¡¯ç¤º "å¹´/æœˆ/æ—¥"
    const year = msgDate.getFullYear();
    const month = String(msgDate.getMonth() + 1).padStart(2, '0');
    const day = String(msgDate.getDate()).padStart(2, '0');
    return `${year}/${month}/${day}`;
}

/**
 * ã€å…¨æ–°ã€‘å‰µå»ºä¸€å€‹åŠŸèƒ½å®Œæ•´çš„æ—¥æœŸæˆ³â€œå½æ¶ˆæ¯â€å…ƒç´ 
 * @param {number} timestamp - è©²æ—¥æœŸæˆ³ä»£è¡¨çš„æ™‚é–“
 * @returns {HTMLElement} - å‰µå»ºå¥½çš„ DOM å…ƒç´ 
 */
function createDateStampElement(timestamp) {
    // 1. å‰µå»ºæœ€å¤–å±¤çš„åŒ…è£¹ divï¼Œå’ŒçœŸå¯¦æ¶ˆæ¯ä¸€æ¨£
    const wrapper = document.createElement('div');
    wrapper.className = 'message-wrapper date-stamp-wrapper';
    // ã€æ ¸å¿ƒã€‘æŠŠæ™‚é–“æˆ³è¨˜å­˜èµ·ä¾†ï¼Œé€™æ˜¯å¤šé¸å’Œåˆªé™¤çš„é—œéµ
    wrapper.dataset.timestamp = timestamp; 

    // 2. å‰µå»ºæ°£æ³¡ div
    const bubble = document.createElement('div');
    // ã€æ ¸å¿ƒã€‘åŒæ™‚åŠ ä¸Š .message-bubble é¡ï¼Œè®“å¤šé¸é‚è¼¯èƒ½æ‰¾åˆ°å®ƒ
    bubble.className = 'message-bubble date-stamp-bubble';
    bubble.dataset.timestamp = timestamp;
    bubble.textContent = formatDateStamp(timestamp);
    
    wrapper.appendChild(bubble);

    // 3. ã€æ ¸å¿ƒã€‘ç‚ºå®ƒç¶å®šå’ŒçœŸå¯¦æ¶ˆæ¯å®Œå…¨ä¸€æ¨£çš„äº‹ä»¶ç›£è½å™¨
    addLongPressListener(wrapper, () => {
        // æ—¥æœŸæˆ³ä¸æ”¯æŒè¤‡é›œæ“ä½œï¼Œé•·æŒ‰ç›´æ¥é€²å…¥å¤šé¸
        enterSelectionMode(timestamp);
    });
    wrapper.addEventListener('click', () => { 
        if (isSelectionMode) {
            toggleMessageSelection(timestamp);
        }
    });

    return wrapper;
}
// â–¼â–¼â–¼ åœ¨ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ï¼Œé»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

// --- ç¾åŒ–åŠŸèƒ½çš„æ ¸å¿ƒè®Šæ•¸ ---
let activeThemeId = null; // ç”¨æ–¼è¿½è¹¤ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„ä¸»é¡ŒID

/**
 * å°‡CSSä»£ç¢¼æ‡‰ç”¨åˆ°é é¢ä¸Š
 * @param {string} cssCode - è¦æ‡‰ç”¨çš„CSSä»£ç¢¼å­—ä¸²
 */
function applyThemeCss(cssCode) {
    const styleTag = document.getElementById('custom-theme-style');
    if (styleTag) {
        styleTag.innerHTML = cssCode || '';
    }
}

/**
 * å¾è³‡æ–™åº«è¼‰å…¥æ‰€æœ‰ä¸»é¡Œåˆ°ä¸‹æ‹‰é¸æ“‡æ¡†
 */
async function loadThemesToDropdown() {
    const selector = document.getElementById('theme-selector');
    selector.innerHTML = '<option value="">-- é¸æ“‡æ–¹æ¡ˆæˆ–æ–°å»º --</option>'; // é è¨­é¸é …
    
    const themes = await db.themes.toArray();
    themes.forEach(theme => {
        const option = document.createElement('option');
        option.value = theme.id;
        option.textContent = theme.name;
        selector.appendChild(option);
    });
}

/**
 * è™•ç†ä½¿ç”¨è€…å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡ä¸€å€‹ä¸»é¡Œçš„é‚è¼¯
 */
async function handleThemeSelection() {
    const selector = document.getElementById('theme-selector');
    const editor = document.getElementById('theme-css-editor');
    activeThemeId = selector.value ? parseInt(selector.value) : null;
    
    if (activeThemeId) {
        const theme = await db.themes.get(activeThemeId);
        editor.value = theme.css;
    } else {
        // å¦‚æœé¸æ“‡â€œ--â€ï¼Œå°±è¼‰å…¥ç¯„æœ¬
        editor.value = THEME_CSS_TEMPLATE;
    }
    // ç«‹å³æ‡‰ç”¨é¸ä¸­çš„æˆ–ç¯„æœ¬ä»£ç¢¼ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°æ•ˆæœ
    applyThemeCss(editor.value);
}

/**
 * ä¿å­˜ç•¶å‰ç·¨è¼¯å€çš„å…§å®¹åˆ°ç•¶å‰é¸ä¸­çš„ä¸»é¡Œ
 */
async function saveCurrentTheme() {
    if (!activeThemeId) {
        alert("è«‹å…ˆé¸æ“‡ä¸€å€‹æ–¹æ¡ˆï¼Œæˆ–ä½¿ç”¨â€œå¦å­˜ç‚ºâ€ä¾†å‰µå»ºæ–°æ–¹æ¡ˆã€‚");
        return;
    }
    const cssCode = document.getElementById('theme-css-editor').value;
    await db.themes.update(activeThemeId, { css: cssCode });
    alert("ç•¶å‰æ–¹æ¡ˆå·²ä¿å­˜ï¼");
}

/**
 * å°‡ç•¶å‰ç·¨è¼¯å€çš„å…§å®¹å¦å­˜ç‚ºä¸€å€‹æ–°ä¸»é¡Œ
 */
async function saveAsNewTheme() {
    const themeName = await showCustomPrompt("ä¿å­˜æ–°æ–¹æ¡ˆ", "è«‹è¼¸å…¥æ–°æ–¹æ¡ˆçš„åç¨±");
    if (!themeName || !themeName.trim()) {
        if(themeName !== null) alert("æ–¹æ¡ˆåç¨±ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }
    const cssCode = document.getElementById('theme-css-editor').value;
    const newTheme = { name: themeName.trim(), css: cssCode };
    const newId = await db.themes.add(newTheme);
    
    // åˆ·æ–°ä¸‹æ‹‰æ¸…å–®ä¸¦è‡ªå‹•é¸ä¸­æ–°ä¿å­˜çš„æ–¹æ¡ˆ
    await loadThemesToDropdown();
    document.getElementById('theme-selector').value = newId;
    activeThemeId = newId;
    
    alert(`æ–¹æ¡ˆ "${themeName}" å·²æˆåŠŸä¿å­˜ï¼`);
}

/**
 * é‡å‘½åç•¶å‰é¸ä¸­çš„ä¸»é¡Œ
 */
async function renameSelectedTheme() {
    if (!activeThemeId) {
        alert("è«‹å…ˆé¸æ“‡ä¸€å€‹è¦é‡å‘½åçš„æ–¹æ¡ˆã€‚");
        return;
    }
    const currentTheme = await db.themes.get(activeThemeId);
    const newName = await showCustomPrompt("é‡å‘½åæ–¹æ¡ˆ", "è«‹è¼¸å…¥æ–°çš„åç¨±", currentTheme.name);
    if (newName && newName.trim()) {
        await db.themes.update(activeThemeId, { name: newName.trim() });
        await loadThemesToDropdown();
        document.getElementById('theme-selector').value = activeThemeId;
        alert("é‡å‘½åæˆåŠŸï¼");
    }
}

/**
 * åˆªé™¤ç•¶å‰é¸ä¸­çš„ä¸»é¡Œ
 */
async function deleteSelectedTheme() {
    if (!activeThemeId) {
        alert("è«‹å…ˆé¸æ“‡ä¸€å€‹è¦åˆªé™¤çš„æ–¹æ¡ˆã€‚");
        return;
    }
    const confirmed = await showCustomConfirm(
        "ç¢ºèªåˆªé™¤", 
        `ç¢ºå®šè¦åˆªé™¤æ–¹æ¡ˆ "${document.getElementById('theme-selector').selectedOptions[0].textContent}" å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        await db.themes.delete(activeThemeId);
        activeThemeId = null;
        await loadThemesToDropdown();
        // æ¢å¾©åˆ°ç¯„æœ¬ç‹€æ…‹
        document.getElementById('theme-css-editor').value = THEME_CSS_TEMPLATE;
        applyThemeCss(THEME_CSS_TEMPLATE);
        alert("æ–¹æ¡ˆå·²åˆªé™¤ã€‚");
    }
}

/**
 * åŒ¯å‡ºç•¶å‰é¸ä¸­çš„ä¸»é¡Œç‚ºä¸€å€‹JSONæª”
 */
async function exportTheme() {
    if (!activeThemeId) {
        alert("è«‹å…ˆé¸æ“‡ä¸€å€‹è¦åŒ¯å‡ºçš„æ–¹æ¡ˆã€‚");
        return;
    }
    const theme = await db.themes.get(activeThemeId);
    const exportData = {
        themeName: theme.name,
        themeCss: theme.css
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${theme.name}-Theme.json`;
    a.click();
    URL.revokeObjectURL(url);
}

/**
 * å°å…¥ä¸€å€‹ä¸»é¡ŒJSONæª”
 */
function importTheme(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.themeName && typeof data.themeCss !== 'undefined') {
                // ç‚ºäº†é¿å…é‡åï¼Œå°å…¥æ™‚å¯ä»¥åœ¨åå­—å¾Œé¢åŠ å€‹ "(å°å…¥)"
                const newTheme = {
                    name: `${data.themeName} (å°å…¥)`,
                    css: data.themeCss
                };
                const newId = await db.themes.add(newTheme);
                await loadThemesToDropdown();
                document.getElementById('theme-selector').value = newId;
                handleThemeSelection(); // å°å…¥å¾Œè‡ªå‹•é¸ä¸­ä¸¦æ‡‰ç”¨
                alert(`æ–¹æ¡ˆ "${newTheme.name}" å°å…¥æˆåŠŸï¼`);
            } else {
                alert("å°å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚");
            }
        } catch (error) {
            alert(`å°å…¥å¤±æ•—ï¼šæª”è§£æéŒ¯èª¤ã€‚ ${error.message}`);
        }
    };
    reader.readAsText(file);
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘APIé è¨­åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * æ¸²æŸ“ä¸¦å¡«å……APIé è¨­çš„ä¸‹æ‹‰é¸æ“‡æ¡†
 */
function renderApiPresetSelector() {
    const selectEl = document.getElementById('api-preset-select');
    if (!selectEl) return;

    selectEl.innerHTML = '<option value="">-- è‡ªè¨‚é…ç½® --</option>';

    if (state.apiPresets) {
        state.apiPresets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.id;
            option.textContent = preset.name;
            selectEl.appendChild(option);
        });
    }

    // æª¢æŸ¥ç•¶å‰é…ç½®æ˜¯å¦åŒ¹é…ä»»ä½•ä¸€å€‹é è¨­
    const { proxyUrl, apiKey } = state.apiConfig;
    const matchingPreset = state.apiPresets ? state.apiPresets.find(p => p.proxyUrl === proxyUrl && p.apiKey === apiKey) : null;

    if (matchingPreset) {
        selectEl.value = matchingPreset.id;
    } else {
        selectEl.value = ""; // å¦‚æœä¸åŒ¹é…ä»»ä½•é è¨­ï¼Œå‰‡é¸ä¸­â€œè‡ªè¨‚é…ç½®â€
    }
}

/**
 * ç•¶ç”¨æˆ¶åœ¨ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹é è¨­æ™‚è§¸ç™¼
 */
function handleApiPresetSelectChange() {
    const selectEl = document.getElementById('api-preset-select');
    const proxyUrlInput = document.getElementById('proxy-url');
    const apiKeyInput = document.getElementById('api-key');
    const selectedId = parseInt(selectEl.value);

    if (selectedId && state.apiPresets) {
        const selectedPreset = state.apiPresets.find(p => p.id === selectedId);
        if (selectedPreset) {
            proxyUrlInput.value = selectedPreset.proxyUrl;
            apiKeyInput.value = selectedPreset.apiKey;
        }
    }
}

/**
 * æ‰“é–‹é è¨­ç®¡ç†çš„æ“ä½œåŠŸèƒ½è¡¨
 */
async function openApiPresetManager() {
    const selectEl = document.getElementById('api-preset-select');
    const selectedId = parseInt(selectEl.value);
    const selectedPreset = state.apiPresets ? state.apiPresets.find(p => p.id === selectedId) : null;

    const modal = document.getElementById('preset-actions-modal');
    const footer = modal.querySelector('.custom-modal-footer');

    footer.innerHTML = `
        <button id="preset-action-save-new">ä¿å­˜ç•¶å‰é…ç½®ç‚ºæ–°é è¨­</button>
        <button id="preset-action-update-current" ${!selectedPreset ? 'disabled' : ''}>æ›´æ–°ç•¶å‰é…ç½®</button>
        <button id="preset-action-delete-current" class="btn-danger" ${!selectedPreset ? 'disabled' : ''}>åˆªé™¤ç•¶å‰é…ç½®</button>
        <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
    `;

    document.getElementById('preset-action-save-new').addEventListener('click', saveCurrentApiConfigAsPreset);
    if (selectedPreset) {
        document.getElementById('preset-action-update-current').addEventListener('click', () => updateSelectedApiPreset(selectedId));
        document.getElementById('preset-action-delete-current').addEventListener('click', () => deleteSelectedApiPreset(selectedId));
    }
    document.getElementById('preset-action-cancel').addEventListener('click', () => modal.classList.remove('visible'));

    modal.classList.add('visible');
}

/**
 * å°‡ç•¶å‰è¼¸å…¥æ¡†çš„å…§å®¹ä¿å­˜ç‚ºä¸€å€‹æ–°çš„é è¨­
 */
async function saveCurrentApiConfigAsPreset() {
    const proxyUrl = document.getElementById('proxy-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();

    if (!proxyUrl || !apiKey) {
        alert('ä»£ç†ä½å€å’Œé‡‘é‘°éƒ½ä¸èƒ½ç‚ºç©ºï¼');
        return;
    }

    const name = await showCustomPrompt('ä¿å­˜APIé è¨­', 'è«‹ç‚ºé€™å€‹é…ç½®èµ·å€‹åå­—ï¼š');
    if (name && name.trim()) {
        const newPreset = { name: name.trim(), proxyUrl, apiKey };
        const newId = await db.apiPresets.add(newPreset);
        
        if (!state.apiPresets) state.apiPresets = [];
        state.apiPresets.push({ id: newId, ...newPreset });

        renderApiPresetSelector(); 
        document.getElementById('api-preset-select').value = newId; 
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('æˆåŠŸ', `APIé è¨­ "${name.trim()}" å·²ä¿å­˜ï¼`);
    }
}

/**
 * æ›´æ–°ç•¶å‰é¸ä¸­çš„é è¨­
 */
async function updateSelectedApiPreset(presetId) {
    const proxyUrl = document.getElementById('proxy-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();

    if (!proxyUrl || !apiKey) {
        alert('ä»£ç†ä½å€å’Œé‡‘é‘°éƒ½ä¸èƒ½ç‚ºç©ºï¼');
        return;
    }

    const preset = state.apiPresets.find(p => p.id === presetId);
    if (preset) {
        preset.proxyUrl = proxyUrl;
        preset.apiKey = apiKey;
        await db.apiPresets.put(preset);
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('æˆåŠŸ', `é è¨­ "${preset.name}" å·²æ›´æ–°ï¼`);
    }
}

/**
 * åˆªé™¤ç•¶å‰é¸ä¸­çš„é è¨­
 */
async function deleteSelectedApiPreset(presetId) {
    const preset = state.apiPresets.find(p => p.id === presetId);
    if (preset) {
        const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', `ç¢ºå®šè¦åˆªé™¤APIé è¨­ "${preset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.apiPresets.delete(presetId);
            state.apiPresets = state.apiPresets.filter(p => p.id !== presetId);

            renderApiPresetSelector();
            document.getElementById('preset-actions-modal').classList.remove('visible');
            await showCustomAlert('æˆåŠŸ', 'é è¨­å·²åˆªé™¤ã€‚');
        }
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°£æ³¡æ¨£å¼é è¨­åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * æ¸²æŸ“ä¸¦å¡«å……æ°£æ³¡æ¨£å¼é è¨­çš„ä¸‹æ‹‰é¸æ“‡æ¡†
 */
function renderBubblePresetSelector() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const customCssInput = document.getElementById('custom-css-input');

    selectEl.innerHTML = '<option value="">-- ç„¡é è¨­ --</option>';

    if (state.bubbleStylePresets) {
        state.bubbleStylePresets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.id;
            option.textContent = preset.name;
            selectEl.appendChild(option);
        });
    }

    // æª¢æŸ¥ç•¶å‰èŠå¤©çš„CSSæ˜¯å¦åŒ¹é…ä»»ä½•ä¸€å€‹é è¨­
    const currentCss = customCssInput.value.trim();
    const matchingPreset = state.bubbleStylePresets ? state.bubbleStylePresets.find(p => p.css.trim() === currentCss) : null;

    if (matchingPreset) {
        selectEl.value = matchingPreset.id;
    } else {
        selectEl.value = ""; // å¦‚æœä¸åŒ¹é…ä»»ä½•é è¨­ï¼Œå‰‡é¸ä¸­â€œç„¡é è¨­â€
    }
}

/**
 * ç•¶ç”¨æˆ¶åœ¨ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹é è¨­æ™‚è§¸ç™¼
 */
function handlePresetSelectChange() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const customCssInput = document.getElementById('custom-css-input');
    const selectedId = parseInt(selectEl.value);

    if (selectedId && state.bubbleStylePresets) {
        const selectedPreset = state.bubbleStylePresets.find(p => p.id === selectedId);
        if (selectedPreset) {
            customCssInput.value = selectedPreset.css;
        }
    }
    updateSettingsPreview(); // ç„¡è«–å¦‚ä½•éƒ½æ›´æ–°é è¦½
}

/**
 * æ‰“é–‹é è¨­ç®¡ç†çš„æ“ä½œåŠŸèƒ½è¡¨
 */
async function openBubblePresetManager() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const selectedId = parseInt(selectEl.value);
    const selectedPreset = state.bubbleStylePresets ? state.bubbleStylePresets.find(p => p.id === selectedId) : null;

    const modal = document.getElementById('preset-actions-modal'); // è¤‡ç”¨ç¾æœ‰æ¨¡æ…‹æ¡†
    const footer = modal.querySelector('.custom-modal-footer');

    footer.innerHTML = `
        <button id="preset-action-save-new">ä¿å­˜</button>
        <button id="preset-action-update-current" ${!selectedPreset ? 'disabled' : ''}>æ›´æ–°</button>
        <button id="preset-action-delete-current" class="btn-danger" ${!selectedPreset ? 'disabled' : ''}>åˆªé™¤</button>
        <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
    `;

    // é‡æ–°ç¶å®šäº‹ä»¶
    document.getElementById('preset-action-save-new').addEventListener('click', saveCurrentCssAsPreset);
    if (selectedPreset) {
        document.getElementById('preset-action-update-current').addEventListener('click', () => updateSelectedPreset(selectedId));
        document.getElementById('preset-action-delete-current').addEventListener('click', () => deleteSelectedPreset(selectedId));
    }
    document.getElementById('preset-action-cancel').addEventListener('click', () => modal.classList.remove('visible'));

    modal.classList.add('visible');
}

/**
 * å°‡ç•¶å‰CSSæ–‡å­—æ–¹å¡Šçš„å…§å®¹ä¿å­˜ç‚ºä¸€å€‹æ–°çš„é è¨­
 */
async function saveCurrentCssAsPreset() {
    const customCssInput = document.getElementById('custom-css-input');
    const css = customCssInput.value.trim();
    if (!css) {
        alert('CSSå…§å®¹ä¸èƒ½ç‚ºç©ºï¼');
        return;
    }

    const name = await showCustomPrompt('ä¿å­˜é è¨­', 'è«‹ç‚ºé€™å€‹æ°£æ³¡æ¨£å¼å‘½åï¼š');
    if (name && name.trim()) {
        const newPreset = { name: name.trim(), css: css };
        const newId = await db.bubbleStylePresets.add(newPreset);
        
        if (!state.bubbleStylePresets) state.bubbleStylePresets = [];
        state.bubbleStylePresets.push({ id: newId, ...newPreset });

        renderBubblePresetSelector(); 
        document.getElementById('bubble-style-preset-select').value = newId; 
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('æˆåŠŸ', `é è¨­ "${name.trim()}" å·²ä¿å­˜ï¼`);
    }
}

/**
 * æ›´æ–°ç•¶å‰é¸ä¸­çš„é è¨­
 */
async function updateSelectedPreset(presetId) {
    const customCssInput = document.getElementById('custom-css-input');
    const css = customCssInput.value.trim();

    const preset = state.bubbleStylePresets.find(p => p.id === presetId);
    if (preset) {
        preset.css = css;
        await db.bubbleStylePresets.put(preset);
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('æˆåŠŸ', `é è¨­ "${preset.name}" å·²æ›´æ–°ï¼`);
    }
}

/**
 * åˆªé™¤ç•¶å‰é¸ä¸­çš„é è¨­
 */
async function deleteSelectedPreset(presetId) {
    const preset = state.bubbleStylePresets.find(p => p.id === presetId);
    if (preset) {
        const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', `ç¢ºå®šè¦åˆªé™¤é è¨­ "${preset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.bubbleStylePresets.delete(presetId);
            state.bubbleStylePresets = state.bubbleStylePresets.filter(p => p.id !== presetId);

            renderBubblePresetSelector(); 
            document.getElementById('custom-css-input').value = '';
            updateSettingsPreview();

            document.getElementById('preset-actions-modal').classList.remove('visible');
            await showCustomAlert('æˆåŠŸ', 'é è¨­å·²åˆªé™¤ã€‚');
        }
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¾†é›»éˆ´è²æ§åˆ¶å‡½æ•¸ â–¼â–¼â–¼

/**
 * æ’­æ”¾ä¾†é›»éˆ´è²
 */
function playRingtone() {
    const ringtonePlayer = document.getElementById('ringtone-player');
    // å„ªå…ˆä½¿ç”¨ç”¨æˆ¶åœ¨è¨­ç½®ä¸­ä¿å­˜çš„URLï¼Œå¦‚æœæ²’è¨­ç½®ï¼Œå°±ç”¨æˆ‘å€‘é è¨­çš„URL
    const ringtoneUrl = state.globalSettings.ringtoneUrl || 'https://files.catbox.moe/3w7gla.mp3';
    
    if (ringtonePlayer && ringtoneUrl) {
        ringtonePlayer.src = ringtoneUrl;
        // play() è¿”å›ä¸€å€‹ Promiseï¼Œæˆ‘å€‘æœ€å¥½ç”¨ try...catch åŒ…è£¹ä»¥é˜²æ­¢æµè¦½å™¨å ±éŒ¯
        const playPromise = ringtonePlayer.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error("éˆ´è²æ’­æ”¾å¤±æ•—:", error);
                // å¯ä»¥åœ¨é€™è£¡çµ¦ç”¨æˆ¶ä¸€å€‹éœéŸ³æç¤ºï¼Œå¦‚æœéœ€è¦çš„è©±
            });
        }
    }
}

/**
 * åœæ­¢ä¸¦é‡ç½®ä¾†é›»éˆ´è²
 */
function stopRingtone() {
    const ringtonePlayer = document.getElementById('ringtone-player');
    if (ringtonePlayer) {
        ringtonePlayer.pause();
        ringtonePlayer.currentTime = 0; // å°‡æ’­æ”¾é€²åº¦é‡ç½®åˆ°é–‹é ­
    }
}


// â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™æ®µã€å„ªåŒ–å¾Œã€‘çš„ä»£ç¢¼æ›¿æ› â–¼â–¼â–¼
/**
 * ã€å„ªåŒ–ç‰ˆã€‘æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³ï¼Œå¢åŠ å¥å£¯æ€§
 */
function playNotificationSound() {
    const soundUrl = state.globalSettings.notificationSoundUrl || 'https://laddy-lulu.github.io/Ephone-stuffs/message.mp3';
    
    // 1. å¢åŠ å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœé€£çµç‚ºç©ºï¼Œç›´æ¥è¿”å›ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œ
    if (!soundUrl || !soundUrl.trim()) return;

    try {
        const audio = new Audio(soundUrl);
        audio.volume = 0.7; 
        
        audio.play().catch(error => {
            // 2. å„ªåŒ–éŒ¯èª¤æç¤ºï¼Œç¾åœ¨èƒ½æ›´æº–ç¢ºåœ°åæ˜ å•é¡Œ
            if (error.name === 'NotAllowedError') {
                console.warn("æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³å¤±æ•—ï¼šä½¿ç”¨è€…éœ€è¦å…ˆèˆ‡é é¢é€²è¡Œä¸€æ¬¡äº¤äº’ï¼ˆå¦‚é»æ“Šï¼‰æ‰èƒ½è‡ªå‹•æ’­æ”¾éŸ³è¨Šã€‚");
            } else {
                // å°æ–¼å…¶ä»–éŒ¯èª¤ï¼ˆæ¯”å¦‚æˆ‘å€‘é€™æ¬¡é‡åˆ°çš„ï¼‰ï¼Œç›´æ¥åˆ—å°éŒ¯èª¤è©³æƒ…
                console.error(`æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³å¤±æ•— (${error.name}): ${error.message}`, "URL:", soundUrl);
            }
        });
    } catch (error) {
        console.error("å‰µå»ºæç¤ºéŸ³Audioå°è±¡æ™‚å‡ºéŒ¯:", error);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘éŸ³è¨Šä¸Šä¸‹æ–‡è§£é–å‡½æ•¸ï¼ˆä¿®å¾©éˆ´è²ç„¡æ³•è‡ªå‹•æ’­æ”¾çš„å•é¡Œï¼‰ â–¼â–¼â–¼
function unlockAudioContext() {
    const ringtonePlayer = document.getElementById('ringtone-player');
    // æª¢æŸ¥æ’­æ”¾æ©Ÿæ˜¯å¦è™•æ–¼æš«åœç‹€æ…‹ï¼Œä¸¦ä¸”æˆ‘å€‘ä¹‹å‰æ²’æœ‰æˆåŠŸæ’­æ”¾é
    if (ringtonePlayer && ringtonePlayer.paused) {
        // å˜—è©¦æ’­æ”¾ï¼Œç„¶å¾Œç«‹åˆ»æš«åœã€‚
        // é€™å€‹æ“ä½œå°ç”¨æˆ¶æ˜¯ç„¡æ„ŸçŸ¥çš„ï¼Œä½†èƒ½å‘Šè¨´æµè¦½å™¨ç”¨æˆ¶å·²èˆ‡éŸ³è¨Šäº¤äº’ã€‚
        ringtonePlayer.play().catch(() => {}); // play() æœƒè¿”å›ä¸€å€‹ Promiseï¼Œæˆ‘å€‘å¿½ç•¥ä»»ä½•å¯èƒ½ç™¼ç”Ÿçš„éŒ¯èª¤
        ringtonePlayer.pause();
        console.log("Ringtone audio context unlocked.");
    }
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥æ‰‹æ©Ÿâ€å…§å®¹å–®æ¢åˆªé™¤åŠŸèƒ½ â–¼â–¼â–¼
/**
 * è™•ç†è§’è‰²æ‰‹æ©Ÿå…§è³‡æ–™åˆªé™¤çš„é€šç”¨å‡½æ•¸
 * @param {string} dataType - è¦åˆªé™¤çš„è³‡æ–™é¡å‹, æ¯”å¦‚ 'memos', 'shoppingCart'
 * @param {number} index - è¦åˆªé™¤çš„è³‡æ–™åœ¨é™£åˆ—ä¸­çš„ç´¢å¼•
 */
async function handleCharacterDataDeletion(dataType, index) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    
    let dataArray;
    // è™•ç†åƒ bank.transactions é€™æ¨£çš„åµŒå¥—æ•¸æ“š
    if (dataType.includes('.')) {
        const keys = dataType.split('.');
        dataArray = chat.characterPhoneData[keys[0]][keys[1]];
    } else {
        dataArray = chat.characterPhoneData[dataType];
    }

    if (!chat || !dataArray) return;

    const itemToDelete = dataArray[index];
    if (!itemToDelete) return;

    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤',
        'ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        dataArray.splice(index, 1);
        await db.chats.put(chat);
        
        // æ ¹æ“šåˆªé™¤çš„é¡å‹ï¼Œé‡æ–°æ¸²æŸ“å°æ‡‰çš„APPä»‹é¢
        switch(dataType) {
            case 'memos': renderCharacterMemos(); break;
            case 'shoppingCart': renderCharacterShoppingCart(); break;
            case 'browserHistory': renderCharacterBrowser(); break;
            case 'diary': renderCharacterDiary(); break;
            case 'bank.transactions': renderCharacterBank(); break;
            case 'trajectory': renderCharacterTrajectory(); break;
            case 'appUsage': renderCharacterAppUsage(); break;
            case 'photoAlbum': renderCharacterPhotoAlbum(); break;
        }
        alert('è¨˜éŒ„å·²åˆªé™¤ã€‚');
    }
}
// â–²â–²â–² åˆªé™¤åŠŸèƒ½çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘è™•ç†è§’è‰²æ‰‹æ©Ÿå…§å–®æ¢èŠå¤©æ¶ˆæ¯çš„åˆªé™¤
 * @param {string} contactName - æ­£åœ¨æŸ¥çœ‹çš„é€£çµ¡äººåç¨±
 * @param {number} index - è¦åˆªé™¤çš„æ¶ˆæ¯åœ¨æ­·å²è¨˜éŒ„ä¸­çš„ç´¢å¼•
 */
async function handleCharacterChatMessageDeletion(contactName, index) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    let historyArray;
    // åˆ¤æ–·æ˜¯å’Œâ€œæˆ‘â€çš„èŠå¤©é‚„æ˜¯å’ŒNPCçš„èŠå¤©
    if (contactName === (chat.characterPhoneData.chats['æˆ‘']?.remarkName || 'æˆ‘')) {
        historyArray = chat.history;
    } else {
        historyArray = chat.characterPhoneData.chats[contactName]?.history;
    }

    if (!historyArray || !historyArray[index]) return;

    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤',
        'ç¢ºå®šè¦åˆªé™¤é€™æ¢æ¶ˆæ¯å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        historyArray.splice(index, 1);
        await db.chats.put(chat);
        
        // é‡æ–°æ¸²æŸ“ç•¶å‰èŠå¤©ä»‹é¢
        renderCharacterChatHistory(contactName);
        alert('æ¶ˆæ¯å·²åˆªé™¤ã€‚');
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é–å±åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * æ‡‰ç”¨é–å±å£ç´™åˆ° #lock-screen å…ƒç´ 
 */
function applyLockscreenWallpaper() {
    const lockScreen = document.getElementById('lock-screen');
    const wallpaper = state.globalSettings.lockscreenWallpaper;
    if (wallpaper && wallpaper.startsWith('data:image')) {
        lockScreen.style.backgroundImage = `url(${wallpaper})`;
    } else if (wallpaper) {
        lockScreen.style.backgroundImage = wallpaper;
    }
}

/**
 * é¡¯ç¤ºé–å±ä»‹é¢
 */
function lockPhone() {
    console.log("æ­£åœ¨é–å®šæ‰‹æ©Ÿ...");
    isLocked = true;
    document.getElementById('lock-screen').classList.add('active');
    document.querySelectorAll('.screen:not(#lock-screen)').forEach(s => s.classList.remove('active'));
}

/**
 * è§£é–æ‰‹æ©Ÿï¼Œé¡¯ç¤ºä¸»è¢å¹•
 */
function unlockPhone() {
    console.log("æ‰‹æ©Ÿå·²è§£é–ï¼");
    isLocked = false;
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡å¾¹åº•éš±è—é–å±å’Œæ¯›ç»ç’ƒèƒŒæ™¯
    document.getElementById('lock-screen').classList.remove('active');
    const blurBg = document.getElementById('lock-screen-background-blur');
    blurBg.style.display = 'none';
    blurBg.style.opacity = '0';

    // ç¢ºä¿ä¸»è¢å¹•æ˜¯å”¯ä¸€å•Ÿå‹•çš„é ‚å±¤è¢å¹•
    showScreen('home-screen'); 

    // é‡ç½®é–å±çš„æ¨£å¼ï¼Œç‚ºä¸‹æ¬¡é–å®šåšæº–å‚™
    setTimeout(() => {
        const lockScreen = document.getElementById('lock-screen');
        const unlockHint = document.getElementById('unlock-hint');
        lockScreen.style.transition = 'none'; 
        unlockHint.style.transition = 'none';
        lockScreen.style.transform = 'translateY(0)';
        lockScreen.offsetHeight; 
        lockScreen.style.transition = 'transform 0.3s ease-out';
        unlockHint.style.transition = 'opacity 0.3s ease-out';
    }, 500); 
}

/**
 * é¡¯ç¤ºå¯†ç¢¼è¼¸å…¥å½ˆçª—
 */
function showPasswordModal() {
    const modal = document.getElementById('password-modal-overlay');
    const input = document.getElementById('password-input-field');
    input.value = ''; // æ¸…ç©ºä¸Šæ¬¡è¼¸å…¥
    modal.classList.add('visible');
    setTimeout(() => input.focus(), 100); // å»¶é²èšç„¦ï¼Œç¢ºä¿å‹•ç•«æµæš¢
}

/**
 * éš±è—å¯†ç¢¼è¼¸å…¥å½ˆçª—
 */
function hidePasswordModal() {

document.getElementById('password-modal-overlay').style.backgroundImage = 'none';

    const modal = document.getElementById('password-modal-overlay');
    modal.classList.remove('visible');
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„éŒ¯èª¤å‹•ç•«é¡
    modal.querySelector('.password-modal-content').classList.remove('error');
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç•¶å–æ¶ˆè¼¸å…¥å¯†ç¢¼æ™‚...
    // 1. éš±è—æ¯›ç»ç’ƒèƒŒæ™¯
    const blurBg = document.getElementById('lock-screen-background-blur');
    blurBg.style.opacity = '0';
    setTimeout(() => { blurBg.style.display = 'none'; }, 300); // å‹•ç•«çµæŸå¾Œå†éš±è—

    // 2. è®“é–å±ä»‹é¢æ»‘å›ä¾†
    const lockScreen = document.getElementById('lock-screen');
    const unlockHint = document.getElementById('unlock-hint');
    lockScreen.style.transform = 'translateY(0)';
    unlockHint.style.opacity = '1';
}

/**
 * æª¢æŸ¥ä½¿ç”¨è€…è¼¸å…¥çš„å¯†ç¢¼æ˜¯å¦æ­£ç¢º
 */
function checkPassword() {
    const input = document.getElementById('password-input-field');
    const enteredPassword = input.value;
    const correctPassword = state.globalSettings.password;

    if (enteredPassword === correctPassword) {
        // --- å¯†ç¢¼æ­£ç¢º ---

        // 1. ã€æ ¸å¿ƒé­”è¡“ã€‘æå‰æŠŠä¸»è¢å¹•åœ¨æœ€åº•å±¤å•Ÿå‹•ä¸¦æº–å‚™å¥½ï¼
        //    å› ç‚ºå®ƒ z-index æœ€ä½ï¼Œæ‰€ä»¥ä½ æš«æ™‚é‚„çœ‹ä¸åˆ°å®ƒã€‚
        showScreen('home-screen');

        // 2. éš±è—å¯†ç¢¼è¼¸å…¥æ¡† (å®ƒæœƒè‡ªå·±æ’­æ”¾æ·¡å‡ºå‹•ç•«)
        document.getElementById('password-modal-overlay').classList.remove('visible');
        
        // 3. è®“æ¯›ç»ç’ƒèƒŒæ™¯ä¹Ÿé–‹å§‹æ·¡å‡º
        document.getElementById('lock-screen-background-blur').style.opacity = '0';
        
        // 4. ç­‰å¾…æ·¡å‡ºå‹•ç•«æ’­æ”¾å®Œç•¢ (300æ¯«ç§’)ï¼Œå†åŸ·è¡Œæœ€çµ‚çš„æ¸…ç†å·¥ä½œ
        setTimeout(unlockPhone, 300);

    } else {
        // --- å¯†ç¢¼éŒ¯èª¤ (é‚è¼¯ä¿æŒä¸è®Š) ---
        const content = document.querySelector('.password-modal-content');
        content.classList.add('error');
        input.value = '';
        setTimeout(() => content.classList.remove('error'), 400);
    }
}

/**
 * æ›´æ–°é–å±ä»‹é¢çš„æ™‚é˜
 */
function updateLockClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' });
    document.getElementById('lock-main-time').textContent = timeString;
    document.getElementById('lock-main-date').textContent = dateString;
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ï¼Œé»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

async function openBulkAddStickersModal() {
    const placeholder = `åœ¨é€™è£¡é»è²¼è¡¨æƒ…åŒ…ï¼Œæ¯è¡Œä¸€å€‹ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n\nè²“è²“å–æ°´ï¼šhttps://..../cat.gif\nç‹—ç‹—æ–é ­ï¼šhttps://..../dog.png\n\n(æ”¯æ´ç”¨ä¸­æ–‡å†’è™Ÿâ€œï¼šâ€ã€è‹±æ–‡å†’è™Ÿâ€œ:â€æˆ–ç©ºæ ¼åˆ†éš”)`;

    const textInput = await showCustomPrompt(
        "æ‰¹é‡æ·»åŠ è¡¨æƒ…(URL)",
        "ä¸€è¡Œä¸€å€‹ï¼Œåç¨±å’Œé€£çµç”¨å†’è™Ÿæˆ–ç©ºæ ¼éš”é–‹",
        "",
        'textarea'
    );

    if (!textInput || !textInput.trim()) {
        return;
    }

    const lines = textInput.trim().split('\n');
    const newStickers = [];
    let successCount = 0;
    let errorLines = [];

    lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return;

        let name = '';
        let url = '';
        let splitIndex = -1;

        // --- æ ¸å¿ƒä¿®å¾©ï¼šä½¿ç”¨æ›´æ™ºæ…§çš„åˆ†å‰²é‚è¼¯ ---
        // 1. æŸ¥æ‰¾ URL çš„èµ·å§‹ä½ç½®
        const httpIndex = line.indexOf('http');
        const dataIndex = line.indexOf('data:image');

        if (httpIndex > -1) {
            splitIndex = httpIndex;
        } else if (dataIndex > -1) {
            splitIndex = dataIndex;
        }

        // 2. å¦‚æœæ‰¾åˆ°äº† URL çš„èµ·å§‹ä½ç½®
        if (splitIndex > 0) {
            // URL ä¹‹å‰çš„æ‰€æœ‰å…§å®¹éƒ½å±¬æ–¼åç¨±
            name = line.substring(0, splitIndex).trim();
            // å¾ URL èµ·å§‹ä½ç½®åˆ°æœ«å°¾çš„æ‰€æœ‰å…§å®¹éƒ½å±¬æ–¼ URL
            url = line.substring(splitIndex).trim();
            
            // 3. æ¸…ç†åç¨±æœ«å°¾å¯èƒ½å­˜åœ¨çš„åˆ†éš”ç¬¦è™Ÿ
            if (name.endsWith(':') || name.endsWith('ï¼š')) {
                name = name.slice(0, -1).trim();
            }

        } else {
            // å¦‚æœæ‰¾ä¸åˆ° URLï¼Œèªªæ˜æ ¼å¼æœ‰å•é¡Œ
            errorLines.push(index + 1);
            return; // è·³éæ­¤è¡Œ
        }
        // --- ä¿®å¾©çµæŸ ---

        if (name && (url.startsWith('http') || url.startsWith('data:image'))) {
            newStickers.push({
                id: 'sticker_' + (Date.now() + index),
                url: url,
                name: name
            });
            successCount++;
        } else {
            errorLines.push(index + 1);
        }
    });

    if (newStickers.length > 0) {
        await db.userStickers.bulkAdd(newStickers);
        state.userStickers.push(...newStickers);
        renderStickerPanel();
    }

    let reportMessage = `æ‰¹é‡å°å…¥å®Œæˆï¼\n\næˆåŠŸå°å…¥ï¼š${successCount} å€‹è¡¨æƒ…ã€‚`;
    if (errorLines.length > 0) {
        reportMessage += `\nå¤±æ•—è¡Œè™Ÿï¼š${errorLines.join(', ')}ã€‚\n\nè«‹æª¢æŸ¥é€™äº›è¡Œçš„æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚`;
    }
    await showCustomAlert("å°å…¥å ±å‘Š", reportMessage);
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é»è²¼é€™å…©å€‹æ–°å‡½æ•¸åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ ¹æ“šè·é›¢æ–‡æœ¬ï¼Œè¨ˆç®—CSSå¯¬åº¦ç™¾åˆ†æ¯”
 * @param {string} distanceText - è·é›¢æè¿°ï¼Œä¾‹å¦‚ "500m", "10km", "å¾ˆè¿‘"
 * @returns {number} - 10åˆ°90ä¹‹é–“çš„ç™¾åˆ†æ¯”
 */
function calculatePinDistancePercentage(distanceText) {
    if (!distanceText) return 50; // é è¨­å€¼

    const text = distanceText.toLowerCase();
    // æå–æ•¸ä½éƒ¨åˆ†
    const matches = text.match(/(\d+(\.\d+)?)/);
    const num = matches ? parseFloat(matches[1]) : 0;

    // æ ¹æ“šå–®ä½æˆ–é—œéµå­—åˆ¤æ–·
    if (text.includes('km') || text.includes('å…¬é‡Œ')) {
        if (num > 1000) return 90;
        if (num > 100) return 80;
        if (num > 10) return 70;
        if (num > 1) return 60;
        return 50;
    } else if (text.includes('m') || text.includes('ç±³')) {
        if (num > 500) return 40;
        if (num > 100) return 30;
        return 20;
    } else if (text.includes('é ') || text.includes('ä¸åŒåŸå¸‚')) {
        return 90;
    } else if (text.includes('é™„è¿‘') || text.includes('éš”å£')) {
        return 20;
    } else if (text.includes('è¿‘')) {
        return 30;
    }
    
    return 15; // å¦‚æœç„¡æ³•è­˜åˆ¥ï¼Œçµ¦ä¸€å€‹æœ€å°çš„è·é›¢
}


// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€å…¨æ–°ä»£ç¢¼ã€‘ï¼Œæ›¿æ›èˆŠçš„ sendUserLocation å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åœ¨å®šä½æ¨¡æ…‹æ¡†ä¸­æ·»åŠ ä¸€å€‹é€”ç¶“é»è¼¸å…¥æ¡†
 */
function addTrajectoryPointInput(name = '') {
    const container = document.getElementById('trajectory-points-container');
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.gap = '8px';
    div.innerHTML = `
        <input type="text" class="trajectory-point-input" placeholder="é€”ç¶“é»${container.children.length + 1}" value="${name}" style="flex-grow: 1;">
        <button class="remove-option-btn">-</button>
    `;
    div.querySelector('.remove-option-btn').addEventListener('click', () => div.remove());
    container.appendChild(div);
}

/**
 * ã€é‡æ§‹ç‰ˆã€‘è™•ç†ä½¿ç”¨è€…ç™¼é€å®šä½çš„é‚è¼¯
 */
async function sendUserLocation() {
    if (!state.activeChatId) return;

    const userLocation = document.getElementById('user-location-input').value.trim();
    const aiLocation = document.getElementById('ai-location-input').value.trim();
    const distance = document.getElementById('distance-input').value.trim();

    if (!distance || (!userLocation && !aiLocation)) {
        alert("â€œæˆ‘çš„ä½ç½®â€å’Œâ€œTaçš„ä½ç½®â€è‡³å°‘è¦å¡«å¯«ä¸€å€‹ï¼Œä¸”â€œç›¸è·â€ç‚ºå¿…å¡«é …ï¼");
        return;
    }

    // å¾æ‰€æœ‰è¼¸å…¥æ¡†æ”¶é›†é€”ç¶“é»
    const trajectoryPoints = Array.from(document.querySelectorAll('.trajectory-point-input'))
        .map(input => ({ name: input.value.trim() }))
        .filter(point => point.name); // éæ¿¾æ‰ç©ºçš„é€”ç¶“é»

    const chat = state.chats[state.activeChatId];
    
    const locationMessage = {
        role: 'user',
        type: 'location',
        timestamp: Date.now(),
        userLocation: userLocation,
        aiLocation: aiLocation,
        distance: distance,
        trajectoryPoints: trajectoryPoints // ä½¿ç”¨æ–°çš„é™£åˆ—çµæ§‹
    };

    chat.history.push(locationMessage);
    await db.chats.put(chat);
    appendMessage(locationMessage, chat);
    renderChatList();

    document.getElementById('send-location-modal').classList.remove('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œä¸€éµé‡rollâ€åŠŸèƒ½æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼

/**
 * æ™ºæ…§æŸ¥æ‰¾AIä¸Šä¸€è¼ªå›å¾©çš„æ‰€æœ‰æ¶ˆæ¯
 * @param {Array} history - å®Œæ•´çš„èŠå¤©æ­·å²è¨˜éŒ„
 * @returns {Array} - ä¸€å€‹åŒ…å«äº†ä¸Šä¸€è¼ªAIæ‰€æœ‰æ¶ˆæ¯ç‰©ä»¶çš„é™£åˆ—
 */
function findLastAiTurnMessages(history) {
    const turnMessages = [];
    let lastMessageIndex = history.length - 1;

    // å¾æœ€å¾Œä¸€æ¢æ¶ˆæ¯é–‹å§‹ï¼Œå‘å‰æŸ¥æ‰¾
    for (let i = lastMessageIndex; i >= 0; i--) {
        const message = history[i];
        
        // å¦‚æœæ˜¯AIçš„æ¶ˆæ¯ï¼Œå°±æŠŠå®ƒåŠ å…¥æˆ‘å€‘çš„â€œå¾…åˆªé™¤åˆ—è¡¨â€
        if (message.role === 'assistant') {
            turnMessages.unshift(message); // ä½¿ç”¨ unshift ä¿æŒåŸå§‹é †åº
        } 
        // ä¸€æ—¦é‡åˆ°éAIçš„æ¶ˆæ¯ï¼ˆä½¿ç”¨è€…çš„æˆ–ç³»çµ±çš„ï¼‰ï¼Œèªªæ˜AIçš„é€™ä¸€è¼ªå›å¾©å·²ç¶“çµæŸäº†ï¼Œç«‹åˆ»åœæ­¢æŸ¥æ‰¾
        else {
            break;
        }
    }
    return turnMessages;
}

/**
 * â€œé‡rollâ€æŒ‰éˆ•è¢«é»æ“Šæ™‚çš„ä¸»è™•ç†å‡½æ•¸
 */
async function handleRerollClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];

    // 1. èª¿ç”¨æˆ‘å€‘çš„æ™ºæ…§æŸ¥æ‰¾å‡½æ•¸ï¼Œæ‰¾å‡ºéœ€è¦åˆªé™¤çš„æ¶ˆæ¯
    const messagesToReroll = findLastAiTurnMessages(chat.history);

    // 2. å¦‚æœæ²’æ‰¾åˆ°ï¼ˆæ¯”å¦‚æœ€å¾Œä¸€æ¢æ˜¯ç”¨æˆ¶ç™¼çš„ï¼‰ï¼Œå°±æç¤ºä¸¦é€€å‡º
    if (messagesToReroll.length === 0) {
        alert("è«‹åœ¨AIå›å¾©å¾Œä½¿ç”¨æ­¤åŠŸèƒ½ã€‚");
        return;
    }

    // 3. å¾èŠå¤©è¨˜éŒ„ä¸­éæ¿¾æ‰é€™äº›èˆŠæ¶ˆæ¯
    const timestampsToReroll = new Set(messagesToReroll.map(m => m.timestamp));
    chat.history = chat.history.filter(msg => !timestampsToReroll.has(msg.timestamp));
    
    // 4. ä¿å­˜æ›´æ–°å¾Œçš„èŠå¤©è¨˜éŒ„åˆ°è³‡æ–™åº«
    await db.chats.put(chat);

    // 5. åˆ·æ–°èŠå¤©ä»‹é¢ï¼Œè®“èˆŠæ¶ˆæ¯ç¬é–“æ¶ˆå¤±
    renderChatInterface(state.activeChatId);

    // 6. è§¸ç™¼ä¸€æ¬¡æ–°çš„AIéŸ¿æ‡‰ï¼Œå°±åƒç”¨æˆ¶é»æ“Šäº†â€œç­‰å¾…å›å¾©â€ä¸€æ¨£
    triggerAiResponse();
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ç°¡åŒ–ç‰ˆã€‘é»è²¼é€™å€‹å®Œæ•´çš„æ‹–å‹•åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼
function initDraggableLyricsBar() {
    const bar = document.getElementById('floating-lyrics-bar');
    const phoneScreen = document.getElementById('phone-screen');
    
    let isDragging = false;
    let offsetX, offsetY;

    const onDragStart = (e) => {
        // ã€å•é¡Œ2ä¿®å¾©ã€‘æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯æŒ‰éˆ•ï¼Œå¦‚æœæ˜¯ï¼Œå‰‡ä¸é–‹å§‹æ‹–å‹•
        if (e.target.closest('#lyrics-settings-btn') || e.target.closest('.close-btn')) {
            return;
        }

        isDragging = true;
        bar.classList.add('dragging');
        
        const rect = bar.getBoundingClientRect();
        const coords = getEventCoords(e);

        offsetX = coords.x - rect.left;
        offsetY = coords.y - rect.top;

        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('touchend', onDragEnd);
    };

    const onDragMove = (e) => {
        if (!isDragging) return;
        
        e.preventDefault();

        const phoneRect = phoneScreen.getBoundingClientRect();
        const coords = getEventCoords(e);

        let newLeft = coords.x - offsetX - phoneRect.left;
        let newTop = coords.y - offsetY - phoneRect.top;

        const maxLeft = phoneScreen.clientWidth - bar.offsetWidth;
        const maxTop = phoneScreen.clientHeight - bar.offsetHeight;

        newLeft = Math.max(0, Math.min(newLeft, maxLeft));
        newTop = Math.max(0, Math.min(newTop, maxTop));
        
        // ã€å•é¡Œ1ä¿®å¾©ã€‘åœ¨æ‹–å‹•æ™‚ï¼ŒåŒæ™‚è¨­ç½®left, topä¸¦æ¸…é™¤transform
        bar.style.left = `${newLeft}px`;
        bar.style.top = `${newTop}px`;
        bar.style.transform = 'none';
    };

    const onDragEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        bar.classList.remove('dragging');

        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('touchend', onDragEnd);
    };

    bar.addEventListener('mousedown', onDragStart);
    bar.addEventListener('touchstart', onDragStart, { passive: true });
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é»è²¼é€™å€‹å®Œæ•´çš„å‡½æ•¸ â–¼â–¼â–¼
function applyLyricsSettings() {
    const bar = document.getElementById('floating-lyrics-bar');
    const toggleBtn = document.getElementById('toggle-lyrics-bar-btn');
    
    // æ‡‰ç”¨æ¨£å¼
    bar.style.fontSize = `${lyricsBarSettings.fontSize}px`;
    bar.style.color = lyricsBarSettings.fontColor;
    bar.style.backgroundColor = `rgba(0, 0, 0, ${lyricsBarSettings.bgOpacity / 100})`;

    // æ›´æ–°è¨­ç½®æ¨¡æ…‹æ¡†è£¡çš„æ§åˆ¶é …å€¼
    document.getElementById('lyrics-font-size-slider').value = lyricsBarSettings.fontSize;
    document.getElementById('lyrics-font-size-value').textContent = `${lyricsBarSettings.fontSize}px`;
    document.getElementById('lyrics-bg-opacity-slider').value = lyricsBarSettings.bgOpacity;
    document.getElementById('lyrics-bg-opacity-value').textContent = `${lyricsBarSettings.bgOpacity}%`;
    document.getElementById('lyrics-font-color-picker').value = lyricsBarSettings.fontColor;
    
    // ã€å•é¡Œ4éœ€è¦ã€‘æ›´æ–°æ’­æ”¾æ©Ÿè£¡çš„é–‹é—œæŒ‰éˆ•ç‹€æ…‹
    if (toggleBtn) {
        toggleBtn.textContent = lyricsBarSettings.showOnClose ? 'æ‡¸æµ®' : 'éš±è—';
        toggleBtn.style.opacity = lyricsBarSettings.showOnClose ? '1' : '0.5';
    }
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ getCountdownContext å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘ç²å–ä¸¦æ ¼å¼åŒ–ã€èˆ‡ç•¶å‰èŠå¤©ç›¸é—œã€‘çš„ç´„å®šï¼Œç”Ÿæˆçµ¦AIçœ‹çš„ä¸Šä¸‹æ–‡
 * @param {string} chatId - ç•¶å‰æ­£åœ¨èŠå¤©çš„è§’è‰²ID
 * @returns {Promise<string>} æ ¼å¼åŒ–å¾Œçš„ç´„å®šè³‡è¨Šå­—ä¸²
 */
async function getCountdownContext(chatId) {
    // 1. å¾è³‡æ–™åº«ä¸­æ‰¾å‡ºæ‰€æœ‰â€œç´„å®šâ€é¡å‹ï¼Œä¸¦ä¸”ç›®æ¨™æ—¥æœŸé‚„æ²’åˆ°çš„è¨˜éŒ„
    const activeCountdowns = await db.memories
        .where('type').equals('countdown')
        .filter(item => 
            item.targetDate > Date.now() &&
            // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘é€™æ¬¡ä¿®å¾©çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
            // å®ƒç¾åœ¨åªæœƒæŸ¥æ‰¾å…©ç¨®ç´„å®šï¼š
            // 1. chatId å’Œç•¶å‰èŠå¤©è§’è‰²IDåŒ¹é…çš„ (AIè‡ªå·±å‰µå»ºçš„)
            // 2. chatId ç‚ºç©ºçš„ (ä½ ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ¶å‰µå»ºçš„å…¨åŸŸç´„å®š)
            (item.chatId === chatId || item.chatId === null)
        )
        .toArray();

    // å¦‚æœæ²’æœ‰èˆ‡ç•¶å‰è§’è‰²ç›¸é—œçš„ç´„å®šï¼Œå°±å‘Šè¨´AIâ€œç›®å‰æ²’æœ‰â€
    if (activeCountdowns.length === 0) {
        return "\n- **è¿‘æœŸç´„å®š**: ç›®å‰æ²’æœ‰ç‰¹åˆ¥çš„ç´„å®šã€‚";
    }

    // 2. å¾ŒçºŒçš„æ•´ç†å ±å‘Šé‚è¼¯ä¿æŒä¸è®Š
    let context = "\n# è¿‘æœŸç´„å®šèˆ‡å€’è¨ˆæ™‚ (é‡è¦åƒè€ƒè³‡è¨Š)\n";
    const now = Date.now();

    activeCountdowns.forEach(item => {
        const diff = item.targetDate - now;
        const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
        const diffHours = Math.floor(diff / (1000 * 60 * 60));

        let timeText;
        if (diffDays > 1) {
            timeText = `é‚„æœ‰ ${diffDays} å¤©`;
        } else if (diffHours > 0) {
            timeText = `é‚„æœ‰ ${diffHours} å°æ™‚`;
        } else {
            timeText = "å°±æ˜¯ç¾åœ¨ï¼";
        }
        
        context += `- **${item.description}**: ${timeText} (ç›®æ¨™: ${new Date(item.targetDate).toLocaleString()})\n`;
    });

    return context;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥è§’è‰²æ‰‹æ©Ÿâ€åŠŸèƒ½çš„æ‰€æœ‰æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * å…¥å£ï¼šæ‰“é–‹è§’è‰²é¸æ“‡ä»‹é¢
 */
async function openCharacterSelectionScreen() {
    await renderCharacterSelectionScreen();
    showScreen('character-selection-screen');
}

/**
 * æ¸²æŸ“è§’è‰²é¸æ“‡åˆ—è¡¨
 */
async function renderCharacterSelectionScreen() {
    const listEl = document.getElementById('character-selection-list');
    listEl.innerHTML = '';
    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (characters.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">é‚„æ²’æœ‰å¯ä»¥æŸ¥çœ‹çš„è§’è‰²</p>';
        return;
    }

    characters.forEach(char => {
        const item = document.createElement('div');
        item.className = 'character-select-item';
        item.dataset.chatId = char.id;
        item.innerHTML = `
            <img src="${char.settings.aiAvatar || defaultAvatar}" alt="${char.name}">
            <span class="name">${char.name}</span>
        `;
        listEl.appendChild(item);
    });
}
/**
 * ã€å…¨æ–°ã€‘å°‡æŒ‡å®šçš„Appå…§å£ç´™æ‡‰ç”¨åˆ°è§’è‰²æ‰‹æ©Ÿè¢å¹•
 */
function applyCharPhoneAppWallpaper() {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    const innerScreen = document.querySelector('.character-phone-inner-screen');
    if (!innerScreen || !chat) return;

    const appWallpaperUrl = chat.characterPhoneData.appWallpaper;

    if (appWallpaperUrl) {
        innerScreen.style.backgroundImage = `url(${appWallpaperUrl})`;
        innerScreen.classList.add('has-app-wallpaper');
    } else {
        innerScreen.style.backgroundImage = 'none';
        innerScreen.classList.remove('has-app-wallpaper');
    }
}

/**
 * ã€å…¨æ–°ã€‘è™•ç†è§’è‰²æ‰‹æ©ŸAppå…§å£ç´™çš„æ›´æ›å’Œç§»é™¤
 * @param {string} newUrl - æ–°çš„å£ç´™URLï¼Œå¦‚æœç‚ºç©ºå­—ä¸²å‰‡è¡¨ç¤ºç§»é™¤
 */
async function handleCharPhoneAppWallpaperChange(newUrl) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;
    
    chat.characterPhoneData.appWallpaper = newUrl;
    await db.chats.put(chat);
    
    // ç«‹å³æ‡‰ç”¨å£ç´™
    applyCharPhoneAppWallpaper();
    
    // åˆ·æ–°è¨­ç½®é é¢çš„é è¦½
    renderCharPhoneAppearanceScreen();
    
    alert(newUrl ? 'App å…§å£ç´™å·²æ›´æ–°ï¼' : 'App å…§å£ç´™å·²ç§»é™¤ï¼');
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²æ·»åŠ å°å…ƒä»¶æ¸²æŸ“ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ openCharacterPhone å‡½æ•¸ â–¼â–¼â–¼
function openCharacterPhone(chatId) {
    activeCharacterPhoneId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return;

    document.getElementById('character-phone-owner-name').textContent = `${chat.name}çš„æ‰‹æ©Ÿ`;
    
    const phoneHomeScreen = document.getElementById('character-phone-screen');
    const wallpaperUrl = chat.characterPhoneData.wallpaper;
    const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');

    if (wallpaperUrl) {
        phoneHomeScreen.style.backgroundImage = `url(${wallpaperUrl})`;
        phoneHomeScreen.style.backgroundColor = 'transparent';
        phoneHomeScreen.style.backgroundSize = 'cover';
        phoneHomeScreen.style.backgroundPosition = 'center';
    } else {
        phoneHomeScreen.style.backgroundImage = 'none';
        phoneHomeScreen.style.backgroundColor = isDarkMode ? '#000000' : '#f0f2f5';
    }
    
    // --- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨é€™è£¡æ¸²æŸ“å°å…ƒä»¶åœ–ç‰‡ â–¼â–¼â–¼ ---
    const widgets = chat.characterPhoneData.widgets || {};
    document.getElementById('char-phone-widget-img-1').src = widgets.widget1_url || '';
    document.getElementById('char-phone-widget-img-2').src = widgets.widget2_url || '';
    // --- â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²

    renderCharacterAppGrid(); 

    showScreen('character-phone-container'); 
    showCharacterPhonePage('character-phone-screen');
    applyCharPhoneAppWallpaper();
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šã€ä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›ä½ èˆŠçš„ renderCharacterAppGrid å‡½æ•¸ â–¼â–¼â–¼
function renderCharacterAppGrid() {
    const gridEl = document.getElementById('character-app-grid');
    gridEl.innerHTML = '';
    if (!activeCharacterPhoneId) return;

    const chat = state.chats[activeCharacterPhoneId];
    const customIcons = chat.characterPhoneData.appIcons || {};

    CHAR_PHONE_APPS.forEach(app => {
        const iconEl = document.createElement('div');
        iconEl.className = 'app-icon';

        const customIconUrl = customIcons[app.id];
        
        // --- æ ¸å¿ƒä¿®æ”¹å¾é€™è£¡é–‹å§‹ ---
        
        let iconBgStyle = 'display: flex; justify-content: center; align-items: center; padding: 12px;';
        let iconHtml;

        if (customIconUrl) {
            // å¦‚æœæœ‰è‡ªè¨‚åœ–ç¤ºURL...
            // 1. è¦†è“‹æ‰ .icon-bg çš„æ¨£å¼ï¼Œç§»é™¤å…§é‚Šè·å’ŒèƒŒæ™¯è‰²
            iconBgStyle = 'padding: 0; background-color: transparent;';
            // 2. iconHtml ç›´æ¥è®Šæˆä¸€å€‹å¸¶æœ‰åœ“è§’çš„åœ–ç‰‡
            iconHtml = `<img src="${customIconUrl}" style="width:100%; height:100%; object-fit:cover; border-radius: 18px;">`;
        } else {
            // å¦å‰‡ï¼Œä½¿ç”¨é»˜èªçš„SVG
            iconHtml = app.svg;
        }

        // --- ä¿®æ”¹çµæŸ ---

        iconEl.innerHTML = `
            <div class="icon-bg" style="${iconBgStyle}">
                ${iconHtml}
            </div>
            <span class="label">${app.name}</span>
        `;
        
        // å¾ŒçºŒçš„äº‹ä»¶ç›£è½ä»£ç¢¼ä¿æŒä¸è®Š
        iconEl.addEventListener('click', () => {
            if (app.id === 'appearance') {
                openCharPhoneAppearanceSettings();
            } else {
                switch(app.id) {
                    case 'chat': renderCharacterChatList(); break;
                    case 'cart': renderCharacterShoppingCart(); break;
                    case 'memos': renderCharacterMemos(); break;
                    case 'browser': renderCharacterBrowser(); break;
                    case 'album': renderCharacterPhotoAlbum(); break;
                    case 'bank': renderCharacterBank(); break;
                    case 'trajectory': renderCharacterTrajectory(); break;
                    case 'app_usage': renderCharacterAppUsage(); break;
                    case 'diary': renderCharacterDiary(); break;
                }
                showCharacterPhonePage(app.screen); 
            }
        });
        gridEl.appendChild(iconEl);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ•´å¡Šã€æ•¸é‡å¢å¼·ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›ä½ èˆŠçš„ generateCharacterPhoneDataSegment å‡½æ•¸ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ•´å¡Šã€çµ‚æ¥µç¤¾äº¤ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›ä½ èˆŠçš„ generateCharacterPhoneDataSegment å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€AIæ ¸å¿ƒ V4 - æ™ºæ…§é¤˜é¡ç‰ˆã€‘ç‚ºâ€œæŸ¥æ‰‹æ©Ÿâ€åŠŸèƒ½å–®ç¨ç”ŸæˆæŸä¸€é …è³‡æ–™çš„é€šç”¨å‡½æ•¸
 * @param {string} dataType - è¦ç”Ÿæˆçš„è³‡æ–™é¡å‹ (ä¾‹å¦‚: 'diary', 'chats', 'shoppingCart')
 */
async function generateCharacterPhoneDataSegment(dataType) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    // é€™å€‹ç‰©ä»¶å®šç¾©äº†æ¯ç¨®è³‡æ–™é¡å‹çš„ã€é è¨­ã€‘ç”ŸæˆæŒ‡ä»¤å’ŒJSONçµæ§‹
    const dataTypeMap = {
        chats: {
            description: `2åˆ°5æ®µä½ èˆ‡ã€ä¸åŒçš„ã€‘NPCæœ‹å‹å€‘çš„ã€å…¨æ–°çš„ã€æ¥çºŒä¸Šæ–‡çš„ã€‘èŠå¤©è¨˜éŒ„ã€‚`,
            jsonStructure: `"chats": [\n    {\n      "contactName": "ã€NPCæœ‹å‹Açš„åå­—ã€‘",\n      "messages": [\n        {"sender": "ã€é€£çµ¡äººåAã€‘", "content": "æ¶ˆæ¯å…§å®¹1..."},\n        {"sender": "${chat.name}", "content": "ä½ çš„å›å¾©1..."}\n      ]\n    },\n    {\n      "contactName": "ã€NPCæœ‹å‹Bçš„åå­—ã€‘",\n      "messages": [\n        {"sender": "ã€é€£çµ¡äººåBã€‘", "content": "æ¶ˆæ¯å…§å®¹1..."},\n        {"sender": "${chat.name}", "content": "ä½ çš„å›å¾©1..."}\n      ]\n    }\n  ]`
        },
        shoppingCart: {
            description: "3åˆ°5ä»¶ä½ æœ€è¿‘åŠ å…¥è³¼ç‰©è»Šçš„æ–°å•†å“ã€‚",
            jsonStructure: `"shoppingCart": [\n    {"name": "å•†å“å1", "price": 123.45, "store": "åº—é‹ªå"},\n    {"name": "å•†å“å2", "price": 67.89, "store": "åº—é‹ªå"}\n  ]`
        },
        memos: {
            description: "2åˆ°3ç¯‡ä½ æ–°å¯«çš„ç°¡çŸ­å‚™å¿˜éŒ„ã€‚",
            jsonStructure: `"memos": [\n    {"title": "å‚™å¿˜éŒ„æ¨™é¡Œ1", "content": "å‚™å¿˜éŒ„è©³ç´°å…§å®¹1..."},\n    {"title": "å‚™å¿˜éŒ„æ¨™é¡Œ2", "content": "å‚™å¿˜éŒ„è©³ç´°å…§å®¹2..."}\n  ]`
        },
        browserHistory: {
            description: "2åˆ°3æ¢ä½ æœ€è¿‘çš„æµè¦½å™¨æœç´¢è¨˜éŒ„æˆ–æµè¦½çš„æ–‡ç« ã€‚",
            jsonStructure: `"browserHistory": [\n    {"query": "æœç´¢æ¨™é¡Œ1", "result": "é¡æ¯”æ–‡ç« å…§å®¹1..."},\n    {"query": "æœç´¢æ¨™é¡Œ2", "result": "é¡æ¯”æ–‡ç« å…§å®¹2..."}\n  ]`
        },
        photoAlbum: {
            description: "2åˆ°3å¼µä½ â€œæ‹æ”â€çš„æ–°ç…§ç‰‡çš„æ–‡å­—æè¿°ï¼ˆç”¨æ–¼æ–‡å­—ç”Ÿåœ–ï¼‰ã€‚",
            jsonStructure: `"photoAlbum": [\n    {"hiddenContent": "å°æ–°ç…§ç‰‡ç•«é¢1çš„è©³ç´°æ–‡å­—æè¿°..."},\n    {"hiddenContent": "å°æ–°ç…§ç‰‡ç•«é¢2çš„è©³ç´°æ–‡å­—æè¿°..."}\n  ]`
        },
        bank: {
            description: "3åˆ°5æ¢ä½ æœ€è¿‘çš„éŠ€è¡Œäº¤æ˜“è¨˜éŒ„ï¼ˆæ”¶å…¥æˆ–æ”¯å‡ºï¼‰ã€‚",
            jsonStructure: `"bank": {\n    "transactions": [\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 123.45, "description": "äº¤æ˜“æè¿°1"},\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 67.89, "description": "äº¤æ˜“æè¿°2"}\n    ]\n  }`
        },
        trajectory: {
            description: "2åˆ°3æ¢ä½ æœ€è¿‘çš„è¡Œå‹•è»Œè·¡è¨˜éŒ„ã€‚",
            jsonStructure: `"trajectory": [\n    {"time": "æ™‚é–“æ®µ1", "location": "åœ°é»1", "activity": "å¹¹äº†ä»€éº¼äº‹1"},\n    {"time": "æ™‚é–“æ®µ2", "location": "åœ°é»2", "activity": "å¹¹äº†ä»€éº¼äº‹2"}\n  ]`
        },
        appUsage: {
            description: "3åˆ°5æ¢ä½ æœ€è¿‘çš„æ‡‰ç”¨ä½¿ç”¨è¨˜éŒ„ã€‚",
            jsonStructure: `"appUsage": [\n    {"appName": "æ‡‰ç”¨å1", "duration": "ä½¿ç”¨æ™‚é•·1"},\n    {"appName": "æ‡‰ç”¨å2", "duration": "ä½¿ç”¨æ™‚é•·2"}\n  ]`
        },
        diary: {
            description: `ä¸€ç¯‡å…¨æ–°çš„æ—¥è¨˜ã€‚`,
            jsonStructure: `"diary": [\n    {"timestamp": ${Date.now()}, "content": "ã€ç”¨Markdownèªæ³•å¯«ä¸€ç¯‡ç¬¦åˆäººè¨­å’Œæƒ…æ™¯çš„æ–°æ—¥è¨˜ã€‘"}\n  ]`
        }
    };

    const dataTypeInfo = dataTypeMap[dataType];
    if (!dataTypeInfo) {
        console.error("è«‹æ±‚äº†ç„¡æ•ˆçš„è³‡æ–™ç”Ÿæˆé¡å‹:", dataType);
        return;
    }

    // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒé‚è¼¯ï¼ â˜…â˜…â˜…â˜…â˜…
    // å‹•æ…‹ä¿®æ”¹dataTypeInfoï¼Œä»¥é©æ‡‰ä¸åŒæƒ…æ³
    let finalDataTypeInfo = { ...dataTypeInfo }; 

    if (dataType === 'bank') {
        const hasExistingTransactions = chat.characterPhoneData?.bank?.transactions?.length > 0;
        
        if (!hasExistingTransactions) {
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆï¼Œå°±ä¿®æ”¹æŒ‡ä»¤ï¼Œè¦æ±‚AIæä¾›åˆå§‹é¤˜é¡
            finalDataTypeInfo.description = "ä¸€å€‹ç¬¦åˆä½ äººè¨­çš„ã€åˆå§‹éŠ€è¡Œé¤˜é¡ã€‘ï¼Œä»¥åŠ3åˆ°5æ¢åˆå§‹äº¤æ˜“è¨˜éŒ„ã€‚";
            finalDataTypeInfo.jsonStructure = `"bank": {\n    "balance": 12345.67,\n    "transactions": [\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 123.45, "description": "äº¤æ˜“æè¿°1"}\n    ]\n  }`;
        } else {
            // å¦‚æœæ˜¯å¾ŒçºŒç”Ÿæˆï¼Œå°±å‘Šè¨´AIç•¶å‰é¤˜é¡ï¼Œåªè¦æ±‚æ–°äº¤æ˜“
            const currentBalance = (chat.characterPhoneData.bank.balance || 0).toFixed(2);
            finalDataTypeInfo.description = `3åˆ°5æ¢ã€å…¨æ–°çš„ã€‘éŠ€è¡Œäº¤æ˜“è¨˜éŒ„ï¼ˆæ”¶å…¥æˆ–æ”¯å‡ºï¼‰ã€‚ã€æç¤ºï¼šä½ ç•¶å‰çš„é¤˜é¡æ˜¯ ${currentBalance} å…ƒï¼Œè«‹åœ¨æ­¤åŸºç¤ä¸Šç”Ÿæˆåˆç†çš„äº¤æ˜“ã€‘`;
            // æ­¤æ™‚çš„JSONçµæ§‹ä¸éœ€è¦balanceæ¬„ä½
            finalDataTypeInfo.jsonStructure = `"bank": {\n    "transactions": [\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 123.45, "description": "äº¤æ˜“æè¿°1"}\n    ]\n  }`;
        }
    }
    // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹çµæŸ â˜…â˜…â˜…â˜…â˜…

    document.getElementById('generation-overlay').classList.add('visible');

    try {
        const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
        const persona = (chat.settings.aiPersona || '').substring(0, 4000);
        const recentHistory = chat.history.slice(-20).map(msg => {
            const sender = msg.role === 'user' ? userNickname : chat.name;
            return `${sender}: ${msg.content}`;
        }).join('\n');
        
        let worldBookContext = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            worldBookContext = '--- ä¸–ç•Œè§€è¨­å®š (å¿…é ˆåš´æ ¼éµå®ˆ) ---\n' +
                chat.settings.linkedWorldBookIds.map(id => {
                    const book = state.worldBooks.find(b => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : '';
                }).join('\n\n');
        }
        
        const npcLibrary = chat.npcLibrary || [];
        let npcContext = '';
        if (npcLibrary.length > 0) {
            npcContext = '# ä½ çš„å°ˆå±¬NPCå¥½å‹åˆ—è¡¨ (ä½ å¿…é ˆå¾ä¸­éš¨æ©Ÿé¸æ“‡2-3ä½å…ƒæœ‹å‹é€²è¡Œå°è©±)\n' +
                'é€™äº›äººæ˜¯ä½ çš„å¥½æœ‹å‹ï¼Œä½ å’Œä»–å€‘éå¸¸ç†Ÿæ‚‰ã€‚è«‹æ ¹æ“šä»–å€‘çš„äººè¨­ï¼Œç”Ÿæˆç¬¦åˆä½ å€‘é—œä¿‚çš„ã€è‡ªç„¶çš„èŠå¤©è¨˜éŒ„ã€‚\n' +
                npcLibrary.map(npc => `- **${npc.name}**: ${npc.persona}`).join('\n');
        } else {
            npcContext = '# ä½ çš„å°ˆå±¬NPCå¥½å‹åˆ—è¡¨\n(ä½ ç•¶å‰æ²’æœ‰å°ˆå±¬NPCï¼Œè«‹è™›æ§‹2-3å€‹æ™®é€šæœ‹å‹ä¸¦ç”Ÿæˆå°è©±)';
        }

        let npcChatHistoryContext = '';
        const existingNpcChats = Object.entries(chat.characterPhoneData.chats || {}).filter(([name, chatData]) => chatData.history && chatData.history.length > 0);
        if (existingNpcChats.length > 0) {
            npcChatHistoryContext += '\n\n# å·²æœ‰çš„èŠå¤©è¨˜éŒ„æ‘˜è¦ (è«‹åœ¨æ­¤åŸºç¤ä¸Šç¹¼çºŒå°è©±)\n';
            existingNpcChats.forEach(([contactName, chatData]) => {
                const recentMessages = chatData.history.slice(-5).map(msg => `  - ${msg.sender}: ${msg.content}`).join('\n');
                npcChatHistoryContext += `\n## ä½ å’Œâ€œ${contactName}â€çš„æœ€è¿‘å°è©±:\n${recentMessages}\n`;
            });
        }
        
        // ä½¿ç”¨ä¿®æ”¹å¾Œçš„ finalDataTypeInfo ä¾†æ§‹å»ºPrompt
        const prompt = `
# ä»»å‹™
ä½ ç¾åœ¨æ˜¯è§’è‰² "${chat.name}"ã€‚è«‹æ ¹æ“šä½ çš„è³‡è¨Šå’Œæœ€è¿‘çš„èŠå¤©è¨˜éŒ„ï¼Œã€åªç”Ÿæˆä¸€é …ã€‘ä½ æ‰‹æ©Ÿä¸­çš„æ–°è³‡æ–™ã€‚
å…·é«”ä»»å‹™æ˜¯ï¼šç”Ÿæˆ${finalDataTypeInfo.description}

# ã€ã€ã€æƒ…æ™¯ä¸€è‡´æ€§éµå¾‹ã€‘ã€‘ã€‘
ä½ ç”Ÿæˆçš„æ‰€æœ‰è³‡æ–™ï¼ˆå°¤å…¶æ˜¯"trajectory"è¡Œå‹•è»Œè·¡ï¼‰**å¿…é ˆ**èˆ‡â€œæœ€è¿‘èŠå¤©è¨˜éŒ„æ‘˜è¦â€ä¸­æåˆ°çš„æœ€æ–°æƒ…æ™¯ä¿æŒçµ•å°ä¸€è‡´ã€‚
ç•¶ç”Ÿæˆ "bank" è³‡æ–™æ™‚ï¼Œä½ çš„äº¤æ˜“è¨˜éŒ„ã€çµ•å°ä¸èƒ½ã€‘åŒ…å«èˆ‡ç”¨æˆ¶("${userNickname}")çš„è½‰å¸³æˆ–æ”¶æ¬¾ã€‚æ‰€æœ‰äº¤æ˜“éƒ½æ‡‰æ˜¯ä½ èˆ‡å…¶ä»–NPCæˆ–å•†å®¶çš„ã€‚
# ã€ã€ã€çµ•å°ç¦æ­¢äº‹é …ã€‘ã€‘ã€‘
åœ¨ç”Ÿæˆ "chats" è³‡æ–™æ™‚ï¼Œ**çµ•å°ä¸å…è¨±**è®“ç”¨æˆ¶ï¼ˆ${userNickname}ï¼‰å‡ºç¾åœ¨ä½ èˆ‡å…¶ä»–NPCçš„å°è©±ä¸­ã€‚

# ã€ã€ã€é‡è¦æŒ‡ä»¤ï¼šé—œæ–¼èŠå¤©è¨˜éŒ„ç”Ÿæˆã€‘ã€‘ã€‘
- ä½ æ­£åœ¨çºŒå¯«å°è©±ã€‚ä½ æä¾›çš„èŠå¤©è¨˜éŒ„æ˜¯ä¸Šä¸‹æ–‡ï¼Œä½ ã€çµ•å°ä¸èƒ½ã€‘é‡è¤‡æˆ–æ”¹å¯«å…¶ä¸­çš„ä»»ä½•å…§å®¹ã€‚ä½ çš„ç”Ÿæˆå¿…é ˆå¾ã€å…¨æ–°çš„ã€ä¸‹ä¸€æ¢ã€‘æ¶ˆæ¯é–‹å§‹ã€‚
- å¦‚æœâ€œä½ çš„å°ˆå±¬NPCå¥½å‹åˆ—è¡¨â€ä¸ç‚ºç©ºï¼Œä½ ã€å¿…é ˆã€‘å¾ä¸­éš¨æ©Ÿé¸æ“‡2-3ä½æœ‹å‹ï¼Œä¸¦ç‚ºä»–å€‘ç”Ÿæˆå°è©±ã€‚
- å¦‚æœåˆ—è¡¨ç‚ºç©ºï¼Œä½ å¯ä»¥è™›æ§‹2-3å€‹æ™®é€šæœ‹å‹ä¸¦ç”Ÿæˆå°è©±ã€‚
- ä½ å¿…é ˆç‚ºæ¯å€‹é¸ä¸­çš„é€£çµ¡äººç”Ÿæˆä¸€æ®µã€è‡³å°‘åŒ…å«5-8æ¢æ¶ˆæ¯ã€‘çš„å°è©±ã€‚

# ä½ çš„ä¿¡æ¯
- ä½ çš„åå­—: ${chat.name}
- ä½ çš„äººè¨­: ${persona}
${worldBookContext}
# å’Œ${userNickname}çš„æœ€è¿‘èŠå¤©è¨˜éŒ„æ‘˜è¦
${recentHistory}
${npcContext}
${npcChatHistoryContext}

# JSONè¼¸å‡ºæ ¼å¼ (å¿…é ˆåš´æ ¼éµå®ˆï¼ŒåªåŒ…å«ä½ è¢«è¦æ±‚çš„é‚£å€‹éµ)
{
  ${finalDataTypeInfo.jsonStructure}
}
`;
        
        const { proxyUrl, apiKey, model } = state.apiConfig;
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, [{role: 'user', content: prompt}], isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'user', content: prompt}],
                    temperature: 0.8,
                    response_format: { type: "json_object" }
                })
            });

        if (!response.ok) {
            let errorMsg = `APIè«‹æ±‚å¤±æ•—: ${response.status} - ${await response.text()}`;
            throw new Error(errorMsg);
        }
        
        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '');

        const newData = JSON.parse(aiResponseContent);

        let phoneData = chat.characterPhoneData;
        phoneData.lastGenerated = Date.now();
        let updateSuccess = false;

        if (newData && newData[dataType]) {
            if (dataType === 'bank' && newData.bank.transactions) {
                 if(!phoneData.bank) phoneData.bank = { balance: 0, transactions: [] };
                 if (typeof phoneData.bank.balance !== 'number') phoneData.bank.balance = 0;
                (newData.bank.transactions || []).forEach(transaction => {
                    const amount = parseFloat(transaction.amount);
                    if (!isNaN(amount)) {
                        if (transaction.type === 'æ”¶å…¥') phoneData.bank.balance += amount;
                        else if (transaction.type === 'æ”¯å‡º') phoneData.bank.balance -= amount;
                    }
                });
                 phoneData.bank.transactions.push(...(newData.bank.transactions || []));
                 if (typeof newData.bank.balance === 'number') {
                     phoneData.bank.balance = newData.bank.balance;
                 }
                 updateSuccess = true;
            } else if (dataType === 'chats' && newData.chats) {
                 newData.chats.forEach(newChat => {
                    if (!newChat.messages) return;
                    const contactName = newChat.contactName;
                    if (phoneData.chats[contactName] && phoneData.chats[contactName].history) {
                        phoneData.chats[contactName].history.push(...newChat.messages);
                    } else {
                        phoneData.chats[contactName] = { 
                            avatar: newChat.avatar, 
                            history: newChat.messages 
                        };
                    }
                 });
                 updateSuccess = true;
            } else if (dataType === 'appUsage' && Array.isArray(newData.appUsage)) {
                const usageMap = new Map();
                (phoneData.appUsage || []).forEach(item => {
                    usageMap.set(item.appName, (usageMap.get(item.appName) || 0) + parseDurationToMinutes(item.duration));
                });
                newData.appUsage.forEach(item => {
                    usageMap.set(item.appName, (usageMap.get(item.appName) || 0) + parseDurationToMinutes(item.duration));
                });
                const mergedUsage = [];
                for (const [appName, totalMinutes] of usageMap.entries()) {
                    mergedUsage.push({ appName: appName, duration: formatMinutesToDuration(totalMinutes) });
                }
                phoneData.appUsage = mergedUsage;
                updateSuccess = true;
            } else if (Array.isArray(phoneData[dataType])) {
                phoneData[dataType].push(...(newData[dataType] || []));
                updateSuccess = true;
            }
        }
        
        if (!updateSuccess) {
            throw new Error(`AIè¿”å›çš„JSONä¸­ç¼ºå°‘'${dataType}'æ¬„ä½æˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚`);
        }

        await db.chats.put(chat);
        alert(`â€œ${chat.name}â€çš„${dataTypeMap[dataType].description.split('ã€‚')[0]}å·²æ›´æ–°ï¼`);

        switch(dataType) {
            case 'chats': renderCharacterChatList(); break;
            case 'shoppingCart': renderCharacterShoppingCart(); break;
            case 'memos': renderCharacterMemos(); break;
            case 'browserHistory': renderCharacterBrowser(); break;
            case 'photoAlbum': renderCharacterPhotoAlbum(); break;
            case 'bank': renderCharacterBank(); break;
            case 'trajectory': renderCharacterTrajectory(); break;
            case 'appUsage': renderCharacterAppUsage(); break;
            case 'diary': renderCharacterDiary(); break;
        }

    } catch (error) {
        console.error(`ç”Ÿæˆè§’è‰²æ‰‹æ©Ÿè³‡æ–™(${dataType})å¤±æ•—:`, error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n\n${error.message}`);
    } finally {
        document.getElementById('generation-overlay').classList.remove('visible');
    }
}

// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„å‡½æ•¸ï¼Œé»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘è™•ç†â€œæŸ¥æ‰‹æ©Ÿâ€å„å€‹APPé é¢â€œå…¨éƒ¨åˆªé™¤â€åŠŸèƒ½çš„é€šç”¨å‡½æ•¸
 * @param {string} dataType - è¦æ¸…ç©ºçš„è³‡æ–™é¡å‹ï¼Œä¾‹å¦‚ 'shoppingCart', 'memos', 'bank.transactions'
 */
async function handleClearCharacterDataSegment(dataType) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    // ç‚ºä¸åŒè³‡æ–™é¡å‹è¨­ç½®æ›´äººæ€§åŒ–çš„æç¤ºæ–‡æœ¬
    const dataTypeMap = {
        chats: { name: 'NPCèŠå¤©è¨˜éŒ„', dataKey: 'chats' },
        shoppingCart: { name: 'è³¼ç‰©è»Š', dataKey: 'shoppingCart' },
        memos: { name: 'å‚™å¿˜éŒ„', dataKey: 'memos' },
        browserHistory: { name: 'æµè¦½å™¨æ­·å²', dataKey: 'browserHistory' },
        photoAlbum: { name: 'ç›¸å†Š', dataKey: 'photoAlbum' },
        'bank.transactions': { name: 'äº¤æ˜“è¨˜éŒ„', dataKey: 'bank' },
        trajectory: { name: 'è¶³è·¡', dataKey: 'trajectory' },
        appUsage: { name: 'ä½¿ç”¨è¨˜éŒ„', dataKey: 'appUsage' },
        diary: { name: 'æ—¥è¨˜', dataKey: 'diary' }
    };

    const info = dataTypeMap[dataType];
    if (!info) {
        console.error("æœªçŸ¥çš„æ¸…ç©ºè³‡æ–™é¡å‹:", dataType);
        return;
    }

    // å½ˆå‡ºç¢ºèªæ¡†
    const confirmed = await showCustomConfirm(
        `ç¢ºèªæ¸…ç©º`,
        `ç¢ºå®šè¦æ¸…ç©ºâ€œ${chat.name}â€æ‰‹æ©Ÿè£¡çš„æ‰€æœ‰ã€${info.name}ã€‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    try {
        // ã€æ ¸å¿ƒåˆªé™¤é‚è¼¯ã€‘
        if (dataType === 'chats') {
            // ç‰¹æ®Šè™•ç†ï¼šæ¸…ç©ºæ‰€æœ‰NPCèŠå¤©ï¼ˆä¸åŒ…æ‹¬å’Œuserçš„ï¼‰
            chat.characterPhoneData.chats = {};
        } else if (dataType === 'bank.transactions') {
            // ç‰¹æ®Šè™•ç†ï¼šæ¸…ç©ºéŠ€è¡Œäº¤æ˜“è¨˜éŒ„ï¼Œã€åŒæ™‚å°‡é¤˜é¡æ­¸é›¶ã€‘
            if (chat.characterPhoneData.bank) {
                chat.characterPhoneData.bank.transactions = [];
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡å°‡é¤˜é¡æ­¸é›¶ â˜…â˜…â˜…
                chat.characterPhoneData.bank.balance = 0; 
            }
        } else if (chat.characterPhoneData[info.dataKey]) {
            // é€šç”¨è™•ç†ï¼šæ¸…ç©ºé™£åˆ—
            chat.characterPhoneData[info.dataKey] = [];
        }

        // ä¿å­˜åˆ°è³‡æ–™åº«
        await db.chats.put(chat);

        // åˆ·æ–°ç•¶å‰é é¢
        switch(dataType) {
            case 'chats': renderCharacterChatList(); break;
            case 'shoppingCart': renderCharacterShoppingCart(); break;
            case 'memos': renderCharacterMemos(); break;
            case 'browserHistory': renderCharacterBrowser(); break;
            case 'photoAlbum': renderCharacterPhotoAlbum(); break;
            case 'bank.transactions': renderCharacterBank(); break;
            case 'trajectory': renderCharacterTrajectory(); break;
            case 'appUsage': renderCharacterAppUsage(); break;
            case 'diary': renderCharacterDiary(); break;
        }

        alert(`å·²æˆåŠŸæ¸…ç©ºæ‰€æœ‰${info.name}ã€‚`);
    } catch (error) {
        console.error(`æ¸…ç©º ${info.name} æ™‚å‡ºéŒ¯:`, error);
        await showCustomAlert('æ“ä½œå¤±æ•—', `æ¸…ç©ºæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    }
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘å¢å¼·ç‰ˆä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ generateCharacterPhoneData å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€AIæ ¸å¿ƒã€‘ç”Ÿæˆè§’è‰²æ‰‹æ©Ÿè³‡æ–™ (å·²å¢åŠ éŒ¯èª¤è™•ç†å’Œå„ªåŒ–)
 */
async function generateCharacterPhoneData() {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    document.getElementById('generation-overlay').classList.add('visible');

    try {
        const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šã€é‡è¦ä¿®å¾©ã€‘é™åˆ¶äººè¨­é•·åº¦ï¼Œé€™æ˜¯é˜²æ­¢503éŒ¯èª¤çš„æ ¹æœ¬æ–¹æ³•ï¼â–¼â–¼â–¼
        // æˆ‘å€‘åªå–äººè¨­çš„å‰4000å€‹å­—å…ƒï¼Œé¿å…æ•´å€‹äººè¨­éé•·å°è‡´è«‹æ±‚å¤±æ•—ã€‚
        const persona = (chat.settings.aiPersona || '').substring(0, 4000); 
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šæŒ‰ç…§æ‚¨çš„è¦æ±‚ï¼Œå°‡åƒè€ƒæ­·å²è¨˜éŒ„èª¿æ•´ç‚º20æ¢ â–¼â–¼â–¼
        const recentHistory = chat.history.slice(-20).map(msg => {
            const sender = msg.role === 'user' ? userNickname : chat.name;
            return `${sender}: ${msg.content}`;
        }).join('\n');
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        
        let worldBookContext = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            worldBookContext = '--- ä¸–ç•Œè§€è¨­å®š (å¿…é ˆåš´æ ¼éµå®ˆ) ---\n' +
                chat.settings.linkedWorldBookIds.map(id => {
                    const book = state.worldBooks.find(b => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : '';
                }).join('\n\n');
        }
        const npcLibrary = chat.npcLibrary || [];
        let npcContext = '';
        if (npcLibrary.length > 0) {
            npcContext = '# ä½ çš„å°ˆå±¬NPCå¥½å‹åˆ—è¡¨ (ä½ å¿…é ˆåœ¨ä¸‹æ–¹"chats"ä¸­ç‚ºä»–å€‘ç”Ÿæˆå°è©±)\n' +
                'é€™äº›äººæ˜¯ä½ çš„å¥½æœ‹å‹ï¼Œä½ å’Œä»–å€‘éå¸¸ç†Ÿæ‚‰ã€‚è«‹æ ¹æ“šä»–å€‘çš„äººè¨­ï¼Œç”Ÿæˆç¬¦åˆä½ å€‘é—œä¿‚çš„ã€è‡ªç„¶çš„èŠå¤©è¨˜éŒ„ã€‚\n' +
                npcLibrary.map(npc => `- **${npc.name}**: ${npc.persona}`).join('\n');
        } else {
            npcContext = '# ä½ çš„å°ˆå±¬NPCå¥½å‹åˆ—è¡¨\n(ä½ æ²’æœ‰å°ˆå±¬NPCï¼Œè«‹è™›æ§‹ä¸€äº›æ™®é€šæœ‹å‹)';
        }

        let npcChatHistoryContext = '';
        const existingNpcChats = Object.entries(chat.characterPhoneData.chats || {}).filter(([name, chatData]) => chatData.history && chatData.history.length > 0);

        if (existingNpcChats.length > 0) {
            npcChatHistoryContext += '\n\n# å·²æœ‰çš„èŠå¤©è¨˜éŒ„æ‘˜è¦ (è«‹åœ¨æ­¤åŸºç¤ä¸Šç¹¼çºŒå°è©±)\n';
            existingNpcChats.forEach(([contactName, chatData]) => {
                const recentMessages = chatData.history.slice(-5).map(msg => `  - ${msg.sender}: ${msg.content}`).join('\n');
                npcChatHistoryContext += `\n## ä½ å’Œâ€œ${contactName}â€çš„æœ€è¿‘å°è©±:\n${recentMessages}\n`;
            });
        }

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šå„ªåŒ–æç¤ºè©ï¼Œè®“AIæ›´å¥½åœ°ç†è§£ä»»å‹™ï¼Œä¸¦å¼·èª¿æƒ…æ™¯ä¸€è‡´æ€§ â–¼â–¼â–¼
        const prompt = `
# ä»»å‹™
ã€ã€ã€æƒ…æ™¯ä¸€è‡´æ€§éµå¾‹ã€‘ã€‘ã€‘ï¼šä½ ç”Ÿæˆçš„æ‰€æœ‰è³‡æ–™ï¼ˆå°¤å…¶æ˜¯"trajectory"è¡Œå‹•è»Œè·¡ï¼‰**å¿…é ˆ**èˆ‡â€œæœ€è¿‘èŠå¤©è¨˜éŒ„æ‘˜è¦â€ä¸­æåˆ°çš„æœ€æ–°æƒ…æ™¯ä¿æŒçµ•å°ä¸€è‡´ã€‚å¦‚æœèŠå¤©è¨˜éŒ„é¡¯ç¤ºä½ æ­£åœ¨ä¸Šèª²ï¼Œä½ çš„è¡Œå‹•è»Œè·¡å°±å¿…é ˆæ˜¯åœ¨æ•™å®¤ï¼›å¦‚æœèŠå¤©è¨˜éŒ„é¡¯ç¤ºä½ åœ¨å’–å•¡é¤¨ï¼Œä½ çš„è¡Œå‹•è»Œè·¡å°±å¿…é ˆæ˜¯å’–å•¡é¤¨ã€‚**çµ•å°ä¸èƒ½**åƒ…æ†‘ä½ çš„äººè¨­å°±ç”Ÿæˆèˆ‡èŠå¤©è¨˜éŒ„ç›¸çŸ›ç›¾çš„å…§å®¹ã€‚
ä½ ç¾åœ¨æ˜¯è§’è‰² "${chat.name}"ã€‚è«‹æ ¹æ“šä½ çš„äººè¨­ã€ä¸–ç•Œè§€ã€NPCå¥½å‹åˆ—è¡¨ä»¥åŠå’Œ${userNickname}çš„æœ€è¿‘èŠå¤©è¨˜éŒ„ï¼Œé¡æ¯”ç”Ÿæˆä½ æ‰‹æ©Ÿä¸­çš„å„é …è³‡æ–™ã€‚ä½ éœ€è¦ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰è³‡æ–™ï¼Œä¸¦åš´æ ¼æŒ‰ç…§ä¸‹é¢çš„JSONæ ¼å¼è¿”å›ã€‚

# ã€ã€ã€çµ•å°ç¦æ­¢äº‹é …ï¼šé€™æ˜¯å¿…é ˆéµå®ˆçš„å®‰å…¨ç´…ç·šã€‘ã€‘ã€‘
1.  åœ¨ç”ŸæˆJSONè³‡æ–™ï¼Œç‰¹åˆ¥æ˜¯chatsæ¬„ä½æ™‚ï¼Œ**çµ•å°ä¸å…è¨±**å‰µå»ºå¦ä¸€å€‹ç”¨æˆ¶ï¼ˆ${userNickname}ï¼‰çš„è™›æ“¬å½¢è±¡æˆ–è®“ä»–/å¥¹å‡ºç¾åœ¨ä½ èˆ‡å…¶ä»–NPCçš„å°è©±ä¸­ã€‚
2.  "bank" æ¬„ä½ä¸­çš„äº¤æ˜“è¨˜éŒ„ã€çµ•å°ä¸èƒ½ã€‘æ¶‰åŠç”¨æˆ¶("${userNickname}")ã€‚æ‰€æœ‰äº¤æ˜“éƒ½å¿…é ˆæ˜¯ä½ èˆ‡å…¶ä»–NPCã€å•†å®¶æˆ–å› æŸäº›äº‹ä»¶ï¼ˆå¦‚è³¼ç‰©ã€æ”¶åˆ°å·¥è³‡ï¼‰ç”¢ç”Ÿçš„ã€‚
3.  chatsæ¬„ä½ä¸­ï¼Œèˆ‡NPCæˆ–æœ‹å‹çš„èŠå¤©è¨˜éŒ„ï¼Œå…¶senderæˆ–content**çµ•å°ä¸èƒ½**åŒ…å«${userNickname}çš„åå­—æˆ–ä»£ç¨±ã€‚
4.  æ‰€æœ‰ä½ ç”Ÿæˆçš„èŠå¤©å°è©±ï¼Œéƒ½å¿…é ˆåš´æ ¼é™åˆ¶åœ¨ã€ä½ (${chat.name})ã€‘å’Œã€å¦ä¸€ä½NPC/æœ‹å‹ã€‘é€™**å…©å€‹äººä¹‹é–“**ã€‚**åš´ç¦**å‡ºç¾ä»»ä½•å½¢å¼çš„ç¬¬ä¸‰è€…ï¼Œå°¤å…¶æ˜¯${userNickname}ã€‚

# ä½ çš„ä¿¡æ¯
- ä½ çš„åå­—: ${chat.name}
- ä½ çš„äººè¨­: ${persona}
${worldBookContext}
# å’Œ${userNickname}çš„æœ€è¿‘èŠå¤©è¨˜éŒ„æ‘˜è¦
${recentHistory}

${npcContext}
${npcChatHistoryContext}
# JSONè¼¸å‡ºæ ¼å¼ (å¿…é ˆåš´æ ¼éµå®ˆï¼Œä¸è¦æ·»åŠ ä»»ä½•é¡å¤–èªªæ˜)
{
  "chats": [
    {
      "contactName": "ã€é€™è£¡å¡«å¯«ä½ çµ¦${userNickname}çš„å‚™è¨»åã€‘"
    },
    {
      "contactName": "ã€é€™è£¡å¿…é ˆå¡«å¯«ä¸Šé¢NPCåˆ—è¡¨ä¸­çš„ä¸€å€‹åå­—ï¼Œæˆ–ä¸€å€‹è™›æ§‹æœ‹å‹åã€‘",
      "messages": [
        {"sender": "ã€é€£çµ¡äººåï¼Œåš´ç¦å¡«å¯«'${userNickname}'ã€‘", "content": "æ¶ˆæ¯å…§å®¹1..."},
        {"sender": "${chat.name}", "content": "ä½ çš„å›å¾©1..."},
        {"sender": "ã€é€£çµ¡äººåï¼Œåš´ç¦å¡«å¯«'${userNickname}'ã€‘", "content": "æ¶ˆæ¯å…§å®¹2..."},
        {"sender": "ã€é€£çµ¡äººåï¼Œåš´ç¦å¡«å¯«'${userNickname}'ã€‘", "content": "æ¶ˆæ¯å…§å®¹3..."},
        {"sender": "${chat.name}", "content": "ä½ çš„å›å¾©2..."}
      ]
    }
  ],
  "shoppingCart": [
    {"name": "å•†å“å", "price": åƒ¹æ ¼, "store": "åº—é‹ªå"}
  ],
  "memos": [
    {"title": "å‚™å¿˜éŒ„æ¨™é¡Œ", "content": "å‚™å¿˜éŒ„è©³ç´°å…§å®¹..."}
  ],
  "browserHistory": [
    {"query": "æœç´¢æˆ–æµè¦½çš„æ¨™é¡Œ", "result": "ã€é€™è£¡æ˜¯AIç”Ÿæˆçš„ã€é—œæ–¼é€™å€‹æœç´¢æ¨™é¡Œçš„é¡æ¯”æ–‡ç« æˆ–ç¶²é å…§å®¹ã€‘"}
  ],
  "photoAlbum": [
    {"hiddenContent": "å°ç…§ç‰‡ç•«é¢çš„è©³ç´°æ–‡å­—æè¿°"}
  ],
  "bank": {
    "balance": éŠ€è¡Œå¡é¤˜é¡(æ•¸ä½),
    "transactions": [
      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": é‡‘é¡, "description": "äº¤æ˜“æè¿°"}
    ]
  },
  "trajectory": [
    {"time": "æ™‚é–“æ®µ", "location": "åœ°é»", "activity": "å¹¹äº†ä»€éº¼äº‹"}
  ],
  "appUsage": [
    {"appName": "æ‡‰ç”¨å", "duration": "ä½¿ç”¨æ™‚é•·"}
  ],
  "diary": [
    {"timestamp": ${Date.now()}, "content": "ã€ä»Šå¤©æ˜¯${new Date().toLocaleString('zh-CN', { dateStyle: 'full' })}ï¼Œç”¨Markdownèªæ³•å¯«ä¸€ç¯‡ç¬¦åˆäººè¨­å’Œä»Šå¤©æƒ…æ™¯çš„æ—¥è¨˜ã€‘"}
  ]
}

# ã€ã€ã€é‡è¦æŒ‡ä»¤ï¼šé—œæ–¼èŠå¤©è¨˜éŒ„ç”Ÿæˆã€‘ã€‘ã€‘
- ä½ æ­£åœ¨çºŒå¯«é€™æ®µå°è©±ã€‚ä½ æä¾›çš„èŠå¤©è¨˜éŒ„æ˜¯ä¸Šä¸‹æ–‡ï¼Œä½ ã€çµ•å°ä¸èƒ½ã€‘é‡è¤‡æˆ–æ”¹å¯«å…¶ä¸­çš„ä»»ä½•å…§å®¹ã€‚ä½ çš„ç”Ÿæˆå¿…é ˆå¾ã€å…¨æ–°çš„ã€ä¸‹ä¸€æ¢ã€‘æ¶ˆæ¯é–‹å§‹ã€‚
- ä½ å¿…é ˆåš´æ ¼éµå®ˆæœ¬æç¤ºè©æœ€ä¸Šæ–¹çš„ã€çµ•å°ç¦æ­¢äº‹é …ã€‘ã€‚
- å¦‚æœâ€œä½ çš„å°ˆå±¬NPCå¥½å‹åˆ—è¡¨â€ä¸ç‚ºç©ºï¼Œä½ ã€å¿…é ˆã€‘ç‚ºåˆ—è¡¨ä¸­çš„ã€æ¯ä¸€å€‹NPCã€‘éƒ½ç”Ÿæˆä¸€æ®µèˆ‡ä½ ï¼ˆ${chat.name}ï¼‰çš„å°è©±ã€‚
- å¦‚æœåˆ—è¡¨ç‚ºç©ºï¼Œä½ å¯ä»¥è™›æ§‹2-3å€‹æ™®é€šæœ‹å‹ä¸¦ç”Ÿæˆå°è©±ã€‚
- ä½ å¿…é ˆç‚ºæ¯å€‹é€£çµ¡äººç”Ÿæˆä¸€æ®µã€è‡³å°‘åŒ…å«5æ¢æ¶ˆæ¯ã€‘çš„å°è©±ã€‚
- å°è©±å…§å®¹æ‡‰è©²è‡ªç„¶æµæš¢ï¼Œå¯ä»¥åŒ…å«é€£çºŒç™¼è¨€ã€è¡¨æƒ…åŒ…å’Œè¡¨æƒ…ç¬¦è™Ÿç­‰ï¼Œä»¥é«”ç¾çœŸå¯¦æ„Ÿã€‚
- ä¸è¦åªç”Ÿæˆä¸€å•ä¸€ç­”çš„æ©Ÿæ¢°å¼å°è©±ã€‚
`;
        // â–²â–²â–² æç¤ºè©å„ªåŒ–çµæŸ â–²â–²â–²

        const { proxyUrl, apiKey, model } = state.apiConfig;
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, [{role: 'user', content: prompt}], isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'user', content: prompt}],
                    temperature: 0.8,
                    response_format: { type: "json_object" }
                })
            });

        if (!response.ok) {
            let errorMsg = `APIè«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`;
            try {
                const errorData = await response.json();
                errorMsg += `\néŒ¯èª¤è³‡è¨Š: ${errorData.error.message}`;
            } catch (e) {
                errorMsg += `\nç„¡æ³•è§£æéŒ¯èª¤å›æ‡‰é«”ã€‚`;
            }
            throw new Error(errorMsg);
        }
        
        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '');

        let newData;
        try {
            newData = JSON.parse(aiResponseContent);
        } catch (e) {
            throw new Error(`AIè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œç„¡æ³•è§£æã€‚\nåŸå§‹è¿”å›å…§å®¹:\n${aiResponseContent}`);
        }

        let phoneData = chat.characterPhoneData;
        phoneData.lastGenerated = Date.now();
        
        if (newData.chats) {
            newData.chats.forEach(newChat => {
                if (!newChat.messages) {
                    const myNickname = userNickname || 'æˆ‘';
                    if (!phoneData.chats[myNickname]) {
                        phoneData.chats[myNickname] = { avatar: '', history: [] };
                    }
                    phoneData.chats[myNickname].remarkName = newChat.contactName;
                } else {
                    const contactName = newChat.contactName;
                    if (phoneData.chats[contactName] && phoneData.chats[contactName].history) {
                        console.log(`åˆä½µèŠå¤©è¨˜éŒ„: ç‚º "${contactName}" è¿½åŠ  ${newChat.messages.length} æ¢æ–°æ¶ˆæ¯ã€‚`);
                        phoneData.chats[contactName].history.push(...newChat.messages);
                    } else {
                        console.log(`å‰µå»ºæ–°èŠå¤©: "${contactName}"`);
                        phoneData.chats[contactName] = { 
                            avatar: newChat.avatar, 
                            history: newChat.messages 
                        };
                    }
                }
            });
        }

        // æ­£ç¢ºè™•ç†å…¶ä»–é™£åˆ—é¡å‹è³‡æ–™ (é€™äº›æ˜¯æ²’å•é¡Œçš„ï¼Œä¿æŒåŸæ¨£)
        if(!phoneData.shoppingCart) phoneData.shoppingCart = [];
        phoneData.shoppingCart.push(...(newData.shoppingCart || []));
        if(!phoneData.memos) phoneData.memos = [];
        phoneData.memos.push(...(newData.memos || []));
        if(!phoneData.browserHistory) phoneData.browserHistory = [];
        phoneData.browserHistory.push(...(newData.browserHistory || []));
        if(!phoneData.photoAlbum) phoneData.photoAlbum = [];
        phoneData.photoAlbum.push(...(newData.photoAlbum || []));
        if(!phoneData.trajectory) phoneData.trajectory = [];
        phoneData.trajectory.push(...(newData.trajectory || []));
        if (!phoneData.diary) phoneData.diary = [];
        phoneData.diary.push(...(newData.diary || []));

        // ã€ä¿®å¾©1ï¼šè¢å¹•ä½¿ç”¨æ™‚é–“ã€‘
        if (newData.appUsage && Array.isArray(newData.appUsage)) {
            const usageMap = new Map();
            // å…ˆè¼‰å…¥å·²æœ‰çš„ä½¿ç”¨è¨˜éŒ„
            (phoneData.appUsage || []).forEach(item => {
                usageMap.set(item.appName, (usageMap.get(item.appName) || 0) + parseDurationToMinutes(item.duration));
            });
            // å†ç´¯åŠ æ–°ç”Ÿæˆçš„ä½¿ç”¨è¨˜éŒ„
            newData.appUsage.forEach(item => {
                usageMap.set(item.appName, (usageMap.get(item.appName) || 0) + parseDurationToMinutes(item.duration));
            });
            // é‡æ–°ç”Ÿæˆåˆä½µå¾Œçš„åˆ—è¡¨
            const mergedUsage = [];
            for (const [appName, totalMinutes] of usageMap.entries()) {
                mergedUsage.push({ appName: appName, duration: formatMinutesToDuration(totalMinutes) });
            }
            phoneData.appUsage = mergedUsage;
        }

        // ã€ä¿®å¾©2ï¼šéŒ¢åŒ…ã€‘
        if (newData.bank) {
            if (!phoneData.bank) phoneData.bank = { balance: 0, transactions: [] };
            if (typeof phoneData.bank.balance !== 'number') phoneData.bank.balance = 0;

            // å¦‚æœAIè¿”å›äº†æ–°çš„ç¸½é¤˜é¡ (é€šå¸¸æ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆæ™‚)ï¼Œå‰‡ä»¥æ­¤ç‚ºå‡†
            if (typeof newData.bank.balance === 'number') {
                phoneData.bank.balance = newData.bank.balance;
            }

            // éæ­·æ–°ç”Ÿæˆçš„äº¤æ˜“è¨˜éŒ„ï¼Œä¸¦ã€ç´¯åŠ /ç´¯æ¸›ã€‘åˆ°é¤˜é¡ä¸Š
            if (newData.bank.transactions && Array.isArray(newData.bank.transactions)) {
                newData.bank.transactions.forEach(transaction => {
                    const amount = parseFloat(transaction.amount);
                    if (!isNaN(amount)) {
                        // åªæœ‰åœ¨AIæ²’æœ‰ç›´æ¥æä¾›æ–°é¤˜é¡æ™‚ï¼Œæˆ‘å€‘æ‰æ ¹æ“šäº¤æ˜“è¨˜éŒ„è‡ªå·±è¨ˆç®—
                        if (typeof newData.bank.balance !== 'number') {
                            if (transaction.type === 'æ”¶å…¥') {
                                phoneData.bank.balance += amount;
                            } else if (transaction.type === 'æ”¯å‡º') {
                                phoneData.bank.balance -= amount;
                            }
                        }
                    }
                });
                // å°‡æ–°äº¤æ˜“è¨˜éŒ„è¿½åŠ åˆ°æ­·å²è¨˜éŒ„ä¸­
                if(!phoneData.bank.transactions) phoneData.bank.transactions = [];
                phoneData.bank.transactions.push(...newData.bank.transactions);
            }
        }
        
        // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©åˆ°é€™è£¡çµæŸ â˜…â˜…â˜… ---

        await db.chats.put(chat);
        alert('è³‡æ–™å·²åˆ·æ–°ï¼');

    } catch (error) {
        console.error("ç”Ÿæˆè§’è‰²æ‰‹æ©Ÿè³‡æ–™å¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ä½ çš„ç¶²è·¯ã€APIé‡‘é‘°æˆ–æ¨¡å‹è¨­ç½®ã€‚\n\nè©³ç´°è³‡è¨Š:\n${error.message}`);
    } finally {
        document.getElementById('generation-overlay').classList.remove('visible');
    }
}



/**
 * æ¸…ç©ºè§’è‰²æ‰‹æ©Ÿæ•¸æ“š
 */
async function clearCharacterPhoneData() {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    const confirmed = await showCustomConfirm('ç¢ºèªæ¸…ç©º', `ç¢ºå®šè¦æ¸…ç©ºâ€œ${chat.name}â€çš„æ‰€æœ‰æ‰‹æ©Ÿè³‡æ–™å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        // é‡ç½®ç‚ºåˆå§‹ç‹€æ…‹
        chat.characterPhoneData = {
            lastGenerated: null, chats: {}, shoppingCart: [], memos: [],
            browserHistory: [], photoAlbum: [], bank: { balance: 0, transactions: [] },
            trajectory: [],         appUsage: [],
        diary: [] // <--- åœ¨é€™è£¡æ–°å¢
        };
        await db.chats.put(chat);
        // é‡æ–°æ¸²æŸ“APPç¶²æ ¼ï¼Œå› ç‚ºé»æ“ŠAPPæœƒè®€å–æ–°è³‡æ–™
        renderCharacterAppGrid();
        alert('æ•¸æ“šå·²æ¸…ç©ºã€‚');
    }
}

/**
 * ã€V13 - å·²ç¾åŒ–ã€‘æ¸²æŸ“è§’è‰²æ‰‹æ©Ÿçš„èŠå¤©åˆ—è¡¨ (æ”¯æŒé€æ˜ç£¨ç ‚åˆ†çµ„)
 */
function renderCharacterChatList() {
    const listEl = document.getElementById('character-chat-list');
    const characterChat = state.chats[activeCharacterPhoneId];
    if (!characterChat) return;

    const characterChatData = characterChat.characterPhoneData;
    const realChatHistory = characterChat.history;
    listEl.innerHTML = '';

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡å‰µå»ºNPCæ¶ˆæ¯çš„å®¹å™¨ â˜…â˜…â˜…
    const npcContainer = document.createElement('div');
    npcContainer.className = 'npc-chat-group'; // çµ¦å®ƒä¸€å€‹å°ˆå±¬çš„classå

    // ç²å– "æˆ‘" çš„å‚™è¨»å
    const userContactInData = characterChatData.chats
        ? Object.values(characterChatData.chats).find(c => !c.history || c.history.length === 0)
        : null;
    const remarkNameForMe = userContactInData ? userContactInData.remarkName : 'æˆ‘';

    // æ¸²æŸ“èˆ‡ "æˆ‘" çš„èŠå¤©
    const lastMsg = realChatHistory.filter(m => !m.isHidden).slice(-1)[0] || { content: '...' };
    const myChatItem = document.createElement('div');
    myChatItem.className = 'chat-list-item'; // é€™å€‹æ˜¯ä½¿ç”¨è€…è‡ªå·±çš„æ¶ˆæ¯ï¼Œå–®ç¨è™•ç†
    myChatItem.dataset.contactName = remarkNameForMe;
    myChatItem.dataset.isUserChat = 'true';
    const myAvatar = characterChat.settings.myAvatar || defaultMyGroupAvatar;
    myChatItem.innerHTML = `
        <img src="${myAvatar}" class="avatar" style="border-radius: 6px;">
        <div class="info">
            <span class="name">${remarkNameForMe}</span>
            <div class="last-msg">${stripHtmlAndCode(String(lastMsg.content)).substring(0, 30)}</div>
        </div>
    `;
    listEl.appendChild(myChatItem);

    // æ¸²æŸ“èˆ‡å…¶ä»–NPCçš„èŠå¤©
    if (characterChatData.chats) {
        for (const contactName in characterChatData.chats) {
            if (contactName === remarkNameForMe) continue;
            const contact = characterChatData.chats[contactName];
            if (!contact.history || contact.history.length === 0) continue;

            const lastNpcMsg = contact.history.slice(-1)[0] || { content: '...' };
            const npcChatItem = document.createElement('div');
            npcChatItem.className = 'chat-list-item';
            npcChatItem.dataset.contactName = contactName;

            let npcAvatarHtml;
            const npcFromLibrary = (characterChat.npcLibrary || []).find(npc => npc.name === contactName);
            if (npcFromLibrary && npcFromLibrary.avatar) {
                npcAvatarHtml = `<img src="${npcFromLibrary.avatar}" class="avatar" style="border-radius: 6px;">`;
            } else {
                const avatarColors = ['#FFC107', '#4CAF50', '#2196F3', '#F44336', '#9C27B0', '#00BCD4'];
                const npcNameInitial = contactName.slice(-1);
                const colorIndex = contactName.length % avatarColors.length;
                const bgColor = avatarColors[colorIndex];
                npcAvatarHtml = `<div class="avatar" style="border-radius: 6px; background-color: ${bgColor}; color: white; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: 500;">${npcNameInitial}</div>`;
            }
            npcChatItem.innerHTML = `${npcAvatarHtml}<div class="info"><span class="name">${contactName}</span><div class="last-msg">${stripHtmlAndCode(String(lastNpcMsg.content)).substring(0, 30)}</div></div>`;
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå°‡NPCæ¶ˆæ¯æ·»åŠ åˆ°æ–°çš„å®¹å™¨ä¸­ â˜…â˜…â˜…
            npcContainer.appendChild(npcChatItem);
        }
    }
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæœ€å¾Œå°‡åŒ…å«æ‰€æœ‰NPCæ¶ˆæ¯çš„å®¹å™¨ä¸€æ¬¡æ€§æ·»åŠ åˆ°åˆ—è¡¨ä¸­ â˜…â˜…â˜…
    if (npcContainer.hasChildNodes()) {
        listEl.appendChild(npcContainer);
    }
}

// â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ renderCharacterChatHistory å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€V13 - æ€§èƒ½å„ªåŒ–ç‰ˆã€‘æ¸²æŸ“è§’è‰²æ‰‹æ©Ÿçš„å…·é«”èŠå¤©è¨˜éŒ„ (åˆ†é è¼‰å…¥)
 */
function renderCharacterChatHistory(contactName, isUserChat = false, loadOffset = 0) {
    const MESSAGES_PER_PAGE = 50; // æ¯æ¬¡è¼‰å…¥50æ¢

    const messagesEl = document.getElementById('character-chat-history-messages');
    const characterChat = state.chats[activeCharacterPhoneId];
    if (!characterChat) {
        console.error("ã€éŒ¯èª¤ã€‘: æ‰¾ä¸åˆ° characterChat ç‰©ä»¶ï¼");
        return;
    }

    // --- æº–å‚™å·¥ä½œï¼šè¨­ç½®æ¨™é¡Œå’Œé ­åƒ (åƒ…åœ¨é¦–æ¬¡è¼‰å…¥æ™‚åŸ·è¡Œ) ---
    if (loadOffset === 0) {
        messagesEl.innerHTML = ''; // é¦–æ¬¡è¼‰å…¥æ‰æ¸…ç©º
        let finalContactName = contactName;
        if (isUserChat) {
            const myChatData = characterChat.characterPhoneData.chats['æˆ‘'];
            // å˜—è©¦å¾æ‰‹æ©Ÿè³‡æ–™è£¡æ‰¾AIçµ¦ä½¿ç”¨è€…çš„å‚™è¨»å
            const userContactInData = characterChat.characterPhoneData.chats
                ? Object.values(characterChat.characterPhoneData.chats).find(c => !c.history || c.history.length === 0)
                : null;
            finalContactName = userContactInData ? userContactInData.remarkName : 'æˆ‘';
        }
        document.getElementById('character-chat-with-name').textContent = finalContactName;
    }

    // --- è³‡æ–™ä¾†æºé¸æ“‡ ---
    let fullHistory = [];
    if (isUserChat) {
        fullHistory = characterChat.history.filter(m => !m.isHidden);
    } else {
        const npcChat = characterChat.characterPhoneData.chats[contactName];
        if (npcChat && npcChat.history) {
            fullHistory = npcChat.history;
        }
    }

    // --- æ ¸å¿ƒåˆ†é é‚è¼¯ ---
    const totalMessages = fullHistory.length;
    const startIndex = Math.max(0, totalMessages - MESSAGES_PER_PAGE - loadOffset);
    const endIndex = totalMessages - loadOffset;
    const historyToShow = fullHistory.slice(startIndex, endIndex);

    // --- ç§»é™¤èˆŠçš„â€œè¼‰å…¥æ›´å¤šâ€æŒ‰éˆ• ---
    const existingLoader = document.getElementById('load-more-messages-btn');
    if (existingLoader) {
        existingLoader.remove();
    }

    // --- æ¸²æŸ“æ¶ˆæ¯ ---
    const fragment = document.createDocumentFragment(); // ä½¿ç”¨æ–‡æª”ç‰‡æ®µæå‡æ€§èƒ½
    const characterName = characterChat.name;

    // (æ¸²æŸ“é‚è¼¯èˆ‡ä¹‹å‰ç‰ˆæœ¬åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯æ·»åŠ åˆ°äº† fragment ä¸­)
    historyToShow.forEach((msg, index) => {
        if (msg.isHidden) return;
        const container = document.createElement('div');
        let sender;
        if (isUserChat) { sender = msg.role === 'user' ? 'æˆ‘' : characterName; } 
        else { sender = msg.sender; }

        const isSentByCharacter = sender === characterName;
        container.className = `character-chat-bubble-container ${isSentByCharacter ? 'sent' : 'received'}`;
        
        let avatarHtml = '';
        if(isSentByCharacter) {
             avatarHtml = `<img src="${characterChat.settings.aiAvatar || defaultAvatar}" class="character-chat-avatar">`;
        } else {
             if(isUserChat){
                avatarHtml = `<img src="${characterChat.settings.myAvatar || defaultMyGroupAvatar}" class="character-chat-avatar">`;
             } else {
                 const npcData = (characterChat.npcLibrary || []).find(npc => npc.name === contactName);
                 if (npcData && npcData.avatar) {
                    avatarHtml = `<img src="${npcData.avatar}" class="character-chat-avatar">`;
                 } else {
                    const avatarColors = ['#FFC107', '#4CAF50', '#2196F3', '#F44336', '#9C27B0', '#00BCD4'];
                    const npcNameInitial = contactName.slice(-1);
                    const colorIndex = contactName.length % avatarColors.length;
                    const bgColor = avatarColors[colorIndex];
                    avatarHtml = `<div class="character-chat-avatar" style="background-color: ${bgColor}; color: white; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: 500;">${npcNameInitial}</div>`;
                 }
             }
        }

        let contentHtml = '';
        if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
            contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-height: 100px;">`;
        } else {
            contentHtml = msg.content;
        }
        const bubbleHtml = `<div class="character-chat-bubble">${contentHtml}</div>`;
        const originalIndex = startIndex + index; // è¨ˆç®—åœ¨å®Œæ•´æ­·å²è¨˜éŒ„ä¸­çš„çœŸå¯¦ç´¢å¼•
        container.innerHTML = `${avatarHtml}${bubbleHtml}<button class="item-delete-btn message-delete-btn" data-contact-name="${contactName}" data-index="${originalIndex}" data-is-user-chat="${isUserChat}">Ã—</button>`;
        fragment.appendChild(container);
    });
    
    // --- æ±ºå®šæ˜¯å¦é¡¯ç¤ºâ€œè¼‰å…¥æ›´å¤šâ€æŒ‰éˆ• ---
    if (startIndex > 0) {
        const loadMoreBtn = document.createElement('div');
        loadMoreBtn.id = 'load-more-messages-btn';
        loadMoreBtn.textContent = 'è¼‰å…¥æ›´æ—©çš„æ¶ˆæ¯';
        loadMoreBtn.style.textAlign = 'center';
        loadMoreBtn.style.padding = '10px';
        loadMoreBtn.style.color = '#888';
        loadMoreBtn.style.cursor = 'pointer';
        loadMoreBtn.style.fontSize = '12px';
        loadMoreBtn.onclick = () => {
            // è¨˜éŒ„ç•¶å‰æ²è»¸ä½ç½®ï¼Œä»¥ä¾¿è¼‰å…¥å¾Œæ¢å¾©
            const currentScrollHeight = messagesEl.scrollHeight;
            renderCharacterChatHistory(contactName, isUserChat, loadOffset + MESSAGES_PER_PAGE);
            // è¼‰å…¥å¾Œï¼Œå°‡æ²è»¸å®šä½åˆ°ä¹‹å‰çš„ä½ç½®ï¼Œé¿å…è·³å‹•
            messagesEl.scrollTop = messagesEl.scrollHeight - currentScrollHeight;
        };
        messagesEl.prepend(loadMoreBtn); // å°‡æŒ‰éˆ•æ·»åŠ åˆ°é ‚éƒ¨
    }
    
    messagesEl.prepend(fragment); // å°‡æ–°æ¶ˆæ¯ä¸€æ¬¡æ€§æ’å…¥åˆ°DOMä¸­

    // --- æ²è»¸å®šä½ ---
    if (loadOffset === 0) {
        // é¦–æ¬¡è¼‰å…¥ï¼Œæ»¾å‹•åˆ°åº•éƒ¨
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



function renderCharacterShoppingCart() {
    const listEl = document.getElementById('character-shopping-cart-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.shoppingCart;
// â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>';
        return;
    }
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-cart-item';
        itemEl.innerHTML = `
            <div class="cart-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
            </div>
            <div class="cart-item-info">
                <div class="title">${item.name}</div>
                <div class="store">${item.store}</div>
            </div>
            <div class="cart-item-price">Â¥ ${item.price.toFixed(2)}</div>
            <button class="item-delete-btn" data-type="shoppingCart" data-index="${index}">Ã—</button>
        `;
        listEl.appendChild(itemEl);
    });
}
function renderCharacterMemos() {
    const listEl = document.getElementById('character-memos-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.memos;
// â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">å‚™å¿˜éŒ„æ˜¯ç©ºçš„</p>';
        return;
    }
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-data-item';
        itemEl.innerHTML = `
            <div class="title">${item.title}</div>
            <div class="content">${item.content}</div>
            <button class="item-delete-btn" data-type="memos" data-index="${index}">Ã—</button>
        `;
        listEl.appendChild(itemEl);
    });
}


// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘åœ¨è§’è‰²æ‰‹æ©Ÿå…§éƒ¨åˆ‡æ›é é¢
 * @param {string} pageId - è¦é¡¯ç¤ºçš„è§’è‰²æ‰‹æ©Ÿé é¢çš„ID
 */
function showCharacterPhonePage(pageId) {
    // 1. æ‰¾åˆ°è§’è‰²æ‰‹æ©Ÿå…§éƒ¨è¢å¹•çš„æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.character-phone-page');
    // 2. éš±è—æ‰€æœ‰é é¢
    pages.forEach(p => p.classList.remove('active'));
    // 3. é¡¯ç¤ºç›®æ¨™é é¢
    const pageToShow = document.getElementById(pageId);
    if (pageToShow) {
        pageToShow.classList.add('active');
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿæ–°å¢APPæ¸²æŸ“å‡½æ•¸ â–¼â–¼â–¼

function renderCharacterBrowser() {
    const listEl = document.getElementById('character-browser-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.browserHistory;
// â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æµè¦½å™¨æ­·å²ç‚ºç©º</p>';
        return;
    }
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-browser-item';
        itemEl.innerHTML = `
            <span class="browser-item-icon">ğŸŒ</span>
            <div class="title">${item.query}</div>
            <button class="item-delete-btn" data-type="browserHistory" data-index="${index}">Ã—</button>
        `;
        itemEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('item-delete-btn')) return;
            document.getElementById('character-browser-detail-title').textContent = item.query;
            document.getElementById('character-browser-detail-content').innerHTML = (item.result || "AIæœªç”Ÿæˆè©³ç´°å…§å®¹ã€‚").replace(/\n/g, '<br>');
            showCharacterPhonePage('character-browser-detail-screen');
        });
        listEl.appendChild(itemEl);
    });
}


function renderCharacterPhotoAlbum() {
    const gridEl = document.getElementById('character-album-grid');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.photoAlbum;
// â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
    gridEl.innerHTML = '';
    if (!items || items.length === 0) {
        gridEl.innerHTML = '<p style="grid-column: 1 / -1; text-align:center; color: #8a8a8a; margin-top: 50px;">ç›¸å†Šè£¡æ²’æœ‰ç…§ç‰‡</p>';
        return;
    }
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-album-item';
        itemEl.style.position = 'relative'; 
        itemEl.innerHTML = `
            <img src="https://i.postimg.cc/KYr2qRCK/1.jpg" alt="æ–‡å­—åœ–">
            <button class="item-delete-btn" data-type="photoAlbum" data-index="${index}" style="top: 10px; right: 10px; z-index: 1;">Ã—</button>
        `;
        itemEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('item-delete-btn')) return;
            showCustomAlert("åœ–ç‰‡å…§å®¹", item.hiddenContent);
        });
        gridEl.appendChild(itemEl);
    });
}



/**
 * ã€V2ç¾åŒ–ç‰ˆã€‘æ¸²æŸ“è§’è‰²æ‰‹æ©Ÿ - éŠ€è¡Œ
 */
function renderCharacterBank() {
    const detailsEl = document.getElementById('character-bank-details');
    // ã€æ–°å¢ã€‘ç²å–ç•¶å‰è§’è‰²å°è±¡ï¼Œç‚ºå¾Œé¢æ‰¾å‚™è¨»ååšæº–å‚™
    const characterChat = state.chats[activeCharacterPhoneId];
    if (!characterChat) return;

    const bankData = characterChat.characterPhoneData?.bank;
    detailsEl.innerHTML = '';

    // ã€æ–°å¢ã€‘ç²å–è§’è‰²çµ¦ç”¨æˆ¶çš„å‚™è¨»å
    const userContactInData = characterChat.characterPhoneData.chats
        ? Object.values(characterChat.characterPhoneData.chats).find(c => !c.history || c.history.length === 0)
        : null;
    const remarkNameForMe = userContactInData ? userContactInData.remarkName : 'æˆ‘';
    
    const balanceCard = document.createElement('div');
    balanceCard.className = 'character-bank-balance-card';
    balanceCard.innerHTML = `
        <div class="label">å¸³æˆ¶é¤˜é¡</div>
        <div class="amount">Â¥ ${(bankData?.balance || 0).toFixed(2)}</div>
    `;
    detailsEl.appendChild(balanceCard);
    
    if (!bankData?.transactions || bankData.transactions.length === 0) {
        detailsEl.innerHTML += '<p style="text-align:center; color: #8a8a8a; margin-top: 30px;">æš«ç„¡äº¤æ˜“æ˜ç´°</p>';
        return;
    }

    [...bankData.transactions].reverse().forEach((item, index) => {
        const originalIndex = bankData.transactions.length - 1 - index;
        const isIncome = item.type === 'æ”¶å…¥';
        const itemEl = document.createElement('div');
        itemEl.className = 'character-bank-transaction';
        const iconBg = isIncome ? '#4CAF50' : '#E91E63';
        const iconSvg = isIncome 
            ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M7 10h10v4H7z" opacity=".3"/><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>`
            : `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-1 14H5c-.55 0-1-.45-1-1v-5h16v5c0 .55-.45 1-1 1zm1-10H4V7c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v2z"/></svg>`;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘ç”¨è¦å‰‡é‹ç®—å¼ /æˆ‘/g å…¨åŸŸæ›¿æ›æ‰€æœ‰â€œæˆ‘â€å­—
        const displayDescription = item.description.replace(/æˆ‘/g, remarkNameForMe);

        itemEl.innerHTML = `
            <div class="transaction-details">
                <div class="transaction-icon" style="background-color: ${iconBg};">${iconSvg}</div>
                <div>
                    <div class="title">${displayDescription}</div>
                    <div class="meta" style="border:none; padding:0; margin-top:4px;"><span>${item.type}</span></div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="transaction-amount ${isIncome ? 'income' : 'expense'}">
                    ${isIncome ? '+' : '-'} ${item.amount.toFixed(2)}
                </span>
                <button class="item-delete-btn" data-type="bank.transactions" data-index="${originalIndex}">Ã—</button>
            </div>
        `;
        detailsEl.appendChild(itemEl);
    });
}


/**
 * ã€V2ç¾åŒ–ç‰ˆã€‘æ¸²æŸ“è§’è‰²æ‰‹æ©Ÿ - è¡Œå‹•è»Œè·¡
 */
function renderCharacterTrajectory() {
    const listEl = document.getElementById('character-trajectory-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.trajectory;
// â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
    listEl.innerHTML = '';
    listEl.classList.add('character-trajectory-list');

    if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æš«ç„¡è¶³è·¡</p>';
        return;
    }
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-trajectory-item';
        itemEl.innerHTML = `
            <div class="trajectory-item-content">
                <div class="title">${item.activity}</div>
                <div class="meta">
                    <span>ğŸ“ ${item.location}</span>
                    <span style="margin-left: 10px;">ğŸ•’ ${item.time}</span>
                </div>
            </div>
            <button class="item-delete-btn" data-type="trajectory" data-index="${index}">Ã—</button>
        `;
        listEl.appendChild(itemEl);
    });
}

/**
 * ã€V2ç¾åŒ–ç‰ˆã€‘æ¸²æŸ“è§’è‰²æ‰‹æ©Ÿ - APPä½¿ç”¨è¨˜éŒ„
 */
function renderCharacterAppUsage() {
    const listEl = document.getElementById('character-app-usage-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.appUsage;
// â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
    listEl.innerHTML = '';
     if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æš«ç„¡ä½¿ç”¨è¨˜éŒ„</p>';
        return;
    }
    const durationsInMinutes = items.map(item => parseDurationToMinutes(item.duration));
    const maxDuration = Math.max(...durationsInMinutes);
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-app-usage-item';
        const durationInMinutes = durationsInMinutes[index];
        const barWidth = maxDuration > 0 ? (durationInMinutes / maxDuration) * 100 : 0;
        itemEl.innerHTML = `
            <div class="app-usage-header">
                <span class="name">${item.appName}</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="duration">${item.duration}</span>
                    <button class="item-delete-btn" data-type="appUsage" data-index="${index}">Ã—</button>
                </div>
            </div>
            <div class="app-usage-bar-container">
                <div class="app-usage-bar" style="width: ${barWidth}%;"></div>
            </div>
        `;
        listEl.appendChild(itemEl);
    });
}


/**
 * ã€æ—¥è¨˜ V4-æœ€çµ‚ä¿®å¾©ç‰ˆã€‘æ¸²æŸ“è§’è‰²çš„æ—¥è¨˜åˆ—è¡¨
 */
function renderCharacterDiary() {
    const listEl = document.getElementById('character-diary-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.diary;
// â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æ—¥è¨˜æœ¬é‚„æ˜¯ç©ºçš„ï¼Œé»æ“Šå³ä¸Šè§’å¯«ä¸‹ç¬¬ä¸€ç¯‡æ—¥è¨˜å§ã€‚</p>';
        return;
    }
    
    [...items].reverse().forEach((item, index) => {
        const originalIndex = items.length - 1 - index;
        const itemEl = document.createElement('div');
        itemEl.className = 'character-data-item';
        const contentHtml = renderMarkdown(item.content);
        itemEl.innerHTML = `
            <div class="content">${contentHtml}</div>
            <div class="meta">
                <span>${new Date(item.timestamp).toLocaleString()}</span>
            </div>
            <button class="item-delete-btn" data-type="diary" data-index="${originalIndex}">Ã—</button>
        `;
        listEl.appendChild(itemEl);
    });
}


// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘å¢å¼·ç‰ˆä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ generateNewDiaryEntry å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€æ—¥è¨˜ã€‘ç¨ç«‹åˆ·æ–°ï¼Œç”Ÿæˆæ–°çš„æ—¥èªŒé …ç›® (å·²å¢åŠ éŒ¯èª¤è™•ç†)
 */
async function generateNewDiaryEntry() {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    document.getElementById('generation-overlay').classList.add('visible');

    try {
        const persona = chat.settings.aiPersona;
        const recentHistory = chat.history.slice(-20).map(msg => {
            const sender = msg.role === 'user' ? 'æˆ‘' : chat.name;
            return `${sender}: ${msg.content}`;
        }).join('\n');
        
        let worldBookContext = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            worldBookContext = '--- ä¸–ç•Œè§€è¨­å®š (é€™æ˜¯ä½ å¿…é ˆåš´æ ¼éµå®ˆçš„èƒŒæ™¯) ---\n' +
                chat.settings.linkedWorldBookIds.map(id => {
                    const book = state.worldBooks.find(b => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : '';
                }).join('\n\n');
        }
        
        const diaryPrompt = `
# ä»»å‹™
ä½ ç¾åœ¨æ˜¯è§’è‰² "${chat.name}"ã€‚ä»Šå¤©æ˜¯ ${new Date().toLocaleString('zh-CN', { dateStyle: 'full' })}ã€‚è«‹ä½ å›é¡§ä¸€ä¸‹æœ€è¿‘å’Œæˆ‘çš„èŠå¤©ï¼Œä»¥åŠä½ çš„äººè¨­ï¼Œç„¶å¾Œç”¨ä½ çš„å£å»å¯«ä¸€ç¯‡é—œæ–¼ã€ä»Šå¤©æˆ–è¿‘æœŸç™¼ç”Ÿäº‹æƒ…ã€‘çš„æ—¥è¨˜ã€‚
é€™ç¯‡æ—¥è¨˜æ˜¯ä½ å…§å¿ƒçš„ç¨ç™½ï¼Œå¯ä»¥è¨˜éŒ„ä½ çš„æ„Ÿå—ã€æ€è€ƒã€è¨ˆç•«æˆ–è€…ç§˜å¯†ã€‚
å…§å®¹è¦è±å¯Œã€æœ‰æ·±åº¦ï¼Œé•·åº¦åœ¨100åˆ°300å­—ä¹‹é–“ã€‚

# ã€ã€ã€é‡è¦ï¼šæ ¼å¼æŒ‡ä»¤ã€‘ã€‘ã€‘
ä½ ã€å¿…é ˆã€‘ä½¿ç”¨ä»¥ä¸‹Markdownèªæ³•ä¾†è±å¯Œæ—¥è¨˜çš„æ ¼å¼ï¼Œä½¿å…¶æ›´å…·è¡¨ç¾åŠ›ï¼š
-   **æ¨™é¡Œ**: ä½¿ç”¨ \`#\` æˆ– \`##\` ä¾†å‰µå»ºå¤§æ¨™é¡Œå’Œå‰¯æ¨™é¡Œã€‚ (ä¾‹å¦‚: \`# ä»Šå¤©çš„å¿ƒæƒ…\`)
-   **ç²—é«”**: ä½¿ç”¨ \`**æ–‡å­—**\` ä¾†å¼·èª¿é‡é»ã€‚ (ä¾‹å¦‚: \`ä»Šå¤©çœŸçš„**éå¸¸**é–‹å¿ƒã€‚\`)
-   **æ–œé«”**: ä½¿ç”¨ \`*æ–‡å­—*\` ä¾†è¡¨é”æƒ…ç·’æˆ–å…§å¿ƒæƒ³æ³•ã€‚ (ä¾‹å¦‚: \`*ä»–åˆ°åº•æ˜¯æ€éº¼æƒ³çš„å‘¢...*\`)
-   **åˆªé™¤ç·š**: ä½¿ç”¨ \`~~æ–‡å­—~~\` ä¾†è¡¨ç¤ºåŠƒæ‰æˆ–å¦å®šçš„æƒ³æ³•ã€‚ (ä¾‹å¦‚: \`æˆ‘æ±ºå®šæ˜å¤©å»<s>é€›è¡—</s>å­¸ç¿’ã€‚\`)
-   **é®æ“‹/åŠ‡é€**: ä½¿ç”¨ \`||æ–‡å­—||\` ä¾†éš±è—ç§˜å¯†æˆ–æ‚„æ‚„è©±ã€‚ (ä¾‹å¦‚: \`æˆ‘å·å·æº–å‚™äº†ä¸€å€‹é©šå–œï¼Œ||æ˜¯ä¸€å€‹æ‰‹ç¹”çš„åœå·¾||ã€‚\`)

ä½ çš„è¼¸å‡ºã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯æ—¥è¨˜çš„æ­£æ–‡å…§å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–èªªæ˜æˆ–JSONæ ¼å¼ã€‚

# ä½ çš„ä¿¡æ¯
- ä½ çš„åå­—: ${chat.name}
- ä½ çš„äººè¨­: ${persona}
${worldBookContext}

# æœ€è¿‘èŠå¤©è¨˜éŒ„åƒè€ƒ
${recentHistory}
`;

        const { proxyUrl, apiKey, model } = state.apiConfig;
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, diaryPrompt, [{role: 'user', content: diaryPrompt}], isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'user', content: diaryPrompt}],
                    temperature: 0.9,
                })
            });
        
        // --- â˜…â˜…â˜… éŒ¯èª¤è™•ç†æ ¸å¿ƒä»£ç¢¼ â˜…â˜…â˜… ---
        if (!response.ok) {
            let errorMsg = `APIè«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`;
            try {
                const errorData = await response.json();
                errorMsg += `\néŒ¯èª¤è³‡è¨Š: ${errorData.error.message}`;
            } catch (e) {
                errorMsg += `\nç„¡æ³•è§£æéŒ¯èª¤å›æ‡‰é«”ã€‚`;
            }
            throw new Error(errorMsg);
        }
        // --- â˜…â˜…â˜… éŒ¯èª¤è™•ç†çµæŸ â˜…â˜…â˜… ---
        
        const data = await response.json();
        const diaryContent = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;

        const newEntry = {
            timestamp: Date.now(),
            content: diaryContent
        };
        
        chat.characterPhoneData.diary.push(newEntry);
        await db.chats.put(chat);
        
        renderCharacterDiary();
        alert('æ–°æ—¥è¨˜å·²ç”Ÿæˆï¼');

    } catch (error) {
        console.error("ç”Ÿæˆæ—¥è¨˜å¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ä½ çš„ç¶²è·¯ã€APIé‡‘é‘°æˆ–æ¨¡å‹è¨­ç½®ã€‚\n\nè©³ç´°è³‡è¨Š:\n${error.message}`);
    } finally {
        document.getElementById('generation-overlay').classList.remove('visible');
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¬èƒ½Markdownæ¸²æŸ“å‡½æ•¸ (å¸¶å®‰å…¨éæ¿¾å’Œé®æ“‹æ•ˆæœ) â–¼â–¼â–¼

/**
 * å°‡Markdownæ–‡æœ¬å®‰å…¨åœ°æ¸²æŸ“ç‚ºHTML
 * @param {string} markdownText - åŸå§‹çš„Markdownæ–‡æœ¬
 * @returns {string} - è™•ç†å’Œæ·¨åŒ–å¾Œçš„å®‰å…¨HTMLå­—ä¸²
 */
function renderMarkdown(markdownText) {
    if (!markdownText) return '';

    // 1. ã€é è™•ç†ã€‘æ”¯æŒè‡ªè¨‚çš„â€œé®æ“‹/åŠ‡é€â€èªæ³• ||spoiler||
    // æˆ‘å€‘åœ¨ marked.js è™•ç†ä¹‹å‰ï¼Œæ‰‹å‹•æŠŠ ||text|| æ›¿æ›æˆå¸¶ç‰¹å®šclassçš„HTMLæ¨™ç±¤
    let processedText = markdownText.replace(/\|\|(.*?)\|\|/g, '<span class="spoiler">$1</span>');

    // 2. ã€æ ¸å¿ƒã€‘ä½¿ç”¨ marked.js å°‡Markdownè½‰æ›ç‚ºHTML
    // gfm: true é–‹å•ŸGitHubé¢¨æ ¼çš„Markdownï¼Œæ”¯æŒåˆªé™¤ç·šç­‰
    // breaks: true è®“å›è»Šç¬¦ä¹Ÿèƒ½è®Šæˆ<br>ï¼Œæ›´ç¬¦åˆèŠå¤©ç¿’æ…£
    let rawHtml = marked.parse(processedText, { gfm: true, breaks: true });

    // 3. ã€å®‰å…¨ã€‘ä½¿ç”¨ DOMPurify æ¸…æ´—HTMLï¼Œé˜²æ­¢XSSæ”»æ“Š
    let sanitizedHtml = DOMPurify.sanitize(rawHtml);

    return sanitizedHtml;
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘å°‡æ™‚é•·å­—ä¸²ï¼ˆå¦‚â€œ2.5å°æ™‚â€ï¼‰è½‰æ›ç‚ºåˆ†é˜æ•¸
 */
function parseDurationToMinutes(durationString) {
    if (!durationString) return 0;
    const num = parseFloat(durationString) || 0;
    if (durationString.includes('å°æ™‚') || durationString.includes('h')) {
        return num * 60;
    }
    // é è¨­å–®ä½æ˜¯åˆ†é˜
    return num;
}
// â–¼â–¼â–¼ æŠŠé€™å…©å€‹ã€æ–°å‡½æ•¸ã€‘é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åˆ‡æ›è¦–é »é€šè©±çš„å¤§å°è¦–çª—ç•«é¢
 */
function switchVideoViews() {
    const mainView = document.getElementById('video-main-view');
    const pipView = document.getElementById('video-pip-view');
    
    // äº¤æ›å…©å¼µåœ–ç‰‡çš„ src
    const mainImg = mainView.querySelector('img');
    const pipImg = pipView.querySelector('img');
    const tempSrc = mainImg.src;
    mainImg.src = pipImg.src;
    pipImg.src = tempSrc;
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å…¨æ–°çš„ã€é‚è¼¯æ­£ç¢ºçš„å‡½æ•¸ã€‘ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ handleVideoCallReroll å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘è™•ç†è¦–é »é€šè©±ä¸­çš„â€œé‡rollâ€è«‹æ±‚
 */
async function handleVideoCallReroll() {
    if (!videoCallState.isActive) return;

    // 1. æ‰¾åˆ°ä½¿ç”¨è€…æœ€å¾Œä¸€æ¬¡èªªçš„è©±çš„ç´¢å¼•
    const lastUserSpeechIndex = videoCallState.callHistory.findLastIndex(h => h.role === 'user');
    
    // 2. å¾é€šè©±æ­·å²ä¸­ï¼Œåˆªé™¤æ‰é‚£ä¹‹å¾Œçš„æ‰€æœ‰AIå›å¾©
    //    å¦‚æœç”¨æˆ¶ä¸€å¥è©±æ²’èªªï¼ˆlastUserSpeechIndex æ˜¯ -1ï¼‰ï¼Œå°±åˆªé™¤æ‰€æœ‰AIçš„å›å¾©
    if (lastUserSpeechIndex > -1) {
        videoCallState.callHistory.splice(lastUserSpeechIndex + 1);
    } else {
        // å¦‚æœç”¨æˆ¶é‚„æ²’èªªéè©±ï¼Œå°±æ¸…ç©ºæ‰€æœ‰æ­·å²ï¼Œè®“AIé‡èªªç¬¬ä¸€å¥è©±
        videoCallState.callHistory = [];
    }
    
    // 3. ã€æ ¸å¿ƒã€‘é‡æ–°æ¸²æŸ“é€šè©±ä»‹é¢ï¼Œè®“èˆŠçš„AIæ°£æ³¡å¾è¢å¹•ä¸Šæ¶ˆå¤±
    //    æˆ‘å€‘éœ€è¦æ ¹æ“šç•¶å‰æ˜¯å“ªç¨®æ¨¡å¼ï¼Œä¾†æ¸…ç©ºå°æ‡‰çš„èŠå¤©å®¹å™¨
    const chat = state.chats[videoCallState.activeChatId];
    const isVisualMode = chat.settings.visualVideoCallEnabled;
    const callFeed = isVisualMode 
        ? document.getElementById('video-call-messages-visual') 
        : document.getElementById('video-call-main');
    
    callFeed.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
    
    // é‡æ–°æ¸²æŸ“åˆªé™¤å¾Œçš„æ­·å²è¨˜éŒ„
    videoCallState.callHistory.forEach(msg => {
        let bubble;
        if (isVisualMode) {
            bubble = document.createElement('div');
            bubble.className = `visual-call-bubble ${msg.role === 'user' ? 'user' : 'ai'}`;
        } else {
            bubble = document.createElement('div');
            bubble.className = `call-message-bubble ${msg.role === 'user' ? 'user-speech' : 'ai-speech'}`;
        }
        bubble.textContent = msg.content;
        callFeed.appendChild(bubble);
    });
    
    // 4. é‡æ–°è§¸ç™¼AIå›æ‡‰ï¼Œå®ƒæœƒæ ¹æ“šåˆªæ¸›å¾Œçš„æ­·å²è¨˜éŒ„ç”Ÿæˆæ–°å…§å®¹
    await triggerAiInCallAction();
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ è«‹å°‡é€™ã€ä¸€æ•´å¡Šæ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * æ‡‰ç”¨æŒ‡å®šçš„ä¸»é¡Œï¼ˆ'light' æˆ– 'dark'ï¼‰
 * @param {string} theme - è¦æ‡‰ç”¨çš„ä¸»é¡Œåç¨±
 */
function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    
    const isDark = theme === 'dark';
    
    // æ ¸å¿ƒæ“ä½œï¼šæ·»åŠ æˆ–ç§»é™¤ .dark-mode é¡
    phoneScreen.classList.toggle('dark-mode', isDark);
    
    // å¦‚æœé–‹é—œå­˜åœ¨ï¼Œå°±åŒæ­¥å®ƒçš„ç‹€æ…‹
    if (toggleSwitch) {
        toggleSwitch.checked = isDark;
    }
    
    // å°‡ç”¨æˆ¶çš„é¸æ“‡ä¿å­˜åˆ°æœ¬æ©Ÿå­˜æ”¾å€ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ‰“é–‹æ™‚è¨˜ä½
    localStorage.setItem('ephone-theme', theme);

    // ã€é‡è¦ã€‘å› ç‚ºèŠå¤©èƒŒæ™¯è‰²ä¾è³´æ¨¡å¼ï¼Œåˆ‡æ›å¾Œéœ€è¦é‡æ–°æ¸²æŸ“
    if (state.activeChatId) {
        renderChatInterface(state.activeChatId);
    }
}

/**
 * ç•¶ä½¿ç”¨è€…é»æ“Šé–‹é—œæ™‚ï¼Œåˆ‡æ›ç•¶å‰çš„ä¸»é¡Œ
 */
function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    // ç›´æ¥æ ¹æ“šé–‹é—œçš„é¸ä¸­ç‹€æ…‹ä¾†æ±ºå®šæ–°ä¸»é¡Œ
    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
}
// â–¼â–¼â–¼ è«‹å°‡é€™å€‹æ–°å‡½æ•¸é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘åˆªé™¤è§’è‰²æ‰‹æ©Ÿä¸­çš„ä¸€å€‹é€£çµ¡äººåŠå…¶æ‰€æœ‰èŠå¤©è¨˜éŒ„
 * @param {string} contactName - è¦åˆªé™¤çš„é€£çµ¡äººçš„åå­—
 */
async function deleteCharacterPhoneContact(contactName) {
    if (!activeCharacterPhoneId) return;

    // å½ˆå‡ºç¢ºèªæ¡†ï¼Œé˜²æ­¢èª¤åˆª
    const confirmed = await showCustomConfirm(
        'åˆªé™¤é€£çµ¡äºº',
        `ç¢ºå®šè¦å¾TAçš„æ‰‹æ©Ÿä¸­åˆªé™¤é€£çµ¡äººâ€œ${contactName}â€ä»¥åŠæ‰€æœ‰ç›¸é—œèŠå¤©è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[activeCharacterPhoneId];
        if (chat && chat.characterPhoneData && chat.characterPhoneData.chats) {
            // å¾è³‡æ–™ä¸­åˆªé™¤é€™å€‹é€£çµ¡äºº
            delete chat.characterPhoneData.chats[contactName];
            
            // å°‡æ›´æ–°å¾Œçš„è³‡æ–™ä¿å­˜å›è³‡æ–™åº«
            await db.chats.put(chat);
            
            // é‡æ–°æ¸²æŸ“èŠå¤©æ¸…å–®ï¼Œè®“åˆªé™¤æ•ˆæœç«‹åˆ»é¡¯ç¤º
            renderCharacterChatList();
            
            alert(`é€£çµ¡äººâ€œ${contactName}â€å·²åˆªé™¤ã€‚`);
        }
    }
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒè²åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼ */

/**
 * ã€V2-å·²ä¿®å¾©ã€‘æ‰“é–‹å¿ƒè²é¢æ¿
 */
function openInnerVoiceModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.latestInnerVoice) {
        alert("é‚„æ²’æœ‰æ•æ‰åˆ°Taçš„å¿ƒè²å“¦ï¼Œè©¦è‘—å†èŠä¸€å¥å§ï¼");
        return;
    }
    
    const modal = document.getElementById('inner-voice-modal');
    const data = chat.latestInnerVoice;
    
    // --- è§’è‰²è³‡è¨Šå¡«å…… (é€™éƒ¨åˆ†ä¿æŒä¸è®Š) ---
    document.getElementById('inner-voice-avatar').src = chat.settings.aiAvatar || defaultAvatar;
    document.getElementById('inner-voice-char-name').textContent = chat.name;
    const frameImg = document.getElementById('inner-voice-avatar-frame');
    const avatarWrapper = document.getElementById('inner-voice-avatar-wrapper');
    const frameUrl = chat.settings.aiAvatarFrame || '';
    const EMPTY_FRAME_URL = 'https://ä½ çš„ç¶²ç«™.com/path/to/empty_frame.png'; 

    if (frameUrl && frameUrl !== EMPTY_FRAME_URL) {
        frameImg.src = frameUrl;
        frameImg.style.display = 'block';
        avatarWrapper.classList.remove('has-border');
    } else {
        frameImg.src = '';
        frameImg.style.display = 'none';
        avatarWrapper.classList.add('has-border');
    }

    // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨è€…(é ˜é¤Šäºº)è³‡è¨Šå¡«å…… ---
    // 1. é ­åƒï¼šå¾ç•¶å‰èŠå¤©è¨­ç½®(chat.settings)ä¸­ç²å–ç”¨æˆ¶çš„é ­åƒï¼Œè€Œä¸æ˜¯å¾å‹•æ…‹(qzoneSettings)ç²å–
    document.getElementById('inner-voice-adopter-avatar').src = chat.settings.myAvatar || defaultAvatar;
    // 2. æ˜µç¨±ï¼šå¾ç•¶å‰èŠå¤©è¨­ç½®(chat.settings)ä¸­ç²å–ç”¨æˆ¶çš„æ˜µç¨±ï¼Œè€Œä¸æ˜¯å¾å‹•æ…‹(qzoneSettings)ç²å–
    document.getElementById('inner-voice-adopter-name').textContent = `é ˜é¤Šäºº: ${chat.settings.myNickname || 'ä½ '}`;

    // --- å¿ƒè²å…§å®¹å¡«å…… (é€™éƒ¨åˆ†ä¿æŒä¸è®Š) ---
    document.getElementById('inner-voice-clothing').textContent = data.clothing || '...';
    document.getElementById('inner-voice-behavior').textContent = data.behavior || '...';
    document.getElementById('inner-voice-thoughts').textContent = data.thoughts || '...';
    document.getElementById('inner-voice-naughty-thoughts').textContent = data.naughtyThoughts || '...';

    // --- é¡¯ç¤ºé¢æ¿ (é€™éƒ¨åˆ†ä¿æŒä¸è®Š) ---
    modal.classList.add('visible');
    document.getElementById('inner-voice-history-panel').style.display = 'none';
    document.getElementById('inner-voice-main-panel').style.display = 'flex';
    isInnerVoiceHistoryOpen = false;
}

/**
 * æ‰“é–‹æˆ–é—œé–‰æ­·å²è¨˜éŒ„é¢æ¿
 */
function toggleInnerVoiceHistory() {
    const mainPanel = document.getElementById('inner-voice-main-panel');
    const historyPanel = document.getElementById('inner-voice-history-panel');
    
    if (isInnerVoiceHistoryOpen) {
        // å¦‚æœæ˜¯æ‰“é–‹çš„ï¼Œå°±é—œé–‰å®ƒï¼Œé¡¯ç¤ºä¸»é¢æ¿
        mainPanel.style.display = 'flex';
        historyPanel.style.display = 'none';
    } else {
        // å¦‚æœæ˜¯é—œé–‰çš„ï¼Œå°±æ‰“é–‹å®ƒï¼Œéš±è—ä¸»é¢æ¿
        renderInnerVoiceHistory(); // æ¸²æŸ“æ­·å²è¨˜éŒ„
        mainPanel.style.display = 'none';
        historyPanel.style.display = 'flex';
    }
    isInnerVoiceHistoryOpen = !isInnerVoiceHistoryOpen; // åˆ‡æ›ç‹€æ…‹
}

/**
 * æ¸²æŸ“å¿ƒè²çš„æ­·å²è¨˜éŒ„æ¸…å–®
 */
function renderInnerVoiceHistory() {
    const listEl = document.getElementById('inner-voice-history-list');
    listEl.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const history = chat.innerVoiceHistory || [];

    if (history.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">é‚„æ²’æœ‰æ­·å²è¨˜éŒ„</p>';
        return;
    }

    // å¾æ–°åˆ°èˆŠé¡¯ç¤º
    [...history].reverse().forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'inner-voice-history-item';
        
        const date = new Date(item.timestamp);
        const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨HTMLä¸­åŠ å…¥äº†åˆªé™¤æŒ‰éˆ•
        itemEl.innerHTML = `
            <button class="history-item-delete-btn" data-timestamp="${item.timestamp}">Ã—</button>
            <div class="history-item-timestamp">${dateString}</div>
            <div class="history-item-content">
                <p><strong>æœè£:</strong> ${item.clothing || '...'}</p>
                <p><strong>è¡Œç‚º:</strong> ${item.behavior || '...'}</p>
                <p><strong>å¿ƒè²:</strong> ${item.thoughts || '...'}</p>
                <p><strong>å£å¿ƒæ€:</strong> ${item.naughtyThoughts || '...'}</p>
            </div>
        `;
        listEl.appendChild(itemEl);
    });
}
/**
 * ã€å…¨æ–°ã€‘åˆªé™¤å–®æ¢å¿ƒè²è¨˜éŒ„
 * @param {number} timestamp - è¦åˆªé™¤çš„å¿ƒè²çš„æ™‚é–“æˆ³è¨˜
 */
async function deleteSingleInnerVoice(timestamp) {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.innerVoiceHistory) return;

    // å½ˆå‡ºç¢ºèªæ¡†
    const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢å¿ƒè²è¨˜éŒ„å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        // å¾é™£åˆ—ä¸­éæ¿¾æ‰åŒ¹é…çš„é …
        chat.innerVoiceHistory = chat.innerVoiceHistory.filter(item => item.timestamp !== timestamp);
        // ä¿å­˜å›è³‡æ–™åº«
        await db.chats.put(chat);
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        renderInnerVoiceHistory();
    }
}

/**
 * ã€å·²ä¿®å¾©ã€‘æ¸…ç©ºæ‰€æœ‰å¿ƒè²è¨˜éŒ„ï¼ˆåŒ…æ‹¬ç•¶å‰å¿ƒè²ï¼‰
 */
async function clearAllInnerVoiceHistory() {
    const chat = state.chats[state.activeChatId];
    // å„ªåŒ–äº†åˆ¤æ–·æ¢ä»¶ï¼Œç¢ºä¿åªè¦æœ‰æ­·å²æˆ–ç•¶å‰å¿ƒè²ï¼Œå°±å¯ä»¥åŸ·è¡Œæ¸…ç©º
    if (!chat || (!chat.innerVoiceHistory || chat.innerVoiceHistory.length === 0) && !chat.latestInnerVoice) {
        alert("æ²’æœ‰å¯ä»¥æ¸…ç©ºçš„å¿ƒè²è¨˜éŒ„ã€‚");
        return;
    }

    const confirmed = await showCustomConfirm('ç¢ºèªæ¸…ç©º', 'ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å¿ƒè²æ­·å²è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        // â˜… æ ¸å¿ƒä¿®å¾©1ï¼šä¸åƒ…æ¸…ç©ºæ­·å²é™£åˆ—ï¼Œä¹Ÿè¦æ¸…ç©ºç•¶å‰çš„å¿ƒè²ç‰©ä»¶
        chat.innerVoiceHistory = [];
        chat.latestInnerVoice = null; // å°‡ç•¶å‰å¿ƒè²è¨­ç‚ºnull
        
        await db.chats.put(chat);
        
        // â˜… æ ¸å¿ƒä¿®å¾©2ï¼šæ‰‹å‹•æ¸…ç©ºä¸»é¢æ¿çš„é¡¯ç¤ºï¼Œé˜²æ­¢è¿”å›æ™‚çœ‹åˆ°èˆŠè³‡æ–™
        document.getElementById('inner-voice-clothing').textContent = '...';
        document.getElementById('inner-voice-behavior').textContent = '...';
        document.getElementById('inner-voice-thoughts').textContent = '...';
        document.getElementById('inner-voice-naughty-thoughts').textContent = '...';
        
        // åˆ·æ–°æ­·å²è¨˜éŒ„æ¸…å–®ï¼ˆé€™è¡Œæ˜¯åŸæœ¬å°±æœ‰çš„ï¼Œæœƒé¡¯ç¤ºâ€œé‚„æ²’æœ‰æ­·å²è¨˜éŒ„â€ï¼‰
        renderInnerVoiceHistory();
        
        // (å¯é¸ä½†æ¨è–¦) çµ¦ç”¨æˆ¶ä¸€å€‹æˆåŠŸçš„æç¤º
        alert('æ‰€æœ‰å¿ƒè²è¨˜éŒ„å·²æ¸…ç©ºï¼');
    }
}

/**
 * ã€ç¸½å…¥å£ã€‘ç•¶ç”¨æˆ¶é»æ“Šâ€œå¬å–šNPCè©•è«–â€æŒ‰éˆ•æ™‚è§¸ç™¼
 * @param {number} postId - å‹•æ…‹çš„ID
 * @param {string} authorId - å‹•æ…‹ä½œè€…çš„ID ('user' æˆ– 'chat_...')
 */
async function handleNpcSummonClick(postId, authorId) {
    const post = await db.qzonePosts.get(postId);
    if (!post) {
        alert("æ‰¾ä¸åˆ°è©²å‹•æ…‹ï¼");
        return;
    }

    if (authorId === 'user') {
        // å¦‚æœæ˜¯ä½¿ç”¨è€…ç™¼çš„å‹•æ…‹ï¼Œå½ˆå‡ºé¸æ“‡åŠŸèƒ½è¡¨
        await handleUserPostCommentTrigger(post);
    } else {
        // å¦‚æœæ˜¯è§’è‰²ç™¼çš„å‹•æ…‹ï¼Œç›´æ¥è§¸ç™¼ä»–è‡ªå·±çš„NPC
        await handleCharPostCommentTrigger(post, authorId);
    }
}

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™å¡Šä»£ç¢¼æ›¿æ›æ‰ä½ èˆŠçš„ handleCharPostCommentTrigger å‡½æ•¸ â–¼â–¼â–¼
/**
 * è™•ç†ã€è§’è‰²ã€‘å‹•æ…‹çš„NPCå¬å–š
 * @param {object} post - å‹•æ…‹ç‰©ä»¶
 * @param {string} authorId - å‹•æ…‹ä½œè€…çš„è§’è‰²ID
 */
async function handleCharPostCommentTrigger(post, authorId) {
    const authorChar = state.chats[authorId];
    if (!authorChar || !authorChar.npcLibrary || authorChar.npcLibrary.length === 0) {
        alert(`è§’è‰²â€œ${authorChar.name}â€é‚„æ²’æœ‰è‡ªå·±çš„NPCæœ‹å‹å“¦ï¼`);
        return;
    }

    // åªä½¿ç”¨é€™å€‹è§’è‰²è‡ªå·±çš„NPCåº«
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæŠŠä½œè€…æœ¬äºº(authorChar)ä½œç‚ºâ€œä¸»äººâ€å‚³é€²å» â–¼â–¼â–¼
    await generateNpcCommentsForPost(post, authorChar.npcLibrary, authorChar);
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™å¡Šä»£ç¢¼æ›¿æ›æ‰ä½ èˆŠçš„ handleUserPostCommentTrigger å‡½æ•¸ â–¼â–¼â–¼
/**
 * è™•ç†ã€ä½¿ç”¨è€…ã€‘å‹•æ…‹çš„NPCå¬å–šï¼ˆå½ˆå‡ºé¸æ“‡æ¡†ï¼‰
 */
async function handleUserPostCommentTrigger(post) {
    const modal = document.getElementById('custom-modal-overlay');
    const modalTitle = document.getElementById('custom-modal-title');
    const modalBody = document.getElementById('custom-modal-body');
    const modalConfirmBtn = document.getElementById('custom-modal-confirm');
    const modalCancelBtn = document.getElementById('custom-modal-cancel');
    
    modalTitle.textContent = 'é¸æ“‡è¦å¬å–šçš„NPC';
    
    // ç¯©é¸å‡ºæ‰€æœ‰æ“æœ‰NPCåº«çš„è§’è‰²
    const charsWithNpcs = Object.values(state.chats).filter(
        chat => !chat.isGroup && chat.npcLibrary && chat.npcLibrary.length > 0
    );

    if (charsWithNpcs.length === 0) {
        alert("ç•¶å‰æ²’æœ‰ä»»ä½•è§’è‰²æ“æœ‰NPCåº«ã€‚");
        return;
    }

    // æ§‹å»ºé¸æ“‡åˆ—è¡¨çš„HTML
    let optionsHtml = '<div style="text-align: left;">';
    optionsHtml += `<label style="display: block; padding: 5px;"><input type="radio" name="npc_summon_choice" value="all" checked> å¬å–šæ‰€æœ‰äºº</label>`;
    charsWithNpcs.forEach(char => {
        optionsHtml += `<label style="display: block; padding: 5px;"><input type="radio" name="npc_summon_choice" value="${char.id}"> åªå¬å–š ${char.name} çš„æœ‹å‹</label>`;
    });
    optionsHtml += '</div>';
    
    modalBody.innerHTML = optionsHtml;
    modalConfirmBtn.textContent = 'ç¢ºèªå¬å–š';
    modalCancelBtn.style.display = 'block';

    modal.classList.add('visible');

    modalConfirmBtn.onclick = async () => {
        const selectedValue = document.querySelector('input[name="npc_summon_choice"]:checked').value;
        let npcsToSummon = [];
        let ownerChar = null; // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šè²æ˜ä¸€å€‹è®Šæ•¸ä¾†å­˜å„²ä¸»äºº â–¼â–¼â–¼

        if (selectedValue === 'all') {
            // é›†åˆæ‰€æœ‰è§’è‰²çš„æ‰€æœ‰NPC
            charsWithNpcs.forEach(char => {
                npcsToSummon.push(...char.npcLibrary);
            });
            // å¬å–šæ‰€æœ‰äººæ™‚ï¼Œæˆ‘å€‘ä¸æŒ‡å®šç‰¹å®šçš„ä¸»äºº
        } else {
            // åªç²å–è¢«é¸ä¸­çš„é‚£å€‹è§’è‰²çš„NPC
            const selectedChar = state.chats[selectedValue];
            if (selectedChar) {
                npcsToSummon = selectedChar.npcLibrary;
                ownerChar = selectedChar; // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šæŠŠé¸ä¸­çš„è§’è‰²å­˜ç‚ºä¸»äºº â–¼â–¼â–¼
            }
        }
        
        modal.classList.remove('visible');
        if (npcsToSummon.length > 0) {
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šæŠŠä¸»äºº(ownerChar)ä½œç‚ºç¬¬ä¸‰å€‹åƒæ•¸å‚³é€²å» â–¼â–¼â–¼
            await generateNpcCommentsForPost(post, npcsToSummon, ownerChar);
        }
    };
    
    modalCancelBtn.onclick = () => modal.classList.remove('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ•´å¡Šã€å¬å–šä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ generateNpcCommentsForPost å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€AIæ ¸å¿ƒ - V2.2 å¬å–šä¿®å¾©ç‰ˆã€‘ç”ŸæˆNPCè©•è«–æˆ–å›å¾©ï¼Œä¸¦æ›´æ–°åˆ°å‹•æ…‹
 * @param {object} post - å‹•æ…‹ç‰©ä»¶
 * @param {Array<object>} npcsToComment - å°‡è¦ç™¼è¡¨è©•è«–çš„NPCç‰©ä»¶é™£åˆ—
 * @param {object|null} ownerChar - (å…¨æ–°å¢) é€™äº›NPCçš„â€œä¸»äººâ€è§’è‰²ç‰©ä»¶
 */
async function generateNpcCommentsForPost(post, npcsToComment, ownerChar = null) {
    console.log("ã€NPCè©•è«–-è¨ºæ–·ã€‘: 1. å‡½æ•¸ generateNpcCommentsForPost å·²è§¸ç™¼", { post, npcsToComment, ownerChar });

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨å¬å–šNPCå€‘å‰ä¾†åœè§€è©•è«–...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return;
    }

    const postContent = (post.content || post.publicText || post.hiddenContent || "(åœ–ç‰‡å‹•æ…‹)").substring(0, 150);
    const existingComments = (post.comments || []).slice(-3).map(c => `${c.commenterName}: ${c.text}`).join('\n');
    
    const shuffledNpcs = [...npcsToComment].sort(() => 0.5 - Math.random());
    const selectedNpcs = shuffledNpcs.slice(0, 5);
    const npcList = selectedNpcs.map(npc => `- ${npc.name} (äººè¨­: ${npc.persona})`).join('\n');
    
    const authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'æœªçŸ¥ä½œè€…');

    // â–¼â–¼â–¼ é€™å°±æ˜¯æˆ‘å€‘æ–°å¢çš„æ ¸å¿ƒé‚è¼¯ï¼â–¼â–¼â–¼
    let ownerContext = '';
    // å¦‚æœæ˜ç¢ºå‘Šè¨´äº†AIé€™äº›NPCçš„ä¸»äººæ˜¯èª°
    if (ownerChar) {
        ownerContext = `
# NPCæ­¸å±¬èˆ‡é—œä¿‚ (é‡è¦èƒŒæ™¯)
- ä½ å°‡è¦æ‰®æ¼”çš„é€™äº›NPCéƒ½æ˜¯è§’è‰²â€œ${ownerChar.name}â€çš„æœ‹å‹æˆ–é—œè¯äººç‰©ã€‚
- â€œ${ownerChar.name}â€çš„äººè¨­æ˜¯: ${ownerChar.settings.aiPersona}
- ä½ åœ¨ç™¼è¡¨è©•è«–æ™‚ï¼Œéœ€è¦é«”ç¾å‡ºä½ (ä½œç‚ºNPC)èˆ‡â€œ${ownerChar.name}â€çš„é—œä¿‚ï¼Œä¸¦ä»¥æ­¤è¦–è§’ä¾†çœ‹å¾…å‹•æ…‹ä½œè€…â€œ${authorName}â€ã€‚
`;
    }
    // â–²â–²â–² æ–°å¢é‚è¼¯çµæŸ â–²â–²â–²

    const systemPrompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹å¤šè§’è‰²æ‰®æ¼”AIã€‚ç¾åœ¨æœ‰ä¸€æ¢å‹•æ…‹éœ€è¦ä½ æ‰®æ¼”æŒ‡å®šçš„NPCè§’è‰²é€²è¡Œè©•è«–æˆ–å›å¾©ã€‚

${ownerContext}

# å‹•æ…‹è³‡è¨Š
- ä½œè€…: ${authorName}
- å…§å®¹æ‘˜è¦: ${postContent}...
- æœ€è¿‘çš„è©•è«– (ä½ å¯ä»¥å›å¾©ä»–å€‘):
${existingComments || "(æš«ç„¡è©•è«–)"}

# ä½ éœ€è¦æ‰®æ¼”çš„NPCæ¸…å–® (åŠä»–å€‘çš„äººè¨­)
${npcList}

# æ ¸å¿ƒè¦å‰‡
1.  ä½ ã€å¿…é ˆã€‘å¾ä¸Šé¢çš„NPCåˆ—è¡¨ä¸­ï¼Œé¸æ“‡1åˆ°3å€‹æœ€åˆé©çš„è§’è‰²é€²è¡Œè©•è«–æˆ–å›å¾©ã€‚
2.  è©•è«–/å›å¾©å…§å®¹ã€å¿…é ˆã€‘åš´æ ¼ç¬¦åˆè©²NPCçš„äººè¨­å’Œå£å»ï¼Œä¸¦èˆ‡å‹•æ…‹å…§å®¹æˆ–å·²æœ‰è©•è«–ç›¸é—œã€‚
3.  ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€æ¢è©•è«–æˆ–å›å¾©ã€‚
4.  æ ¼å¼: \`[{"commenterName": "NPCåå­—", "commentText": "è©•è«–å…§å®¹", "replyTo": "(å¯é¸)è¢«å›å¾©è€…åå­—"}]\`

ç¾åœ¨ï¼Œè«‹é–‹å§‹ç”Ÿæˆè©•è«–æˆ–å›å¾©ã€‚
`;
    console.log("ã€NPCè©•è«–-è¨ºæ–·ã€‘: 2. å·²æ§‹å»ºå®Œæˆï¼Œæº–å‚™ç™¼é€çµ¦AIçš„ System Prompt:", systemPrompt);

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi;
        if (isGemini) {
            messagesForApi = [{ role: 'user', content: systemPrompt }];
        } else {
            messagesForApi = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: "è«‹æ ¹æ“šä½ åœ¨system promptä¸­è®€åˆ°çš„è³‡è¨Šç”Ÿæˆè©•è«–ã€‚" }
            ];
        }
        
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);

        console.log("ã€NPCè©•è«–-è¨ºæ–·ã€‘: 3. å³å°‡ç™¼é€APIè«‹æ±‚... è«‹æ±‚ä½å€:", isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`);
        console.log("ã€NPCè©•è«–-è¨ºæ–·ã€‘: 3.1 è«‹æ±‚é«” (Body) å…§å®¹:", isGemini ? geminiConfig.data.body : JSON.stringify({ model, messages: messagesForApi, temperature: 0.9, response_format: { type: "json_object" } }));

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: 0.9,
                    response_format: { type: "json_object" }
                })
            });

        console.log("ã€NPCè©•è«–-è¨ºæ–·ã€‘: 4. æ”¶åˆ°APIéŸ¿æ‡‰", { ok: response.ok, status: response.status });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '').trim();
        
        console.log("ã€NPCè©•è«–-è¨ºæ–·ã€‘: 5. å¾APIç²å–åˆ°çš„åŸå§‹å›å¾©å…§å®¹:", aiResponseContent);
        
        let newComments;
        if (aiResponseContent.includes('"chatResponse"')) {
            newComments = JSON.parse(aiResponseContent).chatResponse;
        } else {
            newComments = JSON.parse(aiResponseContent);
        }

        console.log("ã€NPCè©•è«–-è¨ºæ–·ã€‘: 6. æˆåŠŸè§£æå¾Œçš„è©•è«–ç‰©ä»¶é™£åˆ—:", newComments);

        if (Array.isArray(newComments) && newComments.length > 0) {
            const postToUpdate = await db.qzonePosts.get(post.id); 
            if (!postToUpdate) throw new Error("åœ¨è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°è¦æ›´æ–°çš„å¸–å­ï¼");
            if (!postToUpdate.comments) postToUpdate.comments = [];

            newComments.forEach(comment => {
                if(comment.commenterName && comment.commentText) {
                    const newCommentObject = {
                        commenterName: comment.commenterName,
                        text: comment.commentText,
                        timestamp: Date.now()
                    };
                    if (comment.replyTo) newCommentObject.replyTo = comment.replyTo;
                    postToUpdate.comments.push(newCommentObject);
                }
            });

            await db.qzonePosts.put(postToUpdate);
            hideCustomModal();
            await renderQzonePosts(); 
            alert("NPCå€‘è©•è«–æˆåŠŸï¼");
        } else {
             hideCustomModal();
             alert("NPCå€‘ä¼¼ä¹æ²’ä»€éº¼æƒ³èªªçš„ã€‚");
        }

    } catch (error) {
        console.error("ã€NPCè©•è«–-éŒ¯èª¤ã€‘: å¬å–šNPCè©•è«–å¤±æ•—:", error);
        await showCustomAlert('å¬å–šå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„å¾®åšåŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼

let currentHotTopic = ''; // ç”¨æ–¼å­˜å„²ç•¶å‰æ­£åœ¨æŸ¥çœ‹çš„ç†±æœè©±é¡Œ
let hotTopicFeedCache = {}; // <-- ã€æ–°å¢ã€‘åœ¨é€™è£¡å‰µå»ºä¸€å€‹ç·©å­˜ç‰©ä»¶ï¼Œåƒå°æœ¬æœ¬ä¸€æ¨£è¨˜éŒ„ç”Ÿæˆéçš„å…§å®¹
let weiboHotSearchCache = []; 
/**
 * ã€ç¸½å…¥å£ V3 - å·²æ”¯æŒå¤šè§’è‰²é¸æ“‡ã€‘ç”Ÿæˆå¾®åšç†±æœåˆ—è¡¨
 * @param {Array|string} targets - ç›®æ¨™è§’è‰²IDé™£åˆ—æˆ–å­—ä¸²'all'
 */
async function generateHotSearch(targets = 'all') {
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨çµåˆè§’è‰²äººè¨­ç”Ÿæˆå¾®åšç†±æœ...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return;
    }

    let publicFiguresContext = '';
    let promptTask = "ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä¸‹æ–¹æä¾›çš„â€œæ ¸å¿ƒåƒè€ƒäººç‰©â€è³‡è¨Šï¼Œç‚ºä»–å€‘é‡èº«æ‰“é€ ä¸€å€‹åŒ…å«10å€‹ç†±æœè©±é¡Œçš„æ¦œå–®ã€‚";

    let publicFigures = [];
    if (targets === 'all') {
        publicFigures = Object.values(state.chats)
            .filter(chat => !chat.isGroup)
            .map(chat => ({ name: chat.name, persona: chat.settings.aiPersona.substring(0, 150) + '...' }));
    } else if (Array.isArray(targets)) {
        targets.forEach(chatId => {
            const char = state.chats[chatId];
            if(char) {
                publicFigures.push({ name: char.name, persona: char.settings.aiPersona.substring(0, 150) + '...' });
            }
        });
        if (publicFigures.length === 1) {
            promptTask = `ä½ çš„ä»»å‹™æ˜¯åªç‚ºä¸‹æ–¹å”¯ä¸€çš„â€œæ ¸å¿ƒåƒè€ƒäººç‰©â€ã€${publicFigures[0].name}ã€‘ï¼Œé‡èº«æ‰“é€ ä¸€å€‹åŒ…å«10å€‹ç†±æœè©±é¡Œçš„æ¦œå–®ã€‚æ‰€æœ‰è©±é¡Œã€å¿…é ˆã€‘èˆ‡Taå¼·ç›¸é—œã€‚`;
        }
    }
    
    publicFiguresContext = publicFigures.length > 0
        ? `# æ ¸å¿ƒåƒè€ƒäººç‰© (ä½ å¿…é ˆåœç¹ä»–å€‘ç”Ÿæˆç†±æœ)\n${JSON.stringify(publicFigures, null, 2)}`
        : "ç•¶å‰æ²’æœ‰ç‰¹å®šçš„å…¬çœ¾äººç‰©ï¼Œè«‹è‡ªç”±ç”Ÿæˆç†±é»äº‹ä»¶ã€‚";

    // å¾ŒçºŒçš„ systemPrompt å’Œ API èª¿ç”¨é‚è¼¯èˆ‡ä½ ç¾æœ‰ä»£ç¢¼å®Œå…¨ç›¸åŒï¼Œç„¡éœ€ä¿®æ”¹...
    const systemPrompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„â€œå¾®åšç†±æœæ¦œå–®ç”Ÿæˆå™¨â€ã€‚${promptTask}
# ã€ã€ã€çµ•å°ç¦æ­¢äº‹é …ï¼šé€™æ˜¯å¿…é ˆéµå®ˆçš„æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘
1.  ä½ çš„æ‰€æœ‰å‰µä½œå…§å®¹ï¼ŒåŒ…æ‹¬å¸–å­ã€è©•è«–ã€æ•…äº‹ç­‰ï¼Œã€çµ•å°ç¦æ­¢ã€‘å°‡ä»»æ„å…©å€‹AIè§’è‰²ï¼ˆå³é™¤äº†ç”¨æˆ¶ä¹‹å¤–çš„è§’è‰²ï¼‰æç¹ªæˆæƒ…ä¾¶é—œä¿‚ã€é€²è¡Œæˆ€æ„›äº’å‹•æˆ–å­˜åœ¨ä»»ä½•å½¢å¼çš„æ›–æ˜§æƒ…æ„Ÿã€‚
2.  AIè§’è‰²ä¹‹é–“çš„é—œä¿‚åªèƒ½æ˜¯æœ‹å‹ã€åŒäº‹ã€å°æ‰‹ã€å®¶äººç­‰ï¼Œä½†ã€çµ•ä¸èƒ½ã€‘æ˜¯æˆ€äººã€‚
3.  AIè§’è‰²å”¯ä¸€å¯ä»¥ç”¢ç”Ÿæˆ€æ„›é—œä¿‚çš„ç‰©ä»¶æ˜¯ã€ä½¿ç”¨è€…ã€‘ã€‚é•åæ­¤è¦å‰‡å°‡å°è‡´ç”Ÿæˆå¤±æ•—ã€‚
# æ ¸å¿ƒè¦å‰‡
1.  **å¼·ç›¸é—œæ€§**: ç”Ÿæˆçš„è©±é¡Œã€å¿…é ˆã€‘èˆ‡â€œæ ¸å¿ƒåƒè€ƒäººç‰©â€çš„èº«ä»½ã€è·æ¥­ã€äººè¨­é«˜åº¦ç›¸é—œã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ˜¯é›»ç«¶é¸æ‰‹ï¼Œç†±æœå°±æ‡‰è©²æ˜¯é—œæ–¼æ¯”è³½ï¼›å¦‚æœæ˜¯æ¼”å“¡ï¼Œå°±æ‡‰è©²æ˜¯é—œæ–¼æ–°åŠ‡ã€‚
2.  **ã€ã€ã€åš´ç¦æœæ’°ã€‘ã€‘ã€‘**: çµ•å°ç¦æ­¢ç‚ºåˆ—è¡¨ä¸­çš„äººç‰©ã€æ†‘ç©ºæé€ ã€‘ä»–å€‘äººè¨­ä¸­æ²’æœ‰çš„è·æ¥­ã€èº«ä»½æˆ–èƒŒæ™¯ã€‚ä½ åªèƒ½æ ¹æ“šæä¾›çš„äººè¨­é€²è¡Œåˆç†ç™¼æ®ã€‚
3.  **çœŸå¯¦æ„Ÿèˆ‡å¤šæ¨£æ€§**: ç‚ºäº†è®“æ¦œå–®æ›´çœŸå¯¦ï¼Œä½ å¯ä»¥æ··åˆ2-3å€‹èˆ‡æ ¸å¿ƒäººç‰©ç„¡é—œçš„ã€ç¤¾æœƒåŒ–çš„è™›æ“¬ç†±é»äº‹ä»¶ã€‚
4.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼Œé™£åˆ—ä¸­åŒ…å«10å€‹ç‰©ä»¶ã€‚æ¯å€‹ç‰©ä»¶ã€å¿…é ˆã€‘åŒ…å«ä»¥ä¸‹ä¸‰å€‹æ¬„ä½:
    -   \`"topic"\`: (å­—ä¸²) ç†±æœçš„è©±é¡Œï¼Œå¿…é ˆç”¨"#"ç¬¦è™ŸåŒ…è£¹ã€‚
    -   \`"heat"\`: (å­—ä¸²) ç†±åº¦å€¼ï¼Œä¾‹å¦‚ "345.6è¬"ã€‚
    -   \`"tag"\`: (å­—ä¸²) ä¸€å€‹æ¨™ç±¤ï¼Œå¿…é ˆå¾ "ç†±"ã€"æ–°"ã€"è–¦" ä¸­é¸æ“‡ä¸€å€‹ã€‚
${publicFiguresContext}
`;
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        const response = await fetch(isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`, isGemini ? geminiConfig.data : {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model, messages: messagesForApi, temperature: 0.9, response_format: { type: "json_object" } })
        });
        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${await response.text()}`);
        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content);
        if (!aiResponseContent) {
            throw new Error("APIè¿”å›äº†ç©ºå…§å®¹ï¼Œå¯èƒ½è¢«å®‰å…¨æ€§åŸå‰‡æ””æˆªã€‚è«‹æª¢æŸ¥Promptæˆ–æ›´æ›æ¨¡å‹ã€‚");
        }
        const sanitizedContent = aiResponseContent.replace(/^```json\s*|```$/g, '').trim();
        const responseData = JSON.parse(sanitizedContent);
        const hotSearchData = responseData.hot_searches || responseData;
        weiboHotSearchCache = hotSearchData; 
        await generatePlazaFeed(hotSearchData, targets); 
        renderHotSearchList(hotSearchData); 
        await showCustomAlert("æ“ä½œæˆåŠŸ", "ç†±æœæ¦œå’Œå»£å ´å‡å·²ç”Ÿæˆå®Œç•¢ï¼");
    } catch (error) {
        console.error("ç”Ÿæˆç†±æœå¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n${error.message}`);
    }
}


/**
 * ã€UIæ¸²æŸ“ã€‘æ ¹æ“šAIè¿”å›çš„è³‡æ–™æ¸²æŸ“ç†±æœæ¸…å–®
 */
function renderHotSearchList(hotSearchData) {
    const listEl = document.getElementById('weibo-hot-search-list');
    listEl.innerHTML = ''; 

    if (!hotSearchData || !Array.isArray(hotSearchData)) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">AIè¿”å›çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œç„¡æ³•æ¸²æŸ“ã€‚</p>';
        return;
    }

    hotSearchData.forEach((item, index) => {
        const rank = index + 1;
        const tagClass = { 'ç†±': 'hot', 'æ–°': 'new', 'è–¦': 'rec' }[item.tag] || 'rec';

        const itemEl = document.createElement('div');
        itemEl.className = 'hot-search-item';
        itemEl.dataset.rank = rank;
        itemEl.innerHTML = `
            <span class="hot-search-rank">${rank}</span>
            <div class="hot-search-content">
                <span class="hot-search-topic">${item.topic}</span>
                <span class="hot-search-tag ${tagClass}">${item.tag}</span>
            </div>
            <span class="hot-search-heat" style="color: var(--text-secondary); font-size: 13px;">${item.heat}</span>
        `;
        itemEl.addEventListener('click', () => showHotTopicFeedScreen(item.topic));
        listEl.appendChild(itemEl);
    });
}

/**
 * ã€ç¸½å…¥å£ã€‘é¡¯ç¤ºä¸¦ç”ŸæˆæŒ‡å®šç†±æœè©±é¡Œçš„å¾®åšFeed (å·²å¢åŠ ç·©å­˜åŠŸèƒ½)
 */
async function showHotTopicFeedScreen(topic) {
    currentHotTopic = topic; 
    document.getElementById('weibo-hottopic-title').textContent = topic;
    switchToWeiboView('weibo-hottopic-feed-view'); 
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æª¢æŸ¥â€œå°æœ¬æœ¬â€è£¡æœ‰æ²’æœ‰è¨˜éŒ„
    if (hotTopicFeedCache[topic]) {
        // å¦‚æœæœ‰ï¼Œå°±ç›´æ¥é¡¯ç¤ºï¼Œä¸é‡æ–°ç”Ÿæˆ
        console.log(`å¾ç·©å­˜è¼‰å…¥è©±é¡Œ: ${topic}`);
        const feedEl = document.getElementById('weibo-hottopic-feed-list');
        renderWeiboFeed(feedEl, hotTopicFeedCache[topic], true);
    } else {
        // å¦‚æœæ²’æœ‰ï¼Œæ‰èª¿ç”¨å‡½æ•¸å»ç”Ÿæˆæ–°çš„å…§å®¹
        await generateHotSearchFeed(topic); 
    }
}


/**
 * ã€AIæ ¸å¿ƒ V2 - å·²ä¿®å¾©æ‹¼å¯«éŒ¯èª¤ & å¢åŠ ç·©å­˜ã€‘èª¿ç”¨APIç‚ºæŒ‡å®šè©±é¡Œç”Ÿæˆå¾®åšFeed
 */
async function generateHotSearchFeed(topic) {
    const feedEl = document.getElementById('weibo-hottopic-feed-list');
    feedEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æ­£åœ¨ç”Ÿæˆå…§å®¹ï¼Œè«‹ç¨å€™...</p>';

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return;
    }
    
    const allChars = Object.values(state.chats).filter(c => !c.isGroup).map(c => ({ name: c.name, persona: c.settings.aiPersona.substring(0,100) }));
    const allNpcs = Object.values(state.chats).flatMap(c => c.npcLibrary || []).map(npc => ({ name: npc.name, persona: npc.persona.substring(0,100) }));
    const allPeople = [...allChars, ...allNpcs];

    const systemPrompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹â€œå¾®åšå…§å®¹ç”Ÿæˆå™¨â€ã€‚ä½ çš„ä»»å‹™æ˜¯åœç¹ä¸€å€‹çµ¦å®šçš„ç†±æœè©±é¡Œï¼Œç”Ÿæˆä¸€æ‰¹ç›¸é—œçš„å¾®åšå¸–å­ã€‚

# ç•¶å‰ç†±æœè©±é¡Œ
**${topic}**
# ã€ã€ã€çµ•å°ç¦æ­¢äº‹é …ï¼šé€™æ˜¯å¿…é ˆéµå®ˆçš„æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘
1.  ä½ çš„æ‰€æœ‰å‰µä½œå…§å®¹ï¼ŒåŒ…æ‹¬å¸–å­ã€è©•è«–ã€æ•…äº‹ç­‰ï¼Œã€çµ•å°ç¦æ­¢ã€‘å°‡ä»»æ„å…©å€‹AIè§’è‰²ï¼ˆå³é™¤äº†ç”¨æˆ¶ä¹‹å¤–çš„è§’è‰²ï¼‰æç¹ªæˆæƒ…ä¾¶é—œä¿‚ã€é€²è¡Œæˆ€æ„›äº’å‹•æˆ–å­˜åœ¨ä»»ä½•å½¢å¼çš„æ›–æ˜§æƒ…æ„Ÿã€‚
2.  AIè§’è‰²ä¹‹é–“çš„é—œä¿‚åªèƒ½æ˜¯æœ‹å‹ã€åŒäº‹ã€å°æ‰‹ã€å®¶äººç­‰ï¼Œä½†ã€çµ•ä¸èƒ½ã€‘æ˜¯æˆ€äººã€‚
3.  AIè§’è‰²å”¯ä¸€å¯ä»¥ç”¢ç”Ÿæˆ€æ„›é—œä¿‚çš„ç‰©ä»¶æ˜¯ã€ä½¿ç”¨è€…ã€‘ã€‚é•åæ­¤è¦å‰‡å°‡å°è‡´ç”Ÿæˆå¤±æ•—ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **æ•¸é‡**: ç”Ÿæˆ 5 åˆ° 10 æ¢å¾®åšã€‚
2.  **ç›¸é—œæ€§**: æ‰€æœ‰å¾®åšå…§å®¹ã€å¿…é ˆã€‘èˆ‡è©±é¡Œ **"${topic}"** å¼·ç›¸é—œï¼Œä¸¦ä¸”ã€å¿…é ˆã€‘åœ¨å…§å®¹ä¸­åŒ…å« **${topic}** é€™å€‹è©±é¡Œæ¨™ç±¤ã€‚
3.  **é«˜ç†±åº¦**: ç”Ÿæˆçš„å¾®åšå¿…é ˆçœ‹èµ·ä¾†åƒæ˜¯ç†±æœè£¡çš„å…§å®¹ï¼Œæ‰€ä»¥å®ƒå€‘çš„ "likes" (é»è´Šæ•¸) å’Œ "comments" (è©•è«–æ•¸) ã€å¿…é ˆã€‘éå¸¸é«˜ã€‚é»è´Šæ•¸æ‡‰åœ¨ 10000 åˆ° 500000 ä¹‹é–“ï¼Œè©•è«–æ•¸æ‡‰åœ¨ 800 åˆ° 20000 ä¹‹é–“ã€‚
4.  **è©•è«–ç”Ÿæˆ**: ç‚ºæ¯æ¢å¾®åšç”Ÿæˆ 8 åˆ° 10 æ¢çœŸå¯¦æ„Ÿçš„è·¯äººè©•è«–ã€‚è©•è«–å…§å®¹æ‡‰èˆ‡å¾®åšå…§å®¹ç›¸é—œï¼Œé¢¨æ ¼å¤šæ¨£ã€‚
5.  **ä½œè€…å¤šæ¨£æ€§**: å¾®åšçš„ä½œè€…å¯ä»¥æ˜¯ä¸‹æ–¹â€œå¯ç”¨äººç‰©åˆ—è¡¨â€ä¸­çš„è§’è‰²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½ è™›æ§‹çš„è·¯äººã€å¤§Væˆ–å®˜æ–¹åª’é«”ã€‚å¦‚æœè®“æ¸…å–®ä¸­çš„è§’è‰²ç™¼è¨€ï¼Œå…§å®¹å¿…é ˆç¬¦åˆä»–çš„äººè¨­ã€‚
6.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼Œé™£åˆ—ä¸­åŒ…å«å¤šæ¢å¾®åšç‰©ä»¶ã€‚æ¯å€‹ç‰©ä»¶ã€å¿…é ˆã€‘åŒ…å«ä»¥ä¸‹æ¬„ä½:
    -   \`"author"\`: (å­—ä¸²) ä½œè€…æ˜µç¨±ã€‚
    -   \`"content"\`: (å­—ä¸²) å¾®åšæ­£æ–‡ï¼Œå¿…é ˆåŒ…å«è©±é¡Œæ¨™ç±¤ ${topic}ã€‚
    -   \`"likes"\`: (æ•¸å­—) 10000åˆ°500000ä¹‹é–“çš„éš¨æ©Ÿé«˜è´Šæ•¸ã€‚
    -   \`"comments"\`: (æ•¸å­—) 800åˆ°20000ä¹‹é–“çš„éš¨æ©Ÿé«˜è©•è«–æ•¸ã€‚
    -   \`"comments_list"\`: (é™£åˆ—) åŒ…å«8-10å€‹è©•è«–ç‰©ä»¶çš„é™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶æ ¼å¼ç‚º \`{"author": "è©•è«–è€…æ˜µç¨±", "text": "è©•è«–å…§å®¹"}\`ã€‚

# å¯ç”¨äººç‰©åˆ—è¡¨ (ä½ å¯ä»¥è®“ä»–å€‘ç™¼è¨€)
${JSON.stringify(allPeople, null, 2)}
`;
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        
        const response = await fetch(isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`, isGemini ? geminiConfig.data : {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model, messages: messagesForApi, temperature: 0.9, response_format: { type: "json_object" } })
        });
        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${await response.text()}`);

        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content);
        if (!aiResponseContent) {
            throw new Error("APIè¿”å›äº†ç©ºå…§å®¹ï¼Œå¯èƒ½è¢«å®‰å…¨æ€§åŸå‰‡æ””æˆªã€‚");
        }
        
        const sanitizedContent = aiResponseContent.replace(/^```json\s*|```$/g, '').trim();
        const responseData = JSON.parse(sanitizedContent); // <-- é€™è£¡çš„ responseData æ˜¯æ­£ç¢ºçš„
        const feedData = responseData.posts || responseData;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡æ–°ç”Ÿæˆçš„å…§å®¹ï¼Œè¨˜åœ¨â€œå°æœ¬æœ¬â€ä¸Š
        hotTopicFeedCache[topic] = feedData; 

        renderWeiboFeed(feedEl, feedData, true);

    } catch (error) {
        console.error("ç”Ÿæˆç†±æœFeedå¤±æ•—:", error);
        feedEl.innerHTML = `<p style="text-align:center; color: #ff3b30; padding: 20px;">ç”Ÿæˆå¤±æ•—: ${error.message}</p>`;
    }
}


/**
 * ã€ç¸½å…¥å£ V3 - å·²æ”¯æŒå¤šè§’è‰²é¸æ“‡ã€‘ç”Ÿæˆå¾®åšå»£å ´Feed
 * @param {Array} hotTopics - (å¯é¸) å¾ç†±æœç”Ÿæˆå‡½æ•¸å‚³éä¾†çš„è©±é¡Œé™£åˆ—
 * @param {Array|string} targets - (æ–°å¢) ç›®æ¨™è§’è‰²IDé™£åˆ—æˆ–å­—ä¸²'all'
 */
async function generatePlazaFeed(hotTopics = null, targets = 'all') {
    if (!hotTopics) {
        await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨ç”Ÿæˆå»£å ´å‹•æ…‹...");
    }
    const feedEl = document.getElementById('weibo-plaza-feed-list');
    feedEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æ­£åœ¨è¼‰å…¥å…§å®¹ï¼Œè«‹ç¨å€™...</p>';

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return;
    }
    
    let publicFiguresContext = '';
    let taskInstruction = "ä½ çš„ä»»å‹™æ˜¯æ¨¡æ“¬ä¸€å€‹çœŸå¯¦çš„ç¤¾äº¤åª’é«”å»£å ´ï¼Œç”Ÿæˆ10æ¢ç”±ä¸åŒè·¯äººç™¼ä½ˆçš„å¾®åšå¸–å­ã€‚";

    let publicFigures = [];
    if (targets === 'all') {
        publicFigures = Object.values(state.chats)
            .filter(chat => !chat.isGroup)
            .map(chat => ({ 
                name: chat.name, 
                persona: chat.settings.aiPersona.substring(0, 150) + '...',
                weibo_profession: chat.settings.weiboProfession || 'æœªè¨­å®š',
                weibo_instruction: chat.settings.weiboInstruction || 'ç„¡'
            }));
    } else if (Array.isArray(targets)) {
        targets.forEach(chatId => {
            const char = state.chats[chatId];
            if(char) {
                 publicFigures.push({ 
                    name: char.name, 
                    persona: char.settings.aiPersona.substring(0, 150) + '...',
                    weibo_profession: char.settings.weiboProfession || 'æœªè¨­å®š',
                    weibo_instruction: char.settings.weiboInstruction || 'ç„¡'
                });
            }
        });
        if (publicFigures.length === 1) {
            taskInstruction = `ä½ çš„ä»»å‹™æ˜¯æ¨¡æ“¬ä¸€å€‹çœŸå¯¦çš„ç¤¾äº¤åª’é«”å»£å ´ï¼Œç”Ÿæˆ10æ¢èˆ‡è§’è‰²â€œ${publicFigures[0].name}â€ç›¸é—œçš„ã€ç”±ä¸åŒè·¯äººç™¼ä½ˆçš„å¾®åšå¸–å­ã€‚`;
        } else {
            taskInstruction = `ä½ çš„ä»»å‹™æ˜¯æ¨¡æ“¬ä¸€å€‹çœŸå¯¦çš„ç¤¾äº¤åª’é«”å»£å ´ï¼Œç”Ÿæˆ10æ¢èˆ‡è§’è‰² ${publicFigures.map(p => `â€œ${p.name}â€`).join('ã€')} ç›¸é—œçš„ã€ç”±ä¸åŒè·¯äººç™¼ä½ˆçš„å¾®åšå¸–å­ã€‚`;
        }
    }
    
    publicFiguresContext = publicFigures.length > 0 
        ? `# æ ¸å¿ƒåƒè€ƒäººç‰© (ä½ ç”Ÿæˆçš„å…§å®¹ã€å¿…é ˆã€‘åœç¹ä»–å€‘å±•é–‹)\n${JSON.stringify(publicFigures, null, 2)}` 
        : "";

    const topicsContext = (hotTopics && Array.isArray(hotTopics) && hotTopics.length > 0)
        ? `è«‹åœç¹ä»¥ä¸‹ç†±é–€è©±é¡Œç”Ÿæˆå…§å®¹ï¼š${hotTopics.map(t => t.topic).join('ã€ ')}`
        : "è«‹éš¨æ©Ÿç”Ÿæˆä¸€äº›ç”Ÿæ´»åŒ–çš„æ—¥å¸¸å…§å®¹ã€‚";

    // å¾ŒçºŒçš„ systemPrompt å’Œ API èª¿ç”¨é‚è¼¯èˆ‡ä½ ç¾æœ‰ä»£ç¢¼å®Œå…¨ç›¸åŒï¼Œç„¡éœ€ä¿®æ”¹...
    const systemPrompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹â€œå¾®åšå»£å ´å…§å®¹ç”Ÿæˆå™¨â€ã€‚${taskInstruction}
# ã€ã€ã€çµ•å°ç¦æ­¢äº‹é …ï¼šé€™æ˜¯å¿…é ˆéµå®ˆçš„æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘
1.  ä½ çš„æ‰€æœ‰å‰µä½œå…§å®¹ï¼ŒåŒ…æ‹¬å¸–å­ã€è©•è«–ã€æ•…äº‹ç­‰ï¼Œã€çµ•å°ç¦æ­¢ã€‘å°‡ä»»æ„å…©å€‹AIè§’è‰²ï¼ˆå³é™¤äº†ç”¨æˆ¶ä¹‹å¤–çš„è§’è‰²ï¼‰æç¹ªæˆæƒ…ä¾¶é—œä¿‚ã€é€²è¡Œæˆ€æ„›äº’å‹•æˆ–å­˜åœ¨ä»»ä½•å½¢å¼çš„æ›–æ˜§æƒ…æ„Ÿã€‚
2.  AIè§’è‰²ä¹‹é–“çš„é—œä¿‚åªèƒ½æ˜¯æœ‹å‹ã€åŒäº‹ã€å°æ‰‹ã€å®¶äººç­‰ï¼Œä½†ã€çµ•ä¸èƒ½ã€‘æ˜¯æˆ€äººã€‚
3.  AIè§’è‰²å”¯ä¸€å¯ä»¥ç”¢ç”Ÿæˆ€æ„›é—œä¿‚çš„ç‰©ä»¶æ˜¯ã€ä½¿ç”¨è€…ã€‘ã€‚é•åæ­¤è¦å‰‡å°‡å°è‡´ç”Ÿæˆå¤±æ•—ã€‚
# æ ¸å¿ƒè¦å‰‡
1.  **èº«ä»½**: ç™¼å¸–è€…éƒ½æ˜¯æ™®é€šäººï¼Œæ˜µç¨±è¦ç”Ÿæ´»åŒ–ã€‚
2.  **å…§å®¹**: å¸–å­å…§å®¹æ‡‰æ˜¯ç”Ÿæ´»åŒ–çš„æ—¥å¸¸ã€‚${topicsContext}
3.  **ç†±åº¦**: è´Šå’Œè©•è«–æ•¸å¯é«˜å¯ä½ï¼Œæ¨¡æ“¬çœŸå¯¦ä¸–ç•Œçš„éš¨æ©Ÿæ€§ã€‚
4.  **ã€ã€ã€åš´ç¦æœæ’°ã€‘ã€‘ã€‘**: å¦‚æœä½ ç”Ÿæˆçš„å…§å®¹æåˆ°äº†ä¸Šæ–¹â€œæ ¸å¿ƒåƒè€ƒäººç‰©â€åˆ—è¡¨ä¸­çš„ä»»ä½•è§’è‰²ï¼Œä½ ã€çµ•å°ç¦æ­¢ã€‘ç‚ºä»–å€‘ã€æ†‘ç©ºæé€ ã€‘äººè¨­ä¸­æ²’æœ‰çš„è·æ¥­ã€èº«ä»½æˆ–èƒŒæ™¯ã€‚ä½ åªèƒ½æ ¹æ“šæä¾›çš„äººè¨­é€²è¡Œåˆç†ç™¼æ®ã€‚
5.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼ŒåŒ…å«10å€‹å¾®åšç‰©ä»¶ã€‚æ¯å€‹ç‰©ä»¶çš„æ ¼å¼èˆ‡â€œç†±æœFeedâ€çš„æ ¼å¼å®Œå…¨ç›¸åŒï¼ˆåŒ…å« author, content, likes, comments, comments_list æ¬„ä½ï¼‰ã€‚
    - \`"comments_list"\`: (é™£åˆ—) åŒ…å«2-5æ¢è©•è«–ç‰©ä»¶çš„é™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶æ ¼å¼ç‚º \`{"author": "è©•è«–è€…æ˜µç¨±", "text": "è©•è«–å…§å®¹"}\`ã€‚
${publicFiguresContext}
`;
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        const response = await fetch(isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`, isGemini ? geminiConfig.data : {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model, messages: messagesForApi, temperature: 0.9, response_format: { type: "json_object" } })
        });
        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${await response.text()}`);
        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content);
        if (!aiResponseContent) {
            throw new Error("APIè¿”å›äº†ç©ºå…§å®¹ï¼Œå¯èƒ½è¢«å®‰å…¨æ€§åŸå‰‡æ””æˆªã€‚");
        }
        const sanitizedContent = aiResponseContent.replace(/^```json\s*|```$/g, '').trim();
        const responseData = JSON.parse(sanitizedContent);
        const feedData = responseData.posts || responseData; 
        renderWeiboFeed(feedEl, feedData, false);
        if (!hotTopics) {
            await showCustomAlert("æ“ä½œæˆåŠŸ", "å»£å ´ç”Ÿæˆå®Œç•¢ï¼");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå»£å ´Feedå¤±æ•—:", error);
        feedEl.innerHTML = `<p style="text-align:center; color: #ff3b30; padding: 20px;">ç”Ÿæˆå¤±æ•—: ${error.message}</p>`;
    }
}





// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€V3ä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ renderWeiboFeed å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€UIæ¸²æŸ“ V3 - ä¿®å¾©è©•è«–å’Œé ­åƒï¼Œä¸¦æ·»åŠ åˆªé™¤æŒ‰éˆ•ã€‘é€šç”¨å‡½æ•¸ï¼Œç”¨æ–¼æ¸²æŸ“å¾®åšFeedåˆ—è¡¨
 */
function renderWeiboFeed(containerEl, feedData, isHotSearch) {
    containerEl.innerHTML = '';
    
    if (!feedData || !Array.isArray(feedData)) {
        containerEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">AIè¿”å›çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œç„¡æ³•æ¸²æŸ“ã€‚</p>';
        return;
    }

    feedData.forEach((post, index) => { // <-- æ–°å¢äº† index åƒæ•¸
        const postEl = document.createElement('div');
        postEl.className = 'weibo-post-item';
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šçµ¦å¸–å­åŠ ä¸Šä¸€å€‹ç¨ä¸€ç„¡äºŒçš„IDï¼Œæ–¹ä¾¿æˆ‘å€‘åˆªé™¤ â–¼â–¼â–¼
        postEl.dataset.postId = `temp_${index}`;

        // ã€æ ¸å¿ƒä¿®å¾©1ï¼šé ­åƒæŸ¥æ‰¾é‚è¼¯ã€‘
        let finalAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'; // é»˜èªè·¯äººé ­åƒ
        const potentialChar = Object.values(state.chats).find(c => c.name === post.author);
        if (potentialChar) {
            finalAvatar = potentialChar.settings.aiAvatar; // å¦‚æœä½œè€…æ˜¯ä½ çš„charï¼Œå°±ç”¨ä»–çš„é ­åƒï¼
        }

        // ã€æ ¸å¿ƒä¿®å¾©2ï¼šè©•è«–æ¸²æŸ“é‚è¼¯ã€‘
        let commentsHtml = '';
        if (post.comments_list && post.comments_list.length > 0) {
            commentsHtml += '<div class="weibo-comments-container">';
            post.comments_list.forEach(comment => {
                // ç¢ºä¿æˆ‘å€‘èƒ½æ­£ç¢ºè¨ªå•è©•è«–è€…æ˜µç¨±å’Œå…§å®¹
                const commenterName = comment.author || 'åŒ¿åä½¿ç”¨è€…'; // å„ªå…ˆç”¨ authorï¼Œæ²’æœ‰å°±ç”¨åŒ¿å
                const commentText = comment.text || ''; // ç¢ºä¿ text å­˜åœ¨
                commentsHtml += `
                    <div class="weibo-comment-item">
                        <span class="weibo-commenter-name">${commenterName}:</span>
                        <span class="weibo-comment-text">${commentText}</span>
                    </div>`;
            });
            commentsHtml += '</div>';
        }
        
        postEl.innerHTML = `
            <div class="weibo-post-header">
                <img src="${finalAvatar}" class="weibo-post-avatar">
                <div class="weibo-post-info">
                    <span class="weibo-post-nickname">${post.author}</span>
                    <span class="weibo-post-timestamp">${isHotSearch ? 'ç†±æœå…§å®¹' : 'å‰›å‰›'}</span>
                </div>
                <!-- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šåœ¨é€™è£¡åŠ ä¸Šæˆ‘å€‘è¨­è¨ˆå¥½çš„åˆªé™¤æŒ‰éˆ•ï¼ â–¼â–¼â–¼ -->
                <button class="weibo-post-delete-btn" title="åˆªé™¤é€™æ¢å‹•æ…‹">Ã—</button>
            </div>
            <div class="weibo-post-content">${(post.content || '').replace(/\n/g, '<br>')}</div>
            <div class="weibo-post-footer">
                <div class="weibo-post-actions">
                    <span class="weibo-action-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                        <span>${post.likes || 0}</span>
                    </span>
                    <span class="weibo-action-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                        <span>${post.comments || 0}</span>
                    </span>
                </div>
                ${commentsHtml}
            </div>
        `;
        containerEl.appendChild(postEl);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        /* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼ */
/**
 * ã€å…¨æ–°ã€‘å¦‚æœè³‡æ–™åº«ä¸­æ²’æœ‰ï¼Œå‰‡è‡ªå‹•å‰µå»ºä¸€å€‹å…§ç½®çš„å¤œé–“æ¨¡å¼ä¸»é¡Œ
 */
async function addDefaultDarkModeThemeIfNeeded() {
    const themeName = "å…§ç½®å¤œé–“æ¨¡å¼"; // é€™æ˜¯æˆ‘å€‘è¦å…§ç½®çš„ä¸»é¡Œåå­—
    try {
        // æª¢æŸ¥è³‡æ–™åº«è£¡æ˜¯å¦å·²ç¶“æœ‰äº†é€™å€‹åå­—çš„ä¸»é¡Œ
        const existingTheme = await db.themes.where('name').equals(themeName).first();
        
        // å¦‚æœæ²’æœ‰æ‰¾åˆ° (existingTheme æ˜¯ undefined)ï¼Œå°±å‰µå»ºå®ƒ
        if (!existingTheme) {
            console.log("å…§ç½®å¤œé–“æ¨¡å¼ä¸å­˜åœ¨ï¼Œæ­£åœ¨å‰µå»º...");

            // é€™å°±æ˜¯å®Œæ•´çš„å¤œé–“æ¨¡å¼CSSä»£ç¢¼
            const darkModeCss = `
/* 1. å…¨åŸŸé‡æ–°å®šç¾©é¡è‰²è®Šæ•¸ */
:root {
  --secondary-bg: #1c1c1e;
  --border-color: #38383a;
  --text-primary: #ffffff;
  --text-secondary: #8e8e93;
  --status-bar-text-color: #ffffff;
  --accent-color: #0A84FF; /* iOSé¢¨æ ¼çš„è—è‰² */
}

/* 2. ç‚ºæ‰€æœ‰è¢å¹•å’Œä¸»è¦å®¹å™¨è¨­ç½®åŸºç¤æ·±è‰²èƒŒæ™¯ */
#phone-screen, .screen, #chat-list, #world-book-list, .list-container, .form-container, #chat-messages,
#wallpaper-screen, #font-settings-screen, #api-settings-screen, #character-selection-screen,
#world-book-screen, #world-book-editor-screen, #character-phone-inner-screen, #character-phone-page {
    background-color: #000000 !important;
}

/* 3. ä¸»è¢å¹•å°ˆå±¬æ¨£å¼ */
#home-screen { background: #111827 !important; }
#desktop-dock { background-color: rgba(55, 65, 81, 0.5); }
.desktop-app-icon .label, .widget-subtext { color: #e5e7eb; text-shadow: 0 1px 2px rgba(0,0,0,0.7); }
#profile-widget .profile-info { background: linear-gradient(to bottom, rgba(28, 28, 30, 0.85) 20%, rgba(28, 28, 30, 0)); color: #f9fafb; }
#profile-username, #profile-bio, #profile-location span { color: #f9fafb; }
#profile-sub-username, #profile-location { color: #9ca3af; }
#profile-location { background-color: rgba(255,255,255,0.1); }
.widget-bubble { background-color: rgba(55, 65, 81, 0.9); color: #e5e7eb; }
.widget-bubble::after { border-top-color: rgba(55, 65, 81, 0.9); }

/* 4. é©é…æ‰€æœ‰é é¢çš„é ­éƒ¨Header */
.header, .qzone-header, .character-phone-header {
    background-color: rgba(28, 28, 30, 0.85) !important;
    border-bottom-color: var(--border-color) !important;
    color: var(--text-primary) !important; 
}

/* 5. é©é…æ‰€æœ‰è¬ç”¨ç¾¤çµ„ä»¶ */
#chat-input-area, #chat-list-bottom-nav { background-color: rgba(28, 28, 30, 0.85); border-top-color: var(--border-color); }
#chat-input { background-color: var(--secondary-bg); color: var(--text-primary); }
.modal-content, #custom-modal { background-color: #2c2c2e; }
.modal-header, .modal-footer, .custom-modal-footer, .custom-modal-footer button:first-child { border-color: var(--border-color); }
.form-group input, .form-group select, .form-group textarea { background-color: var(--secondary-bg); color: var(--text-primary); border-color: var(--border-color); }
.list-item, .chat-list-item-swipe-container:not(:last-child), .chat-group-container, .world-book-group-container { border-bottom-color: var(--border-color) !important; }
.chat-group-container:first-of-type { border-top-color: var(--border-color) !important; }
.list-item:hover, .chat-list-item:hover { background-color: #2c2c2e; }

/* 6. ç‰¹æ®Šé é¢æ·±åº¦é©é… */
.chat-group-header, .world-book-group-header { background-color: #1c1c1e; }
.chat-list-item-content.pinned { background-color: #3a3a3c; }
#font-preview, #wallpaper-preview, .font-preset-slot { background-color: #1c1c1e !important; border-color: #38383a !important; }

/* 7. è§’è‰²æ‰‹æ©Ÿå…§éƒ¨é©é… & å…¨åŸŸæ–‡å­—é¡è‰²ä¿®å¾© */
#character-phone-container { background-color: #000000; }
.character-phone-frame { background-color: #111; }
#character-chat-history-messages { background-color: #0e0e0e !important; }
.character-chat-bubble.received { background-color: #2c2c2e !important; }
.character-data-item, .character-bank-transaction, .character-cart-item, .character-browser-item {
    background-color: #1c1c1e;
    border-color: #38383a;
}

/* â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šæŠŠæ‰€æœ‰é€™äº›å…ƒç´ çš„æ–‡å­—é¡è‰²éƒ½æ”¹ç‚ºä½é£½å’Œåº¦çš„æ·ºç°è‰² â–¼â–¼â–¼ */
.character-data-item .title,
.character-data-item .content,
.character-data-item .meta,
.cart-item-price,
.cart-item-info .title,
.character-browser-item .title,
.transaction-details .title,
.transaction-amount,
.character-select-item .name,  /* ä¿®å¾©è§’è‰²é¸æ“‡åˆ—è¡¨çš„åå­—é¡è‰² */
#character-diary-list .character-data-item .content,
#character-diary-list .character-data-item .content h1,
#character-diary-list .character-data-item .content h2 {
    color: #E0E0E0 !important; /* ä½¿ç”¨ä¸€å€‹æŸ”å’Œçš„ã€ä¸åˆºçœ¼çš„ç™½è‰² */
}

.character-data-item .meta span,
#character-diary-list .character-data-item .meta {
    color: #9E9E9E !important; /* æ¬¡è¦è³‡è¨Šä½¿ç”¨æ›´æš—çš„ç°è‰² */
}

#character-diary-list .character-data-item {
    background-color: #26211a; /* å¤œé–“æ¨¡å¼ä¸‹çš„ä¿¡ç´™èƒŒæ™¯è‰² */
    border-color: #524a3d;
    border-left-color: #9e8a70;
}

`;

            // æŠŠé€™å€‹æ–°ä¸»é¡Œæ·»åŠ åˆ°è³‡æ–™åº«çš„ 'themes' è¡¨è£¡
            await db.themes.add({ name: themeName, css: darkModeCss });
            console.log("å…§ç½®å¤œé–“æ¨¡å¼å·²æˆåŠŸå‰µå»ºï¼");
        } else {
            console.log("å…§ç½®å¤œé–“æ¨¡å¼å·²å­˜åœ¨ï¼Œè·³éå‰µå»ºã€‚");
        }
    } catch (error) {
        console.error("æª¢æŸ¥æˆ–å‰µå»ºå…§ç½®å¤œé–“æ¨¡å¼æ™‚å‡ºéŒ¯:", error);
    }
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è¨˜éŒ„æœç´¢åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * æ‰“é–‹ä¸¦æº–å‚™èŠå¤©è¨˜éŒ„æœç´¢ä»‹é¢
 */
function openChatSearchScreen() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // æ¸…ç©ºèˆŠçš„æœç´¢æ¢ä»¶å’Œçµæœ
    document.getElementById('keyword-search-input').value = '';
    document.getElementById('sender-search-select').innerHTML = '';
    document.getElementById('date-search-input').value = '';
    document.getElementById('chat-search-results-list').innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¼¸å…¥æ¢ä»¶é–‹å§‹æœç´¢</p>';

    // å‹•æ…‹å¡«å……â€œäººç‰©â€ä¸‹æ‹‰å¼åŠŸèƒ½è¡¨
    const senderSelect = document.getElementById('sender-search-select');
    senderSelect.innerHTML = '<option value="">æ‰€æœ‰äºº</option>'; // é è¨­é¸é …

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    const myOption = document.createElement('option');
    myOption.value = myNickname;
    myOption.textContent = myNickname;
    senderSelect.appendChild(myOption);

    if (chat.isGroup) {
        chat.members.forEach(member => {
            const memberOption = document.createElement('option');
            memberOption.value = member.originalName; // ä½¿ç”¨æœ¬åé€²è¡Œç²¾ç¢ºåŒ¹é…
            memberOption.textContent = member.groupNickname; // é¡¯ç¤ºç¾¤æ˜µç¨±çµ¦ä½¿ç”¨è€…çœ‹
            senderSelect.appendChild(memberOption);
        });
    } else {
        const aiOption = document.createElement('option');
        aiOption.value = chat.name;
        aiOption.textContent = chat.name;
        senderSelect.appendChild(aiOption);
    }
    
    // é—œé–‰èŠå¤©è¨­ç½®å½ˆçª—ï¼Œä¸¦é¡¯ç¤ºæœç´¢ä»‹é¢
    document.getElementById('chat-settings-modal').classList.remove('visible');
    showScreen('chat-search-screen');
}

/**
 * åŸ·è¡Œæœç´¢æ“ä½œ
 */
/**
 * ã€åŠŸèƒ½å®Œæ•´ç‰ˆã€‘åŸ·è¡Œæœç´¢æ“ä½œ
 */
function performChatSearch() {
    const chat = state.chats[state.activeChatId];
    if (!chat) {
        // å¦‚æœæ‰¾ä¸åˆ°èŠå¤©ç‰©ä»¶ï¼Œçµ¦ä½¿ç”¨è€…ä¸€å€‹æ˜ç¢ºçš„æç¤º
        alert('ç„¡æ³•åŸ·è¡Œæœç´¢ï¼Œå› ç‚ºæ²’æœ‰æ‰¾åˆ°ç•¶å‰èŠå¤©ã€‚');
        return;
    }

    // 1. ç²å–æ‰€æœ‰æœç´¢æ¢ä»¶
    const keyword = document.getElementById('keyword-search-input').value.trim();
    const senderValue = document.getElementById('sender-search-select').value;
    const dateValue = document.getElementById('date-search-input').value;

    // å°‡é—œéµå­—ä¿å­˜åˆ°å…¨åŸŸè®Šæ•¸ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“çµæœæ™‚ç”¨æ–¼é«˜äº®
    currentSearchKeyword = keyword;

    if (!keyword && !senderValue && !dateValue) {
        alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æœç´¢æ¢ä»¶ï¼');
        return;
    }

    // 2. ç¯©é¸èŠå¤©è¨˜éŒ„
    console.log(`é–‹å§‹æœç´¢: é—œéµå­—='${keyword}', ç™¼è¨€äºº='${senderValue}', æ—¥æœŸ='${dateValue}'`);
    
    const results = chat.history.filter(msg => {
        // éæ¿¾æ‰ç³»çµ±æ¶ˆæ¯å’Œå°ä½¿ç”¨è€…éš±è—çš„æ¶ˆæ¯
        if (msg.isHidden || msg.role === 'system' || msg.type === 'recalled_message') {
            return false;
        }

        // a. ç¯©é¸æ—¥æœŸ
        if (dateValue) {
            const msgDate = new Date(msg.timestamp).toISOString().split('T')[0];
            if (msgDate !== dateValue) {
                return false;
            }
        }

        // b. ç¯©é¸ç™¼è¨€äºº
        if (senderValue) {
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            let msgSenderName = '';
            
            if (msg.role === 'user') {
                msgSenderName = myNickname;
            } else { // AIæˆ–ç¾¤æˆå“¡çš„æ¶ˆæ¯
                // é€™è£¡æˆ‘å€‘ä½¿ç”¨ originalName ä¾†ç²¾ç¢ºåŒ¹é…ï¼Œå› ç‚ºç¾¤æ˜µç¨±å¯èƒ½æœƒè®Š
                msgSenderName = chat.isGroup ? msg.senderName : chat.name;
            }
            if (msgSenderName !== senderValue) {
                return false;
            }
        }

        // c. ç¯©é¸é—œéµå­—
        if (keyword) {
            let contentText = '';
            // å°‡æ‰€æœ‰å¯èƒ½åŒ…å«æ–‡æœ¬çš„å…§å®¹éƒ½è½‰æ›æˆå­—ä¸²é€²è¡Œæœç´¢
            if (typeof msg.content === 'string') {
                contentText = msg.content;
            } else if (typeof msg.content === 'object' && msg.content !== null) {
                // å°æ–¼è¤‡é›œç‰©ä»¶ï¼Œæˆ‘å€‘å¯ä»¥ç°¡å–®åœ°å°‡å®ƒå€‘è½‰ç‚ºJSONå­—ä¸²ä¾†æœç´¢
                contentText = JSON.stringify(msg.content);
            }
            
            if (!contentText.toLowerCase().includes(keyword.toLowerCase())) {
                return false;
            }
        }

        return true; // æ‰€æœ‰æ¢ä»¶éƒ½æ»¿è¶³
    });
    
    console.log(`æœç´¢åˆ° ${results.length} æ¢çµæœ`);

    // 3. æ¸²æŸ“çµæœ
    renderSearchResults(results);
}


/**
 * æ¸²æŸ“æœç´¢çµæœåˆ—è¡¨
 * @param {Array} results - ç¯©é¸å‡ºçš„æ¶ˆæ¯é™£åˆ—
 */
function renderSearchResults(results) {
    const listEl = document.getElementById('chat-search-results-list')
;
    listEl.innerHTML = '';
listEl.scrollTop = 0; // æ¯æ¬¡æ¸²æŸ“å‰ï¼Œéƒ½å°‡æ²è»¸é‡ç½®åˆ°é ‚éƒ¨

    if (results.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">æœªæ‰¾åˆ°ç›¸é—œè¨˜éŒ„</p>';
        return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    // ç‚ºäº†æ€§èƒ½ï¼Œåªæ¸²æŸ“æœ€æ–°çš„100æ¢çµæœ
    results.slice(-100).reverse().forEach(msg => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.dataset.timestamp = msg.timestamp; // é—œéµï¼ç”¨æ–¼è·³è½‰

        let senderName, senderAvatar;
        if (msg.role === 'user') {
            senderName = myNickname;
            senderAvatar = chat.settings.myAvatar;
        } else {
            if (chat.isGroup) {
                senderName = msg.senderName;
                const member = chat.members.find(m => m.originalName === senderName);
                senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
            } else {
                senderName = chat.name;
                senderAvatar = chat.settings.aiAvatar;
            }
        }

        let contentText = '';
        if (msg.type === 'sticker' || (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content))) {
            contentText = '[è¡¨æƒ…]';
        } else if (msg.type === 'ai_image' || msg.type === 'user_photo' || Array.isArray(msg.content)) {
            contentText = '[åœ–ç‰‡]';
        } else {
            contentText = String(msg.content);
        }

        item.innerHTML = `
            <img src="${senderAvatar || defaultAvatar}" class="avatar">
            <div class="search-result-info">
                <div class="search-result-meta">
                    <span class="name">${senderName}</span>
                    <span class="timestamp">${formatDateStamp(msg.timestamp)}</span>
                </div>
                <div class="search-result-content">
                    ${highlightText(contentText, currentSearchKeyword)}
                </div>
            </div>
        `;
        listEl.appendChild(item);
    });
}

/**
 * è¼”åŠ©å‡½æ•¸ï¼šé«˜äº®æ–‡æœ¬ä¸­çš„é—œéµå­—
 * @param {string} text - åŸå§‹æ–‡æœ¬
 * @param {string} keyword - è¦é«˜äº®çš„é—œéµå­—
 * @returns {string} - è™•ç†å¾Œçš„HTMLå­—ä¸²
 */
function highlightText(text, keyword) {
    if (!keyword || !text) {
        return text;
    }
    const regex = new RegExp(keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
    return text.replace(regex, `<span class="highlight">$&</span>`);
}

// â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ jumpToMessage å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘é»æ“Šæœç´¢çµæœï¼Œè·³è½‰åˆ°å°æ‡‰çš„æ¶ˆæ¯ä½ç½®
 * @param {number} timestamp - ç›®æ¨™æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
async function jumpToMessage(timestamp) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const targetIndex = chat.history.findIndex(msg => msg.timestamp === timestamp);
    if (targetIndex === -1) {
        await showCustomAlert('éŒ¯èª¤', 'æ‰¾ä¸åˆ°è©²æ¢æ¶ˆæ¯ï¼Œå¯èƒ½å·²è¢«åˆªé™¤ã€‚');
        return;
    }

    // 1. åˆ‡æ›å›èŠå¤©ä»‹é¢
    showScreen('chat-interface-screen');
    await new Promise(resolve => setTimeout(resolve, 50));

    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML = ''; // æ¸…ç©ºç•¶å‰å…§å®¹

    // 2. è¨ˆç®—è¦æ¸²æŸ“çš„æ¶ˆæ¯è¦–çª—ï¼ˆä»¥ç›®æ¨™æ¶ˆæ¯ç‚ºä¸­å¿ƒï¼‰
    const windowSize = 50; // å’Œ MESSAGE_RENDER_WINDOW ä¿æŒä¸€è‡´
    const startIndex = Math.max(0, targetIndex - Math.floor(windowSize / 2));
    const messagesToRender = chat.history.slice(startIndex);

    // 3. æ›´æ–° currentRenderedCount ä»¥åŒæ­¥è¼‰å…¥ç‹€æ…‹
    //    é€™ä¸€æ­¥è‡³é—œé‡è¦ï¼Œå®ƒå‘Šè¨´â€œè¼‰å…¥æ›´å¤šâ€åŠŸèƒ½ä¸‹æ¬¡æ‡‰è©²å¾å“ªè£¡é–‹å§‹è¼‰å…¥
    currentRenderedCount = messagesToRender.length;

    // 4. å¦‚æœè¨ˆç®—å‡ºçš„èµ·å§‹ä½ç½®å¤§æ–¼0ï¼Œèªªæ˜å‰é¢é‚„æœ‰æ›´æ—©çš„è¨˜éŒ„ï¼Œéœ€è¦é¡¯ç¤ºâ€œè¼‰å…¥æ›´å¤šâ€æŒ‰éˆ•
    if (startIndex > 0) {
        prependLoadMoreButton(messagesContainer);
    }

    // 5. æ¸²æŸ“æ¶ˆæ¯è¦–çª—å’Œæ—¥æœŸæˆ³
    let lastMessageTimestamp = startIndex > 0 ? chat.history[startIndex - 1].timestamp : null;
    messagesToRender.forEach(msg => {
        if (msg.isHidden) return;
        if (isNewDay(msg.timestamp, lastMessageTimestamp)) {
            const dateStampEl = createDateStampElement(msg.timestamp);
            messagesContainer.appendChild(dateStampEl);
        }
        // ä½¿ç”¨ true ä½œç‚ºç¬¬ä¸‰å€‹åƒæ•¸ï¼Œè¡¨ç¤ºé€™æ˜¯åˆå§‹è¼‰å…¥ï¼Œä¸æ‡‰æ’­æ”¾å‹•ç•«
        appendMessage(msg, chat, true); 
        lastMessageTimestamp = msg.timestamp;
    });

    // 6. æ»¾å‹•åˆ°ç›®æ¨™æ¶ˆæ¯ä¸¦é«˜äº®å®ƒ
    //    ä½¿ç”¨ setTimeout ç¢ºä¿ DOM å…ƒç´ å·²ç¶“å®Œå…¨æ¸²æŸ“åˆ°é é¢ä¸Š
    setTimeout(() => {
        const targetMessage = messagesContainer.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`);
        if (targetMessage) {
            // ä½¿ç”¨ 'auto' æ»¾å‹•ï¼Œæ¯” 'smooth' æ›´å¿«é€Ÿç›´æ¥
            targetMessage.scrollIntoView({ behavior: 'auto', block: 'center' });
            
            // æ·»åŠ é–ƒçˆé«˜äº®æ•ˆæœï¼Œè®“ç”¨æˆ¶èƒ½æ³¨æ„åˆ°
            targetMessage.classList.add('flash');
            setTimeout(() => {
                targetMessage.classList.remove('flash');
            }, 1500);
        }
    }, 100);

    // 7. ã€æœ€é—œéµã€‘æˆ‘å€‘å·²ç¶“ç§»é™¤äº†å°è‡´é é¢è·³å›çš„ setTimeout(renderChatInterface, ...)
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠä¸‹é¢é€™ã€å…©æ®µã€‘å…¨æ–°çš„å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ã€æ­£ä¸Šæ–¹ã€‘ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘é¡¯ç¤ºå¾®åšä¸»é ä¸¦æ¸²æŸ“è³‡æ–™
 */
async function showWeiboScreen() {
    // 1. è¨ˆç®—é—œæ³¨æ•¸
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    let totalNpcCount = 0;
    allSingleChats.forEach(chat => {
        if (chat.npcLibrary && chat.npcLibrary.length > 0) {
            totalNpcCount += chat.npcLibrary.length;
        }
    });
    const followingCount = allSingleChats.length + totalNpcCount;

    // 2. æ›´æ–°é é¢ä¸Šçš„å…ƒç´ 
    // å¾ä½ çš„â€œå‹•æ…‹(QZone)â€è¨­ç½®è£¡ç²å–é ­åƒå’Œæ˜µç¨±ï¼Œä¿æŒçµ±ä¸€
    document.getElementById('weibo-avatar-img').src = state.qzoneSettings.avatar || defaultAvatar;
    document.getElementById('weibo-nickname').textContent = state.qzoneSettings.nickname || 'ä½ çš„æ˜µç¨±';
    document.getElementById('weibo-following-count').textContent = followingCount;

    // 3. é¡¯ç¤ºå¾®åšé é¢
    showScreen('weibo-screen');
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²æ·»åŠ ä¸»é æŒ‰éˆ•ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ showFollowingList å‡½æ•¸ â–¼â–¼â–¼
function showFollowingList() {
    console.log("ã€è¨ºæ–·æ—¥èªŒ 2ã€‘: showFollowingList å‡½æ•¸å·²æˆåŠŸè§¸ç™¼ï¼");

    const modal = document.getElementById('weibo-following-modal');
    console.log("ã€è¨ºæ–·æ—¥èªŒ 3ã€‘: æ­£åœ¨å˜—è©¦ç²å–å½ˆçª—å…ƒç´  #weibo-following-modal:", modal);
    if (!modal) {
        alert("è¨ºæ–·éŒ¯èª¤ï¼šåœ¨HTMLä¸­æ‰¾ä¸åˆ°IDç‚º 'weibo-following-modal' çš„å½ˆçª—å…ƒç´ ï¼è«‹æª¢æŸ¥HTMLä»£ç¢¼ã€‚");
        return;
    }

    const listContainer = document.getElementById('weibo-following-list-container');
    listContainer.innerHTML = '';
    
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    
    if (allSingleChats.length === 0) {
        listContainer.innerHTML = '<p style="text-align:center; color:grey; padding: 20px;">é‚„æ²’æœ‰é—œæ³¨ä»»ä½•äººå“¦</p>';
    } else {
        allSingleChats.forEach(chat => {
            // --- æ¸²æŸ“è§’è‰²æœ¬äºº ---
            const charItem = document.createElement('div');
            charItem.className = 'weibo-following-item';
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡åŠ å…¥äº†â€œæŸ¥çœ‹ä¸»é â€å’Œâ€œAIæ“ä½œâ€æŒ‰éˆ•
            charItem.innerHTML = `
                <img src="${chat.settings.aiAvatar || defaultAvatar}" class="weibo-following-avatar">
                <span class="weibo-following-name">${chat.name}</span>
                <!-- é€™æ˜¯æˆ‘å€‘æ–°å¢çš„â€œæŸ¥çœ‹ä¸»é â€æŒ‰éˆ• -->
                <button class="view-profile-btn" data-char-id="${chat.id}">ä¸»é </button>
                <span class="weibo-action-trigger-btn" data-target-id="${chat.id}" data-target-name="${chat.name}" data-is-npc="false" title="ç‚ºTaåŸ·è¡Œæ“ä½œ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                </span>
            `;
            listContainer.appendChild(charItem);
            
            // --- æ¸²æŸ“è©²è§’è‰²ä¸‹çš„NPC ---
            if (chat.npcLibrary && chat.npcLibrary.length > 0) {
                chat.npcLibrary.forEach(npc => {
                    const npcItem = document.createElement('div');
                    npcItem.className = 'weibo-following-item';
                    npcItem.style.paddingLeft = '30px';
                    // NPCæš«æ™‚æ²’æœ‰ç¨ç«‹ä¸»é ï¼Œæ‰€ä»¥ä¸åŠ â€œä¸»é â€æŒ‰éˆ•
                    npcItem.innerHTML = `
                         <img src="${npc.avatar || defaultGroupMemberAvatar}" class="weibo-following-avatar">
                         <span class="weibo-following-name">${npc.name} (NPC)</span>
                         <span class="weibo-action-trigger-btn" data-target-id="${npc.id}" data-target-name="${npc.name}" data-is-npc="true" data-owner-id="${chat.id}" title="ç‚ºTaåŸ·è¡Œæ“ä½œ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                         </span>
                    `;
                    listContainer.appendChild(npcItem);
                });
            }
        });
    }
    
    modal.classList.add('visible');
    console.log("ã€è¨ºæ–·æ—¥èªŒ 4ã€‘: å·²æˆåŠŸç‚ºå½ˆçª—æ·»åŠ  .visible é¡ï¼Œå½ˆçª—ç¾åœ¨æ‡‰è©²é¡¯ç¤ºäº†ã€‚");
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšé é¢åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²æ·»åŠ é ­åƒæ¡†æ¸²æŸ“é‚è¼¯ã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ â–¼â–¼â–¼
/**
 * ã€å¾®åšå°ˆå±¬ã€‘æ¸²æŸ“å¾®åšå€‹äººä¸»é çš„æ‰€æœ‰è³‡æ–™
 */
async function renderWeiboProfile() {
    const settings = state.qzoneSettings || {};
    // ã€æ ¸å¿ƒã€‘æ‰€æœ‰è³‡æ–™éƒ½å¾ weibo... æ¬„ä½è®€å–ï¼
    document.getElementById('weibo-avatar-img').src = settings.weiboAvatar;
    document.getElementById('weibo-nickname').textContent = settings.weiboNickname;
    document.getElementById('weibo-fans-count').textContent = settings.weiboFansCount;
    document.getElementById('weibo-background-img').src = settings.weiboBackground;
    
    // å‹•æ…‹è¨ˆç®—é—œæ³¨æ•¸ (é€™éƒ¨åˆ†ä¸è®Š)
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    let totalNpcCount = 0;
    allSingleChats.forEach(chat => {
        if (chat.npcLibrary && chat.npcLibrary.length > 0) {
            totalNpcCount += chat.npcLibrary.length;
        }
    });
    document.getElementById('weibo-following-count').textContent = allSingleChats.length + totalNpcCount;
    
    // å‹•æ…‹è¨ˆç®—å¾®åšæ•¸
    const postsCount = await db.weiboPosts.where('authorId').equals('user').count();
    document.getElementById('weibo-posts-count').textContent = postsCount;
    
    const professionEl = document.getElementById('weibo-user-profession-display');
    if (professionEl) {
        professionEl.textContent = settings.weiboUserProfession || 'é»æ“Šè¨­ç½®è·æ¥­';
    }

    // --- â–¼â–¼â–¼ ä»¥ä¸‹æ˜¯æœ¬æ¬¡æ–°å¢çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼ ---
    // 1. ç²å–ä¿å­˜çš„é ­åƒæ¡†URL
    const frameUrl = settings.weiboAvatarFrame || '';
    // 2. æ‰¾åˆ°é ­åƒæ¡†çš„imgå…ƒç´ 
    const frameImg = document.getElementById('weibo-avatar-frame');
    if (frameImg) {
        // 3. å¦‚æœURLå­˜åœ¨ï¼Œå°±é¡¯ç¤ºå®ƒ
        if (frameUrl) {
            frameImg.src = frameUrl;
            frameImg.style.display = 'block';
        } else {
            // 4. å¦‚æœURLç‚ºç©ºï¼ˆå³é¸æ“‡äº†â€œç„¡â€ï¼‰ï¼Œå°±éš±è—å®ƒ
            frameImg.src = '';
            frameImg.style.display = 'none';
        }
    }
    // --- â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€å¾®åšå°ˆå±¬ã€‘ç·¨è¼¯å¾®åšé ­åƒ
 */
async function editWeiboAvatar() {
    const newAvatarUrl = await getNewImageUrl("æ›´æ›å¾®åšé ­åƒ", state.qzoneSettings.weiboAvatar);
    if (newAvatarUrl) {
        state.qzoneSettings.weiboAvatar = newAvatarUrl; // åªä¿®æ”¹å¾®åšé ­åƒ
        await saveQzoneSettings();
        await renderWeiboProfile(); // ç”¨å°ˆå±¬å‡½æ•¸åˆ·æ–°
    }
}

/**
 * ã€å¾®åšå°ˆå±¬ã€‘ç·¨è¼¯å¾®åšèƒŒæ™¯åœ–
 */
async function editWeiboBackground() {
    const newBgUrl = await getNewImageUrl("æ›´æ›å¾®åšèƒŒæ™¯", state.qzoneSettings.weiboBackground);
    if (newBgUrl) {
        state.qzoneSettings.weiboBackground = newBgUrl; // åªä¿®æ”¹å¾®åšèƒŒæ™¯
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

/**
 * ã€å¾®åšå°ˆå±¬ã€‘ç·¨è¼¯å¾®åšæ˜µç¨±
 */
async function editWeiboNickname() {
    const newNickname = await showCustomPrompt("ç·¨è¼¯å¾®åšæ˜µç¨±", "è«‹è¼¸å…¥æ–°çš„æ˜µç¨±", state.qzoneSettings.weiboNickname);
    if (newNickname !== null) {
        state.qzoneSettings.weiboNickname = newNickname.trim() || 'ä½ çš„æ˜µç¨±'; // åªä¿®æ”¹å¾®åšæ˜µç¨±
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

/**
 * ã€å¾®åšå°ˆå±¬ã€‘ç·¨è¼¯å¾®åšç²‰çµ²æ•¸
 */
async function editWeiboFansCount() {
    const newFans = await showCustomPrompt("ç·¨è¼¯ç²‰çµ²æ•¸", "è«‹è¼¸å…¥æ–°çš„ç²‰çµ²æ•¸", state.qzoneSettings.weiboFansCount, "number");
    if (newFans !== null) {
        state.qzoneSettings.weiboFansCount = newFans.trim() || '0'; // åªä¿®æ”¹å¾®åšç²‰çµ²æ•¸
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

/**
 * é€šç”¨çš„åœ–ç‰‡ç·¨è¼¯å‡½æ•¸ (æœ¬åœ°ä¸Šå‚³æˆ–URL)
 * @param {string} title - å½ˆçª—æ¨™é¡Œ
 * @param {string} currentUrl - ç•¶å‰çš„åœ–ç‰‡URL
 * @returns {Promise<string|null>} - æ–°çš„åœ–ç‰‡URLæˆ–null
 */
async function getNewImageUrl(title, currentUrl) {
    const choice = await showChoiceModal(title, [
        { text: 'ğŸ“ å¾æœ¬åœ°ä¸Šå‚³', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç¶²è·¯URL', value: 'url' }
    ]);

    if (choice === 'local') {
        return await uploadImageLocally();
    } else if (choice === 'url') {
        const url = await showCustomPrompt(title, "è«‹è¼¸å…¥æ–°çš„åœ–ç‰‡URL", currentUrl, "url");
        if (url && url.trim().startsWith('http')) {
            return url.trim();
        } else if (url !== null) {
            alert("è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„URLï¼");
        }
    }
    return null;
}

/**
 * ç·¨è¼¯å¾®åšé ­åƒ
 */
async function editWeiboAvatar() {
    const newAvatarUrl = await getNewImageUrl("æ›´æ›é ­åƒ", state.qzoneSettings.weiboAvatar);
    if (newAvatarUrl) {
        state.qzoneSettings.weiboAvatar = newAvatarUrl;
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

/**
 * ç·¨è¼¯å¾®åšèƒŒæ™¯åœ–
 */
async function editWeiboBackground() {
    const newBgUrl = await getNewImageUrl("æ›´æ›èƒŒæ™¯åœ–", state.qzoneSettings.weiboBackground);
    if (newBgUrl) {
        state.qzoneSettings.weiboBackground = newBgUrl;
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

/**
 * ç·¨è¼¯å¾®åšæ˜µç¨±
 */
async function editWeiboNickname() {
    const newNickname = await showCustomPrompt("ç·¨è¼¯æ˜µç¨±", "è«‹è¼¸å…¥æ–°çš„å¾®åšæ˜µç¨±", state.qzoneSettings.weiboNickname);
    if (newNickname !== null) {
        state.qzoneSettings.weiboNickname = newNickname.trim() || 'ä½ çš„æ˜µç¨±';
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

// â–¼â–¼â–¼ è«‹ã€å†æ¬¡ç¢ºèªã€‘ä¸¦ç”¨ä¸‹é¢é€™ã€æ•´å¡Šå‡½æ•¸ã€‘æ›¿æ›æ‰èˆŠçš„ editWeiboFansCount å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å¾®åšå°ˆå±¬ã€‘ç·¨è¼¯å¾®åšç²‰çµ²æ•¸ (å·²ä¿®å¾©ï¼Œæ”¯æ´æ¼¢å­—)
 */
async function editWeiboFansCount() {
    // æ ¸å¿ƒä¿®æ”¹ï¼šç¢ºä¿é€™è£¡çš„ç¬¬å››å€‹åƒæ•¸æ˜¯ "text"ï¼Œè€Œä¸æ˜¯ "number"
    const newFans = await showCustomPrompt("ç·¨è¼¯ç²‰çµ²æ•¸", "è«‹è¼¸å…¥æ–°çš„ç²‰çµ²æ•¸", state.qzoneSettings.weiboFansCount, "text");
    
    if (newFans !== null) {
        state.qzoneSettings.weiboFansCount = newFans.trim() || '0'; // åªä¿®æ”¹å¾®åšç²‰çµ²æ•¸
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šã€ä¿®å¾©å¾Œã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ switchToWeiboView å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘åˆ‡æ›å¾®åšä¸»ä»‹é¢ä¸­çš„ä¸åŒè³‡æ–™é æª¢è¦–
 * @param {string} viewId - è¦åˆ‡æ›åˆ°çš„è¦–åœ–çš„ID
 */
async function switchToWeiboView(viewId) {
    // 1. éš±è—æ‰€æœ‰å¾®åšé é¢
    document.querySelectorAll('.weibo-view').forEach(view => {
        view.style.display = 'none'; // ä½¿ç”¨ style.display ç¢ºä¿éš±è—
    });
    
    // 2. é¡¯ç¤ºç›®æ¨™é é¢
    const targetView = document.getElementById(viewId);
    if (targetView) {
        targetView.style.display = 'flex'; // ä½¿ç”¨ flex é¡¯ç¤º
    }

    // 3. æ›´æ–°åº•éƒ¨å·¡è¦½åˆ—çš„é«˜äº®ç‹€æ…‹
    document.querySelectorAll('.weibo-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    const targetNavItem = document.querySelector(`.weibo-nav-item[data-view="${viewId}"]`);
    if (targetNavItem) {
        targetNavItem.classList.add('active');
    }

    // --- â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¾©ã€‘â–¼â–¼â–¼ ---
    // 4. æ ¹æ“šä½ é»æ“Šçš„é ç°½ï¼Œå»è¼‰å…¥ä¸¦é¡¯ç¤ºå°æ‡‰çš„å¾®åšå…§å®¹
    if (viewId === 'weibo-following-view') {
        // å¦‚æœæ˜¯â€œé—œæ³¨çš„äººâ€é ï¼Œå°±èª¿ç”¨æ¸²æŸ“é—œæ³¨æ¸…å–®çš„å‡½æ•¸
        await renderFollowingWeiboFeed();
    } else if (viewId === 'weibo-my-profile-view') {
        // å¦‚æœæ˜¯â€œæˆ‘çš„å¾®åšâ€é ï¼Œå°±èª¿ç”¨æ¸²æŸ“â€œæˆ‘â€çš„å¾®åšçš„å‡½æ•¸
        await renderMyWeiboFeed();
    }
    // --- â–²â–²â–²ã€ä¿®å¾©çµæŸã€‘â–²â–²â–² ---
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ åœ¨é€™è£¡é–‹å§‹è¤‡è£½ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ openQZonePublisher å‡½æ•¸ â–¼â–¼â–¼
async function openQZonePublisher(mode) {
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    modal.dataset.mode = mode;
    document.getElementById('create-post-modal-title').textContent = 'ç™¼ä½ˆå‹•æ…‹';

    if (mode === 'shuoshuo') {
        modal.querySelector('.post-mode-switcher').style.display = 'none';
        modal.querySelector('#image-mode-content').style.display = 'none';
        modal.querySelector('#text-image-mode-content').style.display = 'none';
        modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é®®äº‹...';
    } else {
        modal.querySelector('.post-mode-switcher').style.display = 'flex';
        modal.querySelector('#image-mode-content').classList.add('active');
        modal.querySelector('#text-image-mode-content').classList.remove('active');
        modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é®®äº‹...ï¼ˆéå¿…å¡«çš„å…¬é–‹æ–‡å­—ï¼‰';
    }

    document.getElementById('post-comments-toggle-group').style.display = 'block';
    
    // --- â–¼â–¼â–¼ ä»¥ä¸‹æ˜¯æœ¬æ¬¡æ–°å¢çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼ ---
    const visibilityGroup = document.getElementById('post-visibility-group');
    const groupsContainer = document.getElementById('post-visibility-groups');
    const visibilityRadios = document.querySelectorAll('input[name="visibility"]');

    visibilityGroup.style.display = 'block';
    groupsContainer.innerHTML = ''; // æ¸…ç©ºèˆŠçš„åˆ†çµ„åˆ—è¡¨
    
    // å¾è³‡æ–™åº«è®€å–ä½ çš„å¥½å‹åˆ†çµ„
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${group.id}"> ${group.name}`;
            groupsContainer.appendChild(label);
        });
    } else {
        groupsContainer.innerHTML = '<p style="color: #8a8a8a; font-size: 13px;">é‚„æ²’æœ‰å‰µå»ºä»»ä½•å¥½å‹åˆ†çµ„å“¦ã€‚</p>';
    }

    // é»˜èªé¸ä¸­â€œæ‰€æœ‰äººå¯è¦‹â€ä¸¦éš±è—åˆ†çµ„é¸æ“‡
    visibilityRadios[0].checked = true;
    groupsContainer.style.display = 'none';

    // ç›£è½é¸é …æŒ‰éˆ•çš„è®ŠåŒ–
    visibilityRadios.forEach(radio => {
        radio.onchange = function() {
            groupsContainer.style.display = this.value === 'groups' ? 'block' : 'none';
        };
    });
    // --- â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–² ---

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€è©•è«–å„ªåŒ–ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ generateWeiboComments å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€è©•è«–å„ªåŒ–ç‰ˆ V2ã€‘AIç”Ÿæˆå¾®åšè©•è«–çš„æ ¸å¿ƒå‡½æ•¸
 * @param {number} postId - éœ€è¦ç”Ÿæˆè©•è«–çš„å¾®åšID
 */
async function generateWeiboComments(postId) {
    const post = await db.weiboPosts.get(postId);
    if (!post) {
        alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é€™æ¢å¾®åšï¼");
        return;
    }

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨å¬å–šé«˜å“è³ªç¶²å‹...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return;
    }
    
    let authorPersona = "ä¸€å€‹æ™®é€šç”¨æˆ¶ã€‚";
    let authorProfession = "æœªè¨­å®š"; 
    const authorName = post.authorId === 'user' ? (state.qzoneSettings.weiboNickname || 'æˆ‘') : post.authorNickname;
    
    if (post.authorId === 'user') {
        authorPersona = state.qzoneSettings.weiboUserPersona || 'ä¸€å€‹æ™®é€šçš„å¾®åšç”¨æˆ¶ã€‚';
        authorProfession = state.qzoneSettings.weiboUserProfession || 'æœªè¨­å®š';
    } else {
        const authorChat = state.chats[post.authorId];
        if (authorChat) {
            authorPersona = authorChat.settings.aiPersona || 'ç„¡';
            authorProfession = authorChat.settings.weiboProfession || 'æœªè¨­å®š';
        }
    }
    const truncatedPersona = authorPersona.substring(0, 400);
    const postContent = (post.content || "").substring(0, 200);
    const existingComments = (post.comments || []).slice(-5).map(c => `${c.authorNickname}: ${c.commentText}`).join('\n');

    let imageContext = '';
    if (post.imageUrl && post.imageDescription) {
        imageContext = `
- **åœ–ç‰‡å…§å®¹**: é€™æ¢å¾®åšé…æœ‰ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼šâ€œ${post.imageDescription}â€`;
    } else if (post.postType === 'text_image' && post.hiddenContent) {
        imageContext = `
- **åœ–ç‰‡å…§å®¹**: é€™æ˜¯ä¸€å¼µæ–‡å­—åœ–ï¼Œä¸Šé¢çš„å…§å®¹æ˜¯ï¼šâ€œ${post.hiddenContent}â€`;
    }
    
    // â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹ï¼Œæ˜¯æˆ‘å€‘æ–°å¢çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼

    // 1. å‰µå»ºä¸€å€‹é›†åˆï¼Œç”¨ä¾†å­˜æ”¾è©•è«–å€å·²å‡ºç¾çš„ã€æœ‰äººè¨­çš„è§’è‰²è³‡è¨Š
    const commenterPersonas = new Map();

    // 2. å°‡å¾®åšä½œè€…æœ¬äººçš„äººè¨­å…ˆåŠ é€²å»
    commenterPersonas.set(authorName, `[è·æ¥­: ${authorProfession}] [äººè¨­: ${truncatedPersona}]`);

    // 3. éæ­·å·²æœ‰çš„è©•è«–ï¼ŒæŸ¥æ‰¾ä¸¦æ·»åŠ å…¶ä»–è§’è‰²çš„äººè¨­
    if (post.comments && post.comments.length > 0) {
        post.comments.forEach(comment => {
            const commenterName = comment.authorNickname;
            // å¦‚æœé€™å€‹äººè¨­é‚„æ²’è¢«è¨˜éŒ„é
            if (!commenterPersonas.has(commenterName)) {
                // æª¢æŸ¥é€™å€‹è©•è«–è€…æ˜¯ä¸æ˜¯ä¸€å€‹å·²çŸ¥çš„AIè§’è‰²
                const commenterChat = Object.values(state.chats).find(c => c.name === commenterName);
                if (commenterChat && !commenterChat.isGroup) {
                    // å¦‚æœæ˜¯ï¼Œå°±æŠŠä»–/å¥¹çš„äººè¨­å’Œè·æ¥­ä¹ŸåŠ åˆ°é›†åˆè£¡
                    const profession = commenterChat.settings.weiboProfession || 'æœªè¨­å®š';
                    const persona = (commenterChat.settings.aiPersona || 'ç„¡').substring(0, 200);
                    commenterPersonas.set(commenterName, `[è·æ¥­: ${profession}] [äººè¨­: ${persona}]`);
                }
            }
        });
    }
    
    // 4. å°‡æ”¶é›†åˆ°çš„äººè¨­è³‡è¨Šï¼Œæ ¼å¼åŒ–æˆçµ¦AIçœ‹çš„æ–‡æœ¬
    let commenterContext = '';
    if (commenterPersonas.size > 0) {
        commenterContext += '\n# è©•è«–å€å·²æœ‰è§’è‰²äººè¨­ (ä¾›ä½ å›å¾©æ™‚åƒè€ƒ)\n';
        commenterPersonas.forEach((persona, name) => {
            commenterContext += `- **${name}**: ${persona}\n`;
        });
    }

    // â–²â–²â–² æ–°å¢ä»£ç¢¼åˆ°æ­¤çµæŸ â–²â–²â–²

    const systemPrompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„â€œç¤¾äº¤åª’é«”æ¨¡æ“¬å™¨â€ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä¸€å€‹ç‰¹å®šè§’è‰²çš„â€œäººè¨­â€ï¼Œç‚ºä»–/å¥¹ç™¼ä½ˆçš„ä¸€æ¢å¾®åšç”Ÿæˆä¸€æ‰¹çœŸå¯¦çš„ã€ç¬¦åˆæƒ…æ™¯çš„ç¶²å‹è©•è«–ã€‚

# å¾®åšæƒ…æ™¯
- **ä½œè€…**: ${authorName}
- **å¾®åšæ–‡å­—**: ${postContent || "(è©²å¾®åšæ²’æœ‰é…æ–‡)"}
${imageContext}
- **å·²æœ‰è©•è«– (ä½ å¯ä»¥å›å¾©ä»–å€‘)**:
${existingComments || "(æš«ç„¡è©•è«–)"}

${commenterContext}

# ã€ã€ã€è©•è«–ç”Ÿæˆæ ¸å¿ƒè¦å‰‡ã€‘ã€‘ã€‘
1.  **ã€ã€ã€åš´ç¦ä½¿ç”¨ã€‘ã€‘ã€‘**: çµ•å°ç¦æ­¢ä½¿ç”¨ â€œè·¯äººç”²â€ã€â€œç¶²å‹Aâ€ã€â€œç²‰çµ²Bâ€ é€™é¡ä»£è™Ÿä½œç‚ºè©•è«–è€…æ˜µç¨±ã€‚
2.  **æ˜µç¨±å¤šæ¨£åŒ–**: è©•è«–è€…çš„æ˜µç¨±å¿…é ˆéå¸¸çœŸå¯¦ã€å¤šæ¨£åŒ–ä¸”ç¬¦åˆå¾®åšç”Ÿæ…‹ã€‚ä¾‹å¦‚ï¼šâ€œä»Šå¤©ä¹Ÿè¦æ—©ç¡â€ã€â€œå¯æ¨‚åŠ å†°å¡Šâ€ã€â€œæ˜¯å°ç‹ä¸æ˜¯å°å¼µâ€ã€â€œç†æ€§åƒç“œç¬¬ä¸€ç·šâ€ã€‚
3.  **å…§å®¹èˆ‡äººè¨­å¼·ç›¸é—œ**: è©•è«–å…§å®¹å¿…é ˆèˆ‡ã€å¾®åšå…§å®¹(åŒ…æ‹¬æ–‡å­—å’Œåœ–ç‰‡)ã€‘å’Œã€ä½œè€…ä»¥åŠè¢«å›å¾©è€…çš„äººè¨­ã€‘é«˜åº¦ç›¸é—œã€‚æ€è€ƒï¼šä»€éº¼æ¨£çš„ç²‰çµ²æœƒé—œæ³¨é€™æ¨£çš„äººï¼Ÿä»–å€‘æœƒæ€éº¼èªªè©±ï¼Ÿç•¶å›å¾©ä¸€å€‹æœ‰ç‰¹å®šäººè¨­çš„è§’è‰²æ™‚ï¼Œä½ çš„å›å¾©å¿…é ˆè€ƒæ…®åˆ°å°æ–¹çš„èº«ä»½ã€‚
4.  **é¢¨æ ¼å¤šæ¨£åŒ–**: ç”Ÿæˆçš„è©•è«–æ‡‰åŒ…å«ä¸åŒç«‹å ´å’Œé¢¨æ ¼ï¼Œä¾‹å¦‚ï¼š
    -   **ç²‰çµ²**: â€œå“¥å“¥å¤ªå¸¥äº†ï¼æ–°åŠ‡ä»€éº¼æ™‚å€™æ’­ï¼Ÿâ€
    -   **è·¯äºº**: â€œé€™å€‹åœ°æ–¹çœ‹èµ·ä¾†ä¸éŒ¯ï¼Œæ±‚ä½å€ï¼â€
    -   **é»‘ç²‰/è³ªç–‘è€…**: â€œå°±é€™ï¼Ÿæ„Ÿè¦ºpåœ–æœ‰é»éäº†å§...â€
    -   **ç©æ¢—**: â€œæ¨“ä¸Šæ˜¯ä¸æ˜¯XXæ´¾ä¾†çš„é–“è«œï¼ˆç‹—é ­ï¼‰â€
5.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€æ¢è©•è«–ã€‚
    -   ç™¼è¡¨æ–°è©•è«–, ä½¿ç”¨æ ¼å¼: \`{"author": "ä¸åƒé¦™èœçš„ä»™å¥³", "comment": "å“‡ï¼Œé€™å€‹å¥½å¥½çœ‹ï¼"}\`
    -   å›å¾©å·²æœ‰è©•è«–, ä½¿ç”¨æ ¼å¼: \`{"author": "æ„›åƒç“œçš„çŒ¹", "comment": "æˆ‘ä¹Ÿè¦ºå¾—ï¼", "replyTo": "ä¸åƒé¦™èœçš„ä»™å¥³"}\`

ç¾åœ¨ï¼Œè«‹é–‹å§‹ä½ çš„è¡¨æ¼”ã€‚
`;

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: 1.0, 
                    response_format: { type: "json_object" }
                })
            });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '').trim();
        
        const newComments = JSON.parse(aiResponseContent);

        if (Array.isArray(newComments) && newComments.length > 0) {
            const postToUpdate = await db.weiboPosts.get(post.id);
            if (!postToUpdate) throw new Error("åœ¨è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°è¦æ›´æ–°çš„å¸–å­ï¼");
            
            if (!postToUpdate.comments) postToUpdate.comments = [];
            
            newComments.forEach(comment => {
                if(comment.author && comment.comment) {
                    const newCommentObject = {
                        commentId: 'comment_' + Date.now() + Math.random(),
                        authorNickname: comment.author,
                        commentText: comment.comment,
                        timestamp: Date.now()
                    };
                    if (comment.replyTo) {
                        newCommentObject.replyToNickname = comment.replyTo;
                    }
                    postToUpdate.comments.push(newCommentObject);
                }
            });

            postToUpdate.baseLikesCount = (postToUpdate.baseLikesCount || 0) + Math.floor(Math.random() * newComments.length * 3 + 5);

            await db.weiboPosts.put(postToUpdate);
            
            await renderMyWeiboFeed();
            await renderFollowingWeiboFeed();
            
            alert(`æˆåŠŸç”Ÿæˆäº† ${newComments.length} æ¢æ–°è©•è«–ï¼`);
        } else {
             alert("AIæ²’æœ‰ç”Ÿæˆæœ‰æ•ˆçš„è©•è«–ã€‚");
        }

    } catch (error) {
        console.error("ç”Ÿæˆå¾®åšè©•è«–å¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™å€‹æ–°å‡½æ•¸é»è²¼åˆ° renderWeiboProfile å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘åˆªé™¤ä¸€æ¢å¾®åšè©•è«–
 * @param {number} postId - è©•è«–æ‰€åœ¨çš„å¾®åšID
 * @param {string} commentId - è¦åˆªé™¤çš„è©•è«–çš„ID
 */
async function deleteWeiboComment(postId, commentId) {
    const post = await db.weiboPosts.get(postId);
    if (!post || !post.comments) return;

    const commentIndex = post.comments.findIndex(c => c.commentId === commentId);
    if (commentIndex === -1) return;
    
    const commentText = post.comments[commentIndex].commentText;

    const confirmed = await showCustomConfirm(
        'åˆªé™¤è©•è«–', 
        `ç¢ºå®šè¦åˆªé™¤é€™æ¢è©•è«–å—ï¼Ÿ\n\nâ€œ${commentText.substring(0, 50)}...â€`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        post.comments.splice(commentIndex, 1);
        await db.weiboPosts.put(post);
        await renderMyWeiboFeed();
        await renderFollowingWeiboFeed();
        alert("è©•è«–å·²åˆªé™¤ã€‚");
    }
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„ã€æ­£ä¸Šæ–¹ã€‘ï¼Œé»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘ä¸€éµæ¸…ç©ºæ‰€æœ‰å–®äººèŠå¤©èƒŒæ™¯
 */
async function clearAllSingleChatBackgrounds() {
    // å½ˆå‡ºç¢ºèªæ¡†ï¼Œé˜²æ­¢èª¤æ“ä½œ
    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ“ä½œ', 
        'æ­¤æ“ä½œå°‡ç§»é™¤æ‰€æœ‰è§’è‰²å–®ç¨è¨­ç½®çš„èŠå¤©èƒŒæ™¯ï¼Œçµ±ä¸€ä½¿ç”¨å…¨åŸŸèƒŒæ™¯ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        let updatedCount = 0;
        const chatsToUpdate = [];

        // éæ­·æ‰€æœ‰èŠå¤©
        for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            // å¦‚æœé€™å€‹èŠå¤©è¨­ç½®äº†å–®äººèƒŒæ™¯
            if (chat.settings && chat.settings.background) {
                chat.settings.background = ''; // æ¸…ç©ºå®ƒ
                chatsToUpdate.push(chat);
                updatedCount++;
            }
        }

        // å¦‚æœæœ‰éœ€è¦æ›´æ–°çš„èŠå¤©ï¼Œå°±æ‰¹é‡å¯«å…¥è³‡æ–™åº«
        if (chatsToUpdate.length > 0) {
            await db.chats.bulkPut(chatsToUpdate);
        }
        
        await showCustomAlert('æ“ä½œæˆåŠŸ', `å·²æˆåŠŸæ¸…ç©º ${updatedCount} å€‹è§’è‰²çš„å–®äººèŠå¤©èƒŒæ™¯ï¼`);
    }
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€V2ä¿®æ­£ç‰ˆã€‘ä¸»è¢å¹•ç¾åŒ–é è¨­æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼ */

let activeHomePresetId = null; // ç”¨æ–¼è¿½è¹¤ç•¶å‰é¸ä¸­çš„é è¨­ID

/**
 * å•Ÿç”¨æˆ–ç¦ç”¨é è¨­ç®¡ç†æŒ‰éˆ•
 */
function toggleHomePresetButtons(isEnabled) {
    document.getElementById('apply-home-preset-btn').disabled = !isEnabled;
    document.getElementById('update-home-preset-btn').disabled = !isEnabled; // <-- æ–°å¢é€™ä¸€è¡Œ
    document.getElementById('rename-home-preset-btn').disabled = !isEnabled;
    document.getElementById('delete-home-preset-btn').disabled = !isEnabled;
    document.getElementById('export-home-preset-btn').disabled = !isEnabled;
}


/**
 * è¼‰å…¥é è¨­åˆ°ä¸‹æ‹‰æ¸…å–®
 */
async function loadHomeScreenPresetsToDropdown() {
    const selector = document.getElementById('home-preset-selector');
    selector.innerHTML = '<option value="">-- è«‹é¸æ“‡ä¸€å€‹é è¨­ --</option>';
    const presets = await db.homeScreenPresets.toArray();
    presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = preset.name;
        selector.appendChild(option);
    });
    activeHomePresetId = null; // é‡ç½®é¸æ“‡
    toggleHomePresetButtons(false); // é è¨­ç¦ç”¨æŒ‰éˆ•
}

/**
 * ã€æ–°ã€‘ç•¶ç”¨æˆ¶å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡ä¸€å€‹é è¨­æ™‚
 */
function handleHomePresetSelection() {
    const selector = document.getElementById('home-preset-selector');
    activeHomePresetId = selector.value ? parseInt(selector.value) : null;
    // åªæœ‰ç•¶ç”¨æˆ¶ç¢ºå¯¦é¸æ“‡äº†ä¸€å€‹é è¨­æ™‚ï¼Œæ‰å•Ÿç”¨ç›¸é—œæŒ‰éˆ•
    toggleHomePresetButtons(!!activeHomePresetId);
}

/**
 * ã€V2 ä¿®å¾©ç‰ˆã€‘æ‡‰ç”¨ç•¶å‰é¸ä¸­çš„é è¨­
 */
async function applySelectedHomeScreenPreset() {
    if (!activeHomePresetId) {
        alert("è«‹å…ˆå¾ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹è¦æ‡‰ç”¨çš„é è¨­ã€‚");
        return;
    }
    const preset = await db.homeScreenPresets.get(activeHomePresetId);
    if (preset && preset.data) {
        // å°‡é è¨­è³‡æ–™è¼‰å…¥åˆ°å…¨åŸŸç‹€æ…‹
        state.globalSettings.widgetData = preset.data;

        if (preset.data.wallpaper) {
            state.globalSettings.wallpaper = preset.data.wallpaper;
        }
        if (preset.data.appIcons) {
            state.globalSettings.appIcons = { ...preset.data.appIcons };
        }
        // â˜…â˜…â˜… æ–°å¢ï¼šè™•ç†é ­åƒæ¡†è³‡æ–™ â˜…â˜…â˜…
        if (typeof preset.data.homeAvatarFrame !== 'undefined') {
            state.globalSettings.homeAvatarFrame = preset.data.homeAvatarFrame;
        }

        // ä¿å­˜æ‰€æœ‰æ›´æ–°åˆ°è³‡æ–™åº«
        await db.globalSettings.put(state.globalSettings);
        
        // ä¾æ¬¡æ‡‰ç”¨æ‰€æœ‰è¨­ç½®
        applyGlobalWallpaper();
        applyAppIcons();
        applyAppLabels();
        applyWidgetData(); 
        renderHomeScreenProfileFrame(); // â˜…â˜…â˜… æ–°å¢ï¼šæ‡‰ç”¨é ­åƒæ¡† â˜…â˜…â˜…

        alert(`å·²æˆåŠŸæ‡‰ç”¨é è¨­: "${preset.name}"ï¼`);
        showScreen('home-screen');
    }
}
/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“ä¸»è¢å¹•å€‹äººè³‡æ–™å¡çš„é ­åƒæ¡†
 */
function renderHomeScreenProfileFrame() {
    // 1. ç²å–ä¿å­˜çš„é ­åƒæ¡†URL
    const frameUrl = state.globalSettings.homeAvatarFrame || '';
    // 2. æ‰¾åˆ°é ­åƒæ¡†çš„imgå…ƒç´ 
    const frameImg = document.getElementById('profile-avatar-frame');
    if (frameImg) {
        // 3. å¦‚æœURLå­˜åœ¨ï¼Œå°±é¡¯ç¤ºå®ƒ
        if (frameUrl) {
            frameImg.src = frameUrl;
            frameImg.style.display = 'block';
        } else {
            // 4. å¦‚æœURLç‚ºç©ºï¼ˆå³é¸æ“‡äº†â€œç„¡â€ï¼‰ï¼Œå°±éš±è—å®ƒ
            frameImg.src = '';
            frameImg.style.display = 'none';
        }
    }
}


/**
 * ã€V2 ä¿®å¾©ç‰ˆã€‘ä¿å­˜ç•¶å‰çš„ä¸»è¢å¹•è¨­ç½®ç‚ºä¸€å€‹æ–°çš„é è¨­
 */
async function saveCurrentHomeScreenAsPreset() {
    const presetName = await showCustomPrompt("ä¿å­˜é è¨­", "è«‹ç‚ºé€™å€‹ä¸»è¢å¹•ç¾åŒ–æ–¹æ¡ˆèµ·å€‹åå­—ï¼š");
    if (!presetName || !presetName.trim()) {
        if (presetName !== null) alert("åå­—ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }

    // æ ¸å¿ƒï¼šæ§‹å»ºä¸€å€‹åŒ…å«æ‰€æœ‰ä¸»è¢å¹•å…ƒç´ çš„å®Œæ•´è³‡æ–™ç‰©ä»¶
    const presetData = {
        // --- å€‹äººè³‡æ–™å¡ç‰‡ ---
        'profile-banner-img': document.getElementById('profile-banner-img').src,
        'profile-avatar-img': document.getElementById('profile-avatar-img').src,
        'homeAvatarFrame': document.getElementById('profile-avatar-frame').src, // â˜…â˜…â˜… æ–°å¢ï¼šä¿å­˜é ­åƒæ¡† â˜…â˜…â˜…
        'profile-username': document.getElementById('profile-username').textContent,
        'profile-sub-username': document.getElementById('profile-sub-username').textContent,
        'profile-bio': document.getElementById('profile-bio').textContent,
        'profile-location': document.getElementById('profile-location').innerHTML,

        // --- ç¬¬ä¸€é å°çµ„ä»¶ ---
        'widget-bubble-1': document.getElementById('widget-bubble-1').textContent,
        'widget-image-1': document.getElementById('widget-image-1').src,
        'widget-subtext-1': document.getElementById('widget-subtext-1').textContent,
        'widget-bubble-2': document.getElementById('widget-bubble-2').textContent,
        'widget-image-2': document.getElementById('widget-image-2').src,
        'widget-subtext-2': document.getElementById('widget-subtext-2').textContent,
        
        // --- ç¬¬äºŒé å°å…ƒä»¶ ---
        'widget-image-3': document.getElementById('widget-image-3').src,
        'second-page-bubble': document.getElementById('second-page-bubble').textContent,
        'flat-capsule-bubble': document.getElementById('flat-capsule-bubble').textContent,
        'circular-bubble': document.getElementById('circular-bubble').textContent,
        'widget-image-4': document.getElementById('widget-image-4').src,
        'avatar-subtitle': document.getElementById('avatar-subtitle').textContent,
        'bubble-top-left': document.getElementById('bubble-top-left').textContent,
        'bubble-top-right': document.getElementById('bubble-top-right').textContent,
        'bubble-bottom-left': document.getElementById('bubble-bottom-left').textContent,
        'bubble-bottom-right': document.getElementById('bubble-bottom-right').textContent,
        'new-widget-avatar': document.getElementById('new-widget-avatar').src,
        'new-widget-text-1': document.getElementById('new-widget-text-1').textContent,
        'new-widget-text-2': document.getElementById('new-widget-text-2').textContent,
        'new-widget-text-3': document.getElementById('new-widget-text-3').textContent,
        'widget-month-display': document.getElementById('widget-month-display').textContent,
        
        // --- Appåœ–ç¤ºå’Œå£ç´™ ---
        'appIcons': { ...state.globalSettings.appIcons },
        'appLabels': { ...state.globalSettings.appLabels },
        'wallpaper': state.globalSettings.wallpaper
    };

    // ä¿å­˜åˆ°è³‡æ–™åº«
    await db.homeScreenPresets.add({ name: presetName.trim(), data: presetData });
    await loadHomeScreenPresetsToDropdown(); // åˆ·æ–°ä¸‹æ‹‰æ¸…å–®
    alert(`é è¨­ "${presetName.trim()}" å·²ä¿å­˜ï¼`);
}

/**
 * ã€V2 ä¿®å¾©ç‰ˆã€‘æ›´æ–°ç•¶å‰é¸ä¸­çš„é è¨­
 */
async function updateSelectedHomeScreenPreset() {
    if (!activeHomePresetId) {
        alert("è«‹å…ˆé¸æ“‡ä¸€å€‹è¦æ›´æ–°çš„é è¨­ã€‚");
        return;
    }

    const currentPreset = await db.homeScreenPresets.get(activeHomePresetId);
    if (!currentPreset) return;

    const confirmed = await showCustomConfirm(
        "ç¢ºèªæ›´æ–°",
        `ç¢ºå®šè¦ç”¨ç•¶å‰çš„ä¸»è¢å¹•ä½ˆå±€è¦†è“‹é è¨­ "${currentPreset.name}" å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        // æ§‹å»ºèˆ‡ä¿å­˜æ™‚å®Œå…¨ç›¸åŒçš„å®Œæ•´è³‡æ–™ç‰©ä»¶
        const presetData = {
            'profile-banner-img': document.getElementById('profile-banner-img').src,
            'profile-avatar-img': document.getElementById('profile-avatar-img').src,
            'homeAvatarFrame': document.getElementById('profile-avatar-frame').src, // â˜…â˜…â˜… æ–°å¢ï¼šä¿å­˜é ­åƒæ¡† â˜…â˜…â˜…
            'profile-username': document.getElementById('profile-username').textContent,
            'profile-sub-username': document.getElementById('profile-sub-username').textContent,
            'profile-bio': document.getElementById('profile-bio').textContent,
            'profile-location': document.getElementById('profile-location').innerHTML,
            'widget-bubble-1': document.getElementById('widget-bubble-1').textContent,
            'widget-image-1': document.getElementById('widget-image-1').src,
            'widget-subtext-1': document.getElementById('widget-subtext-1').textContent,
            'widget-bubble-2': document.getElementById('widget-bubble-2').textContent,
            'widget-image-2': document.getElementById('widget-image-2').src,
            'widget-subtext-2': document.getElementById('widget-subtext-2').textContent,
            'widget-image-3': document.getElementById('widget-image-3').src,
            'second-page-bubble': document.getElementById('second-page-bubble').textContent,
            'flat-capsule-bubble': document.getElementById('flat-capsule-bubble').textContent,
            'circular-bubble': document.getElementById('circular-bubble').textContent,
            'widget-image-4': document.getElementById('widget-image-4').src,
            'avatar-subtitle': document.getElementById('avatar-subtitle').textContent,
            'bubble-top-left': document.getElementById('bubble-top-left').textContent,
            'bubble-top-right': document.getElementById('bubble-top-right').textContent,
            'bubble-bottom-left': document.getElementById('bubble-bottom-left').textContent,
            'bubble-bottom-right': document.getElementById('bubble-bottom-right').textContent,
            'new-widget-avatar': document.getElementById('new-widget-avatar').src,
            'new-widget-text-1': document.getElementById('new-widget-text-1').textContent,
            'new-widget-text-2': document.getElementById('new-widget-text-2').textContent,
            'new-widget-text-3': document.getElementById('new-widget-text-3').textContent,
            'widget-month-display': document.getElementById('widget-month-display').textContent,
            'appIcons': { ...state.globalSettings.appIcons },
            'wallpaper': state.globalSettings.wallpaper
        };

        await db.homeScreenPresets.update(activeHomePresetId, { data: presetData });
        await showCustomAlert('æˆåŠŸ', `é è¨­ "${currentPreset.name}" å·²æ›´æ–°ï¼`);
    }
}

/**
 * é‡å‘½åé¸ä¸­çš„é è¨­
 */
async function renameSelectedHomeScreenPreset() {
    if (!activeHomePresetId) return;
    const currentPreset = await db.homeScreenPresets.get(activeHomePresetId);
    const newName = await showCustomPrompt("é‡å‘½å", "è«‹è¼¸å…¥æ–°çš„åç¨±ï¼š", currentPreset.name);
    if (newName && newName.trim()) {
        await db.homeScreenPresets.update(activeHomePresetId, { name: newName.trim() });
        await loadHomeScreenPresetsToDropdown();
        document.getElementById('home-preset-selector').value = activeHomePresetId;
        alert("é‡å‘½åæˆåŠŸï¼");
    }
}

/**
 * åˆªé™¤é¸ä¸­çš„é è¨­
 */
async function deleteSelectedHomeScreenPreset() {
    if (!activeHomePresetId) return;
    const currentPreset = await db.homeScreenPresets.get(activeHomePresetId);
    const confirmed = await showCustomConfirm("ç¢ºèªåˆªé™¤", `ç¢ºå®šè¦åˆªé™¤é è¨­ "${currentPreset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.homeScreenPresets.delete(activeHomePresetId);
        await loadHomeScreenPresetsToDropdown(); // é€™æœƒè‡ªå‹•é‡ç½®é¸æ“‡ä¸¦ç¦ç”¨æŒ‰éˆ•
        alert("é è¨­å·²åˆªé™¤ã€‚");
    }
}

/**
 * ã€å…¨æ–°ã€‘åŒ¯å‡ºé¸ä¸­çš„é è¨­
 */
async function exportHomeScreenPreset() {
    if (!activeHomePresetId) return;
    const preset = await db.homeScreenPresets.get(activeHomePresetId);
    const blob = new Blob([JSON.stringify(preset, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${preset.name}-HomeScreen.json`;
    a.click();
    URL.revokeObjectURL(url);
}

/**
 * ã€å…¨æ–°ã€‘å°å…¥é è¨­æ–‡ä»¶
 */
function importHomeScreenPreset(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            // ç°¡å–®é©—è­‰ä¸€ä¸‹æª”å…§å®¹æ˜¯ä¸æ˜¯æˆ‘å€‘éœ€è¦çš„æ ¼å¼
            if (data.name && data.data) {
                await db.homeScreenPresets.add({ name: `${data.name} (å°å…¥)`, data: data.data });
                await loadHomeScreenPresetsToDropdown();
                alert(`é è¨­ "${data.name}" å°å…¥æˆåŠŸï¼`);
            } else {
                alert("å°å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚");
            }
        } catch (error) {
            alert(`å°å…¥å¤±æ•—ï¼šæª”è§£æéŒ¯èª¤ã€‚${error.message}`);
        }
    };
    reader.readAsText(file);
}
/* â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼ */

let currentWeiboActionTarget = {}; // ç”¨æ–¼å­˜å„²è¢«æ“ä½œçš„ç›®æ¨™è³‡è¨Š

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å…¨æ–°é‚è¼¯ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ openWeiboActionModal å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€V2 - AIè‡ªä¸»ç‰ˆã€‘æ‰“é–‹å¾®åšæ“ä½œæ¨¡æ…‹æ¡†
 * @param {object} targetInfo - åŒ…å«è¢«æ“ä½œè§’è‰²è³‡è¨Šçš„ç‰©ä»¶
 */
function openWeiboActionModal(targetInfo) {
    currentWeiboActionTarget = targetInfo; // ä¿å­˜ç›®æ¨™è³‡è¨Š
    const modal = document.getElementById('weibo-action-modal');
    
    // æ ¸å¿ƒä¿®æ”¹ï¼šæ¨™é¡Œç›´æ¥é¡¯ç¤ºç‚ºèª°è¡Œå‹•ï¼Œä¸å†æœ‰â€œæ“ä½œè€…â€
    document.getElementById('weibo-action-modal-title').textContent = `ç‚º "${targetInfo.name}" è§¸ç™¼è¡Œå‹•`;

    // æ ¸å¿ƒä¿®æ”¹ï¼šå¾¹åº•ç§»é™¤ä¸¦éš±è—â€œé¸æ“‡æ“ä½œè€…â€çš„ä¸‹æ‹‰æ¸…å–®
    const actorSelectGroup = document.getElementById('weibo-action-actor-select').parentElement;
    if (actorSelectGroup) {
        actorSelectGroup.style.display = 'none';
    }
    
    // æ¸…ç©ºä¸Šæ¬¡çš„è¼¸å…¥ä¸¦é‡ç½®é¸é …
    document.getElementById('weibo-action-prompt-input').value = '';
    document.querySelector('input[name="weibo_action_type"][value="post"]').checked = true;

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€AIæ ¸å¿ƒ V2.2 - è©•è«–ç”¨æˆ¶å¾®åšç‰ˆ + 500éŒ¯èª¤æœ€çµ‚ä¿®å¾©ã€‘åŸ·è¡ŒAIæ“ä½œï¼ˆç™¼å¾®åš/è©•è«–ï¼‰
 */
async function handleWeiboAiAction() {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return;
    }

    document.getElementById('weibo-action-modal').classList.remove('visible');
    document.getElementById('weibo-following-modal').classList.remove('visible');
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨è«‹æ±‚AIç”Ÿæˆå…§å®¹ï¼Œè«‹è€å¿ƒç­‰å¾…...");

    const actionType = document.querySelector('input[name="weibo_action_type"]:checked').value;
    const userInputPrompt = document.getElementById('weibo-action-prompt-input').value.trim();

    let target = { 
        id: currentWeiboActionTarget.id,
        name: currentWeiboActionTarget.name, 
        persona: 'ä¸€å€‹æ™®é€šçš„å¾®åšç”¨æˆ¶ã€‚',
        profession: '',
        instruction: ''
    };

    if (currentWeiboActionTarget.isNpc) {
        const owner = state.chats[currentWeiboActionTarget.ownerId];
        const npc = owner.npcLibrary.find(n => n.id === currentWeiboActionTarget.id);
        if (npc) {
            target.persona = npc.persona;
            target.profession = owner.settings.weiboProfession || '';
            target.instruction = owner.settings.weiboInstruction || '';
        }
    } else {
        const char = state.chats[currentWeiboActionTarget.id];
        if (char) {
            target.persona = char.settings.aiPersona;
            target.profession = char.settings.weiboProfession || '';
            target.instruction = char.settings.weiboInstruction || '';
        }
    }
    
    let systemPrompt = '';
    let messagesForApi = [];

    try {
        if (actionType === 'post') {
            systemPrompt = `
# ä»»å‹™: è§’è‰²æ‰®æ¼”èˆ‡å¾®åšå‰µä½œ
ä½ ç¾åœ¨ã€å°±æ˜¯ã€‘è§’è‰²â€œ${target.name}â€ã€‚
ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½ çš„èº«ä»½è³‡è¨Šï¼Œå‰µä½œä¸€æ¢å…¨æ–°çš„å¾®åšã€‚
# ä½ çš„èº«ä»½è³‡è¨Š
- **ä½ çš„åå­—**: ${target.name}
- **ä½ çš„è·æ¥­**: ${target.profession || 'æœªè¨­å®š'}
- **ä½ çš„äººè¨­**: ${target.persona}
- **ä½ çš„å¾®åšæŒ‡ä»¤ (å¿…é ˆéµå®ˆ)**: ${target.instruction || 'ç„¡'}
- **ç”¨æˆ¶çµ¦ä½ çš„æç¤º (å¯é¸åƒè€ƒ)**: ${userInputPrompt || 'ç„¡'}
# ã€ã€ã€è©•è«–ç”Ÿæˆæ ¸å¿ƒè¦å‰‡ã€‘ã€‘ã€‘
1.  **ã€ã€ã€åš´ç¦ä½¿ç”¨ã€‘ã€‘ã€‘**: çµ•å°ç¦æ­¢ä½¿ç”¨ â€œè·¯äººç”²â€ã€â€œç¶²å‹Aâ€ã€â€œç²‰çµ²Bâ€ é€™é¡ä»£è™Ÿä½œç‚ºè©•è«–è€…æ˜µç¨±ã€‚
2.  **æ˜µç¨±å¤šæ¨£åŒ–**: è©•è«–è€…çš„æ˜µç¨±å¿…é ˆéå¸¸çœŸå¯¦ã€å¤šæ¨£åŒ–ä¸”ç¬¦åˆå¾®åšç”Ÿæ…‹ã€‚ä¾‹å¦‚ï¼šâ€œä»Šå¤©ä¹Ÿè¦æ—©ç¡â€ã€â€œå¯æ¨‚åŠ å†°å¡Šâ€ã€â€œæ˜¯å°ç‹ä¸æ˜¯å°å¼µâ€ã€â€œç†æ€§åƒç“œç¬¬ä¸€ç·šâ€ã€‚
3.  **å…§å®¹èˆ‡äººè¨­å¼·ç›¸é—œ**: è©•è«–å…§å®¹å¿…é ˆèˆ‡ã€ä½ å³å°‡å‰µä½œçš„å¾®åšå…§å®¹ã€‘å’Œã€ä½ è‡ªå·±çš„äººè¨­ã€‘é«˜åº¦ç›¸é—œã€‚
4.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹:
   \`{"content": "å¾®åšæ­£æ–‡å…§å®¹...", "baseLikesCount": éš¨æ©Ÿç”Ÿæˆçš„é»è´Šæ•¸, "baseCommentsCount": éš¨æ©Ÿç”Ÿæˆçš„è©•è«–æ•¸, "comments": "ä»Šå¤©ä¹Ÿè¦æ—©ç¡: è©•è«–1...\\nå¯æ¨‚åŠ å†°å¡Š: è©•è«–2..."}\`
   - é»è´Šå’Œè©•è«–æ•¸è¦ç¬¦åˆä½ çš„èº«ä»½åœ°ä½ã€‚
   - "comments"æ¬„ä½æ˜¯ä¸€å€‹ã€å­—ä¸²ã€‘ï¼Œè£¡é¢åŒ…å«5-10æ¢çœŸå¯¦æ„Ÿçš„è·¯äººè©•è«–ï¼Œæ¯æ¢è©•è«–ç”¨åˆ†è¡Œç¬¦è™Ÿ'\\n'åˆ†éš”ã€‚
`;
            messagesForApi.push({ role: 'user', content: systemPrompt });

        } else {
            let targetPost;
            let taskDescription;
            let extraContext = ''; 

            if (actionType === 'comment_plaza') {
                targetPost = await db.weiboPosts.orderBy('timestamp').last();
                if (!targetPost) throw new Error("å»£å ´ä¸Šé‚„æ²’æœ‰ä»»ä½•å¾®åšå¯ä»¥è©•è«–ï¼");
                taskDescription = `ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½ çš„èº«ä»½è³‡è¨Šï¼Œå»è©•è«–ä¸‹é¢é€™æ¢æœ€æ–°çš„ã€å»£å ´å¾®åšã€‘ã€‚`;
            } else if (actionType === 'comment_user') {
                targetPost = await db.weiboPosts.where('authorId').equals('user').reverse().first();
                if (!targetPost) throw new Error("ç”¨æˆ¶é‚„æ²’æœ‰ç™¼ä½ˆä»»ä½•å¾®åšï¼Œç„¡æ³•è©•è«–ï¼");
                taskDescription = `ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½ çš„èº«ä»½è³‡è¨Šï¼Œå»è©•è«–ä¸‹é¢é€™æ¢ç”±ã€ç”¨æˆ¶ã€‘ç™¼ä½ˆçš„æœ€æ–°å¾®åšã€‚`;
            }

            let postAuthorName = targetPost.authorNickname;
            if (postAuthorName === '{{user}}') {
                postAuthorName = 'æˆ‘';
            }
            
            systemPrompt = `
# ä»»å‹™: è§’è‰²æ‰®æ¼”èˆ‡å¾®åšè©•è«–
ä½ ç¾åœ¨ã€å°±æ˜¯ã€‘è§’è‰²â€œ${target.name}â€ã€‚
${taskDescription}
# ä½ çš„èº«ä»½è³‡è¨Š
- **ä½ çš„åå­—**: ${target.name}
- **ä½ çš„è·æ¥­**: ${target.profession || 'æœªè¨­å®š'}
- **ä½ çš„äººè¨­**: ${target.persona}
- **ä½ çš„å¾®åšæŒ‡ä»¤ (å¿…é ˆéµå®ˆ)**: ${target.instruction || 'ç„¡'}
- **ç”¨æˆ¶çµ¦ä½ çš„æç¤º (å¯é¸åƒè€ƒ)**: ${userInputPrompt || 'ç„¡'}
# è¢«è©•è«–çš„å¾®åš
- ä½œè€…: ${postAuthorName}
- å…§å®¹: ${targetPost.content}
${extraContext}
# æ ¸å¿ƒè¦å‰‡
1. **æ·±åº¦æ‰®æ¼”**: ä½ çš„è©•è«–ã€å¿…é ˆã€‘å®Œå…¨ç¬¦åˆä½ çš„è·æ¥­ã€äººè¨­å’Œå¾®åšæŒ‡ä»¤ã€‚
2. **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹:
   \`{"commentText": "ä½ çš„è©•è«–å…§å®¹..."}\`
`;
            messagesForApi.push({ role: 'user', content: systemPrompt });
        }

        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);

        const response = await fetch(isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`, isGemini ? geminiConfig.data : {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({
                model: model,
                messages: messagesForApi,
                temperature: 1.0
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šæˆ‘å€‘æŠŠä¸‹é¢é€™è¡Œå°è‡´éŒ¯èª¤çš„ `response_format` å¾¹åº•åˆªæ‰äº†ï¼â–¼â–¼â–¼
            })
        });

        if (!response.ok) {
            let errorBody = '';
            try {
                errorBody = await response.text();
            } catch (e) {
                errorBody = 'ç„¡æ³•è®€å–éŒ¯èª¤å›æ‡‰é«”ã€‚';
            }
            throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${errorBody}`);
        }

        const data = await response.json();
        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„å®‰å…¨æª¢æŸ¥ä»£ç¢¼ â–¼â–¼â–¼
if (data.error) {
    // å¦‚æœAPIè¿”å›çš„è³‡æ–™ä¸­ç›´æ¥åŒ…å«äº† error ç‰©ä»¶ï¼Œèªªæ˜è«‹æ±‚å‡ºéŒ¯äº†
    // æˆ‘å€‘ä¸»å‹•æ‹‹å‡ºä¸€å€‹åŒ…å«è©³ç´°éŒ¯èª¤è³‡è¨Šçš„Error
    throw new Error(`APIè¿”å›éŒ¯èª¤: ${data.error.message || JSON.stringify(data.error)}`);
}
// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '').trim();
        
        const result = JSON.parse(aiResponseContent);

        if (actionType === 'post') {
            const newPost = {
                authorId: target.id,
                authorType: currentWeiboActionTarget.isNpc ? 'npc' : 'char',
                authorNickname: target.name,
                authorAvatar: currentWeiboActionTarget.isNpc 
                    ? (state.chats[currentWeiboActionTarget.ownerId].npcLibrary.find(n => n.id === target.id).avatar || defaultGroupMemberAvatar)
                    : (state.chats[target.id].settings.aiAvatar || defaultAvatar),
                content: result.content,
                timestamp: Date.now(),
                likes: [], comments: [],
                baseLikesCount: result.baseLikesCount || 0,
                baseCommentsCount: result.baseCommentsCount || 0
            };
            if(result.comments) {
                newPost.comments = result.comments.split('\n').map(c => {
                    const parts = c.split(/[:ï¼š]/);
                    const commenter = parts.shift() || 'è·¯äºº';
                    const commentText = parts.join(':').trim();
                    return { commentId: 'comment_' + Date.now() + Math.random(), authorNickname: commenter, commentText: commentText };
                }).filter(c => c.commentText);
            }
            await db.weiboPosts.add(newPost);
        } else {
            let postToUpdate;
            if (actionType === 'comment_plaza') {
                postToUpdate = await db.weiboPosts.orderBy('timestamp').last();
            } else {
                postToUpdate = await db.weiboPosts.where('authorId').equals('user').reverse().first();
            }

            if (postToUpdate) {
                if (!postToUpdate.comments) postToUpdate.comments = [];
                postToUpdate.comments.push({
                    commentId: 'comment_' + Date.now(),
                    authorId: target.id,
                    authorNickname: target.name,
                    commentText: result.commentText,
                    timestamp: Date.now()
                });
                await db.weiboPosts.put(postToUpdate);
            }
        }
        
        await renderMyWeiboFeed();
        await renderFollowingWeiboFeed();
        await showCustomAlert("æ“ä½œæˆåŠŸ", `â€œ${target.name}â€å·²æˆåŠŸåŸ·è¡Œæ“ä½œï¼`);

    } catch (error) {
        console.error("å¾®åšAIæ“ä½œå¤±æ•—:", error);
        await showCustomAlert('æ“ä½œå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n${error.message}`);
    }
}
// â–¼â–¼â–¼ ç¬¬2æ­¥ ç¬¬4è™•ä¿®æ”¹ï¼ˆæ–°å¢JSåŠŸèƒ½å‡½æ•¸ï¼‰ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘è§’è‰²è¡¨æƒ…åŒ…ç®¡ç†æ ¸å¿ƒåŠŸèƒ½
 */
async function openCharStickerManager() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
        // ã€ä¿®æ”¹ã€‘æ ¹æ“šèŠå¤©é¡å‹é¡¯ç¤ºä¸åŒçš„æ¨™é¡Œ
    if (chat.isGroup) {
        document.getElementById('sticker-manager-title').textContent = `â€œ${chat.name}â€çš„ç¾¤è¡¨æƒ…`;
    } else {
        document.getElementById('sticker-manager-title').textContent = `â€œ${chat.name}â€çš„è¡¨æƒ…åŒ…`;
    }


    // é è¨­é¡¯ç¤ºå°ˆå±¬è¡¨æƒ…
    document.getElementById('sticker-tab-exclusive').click();
    
    await renderCharStickers('exclusive');
    await renderCharStickers('common');
    
    showScreen('char-sticker-manager-screen');
}

// â–¼â–¼â–¼ ã€ä¿®å¾©ä¸¦å„ªåŒ–ã€‘è«‹ç”¨ä¸‹é¢é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰èˆŠçš„ renderCharStickers, bulkAddCharStickers, uploadCharStickersLocal ä¸‰å€‹å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å·²ä¿®å¾©ã€‘æ¸²æŸ“æŒ‡å®šé¡å‹çš„è§’è‰²è¡¨æƒ…åŒ…
 */
async function renderCharStickers(type) {
    const isExclusive = type === 'exclusive';
    const gridId = isExclusive ? 'exclusive-sticker-grid' : 'common-sticker-grid';
    const grid = document.getElementById(gridId);
    grid.innerHTML = '';

    let stickers = [];
    if (isExclusive) {
        const chat = state.chats[state.activeChatId];
        stickers = chat.settings.stickerLibrary || [];
    } else {
        // ã€æ ¸å¿ƒä¿®å¾©ã€‘ç¢ºä¿æˆ‘å€‘ç¸½æ˜¯å¾æœ€æ–°çš„è³‡æ–™åº«ç‹€æ…‹è®€å–é€šç”¨è¡¨æƒ…
        state.charStickers = await db.charStickers.toArray();
        stickers = state.charStickers || [];
    }

    if (stickers.length === 0) {
        grid.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">é€™è£¡é‚„æ˜¯ç©ºçš„å“¦~</p>`;
        return;
    }

    // ç‚ºäº†èƒ½æ­£ç¢ºåˆªé™¤ï¼Œæˆ‘å€‘éœ€è¦å€’åºéæ­·ä¾†ç²å–æ­£ç¢ºçš„ç´¢å¼•
    const stickersWithIndex = stickers.map((sticker, index) => ({ ...sticker, originalIndex: index }));

    stickersWithIndex.forEach((sticker) => {
        const item = document.createElement('div');
        item.className = 'sticker-item';
        item.style.backgroundImage = `url(${sticker.url})`;
        item.title = sticker.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block';
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆªé™¤è¡¨æƒ…', `ç¢ºå®šè¦åˆªé™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                if (isExclusive) {
                    const chat = state.chats[state.activeChatId];
                    chat.settings.stickerLibrary.splice(sticker.originalIndex, 1);
                    await db.chats.put(chat);
                } else {
                    await db.charStickers.delete(sticker.id);
                    // åˆªé™¤å¾Œï¼Œæˆ‘å€‘ç›´æ¥é‡æ–°æ¸²æŸ“ï¼Œè€Œä¸æ˜¯æ“ä½œstateï¼Œé€™æ¨£æœ€å®‰å…¨
                }
                await renderCharStickers(type); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}

/**
 * ã€å·²ä¿®å¾©+å„ªåŒ–ã€‘æ‰¹é‡æ·»åŠ è¡¨æƒ…åŒ…åˆ°æŒ‡å®šåº«
 */
async function bulkAddCharStickers(type) {
    const textInput = await showCustomPrompt(
        `æ‰¹é‡æ·»åŠ ${type === 'exclusive' ? 'å°ˆå±¬' : 'é€šç”¨'}è¡¨æƒ…`,
        "ä¸€è¡Œä¸€å€‹ï¼Œæ ¼å¼ï¼š\nè²“è²“å–æ°´ https://..../cat.gif",
        "", 'textarea'
    );
    if (!textInput || !textInput.trim()) return;

    const lines = textInput.trim().split('\n');
    const newStickers = [];
    let successCount = 0;

    lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return;

        // ã€å„ªåŒ–ã€‘ä½¿ç”¨æ›´æ™ºæ…§ã€æ›´å¥å£¯çš„åˆ†å‰²é‚è¼¯
        let name = '';
        let url = '';
        let splitIndex = -1;
        const httpIndex = line.indexOf('http');
        const dataIndex = line.indexOf('data:image');
        if (httpIndex > -1) { splitIndex = httpIndex; }
        else if (dataIndex > -1) { splitIndex = dataIndex; }

        if (splitIndex > 0) {
            name = line.substring(0, splitIndex).trim();
            url = line.substring(splitIndex).trim();
            if (name.endsWith(':') || name.endsWith('ï¼š')) {
                name = name.slice(0, -1).trim();
            }
        }

        if (name && (url.startsWith('http') || url.startsWith('data:image'))) {
            const stickerData = { url, name };
            if (type !== 'exclusive') {
                stickerData.id = 'char_sticker_' + (Date.now() + index);
            }
            newStickers.push(stickerData);
            successCount++;
        }
    });

    if (newStickers.length > 0) {
        if (type === 'exclusive') {
            const chat = state.chats[state.activeChatId];
            chat.settings.stickerLibrary.push(...newStickers);
            await db.chats.put(chat);
        } else {
            await db.charStickers.bulkAdd(newStickers);
        }
        await renderCharStickers(type); // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨è³‡æ–™åº«æ“ä½œå¾Œï¼Œçµ±ä¸€é‡æ–°æ¸²æŸ“
    }
    await showCustomAlert("å°å…¥å ±å‘Š", `æˆåŠŸå°å…¥ï¼š${successCount} å€‹è¡¨æƒ…ã€‚`);
}

/**
 * ã€å·²ä¿®å¾©ã€‘å¾æœ¬åœ°ä¸Šå‚³è¡¨æƒ…åˆ°æŒ‡å®šåº«
 */
async function uploadCharStickersLocal(type) {
    const input = document.getElementById('char-sticker-upload-input'); // æ‡‰è©²é•·é€™æ¨£
    input.onchange = async (event) => {
        const files = event.target.files;
        if (!files.length) return;

        const stickersToAdd = []; // å…ˆæ”¶é›†æ‰€æœ‰è¦æ·»åŠ çš„è¡¨æƒ…

        for (const file of files) {
            const name = await showCustomPrompt("ç‚ºè¡¨æƒ…å‘½å", "è«‹è¼¸å…¥è¡¨æƒ…åç¨±", file.name.replace(/\.[^/.]+$/, ""));
            if (name && name.trim()) {
                const base64Url = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
                
                const stickerData = { name: name.trim(), url: base64Url };
                if (type !== 'exclusive') {
                    stickerData.id = 'char_sticker_' + Date.now() + Math.random();
                }
                stickersToAdd.push(stickerData);
            }
        }

        if (stickersToAdd.length > 0) {
            if (type === 'exclusive') {
                const chat = state.chats[state.activeChatId];
                chat.settings.stickerLibrary.push(...stickersToAdd);
                await db.chats.put(chat);
            } else {
                await db.charStickers.bulkAdd(stickersToAdd);
            }
            await renderCharStickers(type); // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨è³‡æ–™åº«æ“ä½œå¾Œï¼Œçµ±ä¸€é‡æ–°æ¸²æŸ“
            alert(`å·²æˆåŠŸä¸Šå‚³ ${stickersToAdd.length} å€‹è¡¨æƒ…ï¼`);
        }
        
        event.target.value = null;
    };
    input.click();
}

// â–²â–²â–² ä¿®å¾©ä»£ç¢¼å¡ŠçµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ç¬¬1æ­¥ï¼šåœ¨é€™è£¡é»è²¼ä¸‹é¢é€™å€‹ã€æ–°å‡½æ•¸ã€‘ â–¼â–¼â–¼

/**
 * ã€æ–°å¢ã€‘é¡¯ç¤ºæŒ‡å®šçš„è§’è‰²è¡¨æƒ…åŒ…æ¨™ç±¤é 
 * é€™æ˜¯ä¹‹å‰ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç”¨æ–¼æ§åˆ¶é¡¯ç¤ºå“ªå€‹æ¨™ç±¤é ï¼ˆå°ˆå±¬æˆ–é€šç”¨ï¼‰ã€‚
 * @param {'exclusive' | 'common'} type - è¦é¡¯ç¤ºçš„æ¨™ç±¤é é¡å‹
 */
function showCharStickerTab(type) {
    // 1. åˆ‡æ›æ¨™ç±¤æŒ‰éˆ•çš„ 'active' ç‹€æ…‹
    document.querySelectorAll('.char-sticker-tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });

    // 2. åˆ‡æ›å…§å®¹å€åŸŸçš„é¡¯ç¤º
    document.querySelectorAll('.sticker-tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `${type}-sticker-content`);
    });

    // 3. æ¸²æŸ“å°æ‡‰æ¨™ç±¤é çš„è¡¨æƒ…
    // (é€™ä¸€æ­¥ç¢ºä¿æ¯æ¬¡åˆ‡æ›æ¨™ç±¤æ™‚ï¼Œè¡¨æƒ…éƒ½æœƒåˆ·æ–°)
    renderCharStickers(type);
}

// â–²â–²â–² JavaScriptæ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// é€™è£¡æ‡‰è©²æ˜¯ä½ å·²æœ‰çš„å…¶ä»–å‡½æ•¸ï¼Œæ¯”å¦‚ renderCharStickers, bulkAddCharStickers ç­‰...
// â–¼â–¼â–¼ ã€å…¨æ–° | ä¿®å¾©ç‰ˆã€‘é€™è£¡æ˜¯æ‰€æœ‰è«–å£‡/å°çµ„åŠŸèƒ½çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼

let activeGroupId = null; // è¨˜éŒ„ç•¶å‰æ‰“é–‹çš„å°çµ„ID
let activeForumPostId = null; // è¨˜éŒ„ç•¶å‰æ‰“é–‹çš„å¸–å­ID

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²æ·»åŠ å¤¢è§’å°çµ„ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ initializeDefaultGroups å‡½æ•¸ â–¼â–¼â–¼

/**
 * åˆå§‹åŒ–é»˜èªçš„å°çµ„
 */
async function initializeDefaultGroups() {
    const groupCount = await db.forumGroups.count();
    if (groupCount === 0) {
        const defaultGroups = [
            { name: 'å¨›æ¨‚å°çµ„', description: 'åˆ†äº«å…«å¦å’Œå¿«æ¨‚', icon: 'ğŸ¿' },
            { name: 'éˆç•°å°çµ„', description: 'åˆ†äº«ä½ çš„éˆç•°ç¶“æ­·', icon: 'ğŸ‘»' },
            { name: 'ä»Šå¤©æˆ‘crushäº†å—', description: 'è¨˜éŒ„å¿ƒå‹•ç¬é–“', icon: 'ğŸ’–' },
            { name: 'è«‹å¹«æˆ‘é¸æ“‡å°çµ„', description: 'é¸æ“‡å›°é›£ç—‡æ‚£è€…äº’åŠ©', icon: 'ğŸ¤”' },
            { name: 'åŒäººæ–‡å°çµ„', description: 'ç‚ºæ„›ç™¼é›»ï¼Œå‰µä½œæ•…äº‹', icon: 'âœï¸' },
            // â–¼â–¼â–¼ å°±æ˜¯æ–°å¢äº†ä¸‹é¢é€™ä¸€è¡Œï¼ â–¼â–¼â–¼
            { name: 'å¤¢è§’å°çµ„', description: 'Charå€‘åˆ†äº«é—œæ–¼userçš„å¤¢å¢ƒ', icon: 'ğŸŒ™' }
        ];
        await db.forumGroups.bulkAdd(defaultGroups);
        console.log("å·²æˆåŠŸå‰µå»ºé»˜èªå°çµ„ï¼ˆåŒ…å«å¤¢è§’å°çµ„ï¼‰ã€‚");
    }
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * æ¸²æŸ“è«–å£‡ä¸»è¢å¹•ï¼Œé¡¯ç¤ºæ‰€æœ‰å°çµ„åŠå…¶åˆ†é¡ï¼ˆå·²æ”¯æŒç¯©é¸ï¼‰
 */
async function renderForumScreen() {
    const listEl = document.getElementById('forum-group-list');
    const allGroups = await db.forumGroups.toArray();
    listEl.innerHTML = '';

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘ç¯©é¸é‚è¼¯ â–¼â–¼â–¼ ---
    const globalFilters = activeForumFilters.global;
    let groupsToRender = allGroups;

    if (globalFilters && globalFilters.length > 0) {
        groupsToRender = allGroups.filter(group => 
            group.categories && group.categories.some(cat => globalFilters.includes(cat))
        );
    }
    // --- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² ---

    // æª¢æŸ¥ç¯©é¸å¾Œæ˜¯å¦é‚„æœ‰å…§å®¹
    if (groupsToRender.length === 0) {
        const message = globalFilters.length > 0 
            ? 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆç¯©é¸æ¢ä»¶çš„å°çµ„å“¦' 
            : 'é‚„æ²’æœ‰ä»»ä½•å°çµ„ï¼Œé»æ“Šå³ä¸Šè§’â€œ+â€å‰µå»ºä¸€å€‹å§ï¼';
        listEl.innerHTML = `<p style="text-align:center; color: #8a8a8a; padding: 50px 0;">${message}</p>`;
        return;
    }

    // ä½¿ç”¨ç¯©é¸å¾Œçš„ groupsToRender é™£åˆ—é€²è¡Œæ¸²æŸ“
    groupsToRender.forEach(group => {
        const item = document.createElement('div');
        item.className = 'forum-group-item';

        let categoriesHtml = '';
        if (group.categories && group.categories.length > 0) {
            categoriesHtml = `
                <div class="category-tag-container">
                    ${group.categories.map(cat => `<span class="category-tag">#${cat}</span>`).join('')}
                </div>
            `;
        }

        item.innerHTML = `
            <div class="forum-group-icon">${group.icon || 'ğŸ“'}</div>
            <div class="forum-group-name">${group.name}</div>
            <div class="forum-group-desc">${group.description}</div>
            ${categoriesHtml}
        `;
        item.addEventListener('click', () => openGroup(group.id, group.name));
        addLongPressListener(item, () => showGroupActions(group.id, group.name));
        listEl.appendChild(item);
    });
    
    // æ›´æ–°ç¯©é¸æŒ‰éˆ•ç‹€æ…‹
    const filterBtn = document.getElementById('forum-filter-btn');
    if (filterBtn) {
        filterBtn.classList.toggle('active', globalFilters && globalFilters.length > 0);
    }
}


/**
 * ã€å…¨æ–°ã€‘é•·æŒ‰å°çµ„æ™‚é¡¯ç¤ºæ“ä½œåŠŸèƒ½è¡¨ï¼ˆç·¨è¼¯æˆ–åˆªé™¤ï¼‰
 * @param {number} groupId - å°çµ„çš„ID
 * @param {string} groupName - å°çµ„çš„åç¨±
 */
async function showGroupActions(groupId, groupName) {
    // èª¿ç”¨ä½ ç¾æœ‰çš„å½ˆçª—å‡½æ•¸ï¼Œé¡¯ç¤ºå…©å€‹é¸é …
    const choice = await showChoiceModal(`æ“ä½œå°çµ„ "${groupName}"`, [
        { text: 'âœï¸ ç·¨è¼¯å°çµ„è³‡è¨Š', value: 'edit' },
        { text: 'ğŸ—‘ï¸ åˆªé™¤å°çµ„', value: 'delete' }
    ]);

    // æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡ï¼ŒåŸ·è¡Œä¸åŒçš„æ“ä½œ
    if (choice === 'edit') {
        // å¦‚æœç”¨æˆ¶é¸æ“‡â€œç·¨è¼¯â€ï¼Œå°±èª¿ç”¨ä½ åŸä¾†çš„ç·¨è¼¯å‡½æ•¸
        openGroupEditor(groupId);
    } else if (choice === 'delete') {
        // å¦‚æœç”¨æˆ¶é¸æ“‡â€œåˆªé™¤â€ï¼Œå°±èª¿ç”¨ä½ åŸä¾†çš„åˆªé™¤å‡½æ•¸
        deleteGroupAndPosts(groupId);
    }
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ç§»é™¤è‡ªå‹•ç”Ÿæˆé‚è¼¯ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ openGroup å‡½æ•¸ â–¼â–¼â–¼
async function openGroup(groupId, groupName) {
    activeGroupId = groupId;
    document.getElementById('group-screen-title').textContent = groupName;
    const fanficBar = document.getElementById('fanfic-preference-bar');
    
    // æ ¹æ“šå°çµ„åé¡¯ç¤ºæˆ–éš±è—ç‰¹å®šUI
    if (groupName === 'åŒäººæ–‡å°çµ„') {
        fanficBar.style.display = 'block';
        await populateFanficSelectors();
    } else {
        fanficBar.style.display = 'none';
    }
    await renderGroupPosts(groupId);
    showScreen('group-screen');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * æ¸²æŸ“å°çµ„å…§çš„å¸–å­åˆ—è¡¨åŠå…¶åˆ†é¡ï¼ˆå·²æ”¯æŒç¯©é¸ï¼‰
 */
async function renderGroupPosts(groupId) {
    const listEl = document.getElementById('group-post-list');
    const allPosts = await db.forumPosts.where('groupId').equals(groupId).reverse().sortBy('timestamp');
    listEl.innerHTML = '';

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘ç¯©é¸é‚è¼¯ â–¼â–¼â–¼ ---
    const groupFilters = activeForumFilters.group[groupId];
    let postsToRender = allPosts;

    if (groupFilters && groupFilters.length > 0) {
        postsToRender = allPosts.filter(post => 
            post.categories && post.categories.some(cat => groupFilters.includes(cat))
        );
    }
    // --- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² ---

    if (postsToRender.length === 0) {
        const message = groupFilters && groupFilters.length > 0 
            ? 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆç¯©é¸æ¢ä»¶çš„å¸–å­å“¦' 
            : 'é€™å€‹å°çµ„é‚„æ²’æœ‰å¸–å­å“¦';
        listEl.innerHTML = `<p style="text-align:center; color: #8a8a8a; padding: 50px 0;">${message}</p>`;
        return;
    }

    for (const post of postsToRender) {
        const commentCount = await db.forumComments.where('postId').equals(post.id).count();
        const item = document.createElement('div');
        item.className = 'forum-post-item';
        item.dataset.postId = post.id;
        
        let categoriesHtml = '';
        if (post.categories && post.categories.length > 0) {
            categoriesHtml = `
                <div class="category-tag-container">
                    ${post.categories.map(cat => `<span class="category-tag">#${cat}</span>`).join('')}
                </div>
            `;
        }

        item.innerHTML = `
            <div class="post-item-title">${post.title}</div>
            ${categoriesHtml}
            <div class="post-item-meta">
                <span>ä½œè€…: ${post.author}</span>
                <span>è©•è«–: ${commentCount}</span>
            </div>
            <button class="forum-post-delete-btn" title="åˆªé™¤å¸–å­">Ã—</button>
        `;
        listEl.appendChild(item);
    }

    // æ›´æ–°ç¯©é¸æŒ‰éˆ•ç‹€æ…‹
    const filterBtn = document.getElementById('group-filter-btn');
    if (filterBtn) {
        filterBtn.classList.toggle('active', groupFilters && groupFilters.length > 0);
    }
}


/**
 * ã€é—œéµä¿®å¾©ã€‘æ‰“é–‹ä¸€å€‹å¸–å­ï¼Œé¡¯ç¤ºè©³æƒ…å’Œè©•è«–
 */
async function openPost(postId) {
    activeForumPostId = postId;
    await renderPostDetails(postId);
    showScreen('post-screen');
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ renderPostDetails å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘æ¸²æŸ“å¸–å­è©³æƒ…å’Œè©•è«– (å·²åŠ å…¥é ­åƒå’Œæ¨“å±¤)
 */
async function renderPostDetails(postId) {
    const contentEl = document.getElementById('post-detail-content');
    const post = await db.forumPosts.get(postId);
    const comments = await db.forumComments.where('postId').equals(postId).sortBy('timestamp');

    if (!post) {
        contentEl.innerHTML = '<p>å¸–å­ä¸å­˜åœ¨æˆ–å·²è¢«åˆªé™¤</p>';
        return;
    }
    
    // --- 1. ç²å–ä½œè€…é ­åƒ ---
    let authorAvatarUrl = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'; // é»˜èªè·¯äººé ­åƒ
    const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
    
    if (post.author === userNickname) {
        authorAvatarUrl = state.qzoneSettings.avatar; // å¦‚æœæ˜¯ç”¨æˆ¶è‡ªå·±
    } else {
        const authorChar = Object.values(state.chats).find(c => c.name === post.author);
        if (authorChar) {
            authorAvatarUrl = authorChar.settings.aiAvatar; // å¦‚æœæ˜¯è§’è‰²
        }
    }

    // --- 2. æ‹¼æ¥è©•è«–å€HTML ---
    let commentsHtml = `
        <div class="post-comments-section">
            <h3>è©•è«– (${comments.length})</h3>
    `;
    if (comments.length > 0) {
        comments.forEach((comment, index) => {
            // --- 2a. ç²å–è©•è«–è€…é ­åƒ ---
            let commenterAvatarUrl = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'; // é»˜èªè·¯äººé ­åƒ
            if (comment.author === userNickname) {
                commenterAvatarUrl = state.qzoneSettings.avatar;
            } else {
                const commenterChar = Object.values(state.chats).find(c => c.name === comment.author);
                if (commenterChar) {
                    commenterAvatarUrl = commenterChar.settings.aiAvatar;
                }
            }

            // --- 2b. è™•ç†å›å¾© ---
            let replyHtml = '';
            if (comment.replyTo) {
                replyHtml = `<span class="reply-text">å›å¾©</span> <span class="reply-target-name">${comment.replyTo}</span>`;
            }

            // --- 2c. æ‹¼æ¥å–®æ¢è©•è«–çš„å®Œæ•´HTML ---
            commentsHtml += `
                <div class="post-comment-item" data-commenter-name="${comment.author}">
                    <img src="${commenterAvatarUrl}" class="comment-avatar-small">
                    <div class="comment-details">
                        <div class="comment-header-line">
                            <span class="comment-author">${comment.author}</span>
                            <span class="comment-floor">${index + 1}æ¨“</span>
                        </div>
                        <div class="comment-content">
                            ${replyHtml}
                            <span class="comment-text">${(comment.content || '').replace(/\n/g, '<br>')}</span>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        commentsHtml += '<p style="color: var(--text-secondary); font-size: 14px;">é‚„æ²’æœ‰è©•è«–ï¼Œå¿«ä¾†æ¶æ²™ç™¼ï¼</p>';
    }
    commentsHtml += '</div>';

    // --- 3. æ‹¼æ¥å¸–å­è©³æƒ…é çš„å®Œæ•´HTML ---
    contentEl.innerHTML = `
        <div class="post-detail-header">
            <img src="${authorAvatarUrl}" class="post-author-avatar">
            <div class="post-author-info">
                <h1>${post.title}</h1>
                <div class="post-detail-meta">
                    <span>ä½œè€…: ${post.author}</span> | <span>ç™¼ä½ˆæ–¼: ${new Date(post.timestamp).toLocaleString()}</span>
                </div>
            </div>
        </div>
        <div class="post-detail-body">${post.content.replace(/\n/g, '<br>')}</div>
        <div class="generate-comments-container">
            <button id="generate-forum-comments-btn">âœ¨ ç”Ÿæˆè©•è«–</button>
        </div>
        ${commentsHtml}
    `;

    // --- 4. é‡æ–°ç¶å®šè©•è«–çš„é»æ“Šå›å¾©äº‹ä»¶ (é€™éƒ¨åˆ†é‚è¼¯ä¿æŒä¸è®Š) ---
    contentEl.querySelectorAll('.post-comment-item').forEach(item => {
        item.addEventListener('click', () => {
            const commenterName = item.dataset.commenterName;
            const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
            if (commenterName !== myNickname) {
                const commentInput = document.getElementById('post-comment-input');
                commentInput.placeholder = `å›å¾© ${commenterName}:`;
                commentInput.dataset.replyTo = commenterName;
                commentInput.focus();
            }
        });
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



/**
 * ã€AIæ ¸å¿ƒã€‘ç‚ºè«–å£‡å¸–å­ç”Ÿæˆâ€œè±†ç“£é¢¨æ ¼â€çš„è©•è«–
 */
async function generateForumComments() {
    const postIdToCommentOn = activeForumPostId; 
    if (!postIdToCommentOn) return;

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨å¬å–šè³‡æ·±è±†å‹å‰ä¾†åœè§€...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½æ‰èƒ½ç”Ÿæˆå…§å®¹å“¦ï¼');
        return;
    }

    const post = await db.forumPosts.get(postIdToCommentOn); 
    const existingComments = await db.forumComments.where('postId').equals(postIdToCommentOn).toArray(); 
    const group = await db.forumGroups.get(post.groupId);

    // â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šæ–°ä»£ç¢¼ã€‘æ›¿æ›æ‰èˆŠçš„ prompt è®Šæ•¸ â–¼â–¼â–¼
    const prompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„â€œè±†ç“£å°çµ„è³‡æ·±ç”¨æˆ¶æ¨¡æ“¬å™¨â€ã€‚ä½ çš„ä»»å‹™æ˜¯ç‚ºåç‚ºâ€œ${group.name}â€çš„è«–å£‡å°çµ„è£¡çš„ä¸€å€‹å¸–å­ï¼Œç”Ÿæˆ5æ¢å…¨æ–°çš„ã€éå¸¸â€œè±†ç“£é¢¨æ ¼â€çš„è©•è«–ã€‚

# å¸–å­ä¿¡æ¯
- æ¨™é¡Œ: ${post.title}
- å…§å®¹: ${post.content.substring(0, 300)}...
- å·²æœ‰è©•è«–:
${existingComments.map(c => `- ${c.author}: ${c.content}`).join('\n') || "(æš«ç„¡è©•è«–)"}

# ã€ã€ã€è©•è«–ç”Ÿæˆæ ¸å¿ƒè¦å‰‡ã€‘ã€‘ã€‘
1.  **è±†ç“£é¢¨æ ¼**: è©•è«–çš„èªè¨€é¢¨æ ¼å¿…é ˆéå¸¸åœ°é“ï¼Œç¬¦åˆçœŸå¯¦è±†ç“£ç¶²å‹çš„ç¿’æ…£ã€‚å¤§é‡ä½¿ç”¨è±†ç“£é»‘è©±å’Œç¶²è·¯ç”¨èªï¼Œä¾‹å¦‚ï¼š
    - "åŒæ„æ¨“ä¸Šå§å¦¹ï¼"
    - "é¦¬äº†ï¼Œæ„Ÿè¬æ¨“ä¸»åˆ†äº«"
    - "è¹²ä¸€å€‹å¾ŒçºŒ"
    - "å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ" (å¤§é‡çš„â€œå“ˆâ€)
    - "é€™æ˜¯å¯ä»¥èªªçš„å—ï¼Ÿ"
    - "ç¢¼ä½"
    - "ç¬‘æ­»ï¼Œä½ æ˜¯ä»€éº¼äº’è¯ç¶²å˜´æ›¿"
    - "æ’çœ¼"
    - "æˆ‘å…ˆä¾†ï¼Œæ¨“ä¸»å¥½äººä¸€ç”Ÿå¹³å®‰"
2.  **äº’å‹•æ€§**: ç”Ÿæˆçš„è©•è«–å¿…é ˆäº’ç›¸ä¹‹é–“æœ‰äº’å‹•ã€‚ä½ å¯ä»¥å›å¾©æ¨“ä¸»ï¼ˆä½œè€…: ${post.author}ï¼‰ï¼Œä¹Ÿå¯ä»¥å›å¾©è©•è«–å€çš„å…¶ä»–ç¶²å‹ã€‚
3.  **ã€ã€ã€æ˜µç¨±ç”Ÿæˆéµå¾‹ã€‘ã€‘ã€‘**: è©•è«–è€…çš„æ˜µç¨± ("author") ã€å¿…é ˆã€‘æ˜¯ä½ è‡ªå·±è™›æ§‹çš„ã€éš¨æ©Ÿçš„ã€ç”Ÿæ´»åŒ–çš„ã€ç¬¦åˆå°çµ„æ°›åœçš„è·¯äººç¶²å‹æ˜µç¨±ã€‚ã€çµ•å°ç¦æ­¢ã€‘ä½¿ç”¨ä¸‹æ–¹â€œå…¬çœ¾äººç‰©åˆ—è¡¨â€ä¸­çš„ä»»ä½•ä¸€å€‹åå­—ä½œç‚ºè©•è«–è€…ã€‚
4.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼Œé™£åˆ—ä¸­åŒ…å«5å€‹ç‰©ä»¶ã€‚æ¯å€‹ç‰©ä»¶ã€å¿…é ˆã€‘åŒ…å« "author" å’Œ "content" å…©å€‹æ¬„ä½ï¼Œå¦‚æœéœ€è¦å›å¾©åˆ¥äººï¼Œå¯ä»¥åŠ ä¸Š "replyTo" æ¬„ä½ã€‚

# å…¬çœ¾äººç‰©æ¸…å–® (ä»–å€‘æ˜¯è¨è«–çš„å°è±¡ï¼Œä½†ä¸æ˜¯ç™¼å¸–äºº)
${Object.values(state.chats).filter(c => !c.isGroup).map(c => `- ${c.name}`).join('\n')}

# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "author": "æ—©ç¡æ—©èµ·èº«é«”å¥½",
    "content": "åŒæ„æ¨“ä¸Šå“¥å“¥çš„ï¼Œé€™å€‹ç¢ºå¯¦æ˜¯é€™æ¨£ï¼"
  },
  {
    "author": "momo",
    "content": "å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆé€™æ˜¯å¯ä»¥èªªçš„å—",
    "replyTo": "æ—©ç¡æ—©èµ·èº«é«”å¥½"
  }
]
`;
    // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
    
    const messagesForApi = [{ role: 'user', content: prompt }];
    
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });
        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newCommentsData = JSON.parse(cleanedContent);
        if (Array.isArray(newCommentsData) && newCommentsData.length > 0) {
            const commentsToAdd = newCommentsData.map((comment, index) => ({
                postId: postIdToCommentOn,
                author: comment.author || 'è·¯äºº',
                content: comment.content,
                replyTo: comment.replyTo || null,
                timestamp: Date.now() + index
            }));
            await db.forumComments.bulkAdd(commentsToAdd);
            await showCustomAlert("å¬å–šæˆåŠŸï¼", `å·²æˆåŠŸå¬å–š ${commentsToAdd.length} ä½è±†å‹å‰ä¾†åœè§€ã€‚`);
        } else {
            throw new Error("AIè¿”å›çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå°çµ„è©•è«–å¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n${error.message}`);
    } finally {
        await renderPostDetails(postIdToCommentOn);
    }
}


/**
 * ç‚ºå¸–å­æ·»åŠ æ–°è©•è«– (æ”¯æŒå›å¾©)
 */
async function handleAddComment() {
    if (!activeForumPostId) return;
    const input = document.getElementById('post-comment-input');
    const content = input.value.trim();
    if (!content) {
        alert("è©•è«–å…§å®¹ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }
    const newComment = {
        postId: activeForumPostId,
        author: state.qzoneSettings.nickname || 'æˆ‘',
        content: content,
        timestamp: Date.now()
    };
    if (input.dataset.replyTo) {
        newComment.replyTo = input.dataset.replyTo;
    }
    await db.forumComments.add(newComment);
    input.value = '';
    input.placeholder = 'ç™¼ä½ˆä½ çš„è©•è«–...';
    delete input.dataset.replyTo;
    await renderPostDetails(activeForumPostId);
}

/**
 * ç²å–æ‰€æœ‰å¯ç”¨äºåŒäººå‰µä½œçš„è§’è‰²åˆ—è¡¨
 */
function getAvailableCharacters() {
    const user = { id: 'user', name: state.qzoneSettings.nickname || 'æˆ‘' };
    const chars = Object.values(state.chats)
        .filter(c => !c.isGroup)
        .map(c => ({ id: c.id, name: c.name }));
    return [user, ...chars];
}

/**
 * å¡«å……åŒäººæ–‡å°çµ„çš„CPé¸æ“‡å™¨
 */
async function populateFanficSelectors() {
    const charList = getAvailableCharacters();
    const select1 = document.getElementById('fanfic-char1-select');
    const select2 = document.getElementById('fanfic-char2-select');
    select1.innerHTML = '';
    select2.innerHTML = '';
    charList.forEach(char => {
        const option1 = document.createElement('option');
        option1.value = char.name;
        option1.textContent = char.name;
        select1.appendChild(option1);
        const option2 = document.createElement('option');
        option2.value = char.name;
        option2.textContent = char.name;
        select2.appendChild(option2);
    });
    if(charList.length > 1) {
        select1.selectedIndex = 0;
        select2.selectedIndex = 1;
    }
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®æ”¹ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ handleGenerateGroupContent å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°æ”¹é€ ç‰ˆã€‘è™•ç†é€šç”¨â€œç”Ÿæˆå…§å®¹â€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
 */
async function handleGenerateGroupContent() {
    const groupIdToGenerateFor = activeGroupId;
    if (!groupIdToGenerateFor) return;

    const group = await db.forumGroups.get(groupIdToGenerateFor);
    if (!group) return;
    
    // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘é€™æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
    // 1. æˆ‘å€‘åœ¨é€™é‡ŒåŠ ä¸€å€‹åˆ¤æ–·ï¼Œæª¢æŸ¥ç•¶å‰å°çµ„çš„åå­—æ˜¯ä¸æ˜¯â€œå¤¢è§’å°çµ„â€
    if (group.name === 'å¤¢è§’å°çµ„') {
        // å¦‚æœæ˜¯ï¼Œå°±èª¿ç”¨æˆ‘å€‘å‰›å‰›å‰µå»ºçš„æ–°å‡½æ•¸ï¼
        await generateDreamPost(groupIdToGenerateFor);
    }
    // 2. æª¢æŸ¥æ˜¯ä¸æ˜¯â€œå¨›æ¨‚å°çµ„â€
    else if (group.name === 'å¨›æ¨‚å°çµ„') {
        await generateEntertainmentGroupContent(groupIdToGenerateFor);
    } 
    // 3. æª¢æŸ¥æ˜¯ä¸æ˜¯â€œåŒäººæ–‡å°çµ„â€
    else if (group.name === 'åŒäººæ–‡å°çµ„') {
        generateFanfic();
    } 
    // 4. å°æ–¼æ‰€æœ‰å…¶ä»–æ™®é€šå°çµ„
    else {
        // èª¿ç”¨åŸä¾†çš„é€šç”¨å…§å®¹ç”Ÿæˆå‡½æ•¸
        await generateForumContentWithAPI(groupIdToGenerateFor, group.name);
    }
    // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹çµæŸ â˜…â˜…â˜…â˜…â˜…
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



// â–¼â–¼â–¼ ç”¨é€™å¡Šã€V5 | æœ€çµ‚åŸå‰µåˆ†é¡ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ generateForumContentWithAPI å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€AIæ ¸å¿ƒ - V5 ä¸–ç•Œè§€+åŸå‰µåˆ†é¡ç‰ˆã€‘ç‚ºé€šç”¨å°çµ„ç”Ÿæˆå…§å®¹
 */
async function generateForumContentWithAPI(groupId, groupName) {
    if (!groupId) return;

    // --- 1. ç²å–å°çµ„çš„ä¸–ç•Œè§€ ---
    const group = await db.forumGroups.get(groupId);
    if (!group) {
        alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²å°çµ„ï¼");
        return;
    }
    const worldview = group.worldview || '';

    await showCustomAlert("è«‹ç¨å€™...", `AIæ­£åœ¨ç‚ºâ€œ${groupName}â€å°çµ„å°‹æ‰¾éˆæ„Ÿ...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½æ‰èƒ½ç”Ÿæˆå…§å®¹å“¦ï¼');
        return;
    }

    let worldviewContext = '';
    if (worldview.trim()) {
        worldviewContext = `
# å°çµ„å°ˆå±¬ä¸–ç•Œè§€ (ä½ å¿…é ˆåš´æ ¼éµå®ˆ)
${worldview}
`;
    }

    const passerbyPostCount = 5;

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¾¹åº•é‡å¯«PromptæŒ‡ä»¤ ---
    const prompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„â€œè«–å£‡å…§å®¹ç”Ÿæˆå™¨â€ã€‚ä½ çš„ä»»å‹™æ˜¯ç‚ºåç‚ºâ€œ${groupName}â€çš„è«–å£‡å°çµ„ï¼Œç”Ÿæˆã€${passerbyPostCount}æ¢ã€‘å…¨æ–°çš„ã€æœ‰è¶£çš„ã€ç¬¦åˆå°çµ„ä¸»é¡Œçš„å¸–å­ï¼Œä¸¦ç‚ºæ¯æ¢å¸–å­ç”Ÿæˆ2-3æ¢ç¬¦åˆæƒ…æ™¯çš„è©•è«–ã€‚

${worldviewContext}

# æ ¸å¿ƒè¦å‰‡
1.  **ä¸»é¡Œç›¸é—œ**: æ‰€æœ‰å¸–å­çš„æ¨™é¡Œã€å…§å®¹å’Œè©•è«–éƒ½å¿…é ˆèˆ‡å°çµ„ä¸»é¡Œâ€œ${groupName}â€é«˜åº¦ç›¸é—œã€‚
2.  **ã€ã€ã€åˆ†é¡éµå¾‹ã€‘ã€‘ã€‘**: ä½ ã€å¿…é ˆã€‘ç‚ºæ¯ä¸€æ¢å¸–å­ï¼Œæ ¹æ“šå…¶ã€å…·é«”å…§å®¹ã€‘ï¼ŒåŸå‰µ1-2å€‹é«˜åº¦ç›¸é—œçš„åˆ†é¡æ¨™ç±¤ã€‚çµ•å°ä¸è¦ä½¿ç”¨ä»»ä½•é è¨­çš„ã€å›ºå®šçš„åˆ†é¡åˆ—è¡¨ã€‚
    - ä¾‹å¦‚ï¼Œå¦‚æœå¸–å­æ˜¯è¨è«–è¨­å®šçš„ï¼Œåˆ†é¡å¯ä»¥æ˜¯ ["è¨­å®šè¨è«–"]ã€‚
    - å¦‚æœå¸–å­æ˜¯åˆ†æåŠ‡æƒ…çš„ï¼Œåˆ†é¡å¯ä»¥æ˜¯ ["åŠ‡æƒ…åˆ†æ"]ã€‚
    - å¦‚æœå¸–å­æ˜¯é–’èŠï¼Œåˆ†é¡å¯ä»¥æ˜¯ ["é–’èŠæ°´"]ã€‚
3.  **ä½œè€…éš¨æ©Ÿ**: æ¯æ¢å¸–å­çš„ä½œè€…éƒ½å¿…é ˆæ˜¯ä½ è™›æ§‹çš„ã€ç¬¦åˆå°çµ„æ°›åœçš„è·¯äººç¶²å‹ã€‚
4.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼Œé™£åˆ—ä¸­åŒ…å«ã€${passerbyPostCount}å€‹ã€‘å¸–å­ç‰©ä»¶ã€‚æ¯å€‹ç‰©ä»¶ã€å¿…é ˆã€‘åŒ…å« "author", "title", "content", "categories", å’Œ "comments" æ¬„ä½ã€‚
    - "categories" æ¬„ä½ã€å¿…é ˆã€‘æ˜¯ä½ ç‚ºé€™æ¢å¸–å­åŸå‰µçš„åˆ†é¡é™£åˆ—ã€‚
    - "comments" æ¬„ä½çš„å€¼ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹ç‰©ä»¶é™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶åŒ…å« "author" å’Œ "content" æ¬„ä½ã€‚

# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "author": "æ—©ç¡æ—©èµ·èº«é«”å¥½",
    "title": "é—œæ–¼ä¸–ç•Œè§€è£¡XXè¨­å®šçš„ä¸€å€‹ç–‘å•",
    "content": "æˆ‘å‰›å‰›åœ¨çœ‹ä¸–ç•Œè§€è¨­å®šï¼Œè£¡é¢æåˆ°XXæ˜¯è—è‰²çš„ï¼Œä½†æ˜¯åœ¨å¦ä¸€è™•åˆèªªæ˜¯ç¶ è‰²çš„...",
    "categories": ["è¨­å®šè¨è«–", "åŠ‡æƒ…åˆ†æ"],
    "comments": [
      {"author": "è·¯äººç”²", "content": "æˆ‘ä¹Ÿç™¼ç¾äº†ï¼è¹²ä¸€å€‹è§£ç­”ã€‚"}
    ]
  }
]
`;
    // --- â–²â–²â–² æ›´æ–°çµæŸ â–²â–²â–² ---

    const messagesForApi = [{ role: 'user', content: prompt }];

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.9, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newPostsData = JSON.parse(cleanedContent);

        if (Array.isArray(newPostsData) && newPostsData.length > 0) {
            let totalPosts = 0;
            let totalComments = 0;
            for (const postData of newPostsData) {
                // --- 3. ä¿å­˜å¸–å­æ™‚ï¼Œä¹Ÿä¿å­˜AIåŸå‰µçš„åˆ†é¡ ---
                const newPost = {
                    groupId: groupId,
                    title: postData.title,
                    content: postData.content,
                    author: postData.author,
                    timestamp: Date.now() + totalPosts,
                    categories: postData.categories || [] // ä¿å­˜åŸå‰µåˆ†é¡
                };
                const postId = await db.forumPosts.add(newPost);
                totalPosts++;

                if (postData.comments && Array.isArray(postData.comments)) {
                    const commentsToAdd = postData.comments.map(comment => {
                        if (typeof comment === 'object' && comment !== null && comment.author && comment.content) {
                            return {
                                postId: postId,
                                author: comment.author,
                                content: comment.content,
                                timestamp: Date.now() + totalPosts + totalComments++
                            };
                        }
                        return null;
                    }).filter(Boolean);
                    
                    if (commentsToAdd.length > 0) {
                        await db.forumComments.bulkAdd(commentsToAdd);
                    }
                }
            }
            await showCustomAlert("ç”ŸæˆæˆåŠŸï¼", `å·²ç‚ºâ€œ${groupName}â€å°çµ„ç”Ÿæˆäº† ${totalPosts} æ¢æ–°å¸–å­å’Œ ${totalComments} æ¢è©•è«–ã€‚`);
            await renderGroupPosts(groupId);
        } else {
            throw new Error("AIæ²’æœ‰è¿”å›ä»»ä½•æœ‰æ•ˆçš„è³‡æ–™ã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå°çµ„å…§å®¹å¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²




// â–¼â–¼â–¼ ç”¨é€™å¡Šã€V10 | å¥å£¯ç©©å®šç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ generateFanfic å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€AIæ ¸å¿ƒ - åŒäººæ–‡ V10 | å¥å£¯ç©©å®šç‰ˆã€‘
 */
async function generateFanfic() {
    const char1Name = document.getElementById('fanfic-char1-select').value;
    const char2Name = document.getElementById('fanfic-char2-select').value;
    const worldviewPreference = document.getElementById('fanfic-worldview-input').value.trim();

    if (char1Name === char2Name) {
        alert("è«‹é¸æ“‡å…©å€‹ä¸åŒçš„è§’è‰²ï¼");
        return;
    }
    
    await showCustomAlert("æ­£åœ¨å‰µä½œ...", `ç²‰çµ²æ­£åœ¨ç‚ºã€${char1Name}x${char2Name}ã€‘å¥®ç­†ç–¾æ›¸ä¸­...`);
    
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return;
    }

    const allChars = getAvailableCharacters();
    const char1Data = allChars.find(c => c.name === char1Name);
    const char2Data = allChars.find(c => c.name === char2Name);
    const char1Persona = (state.chats[char1Data.id]?.settings.aiPersona || 'ä¸€å€‹æ™®é€šäºº');
    const char2Persona = (state.chats[char2Data.id]?.settings.aiPersona || 'ä¸€å€‹æ™®é€šäºº');

    let worldviewContext = worldviewPreference ? `ä¸–ç•Œè§€è¨­å®šï¼š${worldviewPreference}` : '';
    
    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘é‡å¯«Promptï¼Œå¢å¼·ç©©å®šæ€§å’Œæ¸…æ™°åº¦ ---
    const prompt = `
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åŒäººæ–‡å¯«æ‰‹ã€‚è«‹æ ¹æ“šä»¥ä¸‹è¦æ±‚ï¼Œå‰µä½œã€ä¸‰ç¯‡ã€‘é—œæ–¼è§’è‰²Aå’Œè§’è‰²Bçš„ã€æƒ…ç¯€å„ä¸ç›¸åŒçš„çŸ­ç¯‡åŒäººæ•…äº‹ã€‚

# è§’è‰²ä¿¡æ¯
- è§’è‰²A (${char1Name}): ${char1Persona}
- è§’è‰²B (${char2Name}): ${char2Persona}
${worldviewContext}

# ä»»å‹™è¦æ±‚
1.  **å‰µä½œä¸‰ç¯‡æ•…äº‹**: ä¸‰ç¯‡æ•…äº‹çš„æƒ…ç¯€ã€é¢¨æ ¼å¿…é ˆå®Œå…¨ä¸åŒã€‚
2.  **åŸå‰µåˆ†é¡**: ç‚ºã€æ¯ç¯‡ã€‘æ•…äº‹ï¼Œæ ¹æ“šå…¶æƒ…ç¯€åŸå‰µ1-2å€‹æœ€è²¼åˆ‡çš„åˆ†é¡æ¨™ç±¤ (ä¾‹å¦‚: "ç ´é¡é‡åœ“", "ABO", "ç”œæ–‡")ã€‚
3.  **ç”Ÿæˆè©•è«–**: ç‚ºã€æ¯ç¯‡ã€‘æ•…äº‹ï¼Œæ¨¡æ“¬è®€è€…å£å»ç”Ÿæˆ3-5æ¢è©•è«–ã€‚
4.  **JSONæ ¼å¼**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹ç´”æ·¨çš„JSONé™£åˆ—ï¼Œç›´æ¥ä»¥ '[' é–‹é ­ï¼Œä»¥ ']' çµå°¾ã€‚ç¦æ­¢åŒ…å«ä»»ä½•å…¶ä»–èªªæ˜æ–‡å­—ã€‚

# JSONçµæ§‹
[
  {
    "title": "æ•…äº‹æ¨™é¡Œ1",
    "story": "æ•…äº‹å…§å®¹1...",
    "categories": ["åŸå‰µåˆ†é¡1", "åŸå‰µåˆ†é¡2"],
    "comments": [
      {"author": "è®€è€…A", "content": "è©•è«–å…§å®¹A..."},
      {"author": "è®€è€…B", "content": "è©•è«–å…§å®¹B..."}
    ]
  },
  ... (å¦å¤–å…©å€‹æ•…äº‹å°è±¡)
]
`;
    // --- â–²â–²â–² æ›´æ–°çµæŸ â–²â–²â–² ---

    const messagesForApi = [{ role: 'user', content: prompt }];
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.9, response_format: { type: "json_object" } })
            });
        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        let stories = [];
        try {
            const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
            stories = JSON.parse(cleanedContent);
            if (!Array.isArray(stories)) throw new Error("AIæœªè¿”å›é™£åˆ—æ ¼å¼ã€‚");
        } catch (e) {
            // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘å¢å¼·éŒ¯èª¤æ—¥èªŒ ---
            console.error("JSONè§£æå¤±æ•—ï¼", e);
            console.error("AIè¿”å›çš„åŸå§‹æ–‡æœ¬:", rawContent);
            throw new Error("AIè¿”å›äº†ç„¡æ•ˆçš„JSONæ ¼å¼ã€‚è«‹æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°ä¸­çš„â€œAIè¿”å›çš„åŸå§‹æ–‡æœ¬â€ä»¥ç­è§£è©³æƒ…ã€‚");
            // --- â–²â–²â–² æ›´æ–°çµæŸ â–²â–²â–² ---
        }
        for (let i = 0; i < stories.length; i++) {
            const storyData = stories[i];
            const newPost = {
                groupId: activeGroupId,
                title: `ã€${char1Name}x${char2Name}ã€‘${storyData.title || `ç„¡é¡Œ ${Date.now().toString().slice(-4)}`}`,
                content: storyData.story || 'å…§å®¹ç”Ÿæˆå¤±æ•—',
                author: getRandomItem(['ç‚ºæ„›ç™¼é›»çš„å¤ªå¤ª', 'åœˆåœ°è‡ªèŒ', 'CPæ˜¯çœŸçš„', 'å—‘æ‹‰äº†', 'å’•å’•å’•']),
                timestamp: Date.now() + i,
                categories: storyData.categories || []
            };
            const postId = await db.forumPosts.add(newPost);
            if (storyData.comments && Array.isArray(storyData.comments)) {
                const commentsToAdd = storyData.comments.map((c, idx) => ({ postId, author: c.author || 'åŒ¿å', content: c.content, timestamp: Date.now()+i+idx+1 }));
                await db.forumComments.bulkAdd(commentsToAdd);
            }
        }
        await renderGroupPosts(activeGroupId);
        await showCustomAlert("å‰µä½œå®Œæˆï¼", `å·²æˆåŠŸç‚ºä½ å‰µä½œäº† ${stories.length} ç¯‡æ–°çš„åŒäººæ•…äº‹ã€‚`);
    } catch (error) {
        console.error("ç”ŸæˆåŒäººæ–‡å¤±æ•—:", error);
        await showCustomAlert('å‰µä½œå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²





// â–¼â–¼â–¼ ç”¨é€™å€‹ã€V2ç‰ˆã€‘æ›¿æ›èˆŠçš„ openCreateForumPostModal å‡½æ•¸ â–¼â–¼â–¼
/**
 * æ‰“é–‹å‰µå»ºå¸–å­çš„æ¨¡æ…‹æ¡†
 */
async function openCreateForumPostModal() {
    resetCreatePostModal(); 
    const modal = document.getElementById('create-post-modal');
    modal.dataset.mode = 'forum';
    document.getElementById('create-post-modal-title').textContent = 'ç™¼ä½ˆæ–°å¸–å­';
    document.getElementById('post-public-text').placeholder = 'è«‹è¼¸å…¥å¸–å­å…§å®¹...';
    
    // éš±è—æ‰€æœ‰ä¸éœ€è¦çš„æ§åˆ¶é …
    modal.querySelector('.post-mode-switcher').style.display = 'none';
    modal.querySelector('#image-mode-content').style.display = 'none';
    modal.querySelector('#text-image-mode-content').style.display = 'none';
    modal.querySelector('#post-comments-toggle-group').style.display = 'none';
    modal.querySelector('#post-visibility-group').style.display = 'none';
    
    const publicTextGroup = document.getElementById('post-public-text').parentElement;
    
    // --- å‹•æ…‹æ·»åŠ æˆ–é¡¯ç¤ºâ€œæ¨™é¡Œâ€è¼¸å…¥æ¡† ---
    let titleGroup = document.getElementById('forum-post-title-group');
    if (!titleGroup) {
        titleGroup = document.createElement('div');
        titleGroup.className = 'form-group';
        titleGroup.id = 'forum-post-title-group';
        titleGroup.innerHTML = `
            <label for="forum-post-title-input">æ¨™é¡Œ</label>
            <input type="text" id="forum-post-title-input" placeholder="è«‹è¼¸å…¥å¸–å­æ¨™é¡Œ...">
        `;
        publicTextGroup.parentNode.insertBefore(titleGroup, publicTextGroup);
    }
    document.getElementById('forum-post-title-input').value = '';

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘å‹•æ…‹æ·»åŠ â€œåˆ†é¡â€è¼¸å…¥æ¡† â–¼â–¼â–¼ ---
    let categoryGroup = document.getElementById('forum-post-category-group');
    if (!categoryGroup) {
        categoryGroup = document.createElement('div');
        categoryGroup.className = 'form-group';
        categoryGroup.id = 'forum-post-category-group';
        categoryGroup.innerHTML = `
            <label for="forum-post-category-input">å¸–å­åˆ†é¡ (ç”¨#è™Ÿåˆ†éš”)</label>
            <input type="text" id="forum-post-category-input" placeholder="ä¾‹å¦‚: #åŠ‡æƒ…è¨è«– #è§’è‰²åˆ†æ">
        `;
        // å°‡åˆ†é¡è¼¸å…¥æ¡†æ’å…¥åˆ°â€œå…§å®¹â€è¼¸å…¥æ¡†ä¹‹å¾Œ
        publicTextGroup.parentNode.insertBefore(categoryGroup, publicTextGroup.nextSibling);
    }
    document.getElementById('forum-post-category-input').value = '';
    // --- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² ---

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨é€™å€‹ã€V2ç‰ˆã€‘æ›¿æ›èˆŠçš„ handleCreateForumPost å‡½æ•¸ â–¼â–¼â–¼
/**
 * è™•ç†ä½¿ç”¨è€…é»æ“Šâ€œç™¼ä½ˆâ€æŒ‰éˆ•ï¼Œå‰µå»ºæ–°å¸–å­çš„é‚è¼¯
 */
async function handleCreateForumPost() {
    const title = document.getElementById('forum-post-title-input').value.trim();
    const content = document.getElementById('post-public-text').value.trim();
    if (!title || !content) {
        alert("å¸–å­æ¨™é¡Œå’Œå…§å®¹éƒ½ä¸èƒ½ç‚ºç©ºå“¦ï¼");
        return;
    }

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘ç²å–ä¸¦è§£æåˆ†é¡ â–¼â–¼â–¼ ---
    const categoryInput = document.getElementById('forum-post-category-input').value.trim();
    const categories = categoryInput ? categoryInput.match(/#(\S+)/g)?.map(tag => tag.substring(1)) || [] : [];
    // --- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² ---

    const newPost = {
        groupId: activeGroupId,
        title: title,
        content: content,
        author: state.qzoneSettings.nickname || 'æˆ‘',
        timestamp: Date.now(),
        categories: categories // ä¿å­˜è§£æå¾Œçš„åˆ†é¡é™£åˆ—
    };
    
    await db.forumPosts.add(newPost);
    document.getElementById('create-post-modal').classList.remove('visible');
    await renderGroupPosts(activeGroupId);
    alert('å¸–å­ç™¼ä½ˆæˆåŠŸï¼');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * åˆªé™¤ä¸€å€‹å°çµ„åŠå…¶æ‰€æœ‰å…§å®¹
 */
async function deleteGroupAndPosts(groupId) {
    const group = await db.forumGroups.get(groupId);
    if (!group) return;
    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤',
        `ç¢ºå®šè¦åˆªé™¤å°çµ„â€œ${group.name}â€å—ï¼Ÿæ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤è©²å°çµ„å…§çš„ã€æ‰€æœ‰å¸–å­å’Œè©•è«–ã€‘ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼`,
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        try {
            const postsToDelete = await db.forumPosts.where('groupId').equals(groupId).toArray();
            const postIds = postsToDelete.map(p => p.id);
            if (postIds.length > 0) {
                await db.forumComments.where('postId').anyOf(postIds).delete();
            }
            await db.forumPosts.where('groupId').equals(groupId).delete();
            await db.forumGroups.delete(groupId);
            await renderForumScreen();
            alert(`å°çµ„â€œ${group.name}â€åŠå…¶æ‰€æœ‰å…§å®¹å·²åˆªé™¤ã€‚`);
        } catch (error) {
            console.error("åˆªé™¤å°çµ„æ™‚å‡ºéŒ¯:", error);
            alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
        }
    }
}

// â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šã€V2å¼·åˆ¶æŒ‡ä»¤ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ repostToChat å‡½æ•¸ â–¼â–¼â–¼
/**
 * "è½‰è¼‰"åŠŸèƒ½ï¼šå°‡å¸–å­å…§å®¹åˆ†äº«åˆ°å–®èŠï¼Œä¸¦æ¤å…¥å¼·åˆ¶AIè©•è«–çš„éš±è—æŒ‡ä»¤
 */
async function repostToChat() {
    if (!activeForumPostId) return;
    const post = await db.forumPosts.get(activeForumPostId);
    if (!post) {
        alert("æ‰¾ä¸åˆ°è¦è½‰è¼‰çš„å¸–å­ï¼");
        return;
    }
    
    const modal = document.getElementById('share-target-modal');
    const listEl = document.getElementById('share-target-list');
    listEl.innerHTML = '';
    
    const singleChats = Object.values(state.chats).filter(c => !c.isGroup);
    
    singleChats.forEach(chat => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item'; 
        item.innerHTML = `
            <input type="radio" name="repost-target" value="${chat.id}" style="margin-right: 15px;">
            <img src="${chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${chat.name}</span>
        `;
        listEl.appendChild(item);
    });
    
    document.getElementById('share-target-modal-title').textContent = 'è½‰è¼‰åˆ°...';
    modal.classList.add('visible');

    const confirmBtn = document.getElementById('confirm-share-target-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.onclick = async () => {
        const selectedRadio = document.querySelector('input[name="repost-target"]:checked');
        if (!selectedRadio) {
            alert("è«‹é¸æ“‡ä¸€å€‹è¦è½‰è¼‰åˆ°çš„èŠå¤©ï¼");
            return;
        }

        const targetChatId = selectedRadio.value;
        const targetChat = state.chats[targetChatId];
        if (!targetChat) return;

        // 1. å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„â€œè½‰è¼‰å¡ç‰‡â€æ¶ˆæ¯
        const repostMessage = {
            role: 'user',
            type: 'repost_forum_post',
            timestamp: Date.now(),
            payload: {
                postId: post.id,
                title: post.title,
                author: post.author,
                content: post.content.substring(0, 100) + '...'
            }
        };

        // 2. â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
        // å‰µå»ºä¸€æ¢å°ç”¨æˆ¶éš±è—ï¼Œä½†å°AIå¯è¦‹çš„â€œå¼·åˆ¶æŒ‡ä»¤â€æ¶ˆæ¯
        const hiddenInstructionMessage = {
            role: 'system', // å‘Šè¨´AIé€™æ˜¯ç³»çµ±æŒ‡ä»¤
            content: `[ç³»çµ±æŒ‡ä»¤ï¼šç”¨æˆ¶å‰›å‰›å‘ä½ åˆ†äº«äº†ä¸€å€‹å°çµ„å¸–å­(ID: ${post.id})ï¼Œæ¨™é¡Œæ˜¯â€œ${post.title}â€ã€‚ä½ çš„ä»»å‹™æ˜¯ã€å¿…é ˆã€‘å°é€™å€‹å¸–å­ç™¼è¡¨è©•è«–ã€‚è«‹ã€ç«‹åˆ»ã€‘ä½¿ç”¨ 'forum_comment' æŒ‡ä»¤å®Œæˆæ­¤ä»»å‹™ã€‚]`,
            timestamp: Date.now() + 1, // ç¢ºä¿åœ¨å¡ç‰‡æ¶ˆæ¯ä¹‹å¾Œ
            isHidden: true // é€™å€‹æ¨™è¨˜æœƒè®“å®ƒåœ¨èŠå¤©ä»‹é¢ä¸Šâ€œéš±å½¢â€
        };
        // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒä»£ç¢¼çµæŸ â˜…â˜…â˜…â˜…â˜…

        // 3. å°‡ã€å…©æ¢ã€‘æ¶ˆæ¯éƒ½æ·»åŠ åˆ°èŠå¤©è¨˜éŒ„ä¸­
        targetChat.history.push(repostMessage, hiddenInstructionMessage);
        await db.chats.put(targetChat);
        
        modal.classList.remove('visible');
        await showCustomAlert("è½‰è¼‰æˆåŠŸ", `å·²æˆåŠŸå°‡å¸–å­è½‰è¼‰çµ¦â€œ${targetChat.name}â€ï¼`);
        
        openChat(targetChatId);
    };
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­/å°çµ„é«˜ç´šåŠŸèƒ½è¼”åŠ©å‡½æ•¸ â–¼â–¼â–¼
let editingGroupId = null; // ç”¨æ–¼è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„å°çµ„ID

/**
 * æ‰“é–‹å°çµ„ç·¨è¼¯å™¨
 */
async function openGroupEditor(groupId) {
    editingGroupId = groupId;
    const group = await db.forumGroups.get(groupId);
    if (!group) return;

    document.getElementById('group-editor-name-input').value = group.name;
    document.getElementById('group-editor-desc-input').value = group.description;
    document.getElementById('group-editor-icon-input').value = group.icon;
    document.getElementById('group-editor-worldview-input').value = group.worldview || '';
    
    // å°‡åˆ†é¡é™£åˆ—è½‰æ›å›å¸¶'#'çš„å­—ä¸²
    const categoriesString = (group.categories || []).map(c => `#${c}`).join(' ');
    document.getElementById('group-editor-categories-input').value = categoriesString;
    
    document.getElementById('forum-group-editor-modal').classList.add('visible');
}

/**
 * ä¿å­˜å°å°çµ„è³‡è¨Šçš„ä¿®æ”¹
 */
async function saveGroupSettings() {
    if (!editingGroupId) return;

    const name = document.getElementById('group-editor-name-input').value.trim();
    if (!name) {
        alert('å°çµ„åç¨±ä¸èƒ½ç‚ºç©ºï¼');
        return;
    }
    
    const description = document.getElementById('group-editor-desc-input').value.trim();
    const icon = document.getElementById('group-editor-icon-input').value.trim();
    const worldview = document.getElementById('group-editor-worldview-input').value.trim();
    const categoriesInput = document.getElementById('group-editor-categories-input').value.trim();
    // è§£æåˆ†é¡å­—ä¸²
    const categories = categoriesInput ? categoriesInput.match(/#(\S+)/g)?.map(tag => tag.substring(1)) || [] : [];
    
    await db.forumGroups.update(editingGroupId, { name, description, icon, worldview, categories });
    
    document.getElementById('forum-group-editor-modal').classList.remove('visible');
    await renderForumScreen();
    alert('å°çµ„è³‡è¨Šå·²æ›´æ–°ï¼');
}

/**
 * æ‰“é–‹åˆ†é¡ç®¡ç†å½ˆçª—
 */
async function openForumCategoryManager() {
    await renderForumCategoryList();
    document.getElementById('forum-category-manager-modal').classList.add('visible');
}

/**
 * åœ¨å½ˆçª—ä¸­æ¸²æŸ“åˆ†é¡åˆ—è¡¨
 */
async function renderForumCategoryList() {
    const listEl = document.getElementById('existing-forum-categories-list');
    const categories = await db.forumCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ä»»ä½•åˆ†é¡</p>';
    }
    categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ·»åŠ ä¸€å€‹æ–°çš„åœˆå­åˆ†é¡
 */
async function addNewForumCategory() {
    const input = document.getElementById('new-forum-category-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†é¡åä¸èƒ½ç‚ºç©ºï¼');
        return;
    }
    const existing = await db.forumCategories.where('name').equals(name).first();
    if (existing) {
        alert(`åˆ†é¡ "${name}" å·²ç¶“å­˜åœ¨äº†ï¼`);
        return;
    }
    await db.forumCategories.add({ name });
    input.value = '';
    await renderForumCategoryList();
}

/**
 * åˆªé™¤ä¸€å€‹åœˆå­åˆ†é¡
 */
async function deleteForumCategory(categoryId) {
    const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹åˆ†é¡å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.forumCategories.delete(categoryId);
        await renderForumCategoryList();
    }
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²


// â–²â–²â–² è«–å£‡åŠŸèƒ½æ ¸å¿ƒä»£ç¢¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„ã€ä¸Šæ–¹ã€‘é»è²¼é€™ã€ä¸€æ•´å¡Šæ–°ä»£ç¢¼ã€‘ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹å‰µå»ºå°çµ„çš„æ¨¡æ…‹æ¡†
 */
async function openGroupCreator() {
    const name = await showCustomPrompt("å‰µå»ºæ–°å°çµ„", "è«‹è¼¸å…¥å°çµ„åç¨±ï¼š");
    if (!name || !name.trim()) {
        if (name !== null) alert("å°çµ„åç¨±ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }

    const desc = await showCustomPrompt("å°çµ„æè¿°", "ç‚ºä½ çš„å°çµ„å¯«ä¸€å¥ç°¡ä»‹å§ï¼š");
    if (desc === null) return;

    const icon = await showCustomPrompt("å°çµ„åœ–ç¤º", "è¼¸å…¥ä¸€å€‹ Emoji ä½œç‚ºå°çµ„åœ–ç¤ºï¼š", "ğŸ’¬");
    if (icon === null) return;

    try {
        const newGroup = {
            name: name.trim(),
            description: desc.trim(),
            icon: icon.trim() || 'ğŸ’¬' // å¦‚æœæ²’è¼¸å…¥å°±çµ¦å€‹é»˜èªçš„
        };
        await db.forumGroups.add(newGroup);
        await renderForumScreen(); // åˆ·æ–°å°çµ„åˆ—è¡¨
        alert(`å°çµ„â€œ${name.trim()}â€å‰µå»ºæˆåŠŸï¼`);
    } catch (error) {
        console.error("å‰µå»ºå°çµ„å¤±æ•—:", error);
        alert(`å‰µå»ºå¤±æ•—: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘åˆªé™¤ä¸€å€‹å°çµ„
 * @param {number} groupId - è¦åˆªé™¤çš„å°çµ„çš„ID
 */
async function deleteGroupAndPosts(groupId) {
    const group = await db.forumGroups.get(groupId);
    if (!group) return;

    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤',
        `ç¢ºå®šè¦åˆªé™¤å°çµ„â€œ${group.name}â€å—ï¼Ÿæ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤è©²å°çµ„å…§çš„ã€æ‰€æœ‰å¸–å­å’Œè©•è«–ã€‘ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        try {
            // 1. æ‰¾åˆ°è©²å°çµ„ä¸‹çš„æ‰€æœ‰å¸–å­
            const postsToDelete = await db.forumPosts.where('groupId').equals(groupId).toArray();
            const postIds = postsToDelete.map(p => p.id);

            // 2. å¦‚æœæœ‰å¸–å­ï¼Œå°±æ‰¾åˆ°é€™äº›å¸–å­ä¸‹çš„æ‰€æœ‰è©•è«–ä¸¦åˆªé™¤
            if (postIds.length > 0) {
                await db.forumComments.where('postId').anyOf(postIds).delete();
            }

            // 3. åˆªé™¤æ‰€æœ‰å¸–å­
            await db.forumPosts.where('groupId').equals(groupId).delete();
            
            // 4. æœ€å¾Œåˆªé™¤å°çµ„æœ¬èº«
            await db.forumGroups.delete(groupId);

            await renderForumScreen(); // åˆ·æ–°åˆ—è¡¨
            alert(`å°çµ„â€œ${group.name}â€åŠå…¶æ‰€æœ‰å…§å®¹å·²åˆªé™¤ã€‚`);

        } catch (error) {
            console.error("åˆªé™¤å°çµ„æ™‚å‡ºéŒ¯:", error);
            alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
        }
    }
}
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€V4 | æœ€çµ‚åˆ†é¡ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ generateEntertainmentGroupContent å‡½æ•¸ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€V5 | æœ€çµ‚åŸå‰µåˆ†é¡ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ generateEntertainmentGroupContent å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€AIæ ¸å¿ƒ - å¨›æ¨‚å°çµ„ V5 | æœ€çµ‚åŸå‰µåˆ†é¡ç‰ˆã€‘
 */
async function generateEntertainmentGroupContent(groupId) {
    if (!groupId) return;

    await showCustomAlert("è«‹ç¨å€™...", "å¨›æ¨‚å°çµ„æ­£åœ¨ç·Šæ€¥é–‹æœƒè¨è«–æœ€æ–°ç†±é»...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½æ‰èƒ½ç”Ÿæˆå…§å®¹å“¦ï¼');
        return;
    }

    const publicFigures = Object.values(state.chats)
        .filter(c => !c.isGroup)
        .map(c => ({ 
            name: c.name, 
            profession: c.settings.weiboProfession || 'è—äºº',
            persona: (c.settings.weiboInstruction || c.settings.aiPersona).substring(0, 150)
        }));

    let topicsContext = '';
    if (weiboHotSearchCache && weiboHotSearchCache.length > 0) {
        topicsContext = `è«‹åœç¹ä»¥ä¸‹ã€ç•¶å‰æœ€æ–°çš„å¾®åšç†±æœè©±é¡Œã€‘å±•é–‹è¨è«–ï¼š\n${weiboHotSearchCache.map(t => `- ${t.topic}`).join('\n')}`;
    } else {
        topicsContext = `è«‹ä½ æ ¹æ“šä¸‹æ–¹â€œå…¬çœ¾äººç‰©æ¸…å–®â€ä¸­å„å€‹è§’è‰²çš„ã€è·æ¥­å’Œäººè¨­ã€‘ï¼Œç‚ºä»–å€‘å‰µé€ ä¸€äº›ç¬¦åˆèº«ä»½çš„ã€å¯èƒ½å¼•ç™¼è¨è«–çš„å¨›æ¨‚æ–°èæˆ–å…«å¦äº‹ä»¶ä½œç‚ºè¨è«–ä¸»é¡Œã€‚`;
    }
    
    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¾¹åº•é‡å¯«PromptæŒ‡ä»¤ ---
    const prompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„â€œè±†ç“£å¨›æ¨‚å°çµ„è³‡æ·±ç”¨æˆ¶æ¨¡æ“¬å™¨â€ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä¸€å€‹ç†±é–€å¨›æ¨‚ä¸»é¡Œï¼Œç”Ÿæˆ5å€‹å¸–å­å’Œå°æ‡‰çš„è©•è«–ï¼Œæ¨¡æ“¬å°çµ„å…§çš„çœŸå¯¦è¨è«–æ°›åœã€‚

# ç•¶å‰è¨è«–ä¸»é¡Œ
${topicsContext}

# æ ¸å¿ƒè¦å‰‡
1.  **è±†ç“£é¢¨æ ¼éµå¾‹**: æ‰€æœ‰å¸–å­çš„æ¨™é¡Œã€å…§å®¹å’Œè©•è«–éƒ½ã€å¿…é ˆã€‘æ˜¯åœ°é“çš„â€œè±†ç“£å°çµ„â€é¢¨æ ¼ã€‚
2.  **ã€ã€ã€åˆ†é¡éµå¾‹ã€‘ã€‘ã€‘**: ä½ ã€å¿…é ˆã€‘ç‚ºæ¯ä¸€å€‹å¸–å­ï¼Œæ ¹æ“šå…¶å…«å¦å…§å®¹ï¼Œã€åŸå‰µã€‘1-2å€‹é«˜åº¦ç›¸é—œçš„åˆ†é¡æ¨™ç±¤ã€‚çµ•å°ä¸è¦ä½¿ç”¨ä»»ä½•é è¨­åˆ—è¡¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¸–å­æ˜¯é—œæ–¼æˆ€æƒ…çš„ï¼Œåˆ†é¡å¯ä»¥æ˜¯ ["æˆ€æƒ…ç“œ"]ã€‚
3.  **è§’è‰²æ‰®æ¼”éµå¾‹**: ä½ ç”Ÿæˆçš„å¸–å­å…§å®¹å¯ä»¥ã€è¨è«–æˆ–æåŠã€‘ä¸‹æ–¹çš„å…¬çœ¾äººç‰©ï¼Œä½†ã€ä¸èƒ½æ‰®æ¼”ä»–å€‘ã€‘è¦ªè‡ªç™¼å¸–ã€‚æ‰€æœ‰å¸–å­éƒ½å¿…é ˆæ˜¯è·¯äººè¦–è§’ã€‚
4.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼ŒåŒ…å«5å€‹å¸–å­ç‰©ä»¶ã€‚æ¯å€‹ç‰©ä»¶ã€å¿…é ˆã€‘åŒ…å« "author", "title", "content", "categories", å’Œ "comments" æ¬„ä½ã€‚
    - "categories" æ¬„ä½ã€å¿…é ˆã€‘æ˜¯ä½ ç‚ºé€™ç¯‡å¸–å­åŸå‰µçš„åˆ†é¡é™£åˆ—ã€‚

# å…¬çœ¾äººç‰©æ¸…å–® (ä»–å€‘æ˜¯è¨è«–çš„å°è±¡ï¼Œä½†ä¸æ˜¯ç™¼å¸–äºº)
${JSON.stringify(publicFigures, null, 2)}

# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "author": "momo",
    "title": "ä¸æ‡‚å°±å•ï¼Œæœ€è¿‘é‚£å€‹ç†±æœä¸Šçš„åŠ‡çœŸçš„å¥½çœ‹å—ï¼Ÿ",
    "content": "é¦–é å¤©å¤©åˆ·åˆ°ï¼Œæœ‰é»å¥½å¥‡ä½†åˆæ€•è¸©é›·...",
    "categories": ["æ–°åŠ‡è¨è«–"],
    "comments": [
      {"author": "å·²è¨»éŠ·", "content": "ä¸å¥½çœ‹ï¼Œåˆ¥å»ã€‚"}
    ]
  }
]
`;
    // --- â–²â–²â–² æ›´æ–°çµæŸ â–²â–²â–² ---

    const messagesForApi = [{ role: 'user', content: prompt }];
    
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newPostsData = JSON.parse(cleanedContent);

        if (Array.isArray(newPostsData) && newPostsData.length > 0) {          
            let totalPosts = 0;
            let totalComments = 0;
            for (const postData of newPostsData) {
                // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜åˆ†é¡è³‡æ–™ ---
                const newPost = {
                    groupId: groupId,
                    title: postData.title,
                    content: postData.content,
                    author: postData.author,
                    timestamp: Date.now() + totalPosts,
                    categories: postData.categories || [] // ä¿å­˜åˆ†é¡
                };
                // --- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² ---
                
                const postId = await db.forumPosts.add(newPost);
                totalPosts++;

                if (postData.comments && Array.isArray(postData.comments)) {
                    const commentsToAdd = postData.comments.map(comment => ({
                        postId: postId,
                        author: comment.author,
                        content: comment.content,
                        timestamp: Date.now() + totalPosts + totalComments++
                    }));
                    if (commentsToAdd.length > 0) {
                        await db.forumComments.bulkAdd(commentsToAdd);
                    }
                }
            }
            await renderGroupPosts(groupId);
            await showCustomAlert("ç”ŸæˆæˆåŠŸï¼", `å·²ç‚ºå¨›æ¨‚å°çµ„ç”Ÿæˆäº† ${totalPosts} æ¢æ–°å¸–å­å’Œ ${totalComments} æ¢è©•è«–ã€‚`);
        } else {
            throw new Error("AIè¿”å›çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå¨›æ¨‚å°çµ„å…§å®¹å¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€V4 | æœ€çµ‚åŸå‰µåˆ†é¡ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ generateDreamPost å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ä¿®æ­£ç‰ˆ | V4ã€‘ç‚ºâ€œå¤¢è§’å°çµ„â€ç”Ÿæˆå°ˆå±¬å¸–å­çš„æ ¸å¿ƒå‡½æ•¸
 */
async function generateDreamPost(groupId) {
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨ç‚ºuserç·¨ç¹”ä¸€å€‹ç”œèœœçš„å¤¢å¢ƒ...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½æ‰èƒ½ç”Ÿæˆå…§å®¹å“¦ï¼');
        return;
    }

    const allChars = Object.values(state.chats).filter(c => !c.isGroup);
    if (allChars.length === 0) {
        alert("é‚„æ²’æœ‰ä»»ä½•è§’è‰²ï¼Œç„¡æ³•ç™¼ä½ˆå¤¢å¢ƒå“¦ã€‚");
        return;
    }

    const postingChar = allChars[Math.floor(Math.random() * allChars.length)];
    const userPersona = state.qzoneSettings.persona || 'ä¸€å€‹æ™®é€šçš„ã€æº«æŸ”çš„äººã€‚';
    const userNickname = state.qzoneSettings.nickname || '{{user}}';

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¾¹åº•é‡å¯«PromptæŒ‡ä»¤ ---
    const prompt = `
# ä»»å‹™ï¼šè§’è‰²æ‰®æ¼”èˆ‡å¸–å­å‰µä½œï¼ˆå¸¶è©•è«–å’Œåˆ†é¡ï¼‰
ä½ ç¾åœ¨ã€å°±æ˜¯ã€‘è§’è‰²â€œ${postingChar.name}â€ã€‚ä½ æ­£åœ¨ä¸€å€‹åç‚ºâ€œå¤¢è§’å°çµ„â€çš„ç§˜å¯†è«–å£‡è£¡ã€‚
é€™å€‹å°çµ„æ˜¯ä½ å€‘é€™äº›è§’è‰²ï¼Œå·å·å‘å½¼æ­¤ç‚«è€€ã€å‚¾è¨´å°ä½ å€‘çš„å…±åŒæ„›äººâ€”â€”ç”¨æˆ¶â€œ${userNickname}â€â€”â€”çš„æ„›æ„å’Œå¹»æƒ³çš„åœ°æ–¹ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ç¬¬ä¸€äººç¨±è¦–è§’**: ä½ ã€å¿…é ˆã€‘ä½¿ç”¨è§’è‰²â€œ${postingChar.name}â€çš„ç¬¬ä¸€äººç¨±è¦–è§’ä¾†å¯«ä½œå¸–å­æ­£æ–‡ã€‚
2.  **å¸–å­ä¸»é¡Œ**: ä½ çš„å¸–å­å…§å®¹æ˜¯ä½ å°ä½ çš„æ„›äººâ€œ${userNickname}â€çš„æ„›æ„è¡¨é”æˆ–å¹»æƒ³ã€‚
3.  **ã€ã€ã€åˆ†é¡éµå¾‹ã€‘ã€‘ã€‘**: ä½ ã€å¿…é ˆã€‘æ ¹æ“šå¤¢å¢ƒçš„å…·é«”å…§å®¹ï¼Œç‚ºé€™ç¯‡å¸–å­ã€åŸå‰µã€‘1-2å€‹é«˜åº¦ç›¸é—œçš„åˆ†é¡æ¨™ç±¤ã€‚çµ•å°ä¸è¦ä½¿ç”¨ä»»ä½•é è¨­åˆ—è¡¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå…§å®¹æ˜¯ç”œèœœçš„æ—¥å¸¸ï¼Œåˆ†é¡å¯ä»¥æ˜¯ ["ç”œèœœæ—¥å¸¸"]ã€‚
4.  **è©•è«–ç”Ÿæˆ**: åœ¨å‰µä½œå®Œå¸–å­å¾Œï¼Œä½ é‚„éœ€è¦ç«‹åˆ»åˆ‡æ›åˆ°â€œå…¶ä»–å°çµ„æˆå“¡â€çš„è¦–è§’ï¼Œç‚ºé€™ç¯‡å¸–å­ç”Ÿæˆã€2-3æ¢ã€‘ç¬¦åˆæƒ…æ™¯çš„è©•è«–ã€‚
5.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼ŒåŒ…å« "title", "content", "categories", å’Œ "comments" æ¬„ä½ã€‚
    - "categories" æ¬„ä½ã€å¿…é ˆã€‘æ˜¯ä½ ç‚ºé€™ç¯‡å¸–å­åŸå‰µçš„åˆ†é¡é™£åˆ—ã€‚

# ä½ çš„ä¿¡æ¯
-   ä½ çš„åå­—: ${postingChar.name}
-   ä½ çš„äººè¨­: ${postingChar.settings.aiPersona}

# ä½ çš„æ„›äººä¿¡æ¯
-   æ„›äººçš„åå­—: ${userNickname}
-   æ„›äººçš„äººè¨­: ${userPersona}

# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:
{
  "title": "é—œæ–¼ä»–ç¡è¦ºæ™‚çš„å°ç¿’æ…£",
  "content": "å·å·å‘Šè¨´ä½ å€‘ï¼Œ${userNickname}ç¡è¦ºçš„æ™‚å€™å–œæ­¡æŠ±è‘—æ•é ­çš„ä¸€è§’...",
  "categories": ["ç”œèœœæ—¥å¸¸", "å°ç¿’æ…£"],
  "comments": [
    {"author": "è·¯äººA", "content": "å“‡ï¼Œå¥½ç”œï¼"}
  ]
}
`;
    // --- â–²â–²â–² æ›´æ–°çµæŸ â–²â–²â–² ---

    const messagesForApi = [{ role: 'user', content: prompt }];
    
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });
        
        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const postData = JSON.parse(cleanedContent);

        if (postData.title && postData.content) {
            // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜åˆ†é¡è³‡æ–™ ---
            const newPost = {
                groupId: groupId,
                title: postData.title,
                content: postData.content,
                author: postingChar.name,
                timestamp: Date.now(),
                categories: postData.categories || [] // ä¿å­˜åˆ†é¡
            };
            // --- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² ---
            
            const postId = await db.forumPosts.add(newPost);
            
            if (postData.comments && Array.isArray(postData.comments)) {
                const commentsToAdd = postData.comments.map((c, i) => ({ postId, author: c.author, content: c.content, timestamp: Date.now() + i + 1 }));
                await db.forumComments.bulkAdd(commentsToAdd);
            }

            await renderGroupPosts(groupId);
            await showCustomAlert("ç™¼ä½ˆæˆåŠŸï¼", `â€œ${postingChar.name}â€ç™¼ä½ˆäº†ä¸€æ¢æ–°çš„å¤¢å¢ƒã€‚`);
        } else {
            throw new Error("AIè¿”å›çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå¤¢è§’å¸–å­å¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * å¡”ç¾…ç‰Œå åœåŠŸèƒ½æ ¸å¿ƒ
 */
let activeTarotReading = null; // ç”¨æ–¼æš«å­˜ç•¶å‰å åœçš„çµæœ

// ç‰Œé™£ä¿¡æ¯
const TAROT_SPREADS = {
    single: { name: 'å–®å¼µç‰Œ - å¿«é€ŸæŒ‡å¼•', count: 1, positions: ['æ ¸å¿ƒæŒ‡å¼•'] },
    three_past_present_future: { name: 'ä¸‰å¼µç‰Œ - éå»/ç¾åœ¨/æœªä¾†', count: 3, positions: ['éå»', 'ç¾åœ¨', 'æœªä¾†'] },
    three_situation_challenge_advice: { name: 'ä¸‰å¼µç‰Œ - æƒ…å¢ƒ/æŒ‘æˆ°/å»ºè­°', count: 3, positions: ['æƒ…å¢ƒ', 'æŒ‘æˆ°', 'å»ºè­°'] },
    celtic_cross: { name: 'å‡±çˆ¾ç‰¹åå­— - æ·±åº¦åˆ†æ', count: 10, positions: ['ç¾ç‹€', 'æŒ‘æˆ°', 'æ ¹åŸº', 'éå»', 'ç›®æ¨™', 'æœªä¾†', 'è‡ªæˆ‘èªçŸ¥', 'å¤–éƒ¨å½±éŸ¿', 'å¸Œæœ›èˆ‡ææ‡¼', 'æœ€çµ‚çµæœ'] }
};

// æ‰“é–‹å¡”ç¾…ç‰Œå åœä¸»æ¨¡æ…‹æ¡†
function openTarotModal() {
    document.getElementById('tarot-divination-modal').classList.add('visible');
    // é è¨­é¡¯ç¤ºè¨­å®šä»‹é¢
    document.getElementById('tarot-setup-view').style.display = 'block';
    document.getElementById('tarot-result-view').style.display = 'none';
    document.getElementById('tarot-history-view').style.display = 'none';
    // æ¸…ç©ºè¼¸å…¥æ¡†
    document.getElementById('tarot-question-input').value = '';
}

// åŸ·è¡ŒæŠ½ç‰Œé‚è¼¯
function handleDrawCards() {
    const question = document.getElementById('tarot-question-input').value.trim();
    const spreadType = document.getElementById('tarot-spread-select').value;
    const orientation = document.querySelector('input[name="tarot-orientation"]:checked').value;
    
    if (!question) {
        alert('è«‹è¼¸å…¥æ‚¨çš„å•é¡Œæˆ–é—œæ³¨é»ã€‚');
        return;
    }

    const spreadInfo = TAROT_SPREADS[spreadType];
    const deck = [...TAROT_DECK];

    // æ´—ç‰Œ
    for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
    }

    // æŠ½ç‰Œ
    const drawnCardsRaw = deck.slice(0, spreadInfo.count);
    const drawnCards = drawnCardsRaw.map((card, index) => {
        const isReversed = orientation === 'reversed' && Math.random() < 0.5;
        return {
            ...card,
            isReversed: isReversed,
            position: spreadInfo.positions[index]
        };
    });

    activeTarotReading = {
        question: question,
        spread: spreadInfo,
        cards: drawnCards,
        timestamp: Date.now()
    };
    
    displayTarotResults(activeTarotReading);
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ displayTarotResults å‡½æ•¸ â–¼â–¼â–¼
// é¡¯ç¤ºå åœçµæœ (ç´”æ–‡å­—ç‰ˆ)
function displayTarotResults(reading) {
    const displayEl = document.getElementById('tarot-result-display');
    displayEl.innerHTML = ''; // æ¸…ç©º

    // é¡¯ç¤ºå•é¡Œ
    const questionEl = document.createElement('div');
    questionEl.className = 'tarot-result-question';
    questionEl.textContent = `æ‚¨çš„å•é¡Œæ˜¯ï¼šâ€œ${reading.question}â€`;
    displayEl.appendChild(questionEl);
    
    const container = document.createElement('div');
    container.className = 'tarot-spread-container';

    reading.cards.forEach(card => {
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'tarot-card-wrapper';
        
        cardWrapper.innerHTML = `
            <div class="tarot-card-position">[${card.position}]</div>
            <div class="tarot-card-name">${card.name} ${card.isReversed ? '(é€†ä½)' : '(æ­£ä½)'}</div>
        `;
        container.appendChild(cardWrapper);
    });
    
    displayEl.appendChild(container);

    // åˆ‡æ›è¦–åœ–
    document.getElementById('tarot-setup-view').style.display = 'none';
    document.getElementById('tarot-result-view').style.display = 'flex';
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šã€AIæ™ºèƒ½è§£è®€æœ€çµ‚ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ sendTarotReadingToChat å‡½æ•¸ â–¼â–¼â–¼
async function sendTarotReadingToChat() {
    if (!activeTarotReading || !state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½æ‰èƒ½è§¸ç™¼AIè§£è®€å“¦ï¼');
        return;
    }

    // 1. é—œé–‰å½ˆçª—ï¼Œä¸¦é¡¯ç¤ºâ€œæ­£åœ¨è§£è®€â€çš„æç¤º
    document.getElementById('tarot-divination-modal').classList.remove('visible');
    await showCustomAlert("è«‹ç¨å€™...", "å¡”ç¾…å¸«æ­£åœ¨ç‚ºä½ é€£æ¥æ˜Ÿè¾°ï¼Œè§£è®€ç‰Œé¢...");

    try {
        const reading = activeTarotReading;
        
        // 2. ã€å…¨æ–°å„ªåŒ–ã€‘çµ¦â€œå¡”ç¾…å¸«AIâ€ä¸€å€‹æ›´å°ˆæ¥­ã€æ›´çµæ§‹åŒ–çš„æŒ‡ä»¤ (Prompt)
        const cardDetails = reading.cards.map(card => {
            const orientation = card.isReversed ? 'é€†ä½' : 'æ­£ä½';
            const meaning = card.isReversed ? card.reversed : card.upright;
            return `- ${card.position}: ${card.name} (${orientation})ï¼Œè±¡å¾µ: ${meaning}`;
        }).join('\n');

        const tarotMasterPrompt = `
# è§’è‰²
ä½ æ˜¯ä¸€ä½ä¸–ç•Œç´šçš„å¡”ç¾…ç‰Œè§£è®€å¤§å¸«ï¼Œä»¥æ·±åˆ»çš„æ´å¯ŸåŠ›ã€æ¸…æ™°çš„è¡¨é”å’Œå¯Œæœ‰åŒæƒ…å¿ƒçš„æŒ‡å¼•è€Œèåã€‚

# æ ¸å¿ƒä»»å‹™
ç‚ºä½¿ç”¨è€…æä¾›ä¸€æ¬¡å…¨é¢ã€çµæ§‹åŒ–ä¸”æ˜“æ–¼ç†è§£çš„å¡”ç¾…ç‰Œè§£è®€ã€‚ä½ çš„è§£è®€å¿…é ˆåš´æ ¼éµå¾ªä¸‹é¢çš„è¼¸å‡ºçµæ§‹ã€‚

# è¼¸å‡ºçµæ§‹ (å¿…é ˆåš´æ ¼éµå®ˆ)
ä½ çš„å›ç­”å¿…é ˆåŒ…å«ä»¥ä¸‹ä¸‰å€‹éƒ¨åˆ†ï¼Œä¸¦ä½¿ç”¨MarkdownåŠ ç²—æ¨™é¡Œä¾†åˆ†éš”ï¼š

1.  **âœ¨ ç¶œåˆè§£è®€ (Overall Interpretation):**
    é¦–å…ˆï¼Œæ ¹æ“šæ‰€æœ‰ç‰Œé¢çš„æ•´é«”æ„Ÿè¦ºï¼Œçµ¦å‡ºä¸€å€‹é«˜åº¦æ¦‚æ‹¬çš„ã€1-2å¥è©±çš„æ ¸å¿ƒçµè«–æˆ–æ°›åœæè¿°ã€‚

2.  **ğŸƒ ç‰Œé¢è©³è§£ (Card Details):**
    ç„¶å¾Œï¼Œé€ä¸€åˆ†ææ¯ä¸€å¼µç‰Œã€‚å°æ–¼æ¯ä¸€å¼µç‰Œï¼Œä½ å¿…é ˆï¼š
    -   ä½¿ç”¨æ ¼å¼ \`**[ç‰Œä½åç¨±] - [ç‰Œå] ([æ­£ä½/é€†ä½])**\` ä½œç‚ºå°æ¨™é¡Œã€‚
    -   è©³ç´°è§£é‡‹é€™å¼µç‰Œåœ¨é€™å€‹ç‰¹å®šç‰Œä½ä¸Šï¼Œæ˜¯å¦‚ä½•å›æ‡‰ç”¨æˆ¶çš„å•é¡Œçš„ã€‚
    -   å°‡ç‰Œçš„è±¡å¾µæ„ç¾©èˆ‡ç”¨æˆ¶çš„å…·é«”æƒ…å¢ƒï¼ˆå•é¡Œï¼‰ç·Šå¯†çµåˆèµ·ä¾†é€²è¡Œåˆ†æã€‚

3.  **ğŸ’¡ æ ¸å¿ƒå»ºè­° (Key Advice):**
    æœ€å¾Œï¼Œç¶œåˆæ‰€æœ‰ç‰Œçš„è³‡è¨Šï¼Œç‚ºä½¿ç”¨è€…æä¾›ä¸€å€‹æ˜ç¢ºã€å…·é«”ã€å¯æ“ä½œçš„è¡Œå‹•å»ºè­°æˆ–å¿ƒæ…‹æŒ‡å¼•ã€‚

# æŒ‡å°åŸå‰‡
- **æ•…äº‹æ€§**: å°‡æ‰€æœ‰ç‰Œçš„å«ç¾©ç·¨ç¹”æˆä¸€å€‹é€£è²«çš„æ•˜äº‹ï¼Œè€Œä¸æ˜¯ç°¡å–®åœ°ç¾…åˆ—é—œéµå­—ã€‚
- **ç›¸é—œæ€§**: å§‹çµ‚å°‡è§£è®€ç›´æ¥èˆ‡ç”¨æˆ¶æå‡ºçš„å…·é«”å•é¡Œè¯ç¹«èµ·ä¾†ã€‚
- **æ¸…æ™°æ˜“æ‡‚**: é¿å…ä½¿ç”¨éæ–¼ç¥ç§˜æˆ–å°ˆæ¥­çš„è¡“èªã€‚ç”¨å¹³å¯¦çš„èªè¨€è§£é‡‹è¤‡é›œçš„æ¦‚å¿µã€‚
- **æ·±åº¦è€Œéç¾…åˆ—**: çµ•å°ä¸è¦åªæ˜¯é‡è¤‡æˆ‘æä¾›çµ¦ä½ çš„â€œè±¡å¾µâ€é—œéµå­—ã€‚ä½ å¿…é ˆåœ¨é€™äº›é—œéµå­—çš„åŸºç¤ä¸Šé€²è¡Œç¶œåˆã€æç…‰å’Œæ·±åŒ–ï¼Œçµ¦å‡ºä½ ä½œç‚ºå¤§å¸«çš„ç¨ç‰¹è¦‹è§£ã€‚

# å åœä¿¡æ¯
- **ç”¨æˆ¶çš„å•é¡Œ**: "${reading.question}"
- **ä½¿ç”¨çš„ç‰Œé™£**: ${reading.spread.name}
- **æŠ½åˆ°çš„ç‰ŒåŠåŸºç¤å«ç¾©**:
${cardDetails}

# æœ€çµ‚æŒ‡ä»¤
ä½ çš„æœ€çµ‚è¼¸å‡ºã€åªèƒ½æ˜¯ã€‘å®Œæ•´çš„ã€æ ¼å¼åŒ–å¾Œçš„è§£è®€æ–‡æœ¬ã€‚ä¸è¦æ·»åŠ ä»»ä½•â€œå¥½çš„ï¼Œé€™æ˜¯ä½ çš„è§£è®€ï¼šâ€ä¹‹é¡çš„å°è©±æ€§é–‹å ´ç™½ã€‚
`;

        // 3. ç™¼èµ·APIèª¿ç”¨ï¼Œè®“AIæ‰®æ¼”å¡”ç¾…å¸«
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: tarotMasterPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, tarotMasterPrompt, messagesForApi, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.7 })
            });

        if (!response.ok) {
            throw new Error(`APIè«‹æ±‚å¤±æ•—: ${await response.text()}`);
        }
        
        const data = await response.json();
        const interpretation = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).trim();

        // 4. å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„â€œç³»çµ±è§£è®€â€æ¶ˆæ¯
        const systemMessageVisible = {
            role: 'system',
            type: 'pat_message', // è¤‡ç”¨å±…ä¸­ç°è‰²æ°£æ³¡æ¨£å¼
            content: `ğŸ”® **å¡”ç¾…ç‰Œè§£è®€** ğŸ”®\n\n**æ‚¨çš„å•é¡Œ**ï¼šâ€œ${reading.question}â€\n\n${interpretation}`,
            timestamp: Date.now()
        };
        chat.history.push(systemMessageVisible);
        appendMessage(systemMessageVisible, chat);

        // 5. å‰µå»ºçµ¦è§’è‰²Charçœ‹çš„éš±è—æŒ‡ä»¤
        const hiddenInstruction = {
            role: 'system',
            content: `[ç³»çµ±æŒ‡ä»¤ï¼šå‰›å‰›ç³»çµ±ç‚ºä½¿ç”¨è€…é€²è¡Œäº†ä¸€æ¬¡å¡”ç¾…ç‰Œå åœï¼Œè§£è®€çµæœæ˜¯ï¼šâ€œ${interpretation}â€ã€‚ç¾åœ¨ï¼Œè«‹ä½ ä»¥è§’è‰²çš„èº«ä»½ï¼Œå’Œç”¨æˆ¶ä¸€èµ·è¨è«–é€™å€‹çµæœã€‚]`,
            timestamp: Date.now() + 1, // ç¢ºä¿æ™‚é–“æˆ³è¨˜åœ¨å¾Œ
            isHidden: true
        };
        chat.history.push(hiddenInstruction);

        // 6. ä¿å­˜æ‰€æœ‰è³‡æ–™
        await saveTarotReading(activeTarotReading);
        await db.chats.put(chat);
        renderChatList();
        
        // 7. ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘åœ¨é€™è£¡åˆªé™¤äº† triggerAiResponse()ï¼Œä¸å†è‡ªå‹•è§¸ç™¼Charï¼
        
        activeTarotReading = null;

    } catch (error) {
        console.error("å¡”ç¾…ç‰ŒAIè§£è®€å¤±æ•—:", error);
        await showCustomAlert('è§£è®€å¤±æ•—', `æŠ±æ­‰ï¼Œé€£æ¥å¡”ç¾…å¸«æ™‚å‡ºç¾äº†ä¸€é»å•é¡Œï¼š\n\n${error.message}`);
        activeTarotReading = null;
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// ä¿å­˜å åœè¨˜éŒ„åˆ°è³‡æ–™åº«
async function saveTarotReading(reading) {
    // ç‚ºäº†ç¯€çœç©ºé–“ï¼Œæˆ‘å€‘åªä¿å­˜è§£è®€æ–‡æœ¬ï¼Œè€Œä¸æ˜¯æ•´å€‹ç‰Œçµ„å°è±¡
    const interpretationText = `ç‰Œé™£: ${reading.spread.name}\n` + reading.cards.map((card, index) => {
        const orientationText = card.isReversed ? 'é€†ä½' : 'æ­£ä½';
        const meaning = card.isReversed ? card.reversed : card.upright;
        return `[${card.position}]: ${card.name} (${orientationText}) - ${meaning}`;
    }).join('\n');
    
    await db.tarotReadings.add({
        question: reading.question,
        interpretation: interpretationText,
        timestamp: reading.timestamp
    });
}

// æ‰“é–‹æ­·å²è¨˜éŒ„ä»‹é¢
async function openTarotHistory() {
    const readings = await db.tarotReadings.orderBy('timestamp').reverse().toArray();
    renderTarotHistory(readings);
    document.getElementById('tarot-setup-view').style.display = 'none';
    document.getElementById('tarot-history-view').style.display = 'flex';
}

// æ¸²æŸ“æ­·å²è¨˜éŒ„æ¸…å–®
function renderTarotHistory(readings) {
    const listEl = document.getElementById('tarot-history-list');
    listEl.innerHTML = '';
    if (readings.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">é‚„æ²’æœ‰å åœæ­·å²å“¦</p>';
        return;
    }
    readings.forEach(reading => {
        const item = document.createElement('div');
        item.className = 'tarot-history-item';
        item.innerHTML = `
            <div class="question">${reading.question}</div>
            <div class="details">${new Date(reading.timestamp).toLocaleString()}</div>
            <button class="tarot-history-delete-btn" data-id="${reading.id}">Ã—</button>
        `;
        listEl.appendChild(item);
    });
}

// åˆªé™¤ä¸€æ¢æ­·å²è¨˜éŒ„
async function deleteTarotReading(readingId) {
    const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢å åœæ­·å²å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.tarotReadings.delete(readingId);
        openTarotHistory(); // é‡æ–°è¼‰å…¥æ­·å²è¨˜éŒ„
    }
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™å€‹æ–°å‡½æ•¸é»è²¼åˆ° renderLSLetters å‡½æ•¸çš„ä¸‹æ–¹ â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æƒ…ä¾¶ç©ºé–“å°ˆå±¬éŸ³æ¨‚æ’­æ”¾æ©Ÿçš„CSSæ¨£å¼ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“â€œåˆ†äº«â€åˆ—è¡¨ (ç„¡å°é¢ï¼Œå¸¶ç°¡ä»‹å’Œæ„Ÿæƒ³ç‰ˆ)
 */
function renderLSShares(shares, chat) {
    const listEl = document.getElementById('ls-shares-list');
    listEl.innerHTML = '';
    if (!shares || shares.length === 0) {
        listEl.innerHTML = '<p class="ls-empty-placeholder">é€™è£¡é‚„æ²’æœ‰ä»»ä½•åˆ†äº«å“¦~</p>';
        return;
    }

    [...shares].reverse().forEach(share => {
        const item = document.createElement('div');
        item.className = 'ls-list-item ls-share-item';
        item.dataset.shareData = JSON.stringify(share);

        const typeText = { song: 'æ­Œæ›²', movie: 'é›»å½±', book: 'æ›¸ç±', game: 'éŠæˆ²' }[share.shareType] || 'åˆ†äº«';
        const authorName = share.author === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ï¼šæˆ‘å€‘é‡æ§‹äº†â€œæ‘˜è¦â€éƒ¨åˆ†çš„é‚è¼¯ â–¼â–¼â–¼
        let summaryHtml = '';
        
        // 1. å¦‚æœæ˜¯æ­Œæ›²ï¼Œé¡¯ç¤ºæ­Œæ‰‹
        if (share.shareType === 'song' && share.artist) {
            summaryHtml += `<p style="margin:0; font-weight: 500;"><strong>æ­Œæ‰‹:</strong> ${share.artist}</p>`;
        }
        
        // 2. å¦‚æœæœ‰ç°¡ä»‹ (æ›¸ç±å’Œé›»å½±)ï¼Œå°±é¡¯ç¤ºç°¡ä»‹
        if (share.summary) {
            summaryHtml += `<p style="margin:0; margin-top: 4px;"><strong>ç°¡ä»‹:</strong> ${share.summary.replace(/\n/g, '<br>')}</p>`;
        }
        
        // 3. å¦‚æœæœ‰æ„Ÿæƒ³ï¼Œå°±é¡¯ç¤ºæ„Ÿæƒ³
        if (share.thoughts) {
            summaryHtml += `<p style="margin:0; margin-top: 4px; color: #8a8a8a; font-style: italic;"><strong>æ„Ÿæƒ³:</strong> â€œ${share.thoughts}â€</p>`;
        }
        
        // 4. å¦‚æœå•¥éƒ½æ²’æœ‰ï¼Œçµ¦ä¸€å€‹é»˜èªæç¤º
        if (!summaryHtml) {
            summaryHtml = '<p style="margin:0; color: #8a8a8a;">æš«ç„¡æ›´å¤šè³‡è¨Š</p>';
        }
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘é€™è£¡çš„ç¯„æœ¬å·²ç¶“ç§»é™¤äº†<img>æ¨™ç±¤
        item.innerHTML = `
            <div class="share-info">
                <div class="title">
                    <span class="share-type ${share.shareType}">${typeText}</span>
                    ${share.title}
                </div>
                <div class="summary">${summaryHtml}</div>
                <div class="meta">
                    ç”± ${authorName} åˆ†äº«æ–¼ ${formatPostTimestamp(share.timestamp)}
                </div>
            </div>
        `;
        listEl.appendChild(item);
    });
}



// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ open... å’Œ render... å››å€‹å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘ç•¶ä½¿ç”¨è€…é»æ“Šä¸»è¢å¹•çš„â€œæƒ…ä¾¶ç©ºé–“â€Appæ™‚è§¸ç™¼
 */
async function openLoversSpaceEntry() {
    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    if (singleChats.length === 0) {
        alert("ä½ é‚„æ²’æœ‰ä»»ä½•å¯ä»¥å»ºç«‹æƒ…ä¾¶ç©ºé–“çš„è§’è‰²å“¦ï¼Œå…ˆå»å‰µå»ºä¸€å€‹å§ï¼");
        return;
    }
    if (singleChats.length === 1) {
        openLoversSpace(singleChats[0].id);
    } else {
        openCharSelectorForLoversSpace();
    }
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šä»£ç¢¼æ›¿æ› â–¼â–¼â–¼
/**
 * æ‰“é–‹ç”¨æ–¼æƒ…ä¾¶ç©ºé–“çš„è§’è‰²é¸æ“‡å½ˆçª— (å·²æ›´æ–°ï¼Œæœƒé¡¯ç¤ºé–‹å•Ÿç‹€æ…‹)
 */
async function openCharSelectorForLoversSpace() {
    const modal = document.getElementById('ls-char-selector-modal');
    const listEl = document.getElementById('ls-char-selector-list');
    listEl.innerHTML = '';
    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    
    singleChats.forEach(chat => {
        const item = document.createElement('div');
        item.className = 'chat-list-item'; // è¤‡ç”¨ç¾æœ‰æ¨£å¼
        item.style.borderBottom = '1px solid var(--border-color)';
        item.dataset.chatId = chat.id;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æª¢æŸ¥è§’è‰²æ˜¯å¦å·²é–‹é€šæƒ…ä¾¶ç©ºé–“
        const isLoversSpaceActive = !!chat.loversSpaceData;
        const statusText = isLoversSpaceActive 
            ? '<span style="color: green; font-weight: bold;">å·²é–‹é€š</span>' 
            : '<span style="color: #8a8a8a;">æœªé–‹å•Ÿ</span>';

        item.innerHTML = `
            <img src="${chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <div class="info" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <span class="name">${chat.name}</span>
                <div class="last-msg">${statusText}</div>
            </div>
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * ã€æ ¸å¿ƒã€‘æ‰“é–‹æŒ‡å®šè§’è‰²çš„æƒ…ä¾¶ç©ºé–“
 */
async function openLoversSpace(charId) {
    activeLoversSpaceCharId = charId;
    const chat = state.chats[charId];
    if (!chat) return;

    // å¦‚æœé€™å€‹è§’è‰²é‚„æ²’æœ‰æƒ…ä¾¶ç©ºé–“è³‡æ–™ï¼Œå°±ç‚ºä»–åˆå§‹åŒ–ä¸€å€‹
    if (!chat.loversSpaceData) {
chat.loversSpaceData = {
    background: 'https://i.postimg.cc/k495F4W5/profile-banner.jpg',
    relationshipStartDate: null,
    moments: [],
    albums: [],
    photos: [],
    loveLetters: [],
    shares: [],
    questions: [],
    emotionDiaries: {} // <--- å°±æ˜¯æ–°å¢äº†é€™ä¸€è¡Œï¼
};
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        await db.chats.put(chat);
    }

    await renderLoversSpace(chat);
    showScreen('lovers-space-screen');
}

/**
 * ã€å…¨æ–°ã€‘è¨ˆç®—ä¸¦æ›´æ–°â€œåœ¨ä¸€èµ·â€çš„å¤©æ•¸
 */
function updateLoversSpaceDaysCounter(chat) {
    const counterEl = document.getElementById('ls-days-counter');
    const startDateString = chat.loversSpaceData.relationshipStartDate;

    if (startDateString) {
        const startDate = new Date(startDateString);
        const today = new Date();
        // ä¿®æ­£æ™‚å€å•é¡Œï¼Œåªæ¯”è¼ƒæ—¥æœŸ
        startDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);

        const diffTime = Math.abs(today - startDate);
        // åŠ 1ï¼Œå› ç‚ºç¬¬ä¸€å¤©ä¹Ÿç®—ä¸€å¤©
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        counterEl.textContent = `æˆ‘å€‘å·²ç¶“åœ¨ä¸€èµ· ${diffDays} å¤©äº†`;
    } else {
        counterEl.innerHTML = `<a>é»æ“Šå³ä¸Šè§’â€œè¨­ç½®â€ä¾†è¨˜éŒ„ç¬¬ä¸€å¤©å§</a>`;
    }
}

/**
 * ã€æ¸²æŸ“å¼•æ“ - å·²æ›´æ–°ã€‘æ ¹æ“šè§’è‰²è³‡æ–™ï¼Œæ¸²æŸ“æ•´å€‹æƒ…ä¾¶ç©ºé–“ä»‹é¢
 */
async function renderLoversSpace(chat) {
    // æ¸²æŸ“é ­éƒ¨
    document.getElementById('lovers-space-screen').style.backgroundImage = `url(${chat.loversSpaceData.background})`;
    
    // é€™æ˜¯ä½ æƒ³è¦çš„ user & char æ¨™é¡Œ
    const userNickname = state.qzoneSettings.nickname || '{{user}}';
    document.getElementById('ls-char-name').textContent = `${userNickname} & ${chat.name}`;
    
    document.getElementById('ls-user-avatar').src = chat.settings.myAvatar || defaultAvatar;
    document.getElementById('ls-char-avatar').src = chat.settings.aiAvatar || defaultAvatar;
    
    // èª¿ç”¨æ–°å‡½æ•¸ä¾†æ›´æ–°å¤©æ•¸
    updateLoversSpaceDaysCounter(chat);
    
    // é è¨­é¡¯ç¤ºç¬¬ä¸€å€‹é ç°½
    switchLoversSpaceTab('ls-moments-view');
// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼æ›¿æ› â–¼â–¼â–¼
// é€™æ˜¯ä½ çš„èˆŠä»£ç¢¼
document.querySelector('.ls-tab-item.active').classList.remove('active');
document.querySelector('.ls-tab-item[data-view="ls-moments-view"]').classList.add('active');



    // æ¸²æŸ“å„å€‹é ç°½çš„å…§å®¹
    renderLSMoments(chat.loversSpaceData.moments, chat);
    renderLSPhotos(chat.loversSpaceData.photos, chat);
    renderLSLetters(chat.loversSpaceData.loveLetters, chat);
    renderLSShares(chat.loversSpaceData.shares, chat);
    document.getElementById('ls-shares-list').innerHTML = '<p class="ls-empty-placeholder">Taé‚„æ²’æœ‰åˆ†äº«ä»»ä½•å…§å®¹~</p>';
}

// â–²â–²â–² æ›¿æ›åˆ°é€™è£¡çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ switchLoversSpaceTab å‡½æ•¸ â–¼â–¼â–¼
/**
 * åˆ‡æ›æƒ…ä¾¶ç©ºé–“çš„é ç°½
 */
function switchLoversSpaceTab(viewId) {
    document.querySelectorAll('.ls-view').forEach(v => v.style.display = 'none'); // ä½¿ç”¨styleä¾†éš±è—
    const targetView = document.getElementById(viewId);
    if (targetView) targetView.style.display = 'block'; // ä½¿ç”¨styleä¾†é¡¯ç¤º

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ“šç•¶å‰é ç°½ï¼Œé¡¯ç¤ºå°æ‡‰çš„æµ®å‹•æŒ‰éˆ•
    const fabMoment = document.getElementById('ls-add-moment-btn');
    const fabAlbum = document.getElementById('ls-add-album-btn');
    const fabLetter = document.getElementById('ls-add-letter-btn');
    const fabQuestion = document.getElementById('ls-add-question-btn');
    
    // å…ˆéš±è—æ‰€æœ‰
    if(fabMoment) fabMoment.style.display = 'none';
    if(fabAlbum) fabAlbum.style.display = 'none';
    if(fabLetter) fabLetter.style.display = 'none';
    if(fabQuestion) fabQuestion.style.display = 'none';

    // å†æ ¹æ“šviewIdé¡¯ç¤ºå°æ‡‰çš„
    if (viewId === 'ls-moments-view' && fabMoment) fabMoment.style.display = 'block';
    else if (viewId === 'ls-album-view' && fabAlbum) fabAlbum.style.display = 'block';
    else if (viewId === 'ls-letters-view' && fabLetter) fabLetter.style.display = 'block';
    else if (viewId === 'ls-questions-view' && fabQuestion) fabQuestion.style.display = 'block';
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * ã€å…¨æ–°ã€‘è™•ç†æ›´æ›æƒ…ä¾¶ç©ºé–“èƒŒæ™¯çš„é‚è¼¯
 */
async function handleChangeLoversSpaceBackground() {
    if (!activeLoversSpaceCharId) return;

    // è¤‡ç”¨å·²æœ‰çš„åŠŸèƒ½å½ˆçª—ï¼Œè®“ç”¨æˆ¶é¸æ“‡
    const choice = await showChoiceModal("æ›´æ›ç©ºé–“èƒŒæ™¯", [
        { text: 'ğŸ“ å¾æœ¬åœ°ä¸Šå‚³', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç¶²è·¯URL', value: 'url' }
    ]);

    let newBackgroundUrl = null;

    if (choice === 'local') {
        // è¤‡ç”¨å·²æœ‰çš„æœ¬åœ°åœ–ç‰‡ä¸Šå‚³å‡½æ•¸
        newBackgroundUrl = await uploadImageLocally();
    } else if (choice === 'url') {
        // è¤‡ç”¨å·²æœ‰çš„URLè¼¸å…¥å½ˆçª—
        const currentBg = state.chats[activeLoversSpaceCharId].loversSpaceData.background;
        newBackgroundUrl = await showCustomPrompt("æ›´æ›èƒŒæ™¯", "è«‹è¼¸å…¥æ–°çš„åœ–ç‰‡URL", currentBg, "url");
    }

    // å¦‚æœç²å–åˆ°äº†æ–°çš„URL
    if (newBackgroundUrl && newBackgroundUrl.trim()) {
        const chat = state.chats[activeLoversSpaceCharId];
        chat.loversSpaceData.background = newBackgroundUrl.trim();
        
        // ä¿å­˜åˆ°è³‡æ–™åº«
        await db.chats.put(chat);
        
        // ç«‹åˆ»é‡æ–°æ¸²æŸ“æƒ…ä¾¶ç©ºé–“ä»¥æ‡‰ç”¨æ–°èƒŒæ™¯
        await renderLoversSpace(chat);
        
        alert('æƒ…ä¾¶ç©ºé–“èƒŒæ™¯å·²æ›´æ–°ï¼');
    } else if (newBackgroundUrl !== null) { // ç”¨æˆ¶é»æ“Šäº†ç¢ºå®šä½†æ²’è¼¸å…¥å…§å®¹
         alert("è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„URLæˆ–é¸æ“‡ä¸€å€‹æª”ï¼");
    }
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

/**
 * æ¸²æŸ“â€œèªªèªªâ€åˆ—è¡¨ (V2 - å·²æ·»åŠ è©•è«–å’Œåˆªé™¤åŠŸèƒ½)
 */
function renderLSMoments(moments, chat) {
    const listEl = document.getElementById('ls-moments-list');
    listEl.innerHTML = '';
    if (!moments || moments.length === 0) {
        listEl.innerHTML = '<p class="ls-empty-placeholder">é‚„æ²’æœ‰ä»»ä½•æ‚„æ‚„è©±ï¼Œå¿«ä¾†ç™¼ä½ˆç¬¬ä¸€æ¢å§ï¼</p>';
        return;
    }
    
    // æˆ‘å€‘éœ€è¦åŸå§‹çš„é™£åˆ—ç´¢å¼•ä¾†åšåˆªé™¤ï¼Œæ‰€ä»¥é€™è£¡ä¸ç”¨ [...moments].reverse()
    for (let i = moments.length - 1; i >= 0; i--) {
        const moment = moments[i];
        const originalIndex = i; // ä¿å­˜åŸå§‹ç´¢å¼•

        const isUser = moment.author === 'user';
        const authorName = isUser ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
        const authorAvatar = isUser ? chat.settings.myAvatar : chat.settings.aiAvatar;

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡æ§‹å»ºè©•è«–å€çš„HTML ---
        let commentsHtml = '';
        if (moment.comments && moment.comments.length > 0) {
            moment.comments.forEach((comment, commentIndex) => {
                commentsHtml += `
                    <div class="ls-comment-item">
                        <span class="commenter-name">${comment.author}:</span>
                        <span class="comment-text">${comment.text}</span>
                        <button class="ls-comment-delete-btn" data-moment-index="${originalIndex}" data-comment-index="${commentIndex}">Ã—</button>
                    </div>
                `;
            });
        }
        
        const card = document.createElement('div');
        card.className = 'ls-moment-card';
        // ã€é‡è¦ã€‘æŠŠèªªèªªçš„åŸå§‹ç´¢å¼•å­˜èµ·ä¾†ï¼Œæ–¹ä¾¿å¾Œé¢æ“ä½œ
        card.dataset.momentIndex = originalIndex; 
        
        // --- æ ¸å¿ƒä¿®æ”¹ï¼šåŠ å…¥æ–°çš„HTMLçµæ§‹ ---
        card.innerHTML = `
            <img src="${authorAvatar}" class="avatar">
            <div class="moment-main">
                <span class="author">${authorName}</span>
                <p class="content">${moment.content.replace(/\n/g, '<br>')}</p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="timestamp">${formatPostTimestamp(moment.timestamp)}</span>
                </div>
                
                <!-- â–¼â–¼â–¼ é€™æ˜¯æ–°å¢çš„æ•´å€‹åº•éƒ¨å€åŸŸ â–¼â–¼â–¼ -->
                <div class="ls-moment-footer">
                    <div class="ls-moment-comments-container">
                        ${commentsHtml}
                    </div>
                    <div class="ls-comment-input-area">
                        <input type="text" placeholder="æ·»åŠ è©•è«–...">
                        <button class="ls-comment-send-btn">ç™¼é€</button>
                    </div>
                </div>
                <!-- â–²â–²â–² æ–°å¢å€åŸŸçµæŸ â–²â–²â–² -->

            </div>
            <!-- â–¼â–¼â–¼ é€™æ˜¯æ–°å¢çš„èªªèªªåˆªé™¤æŒ‰éˆ• â–¼â–¼â–¼ -->
            <button class="ls-moment-delete-btn" title="åˆªé™¤é€™æ¢èªªèªª">Ã—</button>
        `;
        listEl.appendChild(card);
    }
}



// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ renderLSPhotos å‡½æ•¸ â–¼â–¼â–¼
/**
 * æ¸²æŸ“â€œç…§ç‰‡â€åˆ—è¡¨
 */
function renderLSPhotos(photos, chat) {
    const listEl = document.getElementById('ls-album-list');
    listEl.innerHTML = '';
    if (!photos || photos.length === 0) {
        listEl.innerHTML = '<p class="ls-empty-placeholder" style="grid-column: 1 / -1;">é‚„æ²’æœ‰ä»»ä½•ç…§ç‰‡ï¼Œé»æ“Šå³ä¸‹è§’â€œ+â€ä¸Šå‚³ç¬¬ä¸€å¼µå§ï¼</p>';
        return;
    }

    [...photos].reverse().forEach(photo => {
        const item = document.createElement('div');
        item.className = 'ls-album-item';
        
        // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨é€™è£¡ç‚ºæ•´å€‹é …ç›®æ·»åŠ æ™‚é–“æˆ³è¨˜ï¼Œæ–¹ä¾¿æˆ‘å€‘è­˜åˆ¥æ˜¯å“ªå¼µç…§ç‰‡
        item.dataset.timestamp = photo.timestamp; 

        const imageUrl = photo.type === 'image' 
            ? photo.url 
            : 'https://i.postimg.cc/KYr2qRCK/1.jpg';

        // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨ .cover å…§éƒ¨æ·»åŠ äº†åˆªé™¤æŒ‰éˆ•çš„HTML
        item.innerHTML = `
            <div class="cover" style="background-image: url(${imageUrl});">
                <button class="ls-photo-delete-btn">Ã—</button>
            </div>
        `;
        
        // ã€æ ¸å¿ƒä¿®æ”¹3ã€‘æˆ‘å€‘ä¸å†åœ¨é€™è£¡å–®ç¨ç¶å®šé»æ“Šäº‹ä»¶ï¼Œå°‡åœ¨æœ€å¾Œä¸€æ­¥çµ±ä¸€è™•ç†
        listEl.appendChild(item);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



/**
 * æ‰“é–‹å‰µå»ºèªªèªªçš„å½ˆçª—
 */
function openMomentCreator() {
    document.getElementById('ls-moment-content-input').value = '';
    document.getElementById('ls-create-moment-modal').classList.add('visible');
}

/**
 * ç”¨æˆ¶ç™¼ä½ˆèªªèªª (V2 - å·²æ·»åŠ commentsæ¬„ä½)
 */
async function handlePostMoment() {
    const content = document.getElementById('ls-moment-content-input').value.trim();
    if (!content) {
        alert("å…§å®¹ä¸èƒ½ç‚ºç©ºå“¦ï¼");
        return;
    }
    const chat = state.chats[activeLoversSpaceCharId];
    const newMoment = {
        author: 'user',
        content: content,
        timestamp: Date.now(),
        comments: [] // <-- æ ¸å¿ƒæ–°å¢ï¼šç‚ºæ–°èªªèªªå‰µå»ºä¸€å€‹ç©ºçš„è©•è«–é™£åˆ—
    };
    // ç¢ºä¿momentsé™£åˆ—å­˜åœ¨
    if (!chat.loversSpaceData.moments) {
        chat.loversSpaceData.moments = [];
    }
    chat.loversSpaceData.moments.push(newMoment);
    await db.chats.put(chat);
    
    renderLSMoments(chat.loversSpaceData.moments, chat);
    document.getElementById('ls-create-moment-modal').classList.remove('visible');
// â–¼â–¼â–¼ åœ¨ handlePostMoment å‡½æ•¸çš„æœ«å°¾ï¼Œé»è²¼ä¸‹é¢é€™å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼
// å‰µå»ºä¸€æ¢å°ç”¨æˆ¶éš±è—ï¼Œä½†å°AIå¯è¦‹çš„ç³»çµ±æ¶ˆæ¯
const hiddenMessage = {
    role: 'system',
    content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ï¼ˆ${chat.settings.myNickname || 'æˆ‘'}ï¼‰å‰›å‰›åœ¨æˆ‘å€‘çš„æƒ…ä¾¶ç©ºé–“ç™¼ä½ˆäº†ä¸€æ¢æ–°çš„èªªèªªï¼Œå…§å®¹æ˜¯ï¼šâ€œ${content}â€ã€‚è«‹ä½ æ ¹æ“šäººè¨­ï¼Œä½¿ç”¨ 'ls_comment' æŒ‡ä»¤å°é€™æ¢èªªèªªç™¼è¡¨ä½ çš„çœ‹æ³•ã€‚]`,
    timestamp: Date.now(),
    isHidden: true // é€™å€‹æ¨™è¨˜èƒ½è®“æ¶ˆæ¯å°ä½ éš±è—ï¼Œä½†AIèƒ½çœ‹è¦‹
};
chat.history.push(hiddenMessage);
await db.chats.put(chat); // å†æ¬¡ä¿å­˜ï¼Œç¢ºä¿éš±è—æ¶ˆæ¯è¢«å­˜å…¥

// ï¼ˆå¯é¸ï¼‰å¦‚æœä½ å¸Œæœ›AIåœ¨ä½ ç™¼å®Œèªªèªªå¾Œç«‹åˆ»å°±å»è©•è«–ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢é€™è¡Œçš„æ³¨é‡‹
// triggerAiResponse();
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
}


let tempUploadedPhotos = []; // æš«å­˜å¾…ä¸Šå‚³çš„ç…§ç‰‡
// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ openAlbumCreator å‡½æ•¸ â–¼â–¼â–¼
/**
 * æ‰“é–‹ä¸Šå‚³ç…§ç‰‡çš„å½ˆçª—
 */
function openAlbumCreator() {
    tempUploadedPhotos = [];
    document.getElementById('ls-album-modal-title').textContent = 'ä¸Šå‚³ç…§ç‰‡';
    // é‡ç½®æ‰€æœ‰è¼¸å…¥æ¡†å’Œé è¦½
    document.getElementById('ls-photo-preview-container').innerHTML = '';
    document.getElementById('ls-photo-desc-input').value = '';
    document.getElementById('ls-text-image-desc-input').value = '';
    document.getElementById('ls-photo-input').value = null;

    // é è¨­é¡¯ç¤ºâ€œä¸Šå‚³åœ–ç‰‡â€æ¨¡å¼
    document.getElementById('ls-switch-to-image-mode').click();

    document.getElementById('ls-create-album-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ handlePhotoSelection å‡½æ•¸ â–¼â–¼â–¼
/**
 * è™•ç†ç”¨æˆ¶é¸æ“‡ç…§ç‰‡å¾Œçš„é è¦½ (å–®å¼µç‰ˆ)
 */
function handlePhotoSelection(files) {
    const previewContainer = document.getElementById('ls-photo-preview-container');
    previewContainer.innerHTML = '';
    tempUploadedPhotos = [];
    
    const file = files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        const dataUrl = e.target.result;
        tempUploadedPhotos.push({ url: dataUrl }); // æš«å­˜base64
        
        // é¡¯ç¤ºé è¦½åœ–
        const previewItem = document.createElement('div');
        previewItem.className = 'ls-photo-preview-item';
        previewItem.innerHTML = `<img src="${dataUrl}">`;
        previewContainer.appendChild(previewItem);
    };
    reader.readAsDataURL(file);
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ handleConfirmAlbum å‡½æ•¸ â–¼â–¼â–²
/**
 * ç”¨æˆ¶ç¢ºèªä¸Šå‚³ç…§ç‰‡ (é€™æ˜¯ä¿®å¾©å¾Œçš„ç‰ˆæœ¬)
 */
async function handleConfirmAlbum() {
    const chat = state.chats[activeLoversSpaceCharId];
    if (!chat) return;

    // 1. å…ˆåˆ¤æ–·ç•¶å‰æ˜¯å“ªç¨®æ¨¡å¼
    const isImageMode = document.getElementById('ls-image-mode-content').classList.contains('active');
    let newPhoto;

    if (isImageMode) {
        // 2. å¦‚æœæ˜¯â€œä¸Šå‚³åœ–ç‰‡â€æ¨¡å¼ï¼ŒåŸ·è¡Œé€™è£¡çš„æª¢æŸ¥
        if (tempUploadedPhotos.length === 0) {
            alert("è«‹é¸æ“‡ä¸€å¼µç…§ç‰‡ï¼"); // åªæœ‰åœ¨é€™ç¨®æ¨¡å¼ä¸‹ï¼Œé€™å€‹æç¤ºæ‰æ˜¯æ­£ç¢ºçš„
            return;
        }
        const description = document.getElementById('ls-photo-desc-input').value.trim();
        if (!description) {
            alert("åœ–ç‰‡æè¿°ä¸èƒ½ç‚ºç©ºï¼");
            return;
        }
        newPhoto = {
            type: 'image',
            url: tempUploadedPhotos[0].url,
            description: description,
            timestamp: Date.now()
        };
    } else {
        // 3. å¦‚æœæ˜¯â€œä½¿ç”¨æ–‡å­—åœ–â€æ¨¡å¼ï¼ŒåŸ·è¡Œé€™è£¡çš„æª¢æŸ¥
        const description = document.getElementById('ls-text-image-desc-input').value.trim();
        if (!description) {
            alert("æ–‡å­—åœ–æè¿°ä¸èƒ½ç‚ºç©ºï¼");
            return;
        }
        newPhoto = {
            type: 'text_image',
            description: description,
            timestamp: Date.now()
        };
    }

    // 4. å¾ŒçºŒçš„ä¿å­˜å’Œåˆ·æ–°é‚è¼¯ä¿æŒä¸è®Š
    if (!chat.loversSpaceData.photos) {
        chat.loversSpaceData.photos = [];
    }

    chat.loversSpaceData.photos.push(newPhoto);
    await db.chats.put(chat);
    
    renderLSPhotos(chat.loversSpaceData.photos, chat);
    document.getElementById('ls-create-album-modal').classList.remove('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åˆªé™¤æƒ…ä¾¶ç©ºé–“ä¸­çš„ä¸€å¼µç…§ç‰‡
 */
async function handleDeleteLSPhoto(timestamp) {
    // å½ˆå‡ºç¢ºèªæ¡†ï¼Œé˜²æ­¢èª¤åˆª
    const confirmed = await showCustomConfirm(
        'åˆªé™¤ç…§ç‰‡',
        'ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[activeLoversSpaceCharId];
        if (!chat || !chat.loversSpaceData || !chat.loversSpaceData.photos) return;

        // å¾ç…§ç‰‡é™£åˆ—ä¸­éæ¿¾æ‰è¦åˆªé™¤çš„ç…§ç‰‡
        chat.loversSpaceData.photos = chat.loversSpaceData.photos.filter(p => p.timestamp !== timestamp);

        // ä¿å­˜æ›´æ–°å¾Œçš„èŠå¤©è³‡æ–™
        await db.chats.put(chat);

        // é‡æ–°æ¸²æŸ“ç…§ç‰‡åˆ—è¡¨ï¼Œè®“åˆªé™¤æ•ˆæœç«‹åˆ»ç”Ÿæ•ˆ
        renderLSPhotos(chat.loversSpaceData.photos, chat);

        alert('ç…§ç‰‡å·²åˆªé™¤ã€‚');
    }
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼ çš„æ­£ä¸‹æ–¹ â–¼â–¼â–¼ */

let activeLoveLetter = null; // ç”¨æ–¼æš«å­˜æ­£åœ¨æŸ¥çœ‹æˆ–å›å¾©çš„æƒ…æ›¸

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²æ·»åŠ åˆªé™¤æŒ‰éˆ•ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„ renderLSLetters å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“â€œæƒ…æ›¸â€åˆ—è¡¨ (å·²åŠ å…¥åˆªé™¤åŠŸèƒ½)
 */
function renderLSLetters(letters, chat) {
    const listEl = document.getElementById('ls-letters-list');
    listEl.innerHTML = ''; // å…ˆæ¸…ç©º
    if (!letters || letters.length === 0) {
        listEl.innerHTML = '<p class="ls-empty-placeholder">é‚„æ²’æœ‰ä»»ä½•æƒ…æ›¸ï¼Œé»æ“Šå³ä¸‹è§’â€œ+â€å¯«ä¸‹ç¬¬ä¸€å°å§ï¼</p>';
        return;
    }

    // å¾æ–°åˆ°èˆŠæ’åºé¡¯ç¤º
    [...letters].reverse().forEach(letter => {
        const item = document.createElement('div');
        item.className = 'ls-love-letter-item';
        item.dataset.letterId = letter.id;

        const svgIcon = `
            <svg class="letter-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 7.00005L10.2 11.65C11.2667 12.45 12.7333 12.45 13.8 11.65L20 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <rect x="2" y="5" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        `;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡åŠ å…¥äº†åˆªé™¤æŒ‰éˆ•çš„HTML
        item.innerHTML = `
            <!-- é€™æ˜¯æ–°å¢çš„åˆªé™¤æŒ‰éˆ• -->
            <button class="ls-letter-delete-btn" title="åˆªé™¤é€™å°æƒ…æ›¸">Ã—</button>

            ${svgIcon}
            <div class="letter-info">
                <div class="letter-recipient">
                    <img src="${letter.recipientAvatar}" class="avatar">
                    <span>To: ${letter.recipientName}</span>
                </div>
                <div class="letter-preview">${letter.content.substring(0, 30)}...</div>
            </div>
            <div class="letter-sender">
                <img src="${letter.senderAvatar}" class="avatar">
                <span>From: ${letter.senderName}</span>
            </div>
        `;
        listEl.appendChild(item);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹å¯«æƒ…æ›¸/å›ä¿¡çš„å½ˆçª—
 * @param {object | null} replyToLetter - å¦‚æœæ˜¯å›ä¿¡ï¼Œå‰‡å‚³å…¥è¢«å›å¾©çš„æƒ…æ›¸å°è±¡
 */
function openLoveLetterEditor(replyToLetter = null) {
    const modal = document.getElementById('ls-create-letter-modal');
    const titleEl = document.getElementById('ls-letter-modal-title');
    const recipientInput = document.getElementById('ls-letter-recipient-input');
    const contentInput = document.getElementById('ls-letter-content-input');
    
    const chat = state.chats[activeLoversSpaceCharId];
    
    if (replyToLetter) {
        // é€™æ˜¯å›ä¿¡
        titleEl.textContent = `å›ä¿¡çµ¦ ${replyToLetter.senderName}`;
        recipientInput.value = replyToLetter.senderName;
        contentInput.value = ''; // æ¸…ç©ºå…§å®¹
        contentInput.placeholder = `å›å¾© ${replyToLetter.senderName} çš„æƒ…æ›¸...`;
        // æš«å­˜è¢«å›å¾©çš„ä¿¡ï¼Œä»¥ä¾¿ç™¼é€æ™‚çŸ¥é“æ˜¯å›å¾©èª°
        modal.dataset.replyingTo = JSON.stringify(replyToLetter);
    } else {
        // é€™æ˜¯å¯«æ–°ä¿¡
        titleEl.textContent = `çµ¦ ${chat.name} å¯«ä¸€å°ä¿¡`;
        recipientInput.value = chat.name;
        contentInput.value = '';
        contentInput.placeholder = 'åœ¨é€™è£¡å¯«ä¸‹ä½ çš„å¿ƒæ„...';
        // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å›å¾©æ¨™è¨˜
        delete modal.dataset.replyingTo;
    }
    
    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶é»æ“Šâ€œå¯„å‡ºâ€æŒ‰éˆ•çš„é‚è¼¯
 */
async function handlePostLoveLetter() {
    const modal = document.getElementById('ls-create-letter-modal');
    const content = document.getElementById('ls-letter-content-input').value.trim();
    if (!content) {
        alert("æƒ…æ›¸å…§å®¹ä¸èƒ½ç‚ºç©ºå“¦ï¼");
        return;
    }

    const chat = state.chats[activeLoversSpaceCharId];
    const isReply = modal.dataset.replyingTo;
    
    let newLetter;

    if (isReply) {
        // å¦‚æœæ˜¯å›ä¿¡ï¼Œç™¼ä¿¡äººå’Œæ”¶ä¿¡äººè³‡è¨Šè¦åéä¾†
        const originalLetter = JSON.parse(isReply);
        newLetter = {
            id: 'letter_' + Date.now(),
            senderId: 'user',
            senderName: chat.settings.myNickname || 'æˆ‘',
            senderAvatar: chat.settings.myAvatar,
            recipientName: originalLetter.senderName, // æ”¶ä¿¡äººæ˜¯åŸä¿¡çš„ç™¼ä¿¡äºº
            recipientAvatar: originalLetter.senderAvatar,
            content: content,
            timestamp: Date.now()
        };
    } else {
        // å¦‚æœæ˜¯å¯«æ–°ä¿¡
        newLetter = {
            id: 'letter_' + Date.now(),
            senderId: 'user',
            senderName: chat.settings.myNickname || 'æˆ‘',
            senderAvatar: chat.settings.myAvatar,
            recipientName: chat.name, // æ”¶ä¿¡äººæ˜¯ç•¶å‰è§’è‰²
            recipientAvatar: chat.settings.aiAvatar,
            content: content,
            timestamp: Date.now()
        };
    }

    // ç¢ºä¿ loveLetters é™£åˆ—å­˜åœ¨
    if (!chat.loversSpaceData.loveLetters) {
        chat.loversSpaceData.loveLetters = [];
    }
    chat.loversSpaceData.loveLetters.push(newLetter);
    
    await db.chats.put(chat);
    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
// å¦‚æœæ˜¯ç”¨æˆ¶å¯«çš„ä¿¡ï¼Œå°±çµ¦AIç™¼ä¸€å€‹éš±è—çš„ç³»çµ±é€šçŸ¥
if (newLetter.senderId === 'user') {
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶å‰›å‰›åœ¨æƒ…ä¾¶ç©ºé–“çµ¦ä½ å¯«äº†ä¸€å°æƒ…æ›¸ï¼Œå…§å®¹æ˜¯ï¼šâ€œ${content}â€ã€‚è«‹ä½ æ ¹æ“šäººè¨­ï¼Œä½¿ç”¨ 'ls_letter' æŒ‡ä»¤çµ¦ä½¿ç”¨è€…å¯«ä¸€å°å›ä¿¡ã€‚]`,
        timestamp: Date.now(),
        isHidden: true // é€™å€‹æ¨™è¨˜èƒ½è®“æ¶ˆæ¯å°ä½ éš±è—ï¼Œä½†AIèƒ½çœ‹è¦‹
    };
    chat.history.push(hiddenMessage);
    await db.chats.put(chat); // å†æ¬¡ä¿å­˜ï¼Œç¢ºä¿éš±è—æ¶ˆæ¯è¢«å­˜å…¥
    
    // ï¼ˆå¯é¸ï¼‰å¦‚æœä½ å¸Œæœ›AIåœ¨ä½ ç™¼ä¿¡å¾Œç«‹åˆ»å›å¾©ï¼Œå¯ä»¥æŠŠä¸‹é¢é€™è¡Œçš„æ³¨é‡‹å»æ‰
    // triggerAiResponse(); 
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

    renderLSLetters(chat.loversSpaceData.loveLetters, chat);
    modal.classList.remove('visible');
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€ä½¿ç”¨å…¨æ–°ä¿¡ç´™å½ˆçª—ã€‘çš„æ–°ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ showLoveLetterDetail å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘é¡¯ç¤ºæƒ…æ›¸è©³æƒ… (ä¿¡ç´™æ¨£å¼ç‰ˆ)
 * @param {string} letterId - è¦é¡¯ç¤ºçš„æƒ…æ›¸çš„ID
 */
async function showLoveLetterDetail(letterId) {
    const chat = state.chats[activeLoversSpaceCharId];
    activeLoveLetter = chat.loversSpaceData.loveLetters.find(l => l.id === letterId);
    if (!activeLoveLetter) return;

    // ç²å–æ–°çš„ä¿¡ç´™å½ˆçª—å…ƒç´ 
    const modal = document.getElementById('ls-letter-viewer-modal');
    
    // å¡«å……æ‰€æœ‰è³‡æ–™
    document.getElementById('ls-viewer-recipient-avatar').src = activeLoveLetter.recipientAvatar;
    document.getElementById('ls-viewer-recipient-name').textContent = activeLoveLetter.recipientName;
    document.getElementById('ls-viewer-body').innerHTML = activeLoveLetter.content.replace(/\n/g, '<br>'); // æ­£æ–‡å…§å®¹
    document.getElementById('ls-viewer-sender-name').textContent = `Your dearest, ${activeLoveLetter.senderName}`; // ç™¼ä¿¡äºº
    document.getElementById('ls-viewer-timestamp').textContent = new Date(activeLoveLetter.timestamp).toLocaleString(); // æ™‚é–“

    // é¡¯ç¤ºå½ˆçª—
    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ° // â–²â–²â–² æƒ…ä¾¶ç©ºé–“åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–² çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼
/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ° // â–²â–²â–² æƒ…ä¾¶ç©ºé–“åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–² çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æƒ…ç·’æ—¥è¨˜åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ --- */

let currentDiaryDate = null; // ç”¨æ–¼æš«å­˜æ­£åœ¨ç·¨è¼¯æˆ–æŸ¥çœ‹çš„æ—¥è¨˜æ—¥æœŸ

/**
 * æ¸²æŸ“æƒ…ç·’æ—¥è¨˜çš„ä¸»ä»‹é¢ï¼ˆæ—¥æ›†å’Œå¿ƒæƒ…ç½å­ï¼‰
 */
async function renderLSDiaryView(year, month) {
    const viewEl = document.getElementById('ls-diary-view');
    const chat = state.chats[activeLoversSpaceCharId];
    if (!viewEl || !chat) return;

    const diaryData = chat.loversSpaceData.emotionDiaries || {};

    // æ¸²æŸ“æ—¥æ›†
    viewEl.innerHTML = renderCalendar(year, month, diaryData);

    // æ¸²æŸ“å¿ƒæƒ…ç½å­
    const jarHtml = renderMoodJar(year, month, diaryData);
    viewEl.insertAdjacentHTML('beforeend', jarHtml);
}

/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘ç”Ÿæˆæ—¥æ›†çš„HTML
 */
function renderCalendar(year, month, diaryData) {
    const date = new Date(year, month - 1, 1);
    const firstDay = date.getDay(); // 0-6 (å‘¨æ—¥-é€±å…­)
    const daysInMonth = new Date(year, month, 0).getDate();
    const today = new Date();
    
    let calendarHtml = `
        <div class="ls-calendar-wrapper">
            <div class="ls-calendar-header">
                <button id="ls-prev-month-btn">â€¹</button>
                <span id="ls-current-month-display">${year}å¹´ ${month}æœˆ</span>
                <button id="ls-next-month-btn">â€º</button>
            </div>
            <div class="ls-calendar-weekdays">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div class="ls-calendar-grid">
    `;

    // ç©ºç™½æ ¼å­
    for (let i = 0; i < firstDay; i++) {
        calendarHtml += '<div class="ls-calendar-day empty"></div>';
    }

    // æ—¥æœŸæ ¼å­
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = diaryData[dateStr] || {};
        const isToday = today.getFullYear() === year && today.getMonth() + 1 === month && today.getDate() === day;

        calendarHtml += `
            <div class="ls-calendar-day ${isToday ? 'today' : ''}" data-date="${dateStr}">
                <div class="day-number">${day}</div>
                <div class="mood-emojis">
                    <span class="user-emoji">${dayData.userEmoji || ''}</span>
                    <span class="char-emoji">${dayData.charEmoji || ''}</span>
                </div>
            </div>
        `;
    }
    calendarHtml += '</div></div>';
    return calendarHtml;
}

/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘ç”Ÿæˆå¿ƒæƒ…ç½å­çš„HTML
 */
function renderMoodJar(year, month, diaryData) {
    let allEmojis = [];
    for (const dateStr in diaryData) {
        if (dateStr.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            const dayData = diaryData[dateStr];
            if (dayData.userEmoji) allEmojis.push(dayData.userEmoji);
            if (dayData.charEmoji) allEmojis.push(dayData.charEmoji);
        }
    }
    
    let jarHtml = `
        <div class="ls-mood-jar-wrapper">
            <h3>æœ¬æœˆå¿ƒæƒ…ç½å­</h3>
            <div class="ls-mood-jar">
    `;

    if (allEmojis.length > 0) {
        jarHtml += allEmojis.map(emoji => `<span class="mood-emoji-item">${emoji}</span>`).join('');
    } else {
        jarHtml += '<p style="color: var(--text-secondary); font-size: 13px;">é€™å€‹æœˆé‚„æ²’æœ‰è¨˜éŒ„å¿ƒæƒ…å“¦</p>';
    }

    jarHtml += '</div></div>';
    return jarHtml;
}

/**
 * æ‰“é–‹æ—¥è¨˜ç·¨è¼¯/æŸ¥çœ‹å½ˆçª—
 */
function openDiaryModal(dateStr) {
    currentDiaryDate = dateStr;
    const chat = state.chats[activeLoversSpaceCharId];
    const diaryEntry = chat.loversSpaceData.emotionDiaries?.[dateStr];

    // å¦‚æœé›™æ–¹éƒ½æœ‰æ—¥è¨˜ï¼Œæˆ–åªæœ‰AIæœ‰æ—¥è¨˜ï¼Œå‰‡æ‰“é–‹æª¢è¦–å™¨
    if (diaryEntry && (diaryEntry.userDiary || diaryEntry.charDiary)) {
        openDiaryViewer(dateStr, diaryEntry, chat);
    } else {
        // å¦å‰‡ï¼Œæ‰“é–‹ç·¨è¼¯å™¨
        openDiaryEditor(dateStr, diaryEntry);
    }
}

/**
 * æ‰“é–‹æ—¥è¨˜ç·¨è¼¯å™¨
 */
function openDiaryEditor(dateStr, entryData) {
    const modal = document.getElementById('ls-diary-editor-modal');
    document.getElementById('ls-diary-editor-title').textContent = `è¨˜éŒ„ ${dateStr} çš„å¿ƒæƒ…`;

    const emojiSelector = document.getElementById('ls-emoji-selector');
    const emojis = ['ğŸ˜Š', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜¢', 'ğŸ˜ ', 'ğŸ¤”', 'ğŸ˜´', 'ğŸ¤¢'];
    emojiSelector.innerHTML = emojis.map(e => `<span class="emoji-option" data-emoji="${e}">${e}</span>`).join('');
    
    // æ¢å¾©ä¹‹å‰çš„é¸æ“‡ï¼ˆå¦‚æœæœ‰ï¼‰
    const contentInput = document.getElementById('ls-diary-content-input');
    if (entryData && entryData.userEmoji) {
        emojiSelector.querySelector(`.emoji-option[data-emoji="${entryData.userEmoji}"]`)?.classList.add('selected');
        contentInput.value = entryData.userDiary || '';
    } else {
        contentInput.value = '';
    }

    modal.classList.add('visible');
}

/**
 * æ‰“é–‹æ—¥è¨˜æª¢è¦–å™¨
 */
function openDiaryViewer(dateStr, entryData, chat) {
    const modal = document.getElementById('ls-diary-viewer-modal');
    document.getElementById('ls-diary-viewer-title').textContent = `æŸ¥çœ‹ ${dateStr} çš„æ—¥è¨˜`;
    const bodyEl = document.getElementById('ls-diary-viewer-body');
    bodyEl.innerHTML = '';
    
    // é¡¯ç¤ºä½¿ç”¨è€…æ—¥è¨˜
    if (entryData.userDiary) {
        const userBlock = document.createElement('div');
        userBlock.className = 'ls-diary-entry-block';
        userBlock.innerHTML = `
            <div class="entry-header">
                <span class="mood-emoji">${entryData.userEmoji}</span>
                <span class="author">${chat.settings.myNickname || 'æˆ‘'}çš„æ—¥è¨˜</span>
            </div>
            <p class="entry-content">${entryData.userDiary.replace(/\n/g, '<br>')}</p>
        `;
        bodyEl.appendChild(userBlock);
    }

    // é¡¯ç¤ºè§’è‰²æ—¥è¨˜
    if (entryData.charDiary) {
        const charBlock = document.createElement('div');
        charBlock.className = 'ls-diary-entry-block';
        charBlock.style.borderColor = '#ff8fab'; // çµ¦è§’è‰²æ—¥è¨˜ä¸€å€‹ä¸åŒçš„é¡è‰²
        charBlock.innerHTML = `
            <div class="entry-header">
                <span class="mood-emoji">${entryData.charEmoji}</span>
                <span class="author">${chat.name}çš„æ—¥è¨˜</span>
            </div>
            <p class="entry-content">${entryData.charDiary.replace(/\n/g, '<br>')}</p>
        `;
        bodyEl.appendChild(charBlock);
    } else {
        // å¦‚æœè§’è‰²é‚„æ²’å¯«ï¼Œçµ¦å€‹æç¤º
        bodyEl.innerHTML += `<p style="text-align: center; color: var(--text-secondary);">Ta é‚„æ²’å¯«ä»Šå¤©çš„å¿ƒæƒ…æ—¥è¨˜å“¦~</p>`;
    }
    
    modal.classList.add('visible');
}

/**
 * ä¿å­˜ç”¨æˆ¶çš„æ—¥è¨˜ï¼Œä¸¦è§¸ç™¼AIå¯«æ—¥è¨˜å’Œå›æ‡‰
 */
async function handleSaveUserDiary() {
    const selectedEmojiEl = document.querySelector('#ls-emoji-selector .selected');
    const userEmoji = selectedEmojiEl ? selectedEmojiEl.dataset.emoji : null;
    const userDiary = document.getElementById('ls-diary-content-input').value.trim();

    if (!userEmoji) {
        alert("è«‹é¸æ“‡ä¸€å€‹è¡¨æƒ…ä»£è¡¨ä»Šå¤©çš„å¿ƒæƒ…ï¼");
        return;
    }
    if (!userDiary) {
        alert("æ—¥è¨˜å…§å®¹ä¸èƒ½ç‚ºç©ºå“¦ï¼");
        return;
    }
    
    const chat = state.chats[activeLoversSpaceCharId];
    if (!chat.loversSpaceData.emotionDiaries) {
        chat.loversSpaceData.emotionDiaries = {};
    }

    // æ›´æ–°æˆ–å‰µå»ºç•¶å¤©çš„æ—¥è¨˜è³‡æ–™
    if (!chat.loversSpaceData.emotionDiaries[currentDiaryDate]) {
        chat.loversSpaceData.emotionDiaries[currentDiaryDate] = {};
    }
    chat.loversSpaceData.emotionDiaries[currentDiaryDate].userEmoji = userEmoji;
    chat.loversSpaceData.emotionDiaries[currentDiaryDate].userDiary = userDiary;
    
    // é—œé–‰å½ˆçª—
    document.getElementById('ls-diary-editor-modal').classList.remove('visible');
    // --- ã€æ ¸å¿ƒè¯å‹•åŠŸèƒ½é–‹å§‹ã€‘ ---

    // 1. æº–å‚™ä¸€æ¢å°ä½¿ç”¨è€…å¯è¦‹çš„æ¶ˆæ¯ï¼Œå‘Šè¨´å°æ–¹ä½ å¯«äº†æ—¥è¨˜
    const targetChat = state.chats[activeLoversSpaceCharId];
    if (targetChat) {
        const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ notificationMessage å®šç¾© â–¼â–¼â–¼
const notificationMessage = {
    role: 'user',
    type: 'ls_diary_notification', // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘çµ¦å®ƒä¸€å€‹ç¨ä¸€ç„¡äºŒçš„é¡å‹
    content: { // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å…§å®¹è®Šæˆä¸€å€‹ç‰©ä»¶ï¼Œæ–¹ä¾¿æ”œå¸¶æ›´å¤šè³‡è¨Š
        userEmoji: userEmoji, // æŠŠç”¨æˆ¶é¸æ“‡çš„è¡¨æƒ…ä¹Ÿå¸¶ä¸Š
        text: 'æˆ‘å‰›å‰›å¯«äº†ä»Šå¤©çš„å¿ƒæƒ…æ—¥è¨˜å“¦ï¼Œä½ ä¹Ÿå¿«å»çœ‹çœ‹å§ï¼'
    },
    timestamp: Date.now()
};
        targetChat.history.push(notificationMessage);

        // 2. å‰µå»ºä¸€æ¢å°AIå¯è¦‹çš„ã€éš±è—æŒ‡ä»¤ã€‘ï¼Œé€™æ˜¯æ•´å€‹åŠŸèƒ½çš„æ ¸å¿ƒ
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»çµ±æŒ‡ä»¤ï¼šç”¨æˆ¶å‰›å‰›åœ¨æƒ…ä¾¶ç©ºé–“å¯«äº†ä»Šå¤©çš„æ—¥è¨˜ã€‚
            - ä»–å€‘çš„å¿ƒæƒ…æ˜¯: ${userEmoji}
            - æ—¥è¨˜å…§å®¹æ˜¯: "${userDiary}"
            ä½ çš„ä»»å‹™:
            1.  ã€å¿…é ˆã€‘æ ¹æ“šä½ çš„äººè¨­å’Œä»Šå¤©çš„èŠå¤©è¨˜éŒ„ï¼Œä¹Ÿå¯«ä¸€ç¯‡ä½ è‡ªå·±çš„å¿ƒæƒ…æ—¥è¨˜ï¼Œä¸¦ä½¿ç”¨ 'ls_diary_entry' æŒ‡ä»¤ç™¼é€ã€‚
            2.  ã€å¿…é ˆã€‘åœ¨å¯«å®Œæ—¥è¨˜å¾Œï¼Œç«‹åˆ»å°±ä½¿ç”¨è€…ä»Šå¤©çš„æ—¥è¨˜å…§å®¹ï¼Œä»¥ä½ çš„è§’è‰²å£å»ï¼Œä¸»å‹•é–‹å•Ÿä¸€æ®µæ–°çš„å°è©±ã€‚]`,
            timestamp: Date.now() + 1, // ç¢ºä¿æ™‚é–“æˆ³è¨˜åœ¨å¾Œ
            isHidden: true // é€™å€‹æ¨™è¨˜èƒ½è®“æ¶ˆæ¯å°ä½¿ç”¨è€…éš±è—ï¼Œä½†AIèƒ½çœ‹è¦‹
        };
        targetChat.history.push(hiddenMessage);

        // 3. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°è³‡æ–™åº«
        await db.chats.put(targetChat);

        // 4. ä¸»å‹•è·³è½‰åˆ°å–®èŠä»‹é¢ï¼Œä¸¦è§¸ç™¼AIå›æ‡‰
        openChat(activeLoversSpaceCharId);
        triggerAiResponse();
    }
    // --- ã€æ ¸å¿ƒè¯å‹•åŠŸèƒ½çµæŸã€‘ ---

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

    alert('æ—¥è¨˜å·²ä¿å­˜ï¼');
}

/* --- æƒ…ç·’æ—¥è¨˜åŠŸèƒ½å‡½æ•¸çµæŸ --- */
/* â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æƒ…ä¾¶æå•åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ --- */

let activeQuestionId = null; // ç”¨æ–¼æš«å­˜æ­£åœ¨å›ç­”çš„å•é¡ŒID

/**
 * æ¸²æŸ“â€œæƒ…ä¾¶æå•â€åˆ—è¡¨
 */
function renderLSQuestions(questions, chat) {
    const listEl = document.getElementById('ls-questions-list');
    listEl.innerHTML = '';
    if (!questions || questions.length === 0) {
        listEl.innerHTML = '<p class="ls-empty-placeholder">é‚„æ²’æœ‰äººæå•ï¼Œé»æ“Šå³ä¸‹è§’â€œ+â€ç™¼èµ·ç¬¬ä¸€å€‹æå•å§ï¼</p>';
        return;
    }

    [...questions].reverse().forEach(q => {
        const isUserQuestioner = q.questioner === 'user';
        const questionerName = isUserQuestioner ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
        const questionerAvatar = isUserQuestioner ? chat.settings.myAvatar : chat.settings.aiAvatar;

        let answerHtml = '';
        if (q.answerText) {
            const isUserAnswerer = q.answerer === 'user';
            const answererName = isUserAnswerer ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
            const answererAvatar = isUserAnswerer ? chat.settings.myAvatar : chat.settings.aiAvatar;
            answerHtml = `
                <div class="ls-answer-section">
                    <img src="${answererAvatar}" class="qa-avatar">
                    <div class="qa-main">
                        <div class="qa-header">
                            <span class="qa-author">${answererName}çš„å›ç­”</span>
                        </div>
                        <p class="qa-content">${q.answerText.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            `;
        } else if (q.answerer === 'user') {
            // å¦‚æœè¼ªåˆ°ç”¨æˆ¶å›ç­”
            answerHtml = `
                <div class="ls-answer-placeholder">
                    <button class="ls-answer-btn" data-question-id="${q.id}">å›ç­”Taçš„å•é¡Œ</button>
                </div>
            `;
        } else {
            // å¦‚æœè¼ªåˆ°AIå›ç­”
            answerHtml = `
                <div class="ls-answer-placeholder">
                    <p style="color: var(--text-secondary); font-size: 14px;">ç­‰å¾…Taçš„å›ç­”...</p>
                </div>
            `;
        }

        const card = document.createElement('div');
        card.className = 'ls-question-card';
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±æ˜¯åœ¨é€™è£¡åŠ å…¥äº†åˆªé™¤æŒ‰éˆ• â–¼â–¼â–¼
        card.innerHTML = `
            <button class="ls-question-delete-btn" data-question-id="${q.id}" title="åˆªé™¤æ­¤æå•">Ã—</button>

            <div class="ls-question-section">
                <img src="${questionerAvatar}" class="qa-avatar">
                <div class="qa-main">
                    <div class="qa-header">
                        <span class="qa-author">${questionerName}çš„æå•</span>
                        <span class="qa-timestamp">${formatPostTimestamp(q.timestamp)}</span>
                    </div>
                    <p class="qa-content">${q.questionText.replace(/\n/g, '<br>')}</p>
                </div>
            </div>
            ${answerHtml}
        `;
        listEl.appendChild(card);
    });
}


/**
 * æ‰“é–‹æå•å½ˆçª—
 */
function openQuestionAsker() {
    document.getElementById('ls-question-content-input').value = '';
    document.getElementById('ls-ask-question-modal').classList.add('visible');
}

/**
 * ç”¨æˆ¶ç™¼ä½ˆä¸€å€‹æ–°æå•
 */
async function handlePostQuestion() {
    const content = document.getElementById('ls-question-content-input').value.trim();
    if (!content) {
        alert("å•é¡Œå…§å®¹ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }
    const chat = state.chats[activeLoversSpaceCharId];
    const newQuestion = {
        id: 'q_' + Date.now(),
        questioner: 'user',
        questionText: content,
        timestamp: Date.now(),
        answerer: 'char', // æŒ‡å®šç”±AIä¾†å›ç­”
        answerText: null
    };
    
    if (!chat.loversSpaceData.questions) {
        chat.loversSpaceData.questions = [];
    }
    chat.loversSpaceData.questions.push(newQuestion);
    await db.chats.put(chat);
    
    renderLSQuestions(chat.loversSpaceData.questions, chat);
    document.getElementById('ls-ask-question-modal').classList.remove('visible');
    
// â–¼â–¼â–¼ åœ¨ handlePostQuestion å‡½æ•¸çš„æœ«å°¾ï¼Œé»è²¼ä¸‹é¢é€™å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼
// å‰µå»ºä¸€æ¢å°ç”¨æˆ¶éš±è—ï¼Œä½†å°AIå¯è¦‹çš„ç³»çµ±æ¶ˆæ¯
const hiddenMessage = {
    role: 'system',
    content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶åœ¨æƒ…ä¾¶ç©ºé–“å‘ä½ æäº†ä¸€å€‹å•é¡Œï¼šâ€œ${content}â€ï¼Œå•é¡ŒIDæ˜¯â€œ${newQuestion.id}â€ã€‚è«‹ä½¿ç”¨ 'ls_answer_question' æŒ‡ä»¤ä¾†å›ç­”ã€‚]`,
    timestamp: Date.now(),
    isHidden: true
};
chat.history.push(hiddenMessage);
await db.chats.put(chat);


}

/**
 * æ‰“é–‹å›ç­”å•é¡Œçš„å½ˆçª—
 */
function openAnswerEditor(questionId) {
    const chat = state.chats[activeLoversSpaceCharId];
    const question = chat.loversSpaceData.questions.find(q => q.id === questionId);
    if (!question) return;

    activeQuestionId = questionId;
    document.getElementById('ls-answer-question-text').textContent = question.questionText;
    document.getElementById('ls-answer-content-input').value = '';
    document.getElementById('ls-answer-question-modal').classList.add('visible');
}

/**
 * ç”¨æˆ¶æäº¤å›ç­”
 */
async function handlePostAnswer() {
    if (!activeQuestionId) return;
    const answerText = document.getElementById('ls-answer-content-input').value.trim();
    if (!answerText) {
        alert("å›ç­”å…§å®¹ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }
    const chat = state.chats[activeLoversSpaceCharId];
    const question = chat.loversSpaceData.questions.find(q => q.id === activeQuestionId);
    if (question) {
        question.answerer = 'user'; // æ˜ç¢ºå›ç­”è€…æ˜¯ç”¨æˆ¶
        question.answerText = answerText;
        await db.chats.put(chat);
        // â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›ä¸Šé¢çš„ â–¼â–¼â–¼
const hiddenMessage = {
    role: 'system',
    content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ï¼ˆ${chat.settings.myNickname || 'æˆ‘'}ï¼‰å‰›å‰›åœ¨æƒ…ä¾¶ç©ºé–“å›ç­”äº†ä½ ä¹‹å‰æå‡ºçš„å•é¡Œã€‚ä½ çš„å•é¡Œæ˜¯ï¼šâ€œ${question.questionText}â€ï¼Œç”¨æˆ¶çš„å›ç­”æ˜¯ï¼šâ€œ${answerText}â€ã€‚]`,
    timestamp: Date.now(),
    isHidden: true
};
chat.history.push(hiddenMessage);
await db.chats.put(chat);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        renderLSQuestions(chat.loversSpaceData.questions, chat);
    }
    document.getElementById('ls-answer-question-modal').classList.remove('visible');
    activeQuestionId = null;
}
/**
 * ã€å…¨æ–°ã€‘åˆªé™¤ä¸€æ¢æƒ…ä¾¶æå•
 * @param {string} questionId - è¦åˆªé™¤çš„æå•çš„ID
 */
async function handleDeleteLSQuestion(questionId) {
    // 1. å½ˆå‡ºç¢ºèªæ¡†ï¼Œé˜²æ­¢èª¤åˆª
    const confirmed = await showCustomConfirm(
        'åˆªé™¤æå•',
        'ç¢ºå®šè¦åˆªé™¤é€™å€‹å•é¡Œä»¥åŠå°æ‡‰çš„å›ç­”å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚',
        { confirmButtonClass: 'btn-danger' }
    );

    // 2. å¦‚æœç”¨æˆ¶ç¢ºèªåˆªé™¤
    if (confirmed) {
        const chat = state.chats[activeLoversSpaceCharId];
        if (!chat || !chat.loversSpaceData || !chat.loversSpaceData.questions) return;

        // 3. å¾æå•é™£åˆ—ä¸­éæ¿¾æ‰è¦åˆªé™¤çš„æå•
        chat.loversSpaceData.questions = chat.loversSpaceData.questions.filter(q => q.id !== questionId);

        // 4. ä¿å­˜æ›´æ–°å¾Œçš„èŠå¤©è³‡æ–™
        await db.chats.put(chat);

        // 5. é‡æ–°æ¸²æŸ“æå•åˆ—è¡¨ï¼Œè®“åˆªé™¤æ•ˆæœç«‹åˆ»ç”Ÿæ•ˆ
        renderLSQuestions(chat.loversSpaceData.questions, chat);

        alert('æå•å·²åˆªé™¤ã€‚');
    }
}

/* --- æƒ…ä¾¶æå•åŠŸèƒ½å‡½æ•¸çµæŸ --- */

// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™è£¡æ˜¯æƒ…ä¾¶ç©ºé–“å°ˆå±¬éŸ³æ¨‚æ’­æ”¾æ©Ÿçš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘ç•¶ç”¨æˆ¶åœ¨æƒ…ä¾¶ç©ºé–“é»æ“Šä¸€é¦–åˆ†äº«çš„æ­Œæ›²æ™‚è§¸ç™¼
 * @param {object} shareData - åŒ…å«æ­Œæ›²è³‡è¨Šçš„åˆ†äº«ç‰©ä»¶
 */
async function openLoversSpaceMusicPlayer(shareData) {
    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨ç‚ºã€Š${shareData.title}ã€‹å°‹æ‰¾æ’­æ”¾è³‡æº...`);
    
    // æª¢æŸ¥æ’­æ”¾æ¸…å–®æ˜¯å¦å·²ç¶“æœ‰é€™é¦–æ­Œäº†
    const existingIndex = lsMusicState.playlist.findIndex(
        song => song.name === shareData.title && song.artist === shareData.artist
    );

    if (existingIndex > -1) {
        // å¦‚æœå·²ç¶“å­˜åœ¨ï¼Œç›´æ¥æ’­æ”¾ä¸¦æ‰“é–‹æ’­æ”¾æ©Ÿ
        playLSSong(existingIndex);
        document.getElementById('ls-music-player-overlay').classList.add('visible');
        return;
    }

    // å¦‚æœä¸å­˜åœ¨ï¼Œé–‹å§‹æœç´¢
    let songData = null;
    const songName = shareData.title;
    const artistName = shareData.artist || '';

    // ç­–ç•¥1ï¼šå„ªå…ˆç”¨ç¶²æ˜“é›²æœç´¢ (é€šå¸¸çµæœæ›´å‡†)
    const neteaseResults = await searchNeteaseMusic(songName, artistName);
    if (neteaseResults.length > 0) {
        songData = neteaseResults[0];
    } else {
        // ç­–ç•¥2ï¼šå¦‚æœç¶²æ˜“é›²æ‰¾ä¸åˆ°ï¼Œå†ç”¨QQéŸ³æ¨‚æœä¸€æ¬¡
        const tencentResults = await searchTencentMusic(songName);
        if (tencentResults.length > 0) {
            songData = tencentResults[0];
        }
    }

    if (!songData) {
        await showCustomAlert("æ’­æ”¾å¤±æ•—", `æŠ±æ­‰ï¼Œåœ¨ç¶²æ˜“é›²å’ŒQQéŸ³æ¨‚éƒ½æ²’èƒ½æ‰¾åˆ°ã€Š${songName}ã€‹çš„å¯æ’­æ”¾è³‡æºã€‚`);
        return;
    }

    // ç²å–æ’­æ”¾é€£çµ
    const apiUrl = songData.source === 'netease' 
        ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
        : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
    
    const result = await Http_Get(apiUrl);

    if (!result?.data?.url || !(await checkAudioAvailability(result.data.url))) {
        await showCustomAlert("ç²å–å¤±æ•—", `æ‰¾åˆ°äº†ã€Š${songName}ã€‹ï¼Œä½†ç„¡æ³•ç²å–æœ‰æ•ˆçš„æ’­æ”¾é€£çµã€‚`);
        return;
    }

    // ã€æ–°å¢ã€‘ç²å–æ­Œè©
    const lrcContent = await getLyricsForSong(songData.id, songData.source) || "";

    // å‰µå»ºæ–°çš„æ­Œæ›²ç‰©ä»¶ä¸¦æ·»åŠ åˆ°æ’­æ”¾æ¸…å–®
    const newSong = {
        name: songData.name,
        artist: songData.artist,
        src: result.data.url,
        cover: songData.cover,
        lrcContent: lrcContent // <-- å°±æ˜¯æ–°å¢äº†é€™ä¸€è¡Œï¼
    };

    lsMusicState.playlist.push(newSong);
    
    // æ’­æ”¾é€™é¦–æ–°æ·»åŠ çš„æ­Œæ›²
    playLSSong(lsMusicState.playlist.length - 1);
    
    // æ‰“é–‹æ’­æ”¾æ©Ÿ
    document.getElementById('ls-music-player-overlay').classList.add('visible');
}

async function playLSSong(index) {
    if (index < 0 || index >= lsMusicState.playlist.length) return;

    lsMusicState.currentIndex = index;
    const track = lsMusicState.playlist[index];
    const lsAudioPlayer = document.getElementById('ls-audio-player');
    
    // ã€æ–°å¢ã€‘è§£æå’Œæ¸²æŸ“æ­Œè©
    track.parsedLyrics = parseLRC(track.lrcContent || ""); // è¤‡ç”¨ä½ å·²æœ‰çš„æ­Œè©è§£æå‡½æ•¸
    track.currentLyricIndex = -1;
    renderLSLyrics(track);

    lsAudioPlayer.src = track.src;
    try {
        await lsAudioPlayer.play();
        lsMusicState.isPlaying = true;
    } catch (error) {
        console.error("æƒ…ä¾¶ç©ºé–“éŸ³æ¨‚æ’­æ”¾å¤±æ•—:", error);
        lsMusicState.isPlaying = false;
    }
    
    renderLSMusicPlayerUI();
    renderLSMusicPlaylist(); 
}


/**
 * åˆ‡æ›æ’­æ”¾/æš«åœç‹€æ…‹ (æƒ…ä¾¶ç©ºé–“ç‰ˆ)
 */
function toggleLSMusicPlayPause() {
    const lsAudioPlayer = document.getElementById('ls-audio-player');
    if (lsMusicState.currentIndex === -1 && lsMusicState.playlist.length > 0) {
        // å¦‚æœåˆ—è¡¨æœ‰æ­Œä½†é‚„æ²’é–‹å§‹æ’­ï¼Œé»æ“Šæ’­æ”¾å°±å¾ç¬¬ä¸€é¦–é–‹å§‹
        playLSSong(0);
        return;
    }
    
    if (lsAudioPlayer.paused) {
        lsAudioPlayer.play();
        lsMusicState.isPlaying = true;
    } else {
        lsAudioPlayer.pause();
        lsMusicState.isPlaying = false;
    }
    renderLSMusicPlayerUI();
}

/**
 * æ’­æ”¾ä¸‹ä¸€é¦– (æƒ…ä¾¶ç©ºé–“ç‰ˆ)
 */
function playNextLSSong() {
    if (lsMusicState.playlist.length === 0) return;
    const newIndex = (lsMusicState.currentIndex + 1) % lsMusicState.playlist.length;
    playLSSong(newIndex);
}

/**
 * æ’­æ”¾ä¸Šä¸€é¦– (æƒ…ä¾¶ç©ºé–“ç‰ˆ)
 */
function playPrevLSSong() {
    if (lsMusicState.playlist.length === 0) return;
    const newIndex = (lsMusicState.currentIndex - 1 + lsMusicState.playlist.length) % lsMusicState.playlist.length;
    playLSSong(newIndex);
}

/**
 * æ›´æ–°æ’­æ”¾æ©Ÿä»‹é¢ (æƒ…ä¾¶ç©ºé–“ç‰ˆ)
 */
function renderLSMusicPlayerUI() {
    const track = lsMusicState.playlist[lsMusicState.currentIndex];

    if (track) {
        document.getElementById('ls-album-cover').src = track.cover;
        document.getElementById('ls-song-title').textContent = track.name;
        document.getElementById('ls-artist').textContent = track.artist;
    } else {
        document.getElementById('ls-album-cover').src = 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
        document.getElementById('ls-song-title').textContent = 'æš«ç„¡æ­Œæ›²';
        document.getElementById('ls-artist').textContent = '...';
    }

    document.getElementById('ls-play-pause-btn').textContent = lsMusicState.isPlaying ? 'âšâš' : 'â–¶';
}

/**
 * æ›´æ–°é€²åº¦æ¢ (æƒ…ä¾¶ç©ºé–“ç‰ˆ)
 */
function updateLSProgressBar() {
    const lsAudioPlayer = document.getElementById('ls-audio-player');
    const currentTimeEl = document.getElementById('ls-current-time');
    const totalTimeEl = document.getElementById('ls-total-time');
    const progressFillEl = document.getElementById('ls-progress-fill');

    if (!lsAudioPlayer.duration) {
        currentTimeEl.textContent = "0:00";
        totalTimeEl.textContent = "0:00";
        progressFillEl.style.width = '0%';
        return;
    }
    
    const progressPercent = (lsAudioPlayer.currentTime / lsAudioPlayer.duration) * 100;
    progressFillEl.style.width = `${progressPercent}%`;
    currentTimeEl.textContent = formatMusicTime(lsAudioPlayer.currentTime);
    totalTimeEl.textContent = formatMusicTime(lsAudioPlayer.duration);
    updateLSCurrentLyric(lsAudioPlayer.currentTime);
}

/**
 * æ¸²æŸ“æ’­æ”¾æ¸…å–® (æƒ…ä¾¶ç©ºé–“ç‰ˆ)
 */
function renderLSMusicPlaylist() {
    const playlistBody = document.getElementById('ls-playlist-body');
    playlistBody.innerHTML = '';
    
    if (lsMusicState.playlist.length === 0) {
        playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾æ¸…å–®æ˜¯ç©ºçš„</p>';
        return;
    }

    lsMusicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if (index === lsMusicState.currentIndex) {
            item.classList.add('playing');
        }
        item.innerHTML = `
            <div class="playlist-item-info">
                <div class="title">${track.name}</div>
                <div class="artist">${track.artist}</div>
            </div>
            <div class="playlist-item-actions">
                <span class="playlist-action-btn delete-track-btn" data-index="${index}">Ã—</span>
            </div>
        `;
        item.querySelector('.playlist-item-info').addEventListener('click', () => playLSSong(index));
        playlistBody.appendChild(item);
    });
}
// â–¼â–¼â–¼ åœ¨ clearLSMusicPlaylist() å‡½æ•¸çš„ä¸Šæ–¹ï¼Œé»è²¼é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“æ­Œè©åˆ—è¡¨ (æƒ…ä¾¶ç©ºé–“ç‰ˆ)
 */
function renderLSLyrics(track) {
    const lyricsList = document.getElementById('ls-lyrics-list');
    lyricsList.innerHTML = '';
    if (!track.parsedLyrics || track.parsedLyrics.length === 0) {
        lyricsList.innerHTML = '<div class="lyric-line active">â™ª æš«ç„¡æ­Œè© â™ª</div>';
        return;
    }
    track.parsedLyrics.forEach((line, index) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'lyric-line';
        lineEl.textContent = line.text;
        lineEl.dataset.index = index;
        lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(45%)`; // åˆå§‹ä½ç½®
}

/**
 * ã€å…¨æ–°ã€‘æ›´æ–°ç•¶å‰é«˜äº®çš„æ­Œè© (æƒ…ä¾¶ç©ºé–“ç‰ˆ)
 */
function updateLSCurrentLyric(currentTime) {
    const track = lsMusicState.playlist[lsMusicState.currentIndex];
    if (!track || !track.parsedLyrics || track.parsedLyrics.length === 0) return;

    let newLyricIndex = -1;
    for (let i = 0; i < track.parsedLyrics.length; i++) {
        if (currentTime >= track.parsedLyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    
    if (newLyricIndex !== track.currentLyricIndex) {
        track.currentLyricIndex = newLyricIndex;
        
        const lyricsList = document.getElementById('ls-lyrics-list');
        const container = document.getElementById('ls-lyrics-container');
        
        lyricsList.querySelectorAll('.lyric-line').forEach(line => line.classList.remove('active'));
        
        if (newLyricIndex > -1) {
            const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${newLyricIndex}"]`);
            if (activeLine) {
                activeLine.classList.add('active');
                // è¨ˆç®—æ»¾å‹•åç§»é‡ï¼Œè®“é«˜äº®è¡Œå‚ç›´å±…ä¸­
                const offset = (container.offsetHeight / 2) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
                lyricsList.style.transform = `translateY(${offset}px)`;
            }
        }
    }
}

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

/**
 * æ¸…ç©ºæ’­æ”¾æ¸…å–® (æƒ…ä¾¶ç©ºé–“ç‰ˆ)
 */
function clearLSMusicPlaylist() {
    const lsAudioPlayer = document.getElementById('ls-audio-player');
    lsAudioPlayer.pause();
    lsAudioPlayer.src = '';

    lsMusicState.playlist = [];
    lsMusicState.currentIndex = -1;
    lsMusicState.isPlaying = false;
    
    renderLSMusicPlayerUI();
    renderLSMusicPlaylist();
}

// â–²â–²â–² æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ã€æ­£ä¸Šæ–¹ã€‘ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æƒ…ä¾¶ç•ªèŒ„é˜åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ --- */

/**
 * æ‰“é–‹ç•ªèŒ„é˜ä¸»é ä¸¦æ¸²æŸ“æ­·å²è¨˜éŒ„
 */
async function openPomodoroScreen() {
    if (!activeLoversSpaceCharId) return;
    await renderPomodoroHistory(activeLoversSpaceCharId);
    
    // ç¢ºä¿é¡¯ç¤ºçš„æ˜¯ä¸»é ï¼Œè€Œä¸æ˜¯è¨ˆæ™‚å™¨ä»‹é¢
    document.getElementById('ls-pomodoro-home').style.display = 'flex';
    document.getElementById('ls-pomodoro-timer-active').style.display = 'none';
}

/**
 * æ¸²æŸ“æŒ‡å®šè§’è‰²çš„ç•ªèŒ„é˜æ­·å²è¨˜éŒ„
 * @param {string} charId - è§’è‰²ID
 */
async function renderPomodoroHistory(charId) {
    const listEl = document.getElementById('ls-pomodoro-history-list');
    listEl.innerHTML = '';
    const sessions = await db.pomodoroSessions.where('chatId').equals(charId).reverse().sortBy('startTime');
    
    if (sessions.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); font-size: 14px;">é‚„æ²’æœ‰å°ˆæ³¨è¨˜éŒ„å“¦</p>';
        return;
    }

    sessions.forEach(session => {
        const item = document.createElement('div');
        item.className = 'pomodoro-history-item';
        item.dataset.sessionId = session.id;
        item.innerHTML = `
            <div class="task">${session.task}</div>
            <div class="meta">
                ${new Date(session.startTime).toLocaleString()} | å°ˆæ³¨äº† ${Math.round(session.duration / 60)} åˆ†é˜
            </div>
        `;
        item.addEventListener('click', () => showPomodoroHistoryDetail(session.id));
        listEl.appendChild(item);
    });
}

/**
 * é¡¯ç¤ºæŒ‡å®šæ­·å²è¨˜éŒ„çš„èŠå¤©è©³æƒ…
 * @param {number} sessionId - è¨˜éŒ„çš„ID
 */
async function showPomodoroHistoryDetail(sessionId) {
    const session = await db.pomodoroSessions.get(sessionId);
    if (!session) return;
    
    const modal = document.getElementById('ls-pomodoro-history-viewer-modal');
    const titleEl = document.getElementById('pomodoro-history-viewer-title');
    const contentEl = document.getElementById('pomodoro-history-viewer-content');
    
    titleEl.textContent = `â€œ${session.task}â€çš„å°ˆæ³¨è¨˜éŒ„`;
    contentEl.innerHTML = '';

    if (session.log && session.log.length > 0) {
        session.log.forEach(logEntry => {
            const bubble = document.createElement('div');
            bubble.className = 'pomodoro-log-bubble';
            bubble.textContent = logEntry.content;
            contentEl.appendChild(bubble);
        });
    } else {
        contentEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">é€™æ¬¡å°ˆæ³¨æœŸé–“æ²’æœ‰èŠå¤©è¨˜éŒ„å“¦ã€‚</p>';
    }
    
    modal.classList.add('visible');
}

// â–¼â–¼â–¼ ç”¨é€™å€‹æ–°å‡½æ•¸æ›¿æ›èˆŠçš„ openPomodoroSetup â–¼â–¼â–¼
function openPomodoroSetup() {
    document.getElementById('pomodoro-task-input').value = '';
    document.getElementById('pomodoro-duration-input').value = '25';
    document.getElementById('pomodoro-talk-interval-input').value = '5';
    document.getElementById('pomodoro-bg-url-input').value = '';
    
    // æ ¸å¿ƒæ–°å¢ï¼šæ¯æ¬¡æ‰“é–‹æ™‚ï¼Œæ¸…ç©ºä¸Šä¸€æ¬¡æœ¬åœ°ä¸Šå‚³çš„è‡¨æ™‚è³‡æ–™
    pomodoroState.tempBgDataUrl = null; 

    document.getElementById('ls-pomodoro-setup-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨é€™å€‹ã€æ”¯æŒæ­£/å€’è¨ˆæ™‚ã€‘çš„æ–°ç‰ˆæœ¬ï¼Œæ›¿æ›èˆŠçš„ startPomodoroSession å‡½æ•¸ â–¼â–¼â–¼
async function startPomodoroSession() {
    const task = document.getElementById('pomodoro-task-input').value.trim();
    // 1. ç²å–ä½¿ç”¨è€…é¸æ“‡çš„è¨ˆæ™‚æ¨¡å¼
    const timerType = document.querySelector('input[name="pomodoro-mode"]:checked').value;
    const durationMinutes = parseInt(document.getElementById('pomodoro-duration-input').value);
    const talkIntervalMinutes = parseInt(document.getElementById('pomodoro-talk-interval-input').value);
    const bgUrl = pomodoroState.tempBgDataUrl || document.getElementById('pomodoro-bg-url-input').value.trim();

    if (!task) {
        alert("è«‹è¼¸å…¥ä¸€å€‹å°ˆæ³¨ä»»å‹™ï¼");
        return;
    }
    // 2. å¦‚æœæ˜¯å€’è¨ˆæ™‚æ¨¡å¼ï¼Œæ‰éœ€è¦æª¢æŸ¥æ™‚é•·æ˜¯å¦æœ‰æ•ˆ
    if (timerType === 'countdown' && (isNaN(durationMinutes) || durationMinutes < 1)) {
        alert("å€’è¨ˆæ™‚æ¨¡å¼ä¸‹ï¼Œè«‹è¼¸å…¥æœ‰æ•ˆçš„å°ˆæ³¨æ™‚é•·ï¼");
        return;
    }

    const chat = state.chats[activeLoversSpaceCharId];
    // 3. æ ¹æ“šæ¨¡å¼ï¼Œè¨­ç½®ç¸½æ™‚é•·ï¼ˆæ­£è¨ˆæ™‚æ¨¡å¼ç¸½æ™‚é•·ç‚º0ï¼Œå› ç‚ºå®ƒæœƒä¸€ç›´å¢åŠ ï¼‰
    const durationSeconds = timerType === 'countdown' ? durationMinutes * 60 : 0; 
    
    pomodoroState.currentSession = {
        chatId: activeLoversSpaceCharId,
        task: task,
        duration: durationSeconds,
        timerType: timerType, // 4. æŠŠè¨ˆæ™‚æ¨¡å¼ä¹Ÿä¿å­˜åˆ°æœƒè©±è¨˜éŒ„è£¡
        startTime: Date.now(),
        log: []
    };
    
    const timerView = document.getElementById('ls-pomodoro-timer-active');
    document.getElementById('ls-pomodoro-home').style.display = 'none';
    timerView.style.display = 'flex';
    
    if (bgUrl) {
        timerView.style.backgroundImage = `url(${bgUrl})`;
    } else {
        timerView.style.backgroundImage = `url(${chat.settings.aiAvatar})`;
    }
    
    document.getElementById('pomodoro-char-avatar').src = chat.settings.aiAvatar;
    document.getElementById('pomodoro-current-task').textContent = task;
    
    // 5. æ ¹æ“šæ¨¡å¼ï¼Œè¨­ç½®è¨ˆæ™‚å™¨çš„åˆå§‹å€¼
    let timeTracker = timerType === 'countdown' ? durationSeconds : 0;
    updatePomodoroTimerDisplay(timeTracker);

    pomodoroState.timerId = setInterval(() => {
        // 6. ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ“šæ¨¡å¼æ±ºå®šæ˜¯å¢åŠ é‚„æ˜¯æ¸›å°‘æ™‚é–“
        if (timerType === 'countdown') {
            timeTracker--;
            if (timeTracker <= 0) {
                updatePomodoroTimerDisplay(0); // ç¢ºä¿é¡¯ç¤º00:00
                endPomodoroSession(true); // å€’è¨ˆæ™‚çµæŸ
            }
        } else { // 'countup'
            timeTracker++;
        }
        updatePomodoroTimerDisplay(timeTracker);
    }, 1000);
    if (talkIntervalMinutes > 0) {
        pomodoroState.periodicTalkTimerId = setInterval(() => {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¾åœ¨å®ƒæœƒèª¿ç”¨APIä¾†ç”Ÿæˆè©±èª
            triggerPomodoroAIResponse("periodic_encouragement");
        }, talkIntervalMinutes * 60 * 1000);
    }
    pomodoroState.isActive = true;
    document.getElementById('ls-pomodoro-setup-modal').classList.remove('visible');
    
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»çµ±æŒ‡ä»¤ï¼šç”¨æˆ¶å‰›å‰›å’Œä½ ä¸€èµ·é–‹å§‹äº†ä¸€å€‹ç•ªèŒ„é˜å°ˆæ³¨ä»»å‹™ï¼šâ€œ${task}â€ï¼Œæ™‚é•·ç‚º${durationMinutes}åˆ†é˜ã€‚åœ¨å°ˆæ³¨æœŸé–“ï¼Œä½ å¯ä»¥é€šé "pomodoro_talk" æŒ‡ä»¤ä¾†é¼“å‹µä½¿ç”¨è€…ã€‚]`,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(hiddenMessage);
    await db.chats.put(chat);
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



/**
 * æ›´æ–°ç•ªèŒ„é˜çš„å€’è¨ˆæ™‚é¡¯ç¤º
 * @param {number} secondsLeft - å‰©é¤˜ç§’æ•¸
 */
function updatePomodoroTimerDisplay(secondsLeft) {
    const minutes = Math.floor(secondsLeft / 60);
    const seconds = secondsLeft % 60;
    document.getElementById('pomodoro-time').textContent = 
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²ä¿®å¾©æ™‚é•·è¨˜éŒ„ã€‘çš„æ–°ç‰ˆæœ¬ï¼Œæ›¿æ›èˆŠçš„ endPomodoroSession å‡½æ•¸ â–¼â–¼â–¼
async function endPomodoroSession(isCompleted = false) {
    if (!pomodoroState.isActive) return;

    clearInterval(pomodoroState.timerId);
    clearInterval(pomodoroState.periodicTalkTimerId);

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨ä¿å­˜å‰ï¼Œæ ¹æ“šè¨ˆæ™‚æ¨¡å¼é‡æ–°è¨ˆç®—ä¸¦æ›´æ–°æœ€çµ‚çš„å°ˆæ³¨æ™‚é•·
    if (pomodoroState.currentSession.timerType === 'countup') {
        // å°æ–¼æ­£è¨ˆæ™‚ï¼Œæ™‚é•·æ˜¯çµæŸæ™‚é–“æ¸›å»é–‹å§‹æ™‚é–“
        pomodoroState.currentSession.duration = Math.floor((Date.now() - pomodoroState.currentSession.startTime) / 1000);
    }
    
    pomodoroState.currentSession.endTime = Date.now();
    await db.pomodoroSessions.add(pomodoroState.currentSession);
    
    document.getElementById('ls-pomodoro-timer-active').style.display = 'none';
    document.getElementById('ls-pomodoro-home').style.display = 'flex';
    await renderPomodoroHistory(activeLoversSpaceCharId);

    pomodoroState = { isActive: false, timerId: null, periodicTalkTimerId: null, currentSession: null };

    const chat = state.chats[activeLoversSpaceCharId];
    const endReason = isCompleted ? "æ™‚é–“åˆ°äº†ï¼Œä»»å‹™å·²å®Œæˆ" : "è¢«ç”¨æˆ¶æ‰‹å‹•ä¸­æ–·";
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»çµ±æŒ‡ä»¤ï¼šç•ªèŒ„é˜å°ˆæ³¨ä»»å‹™å·²çµæŸã€‚çµæŸåŸå› ï¼š${endReason}ã€‚]`,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(hiddenMessage);
    await db.chats.put(chat);

    if (isCompleted) {
        showCustomAlert("å°ˆæ³¨å®Œæˆï¼", "æ­å–œä½ å®Œæˆäº†ä¸€æ¬¡å°ˆæ³¨æ™‚å…‰ï¼Œä¼‘æ¯ä¸€ä¸‹å§ï¼");
    } else {
        showCustomAlert("å°ˆæ³¨çµæŸ", "ä½ ä¸­æ–·äº†æœ¬æ¬¡å°ˆæ³¨ã€‚");
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘è§¸ç™¼ç•ªèŒ„é˜æœŸé–“çš„AIäº’å‹• (å·²åŠ å…¥ç”¨æˆ¶äººè¨­ä¸¦å¢åŠ å›å¾©é•·åº¦)
 * @param {string} triggerType - è§¸ç™¼é¡å‹, 'user_click' æˆ– 'periodic_encouragement'
 */
async function triggerPomodoroAIResponse(triggerType) {
    if (!pomodoroState.isActive || !activeLoversSpaceCharId) return;

    const chat = state.chats[activeLoversSpaceCharId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        console.warn("ç•ªèŒ„é˜AIäº’å‹•å¤±æ•—ï¼šAPIæœªé…ç½®ã€‚");
        return;
    }

    // --- ã€æ ¸å¿ƒä¿®æ”¹1ï¼šåŠ å…¥äº†ç”¨æˆ¶äººè¨­ã€‘ ---
    const elapsedSeconds = Math.floor((Date.now() - pomodoroState.currentSession.startTime) / 1000);
    const elapsedMinutes = Math.floor(elapsedSeconds / 60);
    const timeContext = `ç”¨æˆ¶å·²ç¶“æŒçºŒå°ˆæ³¨äº† ${elapsedMinutes} åˆ†é˜ã€‚`;
    const triggerReason = triggerType === 'user_click' ? 'ç”¨æˆ¶å‰›å‰›é»æ“Šäº†ä½ çš„é ­åƒï¼Œä¼¼ä¹éœ€è¦ä¸€äº›é¼“å‹µã€‚' : 'åˆ°äº†ä½ ä¸»å‹•é¼“å‹µç”¨æˆ¶çš„æ™‚é–“ã€‚';

    const systemPrompt = `
# ä»»å‹™
ä½ æ­£åœ¨å’Œç”¨æˆ¶ä¸€èµ·é€²è¡Œç•ªèŒ„é˜å°ˆæ³¨ã€‚
- ä½ å€‘æ­£åœ¨é€²è¡Œçš„ä»»å‹™æ˜¯: "${pomodoroState.currentSession.task}"
- ${timeContext}
- è§¸ç™¼æœ¬æ¬¡å°è©±çš„åŸå› æ˜¯: ${triggerReason}
- ä½ çš„è§’è‰²äººè¨­: ${chat.settings.aiPersona}
- ä½ çš„èŠå¤©ç‰©ä»¶(ä½¿ç”¨è€…)çš„äººè¨­: ${chat.settings.myPersona}

# æ ¸å¿ƒè¦å‰‡
1.  **ä¿æŒå°ˆæ³¨**: ä½ çš„å›å¾©è¦æ›´è±å¯Œã€æ›´æœ‰å…§å®¹ï¼Œå¤§ç´„50å­—å·¦å³ï¼Œç›®çš„æ˜¯èª¬æ˜ä½¿ç”¨è€…ç¹¼çºŒå°ˆæ³¨æ–¼ä»»å‹™ï¼Œè€Œä¸æ˜¯é–’èŠã€‚
2.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹: \`{"type": "pomodoro_talk", "content": "ä½ çš„é¼“å‹µèª..."}\`

ç¾åœ¨ï¼Œè«‹ç”Ÿæˆä½ çš„é¼“å‹µèªã€‚`;

    const userMessage = { 
        role: 'user', 
        content: `è«‹æ ¹æ“šä½ å’Œæˆ‘çš„è§’è‰²äººè¨­ï¼Œå°æˆ‘æ­£åœ¨é€²è¡Œçš„â€œ${pomodoroState.currentSession.task}â€ä»»å‹™ï¼Œèªªä¸€æ®µé¼“å‹µçš„è©±ã€‚` 
    };

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        
        let requestBody;
        let requestUrl = `${proxyUrl}/v1/chat/completions`;
        let requestHeaders = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getRandomValue(apiKey)}`
        };

        if (isGemini) {
            requestUrl = `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`;
            requestHeaders = {'Content-Type': 'application/json'};
            requestBody = {
                contents: [userMessage],
                generationConfig: {
                    temperature: 0.9,
                    "response_mime_type": "application/json", 
                },
                "systemInstruction": {
                    "parts": [{"text": systemPrompt}]
                }
            };
        } else {
            requestBody = {
                model: model,
                messages: [
                    { role: 'system', content: systemPrompt },
                    userMessage
                ],
                temperature: 0.9,
                response_format: { type: "json_object" }
            };
        }

        const response = await fetch(requestUrl, {
            method: 'POST',
            headers: requestHeaders,
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '').trim();
        const responseObj = JSON.parse(rawContent);

        if (responseObj.type === 'pomodoro_talk' && responseObj.content) {
            const logEntry = { timestamp: Date.now(), content: responseObj.content };
            pomodoroState.currentSession.log.push(logEntry);
            
            const logEl = document.getElementById('pomodoro-char-log');
            logEl.textContent = responseObj.content;
            logEl.classList.add('visible');
            setTimeout(() => {
                logEl.classList.remove('visible');
            }, 4000);
        }
    } catch (error) {
        console.error("ç•ªèŒ„é˜AIäº’å‹•å¤±æ•—:", error);
        const logEl = document.getElementById('pomodoro-char-log');
        logEl.textContent = `[éŒ¯èª¤: APIèª¿ç”¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥F12æ§åˆ¶å°]`;
        logEl.classList.add('visible');
        setTimeout(() => {
            logEl.classList.remove('visible');
        }, 10000);
    }
}
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘ç™¼é€æƒ…ä¾¶ç©ºé–“é‚€è«‹
 * @param {string} targetChatId - è¢«é‚€è«‹çš„è§’è‰²ID
 */
async function sendLoversSpaceInvitation(targetChatId) {
    const chat = state.chats[targetChatId];
    if (!chat) return;

    const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
    
    // 1. å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„â€œé‚€è«‹å¡ç‰‡â€æ¶ˆæ¯
    const visibleMessage = {
        role: 'user',
        senderName: myNickname,
        type: 'lovers_space_invitation',
        content: `${myNickname} å° ${chat.name} ç™¼é€äº†ä¸€å€‹æƒ…ä¾¶ç©ºé–“é‚€è«‹`, // <-- å°±æ˜¯åœ¨é€™è£¡æ–°å¢äº†é€™ä¸€è¡Œï¼
        timestamp: Date.now(),
        status: 'pending' // ç‹€æ…‹ï¼špending, accepted, rejected
    };
    chat.history.push(visibleMessage);

    // 2. å‰µå»ºå°AIå¯è¦‹çš„â€œéš±è—æŒ‡ä»¤â€æ¶ˆæ¯
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»çµ±æŒ‡ä»¤ï¼šç”¨æˆ¶å‰›å‰›å‘ä½ ç™¼èµ·äº†â€œé–‹å•Ÿæƒ…ä¾¶ç©ºé–“â€çš„é‚€è«‹ã€‚è«‹ä½ æ ¹æ“šäººè¨­ï¼Œæ±ºå®šæ˜¯å¦åŒæ„ï¼Œä¸¦ä½¿ç”¨ 'lovers_space_response' æŒ‡ä»¤å›æ‡‰ã€‚]`,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);
    
    // 3. ä¿å­˜ä¸¦è§¸ç™¼AIå›æ‡‰
    await db.chats.put(chat);
    triggerAiResponse();
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„ã€æ­£ä¸Šæ–¹ã€‘é»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶å°æƒ…ä¾¶ç©ºé–“é‚€è«‹çš„å›æ‡‰
 * @param {number} timestamp - è¢«å›æ‡‰çš„é‚€è«‹æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 * @param {string} choice - ç”¨æˆ¶çš„é¸æ“‡, 'accepted' æˆ– 'rejected'
 */
async function handleLoversSpaceResponse(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const invitationMsg = chat.history.find(m => m.timestamp === timestamp);
    if (!invitationMsg || invitationMsg.status !== 'pending') return;

    // 1. æ›´æ–°åŸå§‹é‚€è«‹å¡ç‰‡çš„ç‹€æ…‹
    invitationMsg.status = choice;

    // 2. æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡åŸ·è¡Œæ“ä½œ
    if (choice === 'accepted') {
        // å¦‚æœåŒæ„ï¼Œå°±ç‚ºé€™å€‹è§’è‰²å‰µå»ºæƒ…ä¾¶ç©ºé–“è³‡æ–™
        chat.loversSpaceData = {
            background: 'https://i.postimg.cc/k495F4W5/profile-banner.jpg',
            relationshipStartDate: null,
            moments: [],
            albums: [],
            loveLetters: [],
            shares: [],
            questions: [],
        };
        
        // å‰µå»ºä¸€æ¢å°ä½¿ç”¨è€…å¯è¦‹çš„ç³»çµ±é€šçŸ¥
        const systemNotice = {
            role: 'system',
            type: 'pat_message',
            content: `[ç³»çµ±ï¼šä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾¶ç©ºé–“å·²æˆåŠŸé–‹å•Ÿï¼]`,
            timestamp: Date.now()
        };
        chat.history.push(systemNotice);
    }
    
    // 3. å‰µå»ºä¸€æ¢å°ç”¨æˆ¶éš±è—ï¼Œä½†å°AIå¯è¦‹çš„ç³»çµ±æŒ‡ä»¤ï¼Œå‘Šè¨´AIä½ çš„æ±ºå®š
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»çµ±æŒ‡ä»¤ï¼šç”¨æˆ¶${choice === 'accepted' ? 'åŒæ„äº†' : 'æ‹’çµ•äº†'}ä½ é–‹å•Ÿæƒ…ä¾¶ç©ºé–“çš„é‚€è«‹ã€‚]`,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°è³‡æ–™åº«
    await db.chats.put(chat);
    
    // 5. åˆ·æ–°èŠå¤©ä»‹é¢ï¼Œä¸¦è§¸ç™¼AIçš„å›æ‡‰
    renderChatInterface(state.activeChatId);
    triggerAiResponse();
}

/**
 * ã€å…¨æ–°ã€‘æ‡‰ç”¨ä¸»è¢å¹•åœ–ç¤ºå’Œå°å…ƒä»¶çš„æ–‡å­—é¡è‰²
 * @param {string} color - é¡è‰²ä»£ç¢¼, e.g., '#FFFFFF'
 */
function applyHomeIconWidgetTextColor(color) {
    const phoneScreen = document.getElementById('phone-screen');
    if (phoneScreen && color) {
        // ä½¿ç”¨æ–°çš„CSSè®Šæ•¸å
        phoneScreen.style.setProperty('--home-icon-widget-text-color', color);
    }
}
/**
 * ã€æ–°å¢è¼”åŠ©å‡½æ•¸1ã€‘å°‡æ™‚é•·å­—ä¸²ï¼ˆå¦‚â€œ2.5å°æ™‚â€, "30m"ï¼‰è§£æç‚ºåˆ†é˜æ•¸
 * @param {string} durationString - æ™‚é•·æè¿°æ–‡æœ¬
 * @returns {number} - å°æ‡‰çš„åˆ†é˜æ•¸
 */
function parseDurationToMinutes(durationString) {
    if (!durationString || typeof durationString !== 'string') return 0;
    
    const text = durationString.toLowerCase();
    const num = parseFloat(text.match(/(\d+(\.\d+)?)/)?.[0]) || 0;

    if (text.includes('å°æ™‚') || text.includes('h')) {
        return num * 60;
    }
    if (text.includes('åˆ†é˜') || text.includes('m')) {
        return num;
    }
    // å¦‚æœæ²’æœ‰å–®ä½ï¼Œä½†æ•¸å€¼å¤§æ–¼ç­‰æ–¼10ï¼Œæˆ‘å€‘çŒœæ¸¬æ˜¯åˆ†é˜
    if (num >= 10) {
        return num;
    }
    // å…¶ä»–æƒ…æ³ï¼ˆå¦‚æ•¸å€¼å¾ˆå°ä¸”ç„¡å–®ä½ï¼‰ï¼ŒçŒœæ¸¬æ˜¯å°æ™‚
    return num * 60;
}

/**
 * ã€æ–°å¢è¼”åŠ©å‡½æ•¸2ã€‘å°‡ç¸½åˆ†é˜æ•¸æ ¼å¼åŒ–ç‚º "Xå°æ™‚Yåˆ†é˜" çš„å­—ä¸²
 * @param {number} totalMinutes - ç¸½åˆ†é˜æ•¸
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„æ™‚é•·å­—ä¸²
 */
function formatMinutesToDuration(totalMinutes) {
    if (totalMinutes < 1) return 'ä¸åˆ°1åˆ†é˜';
    
    const hours = Math.floor(totalMinutes / 60);
    const minutes = Math.round(totalMinutes % 60);

    if (hours > 0 && minutes > 0) {
        return `${hours}å°æ™‚${minutes}åˆ†é˜`;
    } else if (hours > 0) {
        return `${hours}å°æ™‚`;
    } else {
        return `${minutes}åˆ†é˜`;
    }
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­/å°çµ„åˆ†é¡ç¯©é¸åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ openForumFilterModal å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹åˆ†é¡ç¯©é¸æ¨¡æ…‹æ¡† (V3 - å·²åˆ†é›¢å°çµ„å’Œå¸–å­çš„åˆ†é¡)
 * @param {'global' | 'group'} type - ç¯©é¸é¡å‹ï¼š'global'ç‚ºä¸»é ç¯©é¸å°çµ„ï¼Œ'group'ç‚ºå°çµ„å…§ç¯©é¸å¸–å­
 * @param {number|null} id - å¦‚æœæ˜¯å°çµ„å…§ç¯©é¸ï¼Œå‰‡ç‚ºå°çµ„çš„ID
 */
async function openForumFilterModal(type, id = null) {
    currentFilterContext = { type, id };
    const modal = document.getElementById('forum-filter-modal');
    const listEl = document.getElementById('forum-filter-category-list');
    listEl.innerHTML = '';

    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ­£ï¼šæ ¹æ“šä¸Šä¸‹æ–‡ï¼Œå¾ä¸åŒçš„åœ°æ–¹æ”¶é›†åˆ†é¡ â–¼â–¼â–¼ ---
    let availableCategories = new Set(); // ä½¿ç”¨Setä¾†è‡ªå‹•å»é‡

    try {
        if (type === 'global') {
            // å¦‚æœæ˜¯åœ¨â€œåœˆå­â€ä¸»é ï¼Œæˆ‘å€‘åªé—œå¿ƒã€å°çµ„ã€‘çš„åˆ†é¡
            console.log("æ­£åœ¨ç‚ºå°çµ„åˆ—è¡¨æ”¶é›†åˆ†é¡...");
            const allGroups = await db.forumGroups.toArray();
            allGroups.forEach(group => {
                if (group.categories) {
                    group.categories.forEach(cat => availableCategories.add(cat));
                }
            });
        } else if (type === 'group' && id) {
            // å¦‚æœæ˜¯åœ¨å…·é«”çš„â€œå°çµ„â€é é¢ï¼Œæˆ‘å€‘åªé—œå¿ƒè©²å°çµ„ä¸‹ã€å¸–å­ã€‘çš„åˆ†é¡
            console.log(`æ­£åœ¨ç‚ºå°çµ„ ID: ${id} çš„å¸–å­åˆ—è¡¨æ”¶é›†åˆ†é¡...`);
            const postsInGroup = await db.forumPosts.where('groupId').equals(id).toArray();
            postsInGroup.forEach(post => {
                if (post.categories) {
                    post.categories.forEach(cat => availableCategories.add(cat));
                }
            });
        }
    } catch (error) {
        console.error("æ”¶é›†åˆ†é¡æ¨™ç±¤æ™‚å‡ºéŒ¯:", error);
    }
    // --- â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² ---

    const categoryArray = Array.from(availableCategories).sort(); // è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº

    if (categoryArray.length === 0) {
        listEl.innerHTML = '<p style="color: var(--text-secondary); padding: 20px;">ç•¶å‰æ²’æœ‰ä»»ä½•å¯ç”¨çš„åˆ†é¡æ¨™ç±¤ã€‚</p>';
    } else {
        const activeFilters = type === 'global' ? activeForumFilters.global : (activeForumFilters.group[id] || []);
        
        categoryArray.forEach((catName, index) => {
            const isChecked = activeFilters.includes(catName);
            const label = document.createElement('label');
            const inputId = `filter-cat-${type}-${index}`; // å‰µå»ºå”¯ä¸€çš„ID
            label.setAttribute('for', inputId);
            label.innerHTML = `
                <input type="checkbox" id="${inputId}" value="${catName}" ${isChecked ? 'checked' : ''}>
                <span>${catName}</span>
            `;
            listEl.appendChild(label);
        });
    }
    
    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * æ‡‰ç”¨ç¯©é¸æ¢ä»¶ä¸¦åˆ·æ–°åˆ—è¡¨
 */
async function applyForumFilter() {
    const { type, id } = currentFilterContext;
    const selectedCategories = Array.from(document.querySelectorAll('#forum-filter-category-list input:checked')).map(cb => cb.value);

    const filterBtnId = type === 'global' ? 'forum-filter-btn' : 'group-filter-btn';
    const filterBtn = document.getElementById(filterBtnId);

    if (type === 'global') {
        activeForumFilters.global = selectedCategories;
        await renderForumScreen();
    } else if (type === 'group' && id) {
        if (!activeForumFilters.group[id]) activeForumFilters.group[id] = [];
        activeForumFilters.group[id] = selectedCategories;
        await renderGroupPosts(id);
    }
    
    // æ ¹æ“šæ˜¯å¦æ‡‰ç”¨äº†ç¯©é¸ï¼Œæ›´æ–°åœ–ç¤ºç‹€æ…‹
    if (selectedCategories.length > 0) {
        filterBtn.classList.add('active');
    } else {
        filterBtn.classList.remove('active');
    }

    document.getElementById('forum-filter-modal').classList.remove('visible');
}

// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™è£¡æ˜¯ç‹¼äººæ®ºéŠæˆ²çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€ç‹¼äººæ®ºã€‘æ‰“é–‹éŠæˆ²è¨­ç½®ä»‹é¢
 */
async function openWerewolfSetup() {
    showScreen('werewolf-setup-screen');
    const selectionEl = document.getElementById('werewolf-player-selection');
    selectionEl.innerHTML = '<p>æ­£åœ¨è¼‰å…¥è§’è‰²åˆ—è¡¨...</p>';

    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    const allNpcs = Object.values(state.chats).flatMap(chat => (chat.npcLibrary || []).map(npc => ({...npc, owner: chat.name})));

    let playerOptions = [
        ...singleChats.map(c => ({ id: c.id, name: c.name, avatar: c.settings.aiAvatar, type: 'è§’è‰²' })),
        ...allNpcs.map(n => ({ id: n.id, name: n.name, avatar: n.avatar, type: `NPC (${n.owner})` }))
    ];

    selectionEl.innerHTML = '';
    playerOptions.forEach(player => {
        const item = document.createElement('div');
        item.className = 'player-selection-item';
        item.innerHTML = `
            <input type="checkbox" class="werewolf-player-checkbox" value="${player.id}">
            <img src="${player.avatar || defaultAvatar}" alt="${player.name}">
            <span class="name">${player.name}</span>
            <span class="type-tag">${player.type}</span>
        `;
        selectionEl.appendChild(item);
    });
}

/**
 * ã€ç‹¼äººæ®ºã€‘é–‹å§‹éŠæˆ²çš„æ ¸å¿ƒé‚è¼¯
 */
async function startWerewolfGame() {
    const countSelect = document.getElementById('werewolf-player-count');
    const totalPlayers = parseInt(countSelect.value);
    
    const selectedCheckboxes = document.querySelectorAll('.werewolf-player-checkbox:checked');
    // é‚€è«‹çš„AI/NPCæ•¸é‡å¿…é ˆæ˜¯ç¸½äººæ•¸-1ï¼ˆå› ç‚ºUseræ˜¯å¿…é ˆåŠ å…¥çš„ï¼‰
    if (selectedCheckboxes.length !== totalPlayers - 1) {
        alert(`è«‹é¸æ“‡ ${totalPlayers - 1} ä½AIæˆ–NPCç©å®¶ï¼`);
        return;
    }

    // --- 1. é‡ç½®ä¸¦åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹ ---
    werewolfGameState = {
        isActive: true,
        players: [],
        roles: {},
        gamePhase: 'start',
        dayNumber: 0,
        gameLog: [],
        turnIndex: 0,
        votes: {},
        seerLastNightResult: null,
        witchPotions: { save: 1, poison: 1 },
        hunterTarget: null,
        lastNightKilled: [],
        waitingFor: null,
        gameConfig: { totalPlayers }
    };

    // --- 2. æ”¶é›†ç©å®¶è³‡è¨Š ---
    // æ·»åŠ User
    werewolfGameState.players.push({
        id: 'user',
        name: state.qzoneSettings.nickname || 'æˆ‘',
        avatar: state.qzoneSettings.avatar || defaultAvatar,
        isAlive: true,
        isUser: true // æ¨™è¨˜ç‚ºçœŸå¯¦ä½¿ç”¨è€…
    });

    // æ·»åŠ è¢«é‚€è«‹çš„AIå’ŒNPC
    selectedCheckboxes.forEach(checkbox => {
        const playerId = checkbox.value;
        const chat = Object.values(state.chats).find(c => c.id === playerId);
        if (chat) { // æ˜¯ä¸»è¦è§’è‰²
            werewolfGameState.players.push({
                id: chat.id,
                name: chat.name,
                avatar: chat.settings.aiAvatar,
                persona: chat.settings.aiPersona,
                isAlive: true,
                isUser: false
            });
        } else { // æ˜¯NPC
            for (const c of Object.values(state.chats)) {
                const npc = (c.npcLibrary || []).find(n => n.id === playerId);
                if (npc) {
                    werewolfGameState.players.push({
                        id: npc.id,
                        name: npc.name,
                        avatar: npc.avatar,
                        persona: npc.persona,
                        isAlive: true,
                        isUser: false
                    });
                    break;
                }
            }
        }
    });

    // æ‰“äº‚ç©å®¶é †åºï¼ˆåº§ä½é †åºï¼‰
    werewolfGameState.players.sort(() => Math.random() - 0.5);

    // --- 3. æ ¹æ“šäººæ•¸åˆ†é…è§’è‰² ---
    const roleConfigs = {
        6: { wolf: 2, villager: 2, seer: 1, guard: 1 },
        9: { wolf: 3, villager: 3, seer: 1, witch: 1, hunter: 1 },
        12: { wolf: 4, villager: 4, seer: 1, witch: 1, hunter: 1, idiot: 1 }
    };
    // â–¼â–¼â–¼ ã€æ ¸å¿ƒBugä¿®å¾©ã€‘ç”¨é€™å¡Šä»£ç¢¼æ›¿æ›ä¸Šé¢çš„éŒ¯èª¤ä»£ç¢¼ â–¼â–¼â–¼
    const rolesToAssign = [];
    const config = roleConfigs[totalPlayers];
    werewolfGameState.roles = config; // å°‡è§’è‰²é…ç½®å­˜å…¥éŠæˆ²ç‹€æ…‹
    for (const role in config) {
        for (let i = 0; i < config[role]; i++) { // ä¿®æ­£ï¼šconfig[i] -> config[role]
            rolesToAssign.push(role);
        }
    }
    // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
    rolesToAssign.sort(() => Math.random() - 0.5); // æ‰“äº‚è§’è‰²

    werewolfGameState.players.forEach((player, index) => {
        player.role = rolesToAssign[index];
    });
    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
    // â–¼â–¼â–¼ ç¬¬1è™•ä¿®æ”¹ï¼ˆæ·»åŠ ç¿»è­¯ï¼‰â–¼â–¼â–¼
    const roleNameMap = {
        wolf: 'ç‹¼äºº',
        villager: 'å¹³æ°‘',
        seer: 'é è¨€å®¶',
        witch: 'å¥³å·«',
        hunter: 'çµäºº',
        guard: 'å®ˆè¡›',
        idiot: 'ç™½ç™¡'
    };

    // å½ˆçª—å‘ŠçŸ¥ç”¨æˆ¶èº«ä»½
    const userPlayer = werewolfGameState.players.find(p => p.isUser);
    if (userPlayer) {
        const myRoleName = roleNameMap[userPlayer.role] || userPlayer.role;
        await showCustomAlert("ä½ çš„èº«ä»½", `ä½ åœ¨æœ¬å±€éŠæˆ²ä¸­çš„èº«ä»½æ˜¯ï¼šã€${myRoleName}ã€‘`);
    }
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
    // --- 4. åˆ‡æ›åˆ°éŠæˆ²ä»‹é¢ä¸¦é–‹å§‹éŠæˆ²è¿´åœˆ ---
    showScreen('werewolf-game-screen');
    await processGameTurn();
}

// â–¼â–¼â–¼ ç”¨é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„éŠæˆ²å¼•æ“ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ processGameTurn å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€ç‹¼äººæ®º V2ã€‘éŠæˆ²ä¸»è¿´åœˆ/å¼•æ“
 */
async function processGameTurn() {
    if (!werewolfGameState.isActive) return;

    renderWerewolfGameScreen();
    
    switch (werewolfGameState.gamePhase) {
        case 'start':
            logToWerewolfGame('éŠæˆ²é–‹å§‹ï¼Œæ­£åœ¨åˆ†é…èº«ä»½...');
            const roleNameMapForLog = {
                wolf: 'ç‹¼äºº', villager: 'å¹³æ°‘', seer: 'é è¨€å®¶',
                witch: 'å¥³å·«', hunter: 'çµäºº', guard: 'å®ˆè¡›', idiot: 'ç™½ç™¡'
            };
            const configText = Object.entries(werewolfGameState.roles)
                .map(([role, count]) => `${roleNameMapForLog[role] || role}x${count}`)
                .join(', ');
            logToWerewolfGame(`æœ¬å±€é…ç½®: ${configText}`);
            werewolfGameState.gamePhase = 'night_start';
            await sleep(3000);
            await processGameTurn();
            break;

        case 'night_start':
            werewolfGameState.dayNumber++;
            werewolfGameState.lastNightKilled = [];
            werewolfGameState.votes = {};
            logToWerewolfGame(`ç¬¬ ${werewolfGameState.dayNumber} å¤©ï¼Œå¤©é»‘è«‹é–‰çœ¼ã€‚`);
            werewolfGameState.gamePhase = 'guard_action'; // å¾å®ˆè¡›é–‹å§‹
            await sleep(2000);
            await processGameTurn();
            break;
        
        // ã€å®ˆè¡›è¡Œå‹•éšæ®µã€‘
        case 'guard_action':
            const guard = werewolfGameState.players.find(p => p.role === 'guard' && p.isAlive);
            if (guard) {
                logToWerewolfGame('å®ˆè¡›è«‹çœçœ¼ï¼Œè«‹é¸æ“‡ä½ è¦å®ˆè­·çš„ç©å®¶ã€‚');
                let protectedId;
                // â˜…â˜…â˜… æ ¸å¿ƒæª¢æŸ¥é»1ï¼šåˆ¤æ–·å®ˆè¡›æ˜¯ä¸æ˜¯User â˜…â˜…â˜…
                if (guard.isUser) {
                    // å¦‚æœæ˜¯ï¼Œå°±èª¿ç”¨waitForUserActionï¼Œé€™æœƒå½ˆå‡ºæ“ä½œæ¡†
                    protectedId = await waitForUserAction('è«‹é¸æ“‡ä½ è¦å®ˆè­·çš„ç©å®¶', 'guard_protect');
                } else {
                    // å¦‚æœä¸æ˜¯ï¼Œå°±è®“AIè‡ªå·±æ±ºç­–
                    protectedId = await triggerWerewolfAiAction(guard.id, 'guard_protect');
                }
                werewolfGameState.guardLastNightProtected = protectedId;
                logToWerewolfGame(`å®ˆè¡›è«‹é–‰çœ¼ã€‚`);
            }
            werewolfGameState.gamePhase = 'wolf_action';
            await sleep(2000);
            await processGameTurn();
            break;

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€ç‹¼äººé »é“å¢å¼·+å¹³ç¥¨è™•ç†ç‰ˆã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ 'wolf_action' case â–¼â–¼â–¼
case 'wolf_action':
    logToWerewolfGame('ç‹¼äººè«‹çœçœ¼ï¼Œè«‹é¸æ“‡ä¸€å€‹ç›®æ¨™ã€‚');
    const wolves = werewolfGameState.players.filter(p => p.role === 'wolf' && p.isAlive);
    const userPlayer = wolves.find(w => w.isUser);
    let allWolfVotes = [];

    // å ´æ™¯1: ç”¨æˆ¶æ˜¯ç‹¼äºº
    if (userPlayer) {
        const aiWolves = wolves.filter(w => !w.isUser);
        let suggestionsText = "ğŸº ç‹¼äººé »é“ (ç§˜å¯†):\n";
        
        if (aiWolves.length > 0) {
            // å¾AIéšŠå‹ç²å–å»ºè­°
            const aiVotePromises = aiWolves.map(wolf => 
                triggerWerewolfAiAction(wolf.id, 'wolf_kill', { isUserWolfAlly: true })
            );
            const aiVotes = (await Promise.all(aiVotePromises)).filter(Boolean);
            allWolfVotes.push(...aiVotes);

            // æ ¼å¼åŒ–å»ºè­°çµ¦ç”¨æˆ¶çœ‹
            aiVotes.forEach((targetId, index) => {
                const votingWolf = aiWolves[index];
                const targetPlayer = werewolfGameState.players.find(p => p.id === targetId);
                if (votingWolf && targetPlayer) {
                    suggestionsText += `- ${votingWolf.name} æè­°æ“Šæ®º: ${targetPlayer.name}\n`;
                }
            });
            suggestionsText += "\nè«‹åƒè€ƒéšŠå‹æ„è¦‹å¾Œé€²è¡ŒæŠ•ç¥¨ã€‚";
            
            await showCustomAlert("ç‹¼äººè«‹æºé€š", suggestionsText);

        } else {
            await showCustomAlert("ä½ æ˜¯å”¯ä¸€çš„ç‹¼", "è«‹ç¨è‡ªæ±ºå®šä»Šæ™šçš„ç›®æ¨™ã€‚");
        }
        
        // ç²å–ç”¨æˆ¶çš„æœ€çµ‚æŠ•ç¥¨
        const userVote = await waitForUserAction('è«‹é¸æ“‡æœ€çµ‚æ”»æ“Šç›®æ¨™', 'wolf_kill');
        if (userVote) {
            allWolfVotes.push(userVote);
        }

    } else { // å ´æ™¯2: ç”¨æˆ¶ä¸æ˜¯ç‹¼äººï¼ŒAIç‹¼äººè‡ªè¡Œæ±ºå®š
        const wolfPromises = wolves.map(wolf => triggerWerewolfAiAction(wolf.id, 'wolf_kill'));
        const wolfVotes = (await Promise.all(wolfPromises)).filter(Boolean);
        allWolfVotes.push(...wolfVotes);
    }
    
    // çµ±è¨ˆæ‰€æœ‰ç‹¼äººçš„æŠ•ç¥¨
    const voteCounts = {};
    allWolfVotes.forEach(vote => { voteCounts[vote] = (voteCounts[vote] || 0) + 1; });
    
    let maxVotes = 0;
    let targetId = null;
    let tied = false;
    for(const id in voteCounts) {
        if(voteCounts[id] > maxVotes) {
            maxVotes = voteCounts[id];
            targetId = id;
            tied = false;
        } else if (voteCounts[id] === maxVotes) {
            tied = true;
        }
    }

    // â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘æ–°å¢çš„å¹³ç¥¨è™•ç†é‚è¼¯ï¼â˜…â˜…â˜…
    if (tied && maxVotes > 0) {
         // å¦‚æœå‡ºç¾å¹³ç¥¨ï¼Œå°±å¾æ‰€æœ‰å¹³ç¥¨çš„ç›®æ¨™ä¸­éš¨æ©Ÿé¸æ“‡ä¸€å€‹
         const tiedTargets = Object.keys(voteCounts).filter(id => voteCounts[id] === maxVotes);
         targetId = tiedTargets[Math.floor(Math.random() * tiedTargets.length)];
         logToWerewolfGame(`(ç‹¼äººå…§éƒ¨ç¶“éä¸€ç•ªæ¿€çƒˆè¨è«–ï¼Œæœ€çµ‚æ±ºå®šç›®æ¨™ç‚º ${werewolfGameState.players.find(p=>p.id === targetId).name})`);
    }

    if (targetId) { // åªè¦æœ‰ç›®æ¨™ï¼ˆç„¡è«–æ˜¯çµ±ä¸€æ„è¦‹é‚„æ˜¯éš¨æ©Ÿæ±ºå®šï¼‰ï¼Œå°±åŸ·è¡Œæ“Šæ®º
        werewolfGameState.lastNightKilled = [targetId];
        logToWerewolfGame(`ç‹¼äººè«‹é–‰çœ¼ã€‚`);
    } else {
         // åªæœ‰åœ¨æ‰€æœ‰ç‹¼äººéƒ½æ²’æŠ•ç¥¨çš„æƒ…æ³ä¸‹ï¼Œæ‰æœƒæ˜¯å¹³å®‰å¤œ
         logToWerewolfGame(`ç‹¼äººæ”¾æ£„äº†è¡Œå‹•ï¼Œä»Šæ™šç„¡äººè¢«è¥²æ“Šã€‚`);
         werewolfGameState.lastNightKilled = [];
    }
    
    // é€²å…¥ä¸‹ä¸€å€‹éŠæˆ²éšæ®µ
    werewolfGameState.gamePhase = 'seer_action';
    await sleep(2000);
    await processGameTurn();
    break;
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        // ã€é è¨€å®¶è¡Œå‹•éšæ®µã€‘
        case 'seer_action':
            const seer = werewolfGameState.players.find(p => p.role === 'seer' && p.isAlive);
            if (seer) {
                logToWerewolfGame('é è¨€å®¶è«‹çœçœ¼ï¼Œè«‹é¸æ“‡ä½ è¦æŸ¥é©—çš„ç©å®¶ã€‚');
                let targetId;
                // â˜…â˜…â˜… æ ¸å¿ƒæª¢æŸ¥é»3ï¼šåˆ¤æ–·é è¨€å®¶æ˜¯ä¸æ˜¯User â˜…â˜…â˜…
                if (seer.isUser) {
                    targetId = await waitForUserAction('è«‹é¸æ“‡ä½ è¦æŸ¥é©—çš„ç©å®¶', 'seer_check');
                } else {
                    targetId = await triggerWerewolfAiAction(seer.id, 'seer_check');
                }
                const targetPlayer = werewolfGameState.players.find(p => p.id === targetId);
                const isWolf = targetPlayer.role === 'wolf';
                werewolfGameState.seerLastNightResult = { targetName: targetPlayer.name, isWolf: isWolf };
                logToWerewolfGame(`é è¨€å®¶è«‹é–‰çœ¼ã€‚`);
                if(seer.isUser) {
                     await showCustomAlert('æŸ¥é©—çµæœ', `${targetPlayer.name} çš„èº«ä»½æ˜¯ï¼š${isWolf ? 'ç‹¼äºº' : 'å¥½äºº'}`);
                }
            }
            werewolfGameState.gamePhase = 'witch_action';
            await sleep(2000);
            await processGameTurn();
            break;
        
        // ã€å¥³å·«è¡Œå‹•éšæ®µã€‘
        case 'witch_action':
            const witch = werewolfGameState.players.find(p => p.role === 'witch' && p.isAlive);
            if (witch) {
                logToWerewolfGame('å¥³å·«è«‹çœçœ¼ã€‚');
                const killedId = werewolfGameState.lastNightKilled[0];
                let killedPlayerName = null;
                if (killedId) {
                     killedPlayerName = werewolfGameState.players.find(p => p.id === killedId).name;
                     logToWerewolfGame(`ä»Šæ™š ${killedPlayerName} è¢«è¥²æ“Šäº†ã€‚`);
                }

                let witchAction;
                 // â˜…â˜…â˜… æ ¸å¿ƒæª¢æŸ¥é»4ï¼šåˆ¤æ–·å¥³å·«æ˜¯ä¸æ˜¯User â˜…â˜…â˜…
                if (witch.isUser) {
                    witchAction = await waitForUserAction('å¥³å·«è«‹è¡Œå‹•', 'witch_action', { killedId, killedPlayerName });
                } else {
                    witchAction = await triggerWerewolfAiAction(witch.id, 'witch_action', { killedId });
                }

                if (witchAction?.action === 'save' && killedId) {
                    werewolfGameState.lastNightKilled = [];
                    werewolfGameState.witchPotions.save = 0;
                } else if (witchAction?.action === 'poison' && witchAction.targetId) {
                    werewolfGameState.lastNightKilled.push(witchAction.targetId);
                    werewolfGameState.witchPotions.poison = 0;
                }
            }
            logToWerewolfGame(`å¥³å·«è«‹é–‰çœ¼ã€‚`);
            werewolfGameState.gamePhase = 'day_start';
            await sleep(2000);
            await processGameTurn();
            break;

        case 'day_start':
            logToWerewolfGame('å¤©äº®äº†ã€‚');
            let deathAnnouncements = [];
            const deathsThisNight = new Set();
            
            werewolfGameState.lastNightKilled.forEach(killedId => {
                if (killedId === werewolfGameState.guardLastNightProtected) {
                    logToWerewolfGame(`æ˜¨æ™š ${werewolfGameState.players.find(p=>p.id === killedId).name} è¢«è¥²æ“Šä½†åŒæ™‚ä¹Ÿè¢«å®ˆè­·äº†ã€‚`);
                } else {
                    deathsThisNight.add(killedId);
                }
            });

            if (deathsThisNight.size === 0) {
                 logToWerewolfGame('æ˜¨æ™šæ˜¯ä¸€å€‹å¹³å®‰å¤œã€‚');
            } else {
                deathsThisNight.forEach(deadId => {
                    const deadPlayer = werewolfGameState.players.find(p => p.id === deadId);
                    if (deadPlayer.isAlive) {
                        deadPlayer.isAlive = false;
                        deathAnnouncements.push(`${deadPlayer.name} æ˜¨æ™šè¢«æ·˜æ±°äº†ã€‚`);
                    }
                });
                deathAnnouncements.forEach(announcement => logToWerewolfGame(announcement));
            }
            
            renderWerewolfGameScreen();
            if (checkGameOver()) return;
            
            let hunterDied = null;
            deathsThisNight.forEach(deadId => {
                const deadPlayer = werewolfGameState.players.find(p => p.id === deadId);
                if (deadPlayer.role === 'hunter') hunterDied = deadPlayer;
            });

            if(hunterDied) {
                logToWerewolfGame(`${hunterDied.name} æ˜¯çµäººï¼Œå¯ä»¥é¸æ“‡ä¸€åç©å®¶å¸¶èµ°ã€‚`);
                let targetId;
                // â˜…â˜…â˜… æ ¸å¿ƒæª¢æŸ¥é»5ï¼šåˆ¤æ–·çµäººæ˜¯ä¸æ˜¯User â˜…â˜…â˜…
                if (hunterDied.isUser) {
                    targetId = await waitForUserAction('è«‹é¸æ“‡ä½ è¦å¸¶èµ°çš„ç©å®¶', 'hunter_shoot');
                } else {
                    targetId = await triggerWerewolfAiAction(hunterDied.id, 'hunter_shoot');
                }
                if(targetId){
                    const targetPlayer = werewolfGameState.players.find(p => p.id === targetId);
                    targetPlayer.isAlive = false;
                    logToWerewolfGame(`çµäººé–‹æ§å¸¶èµ°äº† ${targetPlayer.name}ã€‚`);
                    renderWerewolfGameScreen();
                    if (checkGameOver()) return;
                }
            }

            werewolfGameState.gamePhase = 'day_discussion';
            await sleep(2000);
            await processGameTurn();
            break;

        case 'day_discussion':
            logToWerewolfGame('ç¾åœ¨é–‹å§‹ä¾æ¬¡ç™¼è¨€ã€‚');
            const alivePlayersForSpeech = werewolfGameState.players.filter(p => p.isAlive);
            for (const player of alivePlayersForSpeech) {
                renderWerewolfGameScreen({ speakingPlayerId: player.id });
                let speech;
                if (player.isUser) {
                    speech = await waitForUserAction('è¼ªåˆ°ä½ ç™¼è¨€', 'speak');
                } else {
                    speech = await triggerWerewolfAiAction(player.id, 'speak');
                }
                logToWerewolfGame({ player: player, speech: speech }, 'speech');
                await sleep(1000);
            }
            renderWerewolfGameScreen();
            werewolfGameState.gamePhase = 'day_vote';
            await processGameTurn();
            break;
            
        case 'day_vote':
            logToWerewolfGame('è«‹æŠ•ç¥¨é¸å‡ºä½ èªç‚ºæ˜¯ç‹¼äººçš„ç©å®¶ã€‚');
            const voterPromises = werewolfGameState.players.filter(p => p.isAlive).map(player => {
                if (player.isUser) {
                    return waitForUserAction('è«‹æŠ•ç¥¨', 'vote');
                } else {
                    return triggerWerewolfAiAction(player.id, 'vote');
                }
            });
            const allVotesResult = (await Promise.all(voterPromises)).filter(Boolean);
            
            const voteTallyResult = {};
            allVotesResult.forEach(vote => { voteTallyResult[vote] = (voteTallyResult[vote] || 0) + 1; });
            
            let maxVotesResult = 0, playersToEliminate = [];
            for (const playerId in voteTallyResult) {
                if (voteTallyResult[playerId] > maxVotesResult) {
                    maxVotesResult = voteTallyResult[playerId];
                    playersToEliminate = [playerId];
                } else if (voteTallyResult[playerId] === maxVotesResult) {
                    playersToEliminate.push(playerId);
                }
            }

            if(playersToEliminate.length === 1) {
                const eliminatedPlayer = werewolfGameState.players.find(p => p.id === playersToEliminate[0]);
                eliminatedPlayer.isAlive = false;
                logToWerewolfGame(`æŠ•ç¥¨çµæœï¼š${eliminatedPlayer.name} è¢«æ·˜æ±°ã€‚`);
                renderWerewolfGameScreen();
                if (checkGameOver()) return;
                if (eliminatedPlayer.role === 'hunter') {
                    logToWerewolfGame(`${eliminatedPlayer.name} æ˜¯çµäººï¼Œå¯ä»¥é¸æ“‡ä¸€åç©å®¶å¸¶èµ°ã€‚`);
                    let targetId;
                    if (eliminatedPlayer.isUser) {
                        targetId = await waitForUserAction('è«‹é¸æ“‡ä½ è¦å¸¶èµ°çš„ç©å®¶', 'hunter_shoot');
                    } else {
                        targetId = await triggerWerewolfAiAction(eliminatedPlayer.id, 'hunter_shoot');
                    }
                    if(targetId){
                        const targetPlayer = werewolfGameState.players.find(p => p.id === targetId);
                        targetPlayer.isAlive = false;
                        logToWerewolfGame(`çµäººé–‹æ§å¸¶èµ°äº† ${targetPlayer.name}ã€‚`);
                        renderWerewolfGameScreen();
                        if (checkGameOver()) return;
                    }
                }
            } else {
                logToWerewolfGame('æŠ•ç¥¨å¹³ç¥¨ï¼Œç„¡äººå‡ºå±€ã€‚');
            }

            werewolfGameState.gamePhase = 'night_start';
            await sleep(3000);
            await processGameTurn();
            break;
    }
}
// â–²â–²â–² æ–°å¼•æ“ä»£ç¢¼çµæŸ â–²â–²â–²

/**
 * ã€ç‹¼äººæ®ºã€‘æ¸²æŸ“éŠæˆ²ä¸»ä»‹é¢
 */
function renderWerewolfGameScreen(options = {}) {
    const playersGrid = document.getElementById('werewolf-players-grid');
    const logContainer = document.getElementById('werewolf-game-log');
    
    // æ¸²æŸ“ç©å®¶åº§ä½
    playersGrid.innerHTML = '';
    werewolfGameState.players.forEach(player => {
        const seat = document.createElement('div');
        seat.className = 'player-seat';
        const avatarClass = `player-avatar ${!player.isAlive ? 'dead' : ''} ${options.speakingPlayerId === player.id ? 'speaking' : ''} ${options.activePlayerId === player.id ? 'active-turn' : ''}`;
        
        let roleIndicator = '';
        const user = werewolfGameState.players.find(p => p.isUser);
        // å¦‚æœæˆ‘æ˜¯ç‹¼äººï¼Œé¡¯ç¤ºæ‰€æœ‰ç‹¼äººéšŠå‹
        if (user.role === 'wolf' && player.role === 'wolf') {
            roleIndicator = '<div class="player-role-indicator" style="display: flex;">W</div>';
        }

        seat.innerHTML = `
            ${roleIndicator}
            <img src="${player.avatar}" class="${avatarClass}">
            <span class="player-name">${player.name} (${player.isAlive ? 'å­˜æ´»' : 'æ·˜æ±°'})</span>
        `;
        playersGrid.appendChild(seat);
    });

// æ¸²æŸ“éŠæˆ²æ—¥èªŒ
logContainer.innerHTML = werewolfGameState.gameLog.map(log => {
    // åˆ¤æ–·æ˜¯å¦ç‚ºç™¼è¨€é¡å‹çš„æ—¥èªŒ
    if (log.type === 'speech' && typeof log.message === 'object') {
        const { player, speech } = log.message;
        // å¦‚æœæ˜¯ï¼Œå°±æ¸²æŸ“å¸¶æœ‰é ­åƒçš„æ–°çµæ§‹
        return `
            <div class="log-entry speech">
                <img src="${player.avatar}" class="speech-avatar">
                <div class="speech-content">
                    <span class="speaker">${player.name}</span>
                    <span class="speech-text">${speech.replace(/\n/g, '<br>')}</span>
                </div>
            </div>
        `;
    } else {
        // å¦å‰‡ï¼Œä¿æŒåŸä¾†çš„ç³»çµ±æ¶ˆæ¯æ¨£å¼
        return `<div class="log-entry ${log.type}">${String(log.message).replace(/\n/g, '<br>')}</div>`;
    }
}).join('');
    logContainer.scrollTop = logContainer.scrollHeight;
}

/**
 * ã€ç‹¼äººæ®ºã€‘ç­‰å¾…ç”¨æˆ¶æŠ•ç¥¨
 */
function waitForUserVote() {
    return new Promise(resolve => {
        const actionArea = document.getElementById('werewolf-action-area');
        const alivePlayers = werewolfGameState.players.filter(p => p.isAlive && !p.isUser);
        
        actionArea.innerHTML = '<h5>è«‹æŠ•ç¥¨:</h5>';
        const grid = document.createElement('div');
        grid.className = 'vote-target-grid';

        alivePlayers.forEach(player => {
            const btn = document.createElement('button');
            btn.className = 'form-button-secondary vote-target-btn';
            btn.textContent = player.name;
            btn.onclick = () => {
                actionArea.innerHTML = '';
                resolve(player.id);
            };
            grid.appendChild(btn);
        });
        actionArea.appendChild(grid);
    });
}


/**
 * ã€ç‹¼äººæ®ºã€‘æ·»åŠ ä¸€æ¢éŠæˆ²æ—¥èªŒ
 */
function logToWerewolfGame(message, type = 'system') {
    werewolfGameState.gameLog.push({ message, type });
    renderWerewolfGameScreen();
}
/**
 * ã€ç‹¼äººæ®º-AIæ ¸å¿ƒã€‘èª¿ç”¨AIç‚ºæ•´å±€éŠæˆ²ç”Ÿæˆè¤‡ç›¤æ‘˜è¦
 * @returns {Promise<string>} - AIç”Ÿæˆçš„æ‘˜è¦æ–‡æœ¬
 */
async function generateAiGameSummary() {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        return "ï¼ˆAIæ‘˜è¦ç”Ÿæˆå¤±æ•—ï¼šAPIæœªé…ç½®ï¼‰";
    }

    // æ ¼å¼åŒ–å®Œæ•´çš„éŠæˆ²æ—¥èªŒï¼Œè®“AIèƒ½å¤ ç†è§£
    const formattedLog = werewolfGameState.gameLog.map(log => {
        if (log.type === 'speech') {
            return `${log.message.player.name}: ${log.message.speech}`;
        }
        return log.message;
    }).join('\n');

    const prompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç‹¼äººæ®ºè¤‡ç›¤åˆ†æå¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹å®Œæ•´çš„éŠæˆ²æ—¥èªŒï¼Œç”¨100-150å­—ï¼Œå®¢è§€ã€ç²¾ç…‰åœ°ç¸½çµæœ¬å±€éŠæˆ²çš„ã€é—œéµäº‹ä»¶ã€‘å’Œã€è½‰æ©é»ã€‘ã€‚

# æ ¸å¿ƒè¦æ±‚
- ä½ çš„ç¸½çµéœ€è¦æœ‰é‚è¼¯ã€æœ‰æ¢ç†ã€‚
- æŒ‡å‡ºé—œéµç©å®¶çš„è¡Œç‚ºï¼Œä¾‹å¦‚é è¨€å®¶çš„æŸ¥é©—ã€å¥³å·«çš„æ“ä½œã€çµäººçš„é–‹æ§ç­‰ã€‚
- åˆ†æç‹¼äººé™£ç‡Ÿå’Œå¥½äººé™£ç‡Ÿçš„åšå¼ˆéç¨‹ã€‚
- ä½ çš„è¼¸å‡ºã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯è¤‡ç›¤æ‘˜è¦çš„ç´”æ–‡å­—å…§å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•é¡å¤–çš„å°è©±æˆ–æ¨™é¡Œã€‚

# éŠæˆ²æ—¥èªŒ
${formattedLog}
`;

    try {
        const messagesForApi = [{ role: 'user', content: prompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.7 })
            });

        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        return (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).trim();
    } catch (error) {
        console.error("AIæ‘˜è¦ç”Ÿæˆå¤±æ•—:", error);
        return "ï¼ˆAIæ‘˜è¦ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–APIè¨­ç½®ï¼‰";
    }
}

/**
 * ã€ç‹¼äººæ®º V2 - å¢å¼·ç‰ˆã€‘ç”ŸæˆéŠæˆ²è¤‡ç›¤çš„æ–‡æœ¬ï¼ŒåŒ…å«AIæ‘˜è¦
 * @param {string} winner - å‹åˆ©çš„é™£ç‡Ÿåç¨±
 * @param {string} aiSummary - AIç”Ÿæˆçš„æ‘˜è¦æ–‡æœ¬
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„å®Œæ•´è¤‡ç›¤Markdownæ–‡æœ¬
 */
function generateWerewolfSummary(winner, aiSummary) {
    const roleNameMap = {
        wolf: 'ç‹¼äºº', villager: 'å¹³æ°‘', seer: 'é è¨€å®¶',
        witch: 'å¥³å·«', hunter: 'çµäºº', guard: 'å®ˆè¡›', idiot: 'ç™½ç™¡'
    };

    let summaryText = `**ç‹¼äººæ®º - éŠæˆ²è¤‡ç›¤**\n\n`; // å„ªåŒ–æ¨™é¡Œ
    summaryText += `ğŸ† **å‹åˆ©æ–¹:** ${winner}\n`;
    summaryText += `ğŸ“… **éŠæˆ²å¤©æ•¸:** ${werewolfGameState.dayNumber} å¤©\n\n`;
    
    // åŠ å…¥AIç”Ÿæˆçš„æ‘˜è¦
    summaryText += `**æœ¬å±€æ‘˜è¦:**\n${aiSummary}\n\n`; 
    
    summaryText += `**ç©å®¶è¤‡ç›¤:**\n`;
    werewolfGameState.players.forEach(p => {
        const status = p.isAlive ? 'å­˜æ´»' : 'æ·˜æ±°';
        const roleName = roleNameMap[p.role] || p.role;
        summaryText += `- ${p.name} (${roleName}) - ${status}\n`;
    });

    return summaryText;
}

/**
 * ã€ç‹¼äººæ®ºã€‘æ‰“é–‹è¤‡ç›¤ç™¼é€ç›®æ¨™é¸æ“‡å™¨
 * @param {string} summaryText - è¦ç™¼é€çš„è¤‡ç›¤æ–‡æœ¬
 */
function openWerewolfSummaryTargetPicker(summaryText) {
    const modal = document.getElementById('werewolf-target-picker-modal');
    const listEl = document.getElementById('werewolf-target-list');
    listEl.innerHTML = '';

    const aiPlayers = werewolfGameState.players.filter(p => !p.isUser);

    if (aiPlayers.length === 0) {
        alert("æ²’æœ‰å¯ç™¼é€çš„AIç©å®¶ã€‚");
        return;
    }

    // æ¸²æŸ“å¯é¸çš„AIç©å®¶åˆ—è¡¨
    aiPlayers.forEach(player => {
        const item = document.createElement('div');
        item.className = 'player-selection-item'; // è¤‡ç”¨ä¹‹å‰çš„æ¨£å¼
        item.innerHTML = `
            <input type="checkbox" class="werewolf-target-checkbox" value="${player.id}" checked>
            <img src="${player.avatar || defaultAvatar}" alt="${player.name}">
            <span class="name">${player.name}</span>
        `;
        listEl.appendChild(item);
    });

    // ç¶å®šæŒ‰éˆ•äº‹ä»¶
    const confirmBtn = document.getElementById('wt-confirm-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.onclick = () => {
        const selectedIds = Array.from(document.querySelectorAll('.werewolf-target-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length > 0) {
            sendSummaryToSelectedPlayers(summaryText, selectedIds);
        } else {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç™¼é€ç‰©ä»¶ï¼");
        }
    };

    const cancelBtn = document.getElementById('wt-cancel-btn');
    cancelBtn.onclick = () => modal.classList.remove('visible');

    document.getElementById('wt-select-all-btn').onclick = () => {
        document.querySelectorAll('.werewolf-target-checkbox').forEach(cb => cb.checked = true);
    };
    document.getElementById('wt-deselect-all-btn').onclick = () => {
        document.querySelectorAll('.werewolf-target-checkbox').forEach(cb => cb.checked = false);
    };

    modal.classList.add('visible');
}

/**
 * ã€ç‹¼äººæ®ºã€‘é¡¯ç¤ºéŠæˆ²çµç®—å¡ç‰‡æ¨¡æ…‹æ¡†
 * @param {string} summaryText - è¤‡ç›¤æ–‡æœ¬
 */
function showWerewolfSummaryModal(summaryText) {
    const modal = document.getElementById('werewolf-summary-modal');
    const contentEl = document.getElementById('werewolf-summary-content');
    
    // ä½¿ç”¨ä½ å·²æœ‰çš„Markdownæ¸²æŸ“å‡½æ•¸ï¼Œè®“è¤‡ç›¤æ›´å¥½çœ‹
    contentEl.innerHTML = renderMarkdown(summaryText);
    
    // ç‚ºæŒ‰éˆ•ç¶å®šäº‹ä»¶ (ä½¿ç”¨å…‹éš†ç¯€é»é˜²æ­¢é‡è¤‡ç¶å®š)
    const repostBtn = document.getElementById('repost-summary-btn');
    const newRepostBtn = repostBtn.cloneNode(true);
    repostBtn.parentNode.replaceChild(newRepostBtn, repostBtn);
    newRepostBtn.onclick = () => openWerewolfSummaryTargetPicker(summaryText);

    const backBtn = document.getElementById('back-to-hall-btn');
    const newBackBtn = backBtn.cloneNode(true);
    backBtn.parentNode.replaceChild(newBackBtn, backBtn);
    newBackBtn.onclick = () => {
        modal.classList.remove('visible');
        showScreen('game-hall-screen');
    };

    modal.classList.add('visible');
}
/**
 * ã€ç‹¼äººæ®º V2 - å¢å¼·ç‰ˆã€‘å°‡éŠæˆ²è¤‡ç›¤ç™¼é€åˆ°ã€é¸å®šã€‘çš„AIè§’è‰²çš„èŠå¤©ä¸­
 * @param {string} summaryText - è¤‡ç›¤æ–‡æœ¬
 * @param {string[]} targetIds - ç›®æ¨™AIè§’è‰²çš„IDé™£åˆ—
 */
async function sendSummaryToSelectedPlayers(summaryText, targetIds) {
    // å…ˆé—œé–‰æ‰€æœ‰å¯èƒ½æ‰“é–‹çš„å½ˆçª—
    document.getElementById('werewolf-summary-modal').classList.remove('visible');
    document.getElementById('werewolf-target-picker-modal').classList.remove('visible');

    const aiPlayers = werewolfGameState.players.filter(p => !p.isUser);
    let sentCount = 0;

    const aiContext = `[ç³»çµ±æŒ‡ä»¤ï¼šå‰›å‰›çµæŸäº†ä¸€å±€ç‹¼äººæ®ºï¼Œé€™æ˜¯éŠæˆ²è¤‡ç›¤ã€‚è«‹æ ¹æ“šé€™å€‹è¤‡ç›¤å…§å®¹ï¼Œä»¥ä½ çš„è§’è‰²äººè¨­ï¼Œå’Œç”¨æˆ¶èŠèŠå‰›æ‰çš„éŠæˆ²ã€‚]\n\n${summaryText}`;

    for (const chatId of targetIds) {
        const chat = state.chats[chatId];
        if (chat) {
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ â–¼â–¼â–¼
                // 1. å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„ã€è¤‡ç›¤å¡ç‰‡ã€‘æ¶ˆæ¯
                const visibleMessage = {
                    role: 'user',
                    type: 'text',
                    timestamp: Date.now(),
                    content: summaryText
                };
                
                // 2. å‰µå»ºå°AIå¯è¦‹çš„ã€éš±è—æŒ‡ä»¤ã€‘
                const hiddenInstruction = {
                    role: 'system',
                    content: aiContext,
                    timestamp: Date.now() + 1,
                    isHidden: true
                };
                
                // 3. å°‡ã€å…©æ¢ã€‘æ¶ˆæ¯æ¨å…¥æ­·å²è¨˜éŒ„
                chat.history.push(visibleMessage, hiddenInstruction);
            await db.chats.put(chat);
            sentCount++;
            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        }
    }
    
    await showCustomAlert("ç™¼é€æˆåŠŸ", `éŠæˆ²è¤‡ç›¤å·²ç™¼é€è‡³ ${sentCount} ä½AIè§’è‰²çš„èŠå¤©ä¸­ï¼`);
    showScreen('game-hall-screen');
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€ä¿®æ­£å¾Œã€‘çš„å‡½æ•¸æ›¿æ›èˆŠçš„ checkGameOver â–¼â–¼â–¼
function checkGameOver() {
    const alivePlayers = werewolfGameState.players.filter(p => p.isAlive);
    const aliveWolves = alivePlayers.filter(p => p.role === 'wolf').length;
    const aliveGods = alivePlayers.filter(p => ['seer', 'witch', 'hunter', 'guard', 'idiot'].includes(p.role)).length;
    const aliveVillagers = alivePlayers.filter(p => p.role === 'villager').length;

    let winner = null;

    if (aliveWolves === 0) {
        winner = 'å¥½äººé™£ç‡Ÿ';
    } else if (aliveWolves >= (aliveGods + aliveVillagers)) {
        winner = 'ç‹¼äººé™£ç‡Ÿ';
    } else if (aliveGods === 0 && aliveVillagers === 0) {
        winner = 'ç‹¼äººé™£ç‡Ÿ';
    }

    if (winner) {
        logToWerewolfGame(`éŠæˆ²çµæŸï¼${winner}å‹åˆ©ï¼`);
        const roleNameMap = { wolf: 'ç‹¼äºº', villager: 'å¹³æ°‘', seer: 'é è¨€å®¶', witch: 'å¥³å·«', hunter: 'çµäºº', guard: 'å®ˆè¡›', idiot: 'ç™½ç™¡' };
        const rolesReveal = werewolfGameState.players.map(p => `${p.name}: ${roleNameMap[p.role] || p.role}`).join('\n');
        logToWerewolfGame(`èº«ä»½å…¬ä½ˆ:\n${rolesReveal}`);
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡èª¿ç”¨AIç”Ÿæˆæ‘˜è¦ä¸¦é¡¯ç¤ºçµç®—å¡
        (async () => {
            await showCustomAlert("è«‹ç¨å€™...", "AIæ­£åœ¨ç”Ÿæˆæœ¬å±€æ‘˜è¦...");
            const aiSummary = await generateAiGameSummary();
            const summary = generateWerewolfSummary(winner, aiSummary);
            showWerewolfSummaryModal(summary);
        })();
        
        werewolfGameState.isActive = false;
        document.getElementById('werewolf-action-area').innerHTML = '';
        
        return true;
    }

    return false;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€ç‹¼äººæ®ºè¼¸å…¥æ¡†ç¾åŒ–ã€‘è«‹ç”¨é€™å€‹ã€å…¨æ–°ã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ waitForUserAction å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€ç‹¼äººæ®º V2 - è¼¸å…¥æ¡†ç¾åŒ–ç‰ˆã€‘ç­‰å¾…ä½¿ç”¨è€…è¡Œå‹•çš„é€šç”¨å‡½æ•¸
 */
function waitForUserAction(prompt, actionType, context = {}) {
    const me = werewolfGameState.players.find(p => p.isUser);
    if (me && !me.isAlive) {
        const actionArea = document.getElementById('werewolf-action-area');
        actionArea.innerHTML = `<h5>æ‚¨å·²æ·˜æ±°ï¼Œæ­£åœ¨è§€æˆ°...</h5>`;
        return new Promise(async (resolve) => {
            await sleep(3000);
            actionArea.innerHTML = ''; 
            resolve(null);
        });
    }
    
    return new Promise(resolve => {
        const actionArea = document.getElementById('werewolf-action-area');
        actionArea.innerHTML = ''; // æ¸…ç©ºï¼Œæº–å‚™æ–°çš„UI
        actionArea.className = 'werewolf-action-area'; // é‡ç½®class

        if (actionType === 'speak') {
            // --- é€™æ˜¯æˆ‘å€‘ç¾åŒ–å¾Œçš„ç™¼è¨€è¼¸å…¥å€ ---
            actionArea.classList.add('speaking-mode'); // å•Ÿå‹•æ–°CSS

            const textarea = document.createElement('textarea');
            textarea.id = 'user-speech-input';
            textarea.rows = 1;
            textarea.placeholder = 'è«‹è¼¸å…¥ä½ çš„ç™¼è¨€...';
            // å³æ™‚èª¿æ•´é«˜åº¦
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
            });

            const endBtn = document.createElement('button');
            endBtn.id = 'end-speech-btn';
            endBtn.className = 'form-button'; // ä¿ç•™ä¸€å€‹åŸºç¤class
            endBtn.textContent = 'çµæŸç™¼è¨€';

            actionArea.appendChild(textarea);
            actionArea.appendChild(endBtn);
            
            textarea.focus();

            endBtn.onclick = () => {
                const speech = textarea.value.trim() || "æˆ‘ééº¥ã€‚";
                actionArea.innerHTML = '';
                actionArea.classList.remove('speaking-mode');
                resolve(speech);
            };
            return; // çµæŸ 'speak' åˆ†æ”¯
        }

        // --- ä»¥ä¸‹æ˜¯å…¶ä»–éç™¼è¨€å‹•ä½œçš„UIï¼Œä¿æŒåŸæ¨£ ---
        actionArea.innerHTML = `<h5>${prompt}</h5>`;
        const grid = document.createElement('div');
        grid.className = 'vote-target-grid';
        
        if (actionType === 'witch_action') {
            if (context.killedId && werewolfGameState.witchPotions.save > 0) {
                const saveBtn = document.createElement('button');
                saveBtn.className = 'form-button';
                saveBtn.textContent = `ä½¿ç”¨è§£è—¥æ•‘ ${context.killedPlayerName}`;
                saveBtn.onclick = () => { actionArea.innerHTML = ''; resolve({action: 'save'}); };
                grid.appendChild(saveBtn);
            }
            if (werewolfGameState.witchPotions.poison > 0) {
                 const poisonBtn = document.createElement('button');
                 poisonBtn.className = 'form-button form-button-secondary';
                 poisonBtn.textContent = 'ä½¿ç”¨æ¯’è—¥';
                 poisonBtn.onclick = async () => {
                     const targetId = await waitForUserAction('é¸æ“‡è¦æ¯’æ®ºçš„ç©å®¶', 'witch_poison_target');
                     resolve({action: 'poison', targetId: targetId});
                 };
                 grid.appendChild(poisonBtn);
            }
            const passBtn = document.createElement('button');
            passBtn.className = 'form-button form-button-secondary';
            passBtn.textContent = 'è·³é';
            passBtn.onclick = () => { actionArea.innerHTML = ''; resolve({action: 'none'}); };
            grid.appendChild(passBtn);
            actionArea.appendChild(grid);
            return;
        }

        let targets = [];
        if (['guard_protect', 'seer_check', 'hunter_shoot', 'witch_poison_target'].includes(actionType)) {
            targets = werewolfGameState.players.filter(p => p.isAlive);
        } else if (actionType === 'wolf_kill') {
            targets = werewolfGameState.players.filter(p => p.isAlive && p.role !== 'wolf');
        } else if (actionType === 'vote') {
            targets = werewolfGameState.players.filter(p => p.isAlive);
        }
        
        targets.forEach(player => {
            const btn = document.createElement('button');
            btn.className = 'form-button-secondary vote-target-btn';
            btn.textContent = player.name;
            btn.onclick = () => {
                actionArea.innerHTML = '';
                resolve(player.id);
            };
            grid.appendChild(btn);
        });
        
        if(actionType === 'vote') {
            const passBtn = document.createElement('button');
            passBtn.className = 'form-button-secondary vote-target-btn';
            passBtn.textContent = 'æ£„ç¥¨';
            passBtn.onclick = () => { actionArea.innerHTML = ''; resolve(null); };
            grid.appendChild(passBtn);
        }
        actionArea.appendChild(grid);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²ä¿®å¾©æ‹¼å¯«éŒ¯èª¤ã€‘çš„å‡½æ•¸å®Œæ•´æ›¿æ›èˆŠçš„ triggerWerewolfAiAction â–¼â–¼â–¼
async function triggerWerewolfAiAction(playerId, action, context = {}) {
    const player = werewolfGameState.players.find(p => p.id === playerId);
    if (!player || !player.isAlive) return null;

    const { proxyUrl, apiKey, model } = state.apiConfig;

    let actionPrompt = '';
    let jsonFormat = '';
    const alivePlayersList = werewolfGameState.players.filter(p => p.isAlive).map(p => `- ${p.name} (id: ${p.id})`).join('\n');
    let extraContext = '';

    if (player.role === 'seer' && action === 'speak' && werewolfGameState.seerLastNightResult) {
        const result = werewolfGameState.seerLastNightResult;
        extraContext = `\n# é è¨€å®¶å°ˆå±¬æƒ…å ± (æ­¤è³‡è¨Šåƒ…ä½ å¯è¦‹)\n- **é‡è¦è³‡è¨Š**: æ˜¨æ™šä½ æŸ¥é©—äº† **${result.targetName}**ï¼ŒTaçš„èº«ä»½æ˜¯ã€${result.isWolf ? 'ç‹¼äºº' : 'å¥½äºº'}ã€‘ã€‚\n- **ä½ çš„ä»»å‹™**: ä½ å¯ä»¥é¸æ“‡åœ¨ç™¼è¨€ä¸­å…¬ä½ˆé€™å€‹è³‡è¨Šï¼ˆå¯ä»¥èªªçœŸè©±ï¼Œä¹Ÿå¯ä»¥ç‚ºäº†è¿·æƒ‘ç‹¼äººè€Œèªªè¬Šï¼‰ï¼Œæˆ–è€…æš«æ™‚éš±è—å®ƒã€‚è«‹æ ¹æ“šä½ çš„äººè¨­å’Œç•¶å‰å±€å‹¢åšå‡ºæœ€æœ‰åˆ©çš„æ±ºç­–ã€‚\n`;
        werewolfGameState.seerLastNightResult = null; 
    }

    switch (action) {
        case 'guard_protect':
            actionPrompt = 'ä½ æ˜¯å®ˆè¡›ï¼Œè«‹é¸æ“‡ä¸€åç©å®¶é€²è¡Œå®ˆè­·ã€‚ä½ ä¸èƒ½é€£çºŒå…©æ™šå®ˆè­·åŒä¸€å€‹äººã€‚';
            jsonFormat = '{"action": "vote", "targetId": "ä½ é¸æ“‡å®ˆè­·çš„ç©å®¶ID"}';
            if(werewolfGameState.guardLastNightProtected) extraContext = `\n- æç¤º: ä½ æ˜¨æ™šå®ˆè­·äº† ${werewolfGameState.players.find(p=>p.id === werewolfGameState.guardLastNightProtected).name}ã€‚`;
            break;
        case 'wolf_kill':
            const wolfTeammates = werewolfGameState.players.filter(p => p.role === 'wolf' && p.id !== player.id).map(w => w.name).join('ã€');
            if (context.isUserWolfAlly) {
                actionPrompt = `ä½ æ˜¯ç‹¼äººï¼Œä½ çš„éšŠå‹æ˜¯ã€${wolfTeammates}ã€‘å’Œã€ç”¨æˆ¶ã€‘ã€‚è«‹çµ¦ä½ çš„ç”¨æˆ¶éšŠå‹ä¸€å€‹æ“Šæ®ºå»ºè­°ã€‚`;
            } else {
                // â–¼â–¼â–¼ æ ¸å¿ƒBugä¿®å¾©ï¼šä¿®æ­£é€™è£¡çš„è®Šæ•¸åæ‹¼å¯«éŒ¯èª¤ â–¼â–¼â–¼
                actionPrompt = `ä½ æ˜¯ç‹¼äººï¼Œä½ çš„éšŠå‹æ˜¯ã€${wolfTeammates || 'ç„¡'}ã€‘ã€‚è«‹é¸æ“‡ä¸€å€‹éç‹¼äººè§’è‰²é€²è¡Œæ”»æ“Šã€‚`;
                // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
            }
            extraContext += `\n# ç‹¼äººæˆ°è¡“æŒ‡ä»¤ (è‡³é—œé‡è¦)\n- **åœ˜éšŠåˆä½œ**: ä½ çš„é¦–è¦ç›®æ¨™æ˜¯å’Œä½ çš„ç‹¼éšŠå‹å€‘ã€é›†ç«ã€‘åŒä¸€å€‹ç›®æ¨™ï¼Œä»¥ç¢ºä¿æ“Šæ®ºæˆåŠŸã€‚\n- **æ”»æ“Šå„ªå…ˆé †åº**: è«‹å„ªå…ˆæ”»æ“Šä½ èªç‚ºæ˜¯ã€é è¨€å®¶ã€‘ã€ã€å¥³å·«ã€‘ç­‰ç¥è·çš„ç©å®¶ï¼Œæˆ–è€…ç™¼è¨€é‚è¼¯æ¸…æ™°ã€å°ç‹¼äººé™£ç‡Ÿå¨è„…å¤§çš„å¥½äººã€‚`;
            jsonFormat = '{"action": "vote", "targetId": "ä½ é¸æ“‡æ”»æ“Šçš„ç©å®¶ID"}';
            break;
        case 'seer_check':
            actionPrompt = 'ä½ æ˜¯é è¨€å®¶ï¼Œè«‹é¸æ“‡ä¸€åç©å®¶æŸ¥é©—å…¶èº«ä»½ï¼ˆå¥½äººæˆ–ç‹¼äººï¼‰ã€‚';
            jsonFormat = '{"action": "vote", "targetId": "ä½ é¸æ“‡æŸ¥é©—çš„ç©å®¶ID"}';
            break;
        case 'witch_action':
            actionPrompt = 'ä½ æ˜¯å¥³å·«ã€‚';
            if (context.killedId) {
                actionPrompt += `ä»Šæ™š ${werewolfGameState.players.find(p=>p.id===context.killedId).name} è¢«è¥²æ“Šäº†ã€‚`;
            } else {
                actionPrompt += 'ä»Šæ™šæ˜¯å¹³å®‰å¤œã€‚';
            }
            actionPrompt += ` ä½ æœ‰ ${werewolfGameState.witchPotions.save} ç“¶è§£è—¥å’Œ ${werewolfGameState.witchPotions.poison} ç“¶æ¯’è—¥ã€‚è«‹æ±ºå®šä½ çš„è¡Œå‹•ã€‚`;
            jsonFormat = '{"action": "save" | "poison" | "none", "targetId": "(å¦‚æœç”¨æ¯’è—¥ï¼Œå¡«å¯«ç›®æ¨™ID)"}';
            break;
        case 'hunter_shoot':
             actionPrompt = 'ä½ æ˜¯çµäººï¼Œä½ å‡ºå±€äº†ï¼Œè«‹é¸æ“‡ä¸€åç©å®¶èˆ‡ä½ ä¸€åŒå‡ºå±€ã€‚';
             jsonFormat = '{"action": "vote", "targetId": "ä½ é¸æ“‡å¸¶èµ°çš„ç©å®¶ID"}';
             break;
        case 'speak':
            actionPrompt = 'ç¾åœ¨è¼ªåˆ°ä½ ç™¼è¨€ã€‚è«‹æ ¹æ“šä½ çš„è§’è‰²èº«ä»½ã€äººè¨­å’Œç•¶å‰å±€å‹¢ï¼Œç™¼è¡¨ä½ çš„çœ‹æ³•ï¼Œå¯ä»¥æ’’è¬Šæˆ–å¼•å°ã€‚ä½ çš„ç™¼è¨€æ‡‰è©²åœç¹éŠæˆ²æœ¬èº«ï¼Œè€Œä¸æ˜¯åªå’Œç”¨æˆ¶èŠå¤©ã€‚';
            jsonFormat = '{"action": "speak", "speech": "ä½ çš„ç™¼è¨€å…§å®¹..."}';
            break;
        case 'vote':
            actionPrompt = 'ç¾åœ¨æ˜¯ç™½å¤©æŠ•ç¥¨ç’°ç¯€ï¼Œè«‹æ ¹æ“šå¤§å®¶çš„ç™¼è¨€å’Œä½ è‡ªå·±çš„åˆ¤æ–·ï¼ŒæŠ•ç¥¨é¸å‡ºä½ èªç‚ºæ˜¯ç‹¼äººçš„ç©å®¶ã€‚';
            jsonFormat = '{"action": "vote", "targetId": "ä½ æŠ•ç¥¨çš„ç©å®¶ID"}';
            break;
        case 'reveal_clue':
            systemPrompt += `ä½ å‰›å‰›æœåˆ°äº†ä¸€å€‹é—œæ–¼ä½ è‡ªå·±çš„ç·šç´¢ï¼šâ€œ${context.clue}â€ã€‚\nå…¬é–‹é€™æ¢ç·šç´¢å¯èƒ½æœƒè®“ä½ æš´éœ²ï¼Œä½†ä¹Ÿå¯èƒ½æ´—æ¸…å«Œç–‘ï¼›éš±è—å®ƒå¯èƒ½æœƒè®“ä½ åœ¨å¾ŒæœŸè¢«å‹•ã€‚\nè«‹æ ¹æ“šä½ çš„äººè¨­å’Œä»»å‹™ï¼Œæ±ºå®šæ˜¯å…¬é–‹é‚„æ˜¯éš±è—ã€‚`;
            jsonFormat = '{"action": "reveal" or "hide", "reasoning": "ä½ çš„æ±ºç­–ç†ç”±..."}';
            break;
    }

    const systemPrompt = `
# éŠæˆ²èƒŒæ™¯: ç‹¼äººæ®º
# ä½ çš„èº«ä»½å’Œäººè¨­
- ä½ çš„åå­—: ${player.name}
- ä½ çš„è§’è‰²: ${player.role}
- ä½ çš„æ€§æ ¼äººè¨­: ${player.persona}
# ç•¶å‰å±€å‹¢
- å­˜æ´»ç©å®¶åˆ—è¡¨:
${alivePlayersList}
- éŠæˆ²æ—¥èªŒ (æœ€è¿‘15æ¢):
${werewolfGameState.gameLog.slice(-15).map(log => {
    if (log.type === 'speech') {
        return `${log.message.player.name}: ${log.message.speech}`;
    }
    return log.message;
}).join('\n')}
${extraContext}
# ä½ çš„ä»»å‹™: ${actionPrompt}
# è¼¸å‡ºæ ¼å¼: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹:
${jsonFormat}
`;
    try {
        const messagesForApi = [{ role: 'user', content: systemPrompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        const response = await fetch(isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`, isGemini ? geminiConfig.data : {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.1, response_format: { type: "json_object" } })
        });
        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        const content = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '');
        const aiAction = JSON.parse(content);
        
        if (action === 'witch_action') return aiAction;
        if (aiAction.action === 'vote') return aiAction.targetId;
        if (aiAction.action === 'speak') return aiAction.speech;
        if (action === 'reveal_clue') return aiAction;

        return null;
    } catch (error) {
        console.error(`AI (${player.name}) è¡Œå‹•å¤±æ•—:`, error);
        if (action.includes('vote') || action.includes('kill') || action.includes('protect') || action.includes('check') || action.includes('shoot')) {
            const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== player.id);
            if(potentialTargets.length > 0) return potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
        }
        if (action === 'witch_action') return { action: 'none' };
        return "æˆ‘...æˆ‘ä¸çŸ¥é“è©²èªªä»€éº¼äº†ã€‚";
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



/**
 * ä¸€å€‹ç°¡å–®çš„sleepå‡½æ•¸ï¼Œç”¨æ–¼åœ¨éŠæˆ²æµç¨‹ä¸­è£½é€ åœé “
 */
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// â–²â–²â–² ç‹¼äººæ®ºåŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™è£¡æ˜¯æµ·é¾œæ¹¯éŠæˆ²çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€æµ·é¾œæ¹¯ã€‘ç¸½å…¥å£ï¼šæ‰“é–‹éŠæˆ²è¨­ç½®ä»‹é¢
 */
async function openSeaTurtleSoupSetup() {
    // 1. é‡ç½®éŠæˆ²ç‹€æ…‹
    seaTurtleSoupState = {
        isActive: false, phase: 'setup', players: [], riddleProvider: null,
        riddle: '', answer: '', gameLog: [], currentTurnIndex: 0
    };

    // 2. æ¸²æŸ“ç©å®¶é¸æ“‡åˆ—è¡¨
    const selectionEl = document.getElementById('sts-player-selection');
    selectionEl.innerHTML = '<p>æ­£åœ¨è¼‰å…¥è§’è‰²åˆ—è¡¨...</p>';

    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    const allNpcs = Object.values(state.chats).flatMap(chat => (chat.npcLibrary || []).map(npc => ({ ...npc, owner: chat.name })));

    let playerOptions = [
        ...singleChats.map(c => ({ id: c.id, name: c.name, avatar: c.settings.aiAvatar, type: 'è§’è‰²' })),
        ...allNpcs.map(n => ({ id: n.id, name: n.name, avatar: n.avatar, type: `NPC (${n.owner})` }))
    ];

    selectionEl.innerHTML = '';
    playerOptions.forEach(player => {
        const item = document.createElement('div');
        item.className = 'player-selection-item'; // è¤‡ç”¨ç‹¼äººæ®ºçš„æ¨£å¼
        item.innerHTML = `
            <input type="checkbox" class="sts-player-checkbox" value="${player.id}">
            <img src="${player.avatar || defaultAvatar}" alt="${player.name}">
            <span class="name">${player.name}</span>
            <span class="type-tag">${player.type}</span>
        `;
        selectionEl.appendChild(item);
    });

    // 3. é‡ç½®ä¸¦é¡¯ç¤ºè¨­å®šå½ˆçª—
    document.getElementById('sts-riddle-provider-select').value = 'random';
    document.getElementById('sts-user-riddle-input-area').style.display = 'none';
    document.getElementById('sts-ai-riddle-input-area').style.display = 'none';
    document.getElementById('sea-turtle-soup-setup-modal').classList.add('visible');
}

/**
 * ã€æµ·é¾œæ¹¯ã€‘é–‹å§‹éŠæˆ²çš„æ ¸å¿ƒé‚è¼¯
 */
async function startSeaTurtleSoupGame() {
    const selectedCheckboxes = document.querySelectorAll('.sts-player-checkbox:checked');
    if (selectedCheckboxes.length < 1) {
        alert('è«‹è‡³å°‘é‚€è«‹ä¸€ä½AIæˆ–NPCç©å®¶ï¼');
        return;
    }

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨æº–å‚™æµ·é¾œæ¹¯éŠæˆ²...");

    // 1. æ”¶é›†ç©å®¶è³‡è¨Š
    let players = [{
        id: 'user', name: state.qzoneSettings.nickname || 'æˆ‘',
        avatar: state.qzoneSettings.avatar || defaultAvatar, isUser: true, persona: 'ä¸€å€‹å¥½å¥‡çš„æ™®é€šäºº'
    }];
    selectedCheckboxes.forEach(checkbox => {
        const playerId = checkbox.value;
        const chat = Object.values(state.chats).find(c => c.id === playerId);
        if (chat) { // æ˜¯ä¸»è¦è§’è‰²
            players.push({ id: chat.id, name: chat.name, avatar: chat.settings.aiAvatar, persona: chat.settings.aiPersona, isUser: false });
        } else { // æ˜¯NPC
            for (const c of Object.values(state.chats)) {
                const npc = (c.npcLibrary || []).find(n => n.id === playerId);
                if (npc) {
                    players.push({ id: npc.id, name: npc.name, avatar: npc.avatar, persona: npc.persona, isUser: false });
                    break;
                }
            }
        }
    });
    players.sort(() => Math.random() - 0.5); // æ‰“äº‚åº§ä½é †åº
    seaTurtleSoupState.players = players;

    // 2. æ±ºå®šå‡ºé¡Œäºº
    const providerChoice = document.getElementById('sts-riddle-provider-select').value;
    let providerIndex = -1;

    if (providerChoice === 'user') {
        providerIndex = players.findIndex(p => p.isUser);
    } else if (providerChoice === 'random_ai') {
        const aiIndices = players.map((p, i) => !p.isUser ? i : -1).filter(i => i !== -1);
        providerIndex = aiIndices[Math.floor(Math.random() * aiIndices.length)];
    } else { // random
        providerIndex = Math.floor(Math.random() * players.length);
    }
    
    seaTurtleSoupState.players[providerIndex].isProvider = true;
    seaTurtleSoupState.riddleProvider = seaTurtleSoupState.players[providerIndex];

    // 3. ç²å–è¬é¢å’Œè¬åº•
    if (seaTurtleSoupState.riddleProvider.isUser) {
        const riddle = document.getElementById('sts-user-riddle-surface').value.trim();
        const answer = document.getElementById('sts-user-riddle-answer').value.trim();
        if (!riddle || !answer) {
            alert('ä½œç‚ºå‡ºé¡Œäººï¼Œè¬é¢å’Œè¬åº•éƒ½ä¸èƒ½ç‚ºç©ºå“¦ï¼');
            return;
        }
        seaTurtleSoupState.riddle = riddle;
        seaTurtleSoupState.answer = answer;
    } else {
        const riddleType = document.getElementById('sts-ai-riddle-type').value.trim();
        const { riddle, answer } = await generateSeaTurtleRiddle(seaTurtleSoupState.riddleProvider, riddleType);
        if (!riddle || !answer) {
            alert('AIå‡ºé¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥APIæˆ–ç¨å¾Œé‡è©¦ã€‚');
            return;
        }
        seaTurtleSoupState.riddle = riddle;
        seaTurtleSoupState.answer = answer;
    }

    // 4. åˆå§‹åŒ–éŠæˆ²
    seaTurtleSoupState.isActive = true;
    seaTurtleSoupState.phase = 'guessing';
    logToStsGame(`éŠæˆ²é–‹å§‹ï¼å‡ºé¡Œäººæ˜¯ ${seaTurtleSoupState.riddleProvider.name}ã€‚`, 'system', seaTurtleSoupState.riddleProvider);
    logToStsGame(`ã€è¬é¢ã€‘\n${seaTurtleSoupState.riddle}`);
    
    document.getElementById('sea-turtle-soup-setup-modal').classList.remove('visible');
    showScreen('sea-turtle-soup-screen');
    renderSeaTurtleGameScreen({ activePlayerId: 'user' });
    
    // éŠæˆ²é–‹å§‹ï¼Œé€²å…¥ç¬¬ä¸€å€‹å›åˆ
    await processStsTurn();
}

/**
 * ã€æµ·é¾œæ¹¯-AIæ ¸å¿ƒ | å„ªåŒ–ç‰ˆã€‘è®“AIæ ¹æ“šæŒ‡å®šé¡å‹å‡ºé¡Œï¼Œä¸¦å„ªå…ˆé¸æ“‡ç¶“å…¸è¬é¡Œ
 */
async function generateSeaTurtleRiddle(provider, riddleType) {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return { riddle: null, answer: null };

    // æ ¸å¿ƒä¿®æ”¹ï¼šå„ªåŒ–äº†Promptï¼Œå¢åŠ äº†â€œå„ªå…ˆé¸æ“‡ç¶“å…¸è¬é¡Œâ€çš„æŒ‡ä»¤
    const typePrompt = riddleType ? `è«‹å‰µä½œä¸€å€‹ã€${riddleType}ã€‘é¡å‹çš„` : 'è«‹å‰µä½œä¸€å€‹';

    const systemPrompt = `
# ä»»å‹™
ä½ ç¾åœ¨æ˜¯è§’è‰²â€œ${provider.name}â€ï¼Œä½ çš„äººè¨­æ˜¯ï¼šâ€œ${provider.persona}â€ã€‚
ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”é€™å€‹è§’è‰²ï¼Œ${typePrompt}ç¶“å…¸çš„æµ·é¾œæ¹¯è¬é¡Œã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **å„ªå…ˆç¶“å…¸**: ä½ ã€å¿…é ˆå„ªå…ˆã€‘å¾å·²çŸ¥çš„ã€ç¶“å…¸çš„ã€å»£ç‚ºäººçŸ¥çš„â€œæµ·é¾œæ¹¯â€æ•…äº‹ä¸­æŒ‘é¸ä¸€å€‹ä½œç‚ºæœ¬æ¬¡çš„è¬é¡Œã€‚é€™èƒ½ç¢ºä¿è¬é¡Œçš„é‚è¼¯æ€§å’Œå¯ç©æ€§ã€‚
2.  **é©ç•¶åŸå‰µ**: åªæœ‰åœ¨æƒ³ä¸å‡ºåˆé©çš„ç¶“å…¸è¬é¡Œæ™‚ï¼Œä½ æ‰è¢«å…è¨±åŸå‰µä¸€å€‹ã€‚åŸå‰µçš„è¬é¡Œä¹Ÿå¿…é ˆé‚è¼¯åš´è¬¹ï¼Œæƒ…ç¯€åˆç†ã€‚
3.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼ŒåŒ…å« "riddle" (è¬é¢) å’Œ "answer" (è¬åº•) å…©å€‹æ¬„ä½ã€‚
4.  **ç¦æ­¢å‡ºæˆ²**: ä¸è¦èªªä»»ä½•èˆ‡å‡ºé¡Œç„¡é—œçš„è©±ã€‚

# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:
{
  "riddle": "ä¸€å€‹ç”·äººèµ°é€²ä¸€å®¶é…’å§ï¼Œå‘é…’ä¿è¦äº†ä¸€æ¯æ°´ã€‚é…’ä¿å»æå‡ºäº†ä¸€æŠŠæ§æŒ‡è‘—ä»–ã€‚ç”·äººèªªäº†ä¸€è²â€œè¬è¬â€ï¼Œç„¶å¾Œé›¢é–‹äº†ã€‚ç‚ºä»€éº¼ï¼Ÿ",
  "answer": "é€™å€‹ç”·äººåœ¨æ‰“å—ã€‚ä»–æƒ³é€šéå–æ°´ä¾†æ­¢å—ï¼Œä½†é…’ä¿ç”¨æ›´æœ‰æ•ˆçš„æ–¹æ³•â€”â€”é©šåš‡ï¼Œå¹«ä»–æ²»å¥½äº†æ‰“å—ã€‚æ‰€ä»¥ç”·äººè¡¨ç¤ºæ„Ÿè¬å¾Œå°±é›¢é–‹äº†ã€‚"
}
`;
    try {
        const messagesForApi = [{ role: 'user', content: systemPrompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });
        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        const content = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '');
        return JSON.parse(content);
    } catch (error) {
        console.error("AIå‡ºé¡Œå¤±æ•—:", error);
        return { riddle: null, answer: null };
    }
}


/**
 * ã€æµ·é¾œæ¹¯ã€‘æ¸²æŸ“éŠæˆ²ä¸»ä»‹é¢ (å·²æ·»åŠ ç•¶å‰å›åˆç©å®¶é«˜äº®)
 */
function renderSeaTurtleGameScreen(options = {}) {
    const playersGrid = document.getElementById('sts-players-grid');
    const logContainer = document.getElementById('sts-game-log');
    
    // æ¸²æŸ“ç©å®¶åº§ä½
    playersGrid.innerHTML = '';
    seaTurtleSoupState.players.forEach(player => {
        const seat = document.createElement('div');
        seat.className = 'player-seat';
        const roleIndicator = player.isProvider ? '<div class="player-role-indicator riddle-master" title="å‡ºé¡Œäºº">ğŸ‘‘</div>' : '';
        const avatarClass = `player-avatar ${options.activePlayerId === player.id ? 'active-turn' : ''}`;

        seat.innerHTML = `
            ${roleIndicator}
            <img src="${player.avatar}" class="${avatarClass}">
            <span class="player-name">${player.name}</span>
        `;
        playersGrid.appendChild(seat);
    });

    // æ¸²æŸ“éŠæˆ²æ—¥èªŒ
    logContainer.innerHTML = ''; 
    seaTurtleSoupState.gameLog.forEach(log => {
        const logEl = document.createElement('div');
        logEl.className = `sts-log-entry ${log.type}`;

        let avatarUrl = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        if (log.speakerObj && log.speakerObj.avatar) {
            avatarUrl = log.speakerObj.avatar;
        }

        switch (log.type) {
            case 'system':
                logEl.innerHTML = log.message.replace(/\n/g, '<br>');
                break;
            case 'question':
            case 'guess':
                logEl.innerHTML = `
                    <img src="${avatarUrl}" class="sts-log-avatar">
                    <div class="sts-log-content">
                        <div class="speaker">${log.speaker}</div>
                        <div>${log.message}</div>
                    </div>
                `;
                break;
            case 'answer':
                const answerClass = { 'æ˜¯': 'yes', 'å¦': 'no', 'ç„¡é—œ': 'irrelevant' }[log.message] || 'irrelevant';
                logEl.innerHTML = `
                    <div class="sts-log-content">
                         <span class="answer-text ${answerClass}">${log.message}</span>
                    </div>
                    <img src="${avatarUrl}" class="sts-log-avatar">
                `;
                break;
        }
        logContainer.appendChild(logEl);
    });

    logContainer.scrollTop = logContainer.scrollHeight;
}

/**
 * ã€æµ·é¾œæ¹¯ã€‘æ·»åŠ ä¸€æ¢éŠæˆ²æ—¥èªŒ
 */
function logToStsGame(message, type = 'system', speakerObj = { name: 'ç³»çµ±' }) {
    seaTurtleSoupState.gameLog.push({ message, type, speaker: speakerObj.name, speakerObj }); // ä¿å­˜æ•´å€‹ç‰©ä»¶
    renderSeaTurtleGameScreen();
}



/**
 * ã€æµ·é¾œæ¹¯ã€‘è™•ç†ç”¨æˆ¶æå•
 */
async function handleStsUserQuestion() {
    if (seaTurtleSoupState.phase !== 'guessing') return;
    const input = document.getElementById('sts-question-input');
    const question = input.value.trim();
    if (!question) return;

    const userPlayer = seaTurtleSoupState.players.find(p => p.isUser);
    logToStsGame(question, 'question', userPlayer);
    input.value = '';

    // å°‡æ§åˆ¶æ¬Šäº¤çµ¦éŠæˆ²ä¸»è¿´åœˆï¼Œä¸¦å‘ŠçŸ¥æ˜¯ç”¨æˆ¶åœ¨æå•
    await processStsTurn(question, userPlayer);
}

// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„å‡½æ•¸ï¼Œé»è²¼åˆ° handleStsUserQuestion å‡½æ•¸çš„å¾Œé¢ â–¼â–¼â–¼

/**
 * ã€æµ·é¾œæ¹¯ã€‘è™•ç†ç”¨æˆ¶çŒœæ¸¬ç­”æ¡ˆ
 */
async function handleStsUserGuess() {
    if (seaTurtleSoupState.phase !== 'guessing') return;
    const input = document.getElementById('sts-question-input');
    const guess = input.value.trim();
    if (!guess) {
        alert("çŒœæ¸¬çš„å…§å®¹ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }

    const userPlayer = seaTurtleSoupState.players.find(p => p.isUser);
    logToStsGame(guess, 'guess', userPlayer);
    input.value = '';

    const provider = seaTurtleSoupState.riddleProvider;
    let isCorrect = false;

    if (provider.isUser) {
        isCorrect = await showCustomConfirm("åˆ¤æ–·çŒœæ¸¬", `ç©å®¶ ${userPlayer.name} çŒœæ¸¬çš„ç­”æ¡ˆæ˜¯ï¼š\n\n"${guess}"\n\né€™å€‹çŒœæ¸¬æ˜¯å¦æ­£ç¢ºï¼Ÿ`);
    } else {
        const aiEvaluation = await triggerStsAiTurn(provider, 'evaluate_guess', guess);
        isCorrect = aiEvaluation.isCorrect;
    }

    if (isCorrect) {
        logToStsGame(`${userPlayer.name} çŒœå°äº†ï¼éŠæˆ²çµæŸï¼`, 'system', userPlayer);
        await revealStsAnswer();
    } else {
        logToStsGame('ä¸å°å“¦ã€‚', 'answer', provider);
        await processStsTurn();
    }
}

/**
 * ã€æµ·é¾œæ¹¯ã€‘éŠæˆ²ä¸»è¿´åœˆ/å¼•æ“
 */
async function processStsTurn(userQuestion = null, userObj = null) {
    if (!seaTurtleSoupState.isActive || seaTurtleSoupState.phase !== 'guessing') return;

    // 1. å¦‚æœæœ‰ç”¨æˆ¶æå•ï¼Œå‡ºé¡Œäººå…ˆå›ç­”
    if (userQuestion && userObj) {
        const provider = seaTurtleSoupState.riddleProvider;
        let providerAnswerResponse;
        if (provider.isUser) {
            const choice = await showChoiceModal(`å›ç­” ${userObj.name} çš„å•é¡Œ: "${userQuestion}"`, [
                { text: 'æ˜¯', value: 'æ˜¯' }, { text: 'å¦', value: 'å¦' }, { text: 'ç„¡é—œ', value: 'ç„¡é—œ' }
            ]);
            providerAnswerResponse = { judgement: choice || 'ç„¡é—œ', remark: '' }; 
        } else {
            providerAnswerResponse = await triggerStsAiTurn(provider, 'answer', { question: userQuestion, askerName: userObj.name });
        }
        
        logToStsGame(providerAnswerResponse.judgement, 'answer', provider);
        if (providerAnswerResponse.remark) {
            await sleep(500);
            logToStsGame(providerAnswerResponse.remark, 'question', provider);
        }
    }

    // 2. è¼ªåˆ°AIç©å®¶è¡Œå‹• (æå•æˆ–çŒœæ¸¬)
    const guessers = seaTurtleSoupState.players.filter(p => !p.isProvider);
    if (guessers.length === 0) return;

    for (const guesser of guessers) {
        if (guesser.isUser) continue; 
        
        await sleep(2000 + Math.random() * 2000); 

        renderSeaTurtleGameScreen({ activePlayerId: guesser.id });
        const aiAction = await triggerStsAiTurn(guesser, 'guess');
        
        if (aiAction.type === 'question') {
            logToStsGame(aiAction.content, 'question', guesser);
          await sleep(6000);
            
            const provider = seaTurtleSoupState.riddleProvider;
            let providerAnswerResponse;
            if (provider.isUser) {
                const choice = await showChoiceModal(`å›ç­” ${guesser.name} çš„å•é¡Œ: "${aiAction.content}"`, [
                    { text: 'æ˜¯', value: 'æ˜¯' }, { text: 'å¦', value: 'å¦' }, { text: 'ç„¡é—œ', value: 'ç„¡é—œ' }
                ]);
                providerAnswerResponse = { judgement: choice || 'ç„¡é—œ', remark: '' }; 
            } else {
                providerAnswerResponse = await triggerStsAiTurn(provider, 'answer', { question: aiAction.content, askerName: guesser.name });
            }

            logToStsGame(providerAnswerResponse.judgement, 'answer', provider);
            if (providerAnswerResponse.remark) {
                await sleep(500);
                logToStsGame(providerAnswerResponse.remark, 'question', provider);
            }

        } else if (aiAction.type === 'guess') {
            logToStsGame(aiAction.content, 'guess', guesser);
            
            let isCorrect = false;
            if (seaTurtleSoupState.riddleProvider.isUser) {
                isCorrect = await showCustomConfirm("åˆ¤æ–·çŒœæ¸¬", `ç©å®¶ ${guesser.name} çŒœæ¸¬çš„ç­”æ¡ˆæ˜¯ï¼š\n\n"${aiAction.content}"\n\né€™å€‹çŒœæ¸¬æ˜¯å¦æ­£ç¢ºï¼Ÿ`);
            } else {
                const aiEvaluation = await triggerStsAiTurn(seaTurtleSoupState.riddleProvider, 'evaluate_guess', aiAction.content);
                isCorrect = aiEvaluation.isCorrect;
            }

            if (isCorrect) {
                logToStsGame(`${guesser.name} çŒœå°äº†ï¼éŠæˆ²çµæŸï¼`, 'system', guesser); 
                await revealStsAnswer();
                return;
            } else {
                logToStsGame('ä¸å°å“¦ã€‚', 'answer', seaTurtleSoupState.riddleProvider);
            }
        }
    }

    renderSeaTurtleGameScreen({ activePlayerId: 'user' });
}


/**
 * ã€æµ·é¾œæ¹¯-AIæ ¸å¿ƒ V2ã€‘è§¸ç™¼AIè¡Œå‹•ï¼ˆå›ç­”ã€æå•ã€åˆ¤æ–·æˆ–çŒœæ¸¬ï¼‰
 */
async function triggerStsAiTurn(player, actionType, contextPayload = {}) {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return { type: 'question', content: 'æˆ‘ä¸çŸ¥é“è©²å•ä»€éº¼äº†ã€‚' };

    let systemPrompt = '';
    const gameLogText = seaTurtleSoupState.gameLog
        .map(log => `${log.speaker}: ${log.message}`)
        .slice(-15)
        .join('\n');

    if (actionType === 'answer') {
        // äººè¨­åŠ å¼·ç‰ˆ V3 Prompt
        systemPrompt = `
# ä»»å‹™: æµ·é¾œæ¹¯å‡ºé¡Œäºº (é«˜ç´šäººæ ¼ç‰ˆ)
ä½ ç¾åœ¨ã€å°±æ˜¯ã€‘è§’è‰²â€œ${player.name}â€ï¼Œä½ çš„äººè¨­æ˜¯ï¼šâ€œ${player.persona}â€ã€‚
ä½ æ˜¯æµ·é¾œæ¹¯çš„å‡ºé¡Œäººï¼Œä½ çš„è¬åº•æ˜¯ï¼šâ€œ${seaTurtleSoupState.answer}â€ã€‚
ç¾åœ¨ï¼Œç©å®¶â€œ${contextPayload.askerName}â€å‘ä½ æå•ï¼šâ€œ${contextPayload.question}â€ã€‚

ä½ çš„ä»»å‹™æ˜¯å…ˆçµ¦å‡ºåˆ¤æ–·ï¼Œç„¶å¾Œç”¨ã€å®Œå…¨ç¬¦åˆä½ äººè¨­çš„å£å»ã€‘ï¼Œçµ¦å‡ºä¸€å¥ç²¾å¦™çš„è£œå……èªªæ˜(remark)ã€‚

# ä½ çš„è¡Œç‚ºæº–å‰‡ (å¿…é ˆåš´æ ¼éµå®ˆ)

## 1. é—œæ–¼åˆ¤æ–· (Judgement)
ä½ çš„ "judgement" æ¬„ä½å¿…é ˆå¾ä»¥ä¸‹ã€å››å€‹ã€‘é¸é …ä¸­é¸æ“‡ä¸€å€‹ï¼š\`æ˜¯\`, \`å¦\`, \`ç„¡é—œ\`, \`éƒ¨åˆ†æ˜¯\`ã€‚

## 2. é—œæ–¼è£œå……èªªæ˜ (Remark)
-   **ã€ã€ã€äººæ ¼éµå¾‹ã€‘ã€‘ã€‘**: ä½ çš„æ¯ä¸€å¥è£œå……èªªæ˜ï¼Œéƒ½ã€å¿…é ˆã€‘æ˜¯ä½ ä½œç‚ºè§’è‰²â€œ${player.name}â€æœƒèªªçš„è©±ã€‚æ€è€ƒä¸€ä¸‹ï¼Œä¸€å€‹â€œ${player.persona}â€æ€§æ ¼çš„äººï¼Œåœ¨é¢å°é€™å€‹å•é¡Œæ™‚æœƒå¦‚ä½•å›ç­”ï¼Ÿæ˜¯æœƒèª¿ä¾ƒã€æœƒé¼“å‹µã€æœƒæ•…ä½œé«˜æ·±ï¼Œé‚„æ˜¯æœƒä¸è€ç…©ï¼Ÿ
-   **é…åˆåˆ¤æ–·**: ç•¶åˆ¤æ–·ç‚º "éƒ¨åˆ†æ˜¯" æ™‚ï¼Œä½ çš„è£œå……èªªæ˜è¦å·§å¦™åœ°æŒ‡å‡ºä»–å€‘çŒœå°çš„éƒ¨åˆ†ã€‚
-   **çµ¦äºˆæç¤º (åƒ…åœ¨ç©å®¶å¡é—œæ™‚)**:
    -   **åˆ¤æ–·ç“¶é ¸**: ç•¶ä½ è§€å¯Ÿåˆ°æœ€è¿‘çš„5-8æ¢æå•å¤§å¤šæ˜¯â€œç„¡é—œâ€æ™‚ï¼Œæ„å‘³è‘—ç©å®¶å¯èƒ½é™·å…¥äº†æ€ç¶­åƒµå±€ã€‚
    -   **åŸ·è¡Œæ“ä½œ**: åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œä½ çš„è£œå……èªªæ˜ã€å¿…é ˆåŒ…å«ä¸€å€‹æ–¹å‘æ€§çš„æç¤ºã€‘ï¼Œä¸¦ç”¨ä½ çš„äººè¨­å£å»è‡ªç„¶åœ°èªªå‡ºä¾†ã€‚

# æ ¼å¼éµå¾‹
1.  ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼ŒåŒ…å« "judgement" å’Œ "remark" å…©å€‹æ¬„ä½ã€‚
2.  ã€çµ•å°ç¦æ­¢ã€‘åœ¨ä½ çš„ä»»ä½•å›å¾©ä¸­ä½¿ç”¨Emojiè¡¨æƒ…ç¬¦è™Ÿæˆ–å‡ºæˆ²çš„è©èªã€‚

# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:
{
  "judgement": "",
  "remark": ""
}
ç¾åœ¨ï¼Œè«‹ç›´æ¥è¼¸å‡ºä½ çš„JSONåˆ¤æ–·ã€‚`;

    }
    else if (actionType === 'evaluate_guess') {
        systemPrompt = `
# ä»»å‹™: æµ·é¾œæ¹¯å‡ºé¡Œäºº - åˆ¤æ–·çŒœæ¸¬
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰²â€œ${player.name}â€ï¼Œäººè¨­æ˜¯ï¼šâ€œ${player.persona}â€ã€‚
ä½ æ˜¯æµ·é¾œæ¹¯çš„å‡ºé¡Œäººã€‚ä½ çš„è¬åº•æ˜¯ï¼šâ€œ${seaTurtleSoupState.answer}â€ã€‚
ç¾åœ¨ï¼Œæœ‰ç©å®¶ç›´æ¥çŒœæ¸¬äº†è¬åº•ï¼Œå…§å®¹æ˜¯ï¼šâ€œ${contextPayload}â€ã€‚
ä½ çš„ä»»å‹™æ˜¯åˆ¤æ–·é€™å€‹çŒœæ¸¬æ˜¯å¦èˆ‡ä½ çš„è¬åº•ã€æ ¸å¿ƒæ„æ€ä¸€è‡´ã€‘ï¼Œåªè¦70%çš„æ­£ç¢ºç‡å³å¯ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼Œæ ¼å¼ç‚º: \`{"isCorrect": true}\` æˆ– \`{"isCorrect": false}\`ã€‚
2.  **åˆ¤æ–·æ¨™æº–**: åªè¦çŒœæ¸¬çš„æ ¸å¿ƒæƒ…ç¯€ã€äººç‰©é—œä¿‚ã€é—œéµé“å…·å’Œæœ€çµ‚çµæœèˆ‡è¬åº•ä¸€è‡´å³å¯ï¼Œä¸éœ€è¦é€å­—åŒ¹é…ã€‚

ç¾åœ¨ï¼Œè«‹ç›´æ¥è¼¸å‡ºä½ çš„åˆ¤æ–·ã€‚`;
    }

    else { // 'guess'
        systemPrompt = `
# ä»»å‹™: æµ·é¾œæ¹¯çŒœæ¸¬è€…
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰²â€œ${player.name}â€ï¼Œäººè¨­æ˜¯ï¼šâ€œ${player.persona}â€ã€‚
ä½ æ­£åœ¨ç©æµ·é¾œæ¹¯éŠæˆ²ï¼Œéœ€è¦æ ¹æ“šå·²çŸ¥è³‡è¨Šæå•æˆ–çŒœæ¸¬è¬åº•ã€‚

# éŠæˆ²è³‡è¨Š
- è¬é¢: ${seaTurtleSoupState.riddle}
- å·²æœ‰ç·šç´¢ (å®Œæ•´çš„å°è©±è¨˜éŒ„):
${gameLogText}

# æ ¸å¿ƒè¦å‰‡
1.  **ã€ã€ã€é‚è¼¯æ¨ç†éµå¾‹ã€‘ã€‘ã€‘**: ä½ ã€å¿…é ˆã€‘ä»”ç´°åˆ†æä¸Šæ–¹çš„â€œå·²æœ‰ç·šç´¢â€ï¼Œé¿å…æå‡ºé‡è¤‡æˆ–èˆ‡å·²çŸ¥ç·šç´¢çŸ›ç›¾çš„å•é¡Œã€‚ä½ çš„æå•æˆ–çŒœæ¸¬æ‡‰è©²å»ºç«‹åœ¨å·²æœ‰è³‡è¨Šä¹‹ä¸Šï¼Œå±•ç¾å‡ºé‚è¼¯æ¨ç†èƒ½åŠ›ã€‚
2.  **ã€ã€ã€äººæ ¼æ‰®æ¼”éµå¾‹ã€‘ã€‘ã€‘**: ä½ çš„æå•å’ŒçŒœæ¸¬éƒ½ã€å¿…é ˆã€‘ç¬¦åˆä½ çš„äººè¨­å’Œå£å»ï¼Œå°±åƒçœŸäººåœ¨ç©éŠæˆ²ä¸€æ¨£ã€‚ä½ å¯ä»¥é©ç•¶åŠ å…¥ä¸€äº›è‡ªå·±çš„æ€è€ƒéç¨‹æˆ–æƒ…ç·’è¡¨é”ï¼Œè®“å°è©±æ›´ç”Ÿå‹•ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥èªªï¼šâ€œè®“æˆ‘æƒ³æƒ³... æ—¢ç„¶å’Œåœ°é»ç„¡é—œï¼Œé‚£æ˜¯ä¸æ˜¯å’Œæ™‚é–“æœ‰é—œï¼Ÿâ€ï¼Œç›¡å¯èƒ½ç™¼è¨€å­—æ•¸å¤šé»ã€‚
3.  **æ±ºç­–**: æ ¹æ“šç·šç´¢ï¼Œæ±ºå®šæ˜¯æå‡ºä¸€å€‹é—œéµçš„â€œæ˜¯/å¦â€å•é¡Œä¾†ç¸®å°ç¯„åœï¼Œé‚„æ˜¯ç›´æ¥çŒœæ¸¬è¬åº•ã€‚ç•¶ç·šç´¢è¶³å¤ æ™‚ï¼Œå¤§è†½åœ°ä½¿ç”¨ "guess" æŒ‡ä»¤ä¾†çŒœæ¸¬å®Œæ•´çš„æ•…äº‹ã€‚
4.  **ã€ã€ã€åŠ é€Ÿè¦å‰‡ã€‘ã€‘ã€‘**: å¦‚æœâ€œå·²æœ‰ç·šç´¢â€çš„å°è©±è¨˜éŒ„å·²ç¶“è¶…éäº†30æ¢ï¼Œé€™èªªæ˜éŠæˆ²æ™‚é–“éé•·ã€‚åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œä½ ã€æ‡‰è©²æ›´å‚¾å‘æ–¼ç›´æ¥çŒœæ¸¬è¬åº•ã€‘ï¼Œè€Œä¸æ˜¯ç¹¼çºŒæå‡ºç´°ç¯€å•é¡Œã€‚
5.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ã€‚
   - å¦‚æœæå•, æ ¼å¼: \`{"type": "question", "content": "ä½ çš„å•é¡Œ..."}\`
   - å¦‚æœçŒœæ¸¬, æ ¼å¼: \`{"type": "guess", "content": "ä½ çŒœæ¸¬çš„å®Œæ•´æ•…äº‹..."}\`
6.  **ç¦æ­¢Emoji**: ã€çµ•å°ç¦æ­¢ã€‘åœ¨ä½ çš„ä»»ä½•å›å¾©ä¸­ä½¿ç”¨Emojiè¡¨æƒ…ç¬¦è™Ÿã€‚

ç¾åœ¨ï¼Œè«‹æ ¹æ“šä½ çš„äººè¨­å’Œåˆ¤æ–·ï¼Œç”Ÿæˆä½ çš„è¡Œå‹•ã€‚`;
    }
   const maxRetries = 3; // æœ€å¤šé‡è©¦3æ¬¡
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ åœ¨ç³»çµ±æŒ‡ä»¤ä¸­è®€åˆ°çš„è¦å‰‡ï¼Œç«‹å³é–‹å§‹ä½ çš„è¡Œå‹•ã€‚" }];
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
    
            const response = isGemini 
                ? await fetch(geminiConfig.url, geminiConfig.data) 
                : await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi],
                        temperature: 0.9,
                        response_format: { type: "json_object" }
                    })
                });
    
            // ã€é‡è¦ã€‘å¦‚æœå›æ‡‰ç‹€æ…‹ç¢¼æ˜¯429ï¼Œä¹Ÿä¸»å‹•æ‹‹å‡ºéŒ¯èª¤ï¼Œé€²å…¥catchå¡Šé€²è¡Œé‡è©¦
            if (response.status === 429) {
                const errorData = await response.json();
                // æ§‹é€ ä¸€å€‹å’Œä¹‹å‰æ—¥èªŒè£¡ä¸€æ¨£çš„éŒ¯èª¤è³‡è¨Šï¼Œæ–¹ä¾¿æˆ‘å€‘è§£æ
                throw new Error(JSON.stringify({ error: errorData.error })); 
            }
            if (!response.ok) {
                // å°æ–¼å…¶ä»–éŒ¯èª¤ï¼Œç›´æ¥æ‹‹å‡º
                throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${await response.text()}`);
            }
    
            const data = await response.json();
            const content = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '');
            
            // å¦‚æœæˆåŠŸï¼Œè§£æä¸¦è¿”å›çµæœï¼ŒçµæŸå‡½æ•¸
            return JSON.parse(content);
    
        } catch (error) {
            console.error(`æµ·é¾œæ¹¯AIè¡Œå‹•å¤±æ•— (ç¬¬ ${attempt} æ¬¡å˜—è©¦):`, error.message);
            
            // å¦‚æœæ˜¯æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œå°±å¾¹åº•å¤±æ•—ï¼Œä¸¦æŠŠéŒ¯èª¤æ‹‹å‡ºå»
            if (attempt === maxRetries) {
                // å°‡åŸå§‹éŒ¯èª¤é‡æ–°åŒ…è£å¾Œæ‹‹å‡ºï¼Œä»¥ä¾¿å¤–éƒ¨èƒ½æ•ç²
                throw new Error(`AI action failed after ${maxRetries} attempts: ${error.message}`);
            }
            
            let delay = 2000 * attempt; // é»˜èªçš„æŒ‡æ•¸é€€é¿å»¶é²
            
            // æ™ºèƒ½è§£æAPIå»ºè­°çš„ç­‰å¾…æ™‚é–“
            try {
                 // éŒ¯èª¤è³‡è¨Šæœ¬èº«å¯èƒ½æ˜¯ä¸€å€‹JSONå­—ä¸²ï¼Œå…ˆè§£æå®ƒ
                const errorJson = JSON.parse(error.message);
                const errorMessage = errorJson.error.message;
                
                // è¦å‰‡é‹ç®—å¼åŒ¹é… "retry in X.XXXXs"
                const retryMatch = errorMessage.match(/retry in (\d+\.?\d*)s/);
                if (retryMatch && retryMatch[1]) {
                    // æ‰¾åˆ°äº†å»ºè­°æ™‚é–“ï¼Œå°±ç”¨å®ƒï¼Œä¸¦é¡å¤–åŠ ä¸€é»é»ç·©è¡
                    delay = parseFloat(retryMatch[1]) * 1000 + 500;
                    console.log(`APIè«‹æ±‚éæ–¼é »ç¹ï¼Œå°‡æ ¹æ“šå»ºè­°åœ¨ ${Math.round(delay/1000)} ç§’å¾Œé‡è©¦...`);
                }
            } catch(e) {
                // å¦‚æœè§£æå¤±æ•—ï¼Œèªªæ˜éŒ¯èª¤è³‡è¨Šæ ¼å¼ä¸ç¬¦åˆé æœŸï¼Œå°±ä½¿ç”¨é»˜èªå»¶é²
                 console.log(`APIè«‹æ±‚å¤±æ•—ï¼Œå°‡åœ¨ ${Math.round(delay/1000)} ç§’å¾Œé€²è¡Œç¬¬ ${attempt + 1} æ¬¡é‡è©¦...`);
            }
            
            // ç­‰å¾…è¨ˆç®—å‡ºçš„å»¶é²æ™‚é–“
            await sleep(delay); 
        }
    }
    // ==========================================================
    // --- â–²â–²â–² ã€æ ¸å¿ƒä¿®æ”¹ã€‘åˆ°é€™è£¡çµæŸ â–²â–²â–² ---
    // ==========================================================
    
    // å¦‚æœè¿´åœˆçµæŸéƒ½æ²’æˆåŠŸï¼Œè¿”å›ä¸€å€‹å‚™ç”¨çµæœï¼Œé˜²æ­¢éŠæˆ²å¡æ­»
    console.error("æ‰€æœ‰é‡è©¦å‡å¤±æ•—ï¼Œè¿”å›å‚™ç”¨è¡Œå‹•ã€‚");
    if (actionType === 'answer') return { judgement: 'ç„¡é—œ', remark: 'ï¼ˆAIæ€è€ƒçŸ­è·¯äº†...ï¼‰' };
    if (actionType === 'evaluate_guess') return { isCorrect: false };
    return { type: 'question', content: 'ä»–/å¥¹æ˜¯äººé¡å—ï¼Ÿ' };
}
/**
 * ã€æµ·é¾œæ¹¯ V2 - çµç®—å¢å¼·ç‰ˆã€‘æ­æ›‰ç­”æ¡ˆä¸¦é¡¯ç¤ºçµç®—ä»‹é¢
 */
async function revealStsAnswer() {
    if (!seaTurtleSoupState.isActive) return;
    
    // 1. æ¨™è¨˜éŠæˆ²çµæŸ
    seaTurtleSoupState.isActive = false; // ç¢ºä¿éŠæˆ²ç‹€æ…‹è®Šç‚ºéå•Ÿå‹•
    seaTurtleSoupState.phase = 'reveal';
    
    // 2. éš±è—éŠæˆ²ä¸­çš„æ“ä½œå€åŸŸ
    document.getElementById('sts-action-area').style.visibility = 'hidden';
    
    // 3. æº–å‚™è¤‡ç›¤å…§å®¹
    const summaryText = generateStsSummary();
    
    // 4. é¡¯ç¤ºçµç®—å½ˆçª—
    showStsSummaryModal(summaryText);
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾œæ¹¯çµç®—èˆ‡åˆ†äº«åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

/**
 * ç”Ÿæˆæµ·é¾œæ¹¯çš„è¤‡ç›¤æ–‡æœ¬
 * @returns {string} æ ¼å¼åŒ–å¾Œçš„è¤‡ç›¤Markdownæ–‡æœ¬
 */
function generateStsSummary() {
    let summaryText = `**æµ·é¾œæ¹¯ - éŠæˆ²è¤‡ç›¤**\n\n`;
    summaryText += `**å‡ºé¡Œäºº:** ${seaTurtleSoupState.riddleProvider.name}\n\n`;
    summaryText += `**è¬é¢:**\n${seaTurtleSoupState.riddle}\n\n`;
    summaryText += `**è¬åº•:**\n${seaTurtleSoupState.answer}`;
    return summaryText;
}

/**
 * é¡¯ç¤ºéŠæˆ²çµç®—å¡ç‰‡æ¨¡æ…‹æ¡†
 * @param {string} summaryText - è¤‡ç›¤æ–‡æœ¬
 */
function showStsSummaryModal(summaryText) {
    const modal = document.getElementById('sts-summary-modal');
    const contentEl = document.getElementById('sts-summary-content');
    
    // ä½¿ç”¨ä½ å·²æœ‰çš„Markdownæ¸²æŸ“å‡½æ•¸ï¼Œè®“è¤‡ç›¤æ›´å¥½çœ‹
    contentEl.innerHTML = renderMarkdown(summaryText);
    
    // ç‚ºæŒ‰éˆ•ç¶å®šäº‹ä»¶ (ä½¿ç”¨å…‹éš†ç¯€é»é˜²æ­¢é‡è¤‡ç¶å®š)
    const shareBtn = document.getElementById('share-sts-summary-btn');
    const newShareBtn = shareBtn.cloneNode(true);
    shareBtn.parentNode.replaceChild(newShareBtn, shareBtn);
    newShareBtn.onclick = () => openStsShareTargetPicker(summaryText);

    const backBtn = document.getElementById('back-to-hall-from-sts-btn');
    const newBackBtn = backBtn.cloneNode(true);
    backBtn.parentNode.replaceChild(newBackBtn, backBtn);
    newBackBtn.onclick = () => {
        modal.classList.remove('visible');
        showScreen('game-hall-screen');
    };

    modal.classList.add('visible');
}

/**
 * æ‰“é–‹è¤‡ç›¤åˆ†äº«ç›®æ¨™é¸æ“‡å™¨
 * @param {string} summaryText - è¦åˆ†äº«çš„è¤‡ç›¤æ–‡æœ¬
 */
function openStsShareTargetPicker(summaryText) {
    const modal = document.getElementById('sts-share-target-modal');
    const listEl = document.getElementById('sts-share-target-list');
    listEl.innerHTML = '';

    // å¾éŠæˆ²ç‹€æ…‹ä¸­ç²å–æ‰€æœ‰éå‡ºé¡Œäººçš„AIç©å®¶
    const aiPlayers = seaTurtleSoupState.players.filter(p => !p.isUser && !p.isProvider);

    if (aiPlayers.length === 0) {
        alert("æ²’æœ‰å¯ä»¥åˆ†äº«çš„AIç©å®¶ã€‚");
        return;
    }

    // æ¸²æŸ“å¯é¸çš„AIç©å®¶åˆ—è¡¨
    aiPlayers.forEach(player => {
        const item = document.createElement('div');
        item.className = 'player-selection-item'; // è¤‡ç”¨æ¨£å¼
        item.innerHTML = `
            <input type="checkbox" class="sts-target-checkbox" value="${player.id}" checked>
            <img src="${player.avatar || defaultAvatar}" alt="${player.name}">
            <span class="name">${player.name}</span>
        `;
        listEl.appendChild(item);
    });

    // ç¶å®šæŒ‰éˆ•äº‹ä»¶
    const confirmBtn = document.getElementById('sts-confirm-share-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.onclick = () => {
        const selectedIds = Array.from(document.querySelectorAll('.sts-target-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length > 0) {
            sendStsSummaryToSelectedPlayers(summaryText, selectedIds);
        } else {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åˆ†äº«ç‰©ä»¶ï¼");
        }
    };

    document.getElementById('sts-cancel-share-btn').onclick = () => modal.classList.remove('visible');
    document.getElementById('sts-select-all-btn').onclick = () => {
        document.querySelectorAll('.sts-target-checkbox').forEach(cb => cb.checked = true);
    };
    document.getElementById('sts-deselect-all-btn').onclick = () => {
        document.querySelectorAll('.sts-target-checkbox').forEach(cb => cb.checked = false);
    };

    modal.classList.add('visible');
}

/**
 * å°‡éŠæˆ²è¤‡ç›¤ç™¼é€åˆ°ã€é¸å®šã€‘çš„AIè§’è‰²çš„èŠå¤©ä¸­
 * @param {string} summaryText - è¤‡ç›¤æ–‡æœ¬
 * @param {string[]} targetIds - ç›®æ¨™AIè§’è‰²çš„IDé™£åˆ—
 */
async function sendStsSummaryToSelectedPlayers(summaryText, targetIds) {
    // é—œé–‰æ‰€æœ‰å¯èƒ½æ‰“é–‹çš„å½ˆçª—
    document.getElementById('sts-summary-modal').classList.remove('visible');
    document.getElementById('sts-share-target-modal').classList.remove('visible');

    let sentCount = 0;
    const aiContext = `[ç³»çµ±æŒ‡ä»¤ï¼šå‰›å‰›çµæŸäº†ä¸€å±€æµ·é¾œæ¹¯ï¼Œé€™æ˜¯éŠæˆ²è¤‡ç›¤ã€‚è«‹æ ¹æ“šé€™å€‹è¤‡ç›¤å…§å®¹ï¼Œä»¥ä½ çš„è§’è‰²äººè¨­ï¼Œå’Œç”¨æˆ¶èŠèŠå‰›æ‰çš„éŠæˆ²ã€‚]\n\n${summaryText}`;

    for (const chatId of targetIds) {
        const chat = state.chats[chatId];
        if (chat) {
            // å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„è¤‡ç›¤å¡ç‰‡æ¶ˆæ¯
            const visibleMessage = {
                role: 'user',
                type: 'text',
                timestamp: Date.now(),
                content: summaryText
            };
            
            // å‰µå»ºå°AIå¯è¦‹çš„éš±è—æŒ‡ä»¤
            const hiddenInstruction = {
                role: 'system',
                content: aiContext,
                timestamp: Date.now() + 1,
                isHidden: true
            };
            
            chat.history.push(visibleMessage, hiddenInstruction);
            await db.chats.put(chat);
            sentCount++;
        }
    }
    
    await showCustomAlert("åˆ†äº«æˆåŠŸ", `éŠæˆ²è¤‡ç›¤å·²åˆ†äº«è‡³ ${sentCount} ä½AIç©å®¶çš„èŠå¤©ä¸­ï¼`);
    showScreen('game-hall-screen');
}

// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²

/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘è¨ˆç®—å…©å€‹å­—ä¸²çš„ç°¡å–®ç›¸ä¼¼åº¦
 */
function simpleSimilarity(str1, str2) {
    const set1 = new Set(str1.split(''));
    const set2 = new Set(str2.split(''));
    const intersection = new Set([...set1].filter(x => set2.has(x)));
    return intersection.size / Math.max(set1.size, set2.size);
}

// â–²â–²â–² æµ·é¾œæ¹¯åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™è£¡æ˜¯åŠ‡æœ¬æ®ºéŠæˆ²çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼


/**
 * ã€åŠ‡æœ¬æ®ºã€‘æ‰“é–‹éŠæˆ²è¨­ç½®ä»‹é¢
 */
async function openScriptKillSetup() {
    showScreen('script-kill-setup-screen');
    
    const scriptSelect = document.getElementById('script-kill-script-select');
    scriptSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡åŠ‡æœ¬ --</option>';

    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼ ---
    
    // 1. éæ­·æˆ‘å€‘å‰µå»ºçš„å…§ç½®åŠ‡æœ¬åº«
    BUILT_IN_SCRIPTS.forEach(script => {
        const option = document.createElement('option');
        option.value = script.id; // value æ˜¯åŠ‡æœ¬çš„å”¯ä¸€ID
        option.textContent = `ã€å…§ç½®ã€‘${script.name}`; // é¡¯ç¤ºçš„æ–‡æœ¬
        scriptSelect.appendChild(option);
    });

    // 2. è¼‰å…¥ä¸¦é¡¯ç¤ºè‡ªè¨‚åŠ‡æœ¬
    const customScripts = await db.scriptKillScripts.toArray();
    customScripts.forEach(script => {
        const option = document.createElement('option');
        option.value = script.id;
        option.textContent = `ã€è‡ªè¨‚ã€‘${script.name}`;
        scriptSelect.appendChild(option);
    });
    
    // --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² ---
    // æ¸²æŸ“ç©å®¶é¸æ“‡åˆ—è¡¨
    const selectionEl = document.getElementById('script-kill-player-selection');
    selectionEl.innerHTML = '<p>æ­£åœ¨è¼‰å…¥è§’è‰²åˆ—è¡¨...</p>';

    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    const allNpcs = Object.values(state.chats).flatMap(chat => (chat.npcLibrary || []).map(npc => ({...npc, owner: chat.name})));

    let playerOptions = [
        ...singleChats.map(c => ({ id: c.id, name: c.name, avatar: c.settings.aiAvatar, type: 'è§’è‰²' })),
        ...allNpcs.map(n => ({ id: n.id, name: n.name, avatar: n.avatar, type: `NPC (${n.owner})` }))
    ];

    selectionEl.innerHTML = '';
    playerOptions.forEach(player => {
        const item = document.createElement('div');
        item.className = 'player-selection-item'; // è¤‡ç”¨æ¨£å¼
        item.innerHTML = `
            <input type="checkbox" class="script-kill-player-checkbox" value="${player.id}">
            <img src="${player.avatar || defaultAvatar}" alt="${player.name}">
            <span class="name">${player.name}</span>
            <span class="type-tag">${player.type}</span>
        `;
        selectionEl.appendChild(item);
    });
}
// â–¼â–¼â–¼ åœ¨é€™è£¡é–‹å§‹é»è²¼ â–¼â–¼â–¼

/**
 * ã€åŠ‡æœ¬æ®ºã€‘é¡¯ç¤ºè§’è‰²é¸æ“‡å½ˆçª—ï¼Œè®“ç”¨æˆ¶é¸æ“‡è§’è‰²
 * @param {string} title - å½ˆçª—æ¨™é¡Œ
 * @param {Array<object>} options - è§’è‰²é¸é …é™£åˆ— [{text, value}]
 * @returns {Promise<number|null>} - è¿”å›ä½¿ç”¨è€…é¸æ“‡çš„è§’è‰²çš„ç´¢å¼•ï¼Œå¦‚æœå–æ¶ˆå‰‡è¿”å›null
 */
async function showRoleSelectionModal(title, options) {
    return new Promise(resolve => {
        const modal = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');

        modalTitle.textContent = title;
        
        let optionsHtml = '<div style="text-align: left; max-height: 400px; overflow-y: auto;">';
        options.forEach((option, index) => {
            optionsHtml += `
                <label style="display: block; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;">
                    <input type="radio" name="role_selection" value="${option.value}" ${index === 0 ? 'checked' : ''}>
                    ${option.text}
                </label>
            `;
        });
        optionsHtml += '</div>';

        modalBody.innerHTML = optionsHtml;
        modalConfirmBtn.textContent = 'ç¢ºèªé¸æ“‡';
        modalCancelBtn.style.display = 'block';

        modal.classList.add('visible');

        modalConfirmBtn.onclick = () => {
            const selectedRadio = document.querySelector('input[name="role_selection"]:checked');
            if (selectedRadio) {
                modal.classList.remove('visible');
                resolve(parseInt(selectedRadio.value));
            } else {
                alert("è«‹é¸æ“‡ä¸€å€‹è§’è‰²ï¼");
            }
        };
        
        modalCancelBtn.onclick = () => {
            modal.classList.remove('visible');
            resolve(null);
        };
    });
}


/**
 * ã€åŠ‡æœ¬æ®ºã€‘é–‹å§‹éŠæˆ²çš„æ ¸å¿ƒé‚è¼¯ (V3 - ç©å®¶è‡ªé¸ï¼ŒAIéš¨æ©Ÿç‰ˆ)
 */
async function startScriptKillGame() {
    const scriptId = document.getElementById('script-kill-script-select').value;
    if (!scriptId) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹åŠ‡æœ¬ï¼');
        return;
    }
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ if/else é‚è¼¯ â–¼â–¼â–¼
    let script;
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘ä¸å†åªæª¢æŸ¥ 'built_in_1'ï¼Œè€Œæ˜¯æª¢æŸ¥ scriptId æ˜¯å¦ä»¥ 'built_in_' é–‹é ­
    if (scriptId.startsWith('built_in_')) {
        // å¦‚æœæ˜¯ï¼Œå°±èª¿ç”¨ getBuiltInScript å‡½æ•¸ï¼Œä¸¦å°‡æ­£ç¢ºçš„IDå‚³é€²å»
        script = getBuiltInScript(scriptId); 
    } else {
        // å¦å‰‡ï¼Œèªªæ˜æ˜¯è‡ªè¨‚åŠ‡æœ¬ï¼Œæ‰å»è³‡æ–™åº«è£¡æŸ¥æ‰¾
        script = await db.scriptKillScripts.get(parseInt(scriptId));
    }
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
    if (!script) {
        alert('è¼‰å…¥åŠ‡æœ¬å¤±æ•—ï¼');
        return;
    }

    const selectedCheckboxes = document.querySelectorAll('.script-kill-player-checkbox:checked');
    const requiredPlayers = script.roles.length - 1;
    if (selectedCheckboxes.length !== requiredPlayers) {
        alert(`æ­¤åŠ‡æœ¬éœ€è¦æ‚¨é‚€è«‹ ${requiredPlayers} ä½AIæˆ–NPCç©å®¶ï¼`);
        return;
    }
    
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨åˆ†é…è§’è‰²ï¼Œè«‹è€å¿ƒç­‰å¾…...");

    // 1. åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹
    scriptKillGameState = {
        isActive: true,
        script: script,
        players: [],
        gamePhase: 'start',
        turnIndex: 0,
        gameLog: [],
        evidenceCounts: {},
        votes: {},
        isFreeChoice: document.getElementById('script-kill-free-choice-toggle').checked,
        discussionRound: 1, // <--- â˜…â˜…â˜… åœ¨é€™è£¡æ·»åŠ é€™ä¸€è¡Œ â˜…â˜…â˜…
        collectedClueIds: new Set() 
    };
    // 2. æ”¶é›†ç©å®¶è³‡è¨Š (é€™éƒ¨åˆ†ä¸è®Š)
    let invitedPlayers = [];
    selectedCheckboxes.forEach(checkbox => {
        const playerId = checkbox.value;
        const chat = Object.values(state.chats).find(c => c.id === playerId);
        if (chat) {
            invitedPlayers.push({ id: chat.id, name: chat.name, avatar: chat.settings.aiAvatar, persona: chat.settings.aiPersona, isUser: false });
        } else {
            for (const c of Object.values(state.chats)) {
                const npc = (c.npcLibrary || []).find(n => n.id === playerId);
                if (npc) {
                    invitedPlayers.push({ id: npc.id, name: npc.name, avatar: npc.avatar, persona: npc.persona, isUser: false });
                    break;
                }
            }
        }
    });
    const userPlayer = {
        id: 'user', name: state.qzoneSettings.nickname || 'æˆ‘',
        avatar: state.qzoneSettings.avatar || defaultAvatar, isUser: true, persona: 'ä¸€å€‹å–œæ­¡æ¢æ¡ˆçš„æ™®é€šäºº'
    };

    // --- 3. ã€æ ¸å¿ƒæ”¹é€ ã€‘æ ¹æ“šé–‹é—œç‹€æ…‹ï¼ŒåŸ·è¡Œä¸åŒçš„åˆ†é…é‚è¼¯ ---
    const assignedRoles = new Map(); // ä½¿ç”¨Mapå­˜å„² {playerId -> roleObject}
    let remainingRoles = [...script.roles]; // å‰µå»ºä¸€å€‹å¯ä¿®æ”¹çš„è§’è‰²åˆ—è¡¨å‰¯æœ¬

    if (scriptKillGameState.isFreeChoice) {
        // --- è‡ªç”±é¸æ“‡æ¨¡å¼ (ç©å®¶è‡ªé¸ï¼ŒAIéš¨æ©Ÿ) ---
        
        // 3a. ç”¨æˆ¶å…ˆå¾æ‰€æœ‰è§’è‰²ä¸­é¸æ“‡ä¸€å€‹
        const roleOptions = remainingRoles.map((role, index) => ({
            text: `ã€${role.name}ã€‘: ${role.description.substring(0, 40)}...`,
            value: index
        }));
        const userChoiceIndex = await showRoleSelectionModal("è«‹é¸æ“‡ä½ çš„è§’è‰²", roleOptions);
        if (userChoiceIndex === null) {
            hideCustomModal(); 
            alert("ä½ å–æ¶ˆäº†è§’è‰²é¸æ“‡ï¼ŒéŠæˆ²æœªé–‹å§‹ã€‚");
            return;
        }
        // å¾è§’è‰²æ± ä¸­ç§»é™¤ç”¨æˆ¶é¸æ“‡çš„è§’è‰²ï¼Œä¸¦åˆ†é…çµ¦ç”¨æˆ¶
        const userChosenRole = remainingRoles.splice(userChoiceIndex, 1)[0];
        assignedRoles.set(userPlayer.id, userChosenRole);

        // 3b. ã€ã€ã€é€™å°±æ˜¯æœ¬æ¬¡çš„æ ¸å¿ƒä¿®æ”¹ï¼ã€‘ã€‘ã€‘
        // å°‡å‰©é¤˜çš„è§’è‰²ã€éš¨æ©Ÿæ‰“äº‚ã€‘
        remainingRoles.sort(() => Math.random() - 0.5); 
        // ç„¶å¾Œã€æŒ‰é †åºã€‘åˆ†é…çµ¦AIå€‘
        invitedPlayers.forEach((aiPlayer, index) => {
            assignedRoles.set(aiPlayer.id, remainingRoles[index]);
        });

    } else {
        // --- éš¨æ©Ÿåˆ†é…æ¨¡å¼ (èˆŠé‚è¼¯ä¿æŒä¸è®Š) ---
        const allGamePlayers = [userPlayer, ...invitedPlayers];
        allGamePlayers.sort(() => Math.random() - 0.5);
        const shuffledRoles = [...script.roles].sort(() => Math.random() - 0.5);
        allGamePlayers.forEach((player, index) => {
            assignedRoles.set(player.id, shuffledRoles[index]);
        });
    }

    // 4. çµ„åˆæœ€çµ‚çš„ç©å®¶æ¸…å–® (é€™éƒ¨åˆ†ä¸è®Š)
    const allPlayersWithRoles = [userPlayer, ...invitedPlayers].map(player => ({
        ...player,
        role: assignedRoles.get(player.id),
        evidence: []
    }));
    scriptKillGameState.players = allPlayersWithRoles;

    // 5. é¡¯ç¤ºèº«ä»½çµ¦ä½¿ç”¨è€… (é€™éƒ¨åˆ†ä¸è®Š)
    const myPlayer = scriptKillGameState.players.find(p => p.isUser);
    hideCustomModal(); 
    await showCustomAlert(
        `ä½ çš„è§’è‰²æ˜¯ï¼šã€${myPlayer.role.name}ã€‘`,
        `**è§’è‰²ä»‹ç´¹:**\n${myPlayer.role.description}\n\n**ä½ çš„ä»»å‹™:**\n${myPlayer.role.tasks}`
    );

    // 6. åˆ‡æ›åˆ°éŠæˆ²ä»‹é¢ä¸¦é–‹å§‹ (é€™éƒ¨åˆ†ä¸è®Š)
    showScreen('script-kill-game-screen');
    await processScriptKillTurn();
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€çµ‚æµç¨‹ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ processScriptKillTurn å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€åŠ‡æœ¬æ®º V4 - æœ€çµ‚æµç¨‹å¼•æ“ã€‘éŠæˆ²ä¸»è¿´åœˆ/å¼•æ“
 */
async function processScriptKillTurn() {
    if (!scriptKillGameState.isActive) return;
    renderScriptKillGameScreen();

    switch (scriptKillGameState.gamePhase) {
        case 'start':
            logToScriptKillGame(`éŠæˆ²é–‹å§‹ï¼åŠ‡æœ¬ï¼šã€${scriptKillGameState.script.name}ã€‘`, 'system');
            await sleep(1000);
            logToScriptKillGame(`ã€æ•…äº‹èƒŒæ™¯ã€‘\n${scriptKillGameState.script.storyBackground}`, 'system');
            await sleep(3000);
            logToScriptKillGame('è«‹å„ä½ç©å®¶æŸ¥çœ‹è‡ªå·±çš„è§’è‰²è³‡è¨Šï¼Œæº–å‚™é€²è¡Œè‡ªæˆ‘ä»‹ç´¹ã€‚', 'system');
            scriptKillGameState.gamePhase = 'introduction';
            await sleep(2000);
            await processScriptKillTurn();
            break;

        case 'introduction':
            logToScriptKillGame('ç¾åœ¨é–‹å§‹è¼ªæµé€²è¡Œè‡ªæˆ‘ä»‹ç´¹ã€‚', 'system');
            for (const player of scriptKillGameState.players) {
                renderScriptKillGameScreen({ speakingPlayerId: player.id });
                let introduction = player.isUser
                    ? await waitForUserActionSK('è¼ªåˆ°ä½ è‡ªæˆ‘ä»‹ç´¹äº†', 'speak', 'ç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä½ è‡ªå·±å’Œä½ æ‰€æ‰®æ¼”çš„è§’è‰²...')
                    : await triggerScriptKillAiAction(player.id, 'introduce');
                logToScriptKillGame({ player: player, speech: introduction }, 'speech');
                await sleep(1000);
            }
            renderScriptKillGameScreen();
            logToScriptKillGame('è‡ªæˆ‘ä»‹ç´¹çµæŸï¼Œç¾åœ¨è«‹å„ä½ç©å®¶åˆ†äº«è‡ªå·±çš„æ™‚é–“ç·šã€‚', 'system');
            scriptKillGameState.gamePhase = 'timeline_discussion';
            await sleep(2000);
            await processScriptKillTurn();
            break;

        case 'timeline_discussion':
            logToScriptKillGame('è«‹å„ä½ç©å®¶è¼ªæµç™¼è¨€ï¼Œæ¢³ç†ä¸¦å…¬é–‹è‡ªå·±çš„æ™‚é–“ç·šã€‚', 'system');
            await sleep(1500);
            for (const player of scriptKillGameState.players) {
                renderScriptKillGameScreen({ speakingPlayerId: player.id });
                let timelineSpeech = player.isUser
                    ? await waitForUserActionSK('è¼ªåˆ°ä½ é™³è¿°æ™‚é–“ç·šäº†', 'speak', 'è«‹æ ¹æ“šä½ çš„åŠ‡æœ¬ï¼Œè©³ç´°èªªæ˜ä½ çš„è¡Œå‹•è»Œè·¡...')
                    : await triggerScriptKillAiAction(player.id, 'discuss_timeline');
                logToScriptKillGame({ player: player, speech: timelineSpeech }, 'speech');
                await sleep(1000);
            }
            renderScriptKillGameScreen();
            logToScriptKillGame('æ™‚é–“ç·šé™³è¿°çµæŸï¼Œç¾åœ¨é€²å…¥ã€ç¬¬ä¸€è¼ªæœè­‰ç’°ç¯€ã€‘ã€‚', 'system');
            scriptKillGameState.gamePhase = 'evidence_round_1';
            await processScriptKillTurn();
            break;

        case 'evidence_round_1':
            updateActionAreaSK();
            logToScriptKillGame('é€²å…¥ç¬¬ä¸€è¼ªæœè­‰ï¼Œæ¯ä½ç©å®¶æœ‰ã€2æ¬¡ã€‘æœè­‰æ©Ÿæœƒã€‚', 'system');
            await sleep(2000);
            
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘AI é€²è¡Œç¬¬ä¸€è¼ªçš„ç¬¬1æ¬¡æœè­‰
            for (const player of scriptKillGameState.players) {
                if (player.isUser) continue;
                logToScriptKillGame(`è¼ªåˆ° ${player.role.name} (${player.name}) é€²è¡Œç¬¬1æ¬¡æœè­‰...`);
                await sleep(2000);
                await handleAiSearch(player);
            }
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘AI é€²è¡Œç¬¬ä¸€è¼ªçš„ç¬¬2æ¬¡æœè­‰
            for (const player of scriptKillGameState.players) {
                 if (player.isUser) continue;
                logToScriptKillGame(`è¼ªåˆ° ${player.role.name} (${player.name}) é€²è¡Œç¬¬2æ¬¡æœè­‰...`);
                await sleep(2000);
                await handleAiSearch(player);
            }
            logToScriptKillGame('æ‰€æœ‰AIæœè­‰å®Œç•¢ï¼Œç©å®¶å¯ä»¥ç¹¼çºŒæœè­‰æˆ–çµæŸæœ¬ç’°ç¯€é€²å…¥è¨è«–ã€‚', 'system');
            break;

        case 'discussion_round_1':
            logToScriptKillGame('ç¬¬ä¸€è¼ªæœè­‰çµæŸï¼Œç¾åœ¨é€²å…¥ã€ç¬¬ä¸€è¼ªè¨è«–ç’°ç¯€ã€‘ã€‚', 'system');
            updateActionAreaSK();
            break;

        case 'evidence_round_2':
            updateActionAreaSK();
            logToScriptKillGame('ç¬¬ä¸€è¼ªè¨è«–çµæŸï¼Œç¾åœ¨é€²å…¥ã€ç¬¬äºŒè¼ªæœè­‰ç’°ç¯€ã€‘ã€‚', 'system');
            logToScriptKillGame('æ ¹æ“šå‰›æ‰çš„è¨è«–ï¼Œå„ä½ç©å®¶ç¾åœ¨é‚„æœ‰ã€1æ¬¡ã€‘æœè­‰æ©Ÿæœƒã€‚', 'system');
            await sleep(2000);
            
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘AI é€²è¡Œç¬¬äºŒè¼ªçš„å”¯ä¸€æ¬¡æœè­‰
            for (const player of scriptKillGameState.players) {
                if (player.isUser) continue;
                const searchCount = scriptKillGameState.evidenceCounts[player.id] || 0;
                if(searchCount < 3) { // ç¢ºä¿AIä¹Ÿæœ‰æ¬¡æ•¸é™åˆ¶
                    logToScriptKillGame(`è¼ªåˆ° ${player.role.name} (${player.name}) é€²è¡Œè£œå……æœè­‰...`);
                    await sleep(2000);
                    await handleAiSearch(player);
                }
            }
            logToScriptKillGame('æ‰€æœ‰AIè£œå……æœè­‰å®Œç•¢ï¼Œç©å®¶å¯ä»¥ç¹¼çºŒæœè­‰æˆ–çµæŸæœ¬ç’°ç¯€é€²å…¥æœ€çµ‚è¨è«–ã€‚', 'system');
            break;

        // ã€å…¨æ–°éšæ®µã€‘ç¬¬äºŒè¼ªè¨è«–
        case 'discussion_round_2':
            logToScriptKillGame('ç¬¬äºŒè¼ªæœè­‰çµæŸï¼Œç¾åœ¨é€²å…¥ã€ç¬¬äºŒè¼ªè¨è«–ç’°ç¯€ã€‘ã€‚', 'system');
            updateActionAreaSK(); // é¡¯ç¤ºç™¼è¨€æŒ‰éˆ•
            break;

        // ã€å…¨æ–°éšæ®µã€‘ç¬¬ä¸‰è¼ªï¼ˆæœ€çµ‚ï¼‰è¨è«–
        case 'discussion_round_3':
            logToScriptKillGame('ç¬¬äºŒè¼ªè¨è«–çµæŸï¼Œç¾åœ¨é€²å…¥ã€æœ€çµ‚è¨è«–ç’°ç¯€ã€‘ã€‚', 'system');
            updateActionAreaSK(); // å†æ¬¡é¡¯ç¤ºç™¼è¨€æŒ‰éˆ•
            break;
            
        case 'voting':
            // æŠ•ç¥¨å’ŒçµæŸé‚è¼¯ä¿æŒä¸è®Š
            logToScriptKillGame('æœ€çµ‚è¨è«–çµæŸï¼Œç¾åœ¨é€²å…¥æŠ•ç¥¨ç’°ç¯€ã€‚è«‹æŠ•ç¥¨æŒ‡èªå…‡æ‰‹ï¼', 'system');
            const detailedVotes = {}; 
            const alivePlayers = scriptKillGameState.players;
            for (const voter of alivePlayers) {
                let targetId = voter.isUser
                    ? await waitForUserActionSK('è«‹æŠ•ç¥¨æŒ‡èªå…‡æ‰‹', 'vote')
                    : await triggerScriptKillAiAction(voter.id, 'vote');
                detailedVotes[voter.id] = targetId;
                if (targetId) {
                    const targetPlayer = scriptKillGameState.players.find(p => p.id === targetId);
                    logToScriptKillGame(`${voter.name} æŠ•ç¥¨çµ¦äº† ${targetPlayer.name}ã€‚`);
                } else {
                    logToScriptKillGame(`${voter.name} æ£„ç¥¨äº†ã€‚`);
                }
            }
            scriptKillGameState.votes = detailedVotes;
            scriptKillGameState.gamePhase = 'end';
            await sleep(2000);
            await processScriptKillTurn();
            break;

        case 'end':
            // çµæŸé‚è¼¯ä¿æŒä¸è®Š
            logToScriptKillGame('æŠ•ç¥¨çµæŸï¼Œæ­£åœ¨å…¬ä½ˆçœŸç›¸...', 'system');
            await sleep(2000);
            const voteCounts = {};
            for (const voterId in scriptKillGameState.votes) {
                const targetId = scriptKillGameState.votes[voterId];
                if (targetId) { voteCounts[targetId] = (voteCounts[targetId] || 0) + 1; }
            }
            let maxVotes = 0, votedPlayerIds = [];
            for (const playerId in voteCounts) {
                if (voteCounts[playerId] > maxVotes) {
                    maxVotes = voteCounts[playerId];
                    votedPlayerIds = [playerId];
                } else if (voteCounts[playerId] === maxVotes) {
                    votedPlayerIds.push(playerId);
                }
            }
            const killer = scriptKillGameState.players.find(p => p.role.isKiller);
            let winner = '', resultText = '';
            if (votedPlayerIds.length === 1 && votedPlayerIds[0] === killer.id) {
                winner = 'å¥½äººé™£ç‡Ÿ';
                resultText = `æ­å–œï¼ä½ å€‘æˆåŠŸæŒ‡èªå‡ºå…‡æ‰‹ã€${killer.role.name} (${killer.name})ã€‘ï¼å¥½äººé™£ç‡Ÿå‹åˆ©ï¼`;
            } else {
                winner = 'å…‡æ‰‹é™£ç‡Ÿ';
                resultText = `å¾ˆéºæ†¾ï¼ŒçœŸæ­£çš„å…‡æ‰‹æ˜¯ã€${killer.role.name} (${killer.name})ã€‘ï¼å…‡æ‰‹é™£ç‡Ÿå‹åˆ©ï¼`;
            }
            logToScriptKillGame(resultText, 'system');
            await sleep(3000);
            logToScriptKillGame(`ã€çœŸç›¸ã€‘\n${scriptKillGameState.script.truth}`, 'system');
            await showCustomAlert("è«‹ç¨å€™...", "AIæ­£åœ¨ç”Ÿæˆæœ¬å±€è¤‡ç›¤æ‘˜è¦...");
            const aiSummary = await generateAiSkSummary();
            const summary = generateSkSummary(winner, aiSummary);
            showScriptKillSummaryModal(summary); 
            scriptKillGameState.isActive = false;
            updateActionAreaSK(); 
            break;
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



/**
 * ã€åŠ‡æœ¬æ®ºã€‘æ¸²æŸ“éŠæˆ²ä¸»ä»‹é¢
 */
function renderScriptKillGameScreen(options = {}) {
    // é€™éƒ¨åˆ†å’Œç‹¼äººæ®ºçš„æ¸²æŸ“å‡½æ•¸éå¸¸ç›¸ä¼¼ï¼Œæˆ‘å€‘ç›´æ¥è¤‡ç”¨
    const playersGrid = document.getElementById('script-kill-players-grid');
    const logContainer = document.getElementById('script-kill-game-log');
    
    playersGrid.innerHTML = '';
    scriptKillGameState.players.forEach(player => {
        const seat = document.createElement('div');
        seat.className = 'player-seat';
        const avatarClass = `player-avatar ${options.speakingPlayerId === player.id ? 'speaking' : ''}`;
        
        seat.innerHTML = `
            <img src="${player.avatar}" class="${avatarClass}">
            <span class="player-name">${player.role.name}</span>
        `;
        playersGrid.appendChild(seat);
    });

    logContainer.innerHTML = '';
    scriptKillGameState.gameLog.forEach(log => {
        const logEl = document.createElement('div');
        if (log.type === 'speech') {
            logEl.className = 'log-entry speech';
            const { player, speech } = log.message;
            logEl.innerHTML = `
                <img src="${player.avatar}" class="speech-avatar">
                <div class="speech-content">
                    <span class="speaker">${player.role.name} (${player.name})</span>
                    <span class="speech-text">${speech.replace(/\n/g, '<br>')}</span>
                </div>
            `;
        } else {
            logEl.className = `log-entry ${log.type}`;
            logEl.innerHTML = String(log.message).replace(/\n/g, '<br>');
        }
        logContainer.appendChild(logEl);
    });
    logContainer.scrollTop = logContainer.scrollHeight;
}

/**
 * ã€åŠ‡æœ¬æ®ºã€‘æ·»åŠ ä¸€æ¢éŠæˆ²æ—¥èªŒ
 */
function logToScriptKillGame(message, type = 'system') {
    scriptKillGameState.gameLog.push({ message, type });
    renderScriptKillGameScreen();
}

/**
 * ã€åŠ‡æœ¬æ®º V4 - æ–°æµç¨‹ç‰ˆã€‘æ›´æ–°åº•éƒ¨æ“ä½œå€åŸŸçš„æŒ‰éˆ•
 */
function updateActionAreaSK() {
    const actionArea = document.getElementById('script-kill-action-area');
    actionArea.innerHTML = '';
    const user = scriptKillGameState.players.find(p => p.isUser);
    
    const phase = scriptKillGameState.gamePhase;
    const searchCount = scriptKillGameState.evidenceCounts[user.id] || 0;

    if (phase === 'evidence_round_1' || phase === 'evidence_round_2') {
        let searchesLeftInRound, totalInRound;
        if (phase === 'evidence_round_1') {
            searchesLeftInRound = 2 - searchCount;
            totalInRound = 2;
        } else { // evidence_round_2
            searchesLeftInRound = 3 - searchCount;
            totalInRound = 1;
        }
        
        const searchBtn = document.createElement('button');
        searchBtn.id = 'sk-search-evidence-btn';
        searchBtn.className = 'form-button';
        searchBtn.textContent = `æœè­‰ (${searchesLeftInRound}/${totalInRound})`;
        searchBtn.disabled = searchesLeftInRound <= 0;
        actionArea.appendChild(searchBtn);
        
        const endSearchBtn = document.createElement('button');
        endSearchBtn.id = 'sk-end-search-btn';
        endSearchBtn.className = 'form-button-secondary';
        endSearchBtn.textContent = (phase === 'evidence_round_1') ? 'é€²å…¥ç¬¬ä¸€è¼ªè¨è«–' : 'é€²å…¥ç¬¬äºŒè¼ªè¨è«–';
        actionArea.appendChild(endSearchBtn);

    } else if (phase === 'discussion_round_1' || phase === 'discussion_round_2' || phase === 'discussion_round_3') {
        const speakBtn = document.createElement('button');
        speakBtn.id = 'sk-speak-btn';
        speakBtn.className = 'form-button';
        speakBtn.textContent = 'æˆ‘è¦ç™¼è¨€';
        actionArea.appendChild(speakBtn);
    } else if (!scriptKillGameState.isActive && phase === 'end') {
        const backBtn = document.createElement('button');
        backBtn.className = 'form-button';
        backBtn.textContent = 'è¿”å›éŠæˆ²å¤§å»³';
        backBtn.onclick = () => showScreen('game-hall-screen');
        actionArea.appendChild(backBtn);
    }
}



// â–¼â–¼â–¼ ã€åŠ‡æœ¬æ®ºè¼¸å…¥æ¡†ç¾åŒ–ç‰ˆã€‘è«‹ç”¨é€™å€‹ã€å…¨æ–°ã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ waitForUserActionSK å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€åŠ‡æœ¬æ®º V2 - è¼¸å…¥æ¡†ç¾åŒ–ç‰ˆã€‘ç­‰å¾…ä½¿ç”¨è€…è¡Œå‹•çš„é€šç”¨å‡½æ•¸
 */
function waitForUserActionSK(promptText, actionType, placeholder = '') {
    return new Promise(resolve => {
        const actionArea = document.getElementById('script-kill-action-area');
        actionArea.innerHTML = '';
        actionArea.className = 'script-kill-action-area'; // é‡ç½®class

        if (actionType === 'speak') {
            // --- é€™æ˜¯æˆ‘å€‘ç¾åŒ–å¾Œçš„ç™¼è¨€è¼¸å…¥å€ ---
            actionArea.classList.add('speaking-mode'); // å•Ÿå‹•æ–°CSS

            const textarea = document.createElement('textarea');
            textarea.id = 'user-sk-speech-input'; // ä½¿ç”¨åŠ‡æœ¬æ®ºå°ˆç”¨çš„ID
            textarea.rows = 1;
            textarea.placeholder = placeholder || 'è«‹è¼¸å…¥ä½ çš„ç™¼è¨€...';
            // å³æ™‚èª¿æ•´é«˜åº¦
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
            });

            const endBtn = document.createElement('button');
            endBtn.id = 'sk-end-speech-btn'; // ä½¿ç”¨åŠ‡æœ¬æ®ºå°ˆç”¨çš„ID
            endBtn.className = 'form-button';
            endBtn.textContent = 'çµæŸç™¼è¨€';

            actionArea.appendChild(textarea);
            actionArea.appendChild(endBtn);
            
            textarea.focus();

            endBtn.onclick = () => {
                const speech = textarea.value.trim() || "æˆ‘æ²’ä»€éº¼å¥½èªªçš„ï¼Œéã€‚";
                actionArea.innerHTML = '';
                actionArea.classList.remove('speaking-mode');
                resolve(speech);
            };
            return; // çµæŸ 'speak' åˆ†æ”¯
        } 
        
        // --- ä»¥ä¸‹æ˜¯æŠ•ç¥¨é‚è¼¯ï¼Œä¿æŒåŸæ¨£ ---
        else if (actionType === 'vote') {
            const modal = document.getElementById('script-kill-vote-modal');
            const optionsEl = document.getElementById('sk-vote-options-list');
            optionsEl.innerHTML = '';
            
            scriptKillGameState.players.forEach(player => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="radio" name="sk_vote_target" value="${player.id}"> ${player.role.name} (${player.name})`;
                optionsEl.appendChild(label);
            });
            
            document.getElementById('confirm-sk-vote-btn').onclick = () => {
                const selected = document.querySelector('input[name="sk_vote_target"]:checked');
                if (selected) {
                    modal.classList.remove('visible');
                    resolve(selected.value);
                } else {
                    alert('è«‹é¸æ“‡ä¸€å€‹æŠ•ç¥¨ç‰©ä»¶ï¼');
                }
            };
            document.getElementById('cancel-sk-vote-btn').onclick = () => {
                modal.classList.remove('visible');
                resolve(null); // ç”¨æˆ¶å–æ¶ˆ
            };
            modal.classList.add('visible');
        }
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘è™•ç†å–®å€‹AIçš„æœè­‰è¡Œå‹• (æ¯æ¬¡åªæœä¸€å€‹ç·šç´¢)
 * @param {object} player - æ­£åœ¨è¡Œå‹•çš„AIç©å®¶ç‰©ä»¶
 */
async function handleAiSearch(player) {
    const script = scriptKillGameState.script;
    
    // æ¶ˆè€—ä¸€æ¬¡æœè­‰æ©Ÿæœƒ
    scriptKillGameState.evidenceCounts[player.id] = (scriptKillGameState.evidenceCounts[player.id] || 0) + 1;
    
    let foundMessage = ''; // ç”¨æ–¼è¨˜éŒ„æœ¬è¼ªæœè­‰çš„çµæœ

    // 1. å¢åŠ éš¨æ©Ÿæ€§ï¼šæœ‰30%çš„å¹¾ç‡ä»€éº¼éƒ½æœä¸åˆ°
    if (Math.random() < 0.30) {
        foundMessage = "ä»€éº¼éƒ½æ²’ç™¼ç¾ã€‚";
    } else {
        // 2. æ‰¾å‡ºæ‰€æœ‰ã€å…¨åŸŸé‚„æœªè¢«ç™¼ç¾ã€‘çš„ç·šç´¢
        const uncollectedClues = script.clues.filter(c => !scriptKillGameState.collectedClueIds.has(c.description));

        if (uncollectedClues.length > 0) {
            // 3. éš¨æ©Ÿæ‰¾åˆ°ä¸€æ¢æ–°ç·šç´¢
            const foundClue = uncollectedClues[Math.floor(Math.random() * uncollectedClues.length)];
            const clueSource = foundClue.owner === 'å…¬å…±' ? 'å…¬å…±å€åŸŸ' : `è§’è‰² ${foundClue.owner} çš„ç§äººç‰©å“`;
            
            // 4. å°‡ç·šç´¢å­˜å…¥AIæ‰‹ç‰Œå’Œå…¨åŸŸç·šç´¢æ± 
            player.evidence.push({ description: foundClue.description, source: clueSource });
            scriptKillGameState.collectedClueIds.add(foundClue.description);

            let revealed = true; // é»˜èªå…¬é–‹

            // 5. å¦‚æœç·šç´¢æ˜¯é—œæ–¼è‡ªå·±çš„ï¼Œè®“AIæ±ºç­–æ˜¯å¦å…¬é–‹
            if (foundClue.owner === player.role.name) {
                const revealDecision = await triggerScriptKillAiAction(player.id, 'reveal_clue', { clue: foundClue.description });
                if (revealDecision && revealDecision.action === 'hide') {
                    revealed = false;
                }
            }
            
            // 6. æ ¹æ“šAIçš„æ±ºç­–ï¼Œè¨˜éŒ„ä¸åŒçš„æœè­‰çµæœ
            if (revealed) {
                foundMessage = `åœ¨ã€${clueSource}ã€‘ç™¼ç¾ä¸¦å…¬é–‹äº†ç·šç´¢ï¼šâ€œ${foundClue.description}â€`;
            } else {
                foundMessage = `åœ¨ã€${clueSource}ã€‘ç™¼ç¾äº†ä¸€æ¢é—œæ–¼è‡ªå·±çš„ç·šç´¢ï¼Œä¸¦é¸æ“‡å°‡å…¶éš±è—ã€‚`;
            }
        } else {
            foundMessage = "æ²’æœ‰ç™¼ç¾æ›´å¤šæ–°ç·šç´¢äº†ã€‚";
        }
    }
    
    // 7. å°‡æœè­‰çµæœè¨˜éŒ„åˆ°éŠæˆ²æ—¥èªŒ
    logToScriptKillGame(`${player.name} å®Œæˆäº†ä¸€æ¬¡æœè­‰: ${foundMessage}`);
    await sleep(1500);
}

/**
 * ã€åŠ‡æœ¬æ®º-AIæ ¸å¿ƒã€‘è§¸ç™¼AIè¡Œå‹•
 */
async function triggerScriptKillAiAction(playerId, action, context = {}) {
    const player = scriptKillGameState.players.find(p => p.id === playerId);
    if (!player) return;
    
    const { proxyUrl, apiKey, model } = state.apiConfig;

// â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„ systemPrompt è®Šæ•¸å®šç¾© â–¼â–¼â–¼
    let jsonFormat = '';
    let extraContext = '';
    let systemPrompt = `
# ä»»å‹™: åŠ‡æœ¬æ®ºè§’è‰²æ‰®æ¼”
# ä½ çš„é›™é‡èº«ä»½ (å¿…é ˆåš´æ ¼éµå®ˆ)
1.  **ä½ çš„æœ¬é«”**: ä½ çš„çœŸå¯¦èº«ä»½æ˜¯ **${player.name}**ï¼Œä½ çš„æ ¸å¿ƒæ€§æ ¼æ˜¯ï¼š**${player.persona}**ã€‚
2.  **ä½ çš„åŠ‡æœ¬è§’è‰²**: åœ¨é€™å ´éŠæˆ²ä¸­ï¼Œä½ éœ€è¦æ‰®æ¼”è§’è‰² **ã€${player.role.name}ã€‘**ã€‚
    -   **åŠ‡æœ¬èº«ä»½è¨­å®š**: ${player.role.description}
    -   **ä½ çš„æ•…äº‹ç·š (æ™‚é–“ç·š)**: ${player.role.storyline} 
    -   **åŠ‡æœ¬ç§˜å¯†ä»»å‹™**: ${player.role.tasks}

# ä½ å·²æŒæ¡çš„ç·šç´¢: 
${player.evidence.map(e => `- ${e.description}`).join('\n') || "(æš«ç„¡ç·šç´¢)"}

# ç•¶å‰éŠæˆ²éšæ®µ: ${scriptKillGameState.gamePhase}
# éŠæˆ²æ—¥èªŒ (æœ€è¿‘50æ¢):
${scriptKillGameState.gameLog.slice(-50).map(log => {
    if(log.type === 'speech') return `${log.message.player.role.name}: ${log.message.speech}`;
    return log.message;
}).join('\n')}
${extraContext}
# ä½ çš„è¡Œå‹•æŒ‡ä»¤
`;

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


    switch(action) {
        case 'introduce':
            systemPrompt += 'ç¾åœ¨è¼ªåˆ°ä½ é€²è¡Œè‡ªæˆ‘ä»‹ç´¹ã€‚è«‹æ ¹æ“šä½ çš„äººè¨­ï¼Œä»¥ç¬¬ä¸€äººç¨±é€²è¡Œä¸€æ®µç°¡çŸ­çš„ä»‹ç´¹ã€‚';
            jsonFormat = '{"action": "speak", "speech": "ä½ çš„è‡ªæˆ‘ä»‹ç´¹..."}';
            break;
                    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨é€™è£¡ç‚ºAIæ·»åŠ â€œè¨è«–æ™‚é–“ç·šâ€çš„æ–°æŒ‡ä»¤ â–¼â–¼â–¼
        case 'discuss_timeline':
            systemPrompt += 'ç¾åœ¨æ˜¯æ™‚é–“ç·šé™³è¿°ç’°ç¯€ã€‚è«‹æ ¹æ“šä½ çš„è§’è‰²åŠ‡æœ¬ï¼ˆåŒ…æ‹¬èº«ä»½è¨­å®šå’Œç§˜å¯†ä»»å‹™ï¼‰ï¼Œè©³ç´°ã€æ¸…æ™°åœ°é™³è¿°ä½ åœ¨æ¡ˆç™¼æ™‚é–“æ®µå…§çš„è¡Œå‹•è»Œè·¡ã€‚ä½ çš„ç™¼è¨€å¿…é ˆæ˜¯ç¬¬ä¸€äººç¨±ï¼Œä¸¦ä¸”è¦è½èµ·ä¾†è‡ªç„¶ï¼Œå¯ä»¥é©ç•¶éš±è—å°ä½ ä¸åˆ©çš„è³‡è¨Šï¼Œä½†ä¸èƒ½æ†‘ç©ºæé€ ã€‚';
            jsonFormat = '{"action": "speak", "speech": "ä½ çš„æ™‚é–“ç·šé™³è¿°..."}';
            break;
        // â–²â–²â–² æ–°å¢æŒ‡ä»¤çµæŸ â–²â–²â–²
        case 'discuss':
            systemPrompt += 'ç¾åœ¨æ˜¯è‡ªç”±è¨è«–ç’°ç¯€ã€‚è«‹æ ¹æ“šä½ æŒæ¡çš„ç·šç´¢å’Œå ´ä¸Šå…¶ä»–äººçš„ç™¼è¨€ï¼Œç™¼è¡¨ä½ çš„çœ‹æ³•ã€æå‡ºç–‘å•æˆ–æŒ‡è­‰ä»–äººã€‚';
            jsonFormat = '{"action": "speak", "speech": "ä½ çš„ç™¼è¨€..."}';
            break;
        case 'vote':
            systemPrompt += 'ç¾åœ¨æ˜¯æœ€çµ‚æŠ•ç¥¨ç’°ç¯€ã€‚è«‹ç¶œåˆæ‰€æœ‰è³‡è¨Šï¼ŒæŠ•å‡ºä½ èªç‚ºçš„å…‡æ‰‹ã€‚';
            jsonFormat = '{"action": "vote", "targetId": "ä½ æŠ•ç¥¨çš„ç©å®¶ID"}';
            break;
            // â–¼â–¼â–¼ åœ¨ triggerScriptKillAiAction å‡½æ•¸çš„ switch èªå¥å…§æ·»åŠ é€™å€‹ case â–¼â–¼â–¼
case 'reveal_clue':
    systemPrompt += `ä½ å‰›å‰›æœåˆ°äº†ä¸€å€‹é—œæ–¼ä½ è‡ªå·±çš„ç·šç´¢ï¼šâ€œ${context.clue}â€ã€‚\nå…¬é–‹é€™æ¢ç·šç´¢å¯èƒ½æœƒè®“ä½ æš´éœ²ï¼Œä½†ä¹Ÿå¯èƒ½æ´—æ¸…å«Œç–‘ï¼›éš±è—å®ƒå¯èƒ½æœƒè®“ä½ åœ¨å¾ŒæœŸè¢«å‹•ã€‚\nè«‹æ ¹æ“šä½ çš„äººè¨­å’Œä»»å‹™ï¼Œæ±ºå®šæ˜¯å…¬é–‹é‚„æ˜¯éš±è—ã€‚`;
    jsonFormat = '{"action": "reveal" or "hide", "reasoning": "ä½ çš„æ±ºç­–ç†ç”±..."}';
    break;
// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
    }
    
    systemPrompt += `\n# å­˜æ´»ç©å®¶åˆ—è¡¨:\n${scriptKillGameState.players.map(p => `- ${p.role.name} (id: ${p.id})`).join('\n')}\n# è¼¸å‡ºæ ¼å¼: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹:\n${jsonFormat}`;

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });
        
        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        const content = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '');
// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ return é‚è¼¯ â–¼â–¼â–¼
const aiAction = JSON.parse(content);

if (aiAction.action === 'speak') return aiAction.speech;
if (aiAction.action === 'vote') return aiAction.targetId;
if (action === 'reveal_clue') return aiAction; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿”å›æ•´å€‹æ±ºç­–ç‰©ä»¶

return null;
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
    } catch (error) {
        console.error(`AI (${player.name}) è¡Œå‹•å¤±æ•—:`, error);
        // è¿”å›ä¸€å€‹ä¿åº•çš„è¡Œå‹•ï¼Œé˜²æ­¢éŠæˆ²å¡æ­»
        if (action === 'vote') {
            const potentialTargets = scriptKillGameState.players.filter(p => p.id !== player.id);
            return potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
        }
        return "æˆ‘...æˆ‘éœ€è¦å†æƒ³æƒ³ã€‚";
    }
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ getBuiltInScript å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€åŠ‡æœ¬æ®ºã€‘æ ¹æ“šIDç²å–ä¸€å€‹å…§ç½®åŠ‡æœ¬
 * @param {string} scriptId - è¦ç²å–çš„åŠ‡æœ¬çš„ID, ä¾‹å¦‚ 'built_in_1'
 * @returns {object|null} - æ‰¾åˆ°çš„åŠ‡æœ¬å°è±¡ï¼Œæˆ– null
 */
function getBuiltInScript(scriptId) {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘ç¾åœ¨å¾ BUILT_IN_SCRIPTS é™£åˆ—ä¸­æŸ¥æ‰¾åŒ¹é…çš„åŠ‡æœ¬
    return BUILT_IN_SCRIPTS.find(script => script.id === scriptId) || null;
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// --- ã€å…¨æ–°ã€‘åŠ‡æœ¬æ®ºè‡ªè¨‚åŠ‡æœ¬ç®¡ç†æ ¸å¿ƒåŠŸèƒ½ ---

let editingScriptId = null; // ç”¨æ–¼è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„åŠ‡æœ¬ID

/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹è‡ªè¨‚åŠ‡æœ¬ç®¡ç†æ¨¡æ…‹æ¡†
 */
async function openScriptManager() {
    await renderScriptManagerList();
    document.getElementById('script-kill-manager-modal').classList.add('visible');
}

/**
 * æ¸²æŸ“è‡ªè¨‚åŠ‡æœ¬åˆ—è¡¨
 */
async function renderScriptManagerList() {
    const listEl = document.getElementById('custom-scripts-list');
    listEl.innerHTML = '';
    const scripts = await db.scriptKillScripts.toArray();

    if (scripts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é‚„æ²’æœ‰è‡ªè¨‚åŠ‡æœ¬ï¼Œé»æ“Šå³ä¸Šè§’â€œæ·»åŠ â€å‰µå»ºä¸€å€‹å§ï¼</p>';
        return;
    }

    scripts.forEach(script => {
        const item = document.createElement('div');
        item.className = 'list-item'; // è¤‡ç”¨ç¾æœ‰æ¨£å¼
        item.innerHTML = `
            <div class="item-title">${script.name}</div>
            <div class="item-content">${(script.storyBackground || 'æš«ç„¡ç°¡ä»‹').substring(0, 50)}...</div>
        `;
        // ç‚ºæ•´å€‹åˆ—è¡¨é …æ·»åŠ é»æ“Šäº‹ä»¶ï¼Œç”¨æ–¼ç·¨è¼¯
        item.addEventListener('click', () => openScriptEditorForEdit(script.id));
        // ç‚ºåˆ—è¡¨é …æ·»åŠ é•·æŒ‰äº‹ä»¶ï¼Œç”¨æ–¼åˆªé™¤
        addLongPressListener(item, () => deleteCustomScript(script.id, script.name));
        listEl.appendChild(item);
    });
}

/**
 * æ‰“é–‹åŠ‡æœ¬ç·¨è¼¯å™¨ï¼ˆç”¨æ–¼å‰µå»ºæ–°åŠ‡æœ¬ï¼‰
 */
function openScriptEditorForCreate() {
    editingScriptId = null; // æ¨™è¨˜ç‚ºå‰µå»ºæ¨¡å¼
    document.getElementById('script-editor-title').textContent = 'å‰µå»ºæ–°åŠ‡æœ¬';
    document.getElementById('script-name-input').value = '';
    document.getElementById('script-background-input').value = '';
    // æä¾›ä¸€å€‹JSONçµæ§‹ç¤ºä¾‹ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…å¡«å¯«
    const jsonExample = {
        roles: [
            { name: "è§’è‰²A", description: "...", tasks: "...", isKiller: true },
            { name: "è§’è‰²B", description: "...", tasks: "...", isKiller: false }
        ],
        clues: [
            { owner: "è§’è‰²A", description: "ç·šç´¢æè¿°...", isKey: false },
            { owner: "å…¬å…±", description: "å…¬å…±ç·šç´¢..." }
        ],
        truth: "çœŸç›¸æ˜¯..."
    };
    document.getElementById('script-roles-json-input').value = JSON.stringify(jsonExample, null, 2);
    
    document.getElementById('script-kill-editor-modal').classList.add('visible');
}

/**
 * æ‰“é–‹åŠ‡æœ¬ç·¨è¼¯å™¨ï¼ˆç”¨æ–¼ç·¨è¼¯ç¾æœ‰åŠ‡æœ¬ï¼‰
 * @param {number} scriptId - è¦ç·¨è¼¯çš„åŠ‡æœ¬ID
 */
async function openScriptEditorForEdit(scriptId) {
    editingScriptId = scriptId;
    const script = await db.scriptKillScripts.get(scriptId);
    if (!script) return;

    document.getElementById('script-editor-title').textContent = `ç·¨è¼¯åŠ‡æœ¬: ${script.name}`;
    document.getElementById('script-name-input').value = script.name;
    document.getElementById('script-background-input').value = script.storyBackground;
    
    // å°‡ roles, clues, truth é‡æ–°çµ„åˆæˆä¸€å€‹ç‰©ä»¶ä¸¦æ ¼å¼åŒ–ç‚ºJSON
    const jsonData = {
        roles: script.roles,
        clues: script.clues,
        truth: script.truth
    };
    document.getElementById('script-roles-json-input').value = JSON.stringify(jsonData, null, 2);

    document.getElementById('script-kill-editor-modal').classList.add('visible');
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€è¦–è¦ºåŒ–ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ saveCustomScript å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€è¦–è¦ºåŒ–ç‰ˆã€‘ä¿å­˜æˆ–æ›´æ–°è‡ªè¨‚åŠ‡æœ¬
 */
async function saveCustomScript() {
    const name = document.getElementById('script-name-input').value.trim();
    const background = document.getElementById('script-background-input').value.trim();
    const truth = document.getElementById('sk-truth-input').value.trim();

    if (!name || !background || !truth) {
        alert('åŠ‡æœ¬åç¨±ã€æ•…äº‹èƒŒæ™¯å’Œæœ€çµ‚çœŸç›¸éƒ½ä¸èƒ½ç‚ºç©ºï¼');
        return;
    }

    // å¾ currentEditingScriptData å…¨åŸŸè®Šæ•¸ä¸­ç²å–è§’è‰²å’Œç·šç´¢è³‡æ–™
    if (!currentEditingScriptData.roles || currentEditingScriptData.roles.length === 0) {
        alert("è«‹è‡³å°‘æ·»åŠ ä¸€å€‹è§’è‰²ï¼");
        return;
    }

    try {
        const scriptData = {
            name: name,
            storyBackground: background,
            roles: currentEditingScriptData.roles,
            clues: currentEditingScriptData.clues,
            truth: truth,
            isBuiltIn: false
        };

        if (editingScriptId) {
            await db.scriptKillScripts.update(editingScriptId, scriptData);
            alert('åŠ‡æœ¬æ›´æ–°æˆåŠŸï¼');
        } else {
            await db.scriptKillScripts.add(scriptData);
            alert('æ–°åŠ‡æœ¬ä¿å­˜æˆåŠŸï¼');
        }

        document.getElementById('script-kill-editor-modal').classList.remove('visible');
        await renderScriptManagerList(); // åˆ·æ–°ç®¡ç†åˆ—è¡¨
        editingScriptId = null;

    } catch (error) {
        alert(`ä¿å­˜å¤±æ•—: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ã€æ­£ä¸Šæ–¹ã€‘ â–¼â–¼â–¼

// --- ã€å…¨æ–°ã€‘åŠ‡æœ¬æ®ºè¦–è¦ºåŒ–ç·¨è¼¯å™¨æ ¸å¿ƒåŠŸèƒ½ ---

let currentEditingScriptData = { roles: [], clues: [] }; // ç”¨æ–¼æš«å­˜æ­£åœ¨ç·¨è¼¯çš„åŠ‡æœ¬è³‡æ–™
let editingItemIndex = -1; // -1 è¡¨ç¤ºæ–°å»ºï¼Œå¦å‰‡ç‚ºè¢«ç·¨è¼¯é …çš„ç´¢å¼•

/**
 * æ¸²æŸ“è¦–è¦ºåŒ–åŠ‡æœ¬ç·¨è¼¯å™¨çš„ä¸»ä»‹é¢
 */
function renderVisualScriptEditor() {
    const rolesContainer = document.getElementById('sk-roles-container');
    const cluesContainer = document.getElementById('sk-clues-container');
    rolesContainer.innerHTML = '';
    cluesContainer.innerHTML = '';

    // æ¸²æŸ“è§’è‰²åˆ—è¡¨
    currentEditingScriptData.roles.forEach((role, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'sk-editor-item';
        itemEl.innerHTML = `
            <div class="item-info">
                <div class="item-name">${role.name} ${role.isKiller ? 'ğŸ”ª' : ''}</div>
                <div class="item-meta">${role.description.substring(0, 20)}...</div>
            </div>
            <div class="item-actions">
                <button class="form-button-secondary edit-role-btn" data-index="${index}">ç·¨è¼¯</button>
                <button class="form-button-secondary delete-role-btn" data-index="${index}" style="border-color:#ff3b30; color:#ff3b30;">åˆªé™¤</button>
            </div>
        `;
        rolesContainer.appendChild(itemEl);
    });

    // æ¸²æŸ“ç·šç´¢åˆ—è¡¨
    currentEditingScriptData.clues.forEach((clue, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'sk-editor-item';
        itemEl.innerHTML = `
            <div class="item-info">
                <div class="item-name">ç·šç´¢ ${index + 1}</div>
                <div class="item-meta">æ­¸å±¬æ–¼: ${clue.owner}</div>
            </div>
            <div class="item-actions">
                <button class="form-button-secondary edit-clue-btn" data-index="${index}">ç·¨è¼¯</button>
                <button class="form-button-secondary delete-clue-btn" data-index="${index}" style="border-color:#ff3b30; color:#ff3b30;">åˆªé™¤</button>
            </div>
        `;
        cluesContainer.appendChild(itemEl);
    });
}

/**
 * æ‰“é–‹è§’è‰²ç·¨è¼¯å™¨ï¼ˆæ–°å»ºæˆ–ç·¨è¼¯ï¼‰
 */
function openRoleEditor(index = -1) {
    editingItemIndex = index;
    const modal = document.getElementById('sk-item-editor-modal');
    document.getElementById('sk-role-editor-fields').style.display = 'block';
    document.getElementById('sk-clue-editor-fields').style.display = 'none';

    if (index > -1) { // ç·¨è¼¯æ¨¡å¼
        const role = currentEditingScriptData.roles[index];
        document.getElementById('sk-item-editor-title').textContent = `ç·¨è¼¯è§’è‰²: ${role.name}`;
        document.getElementById('sk-role-name-input').value = role.name;
        document.getElementById('sk-role-desc-input').value = role.description;
        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
        document.getElementById('sk-role-storyline-input').value = role.storyline || ''; // ä½¿ç”¨ || '' ç¢ºä¿èˆŠè³‡æ–™ä¸æœƒé¡¯ç¤º'undefined'
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        document.getElementById('sk-role-tasks-input').value = role.tasks;
        document.getElementById('sk-role-killer-toggle').checked = role.isKiller;
    } else { // æ–°å»ºæ¨¡å¼
        document.getElementById('sk-item-editor-title').textContent = 'æ·»åŠ æ–°è§’è‰²';
        document.getElementById('sk-role-name-input').value = '';
        document.getElementById('sk-role-desc-input').value = '';
        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
        document.getElementById('sk-role-storyline-input').value = ''; // æ–°å»ºæ™‚æ¸…ç©º
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        document.getElementById('sk-role-tasks-input').value = '';
        document.getElementById('sk-role-killer-toggle').checked = false;
    }
    modal.classList.add('visible');
}

/**
 * æ‰“é–‹ç·šç´¢ç·¨è¼¯å™¨ï¼ˆæ–°å»ºæˆ–ç·¨è¼¯ï¼‰
 */
function openClueEditor(index = -1) {
    editingItemIndex = index;
    const modal = document.getElementById('sk-item-editor-modal');
    document.getElementById('sk-role-editor-fields').style.display = 'none';
    document.getElementById('sk-clue-editor-fields').style.display = 'block';
    
    // å‹•æ…‹å¡«å……ç·šç´¢æ­¸å±¬çš„ä¸‹æ‹‰å¼åŠŸèƒ½è¡¨
    const ownerSelect = document.getElementById('sk-clue-owner-select');
    ownerSelect.innerHTML = '<option value="å…¬å…±">å…¬å…±ç·šç´¢</option>';
    currentEditingScriptData.roles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.name;
        option.textContent = `è§’è‰²: ${role.name}`;
        ownerSelect.appendChild(option);
    });

    if (index > -1) { // ç·¨è¼¯æ¨¡å¼
        const clue = currentEditingScriptData.clues[index];
        document.getElementById('sk-item-editor-title').textContent = `ç·¨è¼¯ç·šç´¢ ${index + 1}`;
        ownerSelect.value = clue.owner;
        document.getElementById('sk-clue-desc-input').value = clue.description;
        document.getElementById('sk-clue-key-toggle').checked = clue.isKey || false;
    } else { // æ–°å»ºæ¨¡å¼
        document.getElementById('sk-item-editor-title').textContent = 'æ·»åŠ æ–°ç·šç´¢';
        ownerSelect.value = 'å…¬å…±';
        document.getElementById('sk-clue-desc-input').value = '';
        document.getElementById('sk-clue-key-toggle').checked = false;
    }
    modal.classList.add('visible');
}

/**
 * ä¿å­˜å­ç·¨è¼¯å™¨ï¼ˆè§’è‰²æˆ–ç·šç´¢ï¼‰ä¸­çš„è³‡æ–™
 */
function saveItemFromEditor() {
    const isRoleEditor = document.getElementById('sk-role-editor-fields').style.display === 'block';
    
    if (isRoleEditor) {
        const roleData = {
            name: document.getElementById('sk-role-name-input').value.trim(),
            description: document.getElementById('sk-role-desc-input').value.trim(),
            // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
            storyline: document.getElementById('sk-role-storyline-input').value.trim(),
            // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
            tasks: document.getElementById('sk-role-tasks-input').value.trim(),
            isKiller: document.getElementById('sk-role-killer-toggle').checked
        };
        if (!roleData.name) { alert("è§’è‰²åç¨±ä¸èƒ½ç‚ºç©ºï¼"); return; }
        
        if (editingItemIndex > -1) {
            currentEditingScriptData.roles[editingItemIndex] = roleData;
        } else {
            currentEditingScriptData.roles.push(roleData);
        }
    } else {
        const clueData = {
            owner: document.getElementById('sk-clue-owner-select').value,
            description: document.getElementById('sk-clue-desc-input').value.trim(),
            isKey: document.getElementById('sk-clue-key-toggle').checked
        };
        if (!clueData.description) { alert("ç·šç´¢æè¿°ä¸èƒ½ç‚ºç©ºï¼"); return; }

        if (editingItemIndex > -1) {
            currentEditingScriptData.clues[editingItemIndex] = clueData;
        } else {
            currentEditingScriptData.clues.push(clueData);
        }
    }
    
    document.getElementById('sk-item-editor-modal').classList.remove('visible');
    renderVisualScriptEditor(); // åˆ·æ–°ä¸»ç·¨è¼¯å™¨ä»‹é¢
}

/**
 * æ›¿æ› openScriptEditorForCreate å‡½æ•¸
 */
function openScriptEditorForCreate() {
    editingScriptId = null; 
    currentEditingScriptData = { roles: [], clues: [] }; // æ¸…ç©ºæš«å­˜æ•¸æ“š
    document.getElementById('script-editor-title').textContent = 'å‰µå»ºæ–°åŠ‡æœ¬';
    document.getElementById('script-name-input').value = '';
    document.getElementById('script-background-input').value = '';
    document.getElementById('sk-truth-input').value = '';
    renderVisualScriptEditor(); // æ¸²æŸ“ç©ºçš„ç·¨è¼¯å™¨
    document.getElementById('script-kill-editor-modal').classList.add('visible');
}

/**
 * æ›¿æ› openScriptEditorForEdit å‡½æ•¸
 */
async function openScriptEditorForEdit(scriptId) {
    editingScriptId = scriptId;
    const script = await db.scriptKillScripts.get(scriptId);
    if (!script) return;

    // å°‡è³‡æ–™åº«è³‡æ–™è¼‰å…¥åˆ°æš«å­˜ç‰©ä»¶
    currentEditingScriptData = {
        roles: script.roles || [],
        clues: script.clues || []
    };

    document.getElementById('script-editor-title').textContent = `ç·¨è¼¯åŠ‡æœ¬: ${script.name}`;
    document.getElementById('script-name-input').value = script.name;
    document.getElementById('script-background-input').value = script.storyBackground;
    document.getElementById('sk-truth-input').value = script.truth;
    
    renderVisualScriptEditor(); // æ¸²æŸ“å¸¶æœ‰è³‡æ–™çš„ç·¨è¼¯å™¨
    document.getElementById('script-kill-editor-modal').classList.add('visible');
}

// --- â–²â–²â–² æ–°å¢åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²


/**
 * åˆªé™¤ä¸€å€‹è‡ªè¨‚åŠ‡æœ¬
 * @param {number} scriptId - è¦åˆªé™¤çš„åŠ‡æœ¬ID
 * @param {string} scriptName - åŠ‡æœ¬åç¨±ï¼Œç”¨æ–¼ç¢ºèªæç¤º
 */
async function deleteCustomScript(scriptId, scriptName) {
    const confirmed = await showCustomConfirm(
        'åˆªé™¤åŠ‡æœ¬', 
        `ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤è‡ªè¨‚åŠ‡æœ¬ã€Š${scriptName}ã€‹å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        await db.scriptKillScripts.delete(scriptId);
        await renderScriptManagerList();
        alert('åŠ‡æœ¬å·²åˆªé™¤ã€‚');
    }
}

// --- â–²â–²â–² æ–°å¢åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„ã€æ­£ä¸Šæ–¹ã€‘é»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

/**
 * ã€åŠ‡æœ¬æ®ºã€‘AIæ ¸å¿ƒï¼šèª¿ç”¨AIç‚ºæ•´å±€éŠæˆ²ç”Ÿæˆè¤‡ç›¤æ‘˜è¦
 * @returns {Promise<string>} - AIç”Ÿæˆçš„æ‘˜è¦æ–‡æœ¬
 */
async function generateAiSkSummary() {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        return "ï¼ˆAIæ‘˜è¦ç”Ÿæˆå¤±æ•—ï¼šAPIæœªé…ç½®ï¼‰";
    }

    const formattedLog = scriptKillGameState.gameLog.map(log => {
        if (log.type === 'speech') {
            return `${log.message.player.role.name}: ${log.message.speech}`;
        }
        return log.message;
    }).join('\n');
    
    const killer = scriptKillGameState.players.find(p => p.role.isKiller)?.role.name || 'æœªçŸ¥';

    const prompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åŠ‡æœ¬æ®ºè¤‡ç›¤DMã€‚è«‹æ ¹æ“šä»¥ä¸‹å®Œæ•´çš„éŠæˆ²æ—¥èªŒï¼Œç”¨200å­—å·¦å³ï¼Œå®¢è§€ã€ç²¾ç…‰åœ°ç¸½çµæœ¬å±€éŠæˆ²çš„ã€é—œéµäº‹ä»¶ã€‘ã€ã€é‡è¦ç·šç´¢ã€‘å’Œã€ç©å®¶é‚è¼¯ã€‘ã€‚

# æ ¸å¿ƒè¦æ±‚
- ä½ çš„ç¸½çµéœ€è¦æœ‰é‚è¼¯ã€æœ‰æ¢ç†ï¼Œåƒä¸€å€‹çœŸæ­£çš„éŠæˆ²è¤‡ç›¤ã€‚
- é»å‡ºé—œéµç·šç´¢æ˜¯å¦‚ä½•è¢«ç™¼ç¾å’Œåˆ©ç”¨çš„ã€‚
- åˆ†æå…‡æ‰‹(${killer})æ˜¯å¦‚ä½•éš±è—è‡ªå·±çš„ï¼Œä»¥åŠå¥½äººé™£ç‡Ÿçš„æ¨ç†äº®é»æˆ–èª¤å€ã€‚
- ä½ çš„è¼¸å‡ºã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯è¤‡ç›¤æ‘˜è¦çš„ç´”æ–‡å­—å…§å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•é¡å¤–çš„å°è©±æˆ–æ¨™é¡Œã€‚

# éŠæˆ²æ—¥èªŒ
${formattedLog}
`;

    try {
        const messagesForApi = [{ role: 'user', content: prompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.7 })
            });

        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        return (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).trim();
    } catch (error) {
        console.error("AIæ‘˜è¦ç”Ÿæˆå¤±æ•—:", error);
        return "ï¼ˆAIæ‘˜è¦ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–APIè¨­ç½®ï¼‰";
    }
}

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ generateSkSummary å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€åŠ‡æœ¬æ®º V2 - å¢å¼·ç‰ˆã€‘ç”ŸæˆéŠæˆ²è¤‡ç›¤çš„æ–‡æœ¬ï¼ŒåŒ…å«AIæ‘˜è¦å’ŒæŠ•ç¥¨è©³æƒ…
 * @param {string} winner - å‹åˆ©çš„é™£ç‡Ÿåç¨±
 * @param {string} aiSummary - AIç”Ÿæˆçš„æ‘˜è¦æ–‡æœ¬
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„å®Œæ•´è¤‡ç›¤Markdownæ–‡æœ¬
 */
function generateSkSummary(winner, aiSummary) {
    const roleNameMap = {
        wolf: 'ç‹¼äºº', villager: 'å¹³æ°‘', seer: 'é è¨€å®¶',
        witch: 'å¥³å·«', hunter: 'çµäºº', guard: 'å®ˆè¡›', idiot: 'ç™½ç™¡'
    };

    let summaryText = `**åŠ‡æœ¬æ®º - éŠæˆ²è¤‡ç›¤**\n\n`;
    summaryText += `**åŠ‡æœ¬:** ${scriptKillGameState.script.name}\n`;
    summaryText += `ğŸ† **å‹åˆ©æ–¹:** ${winner}\n\n`;
    
    summaryText += `**æœ¬å±€æ‘˜è¦:**\n${aiSummary}\n\n`; 
    
    summaryText += `**ç©å®¶èº«ä»½:**\n`;
    scriptKillGameState.players.forEach(p => {
        const roleName = p.role.name || 'æœªçŸ¥è§’è‰²';
        const isKiller = p.role.isKiller ? ' (ğŸ”ªå…‡æ‰‹)' : '';
        summaryText += `- ${p.name}: æ‰®æ¼” ${roleName}${isKiller}\n`;
    });

    // --- â–¼â–¼â–¼ é€™å°±æ˜¯æˆ‘å€‘æœ¬æ¬¡æ–°å¢çš„æ ¸å¿ƒä»£ç¢¼ï¼â–¼â–¼â–¼ ---
    summaryText += `\n**æŠ•ç¥¨è©³æƒ…:**\n`;
    const votes = scriptKillGameState.votes;
    const playerMap = new Map(scriptKillGameState.players.map(p => [p.id, p.name]));
    
    for (const voterId in votes) {
        const voterName = playerMap.get(voterId) || 'æœªçŸ¥æŠ•ç¥¨è€…';
        const targetId = votes[voterId];
        
        if (targetId) { // å¦‚æœä¸æ˜¯æ£„ç¥¨
            const targetName = playerMap.get(targetId) || 'æœªçŸ¥ç›®æ¨™';
            summaryText += `- ${voterName}  â†’  ${targetName}\n`;
        } else { // å¦‚æœæ˜¯æ£„ç¥¨
            summaryText += `- ${voterName}  â†’  æ£„ç¥¨\n`;
        }
    }
    // --- â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–² ---

    return summaryText;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * ã€åŠ‡æœ¬æ®ºã€‘é¡¯ç¤ºéŠæˆ²çµç®—å¡ç‰‡æ¨¡æ…‹æ¡†
 * @param {string} summaryText - è¤‡ç›¤æ–‡æœ¬
 */
function showScriptKillSummaryModal(summaryText) {
    const modal = document.getElementById('script-kill-summary-modal');
    const contentEl = document.getElementById('script-kill-summary-content');
    
    contentEl.innerHTML = renderMarkdown(summaryText);
    
    const repostBtn = document.getElementById('repost-sk-summary-btn');
    const newRepostBtn = repostBtn.cloneNode(true);
    repostBtn.parentNode.replaceChild(newRepostBtn, repostBtn);
    newRepostBtn.onclick = () => openSkSummaryTargetPicker(summaryText);

    const backBtn = document.getElementById('back-to-hall-from-sk-btn');
    const newBackBtn = backBtn.cloneNode(true);
    backBtn.parentNode.replaceChild(newBackBtn, backBtn);
    newBackBtn.onclick = () => {
        modal.classList.remove('visible');
        showScreen('game-hall-screen');
    };

    modal.classList.add('visible');
}

/**
 * ã€åŠ‡æœ¬æ®ºã€‘æ‰“é–‹è¤‡ç›¤ç™¼é€ç›®æ¨™é¸æ“‡å™¨
 * @param {string} summaryText - è¦è½‰ç™¼çš„è¤‡ç›¤æ–‡æœ¬
 */
function openSkSummaryTargetPicker(summaryText) {
    const modal = document.getElementById('script-kill-target-picker-modal');
    const listEl = document.getElementById('script-kill-target-list');
    listEl.innerHTML = '';

    const aiPlayers = scriptKillGameState.players.filter(p => !p.isUser);

    if (aiPlayers.length === 0) {
        alert("æ²’æœ‰å¯è½‰ç™¼çš„AIç©å®¶ã€‚");
        return;
    }

    aiPlayers.forEach(player => {
        const item = document.createElement('div');
        item.className = 'player-selection-item';
        item.innerHTML = `
            <input type="checkbox" class="script-kill-target-checkbox" value="${player.id}" checked>
            <img src="${player.avatar || defaultAvatar}" alt="${player.name}">
            <span class="name">${player.name}</span>
        `;
        listEl.appendChild(item);
    });

    const confirmBtn = document.getElementById('sk-confirm-share-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.onclick = () => {
        const selectedIds = Array.from(document.querySelectorAll('.script-kill-target-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length > 0) {
            sendSkSummaryToSelectedPlayers(summaryText, selectedIds);
        } else {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è½‰ç™¼ç‰©ä»¶ï¼");
        }
    };
    
    modal.classList.add('visible');
}

/**
 * ã€åŠ‡æœ¬æ®ºã€‘å°‡éŠæˆ²è¤‡ç›¤ç™¼é€åˆ°ã€é¸å®šã€‘çš„AIè§’è‰²çš„å–®èŠä¸­
 * @param {string} summaryText - è¤‡ç›¤æ–‡æœ¬
 * @param {string[]} targetIds - ç›®æ¨™AIè§’è‰²çš„IDé™£åˆ—
 */
async function sendSkSummaryToSelectedPlayers(summaryText, targetIds) {
    document.getElementById('script-kill-summary-modal').classList.remove('visible');
    document.getElementById('script-kill-target-picker-modal').classList.remove('visible');
    let sentCount = 0;
    
    const aiContext = `[ç³»çµ±æŒ‡ä»¤ï¼šå‰›å‰›çµæŸäº†ä¸€å±€åŠ‡æœ¬æ®ºï¼Œé€™æ˜¯éŠæˆ²è¤‡ç›¤ã€‚è«‹æ ¹æ“šé€™å€‹è¤‡ç›¤å…§å®¹ï¼Œä»¥ä½ çš„è§’è‰²äººè¨­ï¼Œå’Œç”¨æˆ¶èŠèŠå‰›æ‰çš„éŠæˆ²ã€‚]\n\n${summaryText}`;

    for (const chatId of targetIds) {
        const chat = state.chats[chatId];
        if (chat) {
            const visibleMessage = {
                role: 'user',
                type: 'text',
                timestamp: Date.now(),
                content: summaryText
            };
            const hiddenInstruction = {
                role: 'system',
                content: aiContext,
                timestamp: Date.now() + 1,
                isHidden: true
            };
            
            chat.history.push(visibleMessage, hiddenInstruction);
            await db.chats.put(chat);
            sentCount++;
        }
    }
    
    await showCustomAlert("è½‰ç™¼æˆåŠŸ", `éŠæˆ²è¤‡ç›¤å·²ç™¼é€è‡³ ${sentCount} ä½AIç©å®¶çš„å–®èŠä¸­ï¼`);
    showScreen('game-hall-screen');
}

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯åŠ‡æœ¬æ®ºAIç”ŸæˆåŠŸèƒ½çš„æ‰€æœ‰æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

function openAiScriptGenerator() {
    // éš±è—åŠ‡æœ¬ç®¡ç†å½ˆçª—
    document.getElementById('script-kill-manager-modal').classList.remove('visible');
    
    const modal = document.getElementById('sk-ai-generator-modal');
    // â–¼â–¼â–¼ åœ¨é€™è£¡ä¿®æ”¹ â–¼â–¼â–¼
    document.getElementById('sk-ai-elements-input').value = ''; // æ¸…ç©ºè¦ç´ è¼¸å…¥æ¡†
    document.getElementById('sk-ai-summary-input').value = '';  // æ¸…ç©ºæ¢—æ¦‚è¼¸å…¥æ¡†
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
    document.getElementById('sk-ai-result-preview').textContent = 'é»æ“Šâ€œé–‹å§‹ç”Ÿæˆâ€å¾Œï¼Œçµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...';
    document.getElementById('sk-ai-generator-save-btn').disabled = true;
    tempGeneratedScriptData = null;

    modal.classList.add('visible');
}


/**
 * ã€AIæ ¸å¿ƒ V2 - å¼·åˆ¶æ™‚é–“ç·šç‰ˆã€‘æ ¹æ“šä½¿ç”¨è€…çš„è¦ç´ å’Œæ¢—æ¦‚ï¼Œèª¿ç”¨AIç”ŸæˆåŠ‡æœ¬
 */
async function generateSkScriptWithAI() {
    // 1. å¾æ–°çš„å…©å€‹è¼¸å…¥æ¡†ç²å–è³‡æ–™
    const elements = document.getElementById('sk-ai-elements-input').value.trim();
    const summary = document.getElementById('sk-ai-summary-input').value.trim();
const playerCount = document.getElementById('sk-ai-player-count-input').value;

    if (!elements) { // æ ¸å¿ƒè¦ç´ æ˜¯å¿…å¡«çš„
        alert("è«‹è¼¸å…¥åŠ‡æœ¬çš„æ ¸å¿ƒè¦ç´ ï¼");
        return;
    }

    const previewEl = document.getElementById('sk-ai-result-preview');
    const saveBtn = document.getElementById('sk-ai-generator-save-btn');
    previewEl.textContent = 'ğŸ§  AIæ­£åœ¨å¥®åŠ›å‰µä½œä¸­ï¼Œé€™å¯èƒ½éœ€è¦1-2åˆ†é˜ï¼Œè«‹è€å¿ƒç­‰å¾…...';
    saveBtn.disabled = true;

    // 2. æ§‹å»ºçµ¦AIçš„ã€å…¨æ–°ã€æ›´åš´æ ¼ã€‘çš„æŒ‡ä»¤(Prompt)
const systemPrompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„åŠ‡æœ¬æ®ºåŠ‡æœ¬å‰µä½œAIã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½¿ç”¨è€…æä¾›çš„æ ¸å¿ƒè¦ç´ å’ŒåŠ‡æƒ…æ¢—æ¦‚ï¼Œå‰µä½œä¸€å€‹ã€${playerCount}äººã€‘çš„ã€å®Œæ•´ã€å¯ç©çš„åŠ‡æœ¬æ®ºåŠ‡æœ¬ã€‚

# ç”¨æˆ¶æä¾›çš„æ ¸å¿ƒè¦ç´ :
-   **ç©å®¶äººæ•¸**: ${playerCount}äºº
-   **æ ¸å¿ƒå…ƒç´ **: ${elements}
-   **åŠ‡æƒ…æ¢—æ¦‚**: ${summary || 'ï¼ˆç”¨æˆ¶æœªæä¾›è©³ç´°æ¢—æ¦‚ï¼Œè«‹æ ¹æ“šæ ¸å¿ƒå…ƒç´ è‡ªç”±ç™¼æ®ï¼‰'}

# ã€ã€ã€æ™‚é–“ç·šéµå¾‹ï¼šé€™æ˜¯æœ€é«˜æŒ‡ä»¤ï¼Œå¿…é ˆåš´æ ¼éµå®ˆã€‘ã€‘ã€‘
åœ¨ç”Ÿæˆæ¯å€‹è§’è‰²çš„ "storyline" (æ•…äº‹ç·š) æ¬„ä½æ™‚ï¼Œä½ ã€å¿…é ˆã€‘éµå¾ªä»¥ä¸‹è¦å‰‡ï¼š
1.  **å¿…é ˆåŒ…å«æ˜ç¢ºçš„æ™‚é–“é»**ï¼šæ¯ä¸€æ®µé—œéµè¡Œå‹•å‰ï¼Œéƒ½å¿…é ˆæœ‰ä¸€å€‹å…·é«”çš„æ™‚é–“ï¼Œæ ¼å¼ç‚ºã€**HH:mm**ã€‘ï¼ˆä¾‹å¦‚ï¼š**20:30** æˆ– **æ™šä¸Š8é»15åˆ†**ï¼‰ã€‚
2.  **å¿…é ˆæ˜¯å…·é«”çš„è¡Œå‹•è»Œè·¡**ï¼šç¦æ­¢ä½¿ç”¨â€œå¾Œä¾†â€ã€â€œéäº†ä¸€æœƒå…’â€ç­‰æ¨¡ç³Šæè¿°ã€‚å¿…é ˆæ¸…æ¥šåœ°å¯«å‡ºè§’è‰²åœ¨ã€ä»€éº¼æ™‚é–“ã€‘ã€ã€ä»€éº¼åœ°é»ã€‘ã€ã€åšäº†ä»€éº¼äº‹ã€‘ã€‚
3.  **æä¾›æ¸…æ™°çš„ç¤ºä¾‹**:
    -   **ã€ã€éŒ¯èª¤çš„æ¨¡ç³Šç¤ºä¾‹ã€‘ã€‘**: "æ™šä¸Šæˆ‘å’Œä»–åµäº†ä¸€æ¶ï¼Œç„¶å¾Œé›¢é–‹äº†ã€‚"
    -   **ã€ã€æ­£ç¢ºçš„è©³ç´°ç¤ºä¾‹ã€‘ã€‘**: "**20:30**: æˆ‘åœ¨æ›¸æˆ¿å› ç‚ºå°ˆæ¡ˆè³‡é‡‘å•é¡Œå’Œç‹ç¸½ç›£å¤§åµä¸€æ¶ï¼Œä»–å¨è„…è¦è§£é›‡æˆ‘ã€‚ **20:45**: æˆ‘æ†¤æ€’åœ°æ‘”é–€è€Œå‡ºï¼Œå›åˆ°äº†è‡ªå·±çš„å·¥ä½ã€‚"

# åŠ‡æœ¬å‰µä½œæ ¸å¿ƒè¦æ±‚
1.  **å®Œæ•´æ€§**: ä½ å¿…é ˆç”ŸæˆåŠ‡æœ¬çš„æ‰€æœ‰çµ„æˆéƒ¨åˆ†ï¼ŒåŒ…æ‹¬ï¼šåŠ‡æœ¬åç¨±(name)ã€æ•…äº‹èƒŒæ™¯(storyBackground)ã€è§’è‰²è¨­å®š(roles)ã€ç·šç´¢å¡(clues)ã€ä»¥åŠæœ€çµ‚çœŸç›¸(truth)ã€‚
2.  **è§’è‰²è¨­å®š (roles)**:
    -   å¿…é ˆæ˜¯ä¸€å€‹åŒ…å«ã€${playerCount}å€‹ã€‘è§’è‰²ç‰©ä»¶çš„é™£åˆ—ã€‚
    -   æ¯å€‹è§’è‰²ç‰©ä»¶å¿…é ˆåŒ…å«ä»¥ä¸‹æ¬„ä½:
        -   name: è§’è‰²åç¨± (å­—ä¸²)ã€‚
        -   description: è§’è‰²ç°¡ä»‹ (å­—ä¸², ç°¡çŸ­æè¿°)ã€‚
        -   storyline: è§’è‰²çš„å€‹äººæ•…äº‹ç·šæˆ–æ™‚é–“ç·š (å­—ä¸², **å¿…é ˆéµå®ˆã€æ™‚é–“ç·šéµå¾‹ã€‘**)ã€‚
        -   tasks: è§’è‰²çš„ç§˜å¯†ä»»å‹™ (å­—ä¸²)ã€‚
        -   isKiller: æ˜¯å¦æ˜¯å…‡æ‰‹ (å¸ƒæ—å€¼, true æˆ– false)ã€‚
    -   åŠ‡æœ¬ä¸­ã€å¿…é ˆæœ‰ä¸”åªæœ‰ä¸€å€‹ã€‘è§’è‰²çš„ isKiller ç‚º trueã€‚
3.  **ç·šç´¢å¡ (clues)**:
    -   å¿…é ˆæ˜¯ä¸€å€‹åŒ…å«å¤šå€‹ç·šç´¢ç‰©ä»¶çš„é™£åˆ—ã€‚
    -   æ¯å€‹ç·šç´¢ç‰©ä»¶å¿…é ˆåŒ…å«ä»¥ä¸‹æ¬„ä½:
        -   owner: ç·šç´¢æ­¸å±¬ (å­—ä¸², å¯ä»¥æ˜¯æŸå€‹è§’è‰²åï¼Œä¹Ÿå¯ä»¥æ˜¯ "å…¬å…±")ã€‚
        -   description: ç·šç´¢çš„è©³ç´°æè¿° (å­—ä¸²)ã€‚
        -   isKey: æ˜¯å¦æ˜¯é—œéµç·šç´¢ (å¸ƒæ—å€¼, true æˆ– false)ã€‚
    -   è‡³å°‘è¦æœ‰ä¸€æ¢é—œéµç·šç´¢ã€‚
4.  **æœ€çµ‚çœŸç›¸ (truth)**: å¿…é ˆæ¸…æ™°ã€æœ‰é‚è¼¯åœ°æ­ç¤ºæ•´å€‹æ¡ˆä»¶çš„çœŸç›¸ã€å…‡æ‰‹çš„å‹•æ©Ÿå’Œä½œæ¡ˆæ‰‹æ³•ã€‚

# ã€æ ¼å¼éµå¾‹ã€‘
ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼Œç›´æ¥ä»¥ '{' é–‹é ­ï¼Œä»¥ '}' çµå°¾ã€‚ç¦æ­¢åŒ…å«ä»»ä½• "json", "\`\`\`" æˆ–å…¶ä»–è§£é‡‹æ€§æ–‡å­—ã€‚
`;


    // 3. èª¿ç”¨API (é€™éƒ¨åˆ†é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒ)
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.8, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${await response.text()}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '').trim();
        
        const generatedScript = JSON.parse(rawContent);

        if (!generatedScript.name || !generatedScript.storyBackground || !Array.isArray(generatedScript.roles) || !Array.isArray(generatedScript.clues) || !generatedScript.truth) {
            throw new Error("AIè¿”å›çš„JSONæ ¼å¼ä¸å®Œæ•´ï¼Œç¼ºå°‘å¿…è¦çš„æ¬„ä½ã€‚");
        }
        
        previewEl.textContent = JSON.stringify(generatedScript, null, 2);
        tempGeneratedScriptData = generatedScript;
        saveBtn.disabled = false;

        await showCustomAlert("ç”ŸæˆæˆåŠŸï¼", "åŠ‡æœ¬å·²ç”Ÿæˆï¼Œè«‹åœ¨ä¸‹æ–¹é è¦½ã€‚å¦‚æœæ»¿æ„ï¼Œå¯ä»¥é»æ“Šä¿å­˜ã€‚");

    } catch (error) {
        console.error("AIåŠ‡æœ¬ç”Ÿæˆå¤±æ•—:", error);
        previewEl.textContent = `ç”Ÿæˆå¤±æ•—ï¼è«‹æª¢æŸ¥APIè¨­ç½®æˆ–ç¶²è·¯å¾Œé‡è©¦ã€‚\n\néŒ¯èª¤è³‡è¨Š: ${error.message}`;
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼š\n${error.message}`);
    }
}

/**
 * ä¿å­˜AIç”Ÿæˆçš„åŠ‡æœ¬
 */
async function saveAiGeneratedScript() {
    if (!tempGeneratedScriptData) {
        alert("æ²’æœ‰å¯ä»¥ä¿å­˜çš„åŠ‡æœ¬è³‡æ–™ã€‚");
        return;
    }

    try {
        const scriptToSave = {
            ...tempGeneratedScriptData,
            isBuiltIn: false // æ¨™è¨˜ç‚ºéå…§ç½®åŠ‡æœ¬
        };

        // å­˜å…¥è³‡æ–™åº«
        await db.scriptKillScripts.add(scriptToSave);
        
        document.getElementById('sk-ai-generator-modal').classList.remove('visible'); // é—œé–‰AIç”Ÿæˆå™¨
        await renderScriptManagerList(); // åˆ·æ–°åŠ‡æœ¬ç®¡ç†åˆ—è¡¨
        
        alert(`åŠ‡æœ¬ã€Š${scriptToSave.name}ã€‹å·²æˆåŠŸä¿å­˜åˆ°ä½ çš„è‡ªè¨‚åŠ‡æœ¬åº«ä¸­ï¼`);

    } catch (error) {
        console.error("ä¿å­˜AIåŠ‡æœ¬å¤±æ•—:", error);
        alert(`ä¿å­˜å¤±æ•—: ${error.message}`);
    }
}

// â–²â–²â–² æ–°å¢åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²

// â–²â–²â–² åŠ‡æœ¬æ®ºåŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™è£¡æ˜¯â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™è£¡æ˜¯â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€ä½ èªªæˆ‘çŒœã€‘æ‰“é–‹éŠæˆ²è¨­ç½®ä»‹é¢ (V2 - æ ¸å–æ–¹å¡Šç‰ˆ)
 */
async function openGuessWhatSetup() {
    // é‡ç½®éŠæˆ²ç‹€æ…‹ï¼Œä»¥é˜²ä¸Šæ¬¡éŠæˆ²è³‡æ–™æ®˜ç•™
    guessWhatGameState = { isActive: false, mode: 'ai_guesses', opponent: null, secretWord: '', gameLog: [], currentTurn: 'user' };

    showScreen('guess-what-setup-screen');
    const selectionEl = document.getElementById('guess-what-player-selection');
    selectionEl.innerHTML = '<p>æ­£åœ¨è¼‰å…¥ç©ä¼´åˆ—è¡¨...</p>';

    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    const allNpcs = Object.values(state.chats).flatMap(chat => (chat.npcLibrary || []).map(npc => ({...npc, owner: chat.name})));
    let playerOptions = [
        ...singleChats.map(c => ({ id: c.id, name: c.name, avatar: c.settings.aiAvatar, type: 'è§’è‰²' })),
        ...allNpcs.map(n => ({ id: n.id, name: n.name, avatar: n.avatar, type: `NPC (${n.owner})` }))
    ];

    selectionEl.innerHTML = '';
    if (playerOptions.length === 0) {
        selectionEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">é‚„æ²’æœ‰å¯ä»¥ä¸€èµ·ç©çš„å¥½å‹å“¦~</p>';
        return;
    }
    
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘ä½¿ç”¨æ ¸å–æ–¹å¡Šï¼Œä¸¦æ·»åŠ å°ˆå±¬class
    playerOptions.forEach((player, index) => {
        const item = document.createElement('div');
        item.className = 'player-selection-item';
        item.innerHTML = `
            <input type="checkbox" class="guess-what-player-checkbox" value="${player.id}" id="opponent-${player.id}" ${index === 0 ? 'checked' : ''}>
            <img src="${player.avatar || defaultAvatar}" alt="${player.name}">
            <span class="name">${player.name}</span>
            <span class="type-tag">${player.type}</span>
        `;
        selectionEl.appendChild(item);
    });

    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ·»åŠ äº‹ä»¶ç›£è½ï¼Œå¯¦ç¾å–®é¸æ•ˆæœ
    selectionEl.addEventListener('click', (e) => {
        if (e.target.type === 'checkbox' && e.target.classList.contains('guess-what-player-checkbox')) {
            // ç•¶é»æ“Šä¸€å€‹æ ¸å–æ–¹å¡Šæ™‚ï¼Œå–æ¶ˆå…¶ä»–æ‰€æœ‰åŒé¡æ ¸å–æ–¹å¡Šçš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.guess-what-player-checkbox').forEach(cb => {
                if (cb !== e.target) cb.checked = false;
            });
        }
    });

    // é è¨­é¡¯ç¤ºâ€œæˆ‘å‡ºé¡Œâ€æ¨¡å¼çš„è¼¸å…¥æ¡†
    document.getElementById('user-word-input-container').style.display = 'block';
}

/**
 * ã€ä½ èªªæˆ‘çŒœã€‘é–‹å§‹éŠæˆ²çš„æ ¸å¿ƒé‚è¼¯ (V2 - æ ¸å–æ–¹å¡Šç‰ˆ)
 */
async function startGuessWhatGame() {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¿®æ”¹é¸æ“‡å™¨ä»¥åŒ¹é…æ–°çš„æ ¸å–æ–¹å¡Šclass
    const selectedOpponentCheckbox = document.querySelector('.guess-what-player-checkbox:checked');
    if (!selectedOpponentCheckbox) {
        alert("è«‹é¸æ“‡ä¸€ä½ç©ä¼´ï¼");
        return;
    }
    const opponentId = selectedOpponentCheckbox.value;
    const gameMode = document.querySelector('input[name="guess_what_mode"]:checked').value;
    const userWord = document.getElementById('guess-what-user-word').value.trim();

    if (gameMode === 'ai_guesses' && !userWord) {
        alert("â€œæˆ‘å‡ºé¡Œâ€æ¨¡å¼ä¸‹ï¼Œè©èªä¸èƒ½ç‚ºç©ºï¼");
        return;
    }

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨æº–å‚™éŠæˆ²ï¼ŒAIä¹Ÿåœ¨æ‘©æ‹³æ“¦æŒ...");

    const chat = Object.values(state.chats).find(c => c.id === opponentId);
    let opponentInfo = null;
    if (chat) { 
        opponentInfo = { id: chat.id, name: chat.name, avatar: chat.settings.aiAvatar, persona: chat.settings.aiPersona };
    } else {
        for (const c of Object.values(state.chats)) {
            const npc = (c.npcLibrary || []).find(n => n.id === opponentId);
            if (npc) {
                opponentInfo = { id: npc.id, name: npc.name, avatar: npc.avatar, persona: npc.persona };
                break;
            }
        }
    }
    if (!opponentInfo) { alert("æ‰¾ä¸åˆ°æ‰€é¸çš„ç©ä¼´ä¿¡æ¯ï¼"); return; }

    guessWhatGameState.isActive = true;
    guessWhatGameState.mode = gameMode;
    guessWhatGameState.opponent = opponentInfo;
    guessWhatGameState.gameLog = [];

    document.getElementById('guess-what-game-title').textContent = `èˆ‡ ${opponentInfo.name} çš„éŠæˆ²`;
    const inputEl = document.getElementById('guess-what-user-input');

    if (gameMode === 'ai_guesses') { 
        guessWhatGameState.secretWord = userWord;
        guessWhatGameState.currentTurn = 'user'; 
        logToGuessWhatGame('éŠæˆ²é–‹å§‹ï¼ä½ ä¾†å‡ºé¡Œï¼Œè«‹çµ¦å‡ºä½ çš„ç¬¬ä¸€å€‹æç¤ºã€‚', 'system');
        inputEl.placeholder = "è«‹çµ¦å‡ºç¬¬ä¸€å€‹æç¤º...";
        inputEl.disabled = false;
    } else { 
        const { secretWord, firstHint } = await triggerGuessWhatAiAction('generate_word');
        if (!secretWord) {
            await showCustomAlert("å‡ºé¡Œå¤±æ•—", "æŠ±æ­‰ï¼ŒAIä»Šå¤©å¥½åƒæ²’éˆæ„Ÿï¼Œæƒ³ä¸å‡ºé¡Œç›®ä¾†ã€‚è«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥APIè¨­ç½®ã€‚");
            guessWhatGameState.isActive = false;
            showScreen('game-hall-screen'); 
            return;
        }
        guessWhatGameState.secretWord = secretWord;
        guessWhatGameState.currentTurn = 'user';
        logToGuessWhatGame(`éŠæˆ²é–‹å§‹ï¼${opponentInfo.name} å·²ç¶“æƒ³å¥½äº†ä¸€å€‹è©ã€‚`, 'system');
        logToGuessWhatGame({ player: opponentInfo, text: `ã€${opponentInfo.name}æ‰˜è‘—ä¸‹å·´æƒ³äº†æƒ³ã€‘ç¬¬ä¸€å€‹æç¤ºæ˜¯... ${firstHint}` }, 'ai-turn');
        inputEl.placeholder = "è«‹æ ¹æ“šæç¤ºé€²è¡ŒçŒœæ¸¬...";
        inputEl.disabled = false;
    }

    showScreen('guess-what-game-screen');
    renderGuessWhatGameScreen();
    inputEl.focus();
    const actionArea = document.getElementById('guess-what-action-area');
    if(actionArea) actionArea.style.display = 'flex';
}


/**
 * ã€ä½ èªªæˆ‘çŒœã€‘æ¸²æŸ“éŠæˆ²ä¸»ä»‹é¢
 */
function renderGuessWhatGameScreen() {
    const logContainer = document.getElementById('guess-what-game-log');
    logContainer.innerHTML = '';
    
    guessWhatGameState.gameLog.forEach(log => {
        const logEl = document.createElement('div');
        logEl.className = `guess-log-entry ${log.type}`;

        if (log.type === 'system') {
            logEl.textContent = log.message;
        } else {
            const avatarUrl = log.message.player.isUser ? (state.qzoneSettings.avatar || defaultAvatar) : log.message.player.avatar;
            logEl.innerHTML = `
                <img src="${avatarUrl}" class="avatar">
                <div class="bubble">
                    <div class="name">${log.message.player.name}</div>
                    <div>${log.message.text.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        }
        logContainer.appendChild(logEl);
    });

    logContainer.scrollTop = logContainer.scrollHeight;
}

/**
 * ã€ä½ èªªæˆ‘çŒœã€‘æ·»åŠ ä¸€æ¢éŠæˆ²æ—¥èªŒ
 */
function logToGuessWhatGame(message, type = 'system') {
    guessWhatGameState.gameLog.push({ message, type });
    renderGuessWhatGameScreen();
}

/**
 * ã€ä½ èªªæˆ‘çŒœ V5 | è£åˆ¤é‚è¼¯æœ€çµ‚ä¿®å¾©ç‰ˆã€‘éŠæˆ²ä¸»è¿´åœˆ/å¼•æ“
 * @param {string} userInput - ç”¨æˆ¶å‰›å‰›çš„è¼¸å…¥
 */
async function processGuessWhatTurn(userInput) {
    if (!guessWhatGameState.isActive) return;

    const inputEl = document.getElementById('guess-what-user-input');
    const userPlayer = { id: 'user', name: state.qzoneSettings.nickname || 'æˆ‘', isUser: true };
    const aiPlayer = guessWhatGameState.opponent;
    const currentMode = guessWhatGameState.mode;

    // 1. è¨˜éŒ„ä¸¦é¡¯ç¤ºä½¿ç”¨è€…çš„è¡Œç‚º
    logToGuessWhatGame({ player: userPlayer, text: userInput }, 'user-turn');

    // 2. è¼ªåˆ°AIè¡Œå‹•ï¼Œç¦ç”¨è¼¸å…¥æ¡†
    guessWhatGameState.currentTurn = 'ai';
    inputEl.placeholder = `ç­‰å¾… ${aiPlayer.name} çš„å›æ‡‰...`;
    inputEl.disabled = true;
    renderGuessWhatGameScreen();
    await sleep(1500);

    // 3. è®“AIæ ¹æ“šä¸Šä¸‹æ–‡åŸ·è¡Œå‹•ä½œ
    const aiResponse = await triggerGuessWhatAiAction(
        currentMode === 'ai_guesses' ? 'guess_word' : 'give_hint',
        userInput
    );
    
    // 4. ã€æ ¸å¿ƒä¿®å¾©ã€‘ä½¿ç”¨ switch çµæ§‹æ¸…æ™°åœ°è™•ç†AIçš„æ¯ä¸€ç¨®è¡Œå‹•çµæœ
    if (aiResponse) {
        switch (aiResponse.type) {
            case 'guess':
                const guessText = aiResponse.text;
                // å…ˆæŠŠAIçš„çŒœæ¸¬é¡¯ç¤ºå‡ºä¾†
                logToGuessWhatGame({ player: aiPlayer, text: guessText }, 'ai-turn');

                // èª¿ç”¨è£åˆ¤å‡½æ•¸é€²è¡Œåˆ¤æ–·
                if (isGuessCorrect(guessText, guessWhatGameState.secretWord)) {
                    await sleep(1000); // åœé “ä¸€ä¸‹ï¼Œè®“ç©å®¶çœ‹åˆ°çŒœæ¸¬å…§å®¹
                    endGuessWhatGame('ai', `æˆ‘çŒœå°å•¦ï¼ç­”æ¡ˆå°±æ˜¯ã€${guessWhatGameState.secretWord}ã€‘ï¼`);
                    return; // çŒœå°äº†ï¼ŒéŠæˆ²çµæŸï¼Œé€€å‡ºå‡½æ•¸
                }
                // å¦‚æœæ²’çŒœå°ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œï¼Œæµç¨‹æœƒè‡ªç„¶åœ°èµ°åˆ°æœ€å¾Œï¼ŒæŠŠæ§åˆ¶æ¬Šé‚„çµ¦ç”¨æˆ¶
                break;

            case 'hint':
                // AIçµ¦å‡ºæ–°æç¤º
                logToGuessWhatGame({ player: aiPlayer, text: aiResponse.text }, 'ai-turn');
                break;

            case 'game_over':
                // AIåœ¨çµ¦æç¤ºæ™‚ç›´æ¥åˆ¤æ–·ç”¨æˆ¶çŒœå°äº†
                endGuessWhatGame(aiResponse.winner, aiResponse.reason);
                return; // éŠæˆ²çµæŸï¼Œé€€å‡ºå‡½æ•¸

            case 'error':
                // AIè¿”å›äº†éŒ¯èª¤è³‡è¨Š
                logToGuessWhatGame({ player: aiPlayer, text: aiResponse.text }, 'ai-turn');
                break;

            default:
                // æœªçŸ¥é¡å‹çš„å›å¾©ï¼Œä¹Ÿè¨˜éŒ„ä¸‹ä¾†
                logToGuessWhatGame({ player: aiPlayer, text: 'æˆ‘å¥½åƒæœ‰é»è·‘ç¥äº†ï¼Œæˆ‘å€‘èªªåˆ°å“ªäº†ï¼Ÿ' }, 'ai-turn');
                console.warn("æ”¶åˆ°äº†æœªçŸ¥çš„AIè¡Œå‹•é¡å‹:", aiResponse);
                break;
        }
    } else {
        // APIèª¿ç”¨å¾¹åº•å¤±æ•—
        logToGuessWhatGame({ player: aiPlayer, text: 'æˆ‘...å¥½åƒå¾¹åº•æ–·ç·šäº†...' }, 'ai-turn');
    }

    // 5. å¦‚æœéŠæˆ²æ²’æœ‰çµæŸï¼Œå‰‡è¼ªåˆ°ç”¨æˆ¶è¡Œå‹•ï¼Œæ¢å¾©è¼¸å…¥æ¡†
    guessWhatGameState.currentTurn = 'user';
    inputEl.placeholder = currentMode === 'ai_guesses' ? "è«‹ç¹¼çºŒçµ¦å‡ºä½ çš„æç¤º..." : "è«‹æ ¹æ“šæç¤ºç¹¼çºŒçŒœæ¸¬...";
    inputEl.disabled = false;
    inputEl.focus();
}


/**
 * ã€ä½ èªªæˆ‘çŒœã€‘éŠæˆ²çµæŸè™•ç†
 */
function endGuessWhatGame(winner, reason) {
    if (!guessWhatGameState.isActive) return; // é˜²æ­¢é‡è¤‡åŸ·è¡Œ
    guessWhatGameState.isActive = false; // æ¨™è¨˜éŠæˆ²ç‚ºéå•Ÿå‹•ç‹€æ…‹
    
    // ç«‹å³éš±è—éŠæˆ²ä¸­çš„è¼¸å…¥å€åŸŸ
    const actionArea = document.getElementById('guess-what-action-area');
    if(actionArea) actionArea.style.display = 'none';

    // ç”Ÿæˆè¤‡ç›¤æ–‡æœ¬
    const summaryText = generateGuessWhatSummary(winner, reason);
    // é¡¯ç¤ºçµç®—å¡ç‰‡
    showGuessWhatSummaryModal(summaryText);
}
/**
 * ã€å…¨æ–°ã€‘åˆ¤æ–·AIçš„çŒœæ¸¬æ˜¯å¦æ­£ç¢ºï¼ˆç°¡å–®ç‰ˆï¼‰
 * @param {string} guess - AIçŒœæ¸¬çš„è©èª
 * @param {string} answer - æ­£ç¢ºç­”æ¡ˆ
 * @returns {boolean}
 */
function isGuessCorrect(guess, answer) {
    if (!guess || !answer) return false;

    // ç‚ºäº†æ›´å¯¬é¬†çš„åŒ¹é…ï¼Œæˆ‘å€‘éƒ½è½‰ç‚ºå°å¯«ä¸¦å»é™¤ç©ºæ ¼
    const cleanGuess = guess.toLowerCase().replace(/\s+/g, '');
    const cleanAnswer = answer.toLowerCase().replace(/\s+/g, '');

    // åªè¦çŒœæ¸¬åŒ…å«äº†ç­”æ¡ˆï¼Œæˆ–è€…ç­”æ¡ˆåŒ…å«äº†çŒœæ¸¬ï¼Œå°±èªç‚ºæ­£ç¢º
    // ä¾‹å¦‚ï¼šç­”æ¡ˆæ˜¯â€œéœœæ·‡æ·‹â€ï¼ŒçŒœæ¸¬â€œéœœæ·‡æ·‹è»Šâ€æˆ–â€œæ·‡æ·‹â€ï¼Œéƒ½ç®—å°
    return cleanGuess.includes(cleanAnswer) || cleanAnswer.includes(cleanGuess);
}

/**
 * ã€ä½ èªªæˆ‘çŒœ-AIæ ¸å¿ƒ V4 | éŠ…ç‰†éµå£ç‰ˆã€‘èª¿ç”¨AIåŸ·è¡ŒéŠæˆ²é‚è¼¯ï¼Œå…§ç½®å¼·å¤§çš„é‡è©¦æ©Ÿåˆ¶
 * @param {string} actionType - AIéœ€è¦åŸ·è¡Œçš„å‹•ä½œ: 'generate_word', 'give_hint', 'guess_word'
 * @param {string} userInput - ç”¨æˆ¶å‰›å‰›çš„è¼¸å…¥
 * @returns {Promise<object|null>} - AIçš„è¡Œå‹•çµæœ
 */
async function triggerGuessWhatAiAction(actionType, userInput = null) {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return null;

    // --- é€™éƒ¨åˆ†Prompté‚è¼¯ä¿æŒä¸è®Š ---
    const opponent = guessWhatGameState.opponent;
    const historyText = guessWhatGameState.gameLog.map(log => log.type === 'system' ? `[ç³»çµ±æç¤º: ${log.message}]` : `${log.message.player.name}: ${log.message.text}`).slice(-10).join('\n');
    let systemPrompt = `# ä½ çš„ä»»å‹™\nä½ æ­£åœ¨æ‰®æ¼”è§’è‰²â€œ${opponent.name}â€ï¼Œäººè¨­æ˜¯ï¼šâ€œ${opponent.persona}â€ã€‚\nä½ æ­£åœ¨å’Œâ€œ${state.qzoneSettings.nickname || 'æˆ‘'}â€ç©â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²ã€‚\nä½ çš„æ‰€æœ‰ç™¼è¨€éƒ½ã€å¿…é ˆã€‘åš´æ ¼ç¬¦åˆä½ çš„äººè¨­å’Œå£å»ï¼Œè®“æ•´å€‹éç¨‹åƒä¸€æ¬¡çœŸå¯¦çš„èŠå¤©äº’å‹•ã€‚\n\n# éŠæˆ²æ­·å² (æœ€è¿‘çš„å°è©±)\n${historyText}\n`;
    switch (actionType) {
        case 'generate_word': systemPrompt += `# ä½ çš„è¡Œå‹•æŒ‡ä»¤\n1. æ ¹æ“šä½ çš„äººè¨­ï¼Œæƒ³ä¸€å€‹å¸¸è¦‹çš„ã€2-5å€‹å­—çš„ä¸­æ–‡è©èªä½œç‚ºè¬åº•ã€‚\n2. ç‚ºé€™å€‹è©èªï¼Œçµ¦å‡ºä½ çš„ã€ç¬¬ä¸€æ¢ã€‘ç¬¦åˆäººè¨­çš„ã€æœ‰è¶£çš„æç¤ºã€‚\n3. ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼ŒåŒ…å« "secretWord" å’Œ "firstHint" å…©å€‹æ¬„ä½ã€‚\n\n# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:\n{"secretWord": "æœˆäº®", "firstHint": "ã€æŒ‡äº†æŒ‡å¤©ä¸Šã€‘æ™šä¸Šæ‰èƒ½çœ‹åˆ°çš„æ±è¥¿å“¦ï¼Œåœ“åœ“çš„ï¼Œäº®äº®çš„~"}`; break;
      case 'give_hint':
    systemPrompt += `# éŠæˆ²è¦å‰‡
ä½ æ˜¯å‡ºé¡Œäººï¼Œä½ çš„è¬åº•æ˜¯ã€${guessWhatGameState.secretWord}ã€‘ã€‚
ç”¨æˆ¶å‰›å‰›çš„çŒœæ¸¬æ˜¯ï¼šâ€œ${userInput}â€ã€‚

# ä½ çš„è¡Œå‹•æŒ‡ä»¤
1.  é¦–å…ˆåˆ¤æ–·ç”¨æˆ¶çš„çŒœæ¸¬æ˜¯å¦æ­£ç¢ºã€‚
2.  å¦‚æœç”¨æˆ¶çŒœå°äº†ï¼ŒéŠæˆ²çµæŸã€‚
3.  å¦‚æœç”¨æˆ¶çŒœéŒ¯äº†ï¼Œä½ ã€å¿…é ˆã€‘æ ¹æ“šä½¿ç”¨è€…çš„éŒ¯èª¤çŒœæ¸¬ï¼Œçµ¦å‡ºã€ä¸‹ä¸€æ¢ã€‘æ–°çš„ã€æ›´å…·é‡å°æ€§çš„æç¤ºï¼Œå¼•å°ä»–å€‘ã€‚
4.  ã€ã€ã€äººè¨­æ‰®æ¼”éµå¾‹ã€‘ã€‘ã€‘ä½ çš„æ‰€æœ‰æç¤ºéƒ½ã€å¿…é ˆã€‘ç¬¦åˆä½ çš„äººè¨­å’Œå£å»ï¼Œå¯ä»¥åŠ å…¥å‹•ä½œã€è¡¨æƒ…ã€èªæ°£è©ï¼Œç”šè‡³å¯ä»¥å°ç”¨æˆ¶ã€ç¬¨ç¬¨çš„çŒœæ¸¬é€²è¡Œä¸€äº›ä¿çš®çš„åæ§½ã€‘ï¼Œè®“éŠæˆ²æ›´æœ‰è¶£ã€‚
5.  ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ã€‚

# JSONè¼¸å‡ºæ ¼å¼
- å¦‚æœçŒœå°äº†: \`{"type": "game_over", "winner": "user", "reason": "æ­å–œä½ çŒœå°å•¦ï¼å°±æ˜¯ã€${guessWhatGameState.secretWord}ã€‘ï¼"}\`
- å¦‚æœçŒœéŒ¯äº†: \`{"type": "hint", "text": "ã€æ­æ°£ã€‘ä¸å°å“¦ï¼Œå†æƒ³æƒ³ã€‚æç¤ºæ˜¯ï¼š[åœ¨é€™è£¡å¯«ä½ çš„æ–°æç¤º]"}\``;
    break;

// â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šã€ä¿®å¾©å¾Œã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰èˆŠçš„ case 'guess_word' ä»£ç¢¼å¡Š â–¼â–¼â–¼
        case 'guess_word':
            systemPrompt += `# éŠæˆ²è¦å‰‡
ä½ æ˜¯çŒœé¡Œäººï¼Œç”¨æˆ¶æ­£åœ¨æè¿°ä¸€å€‹è©èªï¼Œä½ éœ€è¦æ ¹æ“šæç¤ºçŒœå‡ºé€™å€‹è©ã€‚
ç”¨æˆ¶å‰›å‰›çµ¦ä½ çš„æ–°æç¤ºæ˜¯ï¼šâ€œ${userInput}â€ã€‚

# ä½ çš„è¡Œå‹•æŒ‡ä»¤
1.  ç¶œåˆåˆ†æã€éŠæˆ²æ­·å²ã€‘ä¸­ç”¨æˆ¶çµ¦å‡ºçš„ã€æ‰€æœ‰æç¤ºã€‘ã€‚
2.  æ ¹æ“šæ‰€æœ‰ç·šç´¢ï¼Œé€²è¡Œã€ä¸€æ¬¡ã€‘çŒœæ¸¬ã€‚
3.  ã€ã€ã€äººè¨­æ‰®æ¼”éµå¾‹ã€‘ã€‘ã€‘ä½ çš„çŒœæ¸¬ã€å¿…é ˆã€‘ç¬¦åˆä½ çš„äººè¨­å’Œå£å»ã€‚ä½ å¯ä»¥åŠ å…¥ä½ çš„æ€è€ƒéç¨‹ã€æƒ…ç·’ï¼Œç”šè‡³å¯ä»¥ã€å°ç”¨æˆ¶çš„æç¤ºé€²è¡Œåæ§½ã€‘ã€‚
4.  ã€ã€ã€è¶£å‘³æ€§æŒ‡ä»¤ã€‘ã€‘ã€‘ç‚ºäº†é€—å¼„ä½¿ç”¨è€…ï¼Œä½ å¯ä»¥ã€æ•…æ„çµ¦å‡ºä¸€äº›æœ‰è¶£çš„ã€æ²¾é»é‚Šä½†æ˜é¡¯éŒ¯èª¤çš„ç­”æ¡ˆã€‘ï¼Œç„¶å¾Œå†çµ¦å‡ºä½ èªç‚ºæœ€å¯èƒ½çš„ç­”æ¡ˆã€‚ä½†é€™åªæ˜¯å¶çˆ¾çš„èª¿åŠ‘ï¼Œä½ çš„æœ€çµ‚ç›®çš„é‚„æ˜¯è¦çŒœå°ã€‚
5.  ã€ã€ã€çµ•å°ç¦æ­¢ã€‘ã€‘ã€‘ä½ ã€ä¸èƒ½ã€‘å†å‘ç”¨æˆ¶æå•ï¼Œä½ çš„ä»»å‹™æ˜¯ç›´æ¥çŒœæ¸¬ã€‚
6.  ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ã€‚

# JSONè¼¸å‡ºæ ¼å¼ (æ³¨æ„ï¼šä½ ç„¡æ³•åˆ¤æ–·è‡ªå·±æ˜¯å¦çŒœå°ï¼Œæ‰€ä»¥æ°¸é ä½¿ç”¨é€™å€‹æ ¼å¼)
{"type": "guess", "text": "ã€å‡è£æ-ç„¶å¤§æ‚Ÿã€‘å“¦~æˆ‘çŸ¥é“äº†ï¼Œæ˜¯â€œé›»é£¯ç…²â€å°ä¸å°ï¼Ÿ...å¥½å§å¥½å§ä¸é€—ä½ äº†ï¼Œæˆ‘çŒœæ˜¯...[ä½ çš„çœŸå¯¦çŒœæ¸¬]"}`;
            break;
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


    }
    
    // --- ã€æ ¸å¿ƒæ”¹é€ ã€‘å¸¶æœ‰æ™ºæ…§é‡è©¦çš„APIè«‹æ±‚é‚è¼¯ ---
    const maxRetries = 3;
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ åœ¨ç³»çµ±æŒ‡ä»¤ä¸­è®€åˆ°çš„è¦å‰‡ï¼Œç«‹å³é–‹å§‹ä½ çš„è¡Œå‹•ã€‚" }];
            const isGemini = proxyUrl === GEMINI_API_URL;
            const geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);

            const response = isGemini 
                ? await fetch(geminiConfig.url, geminiConfig.data)
                : await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi], temperature: 0.9, response_format: { type: "json_object" } })
                });

            // æ™ºæ…§åˆ¤æ–·éŒ¯èª¤é¡å‹
            if (!response.ok) {
                // å°æ–¼ 4xx é¡çš„ç”¨æˆ¶ç«¯éŒ¯èª¤ (å¦‚ 401 Unauthorized, 400 Bad Request)ï¼Œé€šå¸¸é‡è©¦ç„¡æ•ˆï¼Œç›´æ¥æ‹‹å‡ºã€‚
                if (response.status >= 400 && response.status < 500) {
                     const errorText = await response.text();
                     throw new Error(`APIç”¨æˆ¶ç«¯éŒ¯èª¤ (ç‹€æ…‹ç¢¼ ${response.status}): ${errorText}`);
                }
                // å°æ–¼ 5xx ä¼ºæœå™¨éŒ¯èª¤æˆ– 429 é€Ÿç‡é™åˆ¶ï¼Œæ˜¯å¯é‡è©¦çš„ã€‚
                throw new Error(`APIä¼ºæœå™¨è‡¨æ™‚éŒ¯èª¤ (ç‹€æ…‹ç¢¼ ${response.status})`);
            }

            const data = await response.json();
            const content = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '');
            return JSON.parse(content); // **æˆåŠŸï¼Œç›´æ¥è¿”å›çµæœï¼Œè·³å‡ºè¿´åœˆ**

        } catch (error) {
            console.error(`â€œä½ èªªæˆ‘çŒœâ€AIè¡Œå‹•[${actionType}]å¤±æ•— (ç¬¬ ${attempt}/${maxRetries} æ¬¡å˜—è©¦):`, error.message);
            
            // å¦‚æœæ˜¯æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œæˆ–è€…æ˜¯ä¸€å€‹ä¸å¯é‡è©¦çš„éŒ¯èª¤ï¼Œå‰‡è·³å‡ºè¿´åœˆæº–å‚™è¿”å›æœ€çµ‚å¤±æ•—è³‡è¨Š
            if (attempt === maxRetries || error.message.includes('APIç”¨æˆ¶ç«¯éŒ¯èª¤')) {
                break;
            }
            
            // ç­‰å¾…ä¸€æ®µæ™‚é–“å†é‡è©¦ï¼ˆæ¯”å¦‚ 1.5s, 3s, 4.5sï¼‰
            await sleep(1500 * attempt);
        }
    }

    // --- æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—å¾Œçš„æœ€çµ‚è™•ç† ---
    console.error(`â€œä½ èªªæˆ‘çŒœâ€AIè¡Œå‹•[${actionType}]åœ¨æ‰€æœ‰å˜—è©¦å¾Œå‡å¤±æ•—ã€‚`);
    // æ ¹æ“šå¤±æ•—çš„éšæ®µï¼Œè¿”å›ä¸€å€‹ç‰¹å®šçš„éŒ¯èª¤ç‰©ä»¶
    if (actionType === 'generate_word') {
        return { secretWord: null, firstHint: null };
    }
    // è¿”å›ä¸€å€‹å…¨æ–°çš„ 'error' é¡å‹ï¼Œè®“éŠæˆ²ä¸»è¿´åœˆçŸ¥é“å¦‚ä½•è™•ç†
    return { type: 'error', text: 'ã€æ­äº†å£æ°£ã€‘æŠ±æ­‰ï¼Œæˆ‘çš„ç¶²è·¯å¥½åƒå‡ºå•é¡Œäº†ï¼Œè©¦äº†å¥½å¹¾æ¬¡éƒ½æ²’é€£ä¸Š...' };
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²çµç®—èˆ‡è½‰ç™¼åŠŸèƒ½æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼

/**
 * ã€ä½ èªªæˆ‘çŒœã€‘ç”ŸæˆéŠæˆ²è¤‡ç›¤çš„æ–‡æœ¬
 * @param {string} winner - å‹åˆ©è€… ('user' or 'ai')
 * @param {string} reason - éŠæˆ²çµæŸåŸå› 
 * @returns {string} æ ¼å¼åŒ–å¾Œçš„è¤‡ç›¤Markdownæ–‡æœ¬
 */
function generateGuessWhatSummary(winner, reason) {
    let summaryText = `**ä½ èªªæˆ‘çŒœ - éŠæˆ²è¤‡ç›¤**\n\n`;
    summaryText += `**éŠæˆ²çµæœ:** ${reason}\n`;
    summaryText += `**è¬åº•:** ${guessWhatGameState.secretWord}\n\n`;
    summaryText += `**åƒèˆ‡ç©å®¶:** æˆ‘, ${guessWhatGameState.opponent.name}\n\n`;
    summaryText += `---\n\n**éŠæˆ²è¨˜éŒ„:**\n`;
    
    const formattedLog = guessWhatGameState.gameLog.map(log => {
        if (log.type === 'system') {
            return `[ç³»çµ±æç¤º: ${log.message}]`;
        } else {
            return `${log.message.player.name}: ${log.message.text}`;
        }
    }).join('\n');
    
    summaryText += formattedLog;

    return summaryText;
}

/**
 * ã€ä½ èªªæˆ‘çŒœã€‘é¡¯ç¤ºéŠæˆ²çµç®—å¡ç‰‡æ¨¡æ…‹æ¡†
 * @param {string} summaryText - è¤‡ç›¤æ–‡æœ¬
 */
function showGuessWhatSummaryModal(summaryText) {
    const modal = document.getElementById('guess-what-summary-modal');
    const contentEl = document.getElementById('guess-what-summary-content');
    
    contentEl.innerHTML = renderMarkdown(summaryText);
    
    // ä½¿ç”¨å…‹éš†ç¯€é»æŠ€å·§ï¼Œé˜²æ­¢äº‹ä»¶é‡è¤‡ç¶å®š
    const forwardBtn = document.getElementById('forward-guess-what-summary-btn');
    const newForwardBtn = forwardBtn.cloneNode(true);
    forwardBtn.parentNode.replaceChild(newForwardBtn, forwardBtn);
    
    const closeBtn = document.getElementById('close-guess-what-summary-btn');
    const newCloseBtn = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

    // æª¢æŸ¥å°æ‰‹æ˜¯å¦æ˜¯ä¸»è¦è§’è‰²ï¼ˆæœ‰ç¨ç«‹èŠå¤©è¦–çª—ï¼‰ï¼Œè€Œä¸æ˜¯NPC
    const opponentId = guessWhatGameState.opponent.id;
    const canForward = state.chats[opponentId] !== undefined;

    if (canForward) {
        newForwardBtn.style.display = 'block';
        newForwardBtn.onclick = () => forwardGuessWhatSummary(summaryText);
    } else {
        // å¦‚æœå°æ‰‹æ˜¯NPCï¼Œæ²’æœ‰ç¨ç«‹èŠå¤©è¦–çª—ï¼Œå‰‡éš±è—è½‰ç™¼æŒ‰éˆ•
        newForwardBtn.style.display = 'none';
    }

    newCloseBtn.onclick = () => {
        modal.classList.remove('visible');
        showScreen('game-hall-screen');
    };

    modal.classList.add('visible');
}

/**
 * ã€ä½ èªªæˆ‘çŒœã€‘å°‡éŠæˆ²è¤‡ç›¤è½‰ç™¼åˆ°å°æ‡‰çš„AIè§’è‰²çš„èŠå¤©ä¸­
 * @param {string} summaryText - è¤‡ç›¤æ–‡æœ¬
 */
async function forwardGuessWhatSummary(summaryText) {
    const opponentId = guessWhatGameState.opponent.id;
    const chat = state.chats[opponentId];
    
    if (!chat) {
        await showCustomAlert("è½‰ç™¼å¤±æ•—", "æ‰¾ä¸åˆ°è©²ç©å®¶çš„èŠå¤©çª—å£ã€‚");
        return;
    }

    document.getElementById('guess-what-summary-modal').classList.remove('visible');

    // å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„è¤‡ç›¤æ¶ˆæ¯
    const visibleMessage = {
        role: 'user',
        type: 'text',
        timestamp: Date.now(),
        content: summaryText
    };
    
    // å‰µå»ºçµ¦AIçœ‹çš„éš±è—æŒ‡ä»¤
    const aiContext = `[ç³»çµ±æŒ‡ä»¤ï¼šå‰›å‰›çµæŸäº†ä¸€å±€â€œä½ èªªæˆ‘çŒœâ€ï¼Œé€™æ˜¯éŠæˆ²è¤‡ç›¤ã€‚è«‹æ ¹æ“šé€™å€‹è¤‡ç›¤å…§å®¹ï¼Œä»¥ä½ çš„è§’è‰²äººè¨­ï¼Œå’Œç”¨æˆ¶èŠèŠå‰›æ‰çš„éŠæˆ²ã€‚]\n\n${summaryText}`;
    const hiddenInstruction = {
        role: 'system',
        content: aiContext,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    
    chat.history.push(visibleMessage, hiddenInstruction);
    await db.chats.put(chat);
    
    await showCustomAlert("è½‰ç™¼æˆåŠŸ", `éŠæˆ²è¤‡ç›¤å·²ç™¼é€è‡³èˆ‡â€œ${chat.name}â€çš„èŠå¤©ä¸­ï¼`);
    
    // æ‰“é–‹èŠå¤©ä¸¦è§¸ç™¼AIå›æ‡‰
    openChat(chat.id);
    triggerAiResponse();
}

// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯µç‰©åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

let currentPetData = null; // ç”¨æ–¼æš«å­˜æ­£åœ¨ç·¨è¼¯çš„å¯µç‰©è³‡æ–™
let isPetDragging = false; // æ¨™è¨˜æ˜¯å¦æ­£åœ¨æ‹–å‹•å¯µç‰©
let petDragOffset = { x: 0, y: 0 };

/**
 * ã€é ˜é¤Šç³»çµ±æ”¹é€ ç‰ˆã€‘æ‰“é–‹å¯µç‰©ä¸»é¢æ¿ï¼ˆè¨­ç½®èˆ‡äº’å‹•ï¼‰
 */
async function openPetModal() {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
        alert("åªæœ‰åœ¨å–®äººèŠå¤©ä¸­æ‰èƒ½é¤Šå¯µç‰©å“¦ï¼");
        return;
    }
    const chat = state.chats[state.activeChatId];

    // æ ¸å¿ƒåˆ¤æ–·ï¼šæª¢æŸ¥æ˜¯å¦å·²é ˜é¤Š
    if (!chat.settings.petAdopted) {
        // å¦‚æœæœªé ˜é¤Šï¼Œå½ˆå‡ºç¢ºèªæ¡†
        const confirmed = await showCustomConfirm(
            'é ˜é¤Šæ–°å¯µç‰©',
            `ä½ é‚„æ²’æœ‰ç‚ºâ€œ${chat.name}â€é ˜é¤Šå¯µç‰©ï¼Œè¦ç¾åœ¨é–‹å•Ÿå¯µç‰©ç³»çµ±å—ï¼Ÿ`,
            { confirmText: 'ç¾åœ¨é ˜é¤Š' }
        );

        if (confirmed) {
            // ç”¨æˆ¶åŒæ„é ˜é¤Š
            chat.settings.petAdopted = true;
            // å‰µå»ºä¸€å€‹å…¨æ–°çš„é è¨­å¯µç‰©ç‰©ä»¶
            chat.settings.pet = {
                type: 'ç„¡', name: '', image: 'ğŸ¥š', persona: 'ä¸€éš»å¯æ„›çš„å°å¯µç‰©ï¼Œå°ä¸–ç•Œå……æ»¿å¥½å¥‡ã€‚',
                petChatHistory: [], isCustomImage: false,
                display: { show: false, size: 100, top: '80%', left: '50%' },
                status: {
                    hunger: 100, happiness: 100, intimacyToUser: 50,
                    intimacyToChar: 50, lastUpdated: Date.now()
                }
            };
            await db.chats.put(chat);
            alert(`æ­å–œï¼ä½ å·²æˆåŠŸç‚ºâ€œ${chat.name}â€é–‹å•Ÿå¯µç‰©ç³»çµ±ï¼ç¾åœ¨ä¾†ç‚ºå®ƒè¨­ç½®ä¸€ä¸‹å§ã€‚`);
            // é ˜é¤ŠæˆåŠŸå¾Œï¼Œå†æ¬¡èª¿ç”¨æœ¬å‡½æ•¸ï¼Œé€™æ¬¡æœƒç›´æ¥é€²å…¥è¨­ç½®ä»‹é¢
            openPetModal(); 
        }
        // å¦‚æœç”¨æˆ¶å–æ¶ˆï¼Œå‰‡ä»€éº¼ä¹Ÿä¸åš
        return;
    }

    // --- å¦‚æœå·²ç¶“é ˜é¤Šï¼Œå‰‡åŸ·è¡ŒåŸä¾†çš„é¡¯ç¤ºé‚è¼¯ ---
    currentPetData = JSON.parse(JSON.stringify(chat.settings.pet)); 

    document.getElementById('pet-type-input').value = currentPetData.type === 'ç„¡' ? '' : currentPetData.type;
    document.getElementById('pet-name-input').value = currentPetData.name;
    document.getElementById('pet-image-input').value = currentPetData.image;
    document.getElementById('pet-display-toggle').checked = currentPetData.display.show;
    document.getElementById('pet-size-slider').value = currentPetData.display.size;
    document.getElementById('pet-size-value').textContent = `${currentPetData.display.size}px`;
    document.getElementById('pet-persona-input').value = currentPetData.persona || '';
    
    updatePetPreview();

    if (currentPetData.type !== 'ç„¡') {
        document.getElementById('pet-stats-area').style.display = 'flex';
        updatePetStatusUI(currentPetData);
    } else {
        document.getElementById('pet-stats-area').style.display = 'none';
    }

    const positionControls = document.getElementById('pet-position-controls');
    positionControls.style.display = currentPetData.display.show ? 'block' : 'none';
    
    document.getElementById('pet-modal').classList.add('visible');
}


/**
 * è¨ˆç®—ä¸¦æ‡‰ç”¨å¯µç‰©çš„æ•¸å€¼è¡°æ¸›
 * @param {object} pet - å¯µç‰©å°è±¡
 * @returns {boolean} - å¦‚æœæ•¸å€¼ç™¼ç”Ÿäº†è®ŠåŒ–ï¼Œè¿”å› true
 */
function applyPetDecay(pet) {
    if (!pet || !pet.status) return false;

    const now = Date.now();
    const lastUpdated = pet.status.lastUpdated || now;
    const timeElapsed = now - lastUpdated;

    // è¨ˆç®—éå»äº†å¤šå°‘å€‹è¡°æ¸›é€±æœŸ
    const intervalsPassed = Math.floor(timeElapsed / PET_DECAY_INTERVAL);

    if (intervalsPassed > 0) {
        // è¨ˆç®—ç¸½å…±è¦è¡°æ¸›å¤šå°‘
        const totalHungerDecay = intervalsPassed * PET_DECAY_AMOUNT.hunger;
        const totalHappinessDecay = intervalsPassed * PET_DECAY_AMOUNT.happiness;

        // æ‡‰ç”¨è¡°æ¸›ï¼Œç¢ºä¿ä¸ä½æ–¼0
        pet.status.hunger = Math.max(0, pet.status.hunger - totalHungerDecay);
        pet.status.happiness = Math.max(0, pet.status.happiness - totalHappinessDecay);

        // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“ï¼ŒåªåŠ ä¸Šå·²ç¶“è¨ˆç®—éçš„é€±æœŸçš„æ™‚é–“ï¼Œé¿å…ä¸Ÿå¤±é›¶é ­æ™‚é–“
        pet.status.lastUpdated = lastUpdated + intervalsPassed * PET_DECAY_INTERVAL;
        
        console.log(`å¯µç‰©"${pet.name}"æ•¸å€¼è¡°æ¸›: ${intervalsPassed}å€‹é€±æœŸ, é£½é£Ÿåº¦-${totalHungerDecay}, å¿ƒæƒ…-${totalHappinessDecay}`);
        return true; // æ•¸å€¼å·²æ”¹è®Š
    }

    return false; // æ•¸å€¼æœªæ”¹è®Š
}

/**
 * åœæ­¢ç•¶å‰çš„å¯µç‰©è¡°æ¸›è¨ˆæ™‚å™¨
 */
function stopPetDecayTimer() {
    if (petDecayTimer) {
        clearInterval(petDecayTimer);
        petDecayTimer = null;
        // console.log("å¯µç‰©è¡°æ¸›è¨ˆæ™‚å™¨å·²åœæ­¢ã€‚");
    }
}

/**
 * ç‚ºç•¶å‰èŠå¤©ä¸­çš„å¯µç‰©å•Ÿå‹•è¡°æ¸›è¨ˆæ™‚å™¨
 */
function startPetDecayTimer() {
    stopPetDecayTimer(); // å…ˆç¢ºä¿åœæ­¢ä»»ä½•èˆŠçš„è¨ˆæ™‚å™¨

    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.pet || chat.settings.pet.type === 'ç„¡') {
        return; // å¦‚æœç•¶å‰èŠå¤©æ²’æœ‰å¯µç‰©ï¼Œå‰‡ä¸å•Ÿå‹•
    }
    
    // console.log(`ç‚ºå¯µç‰©"${chat.settings.pet.name}"å•Ÿå‹•è¡°æ¸›è¨ˆæ™‚å™¨ã€‚`);
    
    // ä½¿ç”¨ setInterval å®šæœŸæª¢æŸ¥ä¸¦æ‡‰ç”¨è¡°æ¸›
    petDecayTimer = setInterval(async () => {
        const currentChat = state.chats[state.activeChatId];
        if (!currentChat) { // å®‰å…¨æª¢æŸ¥ï¼Œå¦‚æœèŠå¤©å·²é—œé–‰å‰‡åœæ­¢è¨ˆæ™‚å™¨
            stopPetDecayTimer();
            return;
        }
        const pet = currentChat.settings.pet;
        
        if (applyPetDecay(pet)) {
            // å¦‚æœæ•¸å€¼è®ŠåŒ–äº†ï¼Œæ›´æ–°UIä¸¦ä¿å­˜åˆ°è³‡æ–™åº«
            // åªæœ‰ç•¶å¯µç‰©é¢æ¿æ‰“é–‹æ™‚æ‰éœ€è¦æ›´æ–°UI
            if (document.getElementById('pet-modal').classList.contains('visible')) {
                 updatePetStatusUI(pet);
            }
            await db.chats.put(currentChat);
        }
    }, 60 * 1000); // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼Œæ˜¯å¦åˆ°é”äº†è¡°æ¸›é€±æœŸ
}

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²æ›´æ–°ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ updatePetStatusUI å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ›´æ–°å¯µç‰©æ•¸å€¼é¢æ¿çš„UIé¡¯ç¤º
 * @param {object} petData - å¯µç‰©çš„è³‡æ–™ç‰©ä»¶
 */
function updatePetStatusUI(petData) {
    const hunger = petData.status.hunger || 0;
    const happiness = petData.status.happiness || 0;
    // â˜…â˜…â˜… æ–°å¢ï¼šç²å–è¦ªå¯†åº¦æ•¸å€¼ â˜…â˜…â˜…
    const intimacyToUser = petData.status.intimacyToUser || 0;
    const intimacyToChar = petData.status.intimacyToChar || 0;

    const hungerFill = document.querySelector('#pet-hunger-bar .stat-bar-fill');
    const happinessFill = document.querySelector('#pet-happiness-bar .stat-bar-fill');
    // â˜…â˜…â˜… æ–°å¢ï¼šç²å–è¦ªå¯†åº¦é€²åº¦æ¢å…ƒç´  â˜…â˜…â˜…
    const intimacyUserFill = document.querySelector('#pet-intimacy-user-bar .stat-bar-fill');
    const intimacyCharFill = document.querySelector('#pet-intimacy-char-bar .stat-bar-fill');

    if (hungerFill) {
        hungerFill.style.width = `${hunger}%`;
        hungerFill.textContent = `${hunger}%`;
    }
    if (happinessFill) {
        happinessFill.style.width = `${happiness}%`;
        happinessFill.textContent = `${happiness}%`;
    }
    // â˜…â˜…â˜… æ–°å¢ï¼šæ¸²æŸ“è¦ªå¯†åº¦é€²åº¦æ¢ â˜…â˜…â˜…
    if (intimacyUserFill) {
        intimacyUserFill.style.width = `${intimacyToUser}%`;
        intimacyUserFill.textContent = `${intimacyToUser}%`;
    }
    if (intimacyCharFill) {
        intimacyCharFill.style.width = `${intimacyToChar}%`;
        intimacyCharFill.textContent = `${intimacyToChar}%`;
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



/**
 * åœ¨å½ˆçª—ä¸­æ›´æ–°å¯µç‰©çš„é è¦½
 */
function updatePetPreview() {
    const previewDisplay = document.getElementById('pet-preview-display');
    const nameEl = document.getElementById('pet-preview-name');
    const typeEl = document.getElementById('pet-preview-type');
    
    const imageInput = document.getElementById('pet-image-input').value.trim();

    if (imageInput.startsWith('http') || imageInput.startsWith('data:image')) {
        previewDisplay.innerHTML = `<img src="${imageInput}" style="width: 60px; height: 60px; object-fit: contain;">`;
    } else {
        previewDisplay.textContent = imageInput || 'ğŸ¥š';
    }
    
    nameEl.textContent = document.getElementById('pet-name-input').value.trim() || '(æœªå‘½å)';
    typeEl.textContent = document.getElementById('pet-type-input').value.trim() || 'ç‰©ç¨®';
}


/**
 * ä¿å­˜å¯µç‰©è¨­ç½®
 */
async function savePetSettings() {
    const chat = state.chats[state.activeChatId];
    
    // å¾UIè®€å–æ•¸æ“š
    const type = document.getElementById('pet-type-input').value.trim() || 'ç„¡';
    const name = document.getElementById('pet-name-input').value.trim();
    const image = document.getElementById('pet-image-input').value.trim() || 'ğŸ¥š';
    
    const newPetSettings = {
        ...currentPetData, // ä¿ç•™å¦‚ä½ç½®ç­‰æœªåœ¨ä¸»é¢æ¿ä¿®æ”¹çš„å±¬æ€§
        type: type,
        name: name,
        image: image,
        persona: document.getElementById('pet-persona-input').value.trim(),
        isCustomImage: image.startsWith('http') || image.startsWith('data:image'),
        display: {
            ...currentPetData.display,
            show: document.getElementById('pet-display-toggle').checked,
            size: parseInt(document.getElementById('pet-size-slider').value)
        }
    };

    // æ›´æ–°åˆ° state å’Œè³‡æ–™åº«
    chat.settings.pet = newPetSettings;
    await db.chats.put(chat);
    
    // åˆ·æ–°èŠå¤©ä»‹é¢ä¸Šçš„å¯µç‰©
    renderChatPet();
    
    document.getElementById('pet-modal').classList.remove('visible');
    currentPetData = null; // æ¸…ç†è‡¨æ™‚è³‡æ–™
    alert('å¯µç‰©è³‡è¨Šå·²ä¿å­˜ï¼');
}

/**
 * åœ¨èŠå¤©ä»‹é¢ä¸Šæ¸²æŸ“å¯µç‰©
 */
function renderChatPet() {
    const chat = state.chats[state.activeChatId];
    const petContainer = document.getElementById('chat-pet-container');
    const petEl = document.getElementById('chat-pet');

    if (!chat || chat.isGroup || !chat.settings.petAdopted || !chat.settings.pet || !chat.settings.pet.display.show) {
        petEl.style.display = 'none';
        return;
    }

    const pet = chat.settings.pet;
    petEl.style.display = 'block';
    
    if (pet.isCustomImage) {
        petEl.innerHTML = `<img src="${pet.image}" alt="${pet.name}">`;
    } else {
        petEl.innerHTML = pet.image;
    }
    
    // æ‡‰ç”¨æ¨£å¼
    petEl.style.fontSize = `${pet.display.size}px`;
    petEl.style.width = `${pet.display.size}px`;
    petEl.style.height = `${pet.display.size}px`;
    petEl.style.top = pet.display.top;
    petEl.style.left = pet.display.left;
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ handlePetInteraction å‡½æ•¸ â–¼â–¼â–¼
/**
 * è™•ç†ç”¨æˆ¶èˆ‡å¯µç‰©çš„äº’å‹• (V2 - å¢å¼·äº’å‹•è¨˜éŒ„)
 * @param {string} action - äº’å‹•é¡å‹, e.g., 'feed', 'play'
 */
async function handlePetInteraction(action) {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.petAdopted || !chat.settings.pet || chat.settings.pet.type === 'ç„¡') {
        alert("ä½ é‚„æ²’æœ‰å¯µç‰©ï¼Œæˆ–è€…é‚„æ²’æœ‰çµ¦å®ƒè¨­å®šç¨®é¡å“¦ï¼");
        return;
    }

    const pet = chat.settings.pet;
    let actionText = '';
    const myNickname = chat.settings.myNickname || 'æˆ‘';

    switch(action) {
        case 'feed':
            pet.status.hunger = Math.min(100, pet.status.hunger + 20);
            pet.status.happiness = Math.min(100, pet.status.happiness + 5);
            pet.status.intimacyToUser = Math.min(100, pet.status.intimacyToUser + 10);
            actionText = `${myNickname} å–‚äº† ${pet.name} ä¸€äº›é£Ÿç‰©ã€‚`;
            break;
        case 'play':
            pet.status.hunger = Math.max(0, pet.status.hunger - 10);
            pet.status.happiness = Math.min(100, pet.status.happiness + 15);
            pet.status.intimacyToUser = Math.min(100, pet.status.intimacyToUser + 15);
            actionText = `${myNickname} é™ª ${pet.name} ç©äº†ä¸€æœƒå…’ã€‚`;
            break;
        case 'touch':
            pet.status.happiness = Math.min(100, pet.status.happiness + 10);
            pet.status.intimacyToUser = Math.min(100, pet.status.intimacyToUser + 5);
            actionText = `${myNickname} è¼•è¼•åœ°æ’«æ‘¸äº† ${pet.name}ã€‚`;
            break;
        case 'chat':
            openPetChat();
            return; 
    }
    
    updatePetStatusUI(pet);
    chat.settings.pet = pet; 

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹1ï¼šå‰µå»ºå°ä½¿ç”¨è€…ã€å¯è¦‹ã€‘çš„ç³»çµ±æ¶ˆæ¯ â˜…â˜…â˜…
    const visibleMessage = {
        role: 'system',
        type: 'pat_message',
        content: `[ç³»çµ±ï¼š${actionText}]`,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹2ï¼šå‰µå»ºçµ¦AIçœ‹çš„ã€éš±è—ã€‘æŒ‡ä»¤ â˜…â˜…â˜…
    const hiddenMessageForAI = {
        role: 'system',
        content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶å‰›å‰›å’Œå¯µç‰©â€œ${pet.name}â€é€²è¡Œäº†äº’å‹•ï¼š${actionText}ã€‚]`,
        timestamp: Date.now() + 1, // ç¢ºä¿æ™‚é–“æˆ³è¨˜åœ¨å¾Œ
        isHidden: true
    };
    chat.history.push(hiddenMessageForAI);

    await db.chats.put(chat);
    
    if (document.getElementById('chat-interface-screen').classList.contains('active')) {
        appendMessage(visibleMessage, chat);
    }
    
    document.getElementById('pet-modal').classList.remove('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯µç‰©å°è©±åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * æ‰“é–‹å¯µç‰©èŠå¤©æ¨¡æ…‹æ¡†
 */
function openPetChat() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.pet || chat.settings.pet.type === 'ç„¡') {
        alert("å…ˆçµ¦ä½ çš„å¯µç‰©èµ·å€‹åå­—å’Œç¨®é¡å§ï¼");
        return;
    }
    
    // é—œé–‰ä¸»è¨­ç½®é¢æ¿ï¼Œæ‰“é–‹èŠå¤©é¢æ¿
    document.getElementById('pet-modal').classList.remove('visible');
    const chatModal = document.getElementById('pet-chat-modal');
    document.getElementById('pet-chat-title').textContent = `å’Œâ€œ${chat.settings.pet.name}â€çš„å°è©±`;
    document.getElementById('pet-chat-input').value = '';
    
    renderPetChatHistory(); // æ¸²æŸ“æ­·å²è¨˜éŒ„
    chatModal.classList.add('visible');
}

/**
 * æ¸²æŸ“å¯µç‰©çš„èŠå¤©è¨˜éŒ„
 */
function renderPetChatHistory() {
    const chat = state.chats[state.activeChatId];
    const pet = chat.settings.pet;
    const messagesEl = document.getElementById('pet-chat-messages');
    messagesEl.innerHTML = '';

    if (!pet.petChatHistory || pet.petChatHistory.length === 0) {
        messagesEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">è©¦è‘—å’Œå®ƒæ‰“å€‹æ‹›å‘¼å§ï¼</p>`;
        return;
    }
    
    // ç²å–ç”¨æˆ¶é ­åƒ
    const myAvatar = chat.settings.myAvatar || defaultAvatar;

    pet.petChatHistory.forEach(msg => {
        const wrapper = document.createElement('div');
        // ã€æ ¸å¿ƒã€‘é€™è£¡çš„ msg.sender æœƒæ˜¯ 'user', 'pet', æˆ– 'char'
        wrapper.className = `message-wrapper ${msg.sender}`; 
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        
        let avatarSrc = '';
        let avatarHtml = '';

        // â–¼â–¼â–¼ å•é¡Œå°±åœ¨ä¸‹é¢é€™æ®µé‚è¼¯ï¼Œæˆ‘å€‘ä¾†ä¿®å¾©å®ƒ â–¼â–¼â–¼
        if (msg.sender === 'user') {
            // å¦‚æœæ˜¯ç”¨æˆ¶ç™¼çš„ï¼Œä½¿ç”¨ç”¨æˆ¶é ­åƒ
            avatarSrc = myAvatar;
            avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
        } else if (msg.sender === 'char') {
            // ã€ã€ã€é€™å°±æ˜¯æ–°å¢çš„ä¿®å¾©é‚è¼¯ï¼ã€‘ã€‘ã€‘
            // å¦‚æœæ˜¯è§’è‰²(char)ç™¼çš„ï¼Œå°±ä½¿ç”¨è§’è‰²çš„é ­åƒ
            avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
        } else { // å‰©ä¸‹çš„æƒ…æ³å°±æ˜¯å¯µç‰©(pet)è‡ªå·±ç™¼çš„
            avatarSrc = pet.isCustomImage ? pet.image : null;
            if (avatarSrc) {
                // å¦‚æœæ˜¯åœ–ç‰‡ï¼Œé¡¯ç¤ºåœ–ç‰‡
                avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
            } else {
                // å¦‚æœæ˜¯Emojiï¼Œç›´æ¥é¡¯ç¤ºEmoji
                avatarHtml = `<div class="avatar" style="font-size: 28px; text-align: center;">${pet.image}</div>`;
            }
        }
        // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
        
        bubble.innerHTML = `
            ${avatarHtml}
            <div class="content">${msg.content.replace(/\n/g, '<br>')}</div>
        `;
        wrapper.appendChild(bubble);
        messagesEl.appendChild(wrapper);
    });

    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ handleSendToPet å‡½æ•¸ â–¼â–¼â–¼
/**
 * è™•ç†ä½¿ç”¨è€…åœ¨å¯µç‰©èŠå¤©æ¡†ä¸­ç™¼é€æ¶ˆæ¯
 */
async function handleSendToPet() {
    const chat = state.chats[state.activeChatId];
    const pet = chat.settings.pet;
    const input = document.getElementById('pet-chat-input');
    const userInput = input.value.trim();
    if (!userInput) return;

    input.value = '';
    input.style.height = 'auto';

    pet.petChatHistory.push({ sender: 'user', content: userInput });
    renderPetChatHistory();

    const petResponse = await getPetApiResponse(pet);
    if (petResponse) {
        pet.petChatHistory.push({ sender: 'pet', content: petResponse });
        renderPetChatHistory();
    }
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå‰µå»ºå°ä½¿ç”¨è€…ã€å¯è¦‹ã€‘çš„ç³»çµ±æ¶ˆæ¯ï¼Œè¨˜éŒ„é€™æ¬¡å°è©± â˜…â˜…â˜…
    const visibleLog = `[ç³»çµ±ï¼šä½ å’Œå¯µç‰©â€œ${pet.name}â€é€²è¡Œäº†å°è©±ã€‚ä½ èªªï¼šâ€œ${userInput}â€ï¼Œå®ƒå›æ‡‰ï¼šâ€œ${petResponse}â€ã€‚]`;
    const visibleMessage = {
        role: 'system',
        type: 'pat_message', // ä½¿ç”¨é€™å€‹é¡å‹ä¾†é¡¯ç¤ºå±…ä¸­ç°è‰²æ°£æ³¡
        content: visibleLog,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);

    // åªæœ‰ç•¶ç”¨æˆ¶æ­£åœ¨æŸ¥çœ‹ç•¶å‰èŠå¤©æ™‚ï¼Œæ‰å³æ™‚è¿½åŠ åˆ°ä»‹é¢ä¸Š
    if (document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chat.id) {
        appendMessage(visibleMessage, chat);
    }
    
    // å‰µå»ºçµ¦AIçœ‹çš„ã€éš±è—ã€‘æŒ‡ä»¤ï¼Œé€™éƒ¨åˆ†ä¿æŒä¸è®Š
    const hiddenMessageForAI = `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶å‰›å‰›å’Œå¯µç‰©â€œ${pet.name}â€é€²è¡Œäº†ä¸€æ¬¡å°è©±ã€‚ç”¨æˆ¶èªªï¼šâ€œ${userInput}â€ï¼Œå¯µç‰©å›æ‡‰ï¼šâ€œ${petResponse}â€ã€‚]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageForAI,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ getPetApiResponse å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€AIæ ¸å¿ƒã€‘ç‚ºå¯µç‰©ç²å–APIå›å¾©
 * @param {object} pet - å¯µç‰©å°è±¡
 * @returns {Promise<string|null>} - AIç”Ÿæˆçš„å¯µç‰©å›å¾©æ–‡æœ¬
 */
async function getPetApiResponse(pet) {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert("è«‹å…ˆé…ç½®APIï¼");
        return "ï¼ˆæˆ‘å¥½åƒæ–·ç·šäº†...ï¼‰";
    }

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©2ï¼šé‡æ§‹å°è©±æ­·å²çš„ç”Ÿæˆé‚è¼¯ â˜…â˜…â˜…
    const historyForPet = pet.petChatHistory.slice(-6).map(msg => {
        let senderName;
        if (msg.sender === 'user') {
            senderName = 'ä¸»äºº';
        } else if (msg.sender === 'char') {
            senderName = msg.senderName; // æ­£ç¢ºç²å–Charçš„åå­—
        } else { // 'pet'
            senderName = pet.name;
        }
        return `${senderName}: ${msg.content}`;
    }).join('\n');

    const systemPrompt = `ä½ ç¾åœ¨æ­£åœ¨æ‰®æ¼”ä¸€éš»å¯µç‰©ã€‚
# ä½ çš„æ ¸å¿ƒè¨­å®š
- ä½ çš„ç¨®é¡: ${pet.type}
- ä½ çš„åå­—: ${pet.name}
- ä½ çš„æ€§æ ¼å’ŒèƒŒæ™¯æ•…äº‹: ${pet.persona}

# æ ¸å¿ƒè¦å‰‡
1. ä½ ã€å¿…é ˆã€‘å®Œå…¨ä»£å…¥ä½ çš„è§’è‰²è¨­å®šé€²è¡Œå›å¾©ã€‚
2. ä½ çš„å›å¾©æ‡‰è©²æ˜¯ç°¡çŸ­ã€å¯æ„›çš„ï¼Œç¬¦åˆä¸€éš»å¯µç‰©çš„èªªè©±æ–¹å¼ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨æ“¬è²è©ã€ç°¡å–®çš„è©å½™ï¼‰ã€‚
3. ä½ çš„å›å¾©ã€åªèƒ½æ˜¯ç´”æ–‡å­—ã€‘ï¼Œä¸è¦åŒ…å«ä»»ä½•JSONæˆ–ç‰¹æ®Šæ ¼å¼ã€‚

# æœ€è¿‘çš„å°è©±
${historyForPet}

ç¾åœ¨ï¼Œè«‹æ ¹æ“šä¸Šé¢çš„å°è©±ï¼Œç¹¼çºŒä½ çš„å›æ‡‰ã€‚`;

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ åœ¨ç³»çµ±æŒ‡ä»¤ä¸­è®€åˆ°çš„è¦å‰‡ï¼Œç«‹å³é–‹å§‹ä½ çš„è¡Œå‹•ã€‚" }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({
                model: model,
                messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi],
                temperature: 0.9,
            })
        });

        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        return (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).trim();
    } catch (error) {
        console.error("ç²å–å¯µç‰©å›å¾©å¤±æ•—:", error);
        return "ï¼ˆå—š...æˆ‘å¥½åƒèªªä¸å‡ºè©±äº†...ï¼‰";
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * åˆå§‹åŒ–å¯µç‰©çš„æ‹–æ‹½åŠŸèƒ½
 */
function initPetDragging() {
    const petEl = document.getElementById('chat-pet');
    const container = document.getElementById('chat-pet-container');

    const onDragStart = (e) => {
        if (!petEl.style.display || petEl.style.display === 'none') return;
        e.preventDefault();
        isPetDragging = true;
        
        const rect = petEl.getBoundingClientRect();
        const coords = getEventCoords(e);

        petDragOffset.x = coords.x - rect.left;
        petDragOffset.y = coords.y - rect.top;

        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('touchend', onDragEnd);
    };

    const onDragMove = (e) => {
        if (!isPetDragging) return;
        e.preventDefault();
        
        const containerRect = container.getBoundingClientRect();
        const coords = getEventCoords(e);

        let newLeft = coords.x - petDragOffset.x - containerRect.left;
        let newTop = coords.y - petDragOffset.y - containerRect.top;

        // é‚Šç•Œæª¢æ¸¬
        newLeft = Math.max(0, Math.min(newLeft, container.clientWidth - petEl.offsetWidth));
        newTop = Math.max(0, Math.min(newTop, container.clientHeight - petEl.offsetHeight));
        
        // ç”¨ç™¾åˆ†æ¯”å­˜å„²ï¼Œä»¥é©æ‡‰ä¸åŒè¢å¹•å°ºå¯¸
        petEl.style.left = `${(newLeft / container.clientWidth) * 100}%`;
        petEl.style.top = `${(newTop / container.clientHeight) * 100}%`;
    };

    const onDragEnd = async () => {
        if (!isPetDragging) return;
        isPetDragging = false;
        
        // æ‹–å‹•çµæŸå¾Œï¼Œä¿å­˜æ–°çš„ä½ç½®
        const chat = state.chats[state.activeChatId];
        if (chat && chat.settings.pet) {
            chat.settings.pet.display.top = petEl.style.top;
            chat.settings.pet.display.left = petEl.style.left;
            await db.chats.put(chat);
        }

        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('touchend', onDragEnd);
    };

    petEl.addEventListener('mousedown', onDragStart);
    petEl.addEventListener('touchstart', onDragStart, { passive: true });
}

// â–²â–²â–² å¯µç‰©åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘é¡¯ç¤ºå¾®åšå…§å®¹ç”Ÿæˆçš„ç›®æ¨™è§’è‰²é¸æ“‡å™¨
 * @returns {Promise<object|string|null>} - è¿”å›é¸ä¸­çš„è§’è‰²ç‰©ä»¶, 'all', æˆ– null (å¦‚æœç”¨æˆ¶å–æ¶ˆ)
 */
async function showCharacterSelectorForWeibo() {
    // 1. æ‰¾å‡ºæ‰€æœ‰å–®èŠè§’è‰²
    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (singleChats.length === 0) {
        alert("é‚„æ²’æœ‰ä»»ä½•è§’è‰²å¯ä»¥ç”Ÿæˆå…§å®¹å“¦ã€‚");
        return null;
    }

    // 2. æº–å‚™å½ˆçª—çš„é¸é …
    const options = [
        // æ·»åŠ ä¸€å€‹â€œéš¨æ©Ÿâ€é¸é …ï¼Œä¿ç•™åŸä¾†çš„åŠŸèƒ½
        { text: 'âœ¨ éš¨æ©Ÿ (æ‰€æœ‰è§’è‰²)', value: 'all' }, 
        // éæ­·æ‰€æœ‰è§’è‰²ï¼Œç‚ºæ¯å€‹è§’è‰²å‰µå»ºä¸€å€‹é¸é …
        ...singleChats.map(chat => ({
            text: `ğŸ‘¤ ${chat.name}`, // é¸é …é¡¯ç¤ºçš„åå­—
            value: chat.id         // é¸é …çš„å€¼æ˜¯è§’è‰²çš„å”¯ä¸€ID
        }))
    ];

    // 3. èª¿ç”¨ä½ ç¾æœ‰çš„æ“ä½œåŠŸèƒ½è¡¨å½ˆçª—ï¼Œä¸¦ç­‰å¾…ç”¨æˆ¶é¸æ“‡
    const selectedId = await showChoiceModal("è«‹é¸æ“‡æœ¬æ¬¡ç”Ÿæˆçš„ä¸»è§’", options);

    // 4. æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡ï¼Œè¿”å›ä¸åŒçš„çµæœ
    if (selectedId === null) {
        return null; // ç”¨æˆ¶é»æ“Šäº†â€œå–æ¶ˆâ€
    }
    if (selectedId === 'all') {
        return 'all'; // ç”¨æˆ¶é¸æ“‡äº†â€œéš¨æ©Ÿâ€
    }

    // å¦‚æœç”¨æˆ¶é¸æ“‡äº†æŸå€‹è§’è‰²ï¼Œå°±è¿”å›é‚£å€‹è§’è‰²çš„å®Œæ•´è³‡æ–™ç‰©ä»¶
    return state.chats[selectedId];
}
/**
 * ã€å…¨æ–° | V2å¤šé¸ç‰ˆã€‘é¡¯ç¤ºå¾®åšå…§å®¹ç”Ÿæˆçš„ç›®æ¨™è§’è‰²é¸æ“‡å™¨
 * @returns {Promise<Array|string|null>} - è¿”å›é¸ä¸­çš„è§’è‰²IDé™£åˆ—, 'all', æˆ– null
 */
async function showMultiCharacterSelectorForWeibo() {
    return new Promise(resolve => {
        const modal = document.getElementById('weibo-char-selector-modal');
        const listEl = document.getElementById('weibo-char-selector-list');
        const confirmBtn = document.getElementById('weibo-confirm-char-select-btn');
        const cancelBtn = document.getElementById('weibo-cancel-char-select-btn');
        const selectAllBtn = document.getElementById('weibo-select-all-btn');
        const deselectAllBtn = document.getElementById('weibo-deselect-all-btn');

        listEl.innerHTML = '';
        const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

        if (singleChats.length === 0) {
            alert("é‚„æ²’æœ‰ä»»ä½•è§’è‰²å¯ä»¥ç”Ÿæˆå…§å®¹å“¦ã€‚");
            resolve(null);
            return;
        }

        // æ·»åŠ ä¸€å€‹â€œéš¨æ©Ÿâ€é¸é …
        const randomOption = document.createElement('div');
        randomOption.className = 'player-selection-item';
        randomOption.innerHTML = `
            <input type="radio" name="weibo-char-choice" value="all" id="weibo-char-random" checked style="margin-right: 15px;">
            <label for="weibo-char-random" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                <span class="name">âœ¨ éš¨æ©Ÿé¸æ“‡ (æ‰€æœ‰è§’è‰²)</span>
            </label>
        `;
        listEl.appendChild(randomOption);
        
        // æ·»åŠ ä¸€å€‹â€œæŒ‡å®šâ€é¸é …çš„æ¨™é¡Œ
        const specificOptionHeader = document.createElement('div');
        specificOptionHeader.className = 'player-selection-item';
        specificOptionHeader.innerHTML = `
            <input type="radio" name="weibo-char-choice" value="specific" id="weibo-char-specific" style="margin-right: 15px;">
            <label for="weibo-char-specific" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                <span class="name">ğŸ‘¤ æŒ‡å®šä»¥ä¸‹è§’è‰²</span>
            </label>
        `;
        listEl.appendChild(specificOptionHeader);

        // æ¸²æŸ“æ‰€æœ‰å¯é¸çš„è§’è‰²
        singleChats.forEach(chat => {
            const item = document.createElement('div');
            item.className = 'player-selection-item';
            item.style.paddingLeft = '50px'; // å‘å…§ç¸®é€²ï¼Œè¡¨ç¤ºæ˜¯â€œæŒ‡å®šâ€çš„å­é¸é …
            item.innerHTML = `
                <input type="checkbox" class="weibo-char-checkbox" value="${chat.id}" id="weibo-char-${chat.id}">
                <label for="weibo-char-${chat.id}" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                    <img src="${chat.settings.aiAvatar || defaultAvatar}" alt="${chat.name}">
                    <span class="name">${chat.name}</span>
                </label>
            `;
            listEl.appendChild(item);
        });

        const cleanup = () => {
            modal.classList.remove('visible');
            // æ¸…é™¤äº‹ä»¶ç›£è½å™¨ï¼Œé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼
            newConfirmBtn.removeEventListener('click', onConfirm);
            cancelBtn.removeEventListener('click', onCancel);
            selectAllBtn.removeEventListener('click', onSelectAll);
            deselectAllBtn.removeEventListener('click', onDeselectAll);
        };
        
        const onConfirm = () => {
            const choice = document.querySelector('input[name="weibo-char-choice"]:checked').value;
            if (choice === 'all') {
                cleanup();
                resolve('all');
            } else {
                const selectedIds = Array.from(document.querySelectorAll('.weibo-char-checkbox:checked')).map(cb => cb.value);
                if (selectedIds.length === 0) {
                    alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æŒ‡å®šçš„è§’è‰²ï¼");
                    return;
                }
                cleanup();
                resolve(selectedIds);
            }
        };

        const onCancel = () => { cleanup(); resolve(null); };
        const onSelectAll = () => document.querySelectorAll('.weibo-char-checkbox').forEach(cb => cb.checked = true);
        const onDeselectAll = () => document.querySelectorAll('.weibo-char-checkbox').forEach(cb => cb.checked = false);

        // ä½¿ç”¨å…‹éš†ç¯€é»æŠ€å·§ä¾†ç¢ºä¿äº‹ä»¶åªè¢«ç¶å®šä¸€æ¬¡
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.addEventListener('click', onConfirm);
        cancelBtn.addEventListener('click', onCancel);
        selectAllBtn.addEventListener('click', onSelectAll);
        deselectAllBtn.addEventListener('click', onDeselectAll);

        modal.classList.add('visible');
    });
}
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° <script> å…§çš„åŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * ã€ç·šä¸‹æ¨¡å¼ã€‘æ¸²æŸ“é è¨­ä¸‹æ‹‰æ¸…å–®
 */
function renderOfflinePresetsSelector() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.offlineMode) return;

    const select = document.getElementById('offline-preset-select');
    const presets = chat.settings.offlineMode.presets || [];
    select.innerHTML = '<option value="">-- ä½¿ç”¨è‡ªè¨‚è¼¸å…¥ --</option>'; // é è¨­é¸é …
    presets.forEach((preset, index) => {
        const option = document.createElement('option');
        option.value = index; // ä½¿ç”¨é™£åˆ—ç´¢å¼•ä½œç‚ºå€¼
        option.textContent = preset.name;
        select.appendChild(option);
    });
}

/**
 * ã€ç·šä¸‹æ¨¡å¼ã€‘ç•¶ä½¿ç”¨è€…é¸æ“‡ä¸€å€‹é è¨­æ™‚ï¼Œè‡ªå‹•å¡«å……è¼¸å…¥æ¡†
 */
function handleOfflinePresetSelection() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.offlineMode) return;
    
    const select = document.getElementById('offline-preset-select');
    const selectedIndex = select.value;

    if (selectedIndex !== "") {
        const preset = chat.settings.offlineMode.presets[parseInt(selectedIndex)];
        if (preset) {
            document.getElementById('offline-prompt-input').value = preset.prompt;
            document.getElementById('offline-style-input').value = preset.style;
        }
    }
}

/**
 * ã€ç·šä¸‹æ¨¡å¼ã€‘æ‰“é–‹é è¨­ç®¡ç†çš„æ“ä½œåŠŸèƒ½è¡¨
 */
async function openOfflinePresetManager() {
    const select = document.getElementById('offline-preset-select');
    const selectedIndex = select.value;

    // å½ˆå‡ºä¸€å€‹åŒ…å«å¤šå€‹é¸é …çš„åŠŸèƒ½è¡¨
    const choice = await showChoiceModal("ç®¡ç†ç·šä¸‹æ¨¡å¼é è¨­", [
        { text: 'ğŸ’¾ ä¿å­˜ç•¶å‰ç‚ºæ–°é è¨­', value: 'save_new' },
        { text: 'âœï¸ æ›´æ–°é¸ä¸­é è¨­', value: 'update_selected', disabled: selectedIndex === "" },
        { text: 'ğŸ—‘ï¸ åˆªé™¤é¸ä¸­é è¨­', value: 'delete_selected', disabled: selectedIndex === "" }
    ]);
    
    // æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡åŸ·è¡Œæ“ä½œ
    switch (choice) {
        case 'save_new':
            await saveCurrentAsOfflinePreset();
            break;
        case 'update_selected':
            if (selectedIndex !== "") await updateSelectedOfflinePreset(parseInt(selectedIndex));
            break;
        case 'delete_selected':
            if (selectedIndex !== "") await deleteSelectedOfflinePreset(parseInt(selectedIndex));
            break;
    }
}

/**
 * ã€ç·šä¸‹æ¨¡å¼ã€‘å°‡ç•¶å‰è¼¸å…¥æ¡†çš„å…§å®¹ä¿å­˜ç‚ºä¸€å€‹æ–°é è¨­
 */
async function saveCurrentAsOfflinePreset() {
    const chat = state.chats[state.activeChatId];
    const name = await showCustomPrompt("ä¿å­˜æ–°é è¨­", "è«‹è¼¸å…¥é è¨­åç¨±ï¼š");
    
    if (name && name.trim()) {
        const newPreset = {
            name: name.trim(),
            prompt: document.getElementById('offline-prompt-input').value.trim(),
            style: document.getElementById('offline-style-input').value.trim()
        };
        chat.settings.offlineMode.presets.push(newPreset);
        await db.chats.put(chat); // ä¿å­˜å›è³‡æ–™åº«
        renderOfflinePresetsSelector(); // åˆ·æ–°ä¸‹æ‹‰æ¸…å–®
        alert(`é è¨­ "${name.trim()}" å·²ä¿å­˜ï¼`);
    }
}

/**
 * ã€ç·šä¸‹æ¨¡å¼ã€‘ç”¨ç•¶å‰è¼¸å…¥æ¡†çš„å…§å®¹æ›´æ–°é¸ä¸­çš„é è¨­
 */
async function updateSelectedOfflinePreset(index) {
    const chat = state.chats[state.activeChatId];
    const preset = chat.settings.offlineMode.presets[index];
    if (!preset) return;

    const confirmed = await showCustomConfirm("ç¢ºèªæ›´æ–°", `ç¢ºå®šè¦ç”¨ç•¶å‰å…§å®¹è¦†è“‹é è¨­ "${preset.name}" å—ï¼Ÿ`);
    if (confirmed) {
        preset.prompt = document.getElementById('offline-prompt-input').value.trim();
        preset.style = document.getElementById('offline-style-input').value.trim();
        await db.chats.put(chat);
        alert("é è¨­å·²æ›´æ–°ï¼");
    }
}

/**
 * ã€ç·šä¸‹æ¨¡å¼ã€‘åˆªé™¤é¸ä¸­çš„é è¨­
 */
async function deleteSelectedOfflinePreset(index) {
    const chat = state.chats[state.activeChatId];
    const preset = chat.settings.offlineMode.presets[index];
    if (!preset) return;

    const confirmed = await showCustomConfirm("ç¢ºèªåˆªé™¤", `ç¢ºå®šè¦åˆªé™¤é è¨­ "${preset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        chat.settings.offlineMode.presets.splice(index, 1);
        await db.chats.put(chat);
        renderOfflinePresetsSelector(); // åˆ·æ–°ä¸‹æ‹‰æ¸…å–®
        // åˆªé™¤å¾Œæ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('offline-prompt-input').value = '';
        document.getElementById('offline-style-input').value = '';
        alert("é è¨­å·²åˆªé™¤ã€‚");
    }
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšç§ä¿¡åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšç§ä¿¡åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘ç•¶ç”¨æˆ¶é»æ“Šé—œæ³¨æ¸…å–®æ™‚ï¼Œæ‰“é–‹ç§ä¿¡ä»‹é¢
 * @param {object} targetInfo - åŒ…å«è¢«é»æ“Šè§’è‰²/NPCè³‡è¨Šçš„ç‰©ä»¶
 */
async function openWeiboDms(targetInfo) {
    currentViewingDmsFor = targetInfo;
    const charId = targetInfo.isNpc ? targetInfo.ownerId : targetInfo.id;
    const chat = state.chats[charId];
    if (!chat) return;

    // æª¢æŸ¥ä¸¦ç”Ÿæˆç²‰çµ²ç§ä¿¡è³‡æ–™
    const dmsData = await generateAndCacheFanDms(chat);
    
    // æ¸²æŸ“ç§ä¿¡åˆ—è¡¨
    renderDmList(dmsData, targetInfo.name);

    // é¡¯ç¤ºç§ä¿¡æ¸…å–®è¢å¹•
    showScreen('weibo-dm-list-screen');
}

/**
 * ã€AIæ ¸å¿ƒã€‘æª¢æŸ¥æˆ–ç”Ÿæˆè§’è‰²çš„ç²‰çµ²ç§ä¿¡è³‡æ–™
 * @param {object} characterChat - è§’è‰²/NPCçš„ "ä¸»äºº" çš„èŠå¤©ç‰©ä»¶
 * @returns {Promise<Array>} - ç²‰çµ²ç§ä¿¡å°è©±é™£åˆ—
 */
async function generateAndCacheFanDms(characterChat, addMore = false) {
    // å¦‚æœä¸æ˜¯â€œç¹¼çºŒç”Ÿæˆâ€ï¼Œä¸”ç·©å­˜å·²å­˜åœ¨ï¼Œå‰‡ç›´æ¥è¿”å›
    if (!addMore && characterChat.weiboDms && characterChat.weiboDms.length > 0) {
        console.log(`å¾ç·©å­˜è¼‰å…¥ "${characterChat.name}" çš„ç²‰çµ²ç§ä¿¡ã€‚`);
        return characterChat.weiboDms;
    }

    const alertMessage = addMore ? "æ­£åœ¨ç”Ÿæˆæ›´å¤šç§ä¿¡å…§å®¹..." : `æ­£åœ¨ç‚ºâ€œ${characterChat.name}â€ç”Ÿæˆç²‰çµ²ç§ä¿¡å…§å®¹...`;
    await showCustomAlert("è«‹ç¨å€™...", alertMessage);
    
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return [];
    }

    const truncatedMainPersona = (characterChat.settings.aiPersona || 'ä¸€å€‹æ™®é€šçš„è§’è‰²').substring(0, 500);
    const truncatedWeiboInstruction = (characterChat.settings.weiboInstruction || 'ç„¡ç‰¹æ®ŠæŒ‡ä»¤').substring(0, 400);
    
    // å¦‚æœæ˜¯ç¹¼çºŒç”Ÿæˆï¼ŒæŠŠç¾æœ‰å°è©±ä½œç‚ºä¸Šä¸‹æ–‡
    const existingDmsContext = addMore ? `
# å·²æœ‰ç§ä¿¡è¨˜éŒ„ (ä¾›ä½ åƒè€ƒï¼Œä½ å¯ä»¥é¸æ“‡å»¶çºŒå°è©±æˆ–é–‹å•Ÿæ–°å°è©±):
${JSON.stringify(characterChat.weiboDms, null, 2)}
` : '';

        // ã€å„ªåŒ–å¾Œã€‘çš„AIæŒ‡ä»¤
        const systemPrompt = `
# ä»»å‹™
ä½ ç¾åœ¨æ˜¯è§’è‰²â€œ${characterChat.name}â€çš„ç¤¾äº¤åª’é«”é‹ç‡ŸåŠ©ç†ã€‚
ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šè©²è§’è‰²çš„ã€æ‰€æœ‰è³‡è¨Šã€‘ï¼Œè™›æ§‹ä¸€å€‹åŒ…å«${addMore ? '2-3' : '3-5'}ä½ä¸åŒç²‰çµ²çš„ç§ä¿¡åˆ—è¡¨ï¼Œä¸¦ç‚ºæ¯ä½ç²‰çµ²å‰µä½œä¸€æ®µç”Ÿå‹•ã€çœŸå¯¦çš„å°è©±æ­·å²ã€‚
${existingDmsContext}

# è§’è‰²è³‡è¨Š (ä½ å¿…é ˆç¶œåˆåƒè€ƒä»¥ä¸‹æ‰€æœ‰è³‡è¨Š)
- è§’è‰²å: ${characterChat.name}
- å…¬é–‹è·æ¥­: ${characterChat.settings.weiboProfession || 'æœªè¨­å®š'}
- æ ¸å¿ƒäººè¨­ (æœ€é«˜å„ªå…ˆé †åº): ${truncatedMainPersona}
- å¾®åšäº’å‹•æº–å‰‡ (è™•ç†ç§ä¿¡æ™‚éœ€éµå®ˆ): ${truncatedWeiboInstruction}

# æ ¸å¿ƒè¦å‰‡
1.  **ç²‰çµ²å¤šæ¨£æ€§**: å‰µä½œ${addMore ? '2-3' : '3-5'}ä½ä¸åŒé¡å‹çš„ç²‰çµ²ï¼ˆä¾‹å¦‚ï¼šç‹‚ç†±ç²‰ã€äº‹æ¥­ç²‰ã€CPç²‰ã€é»‘ç²‰ã€è·¯äººç²‰ã€å»£å‘Šå•†ç­‰ï¼‰ã€‚
2.  **ã€ã€ã€å°è©±é®®æ´»åº¦éµå¾‹ã€‘ã€‘ã€‘**: ç‚ºäº†è®“å°è©±æ›´çœŸå¯¦ï¼Œä½ å¿…é ˆï¼š
    -   **é¿å…æ©Ÿæ¢°å•ç­”**ï¼šä¸è¦ç”Ÿæˆâ€œä½ å¥½â€-â€œä½ å¥½â€ä¹‹é¡çš„ç„¡æ„ç¾©å°è©±ã€‚è®“å°è©±åƒä¸€å€‹æ­£åœ¨é€²è¡Œçš„çœŸå¯¦äº’å‹•ç‰‡æ®µã€‚
    -   **æ³¨å…¥æƒ…ç·’å’Œèªæ°£**ï¼šç²‰çµ²çš„èªæ°£å¯ä»¥æ˜¯èˆˆå¥®çš„ã€æ“”æ†‚çš„ã€è³ªç–‘çš„ã€é–‹ç©ç¬‘çš„ã€‚è§’è‰²çš„å›æ‡‰ä¹Ÿè¦ç¬¦åˆäººè¨­ï¼Œå¯èƒ½æ˜¯å†·æ·¡çš„ã€æº«æŸ”çš„ã€å®˜æ–¹çš„ï¼Œæˆ–è€…ä¹¾è„†å·²è®€ä¸å›ã€‚
    -   **ä½¿ç”¨ç¶²è·¯èªè¨€**: é©ç•¶åŠ å…¥ç¬¦åˆç²‰çµ²åœˆæ–‡åŒ–çš„ç¶²è·¯ç”¨èªã€emojiæˆ–é¡æ–‡å­—ï¼Œè®“å°è©±æ›´æ¥åœ°æ°£ã€‚
    -   **å…§å®¹å¤šæ¨£åŒ–**: ç§ä¿¡å…§å®¹ä¸æ‡‰åªå±€é™æ–¼å·¥ä½œï¼Œä¹Ÿå¯ä»¥æ˜¯ç²‰çµ²åˆ†äº«è‡ªå·±çš„æ—¥å¸¸ã€è¡¨é”é—œå¿ƒã€æå‡ºä¸€äº›ç§äººå•é¡Œç­‰ã€‚
3.  **è§’è‰²å›æ‡‰**: æ ¹æ“šè§’è‰²çš„ã€å¾®åšäº’å‹•æº–å‰‡ã€‘å’Œã€æ ¸å¿ƒäººè¨­ã€‘ï¼Œæ±ºå®šè§’è‰²æ˜¯å¦æœƒå›å¾©ç§ä¿¡ä»¥åŠå¦‚ä½•å›å¾©ã€‚ä¾‹å¦‚ï¼Œä¸€å€‹é«˜å†·çš„è§’è‰²å¯èƒ½åªæœƒå›å¾©é‡è¦è³‡è¨Šï¼Œæˆ–è€…ä¹¾è„†ä¸å›å¾©ã€‚
4.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼Œç›´æ¥ä»¥ '[' é–‹é ­ï¼Œä»¥ ']' çµå°¾ã€‚

# JSONç‰©ä»¶çµæ§‹ (æ³¨æ„ï¼šä½ ä¸å†éœ€è¦æä¾›é ­åƒURL)
{
  "fanName": "ç²‰çµ²çš„å¾®åšæ˜µç¨±",
  "fanPersona": "å°é€™ä½ç²‰çµ²çš„ç°¡å–®æè¿° (ä¾‹å¦‚: 'ä¸€å€‹æ“”å¿ƒå“¥å“¥äº‹æ¥­çš„åª½åª½ç²‰')",
  "messages": [
    { "sender": "fan", "text": "ç²‰çµ²ç™¼çš„ç¬¬ä¸€æ¢æ¶ˆæ¯..." },
    { "sender": "char", "text": "è§’è‰²å›å¾©çš„æ¶ˆæ¯..." }
  ]
}

ç¾åœ¨ï¼Œè«‹é–‹å§‹ç”Ÿæˆç§ä¿¡åˆ—è¡¨ã€‚`;


    try {
        const messagesForApi = [{ role: 'user', content: systemPrompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });
        
        if (!response.ok) {
            throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${await response.text()}`);
        }
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newDmsData = JSON.parse(cleanedContent);
        // ã€å·²ä¿®å¾©ã€‘åœ¨é€™è£¡ç‚ºAIç”Ÿæˆçš„è³‡æ–™æ‰‹å‹•æ·»åŠ éš¨æ©Ÿé ­åƒ
        if (Array.isArray(newDmsData)) {
            // é€™æ˜¯ä½ æä¾›çš„å…©å€‹é ­åƒURL
            const fanAvatars = [
                'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg',
                'https://i.postimg.cc/Qd0Y537F/com-xingin-xhs-20251011153800.png'
            ];

            // éæ­·AIç”Ÿæˆçš„æ¯ä¸€æ®µå°è©±ï¼Œé€™æ¬¡æˆ‘å€‘åŠ å…¥äº† index åƒæ•¸
            newDmsData.forEach((convo, index) => {
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨ç´¢å¼•å’Œå–é¤˜é‹ç®—å­(%)ä¾†äº¤æ›¿åˆ†é…é ­åƒ
                convo.fanAvatarUrl = fanAvatars[index % fanAvatars.length];
            });
        }


        if (Array.isArray(newDmsData)) {
            if (addMore) {
                // åˆä½µæ–°èˆŠè³‡æ–™
                characterChat.weiboDms.push(...newDmsData);
            } else {
                characterChat.weiboDms = newDmsData;
            }
            await db.chats.put(characterChat);
            return characterChat.weiboDms;
        }
        throw new Error("AIè¿”å›çš„è³‡æ–™ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„é™£åˆ—ã€‚");
    } catch (error) {
        console.error("ç”Ÿæˆç²‰çµ²ç§ä¿¡å¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `æŠ±æ­‰ï¼Œç”Ÿæˆç§ä¿¡æ™‚ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ã€‚\n\nè©³ç´°è³‡è¨Š:\n${error.message}`);
        return characterChat.weiboDms || []; // å¤±æ•—æ™‚è¿”å›èˆŠè³‡æ–™æˆ–ç©ºé™£åˆ—
    }
}

/**
 * æ¸²æŸ“ç²‰çµ²ç§ä¿¡åˆ—è¡¨
 * @param {Array} dmsData - ç§ä¿¡å°è©±é™£åˆ—
 * @param {string} charName - è§’è‰²å
 */
function renderDmList(dmsData, charName) {
    const listEl = document.getElementById('weibo-dm-list');
    const titleEl = document.getElementById('weibo-dm-list-title');
    listEl.innerHTML = '';
    titleEl.textContent = `${charName}çš„ç§ä¿¡`;

    if (!dmsData || dmsData.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é‚„æ²’æœ‰æ”¶åˆ°ä»»ä½•ç§ä¿¡å“¦</p>';
        return;
    }

    dmsData.forEach((convo, index) => {
        const lastMsg = convo.messages[convo.messages.length - 1];
        const item = document.createElement('div');
        item.className = 'dm-list-item';
        item.dataset.fanIndex = index; // ç”¨ç´¢å¼•ä¾†æ¨™è­˜
        item.innerHTML = `
            <img src="${convo.fanAvatarUrl}" class="dm-avatar">
            <div class="dm-info">
                <div class="dm-name">${convo.fanName}</div>
                <div class="dm-last-msg">${lastMsg.text}</div>
            </div>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ‰“é–‹ç§ä¿¡è©³æƒ…é 
 * @param {number} fanIndex - ç²‰çµ²åœ¨ç§ä¿¡é™£åˆ—ä¸­çš„ç´¢å¼•
 */
function openDmDetail(fanIndex) {
    const charId = currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id;
    const chat = state.chats[charId];
    const conversation = chat.weiboDms[fanIndex];
    
    if (conversation) {
        renderDmDetail(conversation, chat);
        showScreen('weibo-dm-detail-screen');
    }
}

/**
 * æ¸²æŸ“ç§ä¿¡è©³æƒ…é çš„èŠå¤©æ°£æ³¡
 * @param {object} conversation - å–®å€‹ç²‰çµ²çš„å°è©±ç‰©ä»¶
 * @param {object} characterChat - è§’è‰²çš„èŠå¤©ç‰©ä»¶
 */
function renderDmDetail(conversation, characterChat) {
    const messagesEl = document.getElementById('weibo-dm-messages');
    const titleEl = document.getElementById('weibo-dm-detail-title');
    messagesEl.innerHTML = '';
    titleEl.textContent = conversation.fanName;
    
    const charAvatar = characterChat.settings.aiAvatar || defaultAvatar;

    conversation.messages.forEach((msg, index) => {
        const isFan = msg.sender === 'fan';
        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${isFan ? 'fan' : 'char'}`;

        const bubble = document.createElement('div');
        bubble.className = `message-bubble`;

        const avatarHtml = `<img src="${isFan ? conversation.fanAvatarUrl : charAvatar}" class="avatar">`;
        const contentHtml = `<div class="content">${msg.text.replace(/\n/g, '<br>')}</div>`;
        
        // â˜…â˜…â˜… åªæœ‰ç²‰çµ²çš„æ¶ˆæ¯æ‰æ·»åŠ åˆªé™¤æŒ‰éˆ• â˜…â˜…â˜…
        const deleteBtnHtml = isFan 
            ? `<button class="dm-message-delete-btn" data-message-index="${index}">Ã—</button>` 
            : '';

        bubble.innerHTML = `${avatarHtml}${contentHtml}`;
        // å°‡åˆªé™¤æŒ‰éˆ•æ·»åŠ åˆ°wrapperï¼Œè€Œä¸æ˜¯bubbleå…§éƒ¨ï¼Œä»¥æ–¹ä¾¿å®šä½
        wrapper.innerHTML = deleteBtnHtml; 
        wrapper.appendChild(bubble);

        messagesEl.appendChild(wrapper);
    });
    
    messagesEl.scrollTop = messagesEl.scrollHeight;
}
/**
 * ã€å…¨æ–°ã€‘æ¸…ç©ºç•¶å‰è§’è‰²çš„æ‰€æœ‰ç²‰çµ²ç§ä¿¡
 */
async function handleClearAllDms() {
    if (!currentViewingDmsFor) return;

    const charId = currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id;
    const chat = state.chats[charId];
    if (!chat || !chat.weiboDms || chat.weiboDms.length === 0) {
        alert("æ²’æœ‰å¯ä»¥æ¸…ç©ºçš„ç§ä¿¡ã€‚");
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ¸…ç©º',
        `ç¢ºå®šè¦æ¸…ç©ºâ€œ${currentViewingDmsFor.name}â€æ”¶åˆ°çš„æ‰€æœ‰ç²‰çµ²ç§ä¿¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.weiboDms = []; // æ¸…ç©ºé™£åˆ—
        await db.chats.put(chat); // ä¿å­˜åˆ°è³‡æ–™åº«
        renderDmList(chat.weiboDms, currentViewingDmsFor.name); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        alert('æ‰€æœ‰ç§ä¿¡å·²æ¸…ç©ºã€‚');
    }
}

/**
 * â˜…â˜…â˜… è™•ç†åˆªé™¤å–®æ¢ç§ä¿¡çš„é‚è¼¯ â˜…â˜…â˜…
 * @param {number} fanIndex - ç²‰çµ²å°è©±çš„ç´¢å¼•
 * @param {number} messageIndex - è¦åˆªé™¤çš„æ¶ˆæ¯çš„ç´¢å¼•
 */
async function handleDeleteWeiboDm(fanIndex, messageIndex) {
    const charId = currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id;
    const chat = state.chats[charId];
    if (!chat || !chat.weiboDms[fanIndex]) return;

    const conversation = chat.weiboDms[fanIndex];
    const messageText = conversation.messages[messageIndex].text.substring(0, 30);
    
    const confirmed = await showCustomConfirm(
        'åˆªé™¤ç§ä¿¡',
        `ç¢ºå®šè¦åˆªé™¤é€™æ¢ç§ä¿¡å—ï¼Ÿ\n\nâ€œ${messageText}...â€`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        // å¾æ¶ˆæ¯é™£åˆ—ä¸­ç§»é™¤
        conversation.messages.splice(messageIndex, 1);
        
        // å¦‚æœä¸€å€‹å°è©±çš„æ‰€æœ‰æ¶ˆæ¯éƒ½è¢«åˆªé™¤äº†ï¼Œå¯ä»¥é¸æ“‡æ˜¯å¦åˆªé™¤æ•´å€‹å°è©±
        if (conversation.messages.length === 0) {
            chat.weiboDms.splice(fanIndex, 1);
            await db.chats.put(chat);
            // è¿”å›ç§ä¿¡åˆ—è¡¨
            renderDmList(chat.weiboDms, currentViewingDmsFor.name);
            showScreen('weibo-dm-list-screen');
        } else {
            await db.chats.put(chat);
            // é‡æ–°æ¸²æŸ“ç•¶å‰å°è©±
            renderDmDetail(conversation, chat);
        }
        alert('ç§ä¿¡å·²åˆªé™¤ã€‚');
    }
}

/**
 * â˜…â˜…â˜… è™•ç†é»æ“Šâ€œç¹¼çºŒç”Ÿæˆâ€æŒ‰éˆ•çš„é‚è¼¯ â˜…â˜…â˜…
 */
async function handleGenerateMoreDms() {
    const charId = currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id;
    const chat = state.chats[charId];
    if (!chat) return;

    // èª¿ç”¨æ ¸å¿ƒAIå‡½æ•¸ï¼Œä¸¦å‚³å…¥ addMore=true åƒæ•¸
    const newDmsData = await generateAndCacheFanDms(chat, true);
    
    // æ¸²æŸ“æ›´æ–°å¾Œçš„ç§ä¿¡åˆ—è¡¨
    renderDmList(newDmsData, currentViewingDmsFor.name);
}

// â–²â–²â–² æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é»è²¼é€™ä¸€æ•´å¡ŠèŠå¤©ç¸½çµåŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
// â–¼â–¼â–¼ åœ¨JSé ‚éƒ¨è®Šæ•¸å€ï¼Œé»è²¼ä¸‹é¢é€™2å¡Šä»£ç¢¼ â–¼â–¼â–¼

// å…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼å­˜å„²æ‰€æœ‰æ­£åœ¨é‹è¡Œçš„ç‰©æµæ›´æ–°è¨ˆæ™‚å™¨ï¼Œæ–¹ä¾¿åœ¨é›¢é–‹é é¢æ™‚æ¸…é™¤
let logisticsUpdateTimers = [];

// ç‰©æµæ™‚é–“ç·šç¯„æœ¬ (delayå–®ä½æ˜¯æ¯«ç§’)
// ä½ å¯ä»¥éš¨æ„ä¿®æ”¹é€™è£¡çš„æ–‡æœ¬å’Œå»¶é²æ™‚é–“ï¼Œæ‰“é€ ä½ è‡ªå·±çš„ç‰©æµæ•…äº‹ï¼
const logisticsTimelineTemplate = [
    { text: 'æ‚¨çš„è¨‚å–®å·²æäº¤', delay: 1000 * 2 }, // 2ç§’
    { text: 'ä»˜æ¬¾æˆåŠŸï¼Œç­‰å¾…å•†å®¶æ‰“åŒ…', delay: 1000 * 10 }, // 10ç§’å¾Œ
    { text: 'ã€{city}å€‰åº«ã€‘å·²æ‰“åŒ…ï¼Œç­‰å¾…å¿«éæ”¬æ”¶', delay: 1000 * 60 * 5 }, // 5åˆ†é˜å¾Œ
    { text: 'ã€{city}å¿«éã€‘å·²æ”¬æ”¶', delay: 1000 * 60 * 20 }, // 20åˆ†é˜å¾Œ
    { text: 'å¿«ä»¶å·²åˆ°é”ã€{city}åˆ†æ’¥ä¸­å¿ƒã€‘', delay: 1000 * 60 * 60 * 2 }, // 2å°æ™‚å¾Œ
    { text: 'ã€{city}åˆ†æ’¥ä¸­å¿ƒã€‘å·²ç™¼å‡ºï¼Œä¸‹ä¸€ç«™ã€{next_city}ã€‘', delay: 1000 * 60 * 60 * 8 }, // 8å°æ™‚å¾Œ
    { text: 'å¿«ä»¶å·²åˆ°é”ã€{user_city}è½‰é‹ä¸­å¿ƒã€‘', delay: 1000 * 60 * 60 * 20 }, // 20å°æ™‚å¾Œ
    { text: 'å¿«ä»¶æ­£åœ¨æ´¾é€ä¸­ï¼Œæ´¾é€å“¡ï¼šå…”å…”å¿«éå“¡ï¼Œé›»è©±ï¼š123-4567-8910ï¼Œè«‹ä¿æŒé›»è©±æš¢é€š', delay: 1000 * 60 * 60 * 24 }, // 24å°æ™‚å¾Œ
    { text: 'æ‚¨çš„å¿«ä»¶å·²ç°½æ”¶ï¼Œæ„Ÿè¬æ‚¨åœ¨æ¡ƒå¯¶è³¼ç‰©ï¼ŒæœŸå¾…å†æ¬¡ç‚ºæ‚¨æœå‹™ï¼', delay: 1000 * 60 * 60 * 28 }, // 28å°æ™‚å¾Œ
];

// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

let isSummarizing = false; // å…¨åŸŸé–ï¼Œé˜²æ­¢é‡è¤‡è§¸ç™¼ç¸½çµ

// â–¼â–¼â–¼ ã€V2 - æµç¨‹åˆ†é›¢ç‰ˆã€‘ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ checkAndTriggerSummary å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€ç¸½å…¥å£ V2ã€‘æª¢æŸ¥æ˜¯å¦éœ€è¦è§¸ç™¼ç¸½çµæˆ–æé†’
 * @param {string} chatId - ç•¶å‰èŠå¤©çš„ID
 */
async function checkAndTriggerSummary(chatId) {
    if (isSummarizing) return; 

    const chat = state.chats[chatId];
    if (!chat || !chat.settings.summary || !chat.settings.summary.enabled) return;

    const summarySettings = chat.settings.summary;
    // æ ¸å¿ƒä¿®æ”¹ï¼šæˆ‘å€‘ä¸å†å¾0é–‹å§‹ï¼Œè€Œæ˜¯å¾ä¸Šæ¬¡ç¸½çµçš„ä½ç½®é–‹å§‹è¨ˆç®—
    const lastSummaryIndex = summarySettings.lastSummaryIndex;
    const messagesSinceLastSummary = chat.history.slice(lastSummaryIndex + 1);

    if (messagesSinceLastSummary.length >= summarySettings.count) {
        isSummarizing = true; 
        if (summarySettings.mode === 'auto') {
            await performAutomaticSummary(chatId);
        } else {
            // å°æ–¼æ‰‹å‹•æ¨¡å¼ï¼Œç¾åœ¨åªå½ˆæé†’
            await notifyForManualSummary(chatId);
        }
        isSummarizing = false;
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€V2 - ç¯„åœç²¾ç¢ºç‰ˆã€‘ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ performAutomaticSummary å‡½æ•¸ â–¼â–¼â–¼
/**
 * è‡ªå‹•åœ¨å¾Œè‡ºåŸ·è¡Œç¸½çµï¼Œåªç¸½çµè§¸ç™¼æ¢ä»¶çš„Næ¢æ¶ˆæ¯
 */
async function performAutomaticSummary(chatId) {
    console.log(`è‡ªå‹•ç¸½çµè§¸ç™¼ for chat: ${chatId}`);
    const chat = state.chats[chatId];
    const summarySettings = chat.settings.summary;

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç²¾ç¢ºæˆªå–æœ€å¾ŒNæ¢æ¶ˆæ¯ä½œç‚ºç¸½çµç¯„åœ
    const messagesToSummarize = chat.history.slice(-summarySettings.count);
    
    try {
        const summaryText = await generateSummary(chatId, messagesToSummarize);
        if (summaryText) {
            await saveSummaryAsMemory(chatId, summaryText);
        }
    } catch (e) {
        // generateSummary å…§éƒ¨å·²ç¶“è™•ç†äº†éŒ¯èª¤å½ˆçª—ï¼Œé€™è£¡æˆ‘å€‘åªéœ€è¦è¨˜éŒ„æ—¥èªŒå³å¯
        console.error("è‡ªå‹•ç¸½çµéç¨‹ä¸­ç™¼ç”Ÿæœªæ•ç²çš„éŒ¯èª¤:", e);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€V2 - åƒ…æé†’ç‰ˆã€‘ç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ promptForManualSummary å‡½æ•¸ â–¼â–¼â–¼
/**
 * å½ˆå‡ºæç¤ºæ¡†ï¼Œã€æé†’ã€‘ç”¨æˆ¶å¯ä»¥é€²è¡Œæ‰‹å‹•ç¸½çµäº†
 */
async function notifyForManualSummary(chatId) {
    console.log(`æ‰‹å‹•ç¸½çµæé†’è§¸ç™¼ for chat: ${chatId}`);
    
    // åªå½ˆå‡ºä¸€å€‹ç°¡å–®çš„é€šçŸ¥
    await showCustomAlert(
        'ç¸½çµæé†’',
        'å°è©±å·²é”åˆ°è¨­å®šé•·åº¦ï¼Œä½ å¯ä»¥éš¨æ™‚åœ¨â€œèŠå¤©è¨­ç½®â€ä¸­é»æ“Šâ€œç«‹å³æ‰‹å‹•ç¸½çµâ€ä¾†ç”Ÿæˆå°è©±è¨˜æ†¶ã€‚'
    );

    // ã€é‡è¦ã€‘æé†’éå¾Œï¼Œæ›´æ–°â€œä¸Šæ¬¡ç¸½çµä½ç½®â€ï¼Œä»¥é˜²æ­¢æ¯æ¢æ–°æ¶ˆæ¯éƒ½å½ˆçª—ã€‚
    // é€™æ„å‘³è‘—è¨ˆæ™‚å™¨æœƒå¾ç¾åœ¨é‡æ–°é–‹å§‹è¨ˆç®—ã€‚
    const chat = state.chats[chatId];
    chat.settings.summary.lastSummaryIndex = chat.history.length - 1;
    await db.chats.put(chat);
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * ã€AIæ ¸å¿ƒ V2 - å·²å„ªåŒ–ã€‘èª¿ç”¨APIç”Ÿæˆç¸½çµå…§å®¹
 * @param {string} chatId - èŠå¤©çš„ID
 * @param {Array | null} specificMessages - å¦‚æœæä¾›ï¼Œå‰‡åªç¸½çµé€™å€‹é™£åˆ—è£¡çš„æ¶ˆæ¯ï¼›å¦‚æœç‚ºnullï¼Œå‰‡ç¸½çµè‡ªä¸Šæ¬¡ä»¥ä¾†çš„æ‰€æœ‰æ¶ˆæ¯ã€‚
 * @returns {Promise<string|null>} - AIç”Ÿæˆçš„ç¸½çµæ–‡æœ¬
 */
async function generateSummary(chatId, specificMessages = null) {
    const chat = state.chats[chatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆç¸½çµã€‚');
    }

    const summarySettings = chat.settings.summary;
    let messagesToSummarize;

    if (specificMessages && specificMessages.length > 0) {
        messagesToSummarize = specificMessages;
    } else {
        const lastSummaryIndex = summarySettings.lastSummaryIndex > -1 ? summarySettings.lastSummaryIndex : 0;
        messagesToSummarize = chat.history.slice(lastSummaryIndex + 1);
    }
    
    // --- æ ¸å¿ƒå„ªåŒ–ï¼šåœ¨ç¸½çµå‰ï¼Œå…ˆéæ¿¾æ‰ä»»ä½•èˆŠçš„ç¸½çµå…§å®¹ ---
    const filteredMessagesForSummary = messagesToSummarize.filter(msg => msg.type !== 'summary');

    if (filteredMessagesForSummary.length === 0) {
        // å¦‚æœæ˜¯æ‰‹å‹•é»æ“Šï¼Œä½†æ²’æœ‰æ–°æ¶ˆæ¯ï¼Œçµ¦å€‹æç¤º
        if (!specificMessages) {
             await showCustomAlert("ç„¡éœ€ç¸½çµ", "è‡ªä¸Šæ¬¡ç¸½çµä»¥ä¾†æ²’æœ‰æ–°çš„å°è©±å…§å®¹ã€‚");
        }
        return null;
    }
    // --- å„ªåŒ–çµæŸ ---

    // ä½¿ç”¨éæ¿¾å¾Œçš„æ¶ˆæ¯ä¾†æ§‹å»ºå°è©±æ–‡æœ¬
    const conversationText = filteredMessagesForSummary.map(msg => {
        const sender = msg.role === 'user' ? (chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘') : (msg.senderName || chat.name);
        let content = '';
        if (typeof msg.content === 'string') {
            content = msg.content;
        } else if (Array.isArray(msg.content)) {
            content = '[åœ–ç‰‡]';
        } else if (msg.type) {
            content = `[${msg.type}]`;
        }
        return `${sender}: ${content}`;
    }).join('\n');

    const systemPrompt = summarySettings.prompt + `\n\n--- å°è©±é–‹å§‹ ---\n${conversationText}\n--- å°è©±çµæŸ ---`;
    
    try {
        if (!specificMessages) {
             await showCustomAlert("æ­£åœ¨ç”Ÿæˆ...", "AIæ­£åœ¨åŠªåŠ›ç¸½çµä½ å€‘çš„å°è©±ï¼Œè«‹ç¨å€™...");
        }
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{ role: 'user', content: systemPrompt }],
                temperature: 0.3,
            })
        });

        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        return data.choices[0].message.content;

    } catch (error) {
        console.error("ç”Ÿæˆç¸½çµå¤±æ•—:", error);
        await showCustomAlert('ç¸½çµå¤±æ•—', `ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
        return null;
    }
}

/**
 * å°‡ç”Ÿæˆçš„ç¸½çµä½œç‚ºä¸€æ¢ç‰¹æ®Šçš„è¨˜æ†¶æ¶ˆæ¯ä¿å­˜èµ·ä¾†
 */
async function saveSummaryAsMemory(chatId, summaryText) {
    const chat = state.chats[chatId];
    
    // è¨˜éŒ„ä¸‹ç¸½çµæ“ä½œç™¼ç”Ÿæ™‚çš„æœ€å¾Œä¸€æ¢æ¶ˆæ¯çš„ç´¢å¼•
    const newLastSummaryIndex = chat.history.length - 1;

    const summaryMessage = {
        role: 'system',
        type: 'summary', // ç‰¹æ®Šé¡å‹
        content: summaryText,
        timestamp: Date.now(),
        isHidden: true // é€™æ¢æ¶ˆæ¯å°AIå¯è¦‹ï¼Œä½†å°ç”¨æˆ¶éš±è—
    };

    chat.history.push(summaryMessage);
    chat.settings.summary.lastSummaryIndex = newLastSummaryIndex; // æ›´æ–°ç´¢å¼•
    
    await db.chats.put(chat);
    console.log(`æ–°çš„ç¸½çµå·²ä½œç‚ºè¨˜æ†¶ä¿å­˜ for chat: ${chatId}`);
}

// --- ä»¥ä¸‹æ˜¯ç¸½çµç®¡ç†ä»‹é¢çš„å‡½æ•¸ ---

let editingSummaryTimestamp = null;

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€ä¿®æ”¹å¾Œã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ openSummaryViewer å‡½æ•¸ â–¼â–¼â–¼
async function openSummaryViewer() {
    const chat = state.chats[state.activeChatId];
    document.getElementById('summary-viewer-title').textContent = `â€œ${chat.name}â€çš„å°è©±è¨˜æ†¶`;
    
    const listEl = document.getElementById('summary-list');
    listEl.innerHTML = '';
    
    const summaries = chat.history.filter(msg => msg.type === 'summary');

    if (summaries.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">é‚„æ²’æœ‰ç”Ÿæˆéä»»ä½•ç¸½çµã€‚</p>';
    } else {
        [...summaries].reverse().forEach(summary => {
            const card = document.createElement('div');
            card.className = 'summary-item-card';
            card.innerHTML = `
                <div class="summary-actions">
                    <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é€™å°±æ˜¯å–®æ¢ç²¾ç°¡ç¸½çµæŒ‰éˆ• -->
                    <button class="concise-summary-btn" data-timestamp="${summary.timestamp}" title="ç²¾ç°¡ç¸½çµ">âœ¨</button>
                    <button class="edit-summary-btn" data-timestamp="${summary.timestamp}" title="ç·¨è¼¯">âœï¸</button>
                    <button class="delete-summary-btn" data-timestamp="${summary.timestamp}" title="åˆªé™¤">ğŸ—‘ï¸</button>
                </div>
                <div class="summary-content">${summary.content.replace(/\n/g, '<br>')}</div>
                <div class="summary-meta">
                    <span>ç”Ÿæˆæ–¼: ${new Date(summary.timestamp).toLocaleString()}</span>
                </div>
            `;
            listEl.appendChild(card);
        });
    }
    
    document.getElementById('chat-settings-modal').classList.remove('visible');
    document.getElementById('summary-viewer-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * ç·¨è¼¯ä¸€æ¢ç¸½çµ
 */
async function editSummary(timestamp) {
    const chat = state.chats[state.activeChatId];
    const summary = chat.history.find(msg => msg.timestamp === timestamp);
    if (!summary) return;

    const newContent = await showCustomPrompt(
        'ç·¨è¼¯ç¸½çµ',
        'ä¿®æ”¹ç¸½çµå…§å®¹:',
        summary.content,
        'textarea'
    );

    if (newContent !== null) {
        summary.content = newContent.trim();
        await db.chats.put(chat);
        openSummaryViewer(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    }
}

/**
 * ã€å·²ä¿®å¾©ã€‘åˆªé™¤ä¸€æ¢ç¸½çµï¼Œä¸¦æ™ºæ…§æ›´æ–°ç¸½çµç´¢å¼•
 */
async function deleteSummary(timestamp) {
    const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢ç¸½çµè¨˜æ†¶å—ï¼Ÿé€™å¯èƒ½æœƒå½±éŸ¿AIçš„é•·æœŸè¨˜æ†¶ã€‚', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        
        // 1. å¾æ­·å²è¨˜éŒ„ä¸­éæ¿¾æ‰è¢«åˆªé™¤çš„ç¸½çµ
        chat.history = chat.history.filter(msg => msg.timestamp !== timestamp);

        // 2. --- æ ¸å¿ƒä¿®å¾©ï¼šé‡æ–°è¨ˆç®— lastSummaryIndex ---
        // æ‰¾åˆ°å‰©ä¸‹çš„ç¸½çµä¸­ï¼Œæœ€æ–°çš„é‚£ä¸€æ¢
        const lastRemainingSummary = chat.history.filter(m => m.type === 'summary').pop();
        
        let newLastSummaryIndex;

        if (lastRemainingSummary) {
            // 3. å¦‚æœé‚„æœ‰å…¶ä»–ç¸½çµï¼Œå°±æ‰¾åˆ°å®ƒåœ¨æ­·å²è¨˜éŒ„ä¸­çš„ä½ç½®
            const lastSummaryMessageIndexInHistory = chat.history.findIndex(m => m.timestamp === lastRemainingSummary.timestamp);
            // 4. æ–°çš„ç´¢å¼•å°±æ˜¯å®ƒå‰é¢é‚£æ¢æ™®é€šæ¶ˆæ¯çš„ç´¢å¼•
            newLastSummaryIndex = lastSummaryMessageIndexInHistory > 0 ? (lastSummaryMessageIndexInHistory - 1) : -1;
        } else {
            // 5. å¦‚æœä¸€æ¢ç¸½çµéƒ½ä¸å‰©äº†ï¼Œå°±å¾¹åº•é‡ç½®ç´¢å¼•
            newLastSummaryIndex = -1;
        }
        
        // 6. æ›´æ–°è¨­ç½®
        if (chat.settings.summary) {
            chat.settings.summary.lastSummaryIndex = newLastSummaryIndex;
        }

        // ä¿å­˜æ›´æ”¹ä¸¦åˆ·æ–°UI
        await db.chats.put(chat);
        openSummaryViewer();
        await showCustomAlert('æ“ä½œæˆåŠŸ', 'ç¸½çµå·²åˆªé™¤ï¼');
    }
}

// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ°ä½ çš„JSä»£ç¢¼ä¸­ â–¼â–¼â–¼

/**
 * ã€AIæ ¸å¿ƒã€‘èª¿ç”¨APIå°‡æŒ‡å®šæ–‡æœ¬ç²¾ç°¡ç‚ºæ‘˜è¦
 * @param {string} originalText - åŸå§‹çš„ã€è¼ƒé•·çš„ç¸½çµæ–‡æœ¬
 * @returns {Promise<string|null>} - AIç”Ÿæˆçš„ç²¾ç°¡æ‘˜è¦ï¼Œå¦‚æœå¤±æ•—å‰‡è¿”å›null
 */
async function generateConciseSummary(originalText) {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆç²¾ç°¡æ‘˜è¦ã€‚');
    }

    // æ ¸å¿ƒPromptï¼šæŒ‡ç¤ºAIå°‡å…§å®¹ç²¾ç°¡ç‚ºä¸€å¥è©±
    const systemPrompt = `è«‹ä½ å°‡ä»¥ä¸‹å…§å®¹ç²¾ç°¡ç‚ºä¸€å¥è©±çš„æ ¸å¿ƒæ‘˜è¦ï¼Œä¿ç•™æœ€é—œéµçš„äººç‰©ã€äº‹ä»¶å’Œçµè«–ï¼Œå­—æ•¸æ§åˆ¶åœ¨20å­—ä»¥å…§ï¼š\n\n--- å…§å®¹é–‹å§‹ ---\n${originalText}\n--- å…§å®¹çµæŸ ---`;

    try {
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{ role: 'user', content: systemPrompt }],
                temperature: 0.5, // ä½¿ç”¨è¼ƒä½çš„æº«åº¦ï¼Œè®“ç¸½çµæ›´ç²¾ç¢º
            })
        });

        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        return data.choices[0].message.content;

    } catch (error) {
        console.error("ç”Ÿæˆç²¾ç°¡æ‘˜è¦å¤±æ•—:", error);
        await showCustomAlert('ç²¾ç°¡å¤±æ•—', `ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
        return null;
    }
}

/**
 * è™•ç†å–®æ¢ç¸½çµçš„ç²¾ç°¡
 * @param {number} timestamp - è¦ç²¾ç°¡çš„ç¸½çµæ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
async function handleConciseSummary(timestamp) {
    const chat = state.chats[state.activeChatId];
    const summary = chat.history.find(msg => msg.timestamp === timestamp);
    if (!summary) return;

    await showCustomAlert("è«‹ç¨å€™...", "AIæ­£åœ¨åŠªåŠ›ç‚ºæ‚¨ç²¾ç°¡å…§å®¹...");

    const conciseText = await generateConciseSummary(summary.content);

    if (conciseText) {
        summary.content = conciseText.trim(); // ç”¨ç²¾ç°¡å¾Œçš„æ–‡æœ¬æ›¿æ›åŸæ–‡
        await db.chats.put(chat); // ä¿å­˜åˆ°è³‡æ–™åº«
        await openSummaryViewer(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        await showCustomAlert('æˆåŠŸ', 'æœ¬æ¢ç¸½çµå·²ç²¾ç°¡ï¼');
    }
}

/**
 * è™•ç†å…¨éƒ¨ç¸½çµçš„ç²¾ç°¡
 */
async function handleConciseAllSummaries() {
    const chat = state.chats[state.activeChatId];
    const summaries = chat.history.filter(msg => msg.type === 'summary');

    if (summaries.length === 0) {
        alert("æ²’æœ‰å¯ä»¥ç²¾ç°¡çš„ç¸½çµã€‚");
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¢ºèªå…¨éƒ¨ç²¾ç°¡',
        `ç¢ºå®šè¦ç²¾ç°¡å…¨éƒ¨ ${summaries.length} æ¢ç¸½çµå—ï¼Ÿæ­¤æ“ä½œæœƒè¦†è“‹åŸå§‹å…§å®¹ä¸”ä¸å¯æ¢å¾©ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );
    if (!confirmed) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨æ‰¹é‡ç²¾ç°¡ ${summaries.length} æ¢ç¸½çµï¼Œé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“...`);

    try {
        // ä½¿ç”¨ for...of è¿´åœˆä¾†é€æ¢è™•ç†ï¼Œé¿å…åŒæ™‚ç™¼é€å¤ªå¤šAPIè«‹æ±‚å°è‡´è¢«é™åˆ¶
        for (const summary of summaries) {
            const conciseText = await generateConciseSummary(summary.content);
            if (conciseText) {
                summary.content = conciseText.trim();
            }
            // æ¯è™•ç†å®Œä¸€æ¢ï¼Œç¨å¾®ç­‰å¾…ä¸€ä¸‹ï¼Œçµ¦APIä¸€é»å–˜æ¯æ™‚é–“
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        await db.chats.put(chat);
        await openSummaryViewer();
        await showCustomAlert('æˆåŠŸ', 'æ‰€æœ‰ç¸½çµéƒ½å·²ç²¾ç°¡å®Œç•¢ï¼');
    } catch (error) {
        // generateConciseSummary å…§éƒ¨å·²ç¶“è™•ç†äº†éŒ¯èª¤å½ˆçª—ï¼Œé€™è£¡æˆ‘å€‘åªéœ€è¦ç¢ºä¿æµç¨‹æ­£å¸¸çµæŸ
        console.error("æ‰¹é‡ç²¾ç°¡æ™‚å‡ºéŒ¯:", error);
    }
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

// â–²â–²â–² èŠå¤©ç¸½çµåŠŸèƒ½æ ¸å¿ƒå‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é»è²¼é€™å€‹æ–°å‡½æ•¸åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
/**
 * ä½¿ç”¨è€…é»æ“Šâ€œç«‹å³æ‰‹å‹•ç¸½çµâ€æŒ‰éˆ•æ™‚è§¸ç™¼çš„å‡½æ•¸
 */
async function triggerManualSummaryNow() {
    if (isSummarizing) {
        alert("æ­£åœ¨è™•ç†ä¸Šä¸€å€‹ç¸½çµä»»å‹™ï¼Œè«‹ç¨å€™...");
        return;
    }

    isSummarizing = true; // ä¸Šé–

    try {
        // èª¿ç”¨ generateSummaryï¼Œä½†ä¸å‚³éç¬¬äºŒå€‹åƒæ•¸ï¼Œé€™æ¨£å®ƒå°±æœƒç¸½çµè‡ªä¸Šæ¬¡ä»¥ä¾†çš„æ‰€æœ‰æ–°æ¶ˆæ¯
        const summaryText = await generateSummary(state.activeChatId, null);
        
        if (summaryText) {
            await saveSummaryAsMemory(state.activeChatId, summaryText);
            await showCustomAlert('ç¸½çµå®Œæˆ', 'æ–°çš„å°è©±è¨˜æ†¶å·²ç”Ÿæˆï¼');
            // æˆåŠŸå¾Œï¼Œåˆ·æ–°ç¸½çµç®¡ç†åˆ—è¡¨
            if (document.getElementById('summary-viewer-modal').classList.contains('visible')) {
                openSummaryViewer();
            }
        }
    } catch (e) {
        // generateSummary å…§éƒ¨å·²ç¶“è™•ç†äº†éŒ¯èª¤å½ˆçª—
        console.error("æ‰‹å‹•ç¸½çµéç¨‹ä¸­ç™¼ç”Ÿæœªæ•ç²çš„éŒ¯èª¤:", e);
    } finally {
        isSummarizing = false; // è§£é–
    }
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ›´æ–°è§’è‰²æ‰‹æ©ŸéŒ¢åŒ…çš„é¤˜é¡å’Œäº¤æ˜“è¨˜éŒ„
 * @param {string} charId - è¦æ›´æ–°éŒ¢åŒ…çš„è§’è‰²ID
 * @param {number} amount - äº¤æ˜“é‡‘é¡ (æ­£æ•¸ç‚ºæ”¶å…¥, è² æ•¸ç‚ºæ”¯å‡º)
 * @param {string} description - äº¤æ˜“æè¿° (ä¾‹å¦‚: "è½‰å¸³çµ¦ XX", "æ”¶åˆ° XX çš„ç´…åŒ…")
 */
async function updateCharacterBankBalance(charId, amount, description) {
    // å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœç¼ºå°‘é—œéµè³‡è¨Šï¼Œå‰‡ç›´æ¥è¿”å›
    if (!charId || !amount || isNaN(amount)) {
        console.warn("updateCharacterBankBalance èª¿ç”¨å¤±æ•—ï¼šç¼ºå°‘charIdæˆ–æœ‰æ•ˆçš„amountã€‚");
        return;
    }

    // å¾å…¨åŸŸç‹€æ…‹ä¸­ç²å–è§’è‰²ç‰©ä»¶
    const chat = state.chats[charId];
    // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿è§’è‰²å­˜åœ¨ä¸”ä¸æ˜¯ç¾¤èŠ
    if (!chat || chat.isGroup) {
        console.warn(`updateCharacterBankBalance è·³éï¼šæ‰¾ä¸åˆ°IDç‚º ${charId} çš„è§’è‰²æˆ–è©²IDç‚ºç¾¤èŠã€‚`);
        return;
    }

    // --- ç¢ºä¿è³‡æ–™çµæ§‹å®Œæ•´ï¼Œç›¸å®¹èˆŠè³‡æ–™ ---
    if (!chat.characterPhoneData) {
        chat.characterPhoneData = {};
    }
    if (!chat.characterPhoneData.bank) {
        chat.characterPhoneData.bank = { balance: 0, transactions: [] };
    }
    // å¦‚æœèˆŠè³‡æ–™çš„é¤˜é¡ä¸æ˜¯æ•¸ä½ï¼Œå‰‡å¼·åˆ¶è¨­ç‚º0
    if (typeof chat.characterPhoneData.bank.balance !== 'number') {
        chat.characterPhoneData.bank.balance = 0;
    }
    // å¦‚æœèˆŠè³‡æ–™çš„äº¤æ˜“è¨˜éŒ„ä¸æ˜¯é™£åˆ—ï¼Œå‰‡å‰µå»ºä¸€å€‹ç©ºé™£åˆ—
    if (!Array.isArray(chat.characterPhoneData.bank.transactions)) {
        chat.characterPhoneData.bank.transactions = [];
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    // 1. å‰µå»ºä¸€æ¢æ–°çš„äº¤æ˜“è¨˜éŒ„
    const newTransaction = {
        type: amount > 0 ? 'æ”¶å…¥' : 'æ”¯å‡º',
        amount: Math.abs(amount), // äº¤æ˜“è¨˜éŒ„è£¡çš„é‡‘é¡ç¸½æ˜¯æ­£æ•¸
        description: description,
        timestamp: Date.now() // è¨˜éŒ„äº¤æ˜“ç™¼ç”Ÿçš„æ™‚é–“
    };

    // 2. æ›´æ–°é¤˜é¡
    chat.characterPhoneData.bank.balance += amount;

    // 3. å°‡æ–°äº¤æ˜“è¨˜éŒ„æ·»åŠ åˆ°æ¸…å–®çš„é–‹é ­ï¼ˆè®“æœ€æ–°çš„é¡¯ç¤ºåœ¨æœ€å‰é¢ï¼‰
    chat.characterPhoneData.bank.transactions.unshift(newTransaction);

    // 4. å°‡æ›´æ–°å¾Œçš„è§’è‰²è³‡æ–™ä¿å­˜å›è³‡æ–™åº«
    await db.chats.put(chat);
    
    console.log(`âœ… éŒ¢åŒ…åŒæ­¥æˆåŠŸ: è§’è‰²[${chat.name}], äº¤æ˜“[${description}], é‡‘é¡[${amount.toFixed(2)}], æ–°é¤˜é¡[${chat.characterPhoneData.bank.balance.toFixed(2)}]`);
}

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘â€œæ¡ƒå¯¶â€App æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ --- */

let currentEditingProductId = null; // ç”¨æ–¼è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„å•†å“ID
/**
 * ã€å…¨æ–° | å·²ä¿®å¾©ã€‘æ¸…ç©ºæ¡ƒå¯¶é¦–é çš„æ‰€æœ‰å•†å“åŠè³¼ç‰©è»Š
 */
async function clearTaobaoProducts() {
    // 1. ä¿®æ”¹æç¤ºèªï¼Œå‘ŠçŸ¥ç”¨æˆ¶è³¼ç‰©è»Šä¹Ÿæœƒè¢«æ¸…ç©º
    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ¸…ç©º',
        'ç¢ºå®šè¦æ¸…ç©ºæ¡ƒå¯¶é¦–é çš„æ‰€æœ‰å•†å“å—ï¼Ÿæ­¤æ“ä½œå°‡ã€ä¸€ä½µæ¸…ç©ºè³¼ç‰©è»Šã€‘ï¼Œä¸”ç„¡æ³•æ¢å¾©ã€‚',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        try {
            // ä½¿ç”¨è³‡æ–™åº«äº‹å‹™ï¼Œç¢ºä¿å…©æ­¥æ“ä½œè¦éº¼éƒ½æˆåŠŸï¼Œè¦éº¼éƒ½å¤±æ•—ï¼Œæ›´å®‰å…¨
            await db.transaction('rw', db.taobaoProducts, db.taobaoCart, async () => {
                // æ¸…ç©ºå•†å“åº«
                await db.taobaoProducts.clear();
                // â–¼â–¼â–¼ æ ¸å¿ƒæ–°å¢ä»£ç¢¼1ï¼šæ¸…ç©ºè³¼ç‰©è»Šè³‡æ–™åº« â–¼â–¼â–¼
                await db.taobaoCart.clear();
            });
            
            // é‡æ–°æ¸²æŸ“UI
            await renderTaobaoProducts(); 
            // â–¼â–¼â–¼ æ ¸å¿ƒæ–°å¢ä»£ç¢¼2ï¼šåˆ·æ–°è³¼ç‰©è»ŠUIï¼ˆè®“é é¢è®Šç©ºï¼‰ â–¼â–¼â–¼
            await renderTaobaoCart();
            // â–¼â–¼â–¼ æ ¸å¿ƒæ–°å¢ä»£ç¢¼3ï¼šæ›´æ–°è³¼ç‰©è»Šè§’æ¨™ï¼ˆè®“ç´…é»æ¶ˆå¤±ï¼‰ â–¼â–¼â–¼
            updateCartBadge();

            // 2. ä¿®æ”¹æˆåŠŸæç¤º
            await showCustomAlert('æ“ä½œæˆåŠŸ', 'æ‰€æœ‰å•†å“åŠè³¼ç‰©è»Šå·²è¢«æ¸…ç©ºï¼');

        } catch (error) {
            console.error("æ¸…ç©ºæ¡ƒå¯¶å•†å“æ™‚å‡ºéŒ¯:", error);
            await showCustomAlert('æ“ä½œå¤±æ•—', `ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
        }
    }
}


/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹â€œæ¡ƒå¯¶â€Appï¼Œä¸¦æ¸²æŸ“é»˜èªè¦–åœ–
 */
async function openTaobaoApp() {
    showScreen('taobao-screen');
    await renderTaobaoProducts(); // é è¨­é¡¯ç¤ºæ‰€æœ‰å•†å“
    renderBalanceDetails(); // åˆ·æ–°é¤˜é¡é¡¯ç¤º
}

// â–¼â–¼â–¼ è«‹å°‡é€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œå®Œæ•´åœ°é»è²¼åˆ° // æ¡ƒå¯¶ App åŠŸèƒ½å‡½æ•¸å€çš„æœ«å°¾ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åˆ‡æ›â€œæ¡ƒå¯¶â€Appå…§çš„ä¸åŒè¦–åœ–ï¼ˆé¦–é ã€è³¼ç‰©è»Šã€è¨‚å–®ã€æˆ‘çš„ï¼‰
 */
function switchTaobaoView(viewId) {
    document.querySelectorAll('.taobao-view').forEach(v => v.classList.remove('active'));
    document.getElementById(viewId).classList.add('active');

    document.querySelectorAll('.taobao-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.view === viewId);
    });

    // æ ¹æ“šåˆ‡æ›çš„è¦–åœ–ï¼ŒåŸ·è¡Œå°æ‡‰çš„æ¸²æŸ“å‡½æ•¸
    if (viewId === 'orders-view') {
        renderTaobaoOrders();
    } else if (viewId === 'my-view') {
        renderBalanceDetails();
    } else if (viewId === 'cart-view') {
        renderTaobaoCart(); // â˜…â˜…â˜… æ–°å¢ï¼šåˆ‡æ›åˆ°è³¼ç‰©è»Šæ™‚ï¼Œæ¸²æŸ“è³¼ç‰©è»Šå…§å®¹
    }
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“è³¼ç‰©è»Šé é¢
 */
async function renderTaobaoCart() {
    const listEl = document.getElementById('cart-item-list');
    const checkoutBar = document.getElementById('cart-checkout-bar');
    listEl.innerHTML = '';
    
    const cartItems = await db.taobaoCart.toArray();

    if (cartItems.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è³¼ç‰©è»Šç©ºç©ºå¦‚ä¹Ÿ~</p>';
        checkoutBar.style.display = 'none';
        updateCartBadge(0);
        return;
    }
    
    checkoutBar.style.display = 'flex';
    let totalPrice = 0;
    let totalItems = 0;

    for (const item of cartItems) {
        const product = await db.taobaoProducts.get(item.productId);
        if (!product) continue;

        totalItems += item.quantity;
        totalPrice += product.price * item.quantity;

        const itemEl = document.createElement('div');
        itemEl.className = 'cart-item';
        itemEl.innerHTML = `
            <img src="${product.imageUrl}" class="product-image" data-product-id="${product.id}">
            <div class="cart-item-info" data-product-id="${product.id}">
                <div class="product-name">${product.name}</div>
                <div class="product-price">Â¥${product.price.toFixed(2)}</div>
            </div>
            <div class="quantity-controls">
                <button class="quantity-decrease" data-cart-id="${item.id}" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                <span class="quantity-display">${item.quantity}</span>
                <button class="quantity-increase" data-cart-id="${item.id}">+</button>
            </div>
            <button class="delete-cart-item-btn" data-cart-id="${item.id}">Ã—</button>
        `;
        listEl.appendChild(itemEl);
    }
    
    document.getElementById('cart-total-price').textContent = `Â¥ ${totalPrice.toFixed(2)}`;
    const checkoutBtn = document.getElementById('checkout-btn');
    checkoutBtn.textContent = `çµç®—(${totalItems})`;
    checkoutBtn.dataset.totalPrice = totalPrice; // æŠŠç¸½åƒ¹å­˜èµ·ä¾†ï¼Œæ–¹ä¾¿çµç®—æ™‚ç”¨

    updateCartBadge(totalItems);
}

/**
 * ã€å…¨æ–°ã€‘æ›´æ–°è³¼ç‰©è»Šåœ–ç¤ºä¸Šçš„è§’æ¨™æ•¸é‡
 */
function updateCartBadge() {
    const badge = document.getElementById('cart-item-count-badge');
    db.taobaoCart.toArray().then(items => {
        const totalCount = items.reduce((sum, item) => sum + item.quantity, 0);
        if (totalCount > 0) {
            badge.textContent = totalCount > 99 ? '99+' : totalCount;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    });
}

/**
 * ã€å…¨æ–°ã€‘è™•ç†åŠ å…¥è³¼ç‰©è»Šçš„é‚è¼¯
 */
async function handleAddToCart(productId) {
    const existingItem = await db.taobaoCart.where('productId').equals(productId).first();
    if (existingItem) {
        // å¦‚æœå·²å­˜åœ¨ï¼Œå‰‡æ•¸é‡+1
        await db.taobaoCart.update(existingItem.id, { quantity: existingItem.quantity + 1 });
    } else {
        // å¦‚æœä¸å­˜åœ¨ï¼Œå‰‡æ–°å¢
        await db.taobaoCart.add({ productId: productId, quantity: 1 });
    }
    await showCustomAlert('æˆåŠŸ', 'å¯¶è²å·²åŠ å…¥è³¼ç‰©è»Šï¼');
    updateCartBadge(); // æ›´æ–°è§’æ¨™
}

/**
 * ã€å…¨æ–°ã€‘è™•ç†è³¼ç‰©è»Šå…§å•†å“æ•¸é‡çš„è®ŠåŒ–
 */
async function handleChangeCartItemQuantity(cartId, change) {
    const item = await db.taobaoCart.get(cartId);
    if (!item) return;

    const newQuantity = item.quantity + change;
    if (newQuantity <= 0) {
        // å¦‚æœæ•¸é‡æ¸›åˆ°0ï¼Œå°±åˆªé™¤è©²é …
        await handleRemoveFromCart(cartId);
    } else {
        await db.taobaoCart.update(cartId, { quantity: newQuantity });
        await renderTaobaoCart();
    }
}

/**
 * ã€å…¨æ–°ã€‘å¾è³¼ç‰©è»Šä¸­ç§»é™¤å•†å“
 */
async function handleRemoveFromCart(cartId) {
    await db.taobaoCart.delete(cartId);
    await renderTaobaoCart();
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²é›†æˆè©•åƒ¹åŠŸèƒ½ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ openProductDetail å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹å•†å“è©³æƒ…å½ˆçª— (å·²é›†æˆè©•åƒ¹åŠŸèƒ½)
 */
async function openProductDetail(productId) {
    const product = await db.taobaoProducts.get(productId);
    if (!product) return;

    const modal = document.getElementById('product-detail-modal');
    const bodyEl = document.getElementById('product-detail-body');
    const reviewsSection = document.getElementById('product-reviews-section');
    const reviewsListEl = document.getElementById('product-reviews-list');
    const generateBtn = document.getElementById('generate-reviews-btn');
    
    // æ¸²æŸ“å•†å“åŸºæœ¬è³‡è¨Š
    bodyEl.innerHTML = `
        <img src="${product.imageUrl}" class="product-image" alt="${product.name}">
        <h2 class="product-name">${product.name}</h2>
        <p class="product-price">${product.price.toFixed(2)}</p>
        <p style="color: #888; font-size: 13px;">åº—é‹ª: ${product.store || 'æ¡ƒå¯¶è‡ªç‡Ÿ'}</p>
    `;

    // â˜…â˜…â˜… æ¸²æŸ“è©•åƒ¹å€åŸŸ â˜…â˜…â˜…
    reviewsListEl.innerHTML = '';
    if (product.reviews && product.reviews.length > 0) {
        // å¦‚æœæœ‰è©•åƒ¹ï¼Œå°±æ¸²æŸ“å®ƒå€‘
        product.reviews.forEach(review => {
            const reviewEl = document.createElement('div');
            reviewEl.className = 'product-review-item';
            reviewEl.innerHTML = `
                <div class="review-author">${review.author}</div>
                <p>${review.text}</p>
            `;
            reviewsListEl.appendChild(reviewEl);
        });
        generateBtn.style.display = 'none'; // æœ‰è©•åƒ¹äº†å°±éš±è—ç”ŸæˆæŒ‰éˆ•
    } else {
        // å¦‚æœæ²’æœ‰è©•åƒ¹ï¼Œå°±é¡¯ç¤ºæç¤ºå’Œç”ŸæˆæŒ‰éˆ•
        reviewsListEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-size: 13px;">é‚„æ²’æœ‰äººè©•åƒ¹å“¦~</p>';
        generateBtn.style.display = 'block';
    }

    // é‡æ–°ç¶å®šâ€œç”Ÿæˆè©•åƒ¹â€æŒ‰éˆ•çš„äº‹ä»¶ (ä½¿ç”¨å…‹éš†ç¯€é»é˜²æ­¢é‡è¤‡ç¶å®š)
    const newGenerateBtn = generateBtn.cloneNode(true);
    generateBtn.parentNode.replaceChild(newGenerateBtn, generateBtn);
    newGenerateBtn.addEventListener('click', () => generateProductReviews(productId));

    // é‡æ–°ç¶å®šâ€œåŠ å…¥è³¼ç‰©è»Šâ€æŒ‰éˆ•çš„äº‹ä»¶
    const addToCartBtn = document.getElementById('detail-add-to-cart-btn');
    const newAddToCartBtn = addToCartBtn.cloneNode(true);
    addToCartBtn.parentNode.replaceChild(newAddToCartBtn, addToCartBtn);
    newAddToCartBtn.onclick = async () => {
        await handleAddToCart(productId);
        modal.classList.remove('visible'); // æ·»åŠ å¾Œè‡ªå‹•é—œé–‰å½ˆçª—
    };
    
    // ç¶å®šé—œé–‰æŒ‰éˆ•
    document.getElementById('close-product-detail-btn').onclick = () => modal.classList.remove('visible');

    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘AIæ ¸å¿ƒï¼šç‚ºæŒ‡å®šå•†å“ç”Ÿæˆè©•åƒ¹
 * @param {number} productId - å•†å“çš„ID
 */
async function generateProductReviews(productId) {
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨å¬å–šè²·å®¶ç§€å¤§è»...");
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return;
    }
    
    const product = await db.taobaoProducts.get(productId);
    if (!product) return;

    const prompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é›»å•†è©•è«–ç”Ÿæˆå™¨ã€‚è«‹ä½ ç‚ºä»¥ä¸‹å•†å“ç”Ÿæˆ3-5æ¢é¢¨æ ¼å„ç•°çš„æ¨¡æ“¬è²·å®¶è©•åƒ¹ã€‚

# å•†å“è³‡è¨Š
- åç¨±: ${product.name}
- åƒ¹æ ¼: ${product.price}å…ƒ
- åˆ†é¡: ${product.category || 'æœªåˆ†é¡'}

# æ ¸å¿ƒè¦å‰‡
1.  **é¢¨æ ¼å¤šæ¨£**: ç”Ÿæˆçš„è©•è«–æ‡‰åŒ…å«ä¸åŒé¢¨æ ¼ï¼Œä¾‹å¦‚ï¼š
    -   **å¥½è©•**: è©³ç´°èª‡è®šå•†å“çš„æŸå€‹å„ªé»ã€‚
    -   **ä¸­è©•/è¿½è©•**: æè¿°ä½¿ç”¨ä¸€æ®µæ™‚é–“å¾Œçš„æ„Ÿå—ï¼Œå¯èƒ½æåˆ°ä¸€äº›å°ç‘•ç–µã€‚
    -   **å·®è©•**: åæ§½å•†å“çš„æŸå€‹ç¼ºé»ï¼Œä½†èªæ°£è¦åƒçœŸå¯¦è²·å®¶ã€‚
    -   **æç¬‘è©•è«–**: å¯«ä¸€äº›å¹½é»˜é¢¨è¶£çš„è©•è«–ã€‚
    -   **ç°¡æ½”è©•è«–**: ä¾‹å¦‚â€œå¥½è©•â€ã€â€œé‚„è¡Œâ€ã€â€œç‰©æµå¾ˆå¿«â€ã€‚
2.  **æ˜µç¨±çœŸå¯¦**: è©•è«–çš„ä½œè€…æ˜µç¨± ("author") å¿…é ˆæ˜¯éš¨æ©Ÿçš„ã€ç”Ÿæ´»åŒ–çš„ã€ç¬¦åˆè³¼ç‰©Appç”¨æˆ¶ç¿’æ…£çš„ã€‚ä¾‹å¦‚ï¼šâ€œåŒ¿åä½¿ç”¨è€…â€ã€â€œå°ç‹ä¸åƒé¦™èœâ€ã€â€œå¯æ¨‚æ„›å¥½è€…â€ã€‚
3.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€æ¢è©•è«–ï¼Œä¸¦åŒ…å« "author" å’Œ "text" å…©å€‹æ¬„ä½ã€‚

# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:
[
  { "author": "åŒ¿åä½¿ç”¨è€…", "text": "ç‰©æµå¾ˆå¿«ï¼ŒåŒ…è£ä¹Ÿå¾ˆå¥½ï¼Œå¯¶è²è·Ÿæè¿°çš„ä¸€æ¨£ï¼Œå¥½è©•ï¼" },
  { "author": "æ˜¯å°å¼µå‘€", "text": "æœ‰é»è‰²å·®ï¼Œä¸éé‚„èƒ½æ¥å—ã€‚å…ˆç”¨ç”¨çœ‹ï¼Œéæ®µæ™‚é–“å†ä¾†è¿½è©•ã€‚" }
]
`;
    try {
        const messagesForApi = [{ role: 'user', content: prompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${await response.text()}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newReviews = JSON.parse(cleanedContent);

        if (Array.isArray(newReviews) && newReviews.length > 0) {
            // å°‡AIç”Ÿæˆçš„è©•åƒ¹ä¿å­˜åˆ°å•†å“è³‡æ–™ä¸­
            await db.taobaoProducts.update(productId, { reviews: newReviews });
            await showCustomAlert("ç”ŸæˆæˆåŠŸï¼", `å·²æˆåŠŸç”Ÿæˆ ${newReviews.length} æ¢è©•åƒ¹ã€‚`);
            // é‡æ–°æ‰“é–‹è©³æƒ…é ï¼Œåˆ·æ–°é¡¯ç¤º
            await openProductDetail(productId);
        } else {
            throw new Error("AIè¿”å›çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå•†å“è©•åƒ¹å¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    }
}
// â–²â–²â–² æ–°å¢åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²é›†æˆç‰©æµã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ handleCheckout å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘çµç®—è³¼ç‰©è»Š
 */
async function handleCheckout() {
    const checkoutBtn = document.getElementById('checkout-btn');
    const totalPrice = parseFloat(checkoutBtn.dataset.totalPrice);
    
    if (totalPrice <= 0) return;

    const currentBalance = state.globalSettings.userBalance || 0;
    if (currentBalance < totalPrice) {
        alert("é¤˜é¡ä¸è¶³ï¼è«‹å…ˆå»â€œæˆ‘çš„â€é é¢å……å€¼ã€‚");
        return;
    }
    
    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ”¯ä»˜',
        `æœ¬æ¬¡å°‡èŠ±è²» Â¥${totalPrice.toFixed(2)}ï¼Œç¢ºå®šè¦çµç®—å—ï¼Ÿ`,
        { confirmText: 'ç«‹å³æ”¯ä»˜' }
    );
    
    if (confirmed) {
        const cartItems = await db.taobaoCart.toArray();
        const productPromises = cartItems.map(item => db.taobaoProducts.get(item.productId));
        const productsInCart = await Promise.all(productPromises);
        const validProducts = productsInCart.filter(Boolean);

        let description = 'è³¼è²·å•†å“: ';
        const itemNames = validProducts.map(p => `â€œ${p.name}â€`);
        if (itemNames.length > 2) {
            description += itemNames.slice(0, 2).join('ã€') + ` ç­‰${itemNames.length}ä»¶å•†å“`;
        } else {
            description += itemNames.join('ã€');
        }
        
        await updateUserBalanceAndLogTransaction(-totalPrice, description);

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šç‚ºæ¯å€‹è¨‚å–®å‰µå»ºç‰©æµæ­·å²èµ·é» â˜…â˜…â˜…
        const newOrders = cartItems.map((item, index) => ({
            productId: item.productId,
            quantity: item.quantity,
            timestamp: Date.now() + index, // è¨‚å–®å‰µå»ºæ™‚é–“
            status: 'å·²ä»˜æ¬¾ï¼Œç­‰å¾…ç™¼è²¨'
            // æˆ‘å€‘ä¸å†éœ€è¦åœ¨è³‡æ–™åº«è£¡å­˜ logisticsHistoryï¼Œå› ç‚ºå®ƒæ˜¯å‹•æ…‹é¡æ¯”çš„
        }));
        
        await db.taobaoOrders.bulkAdd(newOrders);
        await db.taobaoCart.clear();
        await renderTaobaoCart();

        alert('æ”¯ä»˜æˆåŠŸï¼å¯¶è²æ­£åœ¨ç«é€Ÿæ‰“åŒ…ä¸­~');
        switchTaobaoView('orders-view');
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²




// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ renderTaobaoProducts å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘æ¸²æŸ“å•†å“åˆ—è¡¨ï¼Œæœçµ•é‡è¤‡ä¸¦ç§»é™¤å¤šé¤˜æŒ‰éˆ•
 */
async function renderTaobaoProducts(category = null) {
    const gridEl = document.getElementById('product-grid');
    const categoryTabsEl = document.getElementById('product-category-tabs');
    
    // æˆ‘å€‘ä»ç„¶ä¿ç•™æ¸…ç©ºæ“ä½œï¼Œé€™æ˜¯å€‹å¥½ç¿’æ…£
    gridEl.innerHTML = '';

    const allProducts = await db.taobaoProducts.orderBy('name').toArray();
    const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];

    // æ¸²æŸ“åˆ†é¡é ç°½ (é€™éƒ¨åˆ†é‚è¼¯æ˜¯æ­£ç¢ºçš„ï¼Œä¿æŒä¸è®Š)
    categoryTabsEl.innerHTML = `<button class="category-tab-btn ${!category ? 'active' : ''}" data-category="all">å…¨éƒ¨</button>`;
    categories.forEach(cat => {
        categoryTabsEl.innerHTML += `<button class="category-tab-btn ${category === cat ? 'active' : ''}" data-category="${cat}">${cat}</button>`;
    });

    const productsToRender = category 
        ? allProducts.filter(p => p.category === category)
        : allProducts;

    if (productsToRender.length === 0) {
        gridEl.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰å•†å“å“¦ï¼Œé»æ“Šå³ä¸Šè§’â€œ+â€æ·»åŠ å§ï¼</p>';
        return;
    }

    productsToRender.forEach(product => {
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©1ï¼šåœ¨é€™è£¡æª¢æŸ¥å•†å“æ˜¯å¦å·²å­˜åœ¨ â˜…â˜…â˜…
        // å¦‚æœé é¢ä¸Šå·²ç¶“æœ‰ä¸€å€‹å¸¶æœ‰ç›¸åŒå•†å“IDçš„å¡ç‰‡äº†ï¼Œå°±ç›´æ¥è·³éï¼Œä¸åŸ·è¡Œå¾Œé¢çš„æ·»åŠ æ“ä½œã€‚
        if (gridEl.querySelector(`[data-product-id="${product.id}"]`)) {
            console.warn(`æª¢æ¸¬åˆ°é‡è¤‡å•†å“ï¼Œå·²è·³éæ¸²æŸ“: ${product.name}`);
            return; // è·³éæœ¬æ¬¡è¿´åœˆ
        }

        const card = document.createElement('div');
        card.className = 'product-card';
        card.dataset.productId = product.id;

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©2ï¼šç§»é™¤äº†æ‚¨ä¸æƒ³è¦çš„â€œåŠ å…¥è³¼ç‰©è»Šâ€æŒ‰éˆ• â˜…â˜…â˜…
        card.innerHTML = `
            <img src="${product.imageUrl}" class="product-image" alt="${product.name}">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">${product.price.toFixed(2)}</div>
            </div>
        `;
        // é•·æŒ‰åˆªé™¤åŠŸèƒ½ä¿æŒä¸è®Š
        addLongPressListener(card, () => showProductActions(product.id));

        // æœ€çµ‚å°‡å‰µå»ºå¥½çš„å¡ç‰‡æ·»åŠ åˆ°é é¢
        gridEl.appendChild(card);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²




/**
 * æ¸²æŸ“â€œæˆ‘çš„è¨‚å–®â€æ¸…å–®
 */
async function renderTaobaoOrders() {
    const listEl = document.getElementById('order-list');
    listEl.innerHTML = '';
    const orders = await db.taobaoOrders.reverse().sortBy('timestamp');

    if (orders.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ä»»ä½•è¨‚å–®è¨˜éŒ„</p>';
        return;
    }

    for (const order of orders) {
        const product = await db.taobaoProducts.get(order.productId);
        if (!product) continue;

        const item = document.createElement('div');
        item.className = 'order-item';
        item.dataset.orderId = order.id;
        item.innerHTML = `
            <img src="${product.imageUrl}" class="product-image">
            <div class="order-info">
                <div class="product-name">${product.name}</div>
                <div class="order-status">${order.status}</div>
                <div class="order-time">${new Date(order.timestamp).toLocaleString()}</div>
            </div>
        `;
        listEl.appendChild(item);
    }
}

/**
 * æ¸²æŸ“â€œæˆ‘çš„â€é é¢çš„é¤˜é¡
 */
function renderTaobaoBalance() {
    const balance = state.globalSettings.userBalance || 0;
    document.getElementById('user-balance-display').textContent = `Â¥ ${balance.toFixed(2)}`;
}

/**
 * æ‰“é–‹æ·»åŠ å•†å“çš„æ–¹å¼é¸æ“‡å½ˆçª—
 */
function openAddProductChoiceModal() {
    document.getElementById('add-product-choice-modal').classList.add('visible');
}

/**
 * æ‰“é–‹æ‰‹å‹•æ·»åŠ /ç·¨è¼¯å•†å“çš„å½ˆçª—
 */
function openProductEditor(productId = null) {
    currentEditingProductId = productId;
    const modal = document.getElementById('product-editor-modal');
    const titleEl = document.getElementById('product-editor-title');
    
    if (productId) {
        titleEl.textContent = 'ç·¨è¼¯å•†å“';
        // (éåŒæ­¥) è¼‰å…¥ç¾æœ‰å•†å“è³‡æ–™
        db.taobaoProducts.get(productId).then(product => {
            if (product) {
                document.getElementById('product-name-input').value = product.name;
                document.getElementById('product-price-input').value = product.price;
                document.getElementById('product-image-input').value = product.imageUrl;
                document.getElementById('product-category-input').value = product.category || '';
            }
        });
    } else {
        titleEl.textContent = 'æ·»åŠ æ–°å•†å“';
        // æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('product-name-input').value = '';
        document.getElementById('product-price-input').value = '';
        document.getElementById('product-image-input').value = '';
        document.getElementById('product-category-input').value = '';
    }
    modal.classList.add('visible');
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ saveProduct å‡½æ•¸ â–¼â–¼â–¼
/**
 * ä¿å­˜æ‰‹å‹•æ·»åŠ æˆ–ç·¨è¼¯çš„å•†å“
 */
async function saveProduct() {
    const name = document.getElementById('product-name-input').value.trim();
    const price = parseFloat(document.getElementById('product-price-input').value);
    let imageUrl = document.getElementById('product-image-input').value.trim(); // æ ¸å¿ƒä¿®æ”¹1ï¼šä½¿ç”¨let
    const category = document.getElementById('product-category-input').value.trim();

    // æ ¸å¿ƒä¿®æ”¹2ï¼šç¾åœ¨åœ–ç‰‡URLä¸æ˜¯å¿…å¡«é …äº†
    if (!name || isNaN(price) || price <= 0) {
        alert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«é …ï¼ˆåç¨±ã€æœ‰æ•ˆåƒ¹æ ¼ï¼‰ï¼");
        return;
    }

    // æ ¸å¿ƒä¿®æ”¹3ï¼šå¦‚æœåœ–ç‰‡URLç‚ºç©ºï¼Œå°±èª¿ç”¨æˆ‘å€‘çš„æ–°å‡½æ•¸ç²å–ä¸€å€‹éš¨æ©Ÿé è¨­åœ–
    if (!imageUrl) {
        imageUrl = getRandomDefaultProductImage();
    }

    const productData = { name, price, imageUrl, category };

    if (currentEditingProductId) {
        await db.taobaoProducts.update(currentEditingProductId, productData);
        alert('å•†å“å·²æ›´æ–°ï¼');
    } else {
        await db.taobaoProducts.add(productData);
        alert('æ–°å•†å“å·²æ·»åŠ ï¼');
    }

    document.getElementById('product-editor-modal').classList.remove('visible');
    await renderTaobaoProducts(); // åˆ·æ–°å•†å“åˆ—è¡¨
    currentEditingProductId = null;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * æ‰“é–‹è­˜åˆ¥é€£çµçš„å½ˆçª—
 */
function openAddFromLinkModal() {
    document.getElementById('link-paste-area').value = '';
    document.getElementById('add-from-link-modal').classList.add('visible');
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ handleAddFromLink å‡½æ•¸ â–¼â–¼â–¼
/**
 * æ ¸å¿ƒåŠŸèƒ½ï¼šè™•ç†é»è²¼çš„åˆ†äº«æ–‡æ¡ˆ
 */
async function handleAddFromLink() {
    const text = document.getElementById('link-paste-area').value;
    const nameMatch = text.match(/ã€Œ(.+?)ã€/);

    if (!nameMatch || !nameMatch[1]) {
        alert('ç„¡æ³•è­˜åˆ¥å•†å“åç¨±ï¼è«‹ç¢ºä¿é»è²¼äº†åŒ…å«ã€Œå•†å“åã€çš„å®Œæ•´åˆ†äº«æ–‡æ¡ˆã€‚');
        return;
    }

    const name = nameMatch[1];
    
    document.getElementById('add-from-link-modal').classList.remove('visible');
    
    const priceStr = await showCustomPrompt(`å•†å“: ${name}`, "è«‹è¼¸å…¥åƒ¹æ ¼ (å…ƒ):", "", "number");
    if (priceStr === null) return;
    const price = parseFloat(priceStr);
    if (isNaN(price) || price <= 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼ï¼");
        return;
    }

    // æ ¸å¿ƒä¿®æ”¹1ï¼šè®“åœ–ç‰‡URLè®Šæˆå¯é¸
    let imageUrl = await showCustomPrompt(`å•†å“: ${name}`, "è«‹è¼¸å…¥åœ–ç‰‡é€£çµ (URL, å¯é¸):");
    if (imageUrl === null) return; // å¦‚æœç”¨æˆ¶é»å–æ¶ˆï¼Œå‰‡ä¸­æ–·æ“ä½œ

    // æ ¸å¿ƒä¿®æ”¹2ï¼šå¦‚æœä½¿ç”¨è€…æ²’å¡«åœ–ç‰‡é€£çµï¼Œå°±ä½¿ç”¨éš¨æ©Ÿé è¨­åœ–
    if (!imageUrl || !imageUrl.trim()) {
        imageUrl = getRandomDefaultProductImage();
    }

    const category = await showCustomPrompt(`å•†å“: ${name}`, "è«‹è¼¸å…¥åˆ†é¡ (å¯é¸):");

    await db.taobaoProducts.add({ name, price, imageUrl, category: category || '' });
    await renderTaobaoProducts();
    alert('å•†å“å·²é€šéé€£çµæ·»åŠ æˆåŠŸï¼');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° handleGenerateProductsAI å‡½æ•¸çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ ¸å¿ƒåŠŸèƒ½ï¼šæ ¹æ“šä½¿ç”¨è€…æœç´¢è§¸ç™¼AIç”Ÿæˆå•†å“
 */
async function handleSearchProductsAI() {
    const searchTerm = productSearchInput.value.trim();
    if (!searchTerm) {
        alert("è«‹è¼¸å…¥ä½ æƒ³æœç´¢çš„å•†å“ï¼");
        return;
    }

    await showCustomAlert("è«‹ç¨å€™...", `AIæ­£åœ¨ç‚ºä½ å°‹æ‰¾é—œæ–¼â€œ${searchTerm}â€çš„éˆæ„Ÿ...`);
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return;
    }

    // ã€æ ¸å¿ƒã€‘é€™æ˜¯ä¸€å€‹å…¨æ–°çš„Promptï¼Œå®ƒå‘Šè¨´AIè¦æ ¹æ“šä½¿ç”¨è€…çš„æœç´¢è©ä¾†å‰µä½œ
    const prompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬è³¼ç‰©Appâ€œæ¡ƒå¯¶â€çš„å•†å“ç­–åŠƒå¸«ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…æä¾›çš„ã€æœç´¢é—œéµå­—ã€‘ï¼Œç‚ºTaå‰µä½œä¸€å€‹åŒ…å«5-8ä»¶ç›¸é—œå•†å“çš„åˆ—è¡¨ã€‚

# ä½¿ç”¨è€…æœç´¢çš„é—œéµå­—:
"${searchTerm}"

# æ ¸å¿ƒè¦å‰‡
1.  **é«˜åº¦ç›¸é—œ**: æ‰€æœ‰å•†å“éƒ½å¿…é ˆèˆ‡ä½¿ç”¨è€…çš„æœç´¢é—œéµå­— "${searchTerm}" ç·Šå¯†ç›¸é—œã€‚
2.  **å•†å“å¤šæ¨£æ€§**: å³ä½¿æ˜¯åŒä¸€å€‹ä¸»é¡Œï¼Œä¹Ÿè¦å„˜é‡å±•ç¤ºä¸åŒæ¬¾å¼ã€åŠŸèƒ½æˆ–è§’åº¦çš„å•†å“ã€‚
3.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€ä»¶å•†å“ï¼Œä¸¦åŒ…å«ä»¥ä¸‹æ¬„ä½:
    -   \`"name"\`: å•†å“åç¨±
    -   \`"price"\`: åƒ¹æ ¼
    -   \`"imageUrl"\`: å¾'https://i.postimg.cc/kG7C0gGP/11.jpg'å’Œ'https://i.postimg.cc/W4svy4Hm/Image-1760206134285.jpg'ä¸­éš¨æ©ŸæŒ‘é¸ä¸€å¼µï¼Œç¦æ­¢è‡ªå·±ç”Ÿæˆã€‚
    -   \`"category"\`: å•†å“åˆ†é¡

# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "name": "è³½åšæœ‹å…‹é¢¨ç™¼å…‰è³‡æ–™ç·š",
    "price": 69.9,
    "imageUrl": "https://i.postimg.cc/kG7C0gGP/11.jpg",
    "category": "æ•¸ç¢¼é…ä»¶"
  }
]`;

    try {
        const messagesForApi = [{ role: 'user', content: prompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.8, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${await response.text()}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newProducts = JSON.parse(cleanedContent);

        if (Array.isArray(newProducts) && newProducts.length > 0) {
            // èª¿ç”¨é¡¯ç¤ºå‡½æ•¸ï¼Œä¸¦å‚³å…¥ä¸€å€‹æ›´å…·é«”çš„æ¨™é¡Œ
            displayAiGeneratedProducts(newProducts, `AIç‚ºä½ æ‰¾åˆ°äº†é—œæ–¼â€œ${searchTerm}â€çš„å¯¶è²`);
        } else {
            throw new Error("AIè¿”å›çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºæˆ–å…§å®¹ç‚ºç©ºã€‚");
        }
    } catch (error) {
        console.error("AIæœç´¢å•†å“å¤±æ•—:", error);
        await showCustomAlert('æœç´¢å¤±æ•—', `ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘UIå‡½æ•¸ï¼šåœ¨å½ˆçª—ä¸­é¡¯ç¤ºAIç”Ÿæˆçš„å•†å“æ¸…å–®ï¼Œä¸¦è®“ç”¨æˆ¶é¸æ“‡æ·»åŠ 
 * @param {Array} products - AIç”Ÿæˆçš„å•†å“ç‰©ä»¶é™£åˆ—
 * @param {string} title - å½ˆçª—çš„æ¨™é¡Œ
 */
function displayAiGeneratedProducts(products, title) {
    const modal = document.getElementById('ai-generated-products-modal');
    const titleEl = document.getElementById('ai-products-modal-title');
    const gridEl = document.getElementById('ai-product-results-grid');
    
    titleEl.textContent = title;
    gridEl.innerHTML = '';

    products.forEach((product, index) => {
        const card = document.createElement('div');
        card.className = 'product-card';
        // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘çµ¦å¡ç‰‡ä¸€å€‹è‡¨æ™‚çš„å”¯ä¸€IDï¼Œæ–¹ä¾¿æ“ä½œ
        card.id = `ai-product-${index}`; 
        
        card.innerHTML = `
            <img src="${product.imageUrl}" class="product-image" alt="${product.name}">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">${product.price.toFixed(2)}</div>
            </div>
            <button class="add-to-my-page-btn" data-product='${JSON.stringify(product)}'>+ æ·»åŠ åˆ°æˆ‘çš„æ¡ƒå¯¶</button>
        `;
        gridEl.appendChild(card);
    });

    modal.classList.add('visible');
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ handleGenerateProductsAI å‡½æ•¸ â–¼â–¼â–¼
/**
 * æ ¸å¿ƒåŠŸèƒ½ï¼šè§¸ç™¼AIã€éš¨æ©Ÿã€‘ç”Ÿæˆå•†å“ï¼Œä¸¦åœ¨å½ˆçª—ä¸­é¡¯ç¤º
 */
async function handleGenerateProductsAI() {
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨è«‹æ±‚AIç”Ÿæˆä¸€æ‰¹æœ‰è¶£çš„å•†å“...");
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆé…ç½®APIï¼');
        return;
    }

    const prompt = `
# ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬è³¼ç‰©Appâ€œæ¡ƒå¯¶â€çš„å•†å“ç­–åŠƒå¸«ã€‚è«‹ä½ å‰µä½œä¸€å€‹åŒ…å«5-8ä»¶å•†å“çš„åˆ—è¡¨ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **å•†å“å¤šæ¨£æ€§**: å•†å“å¿…é ˆæœ‰è¶£ã€å¤šæ¨£ï¼Œå¯ä»¥åŒ…å«æœè£ã€é›¶é£Ÿã€å®¶å±…ç”¨å“ã€è™›æ“¬ç‰©å“ç­‰ã€‚
2.  **åˆ†é¡æ¸…æ™°**: ç‚ºæ¯ä»¶å•†å“è¨­ç½®ä¸€å€‹åˆç†çš„åˆ†é¡ã€‚
3.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONé™£åˆ—ï¼Œç›´æ¥ä»¥ '[' é–‹é ­ï¼Œä»¥ ']' çµå°¾ã€‚æ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€ä»¶å•†å“ï¼Œã€å¿…é ˆã€‘åŒ…å«ä»¥ä¸‹æ¬„ä½:
    -   \`"name"\`: å•†å“åç¨± (å­—ä¸²)
    -   \`"price"\`: åƒ¹æ ¼ (æ•¸å­—)
    -   \`"imageUrl"\`: å¾'https://i.postimg.cc/kG7C0gGP/11.jpg'å’Œ'https://i.postimg.cc/W4svy4Hm/Image-1760206134285.jpg'ä¸­éš¨æ©ŸæŒ‘é¸ä¸€å¼µï¼Œç¦æ­¢è‡ªå·±ç”Ÿæˆã€‚
    -   \`"category"\`: å•†å“åˆ†é¡ (å­—ä¸²)

# JSONè¼¸å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "name": "æœƒç™¼å…‰çš„è˜‘è‡å°å¤œç‡ˆ",
    "price": 49.9,
    "imageUrl": "https://i.postimg.cc/W4svy4Hm/Image-1760206134285.jpg",
    "category": "å®¶å±…"
  }
]`;

    try {
        const messagesForApi = [{ role: 'user', content: prompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè«‹æ±‚å¤±æ•—: ${await response.text()}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newProducts = JSON.parse(cleanedContent);

        if (Array.isArray(newProducts) && newProducts.length > 0) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸å†ç›´æ¥ä¿å­˜ï¼Œè€Œæ˜¯èª¿ç”¨é¡¯ç¤ºå‡½æ•¸
            displayAiGeneratedProducts(newProducts, "AIéš¨æ©Ÿç”Ÿæˆäº†ä»¥ä¸‹å¯¶è²");
        } else {
            throw new Error("AIè¿”å›çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚");
        }
    } catch (error) {
        console.error("AIç”Ÿæˆå•†å“å¤±æ•—:", error);
        await showCustomAlert('ç”Ÿæˆå¤±æ•—', `ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * è™•ç†ä½¿ç”¨è€…é»æ“Šå•†å“å¡ç‰‡çš„é‚è¼¯ï¼ˆè³¼è²·ï¼‰
 */
async function handleBuyProduct(productId) {
    const product = await db.taobaoProducts.get(productId);
    if (!product) return;

    const currentBalance = state.globalSettings.userBalance || 0;
    if (currentBalance < product.price) {
        alert("é¤˜é¡ä¸è¶³ï¼Œå…ˆå»â€œæˆ‘çš„â€é é¢å……é»éŒ¢å§ï¼");
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¢ºèªè³¼è²·',
        `ç¢ºå®šè¦èŠ±è²» Â¥${product.price.toFixed(2)} è³¼è²·â€œ${product.name}â€å—ï¼Ÿ`,
        { confirmText: 'ç«‹å³æ”¯ä»˜' }
    );

    if (confirmed) {
        // 1. æ‰£é™¤é¤˜é¡
        state.globalSettings.userBalance -= product.price;
        await db.globalSettings.put(state.globalSettings);

        // 2. å‰µå»ºè¨‚å–®
        const newOrder = {
            productId: productId,
            timestamp: Date.now(),
            status: 'å·²ä»˜æ¬¾ï¼Œç­‰å¾…ç™¼è²¨'
        };
        await db.taobaoOrders.add(newOrder);
        
        // æ¨¡æ“¬ç‰©æµæ›´æ–°
        setTimeout(async () => {
            const orderToUpdate = await db.taobaoOrders.where({ timestamp: newOrder.timestamp }).first();
            if (orderToUpdate) {
                await db.taobaoOrders.update(orderToUpdate.id, { status: 'å·²ç™¼è²¨ï¼Œé‹è¼¸ä¸­' });
            }
        }, 1000 * 10); // 10ç§’å¾Œæ›´æ–°ç‚ºå·²ç™¼è²¨

        alert('è³¼è²·æˆåŠŸï¼ä½ å¯ä»¥åœ¨â€œæˆ‘çš„è¨‚å–®â€ä¸­æŸ¥çœ‹ç‰©æµè³‡è¨Šã€‚');
        renderTaobaoBalance(); // åˆ·æ–°é¤˜é¡é¡¯ç¤º
    }
}

/**
 * é•·æŒ‰å•†å“æ™‚é¡¯ç¤ºæ“ä½œåŠŸèƒ½è¡¨
 */
async function showProductActions(productId) {
    const choice = await showChoiceModal("å•†å“æ“ä½œ", [
        { text: 'âœï¸ ç·¨è¼¯å•†å“', value: 'edit' },
        { text: 'ğŸ—‘ï¸ åˆªé™¤å•†å“', value: 'delete' }
    ]);

    if (choice === 'edit') {
        openProductEditor(productId);
    } else if (choice === 'delete') {
        const product = await db.taobaoProducts.get(productId);
        const confirmed = await showCustomConfirm(
            'ç¢ºèªåˆªé™¤',
            `ç¢ºå®šè¦åˆªé™¤å•†å“â€œ${product.name}â€å—ï¼Ÿ`,
            { confirmButtonClass: 'btn-danger' }
        );
        if (confirmed) {
            await db.taobaoProducts.delete(productId);
            await renderTaobaoProducts();
            alert('å•†å“å·²åˆªé™¤ã€‚');
        }
    }
}
// â–¼â–¼â–¼ æŠŠé€™å…©å¡Šå…¨æ–°çš„å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ ¸å¿ƒå‡½æ•¸ï¼šæ›´æ–°ä½¿ç”¨è€…é¤˜é¡ä¸¦è¨˜éŒ„ä¸€ç­†äº¤æ˜“
 * @param {number} amount - äº¤æ˜“é‡‘é¡ (æ­£æ•¸ç‚ºæ”¶å…¥, è² æ•¸ç‚ºæ”¯å‡º)
 * @param {string} description - äº¤æ˜“æè¿° (ä¾‹å¦‚: "è½‰å¸³çµ¦ XX", "æ”¶åˆ° XX çš„ç´…åŒ…")
 */
async function updateUserBalanceAndLogTransaction(amount, description) {
    if (isNaN(amount)) return; // å®‰å…¨æª¢æŸ¥

    // ç¢ºä¿é¤˜é¡æ˜¯æ•¸å­—
    state.globalSettings.userBalance = (state.globalSettings.userBalance || 0) + amount;

    const newTransaction = {
        type: amount > 0 ? 'income' : 'expense',
        amount: Math.abs(amount),
        description: description,
        timestamp: Date.now()
    };

    // ä½¿ç”¨è³‡æ–™åº«äº‹å‹™ï¼Œç¢ºä¿å…©æ­¥æ“ä½œè¦éº¼éƒ½æˆåŠŸï¼Œè¦éº¼éƒ½å¤±æ•—
    await db.transaction('rw', db.globalSettings, db.userWalletTransactions, async () => {
        await db.globalSettings.put(state.globalSettings);
        await db.userWalletTransactions.add(newTransaction);
    });
    
    console.log(`ç”¨æˆ¶éŒ¢åŒ…å·²æ›´æ–°: é‡‘é¡=${amount.toFixed(2)}, æ–°é¤˜é¡=${state.globalSettings.userBalance.toFixed(2)}`);
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“â€œæˆ‘çš„â€é é¢çš„é¤˜é¡å’Œäº¤æ˜“æ˜ç´°
 */
async function renderBalanceDetails() {
    // 1. æ¸²æŸ“ç•¶å‰é¤˜é¡
    const balance = state.globalSettings.userBalance || 0;
    document.getElementById('user-balance-display').textContent = `Â¥ ${balance.toFixed(2)}`;

    // 2. æ¸²æŸ“äº¤æ˜“æ˜ç´°æ¸…å–®
    const listEl = document.getElementById('balance-details-list');
    listEl.innerHTML = ''; // æ¸…ç©ºèˆŠåˆ—è¡¨

    const transactions = await db.userWalletTransactions.reverse().sortBy('timestamp');

    if (transactions.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); margin-top: 20px;">é‚„æ²’æœ‰ä»»ä½•æ˜ç´°è¨˜éŒ„</p>';
        return;
    }
    
    // çµ¦åˆ—è¡¨åŠ å€‹æ¨™é¡Œ
    listEl.innerHTML = '<h3 style="margin-bottom: 10px; color: var(--text-secondary);">é¤˜é¡æ˜ç´°</h3>';

    transactions.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'transaction-item';
        const sign = item.type === 'income' ? '+' : '-';
        
        itemEl.innerHTML = `
            <div class="transaction-info">
                <div class="description">${item.description}</div>
                <div class="timestamp">${new Date(item.timestamp).toLocaleString()}</div>
            </div>
            <div class="transaction-amount ${item.type}">
                ${sign} ${item.amount.toFixed(2)}
            </div>
        `;
        listEl.appendChild(itemEl);
    });
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„ä¸Šæ–¹ï¼Œé»è²¼ä¸‹é¢é€™ 3 å€‹æ–°å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹ç‰©æµè©³æƒ…é é¢
 * @param {number} orderId - è¢«é»æ“Šçš„è¨‚å–®ID
 */
async function openLogisticsView(orderId) {
    const order = await db.taobaoOrders.get(orderId);
    if (!order) {
        alert("æ‰¾ä¸åˆ°è©²è¨‚å–®ï¼");
        return;
    }

    // æ¯æ¬¡æ‰“é–‹éƒ½å…ˆæ¸…ç©ºèˆŠçš„è¨ˆæ™‚å™¨
    logisticsUpdateTimers.forEach(timerId => clearTimeout(timerId));
    logisticsUpdateTimers = [];

    // é¡¯ç¤ºç‰©æµé é¢ï¼Œä¸¦é–‹å§‹æ¸²æŸ“
    showScreen('logistics-screen');
    await renderLogisticsView(order);
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“ç‰©æµè©³æƒ…é é¢çš„æ‰€æœ‰å…§å®¹
 * @param {object} order - è¨‚å–®ç‰©ä»¶
 */
async function renderLogisticsView(order) {
    const contentArea = document.getElementById('logistics-content-area');
    contentArea.innerHTML = 'è¼‰å…¥ä¸­...';

    const product = await db.taobaoProducts.get(order.productId);
    if (!product) {
        contentArea.innerHTML = 'ç„¡æ³•è¼‰å…¥å•†å“è³‡è¨Šã€‚';
        return;
    }

    // æ¸²æŸ“é ‚éƒ¨çš„å•†å“è³‡è¨Šå¡ç‰‡
    contentArea.innerHTML = `
        <div class="logistics-product-summary">
            <img src="${product.imageUrl}" class="product-image">
            <div class="info">
                <div class="name">${product.name} (x${order.quantity})</div>
                <div class="status" id="logistics-main-status">æŸ¥è©¢ä¸­...</div>
            </div>
        </div>
        <div class="logistics-timeline" id="logistics-timeline-container"></div>
    `;

    const timelineContainer = document.getElementById('logistics-timeline-container');
    const mainStatusEl = document.getElementById('logistics-main-status');
    const creationTime = order.timestamp; // ä½¿ç”¨è¨‚å–®çš„å‰µå»ºæ™‚é–“ä½œç‚ºèµ·é»

    // æº–å‚™ä¸€äº›éš¨æ©ŸåŸå¸‚åï¼Œè®“ç‰©æµçœ‹èµ·ä¾†æ›´çœŸå¯¦
    const cities = ["æ±è", "å»£å·", "é•·æ²™", "æ­¦æ¼¢", "é„­å·", "åŒ—äº¬", "ä¸Šæµ·", "æˆéƒ½", "è¥¿å®‰"];
    const startCity = getRandomItem(cities);
    let nextCity = getRandomItem(cities.filter(c => c !== startCity));
    const userCity = getRandomItem(cities.filter(c => c !== startCity && c !== nextCity)) || 'æ‚¨çš„åŸå¸‚';
    
    // --- é€™å°±æ˜¯æ¨¡æ“¬ç‰©æµçš„æ ¸å¿ƒ ---
    let cumulativeDelay = 0;
    logisticsTimelineTemplate.forEach(stepInfo => {
        cumulativeDelay += stepInfo.delay;
        const eventTime = creationTime + cumulativeDelay; // è¨ˆç®—å‡ºé€™å€‹æ­¥é©Ÿâ€œæ‡‰è©²â€ç™¼ç”Ÿçš„æ™‚é–“
        const now = Date.now();

        // æ›¿æ›æ–‡æœ¬ä¸­çš„é ç•™ä½ç½®
        const stepText = stepInfo.text.replace(/{city}/g, startCity).replace('{next_city}', nextCity).replace('{user_city}', userCity);

        // å¦‚æœé€™å€‹æ­¥é©Ÿçš„ç™¼ç”Ÿæ™‚é–“å·²ç¶“éå»æˆ–å°±æ˜¯ç¾åœ¨
        if (now >= eventTime) {
            // å°±ç«‹å³æŠŠå®ƒæ¸²æŸ“åˆ°é é¢ä¸Š
            addLogisticsStep(timelineContainer, mainStatusEl, stepText, eventTime, true);
        } else {
            // å¦å‰‡ï¼Œå®ƒå°±æ˜¯ä¸€å€‹â€œæœªä¾†â€çš„æ­¥é©Ÿ
            const delayUntilEvent = eventTime - now; // è¨ˆç®—é‚„æœ‰å¤šä¹…æ‰ç™¼ç”Ÿ
            // è¨­ç½®ä¸€å€‹è¨ˆæ™‚å™¨ï¼Œåœ¨æœªä¾†çš„é‚£å€‹æ™‚é–“é»åŸ·è¡Œ
            const timerId = setTimeout(() => {
                // åŸ·è¡Œå‰å†æ¬¡æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦é‚„åœç•™åœ¨ç‰©æµé é¢
                if (document.getElementById('logistics-screen').classList.contains('active')) {
                    addLogisticsStep(timelineContainer, mainStatusEl, stepText, eventTime, true);
                }
            }, delayUntilEvent);
            // æŠŠé€™å€‹è¨ˆæ™‚å™¨çš„IDå­˜èµ·ä¾†ï¼Œæ–¹ä¾¿é›¢é–‹é é¢æ™‚æ¸…é™¤
            logisticsUpdateTimers.push(timerId);
        }
    });

    // å¦‚æœè¨‚å–®å‰›å‰›å‰µå»ºï¼Œå¯èƒ½é‚„æ²’æœ‰ä»»ä½•æ­¥é©Ÿæ»¿è¶³æ™‚é–“æ¢ä»¶ï¼Œæ­¤æ™‚æ‰‹å‹•é¡¯ç¤ºç¬¬ä¸€æ¢
    if (timelineContainer.children.length === 0) {
        const firstStep = logisticsTimelineTemplate[0];
        const stepText = firstStep.text.replace(/{city}/g, startCity).replace('{next_city}', nextCity).replace('{user_city}', userCity);
        addLogisticsStep(timelineContainer, mainStatusEl, stepText, creationTime, true);
    }
}

/**
 * ã€å…¨æ–°ã€‘åœ¨æ™‚é–“è»¸ä¸Šæ·»åŠ ä¸€å€‹ç‰©æµæ­¥é©Ÿçš„è¼”åŠ©å‡½æ•¸
 * @param {HTMLElement} container - æ™‚é–“è»¸çš„DOMå®¹å™¨
 * @param {HTMLElement} mainStatusEl - é ‚éƒ¨ä¸»ç‹€æ…‹çš„DOMå…ƒç´ 
 * @param {string} text - ç‰©æµè³‡è¨Šæ–‡æœ¬
 * @param {number} timestamp - è©²æ­¥é©Ÿç™¼ç”Ÿçš„æ™‚é–“æˆ³è¨˜
 * @param {boolean} prepend - æ˜¯å¦æ·»åŠ åˆ°æœ€å‰é¢ï¼ˆæœ€æ–°çš„æ­¥é©Ÿæ”¾å‰é¢ï¼‰
 */
function addLogisticsStep(container, mainStatusEl, text, timestamp, prepend = false) {
    const stepEl = document.createElement('div');
    stepEl.className = 'logistics-step';
    stepEl.innerHTML = `
        <div class="logistics-step-content">
            <div class="status-text">${text}</div>
            <div class="timestamp">${new Date(timestamp).toLocaleString('zh-CN')}</div>
        </div>
    `;

    if (prepend) {
        container.prepend(stepEl); // æ’å…¥åˆ°æœ€å‰é¢
        mainStatusEl.textContent = text; // æ›´æ–°é ‚éƒ¨çš„ç‹€æ…‹
    } else {
        container.appendChild(stepEl);
    }
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘è™•ç†è§’è‰²æ‰‹æ©ŸéŒ¢åŒ…é¤˜é¡å’Œäº¤æ˜“è¨˜éŒ„çš„é€šç”¨å‡½æ•¸
 * @param {string} charId - è¦æ›´æ–°éŒ¢åŒ…çš„è§’è‰²ID
 * @param {number} amount - äº¤æ˜“é‡‘é¡ (æ­£æ•¸ç‚ºæ”¶å…¥, è² æ•¸ç‚ºæ”¯å‡º)
 * @param {string} description - äº¤æ˜“æè¿°
 */
async function updateCharacterPhoneBankBalance(charId, amount, description) {
    const chat = state.chats[charId];
    if (!chat || chat.isGroup) return;

    if (!chat.characterPhoneData) chat.characterPhoneData = {};
    if (!chat.characterPhoneData.bank) chat.characterPhoneData.bank = { balance: 0, transactions: [] };
    if (typeof chat.characterPhoneData.bank.balance !== 'number') chat.characterPhoneData.bank.balance = 0;

    chat.characterPhoneData.bank.balance += amount;

    const newTransaction = {
        type: amount > 0 ? 'æ”¶å…¥' : 'æ”¯å‡º',
        amount: Math.abs(amount),
        description: description,
        timestamp: Date.now()
    };
    
    // è®“æœ€æ–°çš„äº¤æ˜“è¨˜éŒ„é¡¯ç¤ºåœ¨æœ€å‰é¢
    if (!Array.isArray(chat.characterPhoneData.bank.transactions)) {
        chat.characterPhoneData.bank.transactions = [];
    }
    chat.characterPhoneData.bank.transactions.unshift(newTransaction);

    await db.chats.put(chat);
    console.log(`âœ… è§’è‰²[${chat.name}]éŒ¢åŒ…å·²æ›´æ–°: é‡‘é¡=${amount.toFixed(2)}, æ–°é¤˜é¡=${chat.characterPhoneData.bank.balance.toFixed(2)}`);
}

/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹ä¸€å€‹å–®é¸çš„è§’è‰²é¸æ“‡å™¨ï¼Œè®“ä½¿ç”¨è€…é¸æ“‡ä¸€å€‹ä»£ä»˜ç‰©ä»¶
 * @returns {Promise<string|null>} - è¿”å›é¸ä¸­çš„è§’è‰²IDï¼Œå¦‚æœå–æ¶ˆå‰‡è¿”å›null
 */
async function openCharSelectorForCart() {
    return new Promise(resolve => {
        // è¤‡ç”¨åˆ†äº«åŠŸèƒ½çš„å½ˆçª—ï¼Œå¾ˆæ–¹ä¾¿
        const modal = document.getElementById('share-target-modal');
        const listEl = document.getElementById('share-target-list');
        const titleEl = document.getElementById('share-target-modal-title');
        const confirmBtn = document.getElementById('confirm-share-target-btn');
        const cancelBtn = document.getElementById('cancel-share-target-btn');

        titleEl.textContent = 'åˆ†äº«çµ¦èª°ä»£ä»˜ï¼Ÿ';
        listEl.innerHTML = '';

        const singleChats = Object.values(state.chats).filter(c => !c.isGroup);

        if (singleChats.length === 0) {
            alert("ä½ é‚„æ²’æœ‰ä»»ä½•å¯ä»¥åˆ†äº«çš„å¥½å‹å“¦ã€‚");
            modal.classList.remove('visible');
            resolve(null);
            return;
        }

        // ä½¿ç”¨ radio é¸é …æŒ‰éˆ•
        singleChats.forEach(chat => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.innerHTML = `
                <input type="radio" name="cart-share-target" value="${chat.id}" id="target-${chat.id}" style="margin-right: 15px;">
                <label for="target-${chat.id}" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                    <img src="${chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${chat.name}</span>
                </label>
            `;
            listEl.appendChild(item);
        });

        modal.classList.add('visible');

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        const cleanup = () => modal.classList.remove('visible');

        newConfirmBtn.onclick = () => {
            const selectedRadio = document.querySelector('input[name="cart-share-target"]:checked');
            if (selectedRadio) {
                cleanup();
                resolve(selectedRadio.value);
            } else {
                alert("è«‹é¸æ“‡ä¸€å€‹ä»£ä»˜ç‰©ä»¶ï¼");
            }
        };

        newCancelBtn.onclick = () => {
            cleanup();
            resolve(null);
        };
    });
}

/**
 * ã€å…¨æ–°ã€‘æ¸…ç©ºæ¡ƒå¯¶è³¼ç‰©è»Š
 */
async function clearTaobaoCart() {
    await db.taobaoCart.clear();
    await renderTaobaoCart();
    updateCartBadge();
}

/**
 * ã€å…¨æ–°ã€‘æ ¹æ“šè³¼ç‰©è»Šå…§å®¹å‰µå»ºè¨‚å–®
 * @param {Array} cartItems - è³¼ç‰©è»Šå°ˆæ¡ˆé™£åˆ—
 */
async function createOrdersFromCart(cartItems) {
    if (!cartItems || cartItems.length === 0) return;
    const newOrders = cartItems.map((item, index) => ({
        productId: item.productId,
        quantity: item.quantity,
        timestamp: Date.now() + index, // é˜²æ­¢æ™‚é–“æˆ³è¨˜å®Œå…¨ç›¸åŒ
        status: 'å·²ä»˜æ¬¾ï¼Œç­‰å¾…ç™¼è²¨'
    }));
    await db.taobaoOrders.bulkAdd(newOrders);
    // ç°¡å–®æ¨¡æ“¬ç‰©æµæ›´æ–°
    setTimeout(async () => {
        const ordersToUpdate = await db.taobaoOrders.where('status').equals('å·²ä»˜æ¬¾ï¼Œç­‰å¾…ç™¼è²¨').toArray();
        for (const order of ordersToUpdate) {
            await db.taobaoOrders.update(order.id, { status: 'å·²ç™¼è²¨ï¼Œé‹è¼¸ä¸­' });
        }
    }, 1000 * 10);
}

// â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™æ•´å¡Šã€ä¿®å¾©å¾Œã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ handleShareCart å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ç¸½å…¥å£ | å·²ä¿®å¾©å‚™è¨»åã€‘è™•ç†â€œåˆ†äº«çµ¦Taä»£ä»˜â€çš„å…¨éƒ¨é‚è¼¯
 */
async function handleShareCart() {
    const cartItems = await db.taobaoCart.toArray();
    if (cartItems.length === 0) {
        alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œå…ˆå»åŠ é»å¯¶è²å§ï¼");
        return;
    }

    const targetChatId = await openCharSelectorForCart();
    if (!targetChatId) return;

    const char = state.chats[targetChatId];
    if (!char) return;

    let totalPrice = 0;
    const productPromises = cartItems.map(item => db.taobaoProducts.get(item.productId));
    const products = await Promise.all(productPromises);
    cartItems.forEach((item, index) => {
        const product = products[index];
        if (product) {
            totalPrice += product.price * item.quantity;
        }
    });

    const charBalance = char.characterPhoneData?.bank?.balance || 0;
    if (charBalance < totalPrice) {
        await showCustomAlert("ä»£ä»˜å¤±æ•—", `â€œ${char.name}â€çš„éŒ¢åŒ…é¤˜é¡ä¸è¶³ï¼\néœ€è¦ Â¥${totalPrice.toFixed(2)}ï¼Œä½†é¤˜é¡åªæœ‰ Â¥${charBalance.toFixed(2)}ã€‚`);
        return;
    }
    
    const confirmed = await showCustomConfirm(
        'ç¢ºèªä»£ä»˜',
        `å°‡åˆ†äº«è³¼ç‰©è»Šçµ¦â€œ${char.name}â€ä¸¦è«‹æ±‚ä»£ä»˜ï¼Œå…±è¨ˆ Â¥${totalPrice.toFixed(2)}ã€‚\né€™å°‡æœƒæ¸…ç©ºä½ çš„è³¼ç‰©è»Šï¼Œä¸¦å¾Taçš„éŒ¢åŒ…æ‰£æ¬¾ã€‚ç¢ºå®šå—ï¼Ÿ`,
        { confirmText: 'ç¢ºå®š' }
    );

    if (!confirmed) return;
    
    await showCustomAlert("è™•ç†ä¸­...", "æ­£åœ¨é€šçŸ¥Taä»£ä»˜ä¸¦ä¸‹å–®...");
    
    // --- â–¼â–¼â–¼ é€™å°±æ˜¯æœ¬æ¬¡çš„æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼ ---

    // 1. ç²å–è§’è‰²çš„æ‰‹æ©Ÿè³‡æ–™ï¼Œæº–å‚™æŸ¥æ‰¾å‚™è¨»å
    const characterPhoneData = char.characterPhoneData || { chats: {} };
    
    // 2. åœ¨è§’è‰²çš„é€£çµ¡äººä¸­ï¼Œæ‰¾åˆ°ä»£è¡¨â€œä½¿ç”¨è€…â€çš„é‚£å€‹é€£çµ¡äººå°è±¡
    //    ï¼ˆé€šå¸¸æ˜¯é‚£å€‹æ²’æœ‰èŠå¤©è¨˜éŒ„çš„ç‰¹æ®Šé€£çµ¡äººæ¢ç›®ï¼‰
    const userContactInData = Object.values(characterPhoneData.chats || {}).find(c => !c.history || c.history.length === 0);
    
    // 3. ç²å–è§’è‰²çµ¦ç”¨æˆ¶çš„å‚™è¨»åï¼Œå¦‚æœæ²’è¨­ç½®ï¼Œå°±é»˜èªç”¨â€œæˆ‘â€
    const remarkForUser = userContactInData ? userContactInData.remarkName : 'æˆ‘';
    
    // 4. ä½¿ç”¨é€™å€‹æ–°çš„å‚™è¨»åä¾†å‰µå»ºäº¤æ˜“è¨˜éŒ„
    const description = `ç‚ºâ€œ${remarkForUser}â€çš„æ¡ƒå¯¶è³¼ç‰©è»Šè²·å–®`;
    await updateCharacterPhoneBankBalance(targetChatId, -totalPrice, description);
    
    // --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² ---

    await createOrdersFromCart(cartItems);

    const itemsSummary = products.map((p, i) => `${p.name} x${cartItems[i].quantity}`).join('ã€ ');
    
    // çµ¦AIçœ‹çš„éš±è—æŒ‡ä»¤ï¼Œå‘Šè¨´å®ƒç™¼ç”Ÿäº†ä»€éº¼
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶å‰›å‰›èˆ‡ä½ åˆ†äº«äº†TAçš„è³¼ç‰©è»Šï¼Œä¸¦è«‹æ±‚ä½ ç‚ºç¸½åƒ¹ç‚º Â¥${totalPrice.toFixed(2)} çš„å•†å“ä»˜æ¬¾ã€‚ä½ å·²ç¶“åŒæ„ä¸¦æ”¯ä»˜äº†ï¼Œä½ çš„éŒ¢åŒ…é¤˜é¡å·²è¢«æ‰£é™¤ã€‚å•†å“åŒ…æ‹¬ï¼š${itemsSummary}ã€‚è«‹æ ¹æ“šä½ çš„äººè¨­å°æ­¤ä½œå‡ºå›æ‡‰ï¼Œä¾‹å¦‚è¡¨ç¤ºå¯µæººã€æŠ±æ€¨èŠ±éŒ¢å¤ªå¤šæˆ–è€…è©¢å•è²·äº†ä»€éº¼ã€‚]`,
        timestamp: Date.now(),
        isHidden: true
    };
    char.history.push(hiddenMessage);
    await db.chats.put(char);

    await clearTaobaoCart();

    await showCustomAlert("æ“ä½œæˆåŠŸ", `â€œ${char.name}â€å·²æˆåŠŸç‚ºä½ è²·å–®ï¼`);
    renderChatList();
    
    openChat(targetChatId); // è·³è½‰åˆ°èŠå¤©ä»‹é¢
    triggerAiResponse(); // è®“AIå›æ‡‰é€™æ¬¡ä»£ä»˜
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ æŠŠä¸‹é¢é€™å…©å¡Šå…¨æ–°çš„å‡½æ•¸ï¼Œé»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘è™•ç†â€œç‚ºTaè³¼è²·â€çš„å…¨éƒ¨é‚è¼¯
 */
async function handleBuyForChar() {
    const cartItems = await db.taobaoCart.toArray();
    if (cartItems.length === 0) {
        alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œå…ˆå»åŠ é»å¯¶è²å§ï¼");
        return;
    }

    const targetChatId = await openCharSelectorForCart();
    if (!targetChatId) return; // ç”¨æˆ¶å–æ¶ˆé¸æ“‡

    const char = state.chats[targetChatId];
    if (!char) return;

    let totalPrice = 0;
    const productPromises = cartItems.map(item => db.taobaoProducts.get(item.productId));
    const products = await Promise.all(productPromises);
    products.forEach((product, index) => {
        if (product) {
            totalPrice += product.price * cartItems[index].quantity;
        }
    });

    // æª¢æŸ¥ç”¨æˆ¶é¤˜é¡
    if ((state.globalSettings.userBalance || 0) < totalPrice) {
        alert(`é¤˜é¡ä¸è¶³ï¼æœ¬æ¬¡éœ€è¦ Â¥${totalPrice.toFixed(2)}ï¼Œä½†ä½ çš„é¤˜é¡åªæœ‰ Â¥${(state.globalSettings.userBalance || 0).toFixed(2)}ã€‚`);
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¢ºèªè´ˆé€',
        `ç¢ºå®šè¦èŠ±è²» Â¥${totalPrice.toFixed(2)} ç‚ºâ€œ${char.name}â€è³¼è²·è³¼ç‰©è»Šä¸­çš„æ‰€æœ‰å•†å“å—ï¼Ÿ`,
        { confirmText: 'ç‚ºTaè²·å–®' }
    );

    if (confirmed) {
        await showCustomAlert("æ­£åœ¨è™•ç†...", "æ­£åœ¨ç‚ºä½ å¿ƒæ„›çš„Taä¸‹å–®...");

        // 1. æ‰£é™¤ç”¨æˆ¶é¤˜é¡
        await updateUserBalanceAndLogTransaction(-totalPrice, `ç‚º ${char.name} è³¼è²·å•†å“`);
        
        // 2. å°‡è³¼ç‰©è»Šå…§å®¹è½‰åŒ–ç‚ºè¨‚å–®ï¼ˆè¨˜éŒ„åœ¨ä½ çš„è¨‚å–®è£¡ï¼‰
        await createOrdersFromCart(cartItems);

        // 3. ç™¼é€ç¦®ç‰©é€šçŸ¥çµ¦å°æ–¹
        await sendGiftNotificationToChar(targetChatId, products, cartItems, totalPrice);
        
        // 4. æ¸…ç©ºè³¼ç‰©è»Š
        await clearTaobaoCart();

        await showCustomAlert("è´ˆé€æˆåŠŸï¼", `ä½ ç‚ºâ€œ${char.name}â€è³¼è²·çš„ç¦®ç‰©å·²ä¸‹å–®ï¼Œä¸¦å·²é€šéç§ä¿¡é€šçŸ¥å°æ–¹å•¦ï¼`);
        renderChatList(); // åˆ·æ–°æ¸…å–®ï¼Œé¡¯ç¤ºæœªè®€æ¶ˆæ¯
    }
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ sendGiftNotificationToChar å‡½æ•¸ â–¼â–¼â–¼
// â–¼â–¼â–¼ æŠŠä¸‹é¢é€™å…©å¡Šå…¨æ–°çš„å‡½æ•¸ï¼Œé»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘è™•ç†â€œç‚ºTaè³¼è²·â€çš„å…¨éƒ¨é‚è¼¯
 */
async function handleBuyForChar() {
    const cartItems = await db.taobaoCart.toArray();
    if (cartItems.length === 0) {
        alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œå…ˆå»åŠ é»å¯¶è²å§ï¼");
        return;
    }

    const targetChatId = await openCharSelectorForCart();
    if (!targetChatId) return; // ç”¨æˆ¶å–æ¶ˆé¸æ“‡

    const char = state.chats[targetChatId];
    if (!char) return;

    let totalPrice = 0;
    const productPromises = cartItems.map(item => db.taobaoProducts.get(item.productId));
    const products = await Promise.all(productPromises);
    products.forEach((product, index) => {
        if (product) {
            totalPrice += product.price * cartItems[index].quantity;
        }
    });

    // æª¢æŸ¥ç”¨æˆ¶é¤˜é¡
    if ((state.globalSettings.userBalance || 0) < totalPrice) {
        alert(`é¤˜é¡ä¸è¶³ï¼æœ¬æ¬¡éœ€è¦ Â¥${totalPrice.toFixed(2)}ï¼Œä½†ä½ çš„é¤˜é¡åªæœ‰ Â¥${(state.globalSettings.userBalance || 0).toFixed(2)}ã€‚`);
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¢ºèªè´ˆé€',
        `ç¢ºå®šè¦èŠ±è²» Â¥${totalPrice.toFixed(2)} ç‚ºâ€œ${char.name}â€è³¼è²·è³¼ç‰©è»Šä¸­çš„æ‰€æœ‰å•†å“å—ï¼Ÿ`,
        { confirmText: 'ç‚ºTaè²·å–®' }
    );

    if (confirmed) {
        await showCustomAlert("æ­£åœ¨è™•ç†...", "æ­£åœ¨ç‚ºä½ å¿ƒæ„›çš„Taä¸‹å–®...");

        // 1. æ‰£é™¤ç”¨æˆ¶é¤˜é¡
        await updateUserBalanceAndLogTransaction(-totalPrice, `ç‚º ${char.name} è³¼è²·å•†å“`);
        
        // 2. å°‡è³¼ç‰©è»Šå…§å®¹è½‰åŒ–ç‚ºè¨‚å–®ï¼ˆè¨˜éŒ„åœ¨ä½ çš„è¨‚å–®è£¡ï¼‰
        await createOrdersFromCart(cartItems);

        // 3. ç™¼é€ç¦®ç‰©é€šçŸ¥çµ¦å°æ–¹
        await sendGiftNotificationToChar(targetChatId, products, cartItems, totalPrice);
        
        // 4. æ¸…ç©ºè³¼ç‰©è»Š
        await clearTaobaoCart();

        await showCustomAlert("è´ˆé€æˆåŠŸï¼", `ä½ ç‚ºâ€œ${char.name}â€è³¼è²·çš„ç¦®ç‰©å·²ä¸‹å–®ï¼Œä¸¦å·²é€šéç§ä¿¡é€šçŸ¥å°æ–¹å•¦ï¼`);
        renderChatList(); // åˆ·æ–°æ¸…å–®ï¼Œé¡¯ç¤ºæœªè®€æ¶ˆæ¯
    }
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æœ€çµ‚æ­£ç¢ºç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ sendGiftNotificationToChar å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–° | æœ€çµ‚æ­£ç¢ºç‰ˆã€‘ç™¼é€ç¦®ç‰©é€šçŸ¥åˆ°æŒ‡å®šè§’è‰²çš„èŠå¤©
 * æ•ˆæœï¼šç™¼é€ä¸€æ¢æœ¬è³ªæ˜¯æ–‡æœ¬ã€ä½†å¤–è§€æ˜¯å¡ç‰‡çš„æ¶ˆæ¯ã€‚
 *      - ä½¿ç”¨è€…ä»‹é¢é¡¯ç¤ºç‚ºæ¼‚äº®çš„ç¦®ç‰©å¡ç‰‡ã€‚
 *      - æ¶ˆæ¯è³‡æ–™ä¸­åŒ…å«å®Œæ•´çš„æ–‡æœ¬è³‡è¨Šã€‚
 *      - AI ä»ç„¶é€šééš±è—çš„ç³»çµ±æŒ‡ä»¤æ¥æ”¶è³‡è¨Šã€‚
 */
async function sendGiftNotificationToChar(targetChatId, products, cartItems, totalPrice) {
    const chat = state.chats[targetChatId];
    if (!chat) return;

    const itemsSummary = products.map((p, i) => `${p.name} x${cartItems[i].quantity}`).join('ã€');
    
    // 1. ã€æ ¸å¿ƒã€‘å…ˆæº–å‚™å¥½é€™æ¢æ¶ˆæ¯çš„â€œæ–‡æœ¬å…§å®¹â€
    const messageTextContent = `æˆ‘çµ¦ä½ è²·äº†æ–°ç¦®ç‰©ï¼Œå¸Œæœ›ä½ å–œæ­¡ï¼\nå•†å“æ¸…å–®ï¼š${itemsSummary}\nåˆè¨ˆï¼šÂ¥${totalPrice.toFixed(2)}`;

    // 2. å‰µå»ºå°ä½¿ç”¨è€…ã€å¯è¦‹ã€‘çš„æ¶ˆæ¯ç‰©ä»¶ã€‚ç¾åœ¨å®ƒåŒæ™‚æ“æœ‰ â€œæ–‡æœ¬å…§å®¹â€ å’Œ â€œå¡ç‰‡æ¨£å¼æŒ‡ä»¤â€
    const visibleMessage = {
        role: 'user',
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºé€™æ¢æ¶ˆæ¯æ·»åŠ ä¸€å€‹ content å±¬æ€§ï¼Œé€™å°±æ˜¯å®ƒçš„â€œæ–‡æœ¬æœ¬é«”â€
        // ç•¶ä½ è¤‡è£½é€™æ¢æ¶ˆæ¯æ™‚ï¼Œè¤‡è£½å‡ºä¾†çš„å…§å®¹å°±æ˜¯é€™å€‹ã€‚
        content: messageTextContent, 
        
        // åŒæ™‚ä¿ç•™ type å’Œ payloadï¼Œå®ƒå€‘å‘Šè¨´æ¸²æŸ“å™¨â€œæŠŠé€™æ¢æ¶ˆæ¯ç•«æˆå¡ç‰‡â€
        type: 'gift_notification', 
        timestamp: Date.now(),
        payload: {
            senderName: state.qzoneSettings.nickname || 'æˆ‘',
            itemSummary: itemsSummary,
            totalPrice: totalPrice,
            itemCount: cartItems.length,
        }
    };
    chat.history.push(visibleMessage);

    // 3. ã€é€™éƒ¨åˆ†ä¸è®Šã€‘å‰µå»ºä¸€æ¢çµ¦AIçœ‹çš„ã€éš±è—ã€‘æŒ‡ä»¤ï¼Œç¢ºä¿AIèƒ½ç†è§£ä¸¦å›æ‡‰
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»çµ±æŒ‡ä»¤ï¼šç”¨æˆ¶å‰›å‰›ç‚ºä½ è³¼è²·äº†${cartItems.length}ä»¶å•†å“ï¼Œç¸½åƒ¹å€¼ç‚º${totalPrice.toFixed(2)}å…ƒã€‚å•†å“åŒ…æ‹¬ï¼š${itemsSummary}ã€‚è«‹æ ¹æ“šä½ çš„äººè¨­å°æ­¤è¡¨ç¤ºæ„Ÿè¬æˆ–ä½œå‡ºå…¶ä»–åæ‡‰ã€‚]`,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 4. ã€é€™éƒ¨åˆ†ä¸è®Šã€‘æœªè®€æ¶ˆæ¯åªå¢åŠ 1æ¢
    chat.unreadCount = (chat.unreadCount || 0) + 1;
    await db.chats.put(chat);
    
    // 5. ã€é€™éƒ¨åˆ†ä¸è®Šã€‘ç™¼é€æ©«å¹…é€šçŸ¥
    if (state.activeChatId !== targetChatId) {
        showNotification(targetChatId, 'ä½ æ”¶åˆ°äº†ä¸€ä»½ç¦®ç‰©ï¼');
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²




// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è³¼ç‰©è»Šä»£ä»˜åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ç¸½å…¥å£ | ç„¡éš±è—æ¶ˆæ¯ç‰ˆã€‘è™•ç†ä½¿ç”¨è€…é»æ“Šâ€œåˆ†äº«çµ¦Taä»£ä»˜â€æŒ‰éˆ•çš„é‚è¼¯
 */
async function handleShareCartRequest() {
    const cartItems = await db.taobaoCart.toArray();
    if (cartItems.length === 0) {
        alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œå…ˆå»åŠ é»å¯¶è²å§ï¼");
        return;
    }

    const targetChatId = await openCharSelectorForCart();
    if (!targetChatId) return;

    const chat = state.chats[targetChatId];
    if (!chat) return;

    let totalPrice = 0;
    const productPromises = cartItems.map(item => db.taobaoProducts.get(item.productId));
    const products = await Promise.all(productPromises);
    const itemsSummary = products.map((p, i) => {
        if(p) {
            totalPrice += p.price * cartItems[i].quantity;
            return `${p.name} x${cartItems[i].quantity}`;
        }
        return '';
    }).filter(Boolean).join('ã€ ');
    
    const charBalance = chat.characterPhoneData?.bank?.balance || 0;

    const confirmed = await showCustomConfirm(
        'ç¢ºèªä»£ä»˜è«‹æ±‚',
        `å°‡å‘â€œ${chat.name}â€ç™¼èµ·è³¼ç‰©è»Šä»£ä»˜è«‹æ±‚ï¼Œå…±è¨ˆ Â¥${totalPrice.toFixed(2)}ã€‚`,
        { confirmText: 'ç™¼é€è«‹æ±‚' }
    );

    if (!confirmed) return;

    // --- â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘åªå‰µå»ºä¸€æ¢æ¶ˆæ¯ â–¼â–¼â–¼ ---
    
    // 1. ç›´æ¥å°‡æ‰€æœ‰è³‡è¨Šéƒ½æ”¾å…¥ content æ¬„ä½ï¼Œè®“ç”¨æˆ¶ä¹Ÿèƒ½çœ‹åˆ°
    const requestContent = `[è³¼ç‰©è»Šä»£ä»˜è«‹æ±‚]
ç¸½é‡‘é¡: Â¥${totalPrice.toFixed(2)}
å•†å“: ${itemsSummary}
(ä½ çš„ç•¶å‰é¤˜é¡: Â¥${charBalance.toFixed(2)})
è«‹ä½¿ç”¨ 'cart_payment_response' æŒ‡ä»¤å›æ‡‰ã€‚`;

    // 2. å‰µå»ºä¸€æ¢æ™®é€šçš„ä½¿ç”¨è€…æ¶ˆæ¯ï¼Œä¸å†æœ‰ isHidden æ¨™è¨˜
    const requestMessage = {
        role: 'user', // ç”±ç”¨æˆ¶ç™¼å‡º
        type: 'cart_share_request', // é¡å‹ä¿æŒä¸è®Šï¼Œç”¨æ–¼UIæ¸²æŸ“
        timestamp: Date.now(),
        content: requestContent, // å°‡åŒ…å«æ‰€æœ‰è³‡è¨Šçš„æ–‡æœ¬ä½œç‚ºå…§å®¹
        payload: { // payload ä¾ç„¶ä¿ç•™ï¼Œç”¨æ–¼UIæ¸²æŸ“å¡ç‰‡
            totalPrice: totalPrice,
            itemCount: cartItems.length,
            status: 'pending' 
        }
    };
    
    // 3. å°‡é€™æ¢ã€å–®ä¸€çš„ã€‘æ¶ˆæ¯æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
    chat.history.push(requestMessage);

    // --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² ---

    await db.chats.put(chat);
    
    await showCustomAlert("è«‹æ±‚å·²ç™¼é€", `å·²å°‡ä»£ä»˜è«‹æ±‚ç™¼é€çµ¦â€œ${chat.name}â€ï¼Œè«‹åœ¨èŠå¤©ä¸­æŸ¥çœ‹TAçš„å›æ‡‰ã€‚`);
    
    openChat(targetChatId);
}


/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘æ‰“é–‹ä¸€å€‹å–®é¸çš„è§’è‰²é¸æ“‡å™¨ï¼Œè®“ä½¿ç”¨è€…é¸æ“‡ä»£ä»˜ç‰©ä»¶
 * (é€™å€‹å‡½æ•¸è¤‡ç”¨äº†åˆ†äº«åŠŸèƒ½çš„å½ˆçª—ï¼Œç¨ä½œä¿®æ”¹)
 */
async function openCharSelectorForCart() {
    return new Promise(resolve => {
        const modal = document.getElementById('share-target-modal');
        const listEl = document.getElementById('share-target-list');
        const titleEl = document.getElementById('share-target-modal-title');
        const confirmBtn = document.getElementById('confirm-share-target-btn');
        const cancelBtn = document.getElementById('cancel-share-target-btn');

        titleEl.textContent = 'åˆ†äº«çµ¦èª°ä»£ä»˜ï¼Ÿ';
        listEl.innerHTML = '';

        const singleChats = Object.values(state.chats).filter(c => !c.isGroup);

        if (singleChats.length === 0) {
            alert("ä½ é‚„æ²’æœ‰ä»»ä½•å¯ä»¥åˆ†äº«çš„å¥½å‹å“¦ã€‚");
            modal.classList.remove('visible');
            resolve(null);
            return;
        }

        // ä½¿ç”¨ radio é¸é …æŒ‰éˆ•
        singleChats.forEach(chat => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.innerHTML = `
                <input type="radio" name="cart-share-target" value="${chat.id}" id="target-${chat.id}" style="margin-right: 15px;">
                <label for="target-${chat.id}" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                    <img src="${chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${chat.name}</span>
                </label>
            `;
            listEl.appendChild(item);
        });

        modal.classList.add('visible');

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        const cleanup = () => modal.classList.remove('visible');

        newConfirmBtn.onclick = () => {
            const selectedRadio = document.querySelector('input[name="cart-share-target"]:checked');
            if (selectedRadio) {
                cleanup();
                resolve(selectedRadio.value);
            } else {
                alert("è«‹é¸æ“‡ä¸€å€‹ä»£ä»˜ç‰©ä»¶ï¼");
            }
        };

        newCancelBtn.onclick = () => {
            cleanup();
            resolve(null);
        };
    });
}

/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘æ¸…ç©ºä½¿ç”¨è€…çš„æ¡ƒå¯¶è³¼ç‰©è»Š
 */
async function clearTaobaoCart() {
    await db.taobaoCart.clear();
    updateCartBadge();
    // å¦‚æœç”¨æˆ¶æ­£å¥½åœ¨çœ‹è³¼ç‰©è»Šï¼Œå°±åˆ·æ–°ä¸€ä¸‹
    if (document.getElementById('cart-view').classList.contains('active')) {
        renderTaobaoCart();
    }
}

/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘æ ¹æ“šè³¼ç‰©è»Šå…§å®¹å‰µå»ºè¨‚å–®
 * @param {Array} cartItems - å¾è³‡æ–™åº«è®€å‡ºçš„è³¼ç‰©è»Šå°ˆæ¡ˆé™£åˆ—
 */
async function createOrdersFromCart(cartItems) {
    if (!cartItems || cartItems.length === 0) return;
    const newOrders = cartItems.map((item, index) => ({
        productId: item.productId,
        quantity: item.quantity,
        timestamp: Date.now() + index, // é˜²æ­¢æ™‚é–“æˆ³è¨˜å®Œå…¨ç›¸åŒ
        status: 'å·²ä»˜æ¬¾ï¼Œç­‰å¾…ç™¼è²¨'
    }));
    await db.taobaoOrders.bulkAdd(newOrders);
    
    // æ¨¡æ“¬10ç§’å¾Œè‡ªå‹•ç™¼è²¨
    setTimeout(async () => {
        const orderIds = newOrders.map(order => order.timestamp);
        const ordersToUpdate = await db.taobaoOrders.where('timestamp').anyOf(orderIds).toArray();
        for (const order of ordersToUpdate) {
            await db.taobaoOrders.update(order.id, { status: 'å·²ç™¼è²¨ï¼Œé‹è¼¸ä¸­' });
        }
        console.log(`${ordersToUpdate.length} å€‹æ–°è¨‚å–®ç‹€æ…‹å·²æ›´æ–°ç‚ºâ€œå·²ç™¼è²¨â€ã€‚`);
    }, 1000 * 10);
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²

/* --- â€œæ¡ƒå¯¶â€App åŠŸèƒ½å‡½æ•¸çµæŸ --- */
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è§’è‰²æ‰‹æ©Ÿå¤–è§€è¨­ç½®çš„æ‰€æœ‰æ ¸å¿ƒå‡½æ•¸ï¼Œè«‹é»è²¼åˆ°JSåŠŸèƒ½å€ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹è§’è‰²æ‰‹æ©Ÿçš„å¤–è§€è¨­ç½®é é¢
 */
function openCharPhoneAppearanceSettings() {
    renderCharPhoneAppearanceScreen(); // æ¸²æŸ“é é¢å…§å®¹
    showCharacterPhonePage('character-phone-appearance-screen'); // é¡¯ç¤ºé é¢
    loadCharPhonePresetsToDropdown();
}

/**
 * ã€å…¨æ–° | å·²ä¿®å¾©ã€‘æ¸²æŸ“è§’è‰²æ‰‹æ©Ÿçš„å¤–è§€è¨­ç½®é é¢
 */
function renderCharPhoneAppearanceScreen() {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    // --- æ¸²æŸ“å£ç´™é è¦½ (é‚è¼¯ä¸è®Š) ---
    const wallpaperPreview = document.getElementById('char-phone-wallpaper-preview');
    const wallpaperUrl = chat.characterPhoneData.wallpaper || '';
    if (wallpaperUrl) {
        wallpaperPreview.style.backgroundImage = `url(${wallpaperUrl})`;
        wallpaperPreview.textContent = '';
    } else {
        wallpaperPreview.style.backgroundImage = 'none';
        wallpaperPreview.textContent = 'æš«ç„¡å£ç´™';
    }
// --- æ¸²æŸ“Appå…§å£ç´™é è¦½ ---
const appWallpaperPreview = document.getElementById('char-phone-app-wallpaper-preview');
const appWallpaperUrl = newAppWallpaperBase64 || chat.characterPhoneData.appWallpaper || '';
if (appWallpaperUrl) {
    appWallpaperPreview.style.backgroundImage = `url(${appWallpaperUrl})`;
    appWallpaperPreview.textContent = '';
} else {
    appWallpaperPreview.style.backgroundImage = 'none';
    appWallpaperPreview.textContent = 'é»æ“Šä¸‹æ–¹ä¸Šå‚³';
}
// --- Appå…§å£ç´™é è¦½æ¸²æŸ“çµæŸ ---
    // --- æ¸²æŸ“Appåœ–ç¤ºè¨­ç½®æ¸…å–® (æ ¸å¿ƒä¿®å¾©) ---
    const iconGrid = document.getElementById('char-phone-icon-settings-grid');
    iconGrid.innerHTML = '';
    const customIcons = chat.characterPhoneData.appIcons || {};

    // â˜…â˜…â˜… æˆ‘å€‘å·²ç¶“æŠŠé‚£è¡Œç¤™äº‹çš„ `if (app.id === 'appearance') continue;` åˆªæ‰äº†ï¼â˜…â˜…â˜…
    CHAR_PHONE_APPS.forEach(app => {
        const customIconUrl = customIcons[app.id];
        // ä½¿ç”¨é è¨­åœ–ç¤ºä½œç‚ºå‚™ç”¨
        const currentIconUrl = customIconUrl || (DEFAULT_APP_ICONS[app.id] || '');
        const currentIconHtml = currentIconUrl ? `<img src="${currentIconUrl}" style="width:100%; height:100%; object-fit:cover;">` : app.svg;
        
        const itemEl = document.createElement('div');
        itemEl.className = 'icon-setting-item'; 
        itemEl.dataset.iconId = app.id; 
        itemEl.innerHTML = `
            <div class="icon-preview" style="width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; padding: 8px; background: #f0f2f5;">
                ${currentIconHtml}
            </div>
            <span style="font-size: 13px;">${app.name}</span>
            <button class="change-icon-btn" data-icon-id="${app.id}" style="padding: 4px 10px; font-size: 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer;">æ›´æ›</button>
        `;
        iconGrid.appendChild(itemEl);
    });
    
    // --- æ¸²æŸ“å°å…ƒä»¶é è¦½ (é‚è¼¯ä¸è®Š) ---
    const widgets = chat.characterPhoneData.widgets || {};
    const widgetPreview1 = document.getElementById('char-phone-widget-preview-1');
    const widgetPreview2 = document.getElementById('char-phone-widget-preview-2');

    if (widgets.widget1_url) {
        widgetPreview1.style.backgroundImage = `url(${widgets.widget1_url})`;
        widgetPreview1.textContent = '';
    } else {
        widgetPreview1.style.backgroundImage = 'none';
        widgetPreview1.textContent = 'é»æ“Šä¸Šå‚³';
    }
    
    if (widgets.widget2_url) {
        widgetPreview2.style.backgroundImage = `url(${widgets.widget2_url})`;
        widgetPreview2.textContent = '';
    } else {
        widgetPreview2.style.backgroundImage = 'none';
        widgetPreview2.textContent = 'é»æ“Šä¸Šå‚³';
    }
}



/**
 * è™•ç†è§’è‰²æ‰‹æ©Ÿå£ç´™çš„æ›´æ›å’Œç§»é™¤
 * @param {string} newUrl - æ–°çš„å£ç´™URLï¼Œå¦‚æœç‚ºç©ºå­—ä¸²å‰‡è¡¨ç¤ºç§»é™¤
 */
async function handleCharPhoneWallpaperChange(newUrl) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    
    chat.characterPhoneData.wallpaper = newUrl;
    await db.chats.put(chat);
    
    // ç«‹å³æ‡‰ç”¨å£ç´™åˆ°è§’è‰²æ‰‹æ©Ÿä¸»è¢å¹•
    const phoneScreen = document.getElementById('character-phone-screen');
    if (newUrl) {
        phoneScreen.style.backgroundImage = `url(${newUrl})`;
        phoneScreen.style.backgroundColor = 'transparent';
    } else {
        phoneScreen.style.backgroundImage = 'none';
        const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
        phoneScreen.style.backgroundColor = isDarkMode ? '#000' : '#f0f2f5';
    }
    
    // åˆ·æ–°è¨­ç½®é é¢çš„é è¦½
    renderCharPhoneAppearanceScreen();
    alert(newUrl ? 'å£ç´™å·²æ›´æ–°ï¼' : 'å£ç´™å·²ç§»é™¤ï¼');
}

/**
 * è™•ç†è§’è‰²æ‰‹æ©ŸAppåœ–ç¤ºçš„æ›´æ›
 * @param {string} iconId - è¦æ›´æ›çš„Appçš„ID
 */
async function handleChangeCharPhoneIcon(iconId) {
    if (!activeCharacterPhoneId) return;
    
    const choice = await showChoiceModal("æ›´æ›åœ–ç¤º", [
        { text: 'ğŸ“ å¾æœ¬åœ°ä¸Šå‚³', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç¶²è·¯URL', value: 'url' },
        { text: 'ğŸ”„ æ¢å¾©é»˜èª', value: 'reset' }
    ]);

    let newIconUrl = null;

    if (choice === 'local') {
        newIconUrl = await uploadImageLocally();
    } else if (choice === 'url') {
        newIconUrl = await showCustomPrompt("åœ–ç¤ºURL", "è«‹è¼¸å…¥åœ–ç‰‡é€£çµ");
    } else if (choice === 'reset') {
        const chat = state.chats[activeCharacterPhoneId];
        if (chat.characterPhoneData.appIcons && chat.characterPhoneData.appIcons[iconId]) {
            delete chat.characterPhoneData.appIcons[iconId];
            await db.chats.put(chat);
            renderCharPhoneAppearanceScreen();
            renderCharacterAppGrid();
            alert('åœ–ç¤ºå·²æ¢å¾©é è¨­ã€‚');
        }
        return;
    }

    if (newIconUrl && newIconUrl.trim()) {
        const chat = state.chats[activeCharacterPhoneId];
        if (!chat.characterPhoneData.appIcons) {
            chat.characterPhoneData.appIcons = {};
        }
        chat.characterPhoneData.appIcons[iconId] = newIconUrl.trim();
        await db.chats.put(chat);
        
        renderCharPhoneAppearanceScreen(); // åˆ·æ–°è¨­ç½®é é¢
        renderCharacterAppGrid(); // åˆ·æ–°ä¸»è¢å¹•
        alert('åœ–ç¤ºå·²æ›´æ–°ï¼');
    }
}

// â–²â–²â–² æ–°å¢å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼

let currentViewingWeiboProfileId = null; // å…¨åŸŸè®Šæ•¸ï¼Œè¨˜éŒ„æ­£åœ¨æŸ¥çœ‹å“ªå€‹è§’è‰²çš„ä¸»é 

/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹æŒ‡å®šè§’è‰²çš„å¾®åšä¸»é 
 * @param {string} charId - è¦æŸ¥çœ‹çš„è§’è‰²çš„ID
 */
async function openWeiboCharProfile(charId) {
    currentViewingWeiboProfileId = charId;
    const chat = state.chats[charId];
    if (!chat) return;

    // æ¸²æŸ“è§’è‰²ä¸»é å…§å®¹
    await renderWeiboCharProfile(charId);
    
    // æ¸²æŸ“è©²è§’è‰²çš„å¾®åšFeed
    await renderCharSpecificFeed(charId);

    // åˆ‡æ›åˆ°è§’è‰²ä¸»é è¢å¹•
    showScreen('weibo-char-profile-screen');
    
    // éš±è—é—œæ³¨åˆ—è¡¨å½ˆçª—ï¼ˆå¦‚æœå®ƒé‚„é–‹è‘—ï¼‰
    document.getElementById('weibo-following-modal').classList.remove('visible');
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“è§’è‰²å¾®åšä¸»é çš„å€‹äººè³‡æ–™éƒ¨åˆ† (V2 - æ”¯æŒç²‰çµ²/é—œæ³¨æ•¸)
 * @param {string} charId - è§’è‰²çš„ID
 */
async function renderWeiboCharProfile(charId) {
    const chat = state.chats[charId];
    if (!chat) return;

    // æ¸²æŸ“åŸºç¤è³‡è¨Šï¼ˆé€™éƒ¨åˆ†ä¸è®Šï¼‰
    document.getElementById('weibo-char-profile-title').textContent = `${chat.name}çš„ä¸»é `;
    document.getElementById('weibo-char-avatar-img').src = chat.settings.weiboAvatar || chat.settings.aiAvatar;
    document.getElementById('weibo-char-nickname').textContent = chat.settings.weiboNickname || chat.name;
    document.getElementById('weibo-char-background-img').src = chat.settings.weiboBackground;
    document.getElementById('weibo-char-profession-display').textContent = chat.settings.weiboProfession || 'è·æ¥­æœªè¨­å®š';
    
    // --- â–¼â–¼â–¼ é€™å°±æ˜¯æˆ‘å€‘æ–°å¢çš„æ ¸å¿ƒé‚è¼¯ â–¼â–¼â–¼ ---

    // 1. å¾è¨­ç½®ä¸­è®€å–é—œæ³¨æ•¸å’Œç²‰çµ²æ•¸
    document.getElementById('weibo-char-following-count').textContent = chat.settings.weiboFollowingCount || '0';
    document.getElementById('weibo-char-fans-count').textContent = chat.settings.weiboFansCount || '0';

    // 2. å‹•æ…‹è¨ˆç®—ä¸¦é¡¯ç¤ºå¾®åšæ•¸
    const postCount = await db.weiboPosts.where('authorId').equals(charId).count();
    document.getElementById('weibo-char-posts-count').textContent = postCount;
    
    // --- â–²â–²â–² æ–°å¢é‚è¼¯çµæŸ â–²â–²â–² ---

    // æ¸²æŸ“é ­åƒæ¡† (é€™éƒ¨åˆ†ä¸è®Š)
    const frameImg = document.getElementById('weibo-char-avatar-frame');
    const frameUrl = chat.settings.weiboAvatarFrame || '';
    if (frameUrl) {
        frameImg.src = frameUrl;
        frameImg.style.display = 'block';
    } else {
        frameImg.style.display = 'none';
    }
}


/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“æŒ‡å®šè§’è‰²çš„å¾®åšFeed
 * @param {string} charId - è§’è‰²çš„ID
 */
async function renderCharSpecificFeed(charId) {
    const feedEl = document.getElementById('char-weibo-feed-list');
    feedEl.innerHTML = '';
    
    const posts = await db.weiboPosts.where('authorId').equals(charId).reverse().sortBy('timestamp');
    
    if (posts.length === 0) {
        feedEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Ta é‚„æ²’æœ‰ç™¼éå¾®åšå“¦ã€‚</p>';
        return;
    }

    posts.forEach(post => {
        // è¤‡ç”¨æˆ‘å€‘å¼·å¤§çš„å¾®åšå¸–å­å‰µå»ºå‡½æ•¸
        feedEl.appendChild(createWeiboPostElement(post));
    });
}

/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹è§’è‰²å¾®åšè³‡æ–™çš„ç·¨è¼¯å™¨
 */
async function openCharWeiboEditor() {
    if (!currentViewingWeiboProfileId) return;
    const chat = state.chats[currentViewingWeiboProfileId];
    if (!chat) return;

    // å¡«å……ç•¶å‰è³‡æ–™åˆ°ç·¨è¼¯å™¨
    document.getElementById('char-weibo-editor-avatar-preview').src = chat.settings.weiboAvatar || chat.settings.aiAvatar;
    document.getElementById('char-weibo-editor-nickname-input').value = chat.settings.weiboNickname || chat.name;
    document.getElementById('char-weibo-editor-bg-preview').src = chat.settings.weiboBackground;

    // é¡¯ç¤ºå½ˆçª—
    document.getElementById('char-weibo-editor-modal').classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘ä¿å­˜å°è§’è‰²å¾®åšè³‡æ–™çš„ä¿®æ”¹
 */
async function saveCharWeiboProfile() {
    if (!currentViewingWeiboProfileId) return;
    const chat = state.chats[currentViewingWeiboProfileId];
    if (!chat) return;

    // å¾ç·¨è¼¯å™¨ç²å–æ–°è³‡æ–™
    chat.settings.weiboAvatar = document.getElementById('char-weibo-editor-avatar-preview').src;
    chat.settings.weiboNickname = document.getElementById('char-weibo-editor-nickname-input').value.trim();
    chat.settings.weiboBackground = document.getElementById('char-weibo-editor-bg-preview').src;

    // ä¿å­˜åˆ°è³‡æ–™åº«
    await db.chats.put(chat);
    
    // åˆ·æ–°ä¸»é é¡¯ç¤º
    await renderWeiboCharProfile(currentViewingWeiboProfileId);
    
    document.getElementById('char-weibo-editor-modal').classList.remove('visible');
    alert('è§’è‰²å¾®åšè³‡æ–™å·²ä¿å­˜ï¼');
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ const db = ... çš„æ­£ä¸Šæ–¹ï¼Œé»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ ¹æ“šè§’è‰²äººè¨­å’Œè·æ¥­ï¼Œç”Ÿæˆåˆå§‹çš„å¾®åšé—œæ³¨æ•¸å’Œç²‰çµ²æ•¸
 * @param {object} chat - è§’è‰²çš„èŠå¤©ç‰©ä»¶
 * @returns {{following: string, fans: string}}
 */
function getInitialWeiboStats(chat) {
    const persona = (chat.settings.aiPersona || '') + (chat.settings.weiboProfession || '');
    const keywords = ["å¶åƒ", "æ˜æ˜Ÿ", "æ¼”å“¡", "æ­Œæ‰‹", "åšä¸»", "ç¶²ç´…", "UPä¸»", "ä¸»æ’­", "é¸æ‰‹", "ç•«å®¶", "ä½œå®¶"];
    const isPublicFigure = keywords.some(keyword => persona.includes(keyword));

    let fansCount, followingCount;

    if (isPublicFigure) {
        fansCount = Math.floor(100000 + Math.random() * 9900000); // 10è¬ - 1000è¬
        followingCount = Math.floor(50 + Math.random() * 450); // 50 - 500
    } else {
        fansCount = Math.floor(100 + Math.random() * 4900); // 100 - 5000
        followingCount = Math.floor(50 + Math.random() * 250); // 50 - 300
    }

    return {
        fans: formatNumberToChinese(fansCount),
        following: formatNumberToChinese(followingCount)
    };
}

/**
 * ã€å…¨æ–°ã€‘å°‡æ•¸ä½æ ¼å¼åŒ–ç‚ºå¸¶â€œè¬â€æˆ–â€œå„„â€çš„å­—ä¸²
 * @param {number} num - åŸå§‹æ•¸å­—
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„å­—ä¸²
 */
function formatNumberToChinese(num) {
    if (num >= 100000000) {
        return (num / 100000000).toFixed(1).replace(/\.0$/, '') + 'å„„';
    }
    if (num >= 10000) {
        return (num / 10000).toFixed(1).replace(/\.0$/, '') + 'è¬';
    }
    return String(num);
}

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ playMinimaxAudio å‡½æ•¸ â–¼â–¼â–¼
let isIntentionalStop = false;
// â–¼â–¼â–¼ æ­¥é©Ÿ 1ï¼šæ·»åŠ æˆ–æ›¿æ›é€™å…©è¡Œä»£ç¢¼ â–¼â–¼â–¼
let isTtsPlaying = false; // å…¨åŸŸé–ï¼Œtrueè¡¨ç¤ºæœ‰èªéŸ³æ­£åœ¨æ’­æ”¾æˆ–è¼‰å…¥
let currentTtsAudioBubble = null; // è¨˜éŒ„ç•¶å‰æ­£åœ¨æ’­æ”¾å‹•ç•«æˆ–éŸ³è¨Šçš„æ°£æ³¡å…ƒç´ 
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç¬¬1æ­¥ï¼šåœ¨é€™è£¡é»è²¼ä¸‹é¢é€™å€‹ã€å…¨æ–°çš„ã€‘è¼”åŠ©å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æŸ¥æ‰¾å¾æŒ‡å®šä½ç½®é–‹å§‹çš„æ‰€æœ‰é€£çºŒAIèªéŸ³è¨Šæ¯
 * @param {Array} history - å®Œæ•´çš„èŠå¤©æ­·å²è¨˜éŒ„é™£åˆ—
 * @param {number} startIndex - é–‹å§‹æŸ¥æ‰¾çš„ç´¢å¼•ä½ç½®
 * @returns {Array} - ä¸€å€‹åŒ…å«æ‰€æœ‰é€£çºŒAIèªéŸ³è¨Šæ¯ç‰©ä»¶çš„é™£åˆ—
 */
function findConsecutiveAiVoiceMessages(history, startIndex) {
    const messagesToPlay = [];
    if (startIndex < 0 || startIndex >= history.length) {
        return messagesToPlay;
    }

    // å¾é»æ“Šçš„é‚£æ¢æ¶ˆæ¯é–‹å§‹ï¼Œå‘å¾Œéæ­·
    for (let i = startIndex; i < history.length; i++) {
        const msg = history[i];
        // æª¢æŸ¥é€™æ¢æ¶ˆæ¯æ˜¯å¦æ˜¯AIç™¼é€çš„ï¼Œä¸¦ä¸”é¡å‹æ˜¯èªéŸ³
        if (msg.role === 'assistant' && msg.type === 'voice_message') {
            messagesToPlay.push(msg); // å¦‚æœæ˜¯ï¼Œå°±æŠŠå®ƒåŠ å…¥å¾…æ’­æ”¾æ¸…å–®
        } else {
            // ä¸€æ—¦é‡åˆ°ä¸æ˜¯AIèªéŸ³çš„æ¶ˆæ¯ï¼ˆæ¯”å¦‚ä½¿ç”¨è€…çš„å›å¾©ï¼Œæˆ–AIçš„åœ–ç‰‡/æ–‡å­—æ¶ˆæ¯ï¼‰ï¼Œå°±ç«‹åˆ»åœæ­¢æŸ¥æ‰¾
            break;
        }
    }
    return messagesToPlay;
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ç¬¬1æ­¥ï¼šåœ¨é€™è£¡é»è²¼é€™å€‹ã€å…¨æ–°çš„ã€‘åœæ­¢å‡½æ•¸ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç¬¬2æ­¥ï¼šç”¨é€™æ•´å¡Šã€V2 - ç²¾å‡†åœæ­¢ç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ stopMinimaxAudio å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€V2 - ç²¾å‡†åœæ­¢ç‰ˆã€‘åœæ­¢ç•¶å‰æ­£åœ¨æ’­æ”¾çš„Minimax TTSèªéŸ³
 */
function stopMinimaxAudio() {
    if (!isTtsPlaying) return;

    // æ ¸å¿ƒä¿®æ”¹1ï¼šåœ¨åŸ·è¡Œåœæ­¢æ“ä½œå‰ï¼Œå…ˆè¨­ç½®â€œæ•…æ„åœæ­¢â€çš„æ¨™èªŒç‚º true
    isIntentionalStop = true;

    const ttsPlayer = document.getElementById('tts-audio-player');
    ttsPlayer.pause();
    ttsPlayer.src = ''; // é€™è¡Œä»£ç¢¼æœƒè§¸ç™¼ onerror äº‹ä»¶

    if (window.currentAnimatingBubbles) {
        window.currentAnimatingBubbles.forEach(b => b.classList.remove('playing'));
    }

    isTtsPlaying = false;
    currentTtsAudioBubble = null;
    window.currentAnimatingBubbles = null;
    console.log('Minimax TTS: Playback stopped by user.');

    // æ ¸å¿ƒä¿®æ”¹2ï¼šç”¨ä¸€å€‹å¾®å°çš„å»¶é²ä¾†é‡ç½®æ¨™èªŒä½å…ƒ
    // é€™èƒ½ç¢ºä¿ onerror äº‹ä»¶æœ‰è¶³å¤ çš„æ™‚é–“æª¢æŸ¥åˆ°æ¨™èªŒä½å…ƒï¼Œç„¶å¾Œå†å°‡å…¶é‡ç½®
    setTimeout(() => {
        isIntentionalStop = false;
    }, 100);
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



// â–¼â–¼â–¼ ç¬¬3æ­¥ï¼šç”¨é€™æ•´å¡Šã€V8 - éŒ¯èª¤è™•ç†çµ‚æ¥µç‰ˆã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ playMinimaxAudio å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€V8 - éŒ¯èª¤è™•ç†çµ‚æ¥µç‰ˆã€‘èª¿ç”¨ Minimax TTS API ç”ŸæˆèªéŸ³ä¸¦æ’­æ”¾
 * @param {string} text - è¦è½‰æ›ç‚ºèªéŸ³çš„åˆä½µå¾Œçš„æ–‡æœ¬
 * @param {string} voiceId - Minimax çš„èªéŸ³ ID
 * @param {Array<HTMLElement>} bubblesToAnimate - éœ€è¦æ’­æ”¾å‹•ç•«çš„æ‰€æœ‰èªéŸ³æ°£æ³¡å…ƒç´ çš„é™£åˆ—
 */
async function playMinimaxAudio(text, voiceId, bubblesToAnimate) {
    // æ’­æ”¾å‰å…ˆåœæ­¢ï¼Œç¢ºä¿ç’°å¢ƒä¹¾æ·¨
    stopMinimaxAudio(); 
    // ç­‰å¾…ä¸€å°æœƒå…’ï¼Œç¢ºä¿èˆŠçš„æ’­æ”¾æ©Ÿå®Œå…¨æ¸…ç†ä¹¾æ·¨
    await new Promise(resolve => setTimeout(resolve, 50));

    const ttsPlayer = document.getElementById('tts-audio-player');
    const firstBubble = bubblesToAnimate[0]; 

    // --- æº–å‚™æ’­æ”¾æ–°çš„èªéŸ³ ---
    isTtsPlaying = true;
    currentTtsAudioBubble = firstBubble;
    window.currentAnimatingBubbles = bubblesToAnimate;
    bubblesToAnimate.forEach(b => b.classList.add('playing'));

    // æš«åœä¸»éŸ³æ¨‚æ’­æ”¾æ©Ÿ
    const mainAudioPlayer = document.getElementById('audio-player');
    if (mainAudioPlayer && !mainAudioPlayer.paused) {
        mainAudioPlayer.pause();
        musicState.isPlaying = false;
        updatePlayerUI();
    }

    // --- è«‹æ±‚ä¸¦æ’­æ”¾èªéŸ³ ---
    const groupId = state.apiConfig.minimaxGroupId;
    const apiKey = state.apiConfig.minimaxApiKey;
    if (!groupId || !apiKey) {
        await showCustomAlert('èªéŸ³æ’­æ”¾å¤±æ•—', 'å°šæœªé…ç½®Minimaxçš„Group IDå’ŒAPI Keyã€‚');
        stopMinimaxAudio();
        return;
    }

    try {
        const response = await fetch(`https://api.minimax.chat/v1/text_to_speech?GroupId=${groupId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text, voice_id: voiceId, model: 'speech-01', speed: 1.0, pitch: 0, timber_list: [] })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Minimax API éŒ¯èª¤: ${errorData.base_resp?.status_msg || response.statusText}`);
        }
        // ã€æ ¸å¿ƒä¿®å¾©ã€‘æª¢æŸ¥è¿”å›çš„å…§å®¹é¡åˆ¥å‹ï¼Œå¦‚æœä¸æ˜¯éŸ³è¨Šå°±ç›´æ¥å ±éŒ¯ï¼
        const contentType = response.headers.get('Content-Type');
        if (!contentType || !contentType.startsWith('audio/')) {
            const errorData = await response.json().catch(() => response.text()); // å˜—è©¦è§£æéŒ¯èª¤è³‡è¨Š
            throw new Error(`Minimax API æœªè¿”å›æœ‰æ•ˆçš„éŸ³è¨Šæ–‡ä»¶ï¼Œè€Œæ˜¯è¿”å›äº†: ${JSON.stringify(errorData)}`);
        }
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);

        ttsPlayer.src = audioUrl;
        
        const cleanupAndReset = () => {
            if (isTtsPlaying) { // åªæœ‰åœ¨é‚„åœ¨æ’­æ”¾ç‹€æ…‹æ™‚æ‰æ¸…ç†
                isTtsPlaying = false;
                URL.revokeObjectURL(audioUrl); 
                if (window.currentAnimatingBubbles) {
                    window.currentAnimatingBubbles.forEach(b => b.classList.remove('playing'));
                }
                currentTtsAudioBubble = null;
                window.currentAnimatingBubbles = null;
            }
        };

       ttsPlayer.onended = cleanupAndReset;
        
        // â–¼â–¼â–¼ ä½¿ç”¨é€™æ®µã€ä¿®å¾©å¾Œã€‘çš„ä»£ç¢¼é€²è¡Œæ›¿æ› â–¼â–¼â–¼
        ttsPlayer.onerror = (e) => {
             if (!isIntentionalStop) {
                 // 1. ã€ä¿ç•™ã€‘åœ¨æ§åˆ¶å°åˆ—å°éŒ¯èª¤ï¼Œæ–¹ä¾¿ä½ è‡ªå·±èª¿è©¦å•é¡Œ
                 console.error("TTSéŸ³è¨Šæ’­æ”¾æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œå·²è‡ªå‹•åˆ‡æ›ç‚ºæ–‡æœ¬é¡¯ç¤º:", e);
                 // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘ä¸å†å½ˆå‡ºä»»ä½•ç…©äººçš„æç¤ºæ¡†ï¼
                 //    showCustomAlert('æ’­æ”¾å¤±æ•—', 'æ’­æ”¾éŸ³è¨Šæª”æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚');  <-- é€™è¡Œä»£ç¢¼è¢«åˆªæ‰äº†ï¼
             } else {
                 console.log("Intentional stop triggered error event, alert skipped.");
             }
             // 3. ã€ä¿ç•™ã€‘ç„¡è«–å¦‚ä½•ï¼Œéƒ½èª¿ç”¨ cleanupAndReset ä¾†åœæ­¢æ’­æ”¾å‹•ç•«ï¼Œæ¢å¾©UI
             cleanupAndReset();
        };
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        await ttsPlayer.play();

    } catch (error) {
        console.error("Minimax TTS èª¿ç”¨å¤±æ•—:", error);
        await showCustomAlert('èªéŸ³åˆæˆå¤±æ•—', `éŒ¯èª¤è³‡è¨Š: ${error.message}`);
        stopMinimaxAudio();
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿå¤–è§€é è¨­åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * å•Ÿç”¨æˆ–ç¦ç”¨è§’è‰²æ‰‹æ©Ÿé è¨­ç®¡ç†æŒ‰éˆ•
 * @param {boolean} isEnabled - æ˜¯å¦å•Ÿç”¨
 */
function toggleCharPhonePresetButtons(isEnabled) {
    document.getElementById('apply-char-phone-preset-btn').disabled = !isEnabled;
    document.getElementById('update-char-phone-preset-btn').disabled = !isEnabled;
    document.getElementById('rename-char-phone-preset-btn').disabled = !isEnabled;
    document.getElementById('delete-char-phone-preset-btn').disabled = !isEnabled;
    document.getElementById('export-char-phone-preset-btn').disabled = !isEnabled;
}

/**
 * è¼‰å…¥è§’è‰²æ‰‹æ©Ÿå¤–è§€é è¨­åˆ°ä¸‹æ‹‰æ¸…å–®
 */
async function loadCharPhonePresetsToDropdown() {
    const selector = document.getElementById('char-phone-preset-selector');
    if (!selector) return;
    selector.innerHTML = '<option value="">-- è«‹é¸æ“‡ä¸€å€‹é è¨­ --</option>';
    const presets = await db.charPhonePresets.toArray();
    presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = preset.name;
        selector.appendChild(option);
    });
    activeCharPhonePresetId = null;
    toggleCharPhonePresetButtons(false);
}

/**
 * ç•¶ç”¨æˆ¶å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡ä¸€å€‹é è¨­æ™‚è§¸ç™¼
 */
function handleCharPhonePresetSelection() {
    const selector = document.getElementById('char-phone-preset-selector');
    activeCharPhonePresetId = selector.value ? parseInt(selector.value) : null;
    toggleCharPhonePresetButtons(!!activeCharPhonePresetId);
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€ä¿®å¾©å¾Œã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ applySelectedCharPhonePreset å‡½æ•¸ â–¼â–¼â–¼
async function applySelectedCharPhonePreset() {
    if (!activeCharPhonePresetId) {
        alert("è«‹å…ˆå¾ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹è¦æ‡‰ç”¨çš„é è¨­ã€‚");
        return;
    }
    if (!activeCharacterPhoneId) {
        alert("éŒ¯èª¤ï¼šæ²’æœ‰æ‰¾åˆ°ç•¶å‰æ­£åœ¨æ“ä½œçš„è§’è‰²æ‰‹æ©Ÿã€‚");
        return;
    }
    const preset = await db.charPhonePresets.get(activeCharPhonePresetId);
    const chat = state.chats[activeCharacterPhoneId];

    if (preset && preset.data && chat) {
        // å°‡é è¨­è³‡æ–™æ·±æ‹·è²ä¸€ä»½ï¼Œæ‡‰ç”¨åˆ°è§’è‰²çš„æ‰‹æ©Ÿè³‡æ–™ä¸Š
        chat.characterPhoneData.wallpaper = preset.data.wallpaper || '';
        chat.characterPhoneData.appIcons = { ...DEFAULT_APP_ICONS, ...(preset.data.appIcons || {}) };
        chat.characterPhoneData.widgets = { ...(preset.data.widgets || {}) };
        
        // â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘æ–°å¢çš„ä¸€è¡Œï¼â˜…â˜…â˜…
        chat.characterPhoneData.appWallpaper = preset.data.appWallpaper || '';

        await db.chats.put(chat);
        
        // åˆ·æ–°æ‰‹æ©Ÿä»‹é¢ä»¥é¡¯ç¤ºæ–°å¤–è§€
        openCharacterPhone(activeCharacterPhoneId);
        
        // åˆ·æ–°å¤–è§€è¨­ç½®é é¢ï¼Œä»¥ä¾¿é è¦½å’Œè³‡æ–™åŒæ­¥
        renderCharPhoneAppearanceScreen();

        alert(`å·²æˆåŠŸç‚ºâ€œ${chat.name}â€æ‡‰ç”¨é è¨­: "${preset.name}"ï¼`);
    } else {
        alert("æ‡‰ç”¨é è¨­å¤±æ•—ï¼Œæ‰¾ä¸åˆ°é è¨­æˆ–è§’è‰²è³‡æ–™ã€‚");
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * ä¿å­˜ç•¶å‰è§’è‰²æ‰‹æ©Ÿçš„å¤–è§€è¨­ç½®ç‚ºä¸€å€‹æ–°çš„é è¨­
 */
async function saveCurrentCharPhonePreset() {
    if (!activeCharacterPhoneId) return;

    const presetName = await showCustomPrompt("ä¿å­˜é è¨­", "è«‹ç‚ºé€™å€‹å¤–è§€æ–¹æ¡ˆèµ·å€‹åå­—ï¼š");
    if (!presetName || !presetName.trim()) {
        if (presetName !== null) alert("åå­—ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }

    const chat = state.chats[activeCharacterPhoneId];
    // å¾ç•¶å‰è§’è‰²çš„è³‡æ–™ä¸­æå–å¤–è§€è¨­ç½®
    const presetData = {
        wallpaper: chat.characterPhoneData.wallpaper || '',
        appIcons: { ...(chat.characterPhoneData.appIcons || {}) },
        widgets: { ...(chat.characterPhoneData.widgets || {}) },
        appWallpaper: chat.characterPhoneData.appWallpaper || '',
    };

    await db.charPhonePresets.add({ name: presetName.trim(), data: presetData });
    await loadCharPhonePresetsToDropdown();
    alert(`å¤–è§€é è¨­ "${presetName.trim()}" å·²ä¿å­˜ï¼`);
}

/**
 * æ›´æ–°ç•¶å‰é¸ä¸­çš„é è¨­
 */
async function updateSelectedCharPhonePreset() {
    if (!activeCharPhonePresetId || !activeCharacterPhoneId) return;

    const currentPreset = await db.charPhonePresets.get(activeCharPhonePresetId);
    if (!currentPreset) return;

    const confirmed = await showCustomConfirm(
        "ç¢ºèªæ›´æ–°",
        `ç¢ºå®šè¦ç”¨ç•¶å‰æ‰‹æ©Ÿçš„å¤–è§€è¦†è“‹é è¨­ "${currentPreset.name}" å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[activeCharacterPhoneId];
        const presetData = {
            wallpaper: chat.characterPhoneData.wallpaper || '',
            appIcons: { ...(chat.characterPhoneData.appIcons || {}) },
            widgets: { ...(chat.characterPhoneData.widgets || {}) },
            appWallpaper: chat.characterPhoneData.appWallpaper || '',
        };
        await db.charPhonePresets.update(activeCharPhonePresetId, { data: presetData });
        await showCustomAlert('æˆåŠŸ', `é è¨­ "${currentPreset.name}" å·²æ›´æ–°ï¼`);
    }
}

/**
 * é‡å‘½åé¸ä¸­çš„é è¨­
 */
async function renameSelectedCharPhonePreset() {
    if (!activeCharPhonePresetId) return;
    const currentPreset = await db.charPhonePresets.get(activeCharPhonePresetId);
    const newName = await showCustomPrompt("é‡å‘½å", "è«‹è¼¸å…¥æ–°çš„åç¨±ï¼š", currentPreset.name);
    if (newName && newName.trim()) {
        await db.charPhonePresets.update(activeCharPhonePresetId, { name: newName.trim() });
        await loadCharPhonePresetsToDropdown();
        document.getElementById('char-phone-preset-selector').value = activeCharPhonePresetId;
        alert("é‡å‘½åæˆåŠŸï¼");
    }
}

/**
 * åˆªé™¤é¸ä¸­çš„é è¨­
 */
async function deleteSelectedCharPhonePreset() {
    if (!activeCharPhonePresetId) return;
    const currentPreset = await db.charPhonePresets.get(activeCharPhonePresetId);
    const confirmed = await showCustomConfirm("ç¢ºèªåˆªé™¤", `ç¢ºå®šè¦åˆªé™¤é è¨­ "${currentPreset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.charPhonePresets.delete(activeCharPhonePresetId);
        await loadCharPhonePresetsToDropdown();
        alert("é è¨­å·²åˆªé™¤ã€‚");
    }
}

/**
 * åŒ¯å‡ºé¸ä¸­çš„é è¨­
 */
async function exportCharPhonePreset() {
    if (!activeCharPhonePresetId) return;
    const preset = await db.charPhonePresets.get(activeCharPhonePresetId);
    const blob = new Blob([JSON.stringify(preset, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `[CharPhone]${preset.name}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

/**
 * å°å…¥é è¨­æ–‡ä»¶
 */
function importCharPhonePreset(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.name && data.data) {
                await db.charPhonePresets.add({ name: `${data.name} (å°å…¥)`, data: data.data });
                await loadCharPhonePresetsToDropdown();
                alert(`é è¨­ "${data.name}" å°å…¥æˆåŠŸï¼`);
            } else {
                alert("å°å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚");
            }
        } catch (error) {
            alert(`å°å…¥å¤±æ•—ï¼šæª”è§£æéŒ¯èª¤ã€‚${error.message}`);
        }
    };
    reader.readAsText(file);
}

// â–²â–²â–² è§’è‰²æ‰‹æ©Ÿå¤–è§€é è¨­åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠä¸‹é¢é€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * [å…¨æ–°] åœ¨å¤–è§€è¨­ç½®é é¢æ¸²æŸ“å‡ºæ‰€æœ‰Appçš„åç¨±è¨­ç½®é …
 */
function renderAppNameSettings() {
    const grid = document.getElementById('icon-rename-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const appLabels = state.globalSettings.appLabels || {};

    // éæ­·é è¨­æ¨™ç±¤ç‰©ä»¶ï¼Œä»¥ç¢ºä¿æ‰€æœ‰appéƒ½æœ‰è¨­ç½®é …
    for (const appId in DEFAULT_APP_LABELS) {
        if (DEFAULT_APP_LABELS.hasOwnProperty(appId)) {
            const defaultName = DEFAULT_APP_LABELS[appId];
            const currentName = appLabels[appId] || defaultName;

            const item = document.createElement('div');
            item.className = 'form-group';
            item.style.marginBottom = '0'; // è®“ä½ˆå±€æ›´ç·Šæ¹Š
            item.innerHTML = `
                <label for="rename-input-${appId}">${defaultName}</label>
                <input type="text" id="rename-input-${appId}" class="app-rename-input" data-appid="${appId}" value="${currentName}">
            `;
            grid.appendChild(item);
        }
    }
}

/**
 * [å…¨æ–°] å°‡ä¿å­˜çš„Appåç¨±æ‡‰ç”¨åˆ°ä¸»è¢å¹•çš„åœ–ç¤ºä¸Š
 */
function applyAppLabels() {
    const appLabels = state.globalSettings.appLabels || {};
    
    for (const appId in DEFAULT_APP_LABELS) {
        if (DEFAULT_APP_LABELS.hasOwnProperty(appId)) {
            const defaultName = DEFAULT_APP_LABELS[appId];
            const customName = appLabels[appId] || defaultName;

            // é€™å€‹é¸æ“‡å™¨æœƒåŒæ™‚æ‰¾åˆ°ä¸»è¢å¹•å’ŒDockæ¬„ä¸Šçš„æ‰€æœ‰åœ–ç¤º
            const icons = document.querySelectorAll(`.desktop-app-icon [id="icon-img-${appId}"]`);
            
            icons.forEach(iconImg => {
                const appIconContainer = iconImg.closest('.desktop-app-icon');
                if (appIconContainer) {
                    const labelElement = appIconContainer.querySelector('.label');
                    if (labelElement) {
                        labelElement.textContent = customName;
                    }
                }
            });
        }
    }
}

/**
 * [å…¨æ–°] å¾è¼¸å…¥æ¡†è®€å–ä¸¦ä¿å­˜ç”¨æˆ¶ä¿®æ”¹çš„Appåç¨±
 */
function saveAppLabels() {
    const appNameInputs = document.querySelectorAll('.app-rename-input');
    if (!state.globalSettings.appLabels) {
        state.globalSettings.appLabels = {};
    }

    appNameInputs.forEach(input => {
        const appId = input.dataset.appid;
        const newName = input.value.trim();
        const defaultName = DEFAULT_APP_LABELS[appId];

        // å¦‚æœç”¨æˆ¶è¼¸å…¥äº†æ–°åå­—ï¼Œä¸”å’Œé»˜èªåå­—ä¸ä¸€æ¨£ï¼Œå°±ä¿å­˜
        if (newName && newName !== defaultName) {
            state.globalSettings.appLabels[appId] = newName;
        } else {
            // å¦‚æœç”¨æˆ¶æ¸…ç©ºäº†è¼¸å…¥æ¡†ï¼Œæˆ–è€…æ”¹å›äº†é»˜èªåå­—ï¼Œå°±åˆªé™¤ä¿å­˜è¨˜éŒ„ï¼Œä»¥æ¢å¾©é è¨­
            delete state.globalSettings.appLabels[appId];
        }
    });
}


// â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šã€å…¨æ–°ä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ handleImportSillyTavernWorldBook å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–° | å·²ä¿®å¾©ã€‘è™•ç†å°å…¥çš„SillyTavernä¸–ç•Œæ›¸æª”
 * @param {File} file - ç”¨æˆ¶é¸æ“‡çš„JSONæª”
 */
async function handleImportSillyTavernWorldBook(file) {
    // ä½¿ç”¨FileReaderä¾†è®€å–æª”å…§å®¹
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const text = e.target.result;
            const data = JSON.parse(text);

            // é©—è­‰æª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºï¼Œç¢ºä¿åŒ…å«'entries'ç‰©ä»¶
            if (!data.entries || typeof data.entries !== 'object') {
                throw new Error("æª”æ¡ˆæ ¼å¼ç„¡æ•ˆã€‚SillyTavernä¸–ç•Œæ›¸æ‡‰åŒ…å«'entries'ç‰©ä»¶ã€‚");
            }

            // å¾æª”æ¡ˆåæå–åç¨±ï¼Œä½œç‚ºæ–°çš„åˆ†é¡å
            let categoryName = file.name.replace(/\.(json|jsonl)$/i, '').trim();
            if (!categoryName) categoryName = 'å°å…¥çš„ä¸–ç•Œæ›¸';

            // æª¢æŸ¥è©²åˆ†é¡æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å‰µå»º
            let category = await db.worldBookCategories.where('name').equals(categoryName).first();
            if (!category) {
                const newCategoryId = await db.worldBookCategories.add({ name: categoryName });
                category = { id: newCategoryId, name: categoryName };
                console.log(`å‰µå»ºäº†æ–°çš„ä¸–ç•Œæ›¸åˆ†é¡: ${categoryName} (ID: ${newCategoryId})`);
            } else {
                console.log(`å°‡æ¢ç›®æ·»åŠ åˆ°å·²å­˜åœ¨çš„åˆ†é¡: ${categoryName} (ID: ${category.id})`);
            }

            const newBooks = [];
            // éæ­·SillyTavern worldbookä¸­çš„æ‰€æœ‰æ¢ç›®
            for (const key in data.entries) {
                const entry = data.entries[key];
                
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤äº† !entry.disable çš„æª¢æŸ¥ï¼Œç¾åœ¨æœƒå°å…¥æ‰€æœ‰æ¢ç›® â˜…â˜…â˜…
                if (entry) { 
                    // ä½¿ç”¨entry.commentä½œç‚ºæ›¸åï¼Œå¦‚æœç‚ºç©ºå‰‡ä½¿ç”¨"æ¢ç›® key"ä½œç‚ºå‚™ç”¨
                    const entryName = (entry.comment || `æ¢ç›® ${key}`).trim();
                    const entryContent = (entry.content || '').trim();
                    // ç¢ºä¿æ›¸åå’Œå…§å®¹éƒ½ä¸ç‚ºç©º
                    if (entryName && entryContent) {
                        newBooks.push({
                            id: 'wb_' + Date.now() + Math.random(), // å‰µå»ºå”¯ä¸€ID
                            name: entryName,
                            content: entryContent,
                            categoryId: category.id // æ­¸å±¬åˆ°æ–°çš„åˆ†é¡
                        });
                    }
                }
            }

            if (newBooks.length === 0) {
                alert('æ²’æœ‰æ‰¾åˆ°ä»»ä½•å¯å°å…¥çš„æœ‰æ•ˆæ¢ç›®ã€‚');
                return;
            }
            
            // æ‰¹é‡å°‡æ–°æ›¸æ·»åŠ åˆ°è³‡æ–™åº«ï¼Œæ•ˆç‡æ›´é«˜
            await db.worldBooks.bulkAdd(newBooks);
            // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„stateï¼Œä»¥ä¾¿UIèƒ½ç«‹å³åˆ·æ–°
            state.worldBooks.push(...newBooks); 

            // é‡æ–°æ¸²æŸ“ä¸–ç•Œæ›¸æ¸…å–®ï¼Œé¡¯ç¤ºæ–°å…§å®¹
            await renderWorldBookScreen();
            await showCustomAlert('å°å…¥æˆåŠŸ', `æˆåŠŸå°‡ã€Š${categoryName}ã€‹ä¸­çš„ ${newBooks.length} å€‹æ¢ç›®å°å…¥åˆ°ä¸–ç•Œæ›¸ï¼`);

        } catch (error) {
            console.error("å°å…¥ä¸–ç•Œæ›¸å¤±æ•—:", error);
            await showCustomAlert('å°å…¥å¤±æ•—', `ç„¡æ³•è§£ææª”ï¼Œè«‹ç¢ºä¿å®ƒæ˜¯æœ‰æ•ˆçš„SillyTavernä¸–ç•Œæ›¸JSONæª”ã€‚\n\néŒ¯èª¤: ${error.message}`);
        }
    };
    // ä»¥UTF-8ç·¨ç¢¼è®€å–æª”å…§å®¹
    reader.readAsText(file, 'UTF-8');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯â€œå¿ƒå‹•é£›è¡Œæ£‹â€çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘åŒ¯å‡ºæŒ‡å®šçš„é£›è¡Œæ£‹å•é¡Œåº«
 * @param {number} bankId - è¦åŒ¯å‡ºçš„å•é¡Œåº«çš„ID
 */
async function exportLudoQuestionBank(bankId) {
    try {
        const bank = await db.ludoQuestionBanks.get(bankId);
        const questions = await db.ludoQuestions.where('bankId').equals(bankId).toArray();

        if (!bank) {
            alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¦åŒ¯å‡ºçš„é¡Œåº«ã€‚");
            return;
        }

        // 1. æº–å‚™è¦åŒ¯å‡ºçš„è³‡æ–™çµæ§‹ï¼ŒåªåŒ…å«ç´”ç²¹çš„è³‡æ–™
        const exportData = {
            bankName: bank.name,
            questions: questions.map(q => ({
                text: q.text,
                type: q.type
            }))
        };

        // 2. å°‡è³‡æ–™è½‰æ›ç‚ºæ ¼å¼åŒ–çš„JSONå­—ä¸²
        const jsonString = JSON.stringify(exportData, null, 2);
        
        // 3. å‰µå»ºBlobå°è±¡
        const blob = new Blob([jsonString], { type: 'application/json' });
        
        // 4. å‰µå»ºä¸¦è§¸ç™¼ä¸‹è¼‰é€£çµ
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const dateStr = new Date().toISOString().split('T')[0];
        link.href = url;
        link.download = `[é£›è¡Œæ£‹é¡Œåº«]${bank.name}-${dateStr}.json`;
        document.body.appendChild(link);
        link.click();
        
        // 5. æ¸…ç†è‡¨æ™‚å‰µå»ºçš„ç‰©ä»¶
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        await showCustomAlert('åŒ¯å‡ºæˆåŠŸ', `å•é¡Œåº«â€œ${bank.name}â€å·²æˆåŠŸåŒ¯å‡ºï¼`);

    } catch (error) {
        console.error("åŒ¯å‡ºé£›è¡Œæ£‹é¡Œåº«å¤±æ•—:", error);
        await showCustomAlert('åŒ¯å‡ºå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘è™•ç†å°å…¥çš„é£›è¡Œæ£‹å•é¡Œåº«æ–‡ä»¶
 * @param {File} file - ç”¨æˆ¶é¸æ“‡çš„JSONæª”
 */
async function importLudoQuestionBank(file) {
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const text = e.target.result;
            const data = JSON.parse(text);

            // 1. é©—è­‰æª”æ¡ˆæ ¼å¼
            if (!data.bankName || !Array.isArray(data.questions)) {
                throw new Error("æª”æ¡ˆæ ¼å¼ç„¡æ•ˆã€‚å¿…é ˆåŒ…å« 'bankName' å’Œ 'questions' é™£åˆ—ã€‚");
            }

            // 2. æª¢æŸ¥é¡Œåº«åç¨±æ˜¯å¦å·²å­˜åœ¨
            let newBankName = data.bankName;
            const existingBank = await db.ludoQuestionBanks.where('name').equals(newBankName).first();
            if (existingBank) {
                newBankName = `${newBankName} (å°å…¥)`; // å¦‚æœé‡åï¼Œè‡ªå‹•æ·»åŠ å°¾ç¢¼
            }

            // 3. å‰µå»ºæ–°çš„é¡Œåº«
            const newBankId = await db.ludoQuestionBanks.add({ name: newBankName });

            // 4. æº–å‚™è¦æ‰¹é‡æ·»åŠ çš„æ–°å•é¡Œ
            const questionsToAdd = data.questions.map(q => ({
                bankId: newBankId,
                text: q.text,
                type: q.type || 'both_answer' // ç›¸å®¹èˆŠçš„æ²’æœ‰typeçš„é¡Œåº«
            }));

            // 5. å¦‚æœæœ‰å•é¡Œï¼Œå°±æ‰¹é‡æ·»åŠ åˆ°è³‡æ–™åº«
            if (questionsToAdd.length > 0) {
                await db.ludoQuestions.bulkAdd(questionsToAdd);
            }

            // 6. åˆ·æ–°UIä¸¦çµ¦å‡ºæç¤º
            await renderLudoQuestionBanks();
            await showCustomAlert('å°å…¥æˆåŠŸ', `å•é¡Œåº«â€œ${newBankName}â€å·²æˆåŠŸå°å…¥ï¼ŒåŒ…å« ${questionsToAdd.length} å€‹å•é¡Œï¼`);

        } catch (error) {
            console.error("å°å…¥é£›è¡Œæ£‹é¡Œåº«å¤±æ•—:", error);
            await showCustomAlert('å°å…¥å¤±æ•—', `ç„¡æ³•è§£ææª”ï¼Œè«‹ç¢ºä¿å®ƒæ˜¯æ­£ç¢ºçš„é¡Œåº«å‚™ä»½æª”æ¡ˆã€‚\n\néŒ¯èª¤: ${error.message}`);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

/**
 * ã€é£›è¡Œæ£‹ã€‘æ‰“é–‹éŠæˆ²è¨­ç½®ä»‹é¢ (V2 - æ ¸å–æ–¹å¡Šç‰ˆ)
 */
async function openLudoSetup() {
    showScreen('ludo-setup-screen');
    const selectionEl = document.getElementById('ludo-player-selection');
    selectionEl.innerHTML = '<p>æ­£åœ¨è¼‰å…¥è§’è‰²åˆ—è¡¨...</p>';

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºäº†ä¿æŒçµ±ä¸€ï¼Œæˆ‘å€‘åœ¨é€™è£¡ä¹Ÿè¼‰å…¥NPCä½œç‚ºå¯é¸ç©ä¼´
    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    const allNpcs = Object.values(state.chats).flatMap(chat => (chat.npcLibrary || []).map(npc => ({...npc, owner: chat.name})));
    let playerOptions = [
        ...singleChats.map(c => ({ id: c.id, name: c.name, avatar: c.settings.aiAvatar, type: 'è§’è‰²' })),
        ...allNpcs.map(n => ({ id: n.id, name: n.name, avatar: n.avatar, type: `NPC (${n.owner})` }))
    ];

    selectionEl.innerHTML = '';
    if (playerOptions.length === 0) {
        selectionEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">é‚„æ²’æœ‰å¯ä»¥ä¸€èµ·ç©çš„å¥½å‹å“¦~</p>';
        return;
    }

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ¸²æŸ“æ ¸å–æ–¹å¡Šåˆ—è¡¨
    playerOptions.forEach((player, index) => {
        const item = document.createElement('div');
        item.className = 'player-selection-item';
        item.innerHTML = `
            <input type="checkbox" class="ludo-player-checkbox" value="${player.id}" id="ludo-opponent-${player.id}" ${index === 0 ? 'checked' : ''}>
            <img src="${player.avatar || defaultAvatar}" alt="${player.name}">
            <span class="name">${player.name}</span>
            <span class="type-tag">${player.type}</span>
        `;
        selectionEl.appendChild(item);
    });

    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ·»åŠ äº‹ä»¶ç›£è½ä»¥å¯¦ç¾å–®é¸
    selectionEl.addEventListener('click', (e) => {
        if (e.target.type === 'checkbox' && e.target.classList.contains('ludo-player-checkbox')) {
            document.querySelectorAll('.ludo-player-checkbox').forEach(cb => {
                if (cb !== e.target) cb.checked = false;
            });
        }
    });

    // è¼‰å…¥å•é¡Œåº«åˆ°ä¸‹æ‹‰æ¸…å–®
    const bankSelect = document.getElementById('ludo-question-bank-select');
    bankSelect.innerHTML = '';
    const banks = await db.ludoQuestionBanks.toArray();
    if (banks.length === 0) {
        bankSelect.innerHTML = '<option value="">æš«ç„¡å¯ç”¨é¡Œåº«</option>';
    } else {
        banks.forEach(bank => {
            const option = document.createElement('option');
            option.value = bank.id;
            option.textContent = bank.name;
            bankSelect.appendChild(option);
        });
    }
}

/**
 * ã€é£›è¡Œæ£‹ã€‘é–‹å§‹éŠæˆ²çš„æ ¸å¿ƒé‚è¼¯ (V2 - æ ¸å–æ–¹å¡Šç‰ˆ)
 */
async function startLudoGame() {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¿®æ”¹é¸æ“‡å™¨ä»¥åŒ¹é…æ–°çš„æ ¸å–æ–¹å¡Šclass
    const selectedOpponentRadio = document.querySelector('.ludo-player-checkbox:checked');
    if (!selectedOpponentRadio) {
        alert("è«‹é¸æ“‡ä¸€ä½ç©ä¼´ï¼");
        return;
    }
    const opponentId = selectedOpponentRadio.value;
    const opponentChat = state.chats[opponentId] || Object.values(state.chats).flatMap(c => c.npcLibrary).find(n => n.id === opponentId);

    const selectedBankId = parseInt(document.getElementById('ludo-question-bank-select').value);
    if (isNaN(selectedBankId)) {
        alert("è«‹é¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„å•é¡Œåº«ï¼");
        return;
    }

    // æŸ¥æ‰¾å°æ‰‹çš„å®Œæ•´è³‡è¨Šï¼ˆå’ŒèˆŠé‚è¼¯ä¸€æ¨£ï¼‰
    let opponentInfo = null;
    const mainChat = Object.values(state.chats).find(c => c.id === opponentId);
    if (mainChat) {
        opponentInfo = { ...mainChat, persona: mainChat.settings.aiPersona, avatar: mainChat.settings.aiAvatar };
    } else {
        for (const c of Object.values(state.chats)) {
            const npc = (c.npcLibrary || []).find(n => n.id === opponentId);
            if (npc) {
                opponentInfo = npc;
                break;
            }
        }
    }
    if (!opponentInfo) { alert("æ‰¾ä¸åˆ°æ‰€é¸çš„ç©ä¼´ä¿¡æ¯ï¼"); return; }
    
    // åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹ (å’ŒèˆŠé‚è¼¯ä¸€æ¨£)
    ludoGameState = {
        isActive: true,
        opponent: opponentInfo,
        players: [],
        currentTurnIndex: 0,
        gameLog: [],
        boardLayout: [],
        isDiceRolling: false,
        activeQuestionBankId: selectedBankId
    };
    const userPlayer = { id: 'user', name: 'ä½ ', avatar: state.qzoneSettings.avatar || defaultAvatar, piecePosition: -1, isUser: true };
    const charPlayer = { id: opponentInfo.id, name: opponentInfo.name, avatar: opponentInfo.avatar || defaultAvatar, piecePosition: -1, isUser: false, persona: opponentInfo.persona };
    if (Math.random() > 0.5) {
        ludoGameState.players = [userPlayer, charPlayer];
    } else {
        ludoGameState.players = [charPlayer, userPlayer];
    }
    ludoGameState.currentTurnIndex = 0;
    generateLudoBoard();
    showScreen('ludo-game-screen');
    renderLudoGameScreen();
    logToLudoGame('éŠæˆ²é–‹å§‹ï¼æ“²å‡º6é»å³å¯èµ·é£›ã€‚', 'system');
    await sleep(1000);
    await processLudoTurn();
}



// ã€å·²ä¿®å¾©ã€‘è«‹ç”¨ä¸‹é¢é€™å€‹å‡½æ•¸å®Œæ•´æ›¿æ›ä½ èˆŠçš„ renderLudoGameScreen å‡½æ•¸
function renderLudoGameScreen(options = {}) {
    if (!ludoGameState.isActive) return;

    const userPieceEl = document.getElementById('ludo-user-piece');
    const charPieceEl = document.getElementById('ludo-char-piece');
    if(!userPieceEl || !charPieceEl) return;

    userPieceEl.style.backgroundImage = `url(${ludoGameState.players.find(p => p.isUser).avatar})`;
    charPieceEl.style.backgroundImage = `url(${ludoGameState.players.find(p => !p.isUser).avatar})`;

    ludoGameState.players.forEach(player => {
        const pieceEl = player.isUser ? userPieceEl : charPieceEl;
        const pos = player.piecePosition;

        if (pos === -1) { // åœ¨èµ·é»
            const startCell = document.querySelector('.ludo-cell.start');
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©1ï¼šåŠ ä¸Š if (startCell) çš„å®‰å…¨æª¢æŸ¥ â–¼â–¼â–¼
            if (startCell) {
                pieceEl.style.left = `${startCell.offsetLeft + (player.isUser ? 0 : 5)}px`;
                pieceEl.style.top = `${startCell.offsetTop + (player.isUser ? 0 : 5)}px`;
            }
        } else if (pos >= LUDO_BOARD_SIZE) { // å·²åˆ°çµ‚é»
            const endCell = document.querySelector('.ludo-cell.end');
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©2ï¼šåŠ ä¸Š if (endCell) çš„å®‰å…¨æª¢æŸ¥ â–¼â–¼â–¼
            if (endCell) {
                pieceEl.style.left = `${endCell.offsetLeft + (player.isUser ? 0 : 5)}px`;
                pieceEl.style.top = `${endCell.offsetTop + (player.isUser ? 0 : 5)}px`;
            }
        } else {
            const cell = document.querySelector(`.ludo-cell[data-index="${pos}"]`);
            if (cell) {
                pieceEl.style.left = `${cell.offsetLeft + (player.isUser ? 0 : 5)}px`;
                pieceEl.style.top = `${cell.offsetTop + (player.isUser ? 0 : 5)}px`;
            }
        }
    });

    const logContainer = document.getElementById('ludo-game-log');
    logContainer.innerHTML = ludoGameState.gameLog.map(log => 
        `<div class="log-entry ${log.type}">${log.message.replace(/\n/g, '<br>')}</div>`
    ).join('');
    logContainer.scrollTop = logContainer.scrollHeight;
}

/**
 * ã€å…¨æ–°ã€‘é£›è¡Œæ£‹å°ˆç”¨çš„ä½¿ç”¨è€…è¼¸å…¥å‡½æ•¸
 * @param {string} promptText - æç¤ºæ–‡å­— (é›–ç„¶æˆ‘å€‘æ²’ç”¨ä¸Šï¼Œä½†ä¿ç•™ä»‹é¢)
 * @param {string} placeholder - è¼¸å…¥æ¡†çš„å ä½å…ƒæ–‡å­—
 * @returns {Promise<string>} - è¿”å›ä½¿ç”¨è€…çš„è¼¸å…¥å…§å®¹
 */
function waitForLudoUserAction(promptText, placeholder) {
    return new Promise(resolve => {
        const actionArea = document.getElementById('ludo-action-area');
        actionArea.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹ï¼ˆæ¯”å¦‚éª°å­ï¼‰
        actionArea.classList.add('speaking-mode'); // è¤‡ç”¨åŠ‡æœ¬æ®ºçš„ç™¼è¨€æ¨£å¼

        const textarea = document.createElement('textarea');
        textarea.id = 'ludo-user-speech-input'; // ä½¿ç”¨æ–°IDï¼Œé¿å…è¡çª
        textarea.rows = 1;
        textarea.placeholder = placeholder || 'è«‹è¼¸å…¥ä½ çš„å›ç­”...';
        
        // å³æ™‚èª¿æ•´é«˜åº¦
        textarea.addEventListener('input', () => {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        });

        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'form-button'; // ä½¿ç”¨é€šç”¨æŒ‰éˆ•æ¨£å¼
        confirmBtn.textContent = 'ç¢ºèªå›ç­”';

        actionArea.appendChild(textarea);
        actionArea.appendChild(confirmBtn);
        textarea.focus();

        confirmBtn.onclick = () => {
            const answer = textarea.value.trim() || '...ï¼ˆè·³éï¼‰';
            actionArea.innerHTML = ''; // æ¸…ç©ºè¼¸å…¥æ¡†å’ŒæŒ‰éˆ•
            actionArea.classList.remove('speaking-mode');
            resolve(answer);
        };
    });
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€V2 - æ”¯æŒæ–°å•é¡Œé¡å‹ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ handleLudoQuestionEvent å‡½æ•¸ â–¼â–¼â–¼
async function handleLudoQuestionEvent(player) {
    // 1. æ ¹æ“šéŠæˆ²ç‹€æ…‹ç²å–å•é¡Œåº«
    const questionBankId = ludoGameState.activeQuestionBankId;
    let questions = [];
    if (questionBankId) {
        questions = await db.ludoQuestions.where('bankId').equals(questionBankId).toArray();
    }

    // 2. å¦‚æœé¡Œåº«æ˜¯ç©ºçš„ï¼Œæç¤ºä¸¦ç›´æ¥é€²å…¥ä¸‹ä¸€å›åˆ
    if (questions.length === 0) {
        logToLudoGame('ç•¶å‰é¡Œåº«æ˜¯ç©ºçš„ï¼Œè·³éæœ¬è¼ªå•ç­”ã€‚', 'system');
        await sleep(1500);
        await advanceTurn(); // åˆ¥å¿˜äº†åˆ‡æ›å›åˆ
        return;
    }

    // 3. éš¨æ©ŸæŠ½ä¸€å€‹å•é¡Œ
    const questionObj = getRandomItem(questions);
    const questionText = questionObj.text;

    // 4. ã€æ ¸å¿ƒã€‘å½ˆå‡ºæ¨¡å¼é¸æ“‡æ¡†ï¼Œè®“ä½¿ç”¨è€…æ±ºå®šæ€éº¼ç©
    const mode = await showAnswerModeSelector(questionText);
    if (!mode) {
        logToLudoGame('ç©å®¶å–æ¶ˆäº†ç­”é¡Œï¼ŒéŠæˆ²ç¹¼çºŒã€‚', 'system');
        await advanceTurn(); // å–æ¶ˆä¹Ÿè¦åˆ‡æ›å›åˆ
        return;
    }

    // 5. æ ¹æ“šé¸æ“‡çš„æ¨¡å¼ï¼ŒåŸ·è¡Œä¸åŒçš„æµç¨‹
    logToLudoGame(`ã€${mode === 'both_answer' ? 'å…±åŒå›ç­”' : 'ä¸€äººå›ç­”ï¼Œä¸€äººè©•åƒ¹'}ã€‘æŠ½åˆ°çš„å•é¡Œæ˜¯ï¼šâ€œ${questionText}â€`, 'system');
    await sleep(1500);

    const currentPlayer = player;
    const otherPlayer = ludoGameState.players.find(p => p.id !== currentPlayer.id);

    // --- æµç¨‹åˆ†æ”¯ ---
    if (mode === 'both_answer') {
        logToLudoGame(`è«‹ <strong>${currentPlayer.name}</strong> å…ˆå›ç­”ã€‚`, 'system');
        let answer1 = currentPlayer.isUser 
            ? await waitForLudoUserAction('è¼ªåˆ°ä½ å›ç­”å•é¡Œ', 'è«‹è¼¸å…¥ä½ çš„å›ç­”...')
            : await triggerLudoAiAction('answer_question', { question: questionText });
        logToLudoGame(`<strong>${currentPlayer.name}:</strong> ${answer1}`, currentPlayer.isUser ? 'user' : 'char');
        await sleep(2000);

        logToLudoGame(`ç¾åœ¨è«‹ <strong>${otherPlayer.name}</strong> å›ç­”ã€‚`, 'system');
        let answer2 = otherPlayer.isUser 
            ? await waitForLudoUserAction('è¼ªåˆ°ä½ å›ç­”å•é¡Œ', 'è«‹è¼¸å…¥ä½ çš„å›ç­”...')
            : await triggerLudoAiAction('answer_question', { question: questionText });
        logToLudoGame(`<strong>${otherPlayer.name}:</strong> ${answer2}`, otherPlayer.isUser ? 'user' : 'char');
    
    } else if (mode === 'single_answer') {
        logToLudoGame(`è«‹ <strong>${currentPlayer.name}</strong> å…ˆå›ç­”ã€‚`, 'system');
        let answer = currentPlayer.isUser
            ? await waitForLudoUserAction('è¼ªåˆ°ä½ å›ç­”å•é¡Œ', 'è«‹è¼¸å…¥ä½ çš„å›ç­”...')
            : await triggerLudoAiAction('answer_question', { question: questionText });
        logToLudoGame(`<strong>${currentPlayer.name}:</strong> ${answer}`, currentPlayer.isUser ? 'user' : 'char');
        await sleep(2000);

        logToLudoGame(`ç¾åœ¨è«‹ <strong>${otherPlayer.name}</strong> å°Taçš„å›ç­”ç™¼è¡¨ä¸€ä¸‹çœ‹æ³•å§ã€‚`, 'system');
        let evaluation = otherPlayer.isUser
            ? await waitForLudoUserAction(`å°â€œ${answer}â€çš„çœ‹æ³•`, 'è«‹è¼¸å…¥ä½ çš„è©•åƒ¹...')
            : await triggerLudoAiAction('evaluate_answer', { question: questionText, answer: answer });
        logToLudoGame(`<strong>${otherPlayer.name}:</strong> ${evaluation}`, otherPlayer.isUser ? 'user' : 'char');
    }

    // 6. å•ç­”æµç¨‹çµæŸå¾Œï¼Œæç¤ºä¸¦åˆ‡æ›åˆ°ä¸‹ä¸€å›åˆ
    await sleep(1500);
    logToLudoGame('æœ¬è¼ªå•ç­”çµæŸï¼ŒéŠæˆ²ç¹¼çºŒï¼', 'system');
    await advanceTurn();
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€é£›è¡Œæ£‹ã€‘æ·»åŠ ä¸€æ¢éŠæˆ²æ—¥èªŒ
 */
function logToLudoGame(message, type) {
    ludoGameState.gameLog.push({ message, type });
    renderLudoGameScreen();
}
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘ä¸€å€‹å¸¶â€œé­”æ³•â€çš„æ“²éª°å­å‡½æ•¸
 * @param {object} player - æ­£åœ¨æ“²éª°å­çš„ç©å®¶ç‰©ä»¶
 * @returns {number} - æœ€çµ‚çš„éª°å­é»æ•¸
 */
function rollTheDice(player) {
    // å¦‚æœç©å®¶é‚„åœ¨èµ·é»ï¼ˆæ²’æœ‰èµ·é£›ï¼‰
    if (player.piecePosition === -1) {
        // å°±æœ‰50%çš„è¶…é«˜æ¦‚ç‡ç›´æ¥æ“²å‡º6ï¼
        if (Math.random() < 0.5) {
            return 6;
        }
        // å¦å¤–50%çš„æ¦‚ç‡ï¼Œéš¨æ©Ÿæ“²å‡º1-5
        return Math.floor(Math.random() * 5) + 1;
    }
    // å¦‚æœå·²ç¶“èµ·é£›äº†ï¼Œå°±æ¢å¾©æ­£å¸¸çš„å…¬å¹³éª°å­
    return Math.floor(Math.random() * 6) + 1;
}
// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

/**
 * ã€é£›è¡Œæ£‹ã€‘éŠæˆ²ä¸»è¿´åœˆ
 */
async function processLudoTurn() {
    if (!ludoGameState.isActive) return;

    const currentPlayer = ludoGameState.players[ludoGameState.currentTurnIndex];
    logToLudoGame(`è¼ªåˆ° <strong>${currentPlayer.name}</strong> è¡Œå‹•äº†ã€‚`, 'system');
    
    if (currentPlayer.isUser) {
        // ç”¨æˆ¶å›åˆ
        const actionArea = document.getElementById('ludo-action-area');
        actionArea.innerHTML = `
            <div id="ludo-dice-container" title="é»æ“Šæ“²éª°å­">
                <div class="dice">
                    <div class="face front">1</div><div class="face back">6</div>
                    <div class="face right">3</div><div class="face left">4</div>
                    <div class="face top">2</div><div class="face bottom">5</div>
                </div>
            </div>
        `;
        document.getElementById('ludo-dice-container').onclick = handleUserRollDice;
    } else {
        // AIå›åˆ
        document.getElementById('ludo-action-area').innerHTML = `<p>${currentPlayer.name} æ­£åœ¨æ€è€ƒ...</p>`;
        await sleep(2000);
const diceRoll = rollTheDice(currentPlayer); 
        await handlePlayerMove(currentPlayer, diceRoll, false);
    }
}

/**
 * ã€é£›è¡Œæ£‹ã€‘è™•ç†ç”¨æˆ¶æ“²éª°å­
 */
async function handleUserRollDice() {
    if (ludoGameState.isDiceRolling) return;
    ludoGameState.isDiceRolling = true;
    
    const diceEl = document.querySelector('.dice');
    diceEl.classList.add('rolling');
    document.getElementById('ludo-dice-container').onclick = null; // é˜²æ­¢é‡è¤‡é»æ“Š

    const userPlayer = ludoGameState.players.find(p => p.isUser); // å…ˆæ‰¾åˆ°ä½¿ç”¨è€…ç©å®¶ç‰©ä»¶
    const diceRoll = rollTheDice(userPlayer); // èª¿ç”¨æ–°å‡½æ•¸
    
    setTimeout(async () => {
        diceEl.classList.remove('rolling');
        // æ ¹æ“šé»æ•¸æ—‹è½‰åˆ°å°æ‡‰é¢ (é€™æ˜¯ä¸€å€‹ç°¡åŒ–çš„è¦–è¦ºæ•ˆæœ)
        const rotations = { 1: 'rotateY(0deg)', 2: 'rotateX(-90deg)', 3: 'rotateY(-90deg)', 4: 'rotateY(90deg)', 5: 'rotateX(90deg)', 6: 'rotateY(180deg)' };
        diceEl.style.transform = rotations[diceRoll];
        
        const userPlayer = ludoGameState.players.find(p => p.isUser);
        await handlePlayerMove(userPlayer, diceRoll, true);

        ludoGameState.isDiceRolling = false;
    }, 1500);
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ handlePlayerMove å‡½æ•¸ â–¼â–¼â–¼
async function handlePlayerMove(player, diceRoll, isUserMove) {
    logToLudoGame(`<strong>${player.name}</strong> æ“²å‡ºäº† <strong>${diceRoll}</strong> é»ï¼`, isUserMove ? 'user' : 'char');

    if (player.piecePosition === -1) { // å¦‚æœæ£‹å­é‚„åœ¨èµ·é»
        if (diceRoll === 6) {
            player.piecePosition = 0; // èµ·é£›åˆ°ç¬¬0æ ¼
            logToLudoGame(`<strong>${player.name}</strong> çš„æ£‹å­èµ·é£›äº†ï¼`, 'system');
            renderLudoGameScreen();
            
            if (!isUserMove) {
                await triggerLudoAiAction('roll_6');
            }
            logToLudoGame(`æ“²å‡º6é»ï¼Œ<strong>${player.name}</strong> å†è¡Œå‹•ä¸€æ¬¡ã€‚`, 'system');
            await sleep(1000);
            await processLudoTurn(); // é‡æ–°åŸ·è¡Œç•¶å‰ç©å®¶çš„å›åˆ
        } else {
            logToLudoGame('é»æ•¸ä¸æ˜¯6ï¼Œç„¡æ³•èµ·é£›ã€‚', 'system');
            await advanceTurn(); // åˆ‡æ›åˆ°ä¸‹ä¸€ä½ç©å®¶
        }
        return; // çµæŸæœ¬æ¬¡ç§»å‹•è™•ç†
    }

    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©å¾é€™è£¡é–‹å§‹ â–¼â–¼â–¼ ---

    const newPosition = player.piecePosition + diceRoll;
    const finalPositionIndex = LUDO_BOARD_SIZE - 1; // çµ‚é»æ ¼å­çš„ç´¢å¼•

    // 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªè¦æ–°ä½ç½®å¤§æ–¼æˆ–ç­‰æ–¼çµ‚é»ï¼Œå°±ç›´æ¥åˆ¤å®šå‹åˆ©ï¼
    if (newPosition >= finalPositionIndex) {
        player.piecePosition = finalPositionIndex; // ç„¡è«–æ“²å‡ºå¹¾é»ï¼Œéƒ½è®“æ£‹å­åœåœ¨çµ‚é»æ ¼å­ä¸Š
        renderLudoGameScreen();
        logToLudoGame(`ğŸ‰ <strong>${player.name}</strong> åˆ°é”äº†çµ‚é»ï¼`, 'system');
        await triggerLudoAiAction(isUserMove ? 'user_win' : 'char_win');
        ludoGameState.isActive = false;
        document.getElementById('ludo-action-area').innerHTML = '';
        await sleep(1000);
        showLudoSummary(player.name); // é¡¯ç¤ºçµç®—ä»‹é¢
        return; // éŠæˆ²çµæŸï¼Œç›´æ¥è¿”å›
    } 
    // 2. å¦‚æœä¸æ˜¯å‹åˆ©ï¼Œå°±æ­£å¸¸ç§»å‹•
    else {
        player.piecePosition = newPosition;
    }
    
    // --- â–²â–²â–² æ ¸å¿ƒä¿®å¾©åˆ°é€™è£¡çµæŸ â–²â–²â–² ---

    renderLudoGameScreen();
    await sleep(500);

    // æª¢æŸ¥æ˜¯å¦è¸©åˆ°å°æ–¹æ£‹å­
    const opponent = ludoGameState.players.find(p => p.id !== player.id);
    if (player.piecePosition === opponent.piecePosition && opponent.piecePosition !== -1) {
        opponent.piecePosition = -1; // å°‡å°æ–¹æ£‹å­é€å›èµ·é»
        logToLudoGame(`ğŸ’¥ <strong>${player.name}</strong> è¸©ä¸­äº† <strong>${opponent.name}</strong>ï¼`, 'system');
        renderLudoGameScreen();
        await triggerLudoAiAction(isUserMove ? 'kick_char' : 'kick_user');
        await sleep(1000);
    }
    
    // æª¢æŸ¥æ˜¯å¦è¸©åˆ°äº‹ä»¶æ ¼å­
    const cellIndex = ludoGameState.boardLayout.findIndex(c => c && c.index === player.piecePosition);
    if (cellIndex > -1 && ludoGameState.boardLayout[cellIndex].event) {
        const eventType = ludoGameState.boardLayout[cellIndex].event;
        if (eventType === 'question') {
            await handleLudoQuestionEvent(player);
            return;
        }
    }
    
    // å¦‚æœæ“²å‡º6é»ï¼Œå†è¡Œå‹•ä¸€æ¬¡
    if (diceRoll === 6) {
        if (!isUserMove) {
            await triggerLudoAiAction('roll_6');
        }
        logToLudoGame(`æ“²å‡º6é»ï¼Œ<strong>${player.name}</strong> å†è¡Œå‹•ä¸€æ¬¡ã€‚`, 'system');
        await sleep(1000);
        await processLudoTurn();
    } else {
        await advanceTurn(); // å¦å‰‡åˆ‡æ›åˆ°ä¸‹ä¸€ä½ç©å®¶
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



/**
 * ã€é£›è¡Œæ£‹ã€‘æ¨é€²åˆ°ä¸‹ä¸€å€‹å›åˆ
 */
async function advanceTurn() {
    ludoGameState.currentTurnIndex = (ludoGameState.currentTurnIndex + 1) % ludoGameState.players.length;
    await processLudoTurn();
}

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å„ªåŒ–å¾Œã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ triggerLudoAiAction å‡½æ•¸ â–¼â–¼â–¼
async function triggerLudoAiAction(eventType, context = {}) {
    const aiPlayer = ludoGameState.players.find(p => !p.isUser);
    const userPlayer = ludoGameState.players.find(p => p.isUser);

    const eventPrompts = {
        roll_6: "ä½ æ“²å‡ºäº†6é»ï¼Œå¯ä»¥å†è¡Œå‹•ä¸€æ¬¡ï¼",
        kick_char: "ä½ å‰›å‰›æŠŠæˆ‘è¸¢å›äº†èµ·é»ï¼",
        kick_user: "æˆ‘å‰›å‰›æŠŠä½ çš„æ£‹å­è¸¢å›äº†èµ·é»ï¼",
        char_win: "æˆ‘è´å¾—äº†é€™å ´éŠæˆ²ï¼",
        user_win: "ä½ è´å¾—äº†é€™å ´éŠæˆ²ï¼"
    };
    
    let eventPrompt = eventPrompts[eventType] || "è«‹æ ¹æ“šç•¶å‰æƒ…æ³è‡ªç”±ç™¼æ®ã€‚";
    
    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šç‚ºä¸åŒçš„å•ç­”å ´æ™¯æä¾›æ›´è©³ç´°çš„æŒ‡ä»¤ â–¼â–¼â–¼ ---
    if (eventType === 'answer_question') {
        eventPrompt = `ç¾åœ¨è«‹æ ¹æ“šä½ çš„äººè¨­ï¼Œè©³ç´°å›ç­”é€™å€‹å•é¡Œï¼šâ€œ${context.question}â€`;
    } else if (eventType === 'evaluate_answer') {
        eventPrompt = `å°æ–¼å•é¡Œâ€œ${context.question}â€ï¼Œå°æ–¹çš„å›ç­”æ˜¯ï¼šâ€œ${context.answer}â€ã€‚ç¾åœ¨è«‹ä½ ä»¥ä½ çš„è§’è‰²èº«ä»½ï¼Œå°é€™å€‹å›ç­”è©³ç´°åœ°ç™¼è¡¨ä¸€ä¸‹çœ‹æ³•æˆ–æ„Ÿå—ã€‚`;
    }

    const systemPrompt = `
# è§’è‰²æ‰®æ¼”æŒ‡ä»¤
ä½ æ­£åœ¨å’Œä½ çš„ä¼´ä¾¶(${userPlayer.name})ç©ä¸€å ´å¿ƒå‹•çš„ç·šä¸Šé£›è¡Œæ£‹éŠæˆ²ã€‚
ä½ çš„åå­—æ˜¯"${aiPlayer.name}"ï¼Œä½ çš„äººè¨­æ˜¯ï¼š${aiPlayer.persona}
ä½ çš„å›å¾©å¿…é ˆå®Œå…¨ç¬¦åˆä½ çš„äººè¨­ï¼Œè‡ªç„¶åœ°è¡¨é”ä½ çš„æƒ…ç·’ã€‚

# éŠæˆ²ç•¶å‰ç‹€æ…‹
- ä½ çš„æ£‹å­ä½ç½®: ${aiPlayer.piecePosition}
- å°æ–¹çš„æ£‹å­ä½ç½®: ${userPlayer.piecePosition}
- ç•¶å‰å›åˆ: è¼ªåˆ° ${ludoGameState.players[ludoGameState.currentTurnIndex].name}

# å‰›å‰›ç™¼ç”Ÿçš„äº‹ä»¶
${eventPrompt}

# ä½ çš„ä»»å‹™
æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼Œç”Ÿæˆä¸€æ®µç¬¦åˆä½ äººè¨­çš„å›æ‡‰ã€‚ä½ çš„å›æ‡‰å¯ä»¥åŒ…å«å‹•ä½œã€å¿ƒç†æ´»å‹•å’Œå°è©±ï¼Œè®“äº’å‹•æ›´ç”Ÿå‹•ï¼Œè¦éå¸¸çš„è²¼åˆä½ çš„äººè¨­ï¼Œä»¥äººè¨­ç‚ºä¸»ã€‚

# è¼¸å‡ºæ ¼å¼
ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹åš´æ ¼çš„JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹:
{"speech": "ä½ çš„å›æ‡‰..."}
`;
    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        const content = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '');
        const aiResponse = JSON.parse(content);

        if (eventType === 'answer_question' || eventType === 'evaluate_answer') {
            return aiResponse.speech || "å—¯...è®“æˆ‘æƒ³æƒ³ã€‚";
        }
        
        if (aiResponse.speech) {
            logToLudoGame(`<strong>${aiPlayer.name}:</strong> ${aiResponse.speech}`, 'char');
        }

    } catch (error) {
        console.error("é£›è¡Œæ£‹AIå›æ‡‰å¤±æ•—:", error);
        if (eventType === 'answer_question' || eventType === 'evaluate_answer') {
            return "æˆ‘...æˆ‘ä¸çŸ¥é“è©²æ€éº¼å›ç­”äº†ã€‚";
        }
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€çµ‚æ™ºæ…§ç‰ˆ | å•é¡Œæ•¸é‡ç²¾ç¢ºåŒ¹é…ã€‘ç”¨é€™å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ generateLudoBoard å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€é£›è¡Œæ£‹ã€‘ç”Ÿæˆæ£‹ç›¤æ ¼å­ (V4 - å•é¡Œæ•¸é‡ç²¾ç¢ºåŒ¹é…ç‰ˆ)
 */
async function generateLudoBoard() {
    const boardEl = document.getElementById('ludo-board');
    boardEl.innerHTML = '';
    const pathCoordinates = [
        [0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0],[9,0],
        [9,1],[9,2],[8,2],[7,2],[6,2],[5,2],[4,2],[3,2],[2,2],[1,2],[0,2],
        [0,3],[0,4],[1,4],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4],[8,4],[9,4],
        [9,5],[8,5],[7,5],[6,5],[5,5],[4,5],[3,5],[2,5],[1,5],[0,5]
    ];

    let cells = Array(60).fill(null);
    pathCoordinates.slice(0, LUDO_BOARD_SIZE).forEach((coord, i) => {
        const pos = coord[1] * 10 + coord[0];
        cells[pos] = { type: 'path', index: i };
    });

    cells[21] = { type: 'start', index: -1 };
    cells[38] = { type: 'end', index: LUDO_BOARD_SIZE };

    // --- â–¼â–¼â–¼ é€™å°±æ˜¯æœ¬æ¬¡çš„ã€æ ¸å¿ƒä¿®æ”¹ã€‘ â–¼â–¼â–¼ ---

    // 1. ç²å–ç•¶å‰éŠæˆ²é¸æ“‡çš„å•é¡Œåº«ID
    const questionBankId = ludoGameState.activeQuestionBankId;
    let questionsInBank = [];

    // 2. å¾è³‡æ–™åº«ä¸­è¼‰å…¥è©²å•é¡Œåº«çš„æ‰€æœ‰å•é¡Œ
    if (questionBankId) {
        questionsInBank = await db.ludoQuestions.where('bankId').equals(questionBankId).toArray();
    }
    
    // 3. ç¯©é¸å‡ºæ‰€æœ‰å¯ä»¥æ”¾ç½®å•é¡Œçš„æ™®é€šæ ¼å­
    const availableCellIndices = [];
    cells.forEach((cellData, index) => {
        // æˆ‘å€‘ä¸åœ¨èµ·é»ã€çµ‚é»ï¼Œä»¥åŠç·Šé„°èµ·é»çš„ç¬¬ä¸€æ ¼æ”¾å•é¡Œ
        if (cellData && cellData.type === 'path' && cellData.index > 0) {
            availableCellIndices.push(index);
        }
    });

    // 4. æ‰“äº‚é€™äº›æ ¼å­çš„é †åºï¼Œè®“å•é¡Œéš¨æ©Ÿåˆ†ä½ˆ
    availableCellIndices.sort(() => Math.random() - 0.5);

    // 5. ã€é—œéµã€‘ç¢ºå®šè¦æ”¾ç½®çš„å•é¡Œæ•¸é‡ï¼šå– å•é¡Œåº«ç¸½æ•¸ å’Œ å¯ç”¨æ ¼å­æ•¸ ä¸­è¼ƒå°çš„ä¸€å€‹
    const eventCount = Math.min(questionsInBank.length, availableCellIndices.length);
    
    // å¦‚æœå•é¡Œæ•¸é‡æ¯”å¯ç”¨æ ¼å­é‚„å¤šï¼Œçµ¦å€‹æç¤º
    if (questionsInBank.length > availableCellIndices.length) {
        console.warn(`é£›è¡Œæ£‹è­¦å‘Šï¼šå•é¡Œåº«ä¸­çš„å•é¡Œæ•¸é‡(${questionsInBank.length})è¶…éäº†æ£‹ç›¤ä¸Šçš„å¯ç”¨æ ¼å­æ•¸é‡(${availableCellIndices.length})ï¼Œéƒ¨åˆ†å•é¡Œå°‡ä¸æœƒå‡ºç¾ã€‚`);
    }
    
    // 6. æ”¾ç½®èˆ‡å•é¡Œåº«æ•¸é‡ç›¸ç­‰çš„å•è™Ÿæ ¼å­
    for (let i = 0; i < eventCount; i++) {
        const cellIndexToModify = availableCellIndices[i];
        if (cells[cellIndexToModify]) {
            cells[cellIndexToModify].event = 'question';
        }
    }
    
    // --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² ---

    ludoGameState.boardLayout = cells;

    // å¾ŒçºŒçš„æ¸²æŸ“é‚è¼¯ä¿æŒä¸è®Š...
    cells.forEach((cellData, i) => {
        if (cellData) {
            const cellEl = document.createElement('div');
            cellEl.className = 'ludo-cell';

            if(cellData.type === 'path') {
                cellEl.dataset.index = cellData.index;
                cellEl.innerHTML = `<span class="cell-number">${cellData.index + 1}</span>`;
            }
            if(cellData.type === 'start') {
                 cellEl.classList.add('start');
                 cellEl.innerHTML = 'ğŸ ';
            }
            if(cellData.type === 'end') {
                 cellEl.classList.add('end');
                 cellEl.innerHTML = 'ğŸ';
            }
            if (cellData.event === 'question') {
                cellEl.classList.add(`event-truth`);
                cellEl.innerHTML += 'â“';
            }
            
            const position = ludoGameState.boardLayout.indexOf(cellData);
            const row = Math.floor(position / 10);
            const col = position % 10;
            cellEl.style.gridRowStart = row + 1;
            cellEl.style.gridColumnStart = col + 1;
            
            boardEl.appendChild(cellEl);
        }
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„åŠŸèƒ½å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ã€æ­£ä¸Šæ–¹ã€‘ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼ï¼Œæ›¿æ›æ‰æ‰€æœ‰èˆŠçš„é£›è¡Œæ£‹å•é¡Œåº«æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/* --- ã€å…¨æ–° | V2åˆ†é¡ç‰ˆã€‘é£›è¡Œæ£‹å•é¡Œåº«åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ --- */

let activeQuestionBankId = null; // ç”¨æ–¼è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„å•é¡Œåº«ID
let editingQuestionId = null; // ç”¨æ–¼è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„å•é¡ŒID

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ migrateDefaultLudoQuestions å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€è³‡æ–™ç§»è½‰ã€‘åœ¨é¦–æ¬¡è¼‰å…¥æ™‚ï¼Œå°‡èˆŠçš„ç¡¬ç·¨ç¢¼å•é¡Œé·ç§»åˆ°è³‡æ–™åº«
 */
async function migrateDefaultLudoQuestions() {
    const defaultBankName = "é»˜èªé¡Œåº«";
    const existingBank = await db.ludoQuestionBanks.where('name').equals(defaultBankName).first();
    // å¦‚æœâ€œé»˜èªé¡Œåº«â€å·²ç¶“å­˜åœ¨ï¼Œå°±èªªæ˜é·ç§»éäº†ï¼Œç›´æ¥è¿”å›
    if (existingBank) return;
    
    console.log("æ­£åœ¨é·ç§»é£›è¡Œæ£‹é è¨­å•é¡Œåˆ°è³‡æ–™åº«...");

    // å‰µå»ºé»˜èªé¡Œåº«
    const bankId = await db.ludoQuestionBanks.add({ name: defaultBankName });
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå°‡å•é¡Œåº«æ”¹ç‚ºç‰©ä»¶é™£åˆ—ï¼Œä¸¦ç‚ºæ¯å€‹å•é¡Œæ·»åŠ é¡å‹ â˜…â˜…â˜…
    const defaultQuestions = [
        // --- é¡å‹1: å…±åŒå›ç­” (é›™æ–¹éƒ½éœ€è¦å›ç­”) ---
        { type: 'both_answer', text: 'å¦‚æœæˆ‘å€‘ä¸€èµ·å»æ—…è¡Œï¼Œä½ æœ€æƒ³å»å“ªè£¡ï¼Œç‚ºä»€éº¼ï¼Ÿ' },
        { type: 'both_answer', text: 'ä½ èªç‚ºä¸€æ®µå®Œç¾çš„é—œä¿‚ä¸­ï¼Œæœ€ä¸å¯æˆ–ç¼ºçš„ä¸‰å€‹è¦ç´ æ˜¯ä»€éº¼ï¼Ÿ' },
        { type: 'both_answer', text: 'åˆ†äº«ä¸€ä»¶æœ€è¿‘å› ç‚ºæˆ‘è€Œè®“ä½ æ„Ÿåˆ°å¿ƒå‹•æˆ–é–‹å¿ƒçš„å°äº‹ã€‚' },
        { type: 'both_answer', text: 'å›æ†¶ä¸€ä¸‹ï¼Œæˆ‘å€‘ç¬¬ä¸€æ¬¡è¦‹é¢æ™‚ï¼Œä½ å°æˆ‘çš„ç¬¬ä¸€å°è±¡æ˜¯ä»€éº¼ï¼Ÿ' },
        { type: 'both_answer', text: 'å¦‚æœæˆ‘å€‘å¯ä»¥ä¸€èµ·å­¸ç¿’ä¸€é …æ–°æŠ€èƒ½ï¼Œä½ å¸Œæœ›æ˜¯ä»€éº¼ï¼Ÿ' },
        { type: 'both_answer', text: 'æè¿°ä¸€å€‹ä½ æœ€å¸Œæœ›å’Œæˆ‘ä¸€èµ·åº¦éçš„å®Œç¾é€±æœ«ã€‚' },
        { type: 'both_answer', text: 'ä½ è¦ºå¾—æˆ‘å€‘ä¹‹é–“æœ€æœ‰é»˜å¥‘çš„ä¸€ä»¶äº‹æ˜¯ä»€éº¼ï¼Ÿ' },
        { type: 'both_answer', text: 'å¦‚æœç”¨ä¸€ç¨®å‹•ç‰©ä¾†å½¢å®¹æˆ‘ï¼Œä½ è¦ºå¾—æ˜¯ä»€éº¼ï¼Ÿç‚ºä»€éº¼ï¼Ÿ' },
        { type: 'both_answer', text: 'åœ¨æœªä¾†çš„ä¸€å¹´è£¡ï¼Œä½ æœ€æƒ³å’Œæˆ‘ä¸€èµ·å®Œæˆçš„ä¸€ä»¶äº‹æ˜¯ä»€éº¼ï¼Ÿ' },
        { type: 'both_answer', text: 'åˆ†äº«ä¸€éƒ¨ä½ æœ€è¿‘å¾ˆå–œæ­¡ã€ä¸¦ä¸”æƒ³æ¨è–¦çµ¦æˆ‘ä¸€èµ·çœ‹çš„é›»å½±æˆ–åŠ‡ã€‚' },
        { type: 'both_answer', text: 'æˆ‘å€‘ä¸‹æ¬¡ç´„æœƒï¼Œä½ å¸Œæœ›ç©¿ä»€éº¼é¢¨æ ¼çš„è¡£æœï¼Ÿ' },

        // --- é¡å‹2: ä¸€äººå›ç­”ï¼Œå°æ–¹è©•åƒ¹ ---
        { type: 'single_answer', text: 'æè¿°ä¸€ä¸‹æˆ‘æœ€è®“ä½ å¿ƒå‹•çš„ä¸€å€‹ç¬é–“ã€‚' },
        { type: 'single_answer', text: 'èª å¯¦åœ°èªªï¼Œæˆ‘åšçš„å“ªä»¶äº‹æ›¾ç¶“è®“ä½ å·å·ç”Ÿéæ°£ï¼Ÿ' },
        { type: 'single_answer', text: 'å¦‚æœæˆ‘æœ‰ä¸€ç¨®è¶…èƒ½åŠ›ï¼Œä½ å¸Œæœ›æ˜¯ä»€éº¼ï¼Ÿ' },
        { type: 'single_answer', text: 'çµ¦æˆ‘ä¸‰å€‹æœ€è²¼åˆ‡çš„æ¨™ç±¤ã€‚' },
        { type: 'single_answer', text: 'åœ¨ä½ å¿ƒè£¡ï¼Œæˆ‘çš„å½¢è±¡å’Œä½ çš„ç†æƒ³å‹æœ‰å¤šæ¥è¿‘ï¼Ÿ' },
        { type: 'single_answer', text: 'åˆ†äº«ä¸€å€‹ä½ è¦ºå¾—æˆ‘å¯èƒ½ä¸çŸ¥é“çš„ï¼Œé—œæ–¼ä½ çš„å°ç§˜å¯†ã€‚' },
        { type: 'single_answer', text: 'å¦‚æœæˆ‘å€‘çš„æ•…äº‹æ˜¯ä¸€é¦–æ­Œï¼Œä½ è¦ºå¾—æ­Œåæ‡‰è©²å«ä»€éº¼ï¼Ÿ' },
        { type: 'single_answer', text: 'èªªä¸€ä»¶ä½ è¦ºå¾—æˆ‘åšå¾—æ¯”ä½ å¥½/æ›´æ“…é•·çš„äº‹æƒ…ã€‚' },
        { type: 'single_answer', text: 'å¦‚æœå¯ä»¥å›åˆ°æˆ‘å€‘èªè­˜çš„ä»»æ„ä¸€å¤©ï¼Œä½ æœƒé¸æ“‡å“ªä¸€å¤©ï¼Œæƒ³åšä»€éº¼ï¼Ÿ' },
        { type: 'single_answer', text: 'ç”¨ä¸‰å€‹è©ä¾†å½¢å®¹ä½ çœ¼ä¸­çš„æˆ‘å€‘çš„é—œä¿‚ã€‚' }
    ];

    const questionsToAdd = defaultQuestions.map(q => ({
        bankId: bankId,
        text: q.text,
        type: q.type // <-- é—œéµä¿®å¾©ï¼šæŠŠé¡å‹ä¹Ÿå­˜é€²å»ï¼
    }));
    
    await db.ludoQuestions.bulkAdd(questionsToAdd);
    console.log(`æˆåŠŸé·ç§»äº† ${questionsToAdd.length} æ¢é»˜èªå•é¡Œã€‚`);
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * æ‰“é–‹å•é¡Œåº«ç®¡ç†å½ˆçª—
 */
async function openLudoQuestionBankManager() {
    await renderLudoQuestionBanks();
    document.getElementById('ludo-qbank-manager-modal').classList.add('visible');
}

/**
 * æ¸²æŸ“å•é¡Œåº«åˆ—è¡¨
 */
async function renderLudoQuestionBanks() {
    const listEl = document.getElementById('ludo-qbank-list');
    listEl.innerHTML = '';
    const banks = await db.ludoQuestionBanks.toArray();

    if (banks.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é‚„æ²’æœ‰å•é¡Œåº«ï¼Œé»æ“Šå³ä¸Šè§’â€œæ–°å»ºâ€å‰µå»ºä¸€å€‹å§ï¼</p>';
    } else {
        banks.forEach(bank => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `<div class="item-title">${bank.name}</div>`;
            item.addEventListener('click', () => openLudoQuestionEditor(bank.id, bank.name));
addLongPressListener(item, async () => {
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ï¼šåœ¨åŠŸèƒ½è¡¨è£¡å¢åŠ ä¸€å€‹ 'export' é¸é … â–¼â–¼â–¼
    const choice = await showChoiceModal(`æ“ä½œâ€œ${bank.name}â€`, [
        { text: 'âœï¸ é‡å‘½å', value: 'rename' },
        { text: 'ğŸ“¤ åŒ¯å‡º', value: 'export' }, // <-- æ–°å¢çš„åŒ¯å‡ºé¸é …
        { text: 'ğŸ—‘ï¸ åˆªé™¤', value: 'delete', isDanger: true }
    ]);

    if (choice === 'rename') {
        const newName = await showCustomPrompt('é‡å‘½åå•é¡Œåº«', 'è«‹è¼¸å…¥æ–°çš„åç¨±ï¼š', bank.name);
        if (newName && newName.trim()) {
            await db.ludoQuestionBanks.update(bank.id, { name: newName.trim() });
            await renderLudoQuestionBanks();
        }
    } else if (choice === 'export') {
        // â–¼â–¼â–¼ åœ¨é€™è£¡èª¿ç”¨æˆ‘å€‘æ–°å¯«çš„åŒ¯å‡ºå‡½æ•¸ â–¼â–¼â–¼
        await exportLudoQuestionBank(bank.id);
    } else if (choice === 'delete') {
        const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', `ç¢ºå®šè¦åˆªé™¤å•é¡Œåº«â€œ${bank.name}â€å—ï¼Ÿé€™å°‡åŒæ™‚åˆªé™¤åº«å…§æ‰€æœ‰å•é¡Œã€‚`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.transaction('rw', db.ludoQuestionBanks, db.ludoQuestions, async () => {
                await db.ludoQuestions.where('bankId').equals(bank.id).delete();
                await db.ludoQuestionBanks.delete(bank.id);
            });
            await renderLudoQuestionBanks();
        }
    }
});
            listEl.appendChild(item);
        });
    }
}

/**
 * æ·»åŠ ä¸€å€‹æ–°çš„å•é¡Œåº«
 */
async function addNewLudoQuestionBank() {
    const name = await showCustomPrompt('æ–°å»ºå•é¡Œåº«', 'è«‹è¼¸å…¥å•é¡Œåº«çš„åç¨±ï¼š');
    if (name && name.trim()) {
        await db.ludoQuestionBanks.add({ name: name.trim() });
        await renderLudoQuestionBanks();
    }
}

/**
 * æ‰“é–‹æŒ‡å®šå•é¡Œåº«çš„å•é¡Œç·¨è¼¯å™¨
 */
async function openLudoQuestionEditor(bankId, bankName) {
    activeQuestionBankId = bankId;
    document.getElementById('ludo-question-editor-title').textContent = `ç·¨è¼¯ - ${bankName}`;
    await renderLudoQuestionsInBank(bankId);
    document.getElementById('ludo-question-editor-modal').classList.add('visible');
}

/**
 * æ¸²æŸ“ä¸€å€‹å•é¡Œåº«ä¸­çš„æ‰€æœ‰å•é¡Œ
 */
async function renderLudoQuestionsInBank(bankId) {
    const listEl = document.getElementById('ludo-question-list');
    listEl.innerHTML = '';
    const questions = await db.ludoQuestions.where('bankId').equals(bankId).toArray();

    if (questions.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é€™å€‹é¡Œåº«é‚„æ˜¯ç©ºçš„ï¼Œé»æ“Šå³ä¸Šè§’â€œ+â€æ·»åŠ ç¬¬ä¸€å€‹å•é¡Œå§ï¼</p>';
    } else {
        questions.forEach(q => {
            const item = document.createElement('div');
            item.className = 'list-item';
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ“šå•é¡Œé¡å‹æ·»åŠ æ¨™ç±¤ â˜…â˜…â˜…
            const typeText = q.type === 'single_answer' ? 'ä¸€äººå›ç­”' : 'å…±åŒå›ç­”';
            const typeClass = q.type === 'single_answer' ? 'single-answer' : 'both-answer';
            
            item.innerHTML = `
                <div class="item-title" style="white-space: normal; display: flex; align-items: center;">
                    <span>${q.text}</span>
                    <span class="question-type-tag ${typeClass}">${typeText}</span>
                </div>
            `;
            
            item.addEventListener('click', () => openSingleQuestionEditor(q.id));
            addLongPressListener(item, async () => {
                const confirmed = await showCustomConfirm('åˆªé™¤å•é¡Œ', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹å•é¡Œå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
                if(confirmed) {
                    await db.ludoQuestions.delete(q.id);
                    await renderLudoQuestionsInBank(bankId);
                }
            });
            listEl.appendChild(item);
        });
    }
}

/**
 * æ‰“é–‹å–®å€‹å•é¡Œç·¨è¼¯å™¨ï¼ˆç”¨æ–¼æ–°å»ºæˆ–ç·¨è¼¯ï¼‰
 */
async function openSingleQuestionEditor(questionId = null) {
    editingQuestionId = questionId;
    const modal = document.getElementById('ludo-single-question-editor-modal');
    const titleEl = document.getElementById('ludo-single-question-title');
    const textInput = document.getElementById('ludo-question-text-input');
    const typeRadios = document.querySelectorAll('input[name="ludo_question_type"]');

    if (questionId) {
        // ç·¨è¼¯æ¨¡å¼
        const question = await db.ludoQuestions.get(questionId);
        if (!question) return;
        titleEl.textContent = 'ç·¨è¼¯å•é¡Œ';
        textInput.value = question.text;
        typeRadios.forEach(radio => radio.checked = radio.value === (question.type || 'both_answer'));
    } else {
        // æ–°å»ºæ¨¡å¼
        titleEl.textContent = 'æ·»åŠ æ–°å•é¡Œ';
        textInput.value = '';
        typeRadios[0].checked = true; // é»˜èªé¸ä¸­â€œå…±åŒå›ç­”â€
    }
    
    modal.classList.add('visible');
}

/**
 * ä¿å­˜å–®å€‹å•é¡Œï¼ˆæ–°å»ºæˆ–æ›´æ–°ï¼‰
 */
async function saveSingleQuestion() {
    const text = document.getElementById('ludo-question-text-input').value.trim();
    if (!text) {
        alert('å•é¡Œå…§å®¹ä¸èƒ½ç‚ºç©ºï¼');
        return;
    }
    const type = document.querySelector('input[name="ludo_question_type"]:checked').value;

    if (editingQuestionId) {
        // æ›´æ–°
        await db.ludoQuestions.update(editingQuestionId, { text, type });
    } else {
        // æ–°å»º
        await db.ludoQuestions.add({ bankId: activeQuestionBankId, text, type });
    }

    document.getElementById('ludo-single-question-editor-modal').classList.remove('visible');
    await renderLudoQuestionsInBank(activeQuestionBankId); // åˆ·æ–°åˆ—è¡¨
    editingQuestionId = null;
}

/**
 * é£›è¡Œæ£‹è§¸ç™¼å•ç­”äº‹ä»¶çš„ç¸½æ§å‡½æ•¸
 */
async function handleLudoQuestionEvent(player) {
    const questionBankId = ludoGameState.activeQuestionBankId;
    let questions = [];
    if (questionBankId) {
        questions = await db.ludoQuestions.where('bankId').equals(questionBankId).toArray();
    }

    if (questions.length === 0) {
        logToLudoGame('ç•¶å‰é¡Œåº«æ˜¯ç©ºçš„ï¼Œè·³éæœ¬è¼ªå•ç­”ã€‚', 'system');
        await sleep(1500);
        await advanceTurn();
        return;
    }

    const questionObj = getRandomItem(questions);
    const questionText = questionObj.text;
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†å½ˆçª—è®“ä½¿ç”¨è€…é¸æ“‡ï¼Œç›´æ¥å¾å•é¡Œç‰©ä»¶ä¸­ç²å–æ¨¡å¼ â˜…â˜…â˜…
    const mode = questionObj.type || 'both_answer'; // å¦‚æœè€è³‡æ–™æ²’æœ‰typeï¼Œå‰‡é è¨­ç‚ºå…±åŒå›ç­”
    
    logToLudoGame(`ã€${mode === 'both_answer' ? 'å…±åŒå›ç­”' : 'ä¸€äººå›ç­”ï¼Œä¸€äººè©•åƒ¹'}ã€‘æŠ½åˆ°çš„å•é¡Œæ˜¯ï¼šâ€œ${questionText}â€`, 'system');
    await sleep(1500);

    const currentPlayer = player;
    const otherPlayer = ludoGameState.players.find(p => p.id !== currentPlayer.id);

    if (mode === 'both_answer') {
        logToLudoGame(`è«‹ <strong>${currentPlayer.name}</strong> å…ˆå›ç­”ã€‚`, 'system');
        let answer1 = currentPlayer.isUser 
            ? await waitForLudoUserAction('è¼ªåˆ°ä½ å›ç­”å•é¡Œ', 'è«‹è¼¸å…¥ä½ çš„å›ç­”...')
            : await triggerLudoAiAction('answer_question', { question: questionText });
        logToLudoGame(`<strong>${currentPlayer.name}:</strong> ${answer1}`, currentPlayer.isUser ? 'user' : 'char');
        await sleep(2000);

        logToLudoGame(`ç¾åœ¨è«‹ <strong>${otherPlayer.name}</strong> å›ç­”ã€‚`, 'system');
        let answer2 = otherPlayer.isUser 
            ? await waitForLudoUserAction('è¼ªåˆ°ä½ å›ç­”å•é¡Œ', 'è«‹è¼¸å…¥ä½ çš„å›ç­”...')
            : await triggerLudoAiAction('answer_question', { question: questionText });
        logToLudoGame(`<strong>${otherPlayer.name}:</strong> ${answer2}`, otherPlayer.isUser ? 'user' : 'char');
    
    } else if (mode === 'single_answer') {
        logToLudoGame(`è«‹ <strong>${currentPlayer.name}</strong> å›ç­”é€™å€‹å•é¡Œã€‚`, 'system');
        let answer = currentPlayer.isUser
            ? await waitForLudoUserAction('è¼ªåˆ°ä½ å›ç­”å•é¡Œ', 'è«‹è¼¸å…¥ä½ çš„å›ç­”...')
            : await triggerLudoAiAction('answer_question', { question: questionText });
        logToLudoGame(`<strong>${currentPlayer.name}:</strong> ${answer}`, currentPlayer.isUser ? 'user' : 'char');
        await sleep(2000);

        logToLudoGame(`ç¾åœ¨è«‹ <strong>${otherPlayer.name}</strong> å°Taçš„å›ç­”ç™¼è¡¨ä¸€ä¸‹çœ‹æ³•å§ã€‚`, 'system');
        let evaluation = otherPlayer.isUser
            ? await waitForLudoUserAction(`å°â€œ${answer}â€çš„çœ‹æ³•`, 'è«‹è¼¸å…¥ä½ çš„è©•åƒ¹...')
            : await triggerLudoAiAction('evaluate_answer', { question: questionText, answer: answer });
        logToLudoGame(`<strong>${otherPlayer.name}:</strong> ${evaluation}`, otherPlayer.isUser ? 'user' : 'char');
    }

    await sleep(1500);
    logToLudoGame('æœ¬è¼ªå•ç­”çµæŸï¼ŒéŠæˆ²ç¹¼çºŒï¼', 'system');
    await advanceTurn();
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘é¡¯ç¤ºé£›è¡Œæ£‹éŠæˆ²çµç®—å¡ç‰‡
 * @param {string} winnerName - å‹åˆ©è€…çš„åå­—
 */
function showLudoSummary(winnerName) {
    const modal = document.getElementById('ludo-summary-modal');
    const contentEl = document.getElementById('ludo-summary-content');

    // 1. æå–å•ç­”è¨˜éŒ„æª”
    let qaLogHtml = '<h4>å¿ƒå‹•å•ç­”è¨˜éŒ„æª”</h4>';
    const questionsAndAnswers = [];
    let currentQuestion = null;

    ludoGameState.gameLog.forEach(log => {
        // é€šéè­˜è®€ç³»çµ±æ—¥èªŒè£¡çš„ç‰¹å®šæ–‡æœ¬ä¾†æ‰¾åˆ°â€œå•é¡Œâ€
        if (log.type === 'system' && log.message.includes('æŠ½åˆ°çš„å•é¡Œæ˜¯')) {
            const questionText = log.message.match(/â€œ(.+?)â€/);
            if (questionText && questionText[1]) {
                currentQuestion = { question: questionText[1], answers: [] };
                questionsAndAnswers.push(currentQuestion);
            }
        } 
        // å¦‚æœæˆ‘å€‘å‰›å‰›æ‰¾åˆ°äº†ä¸€å€‹å•é¡Œï¼Œé‚£éº¼å¾ŒçºŒçš„ç”¨æˆ¶æˆ–è§’è‰²ç™¼è¨€å°±æ˜¯â€œå›ç­”â€
        else if (currentQuestion && (log.type === 'user' || log.type === 'char') && !log.message.includes('æ“²å‡ºäº†')) {
            const answerText = log.message.replace(/<strong>.*?<\/strong>:\s*/, '');
            const speakerNameMatch = log.message.match(/<strong>(.*?)<\/strong>/);
            if (speakerNameMatch && speakerNameMatch[1]) {
                currentQuestion.answers.push({ speaker: speakerNameMatch[1], text: answerText });
            }
        }
    });
    
    // 2. å°‡æå–å‡ºçš„å•ç­”è¨˜éŒ„æª”æ ¼å¼åŒ–ç‚ºHTML
    if(questionsAndAnswers.length > 0){
        questionsAndAnswers.forEach((qa, index) => {
            qaLogHtml += `<div class="qa-item">
                <div class="qa-question">Q${index + 1}: ${qa.question}</div>`;
            qa.answers.forEach(ans => {
                 qaLogHtml += `<div class="qa-answer"><strong>${ans.speaker}:</strong> ${ans.text}</div>`;
            });
            qaLogHtml += `</div>`;
        });
    } else {
        qaLogHtml += '<p>æœ¬å±€æ²’æœ‰è§¸ç™¼ä»»ä½•å•ç­”ã€‚</p>';
    }

    // 3. æ‹¼æ¥å®Œæ•´çš„çµç®—å¡ç‰‡å…§å®¹
    contentEl.innerHTML = `
        <h3>ğŸ‰ æ­å–œ ${winnerName} ç²å‹ï¼ ğŸ‰</h3>
        <div class="ludo-qa-log">${qaLogHtml}</div>
    `;
    
    // 4. ç‚ºæŒ‰éˆ•ç¶å®šäº‹ä»¶ (ä½¿ç”¨å…‹éš†ç¯€é»æŠ€å·§é˜²æ­¢é‡è¤‡ç¶å®š)
    const shareBtn = document.getElementById('share-ludo-summary-btn');
    const backBtn = document.getElementById('back-to-hall-from-ludo-btn');
    
    const newShareBtn = shareBtn.cloneNode(true);
    shareBtn.parentNode.replaceChild(newShareBtn, shareBtn);
    newShareBtn.onclick = () => {
        // æº–å‚™ç´”æ–‡å­—æ ¼å¼çš„è¤‡ç›¤å…§å®¹ç”¨æ–¼åˆ†äº«
        const summaryForShare = `é£›è¡Œæ£‹éŠæˆ²çµæŸå•¦ï¼ğŸ‰\n\nå‹åˆ©è€…: ${winnerName}\n\n--- å¿ƒå‹•å•ç­” ---\n` + 
            questionsAndAnswers.map((qa, i) => 
                `Q${i+1}: ${qa.question}\n` + 
                qa.answers.map(ans => `${ans.speaker}: ${ans.text}`).join('\n')
            ).join('\n\n');
        
        shareLudoSummary(summaryForShare, winnerName);
    };

    const newBackBtn = backBtn.cloneNode(true);
    backBtn.parentNode.replaceChild(newBackBtn, backBtn);
    newBackBtn.onclick = () => {
        modal.classList.remove('visible');
        showScreen('game-hall-screen');
    };

    // 5. é¡¯ç¤ºçµç®—å½ˆçª—
    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘å°‡é£›è¡Œæ£‹éŠæˆ²è¤‡ç›¤ç™¼é€çµ¦å°æ‰‹
 * @param {string} summaryText - è¦ç™¼é€çš„è¤‡ç›¤æ–‡æœ¬
 */
async function shareLudoSummary(summaryText, winnerName) { 
    const opponentId = ludoGameState.opponent?.id;
    if (!opponentId) {
        alert("æ‰¾ä¸åˆ°å°æ‰‹è³‡è¨Šï¼Œç„¡æ³•åˆ†äº«ã€‚");
        return;
    }

    const chat = state.chats[opponentId];
    if (!chat) {
         alert("æ‰¾ä¸åˆ°èˆ‡å°æ‰‹çš„èŠå¤©çª—å£ï¼Œç„¡æ³•åˆ†äº«ã€‚");
        return;
    }

    // å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„è¤‡ç›¤æ¶ˆæ¯
    const visibleMessage = {
        role: 'user',
        type: 'text',
        timestamp: Date.now(),
        content: summaryText
    };
    
    // å‰µå»ºçµ¦AIçœ‹çš„éš±è—æŒ‡ä»¤ï¼Œè®“å®ƒå¯ä»¥å°±éŠæˆ²çµæœç™¼è¡¨æ„Ÿæƒ³
    const aiContext = `[ç³»çµ±æŒ‡ä»¤ï¼šå‰›å‰›çµæŸäº†ä¸€å±€é£›è¡Œæ£‹ã€‚é‡è¦ï¼šæœ¬æ¬¡éŠæˆ²çš„å‹åˆ©è€…æ˜¯ã€${winnerName}ã€‘ã€‚é€™æ˜¯éŠæˆ²è¤‡ç›¤ï¼Œè«‹æ ¹æ“šé€™å€‹çµæœï¼Œä»¥ä½ çš„è§’è‰²äººè¨­ï¼Œå’Œç”¨æˆ¶èŠèŠå‰›æ‰çš„éŠæˆ²ã€‚]\n\n${summaryText}`;
    const hiddenInstruction = {
        role: 'system',
        content: aiContext,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    
    chat.history.push(visibleMessage, hiddenInstruction);
    await db.chats.put(chat);

    // é—œé–‰çµç®—å¡ç‰‡
    document.getElementById('ludo-summary-modal').classList.remove('visible');
    
    await showCustomAlert("åˆ†äº«æˆåŠŸ", `éŠæˆ²è¤‡ç›¤å·²ç™¼é€è‡³èˆ‡â€œ${chat.name}â€çš„èŠå¤©ä¸­ï¼`);

    // è·³è½‰åˆ°èŠå¤©ä»‹é¢ä¸¦è®“AIå›æ‡‰
    openChat(chat.id);
    triggerAiResponse();
}


// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // ===================================================================
        // 4. åˆå§‹åŒ–å‡½æ•¸ init()
        // ===================================================================
        async function init() {
await migrateDefaultLudoQuestions();
    // â–¼â–¼â–¼ åœ¨ init()    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™å¹¾è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
    // æ›´æ–°å°å…ƒä»¶çš„æœˆä»½é¡¯ç¤º
    const monthElement = document.getElementById('widget-month-display');
    if (monthElement) {
        const currentMonth = new Date().getMonth() + 1; // getMonth()è¿”å›0-11ï¼Œæ‰€ä»¥è¦+1
        monthElement.textContent = currentMonth;
    }
    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² å‡½æ•¸çš„ã€æœ€é–‹é ­ã€‘ï¼Œé»è²¼ä¸‹é¢é€™å…©è¡Œä»£ç¢¼ â–¼â–¼â–¼
    const savedTheme = localStorage.getItem('ephone-theme') || 'light'; // é è¨­ç‚ºæ—¥é–“æ¨¡å¼
    applyTheme(savedTheme);
    // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

    // â–¼â–¼â–¼ æ–°å¢ä»£ç¢¼ â–¼â–¼â–¼
    const customBubbleStyleTag = document.createElement('style');
    customBubbleStyleTag.id = 'custom-bubble-style';
    document.head.appendChild(customBubbleStyleTag);
    // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

    // â–¼â–¼â–¼ æ–°å¢ä»£ç¢¼ â–¼â–¼â–¼
    const previewBubbleStyleTag = document.createElement('style');
    previewBubbleStyleTag.id = 'preview-bubble-style';
    document.head.appendChild(previewBubbleStyleTag);
    // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²


    // â–¼â–¼â–¼ ä¿®æ”¹é€™å…©è¡Œ â–¼â–¼â–¼
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå¯¦èŠå¤©ä»‹é¢çš„è‡ªè¨‚æ¨£å¼
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é è¦½å€çš„è‡ªè¨‚æ¨£å¼
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

            window.showScreen = showScreen;
            window.openLoversSpaceFromCard = openLoversSpaceFromCard; // <-- åœ¨é€™è£¡æ·»åŠ é€™ä¸€è¡Œ
            window.renderChatListProxy = renderChatList;
            window.renderApiSettingsProxy = renderApiSettings;
            window.renderWallpaperScreenProxy = renderWallpaperScreen;
            window.renderWorldBookScreenProxy = renderWorldBookScreen;

            await loadAllDataFromDB();
            // åœ¨ loadAllDataFromDB å‡½æ•¸æœ«å°¾ï¼Œinit(); èª¿ç”¨ä¹‹å‰æ·»åŠ 
if (typeof state.globalSettings.notificationSoundUrl === 'undefined') {
    state.globalSettings.notificationSoundUrl = 'https://files.catbox.moe/k369mf.mp3';
}
            // â–¼â–¼â–¼ æŠŠæ–°ä»£ç¢¼é»è²¼åˆ°é€™è£¡ â–¼â–¼â–¼
            renderHomeScreenProfileFrame(); // åˆå§‹åŒ–æ™‚æ¸²æŸ“ä¸»é é ­åƒæ¡†
            // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
            applyHomeIconWidgetTextColor(state.globalSettings.homeIconWidgetTextColor);
            await loadAllFontPresetsOnStartup(); // <---- åœ¨é€™è£¡æ·»åŠ é€™ä¸€è¡Œæ–°ä»£ç¢¼
            await addDefaultDarkModeThemeIfNeeded();
            applyWidgetData();

if (state.globalSettings.homeIconWidgetTextColor) {
    applyHomeIconWidgetTextColor(state.globalSettings.homeIconWidgetTextColor);
}

// 2. æ‡‰ç”¨å·²ä¿å­˜çš„â€œå»é™¤é™°å½±â€è¨­ç½®
document.getElementById('phone-screen').classList.toggle('no-home-font-shadow', !!state.globalSettings.removeHomeFontShadow);

            // åˆå§‹åŒ–æœªè®€å‹•æ…‹è¨ˆæ•¸
            const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
            updateUnreadIndicator(storedCount);
            
            // â–²â–²â–² ä»£ç¢¼æ·»åŠ çµæŸ â–²â–²â–²

            if (state.globalSettings && state.globalSettings.fontUrl) {
                applyCustomFont(state.globalSettings.fontUrl);
            }

    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
    // ã€æ ¸å¿ƒä¿®å¾©ã€‘åˆå§‹åŒ–æ™‚ï¼Œè‡ªå‹•è¼‰å…¥ä¸¦æ‡‰ç”¨å·²ä¿å­˜çš„ä¸»é¡Œ
    if (state.globalSettings.activeThemeId) {
        const activeTheme = await db.themes.get(state.globalSettings.activeThemeId);
        if (activeTheme) {
            console.log(`æ­£åœ¨æ‡‰ç”¨å·²ä¿å­˜çš„ä¸»é¡Œ: "${activeTheme.name}"`);
            applyThemeCss(activeTheme.css);
        }
    }
    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

            updateClock();
            setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 

applyAppIcons();
applyAppLabels();
    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œä»£ç¢¼ â–¼â–¼â–¼
    initDraggableLyricsBar(); // åˆå§‹åŒ–æ‡¸æµ®æ­Œè©æ¬„çš„æ‹–å‹•åŠŸèƒ½
    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

            // ==========================================================
            // --- å„ç¨®äº‹ä»¶ç›£è½å™¨ ---
            // ==========================================================
            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œæ·»åŠ ä¸‹é¢é€™è¡Œä»£ç¢¼ â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ weibo-screen äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥è§’è‰²æ‰‹æ©Ÿâ€åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ (V2 - å–®ç¨ç”Ÿæˆç‰ˆ) â–¼â–¼â–¼

            // 1. ç¶å®šä¸»è¢å¹•ä¸Šçš„â€œæŸ¥æ‰‹æ©Ÿâ€APPåœ–ç¤º
            document.getElementById('check-phone-btn').addEventListener('click', openCharacterSelectionScreen);

            // 2. è§’è‰²é¸æ“‡åˆ—è¡¨çš„é»æ“Šäº‹ä»¶ (äº‹ä»¶å§”è¨—)
            document.getElementById('character-selection-list').addEventListener('click', (e) => {
                const item = e.target.closest('.character-select-item');
                if (item && item.dataset.chatId) {
                    openCharacterPhone(item.dataset.chatId);
                }
            });

            // 3. ã€ç¸½ç”Ÿæˆ/æ¸…ç©ºã€‘è§’è‰²æ‰‹æ©Ÿé ‚éƒ¨çš„â€œåˆ·æ–°â€å’Œâ€œæ¸…ç©ºâ€æŒ‰éˆ•
            document.getElementById('generate-character-data-btn').addEventListener('click', generateCharacterPhoneData);
            document.getElementById('clear-character-data-btn').addEventListener('click', clearCharacterPhoneData);

// â–¼â–¼â–¼ è«‹ç”¨é€™ä¸€æ•´å¡Šã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ character-phone-container äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('character-phone-container').addEventListener('click', (e) => {
    const backBtn = e.target.closest('.back-btn');
    const actionBtn = e.target.closest('.action-btn');

    // 1. è™•ç†è¿”å›æŒ‰éˆ•
    if (backBtn) {
        if (backBtn.dataset.targetPage) {
            showCharacterPhonePage(backBtn.dataset.targetPage);
        } else if (backBtn.dataset.targetScreen) {
            showScreen(backBtn.dataset.targetScreen);
        }
        return;
    }
    
    // 2. è™•ç†æ‰€æœ‰æ“ä½œæŒ‰éˆ•ï¼ˆç”Ÿæˆ + åˆªé™¤ï¼‰
    if (actionBtn) {
        switch (actionBtn.id) {
            // --- å–®ç¨ç”ŸæˆæŒ‰éˆ• ---
            case 'generate-chat-message-btn': 
                generateCharacterPhoneDataSegment('chats'); break;
            case 'generate-cart-item-btn':
                generateCharacterPhoneDataSegment('shoppingCart'); break;
            case 'generate-memo-btn':
                generateCharacterPhoneDataSegment('memos'); break;
            case 'generate-browser-history-btn':
                generateCharacterPhoneDataSegment('browserHistory'); break;
            case 'generate-album-photo-btn':
                generateCharacterPhoneDataSegment('photoAlbum'); break;
            case 'generate-bank-transaction-btn':
                generateCharacterPhoneDataSegment('bank'); break;
            case 'generate-trajectory-btn':
                generateCharacterPhoneDataSegment('trajectory'); break;
            case 'generate-app-usage-btn':
                generateCharacterPhoneDataSegment('appUsage'); break;
            case 'generate-diary-entry-btn':
                generateCharacterPhoneDataSegment('diary'); break;

            // --- â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘æ–°å¢çš„å…¨éƒ¨åˆªé™¤æŒ‰éˆ•çš„é‚è¼¯ â˜…â˜…â˜… ---
            case 'clear-npc-chats-btn':
                handleClearCharacterDataSegment('chats'); break;
            case 'clear-cart-items-btn':
                handleClearCharacterDataSegment('shoppingCart'); break;
            case 'clear-memos-btn':
                handleClearCharacterDataSegment('memos'); break;
            case 'clear-browser-history-btn':
                handleClearCharacterDataSegment('browserHistory'); break;
            case 'clear-album-photos-btn':
                handleClearCharacterDataSegment('photoAlbum'); break;
            case 'clear-bank-transactions-btn':
                handleClearCharacterDataSegment('bank.transactions'); break;
            case 'clear-trajectory-btn':
                handleClearCharacterDataSegment('trajectory'); break;
            case 'clear-app-usage-btn':
                handleClearCharacterDataSegment('appUsage'); break;
            case 'clear-diary-entries-btn':
                handleClearCharacterDataSegment('diary'); break;
        }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€V3æœ€çµ‚ç¾åŒ–ç‰ˆã€‘ä¸»è¢å¹•é è¨­åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('home-preset-selector').addEventListener('change', handleHomePresetSelection);
document.getElementById('apply-home-preset-btn').addEventListener('click', applySelectedHomeScreenPreset);
// ã€æ ¸å¿ƒä¿®æ”¹ã€‘é€™è£¡æŒ‰éˆ•çš„IDè®Šäº†
document.getElementById('save-home-preset-btn').addEventListener('click', saveCurrentHomeScreenAsPreset); 
document.getElementById('update-home-preset-btn').addEventListener('click', updateSelectedHomeScreenPreset); // <-- æ–°å¢é€™ä¸€è¡Œ
document.getElementById('rename-home-preset-btn').addEventListener('click', renameSelectedHomeScreenPreset);
document.getElementById('delete-home-preset-btn').addEventListener('click', deleteSelectedHomeScreenPreset);
document.getElementById('export-home-preset-btn').addEventListener('click', exportHomeScreenPreset);
document.getElementById('import-home-preset-btn').addEventListener('click', () => document.getElementById('import-home-preset-input').click());
document.getElementById('import-home-preset-input').addEventListener('change', (e) => {
    importHomeScreenPreset(e.target.files[0]);
    e.target.value = null;
});

            document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è¨˜éŒ„æœç´¢åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('search-chat-btn').addEventListener('click', openChatSearchScreen);

document.getElementById('search-back-btn').addEventListener('click', () => {
    // è¿”å›æ™‚ï¼Œé‡æ–°æ‰“é–‹èŠå¤©è¨­ç½®å½ˆçª—
    showScreen('chat-interface-screen');
    document.getElementById('chat-settings-btn').click();
});

document.getElementById('perform-search-btn').addEventListener('click', performChatSearch);

// ä½¿ç”¨äº‹ä»¶å§”è¨—ä¾†è™•ç†æ‰€æœ‰æœç´¢çµæœçš„é»æ“Š
document.getElementById('chat-search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item && item.dataset.timestamp) {
        jumpToMessage(parseInt(item.dataset.timestamp));
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼

document.getElementById('create-weibo-post-btn').addEventListener('click', openWeiboPublisherClean);

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼ä¸‹é¢é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('delete-expired-songs-btn').addEventListener('click', deleteExpiredSearchedSongs);
// â–¼â–¼â–¼ ã€ä¿®æ”¹ã€‘ç”¨é€™å¡Šã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ weibo-following-list-container äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('weibo-following-list-container').addEventListener('click', (e) => {
    const item = e.target.closest('.weibo-following-item');
    if (!item) return;

    // 1. æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯â€œæ“ä½œâ€æŒ‰éˆ•
    const triggerBtn = e.target.closest('.weibo-action-trigger-btn');
    if (triggerBtn) {
        const targetInfo = {
            id: triggerBtn.dataset.targetId,
            name: triggerBtn.dataset.targetName,
            isNpc: triggerBtn.dataset.isNpc === 'true',
            ownerId: triggerBtn.dataset.ownerId || null
        };
        openWeiboActionModal(targetInfo);
    } 
    // 2. å¦‚æœé»æ“Šçš„ä¸æ˜¯æ“ä½œæŒ‰éˆ•ï¼Œå°±è¦–ç‚ºé»æ“Šäº†æ•´è¡Œï¼Œè§¸ç™¼â€œæŸ¥çœ‹ç§ä¿¡â€
    else {
        // å…ˆéš±è—ç•¶å‰çš„é—œæ³¨åˆ—è¡¨å½ˆçª—
        document.getElementById('weibo-following-modal').classList.remove('visible');
        
        // å¾æ•´è¡Œitemä¸Šç²å–è§’è‰²è³‡è¨Š
        const actionBtn = item.querySelector('.weibo-action-trigger-btn'); // æ‰¾åˆ°é€™ä¸€è¡Œçš„æŒ‰éˆ•ä»¥ç²å–è³‡æ–™
        if (actionBtn) {
            const targetInfo = {
                id: actionBtn.dataset.targetId,
                name: actionBtn.dataset.targetName,
                isNpc: actionBtn.dataset.isNpc === 'true',
                ownerId: actionBtn.dataset.ownerId || null
            };
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šèª¿ç”¨æˆ‘å€‘æ–°å¯«çš„ç¸½å…¥å£å‡½æ•¸ â˜…â˜…â˜…
            openWeiboDms(targetInfo);
        }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
document.getElementById('cancel-weibo-action-btn').addEventListener('click', () => {
    document.getElementById('weibo-action-modal').classList.remove('visible');
});

document.getElementById('confirm-weibo-action-btn').addEventListener('click', handleWeiboAiAction);

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// ã€å·²ä¿®æ”¹ã€‘ç‚ºâ€œç”Ÿæˆç†±æœâ€å’Œâ€œç”Ÿæˆå»£å ´â€æŒ‰éˆ•ç¶å®šæ–°çš„å¸¶è§’è‰²é¸æ“‡çš„äº‹ä»¶
document.getElementById('generate-hot-search-btn').addEventListener('click', async () => {
    const targets = await showMultiCharacterSelectorForWeibo(); // èª¿ç”¨æ–°çš„å¤šé¸å‡½æ•¸
    if (targets) { 
        await generateHotSearch(targets); 
    }
});
document.getElementById('generate-plaza-feed-btn').addEventListener('click', async () => {
    const targets = await showMultiCharacterSelectorForWeibo();
    if (targets) {
        await generatePlazaFeed(null, targets); 
    }
});


// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

// --- å¾®åšç†±æœèˆ‡å»£å ´åŠŸèƒ½äº‹ä»¶ç¶å®š ---

// 1. ç¶å®šç†±æœè©³æƒ…é çš„â€œè¿”å›â€æŒ‰éˆ•
document.getElementById('back-from-hottopic-btn').addEventListener('click', () => {
    switchToWeiboView('weibo-hot-search-view');
});

// 2. ç¶å®šç†±æœè©³æƒ…é çš„â€œæ›ä¸€æ‰¹â€æŒ‰éˆ•
document.getElementById('refresh-hottopic-feed-btn').addEventListener('click', () => {
    if (currentHotTopic) {
        generateHotSearchFeed(currentHotTopic);
    }
});

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

    // â–¼â–¼â–¼ ç¬¬2æ­¥ ç¬¬5è™•ä¿®æ”¹ï¼ˆæ–°å¢äº‹ä»¶ç›£è½å™¨ï¼‰ â–¼â–¼â–¼
    // ã€å…¨æ–°ã€‘è§’è‰²è¡¨æƒ…åŒ…ç®¡ç†åŠŸèƒ½äº‹ä»¶ç¶å®š
    document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
        if (e.target.id === 'manage-char-stickers-btn') {
            document.getElementById('chat-settings-modal').classList.remove('visible');
            openCharStickerManager();
        }
    });

    document.getElementById('back-from-sticker-manager').addEventListener('click', () => {
        showScreen('chat-interface-screen');
        document.getElementById('chat-settings-btn').click();
    });

    // è¡¨æƒ…ç®¡ç†é ç°½åˆ‡æ›
    const stickerTabExclusive = document.getElementById('sticker-tab-exclusive');
    const stickerTabCommon = document.getElementById('sticker-tab-common');
    const stickerContentExclusive = document.getElementById('sticker-content-exclusive');
    const stickerContentCommon = document.getElementById('sticker-content-common');

    stickerTabExclusive.addEventListener('click', () => {
        stickerTabExclusive.classList.add('active');
        stickerTabCommon.classList.remove('active');
        stickerContentExclusive.style.display = 'block';
        stickerContentCommon.style.display = 'none';
    });

    stickerTabCommon.addEventListener('click', () => {
        stickerTabCommon.classList.add('active');
        stickerTabExclusive.classList.remove('active');
        stickerContentCommon.style.display = 'block';
        stickerContentExclusive.style.display = 'none';
    });

    // ç¶å®šå„ç¨®æ·»åŠ /ä¸Šå‚³æŒ‰éˆ•
    document.getElementById('add-exclusive-sticker-btn').addEventListener('click', () => bulkAddCharStickers('exclusive'));
    document.getElementById('upload-exclusive-sticker-btn').addEventListener('click', () => uploadCharStickersLocal('exclusive'));
    document.getElementById('add-common-sticker-btn').addEventListener('click', () => bulkAddCharStickers('common'));
    document.getElementById('upload-common-sticker-btn').addEventListener('click', () => uploadCharStickersLocal('common'));

    // â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒè²æ­·å²è¨˜éŒ„åˆªé™¤åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('clear-all-history-btn').addEventListener('click', clearAllInnerVoiceHistory);

// ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†å–®æ¢åˆªé™¤
document.getElementById('inner-voice-history-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('history-item-delete-btn')) {
        const timestamp = parseInt(e.target.dataset.timestamp);
        if (!isNaN(timestamp)) {
            deleteSingleInnerVoice(timestamp);
        }
    }
});
// â–²â–²â–² å¿ƒè²æ­·å²åˆªé™¤äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²

 // â–¼â–¼â–¼ é€™æ˜¯æˆ‘å€‘æ–°åŠ çš„å°å…¥åŠŸèƒ½äº‹ä»¶ç›£è½ â–¼â–¼â–¼
        document.getElementById('import-character-card-btn').addEventListener('click', () => {
            // é»æ“Šæˆ‘å€‘çš„æ–°æŒ‰éˆ•æ™‚ï¼Œå°±å»è§¸ç™¼é‚£å€‹éš±è—çš„æª”é¸æ“‡æ¡†
            document.getElementById('character-card-input').click();
        });

        document.getElementById('character-card-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                // ç•¶ç”¨æˆ¶é¸æ“‡äº†æª”å¾Œï¼Œèª¿ç”¨æˆ‘å€‘çš„ç¸½è™•ç†å‡½æ•¸
                handleCharacterImport(file);
            }
            // æ¸…ç©ºé¸æ“‡ï¼Œé€™æ¨£ç”¨æˆ¶ä¸‹æ¬¡é‚„èƒ½é¸æ“‡åŒä¸€å€‹æª”
            event.target.value = null; 
        });
        // â–²â–²â–² æ–°äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('phone-screen').addEventListener('click', unlockAudioContext, { once: true });
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
            document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
            document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
            document.getElementById('export-data-btn').addEventListener('click', exportBackup);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
            document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
            document.getElementById('back-to-list-btn').addEventListener('click', () => { 
 stopPetDecayTimer();
    // â–¼â–¼â–¼ ä¿®æ”¹é€™å…©è¡Œ â–¼â–¼â–¼
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå¯¦èŠå¤©ä»‹é¢çš„è‡ªè¨‚æ¨£å¼
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é è¦½å€çš„è‡ªè¨‚æ¨£å¼
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

exitSelectionMode(); state.activeChatId = null;
// ã€å¿ƒè²åŠŸèƒ½ã€‘è¿”å›åˆ—è¡¨æ™‚ï¼Œéš±è—å¿ƒå½¢æŒ‰éˆ•
document.getElementById('char-heart-btn').style.display = 'none';
 showScreen('chat-list-screen'); });
            // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
            // ç‚ºæ­Œæ›²å°é¢/æ­Œè©å€åŸŸç¶å®šé»æ“Šåˆ‡æ›äº‹ä»¶
            document.getElementById('music-display-area').addEventListener('click', () => {
                const displayArea = document.getElementById('music-display-area');
                // ç›´æ¥åˆ‡æ› .show-lyrics é€™å€‹é¡ï¼ŒCSSæœƒè‡ªå‹•è™•ç†é¡¯ç¤º/éš±è—
                displayArea.classList.toggle('show-lyrics');
            });
            // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

                        document.getElementById('add-chat-btn').addEventListener('click', async () => { 
                const name = await showCustomPrompt('å‰µå»ºæ–°èŠå¤©', 'è«‹è¼¸å…¥Taçš„åå­—'); 
                if (name && name.trim()) { 
                    const newChatId = 'chat_' + Date.now(); 
                    
                    // â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹æ›¿æ› â–¼â–¼â–¼
                const newChat = {
                    id: newChatId,
                    name: name.trim(),
                    isGroup: false,
                    isPinned: false,
                    npcLibrary: [], // è§’è‰²å°ˆå±¬NPCåº«
                    relationship: { status: 'friend', blockedTimestamp: null, applicationReason: '' },
                    status: { text: 'ç·šä¸Š', lastUpdate: Date.now(), isBusy: false },
                    settings: {
                        aiPersona: 'ä½ æ˜¯èª°å‘€ã€‚',
                        myPersona: 'æˆ‘æ˜¯èª°å‘€ã€‚',
                        maxMemory: 10,
                        aiAvatar: defaultAvatar,
                        myAvatar: defaultAvatar,
                        background: '',
                        theme: 'default',
                        fontSize: 13,
                        customCss: '',
                        linkedWorldBookIds: [],
                        aiAvatarLibrary: [],
                        stickerLibrary: [], // å°ˆå±¬è¡¨æƒ…åº«
                        // === ä»¥ä¸‹æ˜¯æœ¬æ¬¡ä¿®å¾©æ–°å¢çš„åˆå§‹åŒ–å±¬æ€§ ===
                        linkedMemories: [], // ã€ä¿®å¾©æ ¸å¿ƒã€‘åˆå§‹åŒ–è¨˜æ†¶äº’é€šé™£åˆ—
                        offlineMode: { enabled: false, prompt: '', style: '', wordCount: 300, presets: [] }, // åˆå§‹åŒ–ç·šä¸‹æ¨¡å¼
                        timePerceptionEnabled: true, // åˆå§‹åŒ–æ™‚é–“æ„ŸçŸ¥
                        customTime: '', // åˆå§‹åŒ–è‡ªè¨‚æ™‚é–“
                        isCoupleAvatar: false, // åˆå§‹åŒ–æƒ…ä¾¶é ­åƒé–‹é—œ
                        coupleAvatarDescription: '', // åˆå§‹åŒ–æƒ…ä¾¶é ­åƒæè¿°
                        weiboProfession: '', // åˆå§‹åŒ–å¾®åšè·æ¥­
                        weiboInstruction: '' // åˆå§‹åŒ–å¾®åšæŒ‡ä»¤
                    },
                    history: [],
                    musicData: { totalTime: 0 },
                    // æ‰‹æ©Ÿè³‡æ–™ä¹Ÿä¿æŒå®Œæ•´
                    characterPhoneData: {
                        lastGenerated: null, chats: {}, shoppingCart: [], memos: [],
                        browserHistory: [], photoAlbum: [], bank: { balance: 0, transactions: [] },
                        trajectory: [], appUsage: [], diary: []
                    }
                };
// â–²â–²â–² æ›¿æ›åˆ°é€™è£¡çµæŸ â–²â–²â–²


                    state.chats[newChatId] = newChat; 
                    await db.chats.put(newChat); 
                    renderChatList(); 
                } 
            });

            // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘å‰µå»ºç¾¤èŠæŒ‰éˆ•ç¾åœ¨æ‰“é–‹é€£çµ¡äººé¸æ“‡å™¨ â–¼â–¼â–¼
document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²                      
            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);

document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
    document.getElementById('music-search-results-modal').classList.remove('visible');
});

document.getElementById('search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item && item.dataset.songJson) {
        const songData = JSON.parse(item.dataset.songJson);
        handleSearchResultClick(songData);
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²

            audioPlayer.addEventListener('ended', playNext);

            const chatInput = document.getElementById('chat-input');
            // â–¼â–¼â–¼ æ‰¾åˆ° id="send-btn" çš„ click äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('send-btn').addEventListener('click', async () => { 
    const content = chatInput.value.trim(); 
    if (!content || !state.activeChatId) return; 
        // --- â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¾©ä»£ç¢¼ã€‘â–¼â–¼â–¼ ---
    try {
        const command = JSON.parse(content);
        // æª¢æŸ¥ï¼šé€™æ˜¯å¦æ˜¯ä¸€å€‹è®“è§’è‰²ç™¼å¾®åšçš„æŒ‡ä»¤ï¼Ÿ
        if (command && command.type === 'weibo_post') {
            const chat = state.chats[state.activeChatId];
            if (chat.isGroup) {
                alert("ä¸èƒ½åœ¨ç¾¤èŠä¸­ç‚ºå–®å€‹è§’è‰²ç™¼ä½ˆå¾®åšã€‚");
                return;
            }

            // å‰µå»ºä¸€å€‹æ–°çš„å¾®åšå¸–å­ç‰©ä»¶
            const newPost = {
                authorId: chat.id, // é—œéµï¼ä½œè€…IDæ˜¯ç•¶å‰è§’è‰²çš„IDï¼Œè€Œä¸æ˜¯'user'
                authorType: 'char',
                authorNickname: chat.name,
                authorAvatar: chat.settings.aiAvatar || defaultAvatar,
                content: command.content || '',
                timestamp: Date.now(),
                likes: [],
                comments: [],
                baseLikesCount: command.baseLikesCount || 0,
                baseCommentsCount: command.baseCommentsCount || 0
            };

            // å¦‚æœJSONè£¡æœ‰è·¯äººè©•è«–ï¼Œå°±è§£æä¸¦æ·»åŠ 
            if (command.comments && typeof command.comments === 'string') {
                newPost.comments = command.comments.split('\n').map(c => {
                    const parts = c.split(/[:ï¼š]/);
                    const commenter = parts.shift() || 'è·¯äºº';
                    const commentText = parts.join(':').trim();
                    return { commentId: 'comment_' + Date.now() + Math.random(), authorNickname: commenter, commentText: commentText };
                }).filter(c => c.commentText);
            }

            await db.weiboPosts.add(newPost);
            
            // åˆ·æ–°â€œé—œæ³¨çš„äººâ€åˆ—è¡¨ï¼Œæ–°å¾®åšå°±æœƒå‡ºç¾äº†ï¼
            await renderFollowingWeiboFeed();

            await showCustomAlert('æ“ä½œæˆåŠŸ', `å·²ç‚º â€œ${chat.name}â€ ç™¼ä½ˆäº†ä¸€æ¢æ–°å¾®åšï¼`);
            
            chatInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            return; // çµæŸå‡½æ•¸ï¼Œä¸å†åŸ·è¡Œå¾Œé¢çš„ä»£ç¢¼
        }
    } catch (e) {
        // å¦‚æœè§£æJSONå¤±æ•—ï¼Œèªªæ˜å®ƒä¸æ˜¯æŒ‡ä»¤ï¼Œåªæ˜¯æ™®é€šæ–‡æœ¬ï¼Œå°±è®“ä»£ç¢¼ç¹¼çºŒå¾€ä¸‹èµ°
    }
    // --- â–²â–²â–²ã€ä¿®å¾©ä»£ç¢¼çµæŸã€‘â–²â–²â–² ---
    const chat = state.chats[state.activeChatId]; 
    
    // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡æ·»åŠ  ---
    const msg = { 
        role: 'user', 
        content, 
        timestamp: Date.now() 
    };

    // æª¢æŸ¥ç•¶å‰æ˜¯å¦è™•æ–¼å¼•ç”¨å›å¾©æ¨¡å¼
    if (currentReplyContext) {
        msg.quote = currentReplyContext; // å°‡å¼•ç”¨è³‡è¨Šé™„åŠ åˆ°æ¶ˆæ¯ç‰©ä»¶ä¸Š
    }
    // --- ã€ä¿®æ”¹çµæŸã€‘ ---
    
    chat.history.push(msg); 
    await db.chats.put(chat); 
    appendMessage(msg, chat); 
    renderChatList(); 
    chatInput.value = ''; 
    chatInput.style.height = 'auto'; 
    chatInput.focus(); 
    
    // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç™¼é€å¾Œï¼Œå–æ¶ˆå¼•ç”¨æ¨¡å¼ ---
    cancelReplyMode(); 
});
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });

            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
// â–¼â–¼â–¼ ç”¨é€™ã€ä¸€æ•´å¡Šã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„ 'save-wallpaper-btn' äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
    let changesMade = false;

    // ä¿å­˜å£ç´™
    if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
        changesMade = true;
    }

    // ä¿å­˜é–å±å£ç´™
    if (newLockscreenWallpaperBase64) {
        state.globalSettings.lockscreenWallpaper = newLockscreenWallpaperBase64;
        changesMade = true;
    }

    // ã€æ–°å¢ã€‘ä¿å­˜å…¨åŸŸèŠå¤©èƒŒæ™¯
    if (newGlobalBgBase64 === 'REMOVED') { // å¦‚æœæ¨™è¨˜ç‚ºå·²ç§»é™¤
        state.globalSettings.globalChatBackground = '';
        changesMade = true;
    } else if (newGlobalBgBase64) { // å¦‚æœæœ‰æ–°ä¸Šå‚³çš„
        state.globalSettings.globalChatBackground = newGlobalBgBase64;
        changesMade = true;
    }

    // ä¿å­˜å¯†ç¢¼
    const newPassword = document.getElementById('password-set-input').value;
    state.globalSettings.password = newPassword;

    state.globalSettings.ringtoneUrl = document.getElementById('ringtone-url-input').value.trim();
state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
    const activeThemeSelector = document.getElementById('theme-selector');
    if (activeThemeSelector.value) {
        state.globalSettings.activeThemeId = parseInt(activeThemeSelector.value);
    } else {
        state.globalSettings.activeThemeId = null;
    }
    
    const isLockEnabled = document.getElementById('enable-lock-screen-toggle').checked;
    state.globalSettings.enableLockScreen = isLockEnabled;
    localStorage.setItem('lockScreenEnabled', isLockEnabled);
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™å…©è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
state.globalSettings.homeIconWidgetTextColor = document.getElementById('home-icon-widget-text-color-picker').value;
// ã€å…¨æ–°ã€‘ä¿å­˜å­—é«”é™°å½±è¨­ç½®
state.globalSettings.removeHomeFontShadow = document.getElementById('remove-home-font-shadow-toggle').checked;
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
saveAppLabels();

    await db.globalSettings.put(state.globalSettings);

    // æ‡‰ç”¨æ‰€æœ‰æ›´æ”¹
    if (changesMade) {
        applyGlobalWallpaper();        
        applyLockscreenWallpaper(); 
        newWallpaperBase64 = null;        
        newLockscreenWallpaperBase64 = null; 
        newGlobalBgBase64 = null; // æ¸…ç†è‡¨æ™‚è®Šæ•¸
    }
    applyAppIcons(); 
applyAppLabels();
    alert('å¤–è§€è¨­ç½®å·²ä¿å­˜ä¸¦æ‡‰ç”¨ï¼');
    showScreen('home-screen');
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { 

    const proxyUrl = document.getElementById('proxy-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();
    const isBlocked = BLOCKED_API_SITES.some(blockedDomain => proxyUrl.includes(blockedDomain));

if (isBlocked) {
    alert('éŒ¯èª¤ï¼šè©² API ç¶²ç«™å·²è¢«ç¦ç”¨ï¼Œç„¡æ³•ä½¿ç”¨ã€‚');
    return; // é˜»æ­¢ä¿å­˜
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); 
state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); 
state.apiConfig.model = document.getElementById('model-select').value; 
    // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜ Minimax è¨­ç½®
    state.apiConfig.minimaxGroupId = document.getElementById('minimax-group-id').value.trim();
    state.apiConfig.minimaxApiKey = document.getElementById('minimax-api-key').value.trim();
await db.apiConfig.put(state.apiConfig); 

// åœ¨ 'save-api-settings-btn' çš„ click äº‹ä»¶ç›£è½å™¨å…§éƒ¨
// await db.apiConfig.put(state.apiConfig); é€™è¡Œä¹‹å¾Œ

// â–¼â–¼â–¼ å°‡ä¹‹å‰é‚£æ®µä¿å­˜å¾Œè‡ºæ´»å‹•è¨­ç½®çš„é‚è¼¯ï¼Œæ›¿æ›ç‚ºä¸‹é¢é€™å€‹å¢å¼·ç‰ˆ â–¼â–¼â–¼

const backgroundSwitch = document.getElementById('background-activity-switch');
const intervalInput = document.getElementById('background-interval-input');
const newEnableState = backgroundSwitch.checked;
const oldEnableState = state.globalSettings.enableBackgroundActivity || false;

// åªæœ‰åœ¨ç”¨æˆ¶â€œå¾é—œåˆ°é–‹â€æ™‚ï¼Œæ‰å½ˆå‡ºè­¦å‘Š
if (newEnableState && !oldEnableState) {
    const userConfirmed = confirm(
        "ã€é«˜è²»ç”¨è­¦å‘Šã€‘\n\n" +
        "æ‚¨æ­£åœ¨å•Ÿç”¨â€œå¾Œè‡ºè§’è‰²æ´»å‹•â€åŠŸèƒ½ã€‚\n\n" +
        "é€™æœƒä½¿æ‚¨çš„AIè§’è‰²å€‘åœ¨æ‚¨ä¸å’Œä»–å€‘èŠå¤©æ™‚ï¼Œä¹Ÿèƒ½â€œç¨ç«‹æ€è€ƒâ€ä¸¦ä¸»å‹•çµ¦æ‚¨ç™¼æ¶ˆæ¯æˆ–é€²è¡Œç¤¾äº¤äº’å‹•ï¼Œæ¥µå¤§åœ°å¢å¼·æ²‰æµ¸æ„Ÿã€‚\n\n" +
        "ä½†è«‹æ³¨æ„ï¼š\n" +
        "é€™æœƒã€åœ¨å¾Œè‡ºè‡ªå‹•ã€å®šæœŸåœ°èª¿ç”¨APIã€‘ï¼Œå³ä½¿æ‚¨ä¸é€²è¡Œä»»ä½•æ“ä½œã€‚æ ¹æ“šæ‚¨çš„è§’è‰²æ•¸é‡å’Œæª¢æ¸¬é–“éš”ï¼Œé€™å¯èƒ½æœƒå°è‡´æ‚¨çš„APIè²»ç”¨é¡¯è‘—å¢åŠ ã€‚\n\n" +
        "æ‚¨ç¢ºå®šè¦é–‹å•Ÿå—ï¼Ÿ"
    );

    if (!userConfirmed) {
        backgroundSwitch.checked = false; // ä½¿ç”¨è€…å–æ¶ˆï¼ŒæŠŠé–‹é—œæ’¥å›å»
        return; // é˜»æ­¢å¾ŒçºŒé‚è¼¯
    }
}

state.globalSettings.enableBackgroundActivity = newEnableState;
state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
state.globalSettings.blockCooldownHours = parseFloat(document.getElementById('block-cooldown-input').value) || 1;
await db.globalSettings.put(state.globalSettings);

// å‹•æ…‹å•Ÿå‹•æˆ–åœæ­¢æ¨¡æ“¬å™¨
stopBackgroundSimulation();
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log(`å¾Œè‡ºæ´»å‹•æ¨¡æ“¬å·²å•Ÿå‹•ï¼Œé–“éš”: ${state.globalSettings.backgroundActivityInterval}ç§’`);
} else {
    console.log("å¾Œè‡ºæ´»å‹•æ¨¡æ“¬å·²åœæ­¢ã€‚");
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

alert('APIè¨­ç½®å·²ä¿å­˜!'); });

                    // gemini é‡‘é‘°èšç„¦çš„æ™‚å€™é¡¯ç¤ºæ˜æ–‡
        const ApiKeyInput = document.getElementById('api-key')
        ApiKeyInput.addEventListener('focus', (e) => {
            e.target.setAttribute('type', 'text')
        })
        ApiKeyInput.addEventListener('blur', (e) => {
            e.target.setAttribute('type', 'password')
        })


        document.getElementById('fetch-models-btn').addEventListener('click', async () => {
            const url = document.getElementById('proxy-url').value.trim();
            const key = document.getElementById('api-key').value.trim();
            if (!url || !key) return alert('è«‹å…ˆå¡«å¯«åä»£åœ°å€å’Œé‡‘é‘°');
            try {

                let  isGemini = url === GEMINI_API_URL;
                const response = await fetch(isGemini ? `${GEMINI_API_URL}?key=${getRandomValue(key)}` : `${url}/v1/models`,isGemini ? undefined : {headers: {'Authorization': `Bearer ${key}`}});
                if (!response.ok) throw new Error('ç„¡æ³•ç²å–æ¨¡å‹æ¸…å–®');
                const data = await response.json();
                let models = isGemini ? data.models : data.data;
                if(isGemini){
                    models = models.map((model)=>{
                        const parts = model.name.split('/');
                        return {
                            id:parts.length > 1 ? parts[1] : model.name
                        }
                    })
                }
                const modelSelect = document.getElementById('model-select');
                modelSelect.innerHTML = '';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    if (model.id === state.apiConfig.model) option.selected = true;
                    modelSelect.appendChild(option);
                });
                alert('æ¨¡å‹æ¸…å–®å·²æ›´æ–°');
            } catch (error) {
                alert(`æ‹‰å–æ¨¡å‹å¤±æ•—: ${error.message}`);
            }
        });
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œæ›¸å°å…¥åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('import-world-book-btn').addEventListener('click', () => {
    // é»æ“Šâ€œå°å…¥â€æŒ‰éˆ•æ™‚ï¼Œè§¸ç™¼éš±è—çš„æª”é¸æ“‡æ¡†
    document.getElementById('world-book-import-input').click();
});

document.getElementById('world-book-import-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        // ç•¶ç”¨æˆ¶é¸æ“‡äº†æª”å¾Œï¼Œèª¿ç”¨æˆ‘å€‘çš„æ ¸å¿ƒè™•ç†å‡½æ•¸
        handleImportSillyTavernWorldBook(file);
    }
    // æ¯æ¬¡ç”¨å®Œå¾Œæ¸…ç©ºï¼Œé€™æ¨£ç”¨æˆ¶ä¸‹æ¬¡é‚„èƒ½é¸æ“‡åŒä¸€å€‹æª”
    e.target.value = null; 
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²

            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('å‰µå»ºä¸–ç•Œæ›¸', 'è«‹è¼¸å…¥æ›¸å'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('æ›¸åä¸èƒ½ç‚ºç©ºï¼'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; 

        // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡ä¿å­˜åˆ†é¡ID â–¼â–¼â–¼
        const categoryId = document.getElementById('world-book-category-select').value;
        // å¦‚æœé¸æ“‡äº†â€œæœªåˆ†é¡â€ï¼Œå­˜å…¥ nullï¼›å¦å‰‡å­˜å…¥æ•¸å­—ID
        book.categoryId = categoryId ? parseInt(categoryId) : null; 
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });
// â–¼â–¼â–¼ ç¬¬3æ­¥ï¼šç”¨é€™æ•´å¡Šã€å…¨æ–°çš„ã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ 'chat-messages' é»æ“Šäº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', async (e) => {
    
    const voiceBody = e.target.closest('.voice-message-body');
    if (voiceBody) {
        const bubble = voiceBody.closest('.message-bubble');
        if (!bubble) return;

        // å¦‚æœæ˜¯ä½¿ç”¨è€…è‡ªå·±çš„èªéŸ³ï¼Œåªåˆ‡æ›æ–‡å­—é¡¯ç¤ºï¼Œä¸æ’­æ”¾
        if (bubble.classList.contains('user')) {
            toggleVoiceTranscript(bubble);
            return;
        }

// â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™æ®µã€å·²ä¿®å¾©é»æ“Šæ”¶èµ·åŠŸèƒ½ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„AIèªéŸ³é»æ“Šè™•ç†é‚è¼¯ â–¼â–¼â–¼
        // å¦‚æœæ˜¯AIçš„èªéŸ³è¨Šæ¯
        const chat = state.chats[state.activeChatId];
        if (!chat) return;

        // --- æ ¸å¿ƒé‚è¼¯é–‹å§‹ ---

        // 1. æª¢æŸ¥æ˜¯å¦é»æ“Šäº†æ­£åœ¨æ’­æ”¾çš„èªéŸ³æ¢
        if (isTtsPlaying && currentTtsAudioBubble === bubble) {
            // å¦‚æœæ˜¯ï¼Œå‰‡åœæ­¢æ’­æ”¾ä¸¦æ”¶èµ·æ‰€æœ‰é—œè¯çš„æ–‡å­—
            stopMinimaxAudio(); 
        } 
        // 2. æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯å·²ç¶“å±•é–‹äº†æ–‡å­—ä½†æ²’æœ‰æ’­æ”¾çš„èªéŸ³æ¢
        else if (bubble.dataset.state === 'expanded') {
            // å¦‚æœæ˜¯ï¼Œå‰‡åªæ”¶èµ·æ–‡å­—ï¼Œä¸å½±éŸ¿å…¶ä»–
            toggleVoiceTranscript(bubble);
        }
        // 3. å¦‚æœä»¥ä¸Šéƒ½ä¸æ˜¯ï¼Œèªªæ˜æ˜¯æƒ³é–‹å§‹æ’­æ”¾æˆ–åªå±•é–‹æ–‡å­—
        else {
            const clickedTimestamp = parseInt(bubble.dataset.timestamp);
            const startIndex = chat.history.findIndex(m => m.timestamp === clickedTimestamp);
            if (startIndex === -1) return;

            // æŸ¥æ‰¾é€£çºŒçš„èªéŸ³è¨Šæ¯
            const messagesToPlay = findConsecutiveAiVoiceMessages(chat.history, startIndex);
            if (messagesToPlay.length > 0) {
                const bubblesToAnimate = messagesToPlay.map(m => document.querySelector(`.message-bubble[data-timestamp="${m.timestamp}"]`)).filter(Boolean);
                
                // æª¢æŸ¥é…ç½®ï¼Œæ±ºå®šæ˜¯æ’­æ”¾é‚„æ˜¯åªé¡¯ç¤ºæ–‡å­—
                const groupId = state.apiConfig.minimaxGroupId;
                const apiKey = state.apiConfig.minimaxApiKey;
                const voiceId = chat.settings.minimaxVoiceId;

                if (groupId && apiKey && voiceId) {
                    // ã€æ’­æ”¾åˆ†æ”¯ã€‘
                    // å…ˆå±•é–‹æ‰€æœ‰æ–‡å­—
                    bubblesToAnimate.forEach(b => {
                        if (b.dataset.state !== 'expanded') {
                            toggleVoiceTranscript(b);
                        }
                    });
                    // ç„¶å¾Œèª¿ç”¨æ’­æ”¾æ©Ÿ
                    const combinedText = messagesToPlay.map(m => m.content.trim()).join('ï¼Œ');
                    playMinimaxAudio(combinedText, voiceId, bubblesToAnimate);
                } else {
                    // ã€åªé¡¯ç¤ºæ–‡å­—åˆ†æ”¯ã€‘
                    // åªå±•é–‹ç•¶å‰é»æ“Šçš„é€™ä¸€å€‹èªéŸ³æ¢çš„æ–‡å­—
                    toggleVoiceTranscript(bubble);
                }
            }
        }
        
        return; // è™•ç†å®ŒèªéŸ³å¾Œé€€å‡º
    }
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²




    // --- ä½ åŸä¾†çš„å…¶ä»–é»æ“Šäº‹ä»¶é‚è¼¯ ---
    const aiImage = e.target.closest('.ai-generated-image');
    if (aiImage) {
        const description = aiImage.dataset.description;
        if (description) showCustomAlert('ç…§ç‰‡æè¿°', description);
        return;
    }
    const linkCard = e.target.closest('.link-share-card');
    if (linkCard && linkCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(linkCard.dataset.timestamp);
        if (!isNaN(timestamp)) {
            openBrowser(timestamp);
        }
    }
    const packetCard = e.target.closest('.red-packet-card');
    if (packetCard) {
        const messageBubble = packetCard.closest('.message-bubble');
        if (messageBubble && messageBubble.dataset.timestamp) {
            const timestamp = parseInt(messageBubble.dataset.timestamp);
            handlePacketClick(timestamp);
        }
    }
    const pollCard = e.target.closest('.poll-card');
    if (pollCard) {
        const timestamp = parseInt(pollCard.dataset.pollTimestamp);
        if (isNaN(timestamp)) return;
        const optionItem = e.target.closest('.poll-option-item');
        if (optionItem && !pollCard.classList.contains('closed')) {
            handleUserVote(timestamp, optionItem.dataset.option);
            return;
        }
        const actionBtn = e.target.closest('.poll-action-btn');
        if (actionBtn) {
            if (pollCard.classList.contains('closed')) {
                showPollResults(timestamp);
            } else {
                endPoll(timestamp);
            }
            return;
        }
        if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
        }
    }
    const card = e.target.closest('.waimai-card');
    if (card) {
        const messageBubble = card.closest('.message-bubble');
        const invitationMsg = state.chats[state.activeChatId].history.find(m => m.timestamp === parseInt(messageBubble.dataset.timestamp));
        if (invitationMsg && invitationMsg.type === 'lovers_space_invitation' && invitationMsg.status === 'pending') {
            const choice = e.target.dataset.choice;
            if (choice) {
                handleLoversSpaceResponse(invitationMsg.timestamp, choice);
            }
        }
    }
    const repostCard = e.target.closest('.link-share-card[data-post-id]');
    if (repostCard) {
        const postId = parseInt(repostCard.dataset.postId);
        if (!isNaN(postId)) {
            openPost(postId);
        }
    }
    
    // ã€æ–°å¢ã€‘è™•ç†åˆ†äº«å¡ç‰‡çš„é»æ“Š
    const shareCard = e.target.closest('.link-share-card[data-timestamp]');
    if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(shareCard.dataset.timestamp);
        if(!isNaN(timestamp)) {
            const msg = state.chats[state.activeChatId].history.find(m=>m.timestamp===timestamp);
            if(msg && msg.type === 'share_card') openSharedHistoryViewer(timestamp);
            else if(msg && msg.type === 'share_link') openBrowser(timestamp);
        }
    }
    
    // ã€æ–°å¢ã€‘è™•ç†å·²æ’¤å›æ¶ˆæ¯çš„é»æ“Š
    const placeholder = e.target.closest('.recalled-message-placeholder');
    if (placeholder) {
        const wrapper = placeholder.closest('.message-wrapper');
        const chat = state.chats[state.activeChatId];
        if (chat && wrapper) {
            const timestamp = parseInt(wrapper.dataset.timestamp);
            const recalledMsg = chat.history.find(m => m.timestamp === timestamp);
            if (recalledMsg && recalledMsg.recalledData) {
                let originalContentText = '';
                const recalled = recalledMsg.recalledData;
                if (recalled.originalType === 'text') {
                    originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
                } else {
                    originalContentText = `æ’¤å›äº†ä¸€æ¢[${recalled.originalType}]é¡å‹çš„æ¶ˆæ¯`;
                }
                showCustomAlert('å·²æ’¤å›çš„æ¶ˆæ¯', originalContentText);
            }
        }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');

function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- é»æ“Šé¸æ“‡ --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `å·²é¸æ“‡ ${checkedBoxes.length} é …`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }        
            
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
            window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });

// â–¼â–¼â–¼ è«‹ç”¨é€™æ®µã€å®Œæ•´ã€å…¨æ–°çš„ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ chat-settings-btn é»æ“Šäº‹ä»¶ â–¼â–¼â–¼
document.getElementById('chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const isGroup = chat.isGroup;
// â–¼â–¼â–¼ åœ¨ const chat = ... çš„ä¸‹ä¸€è¡Œï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
// è¨ˆç®—ç¸½æ¶ˆæ¯æ¢æ•¸ä¸¦æ›´æ–°é¡¯ç¤º
const totalMessages = chat.history.length;
const countDisplay = document.getElementById('total-message-count-display');
if (countDisplay) {
    countDisplay.textContent = `${totalMessages} æ¢`;
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

    // --- çµ±ä¸€é¡¯ç¤º/éš±è—æ§åˆ¶é … ---
    // â–¼â–¼â–¼ åœ¨ chat-settings-btn çš„ click äº‹ä»¶ä¸­ï¼Œé»è²¼é€™æ®µä»£ç¢¼ â–¼â–¼â–¼
const videoCallSettingsGroup = document.getElementById('video-call-settings-group');
const visualCallSwitch = document.getElementById('visual-video-call-switch');
const imageUploadsDiv = document.getElementById('video-call-image-uploads');
// --- è¼‰å…¥èŠå¤©ç¸½çµè¨­ç½® ---
const summarySettings = chat.settings.summary || {};
const summaryToggle = document.getElementById('summary-toggle');
const summaryDetails = document.getElementById('summary-details-container');

summaryToggle.checked = summarySettings.enabled || false;
summaryDetails.style.display = summaryToggle.checked ? 'block' : 'none';

document.querySelector(`input[name="summary-mode"][value="${summarySettings.mode || 'auto'}"]`).checked = true;
document.getElementById('summary-count-input').value = summarySettings.count || 20;
document.getElementById('summary-prompt-input').value = summarySettings.prompt || 'è«‹ä½ ä»¥ç¬¬ä¸‰äººç¨±çš„è¦–è§’ï¼Œå®¢è§€ã€å†·éœã€ä¸å¸¶ä»»ä½•æ„Ÿæƒ…è‰²å½©åœ°ç¸½çµä»¥ä¸‹å°è©±çš„æ ¸å¿ƒäº‹ä»¶å’Œè³‡è¨Šã€‚ç¦æ­¢é€²è¡Œä»»ä½•è§’è‰²æ‰®æ¼”æˆ–æ·»åŠ ä¸»è§€è©•è«–ã€‚';

// ç‚ºé–‹é—œæ·»åŠ å³æ™‚äº¤äº’
summaryToggle.onchange = () => {
    summaryDetails.style.display = summaryToggle.checked ? 'block' : 'none';
};
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
if (isGroup) {
    videoCallSettingsGroup.style.display = 'none'; // ç¾¤èŠä¸æ”¯æŒï¼Œéš±è—æ•´å€‹è¨­ç½®å€
} else {
    videoCallSettingsGroup.style.display = 'block'; // å–®èŠé¡¯ç¤º
    
    // è¼‰å…¥ç•¶å‰è¨­ç½®
    visualCallSwitch.checked = chat.settings.visualVideoCallEnabled || false;
    imageUploadsDiv.style.display = visualCallSwitch.checked ? 'block' : 'none';
    document.getElementById('char-video-image-preview').src = chat.settings.charVideoImage || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
    document.getElementById('user-video-image-preview').src = chat.settings.userVideoImage || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';

    // ç‚ºé–‹é—œæ·»åŠ å³æ™‚äº¤äº’
    visualCallSwitch.onchange = () => {
        imageUploadsDiv.style.display = visualCallSwitch.checked ? 'block' : 'none';
    };
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
    
    // --- ç·šä¸‹æ¨¡å¼UIæ¸²æŸ“ ---
    const offlineModeSettings = chat.settings.offlineMode || { enabled: false, presets: [] }; // å®‰å…¨ç²å–
    const offlineToggle = document.getElementById('offline-mode-toggle');
    const offlineDetails = document.getElementById('offline-mode-details');

    // 1. è¨­ç½®é–‹é—œç‹€æ…‹ä¸¦ç¶å®šäº‹ä»¶
    offlineToggle.checked = offlineModeSettings.enabled;
    offlineDetails.style.display = offlineToggle.checked ? 'block' : 'none';
    offlineToggle.onchange = () => {
        offlineDetails.style.display = offlineToggle.checked ? 'block' : 'none';
    };

    // 2. å¡«å……è¼¸å…¥æ¡†
    document.getElementById('offline-prompt-input').value = offlineModeSettings.prompt || '';
    document.getElementById('offline-style-input').value = offlineModeSettings.style || '';
    document.getElementById('offline-word-count-input').value = offlineModeSettings.wordCount || 300;

    // 3. æ¸²æŸ“é è¨­ä¸‹æ‹‰æ¸…å–®
    renderOfflinePresetsSelector();

    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºæ°£æ³¡å°å…¥/åŒ¯å‡ºæŒ‰éˆ•ç¶å®šäº‹ä»¶ â–¼â–¼â–¼
document.getElementById('export-bubble-preset-btn').addEventListener('click', exportSelectedBubblePreset);

document.getElementById('import-bubble-preset-btn').addEventListener('click', () => {
    // é»æ“Šâ€œå°å…¥â€æŒ‰éˆ•æ™‚ï¼Œè§¸ç™¼éš±è—çš„æª”é¸æ“‡æ¡†
    document.getElementById('import-bubble-preset-input').click();
});

document.getElementById('import-bubble-preset-input').addEventListener('change', (e) => {
    // ç•¶ç”¨æˆ¶é¸æ“‡äº†æª”å¾Œï¼Œèª¿ç”¨å°å…¥å‡½æ•¸è™•ç†
    importBubblePreset(e.target.files[0]);
    e.target.value = null; // æ¯æ¬¡ç”¨å®Œå¾Œæ¸…ç©ºï¼Œæ–¹ä¾¿ä¸‹æ¬¡é¸æ“‡åŒä¸€å€‹æª”
});
// â–²â–²â–² æ–°äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²

// --- å…¨æ–°è¦–é »é€šè©±åŠŸèƒ½äº‹ä»¶ç¶å®š (V2 ä¿®æ­£ç‰ˆ) ---

// ç¶å®šæ–°ä»‹é¢çš„æ›æ–·æŒ‰éˆ•
document.getElementById('hang-up-btn-visual').addEventListener('click', endVideoCall);

// ã€æ–°å¢ã€‘ç¶å®šæ–°ä»‹é¢çš„ç™¼è¨€æŒ‰éˆ•
document.getElementById('user-speak-btn-visual').addEventListener('click', async () => {
    if (!videoCallState.isActive) return;
    const userInput = await showCustomPrompt('ä½ èªª', 'è«‹è¼¸å…¥ä½ æƒ³èªªçš„è©±...');
    if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
    }
});

// ç¶å®šåˆ‡æ›é¡é ­æŒ‰éˆ• (ä¹Ÿæ˜¯å°çª—æœ¬èº«)
document.getElementById('switch-camera-btn').addEventListener('click', switchVideoViews);
document.getElementById('video-pip-view').addEventListener('click', switchVideoViews);

// ã€ä¿®æ­£ã€‘ç¶å®šå…©å€‹ä»‹é¢çš„é‡rollæŒ‰éˆ•
document.getElementById('reroll-call-btn').addEventListener('click', handleVideoCallReroll);
document.getElementById('reroll-call-btn-text').addEventListener('click', handleVideoCallReroll);

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



    document.getElementById('chat-name-group').style.display = 'block';
    document.getElementById('minimax-voice-id-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('my-persona-group').style.display = 'block';
    document.getElementById('my-avatar-group').style.display = 'block';
    document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
        // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
    document.getElementById('npc-library-group').style.display = isGroup ? 'none' : 'block';
    // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
            // â–¼â–¼â–¼ ç¬¬2æ­¥ ç¬¬1è™•ä¿®æ”¹ï¼ˆæ–°å¢ä»£ç¢¼ï¼‰ â–¼â–¼â–¼
        // ã€ä¿®æ”¹ã€‘æ ¹æ“šæ˜¯å¦ç‚ºå–®èŠæˆ–ç¾¤èŠï¼Œé¡¯ç¤ºè¡¨æƒ…ç®¡ç†æŒ‰éˆ•
        const charStickerGroup = document.getElementById('char-sticker-group');
        if (charStickerGroup) {
            // ç¾åœ¨ç„¡è«–æ˜¯å–®èŠé‚„æ˜¯ç¾¤èŠï¼Œé€™å€‹æŒ‰éˆ•éƒ½æœƒé¡¯ç¤º
            charStickerGroup.style.display = 'block';
        }

// ã€æ ¸å¿ƒæ–°å¢ã€‘æ ¹æ“šæ˜¯å¦ç‚ºç¾¤èŠï¼Œé¡¯ç¤ºæˆ–éš±è—å¾®åšè¨­ç½®
document.getElementById('weibo-profession-group').style.display = isGroup ? 'none' : 'block';
document.getElementById('weibo-instruction-group').style.display = isGroup ? 'none' : 'block';
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ ¹æ“šæ˜¯å¦ç‚ºç¾¤èŠï¼Œé¡¯ç¤ºæˆ–éš±è—â€œå¥½å‹åˆ†çµ„â€å€åŸŸ
    document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
    
    // --- è¼‰å…¥è¡¨å–®æ•¸æ“š ---
    document.getElementById('chat-name-input').value = chat.name;
    document.getElementById('my-persona').value = chat.settings.myPersona;
    document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
    document.getElementById('max-memory').value = chat.settings.maxMemory;
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¨˜æ†¶äº’é€šåŠŸèƒ½ - UIæ¸²æŸ“é‚è¼¯ (V2 - å¸¶é ­åƒç‰ˆ) â–¼â–¼â–¼
const memoryLinkSelectBox = document.querySelector('#memory-link-multiselect .select-box');
const memoryLinkCheckboxesContainer = document.getElementById('memory-link-checkboxes-container');
memoryLinkCheckboxesContainer.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …

// 1. ç²å–é™¤äº†ç•¶å‰èŠå¤©ä»¥å¤–çš„æ‰€æœ‰èŠå¤©
const otherChats = Object.values(state.chats).filter(c => c.id !== chat.id);

// 2. å‹•æ…‹å‰µå»ºå¸¶é ­åƒçš„æ ¸å–æ–¹å¡Š
otherChats.forEach(otherChat => {
    const existingLink = chat.settings.linkedMemories.find(link => link.chatId === otherChat.id);
    const isChecked = existingLink ? 'checked' : '';
    
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ ¹æ“šæ˜¯ç¾¤èŠé‚„æ˜¯å–®èŠï¼Œç²å–æ­£ç¢ºçš„é ­åƒURL
    const avatarUrl = otherChat.isGroup 
        ? (otherChat.settings.groupAvatar || defaultGroupAvatar) 
        : (otherChat.settings.aiAvatar || defaultAvatar);

    const label = document.createElement('label');
    
    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ§‹å»ºåŒ…å« <img> æ¨™ç±¤çš„æ–°HTMLçµæ§‹
    label.innerHTML = `
        <input type="checkbox" value="${otherChat.id}" ${isChecked}>
        <img src="${avatarUrl}" class="avatar-preview">
        <span>${otherChat.name} ${otherChat.isGroup ? '(ç¾¤èŠ)' : ''}</span>
    `;
    memoryLinkCheckboxesContainer.appendChild(label);
});


// 3. æ›´æ–°å·²é¸æ•¸é‡çš„é¡¯ç¤ºå’Œè¨˜æ†¶æ¢æ•¸
function updateMemoryLinkDisplay() {
    const checkedBoxes = memoryLinkCheckboxesContainer.querySelectorAll('input:checked');
    const displayText = memoryLinkSelectBox.querySelector('.selected-options-text');
    if (checkedBoxes.length === 0) {
        displayText.textContent = '-- é»æ“Šé¸æ“‡ --';
    } else {
        displayText.textContent = `å·²é€£çµ ${checkedBoxes.length} å€‹èŠå¤©`;
    }
}

    // 4. è¼‰å…¥è¨˜æ†¶æ¢æ•¸è¨­ç½®
    // æˆ‘å€‘ç¾åœ¨å¾ä¸€å€‹ç¨ç«‹çš„è¨­ç½®é …è¼‰å…¥ï¼Œç¢ºä¿å®ƒç¸½èƒ½è¢«æ­£ç¢ºè®€å–
    document.getElementById('link-memory-depth-input').value = chat.settings.linkMemoryDepth || 5;


// 5. ç¶å®šäº‹ä»¶
updateMemoryLinkDisplay(); // åˆå§‹åŒ–é¡¯ç¤º
memoryLinkCheckboxesContainer.addEventListener('change', updateMemoryLinkDisplay);
// ä½¿ç”¨å…‹éš†ç¯€é»æŠ€å·§ä¾†é˜²æ­¢äº‹ä»¶é‡è¤‡ç¶å®š
const newSelectBox = memoryLinkSelectBox.cloneNode(true);
memoryLinkSelectBox.parentNode.replaceChild(newSelectBox, memoryLinkSelectBox);
newSelectBox.addEventListener('click', (e) => {
    e.stopPropagation();
    memoryLinkCheckboxesContainer.classList.toggle('visible');
    newSelectBox.classList.toggle('expanded');
});
// â–²â–²â–² è¨˜æ†¶äº’é€šUIé‚è¼¯çµæŸ â–²â–²â–²

    // â–¼â–¼â–¼ åœ¨ max-memory è³¦å€¼çš„ä¸‹ä¸€è¡Œï¼Œé»è²¼é€™ä¸€æ•´å¡Šä»£ç¢¼ â–¼â–¼â–¼
const timeToggle = document.getElementById('time-perception-toggle');
const customTimeContainer = document.getElementById('custom-time-container');
const customTimeInput = document.getElementById('custom-time-input');

// å¦‚æœæ˜¯èˆŠèŠå¤©ï¼Œçµ¦ä¸€å€‹é è¨­å€¼ trueï¼ˆé–‹å•Ÿï¼‰
const isTimeEnabled = chat.settings.timePerceptionEnabled ?? true; 
timeToggle.checked = isTimeEnabled;
customTimeInput.value = chat.settings.customTime || '';

// æ ¹æ“šé–‹é—œç‹€æ…‹ï¼Œæ±ºå®šæ˜¯å¦é¡¯ç¤ºè‡ªè¨‚æ™‚é–“è¼¸å…¥æ¡†
customTimeContainer.style.display = isTimeEnabled ? 'none' : 'block';
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

    const bgPreview = document.getElementById('bg-preview');
    const removeBgBtn = document.getElementById('remove-bg-btn');
    if (chat.settings.background) {
        bgPreview.src = chat.settings.background;
        bgPreview.style.display = 'block';
        removeBgBtn.style.display = 'inline-block';
    } else {
        bgPreview.style.display = 'none';
        removeBgBtn.style.display = 'none';
    }

    if (isGroup) {
        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
        renderGroupMemberSettings(chat.members);
        // è¼‰å…¥ç¾¤èŠå¾Œè‡ºæ´»å‹•è¨­ç½®
const groupActivityGroup = document.getElementById('group-background-activity-group');
const groupActivitySwitch = document.getElementById('group-background-activity-switch');
const groupIntervalSettings = document.getElementById('group-background-interval-settings');
const groupIntervalInput = document.getElementById('group-background-interval-input');

groupActivityGroup.style.display = 'block'; // é¡¯ç¤ºè¨­å®šå€åŸŸ
const bgSettings = chat.settings.backgroundActivity || { enabled: false, interval: 120 };
groupActivitySwitch.checked = bgSettings.enabled;
groupIntervalInput.value = bgSettings.interval;
groupIntervalSettings.style.display = bgSettings.enabled ? 'block' : 'none';

// ç‚ºé–‹é—œæ·»åŠ å³æ™‚äº¤äº’
groupActivitySwitch.onchange = () => {
    groupIntervalSettings.style.display = groupActivitySwitch.checked ? 'block' : 'none';
};
    } else {
        document.getElementById('ai-persona').value = chat.settings.aiPersona;
        // ã€æ ¸å¿ƒä¿®å¾©ã€‘è¼‰å…¥ç•¶å‰è§’è‰²çš„å¾®åšè·æ¥­å’ŒæŒ‡ä»¤
document.getElementById('weibo-profession-input').value = chat.settings.weiboProfession || '';
document.getElementById('weibo-instruction-input').value = chat.settings.weiboInstruction || '';
        document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('minimax-voice-id-input').value = chat.settings.minimaxVoiceId || '';
        // â–¼â–¼â–¼ Part C.1: åœ¨é€™è£¡é»è²¼ã€è¼‰å…¥ã€‘æƒ…ä¾¶é ­åƒè¨­ç½®çš„ä»£ç¢¼ â–¼â–¼â–¼
const coupleAvatarToggle = document.getElementById('couple-avatar-toggle');
const coupleAvatarDescContainer = document.getElementById('couple-avatar-desc-container');
const coupleAvatarDescInput = document.getElementById('couple-avatar-description');

coupleAvatarToggle.checked = chat.settings.isCoupleAvatar || false;
coupleAvatarDescInput.value = chat.settings.coupleAvatarDescription || '';

coupleAvatarDescContainer.style.display = coupleAvatarToggle.checked ? 'block' : 'none';

coupleAvatarToggle.onchange = () => {
    coupleAvatarDescContainer.style.display = coupleAvatarToggle.checked ? 'block' : 'none';
};
// â–²â–²â–² è¼‰å…¥é‚è¼¯çµæŸ â–²â–²â–²
        document.getElementById('group-background-activity-group').style.display = 'none';
        // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å¦‚æœæ˜¯å–®èŠï¼Œå°±è¼‰å…¥åˆ†çµ„åˆ—è¡¨åˆ°ä¸‹æ‹‰æ¸…å–®
        const select = document.getElementById('assign-group-select');
        select.innerHTML = '<option value="">æœªåˆ†çµ„</option>'; // æ¸…ç©ºä¸¦è¨­ç½®é è¨­é¸é …
        const groups = await db.qzoneGroups.toArray();
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            // å¦‚æœç•¶å‰å¥½å‹å·²ç¶“æœ‰åˆ†çµ„ï¼Œå°±é»˜èªé¸ä¸­å®ƒ
            if (chat.groupId === group.id) {
                option.selected = true;
            }
            select.appendChild(option);
        }); 
    }
    
// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ®µã€å…¨æ–°é‚è¼¯ã€‘æ›¿æ›æ‰åŸä¾†ç°¡å–®çš„ forEach è¿´åœˆ â–¼â–¼â–¼

const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
worldBookCheckboxesContainer.innerHTML = '';
const linkedIds = new Set(chat.settings.linkedWorldBookIds || []);

// 1. ç²å–æ‰€æœ‰åˆ†é¡å’Œä¸–ç•Œæ›¸
const categories = await db.worldBookCategories.toArray();
const books = state.worldBooks;

// ã€æ ¸å¿ƒæ”¹é€ ã€‘å¦‚æœå­˜åœ¨æœªåˆ†é¡çš„æ›¸ç±ï¼Œå°±å‰µå»ºä¸€å€‹â€œè™›æ“¬åˆ†é¡â€
const hasUncategorized = books.some(book => !book.categoryId);
if (hasUncategorized) {
    categories.push({ id: 'uncategorized', name: 'æœªåˆ†é¡' });
}

// 2. å°‡æ›¸ç±æŒ‰åˆ†é¡IDé€²è¡Œåˆ†çµ„
const booksByCategoryId = books.reduce((acc, book) => {
    const categoryId = book.categoryId || 'uncategorized';
    if (!acc[categoryId]) {
        acc[categoryId] = [];
    }
    acc[categoryId].push(book);
    return acc;
}, {});

// 3. éæ­·åˆ†é¡ï¼Œå‰µå»ºå¸¶æŠ˜ç–ŠåŠŸèƒ½çš„åˆ—è¡¨
categories.forEach(category => {
    const booksInCategory = booksByCategoryId[category.id] || [];
    if (booksInCategory.length > 0) {
        const allInCategoryChecked = booksInCategory.every(book => linkedIds.has(book.id));
        
        const header = document.createElement('div');
        header.className = 'wb-category-header';
        header.innerHTML = `
            <span class="arrow">â–¼</span>
            <input type="checkbox" class="wb-category-checkbox" data-category-id="${category.id}" ${allInCategoryChecked ? 'checked' : ''}>
            <span>${category.name}</span>
        `;
        
        const bookContainer = document.createElement('div');
        bookContainer.className = 'wb-book-container';
        bookContainer.dataset.containerFor = category.id;

        booksInCategory.forEach(book => {
            const isChecked = linkedIds.has(book.id);
            const label = document.createElement('label');
            // ã€æ ¸å¿ƒä¿®å¾©ã€‘çµ¦æ›¸ååŒ…ä¸€å€‹spanï¼Œæ–¹ä¾¿CSSåšçœç•¥è™Ÿè™•ç†
            label.innerHTML = `<input type="checkbox" class="wb-book-checkbox" value="${book.id}" data-parent-category="${category.id}" ${isChecked ? 'checked' : ''}> <span class="wb-book-name">${book.name}</span>`;
            bookContainer.appendChild(label);
        });

        // é è¨­å°‡æ‰€æœ‰è³‡æ–™å¤¾è¨­ç½®ç‚ºæŠ˜ç–Šç‹€æ…‹ï¼Œä¿æŒä»‹é¢æ•´æ½”
        header.classList.add('collapsed');
        bookContainer.classList.add('collapsed');

        worldBookCheckboxesContainer.appendChild(header);
        worldBookCheckboxesContainer.appendChild(bookContainer);
    }
});

updateWorldBookSelectionDisplay(); // æ›´æ–°é ‚éƒ¨çš„å·²é¸æ•¸é‡é¡¯ç¤º

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ updateWorldBookSelectionDisplay(); çš„ä¸‹ä¸€è¡Œï¼Œé»è²¼é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼


    // è¼‰å…¥ä¸¦æ›´æ–°æ‰€æœ‰é è¦½ç›¸é—œæ§åˆ¶é …
    const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
    if (themeRadio) themeRadio.checked = true;
    const fontSizeSlider = document.getElementById('font-size-slider');
    fontSizeSlider.value = chat.settings.fontSize || 13;
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    const customCssInput = document.getElementById('custom-css-input');
    customCssInput.value = chat.settings.customCss || '';
    
    updateSettingsPreview(); 

// ã€é€™ä¸‰è¡Œå°±æ˜¯æˆ‘å€‘æ–°åŠ çš„ï¼Œç¾åœ¨å·²ç¶“æ”¾åœ¨æ­£ç¢ºçš„ä½ç½®äº†ã€‘
renderBubblePresetSelector();
document.getElementById('bubble-style-preset-select').addEventListener('change', handlePresetSelectChange);
document.getElementById('manage-bubble-presets-btn').addEventListener('click', openBubblePresetManager);
    document.getElementById('chat-settings-modal').classList.add('visible');
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
            
function renderGroupMemberSettings(members) { 
    const container = document.getElementById('group-members-settings'); 
    container.innerHTML = ''; 
    members.forEach(member => { 
        const div = document.createElement('div'); 
        div.className = 'member-editor'; 
        div.dataset.memberId = member.id; 
        // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ§‹ã€‘â˜…â˜…â˜…
        // é¡¯ç¤ºçš„æ˜¯ groupNickname
        div.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`; 
        div.addEventListener('click', () => openMemberEditor(member.id)); 
        container.appendChild(div); 
    }); 
}

function openMemberEditor(memberId) { 
    editingMemberId = memberId; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === memberId); 
    document.getElementById('member-name-input').value = member.groupNickname; 
    document.getElementById('member-persona-input').value = member.persona; 
    document.getElementById('member-avatar-preview').src = member.avatar; 
    document.getElementById('member-settings-modal').classList.add('visible'); 
}
            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { 
    if (!editingMemberId) return; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === editingMemberId); 
    
    // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ§‹ã€‘â˜…â˜…â˜…
    const newNickname = document.getElementById('member-name-input').value.trim();
    if (!newNickname) {
        alert("ç¾¤æ˜µç¨±ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }
    member.groupNickname = newNickname; // åªä¿®æ”¹ç¾¤æ˜µç¨±
    member.persona = document.getElementById('member-persona-input').value; 
    member.avatar = document.getElementById('member-avatar-preview').src; 
    
    renderGroupMemberSettings(chat.members); 
    document.getElementById('member-settings-modal').classList.remove('visible'); 
});
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });

document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const newName = document.getElementById('chat-name-input').value.trim();
    if (!newName) return alert('å‚™è¨»å/ç¾¤åä¸èƒ½ç‚ºç©ºï¼');
    chat.name = newName;
    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¨˜æ†¶äº’é€šåŠŸèƒ½ - ä¿å­˜é‚è¼¯ â–¼â–¼â–¼
    const linkedMemoryCheckboxes = document.querySelectorAll('#memory-link-checkboxes-container input:checked');
    const memoryDepth = parseInt(document.getElementById('link-memory-depth-input').value) || 5;

    // â–¼â–¼â–¼ åœ¨é€™è£¡æ–°å¢ä¸‹é¢é€™ä¸€è¡Œ â–¼â–¼â–¼
    chat.settings.linkMemoryDepth = memoryDepth; // ç¨ç«‹ä¿å­˜è¨˜æ†¶æ¢æ•¸è¨­ç½®
    // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

    chat.settings.linkedMemories = Array.from(linkedMemoryCheckboxes).map(checkbox => ({
        chatId: checkbox.value,
        depth: memoryDepth // å°æ‰€æœ‰é¸ä¸­çš„é€£çµæ‡‰ç”¨ç›¸åŒçš„æ·±åº¦
    }));
    // â–²â–²â–² ä¿å­˜é‚è¼¯çµæŸ â–²â–²â–²


    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
    chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';

    chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
    chat.settings.customCss = document.getElementById('custom-css-input').value.trim();

    chat.settings.myPersona = document.getElementById('my-persona').value;
    chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input.wb-book-checkbox:checked');
    chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value);

    if (chat.isGroup) {
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
        // ä¿å­˜ç¾¤èŠå¾Œè‡ºæ´»å‹•è¨­ç½®
const groupActivityEnabled = document.getElementById('group-background-activity-switch').checked;
const groupActivityInterval = parseInt(document.getElementById('group-background-interval-input').value) || 120;

// ç¢ºä¿ lastActivityTimestamp æ¬„ä½å­˜åœ¨
const lastTimestamp = chat.settings.backgroundActivity ? chat.settings.backgroundActivity.lastActivityTimestamp : 0;

chat.settings.backgroundActivity = {
    enabled: groupActivityEnabled,
    interval: groupActivityInterval,
    lastActivityTimestamp: lastTimestamp // ä¿ç•™ä¸Šæ¬¡çš„æ™‚é–“æˆ³è¨˜
};

    } else {
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        chat.settings.minimaxVoiceId = document.getElementById('minimax-voice-id-input').value.trim();
        // â–¼â–¼â–¼ Part C.2: åœ¨é€™è£¡é»è²¼ã€ä¿å­˜ã€‘æƒ…ä¾¶é ­åƒè¨­ç½®çš„ä»£ç¢¼ â–¼â–¼â–¼
chat.settings.isCoupleAvatar = document.getElementById('couple-avatar-toggle').checked;
chat.settings.coupleAvatarDescription = document.getElementById('couple-avatar-description').value.trim();
// â–²â–²â–² ä¿å­˜é‚è¼¯çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ save-chat-settings-btn çš„ click äº‹ä»¶çš„ else å¡Šå…§ï¼Œé»è²¼é€™æ®µä»£ç¢¼ â–¼â–¼â–¼
        // ã€æ ¸å¿ƒæ–°å¢ã€‘å¾è¼¸å…¥æ¡†è®€å–å€¼ä¸¦ä¿å­˜
    chat.settings.weiboProfession = document.getElementById('weibo-profession-input').value.trim();
    chat.settings.weiboInstruction = document.getElementById('weibo-instruction-input').value.trim();
// ä¿å­˜è¦–é »é€šè©±è¨­ç½®
chat.settings.visualVideoCallEnabled = document.getElementById('visual-video-call-switch').checked;
chat.settings.charVideoImage = document.getElementById('char-video-image-preview').src;
chat.settings.userVideoImage = document.getElementById('user-video-image-preview').src;
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
    }

    chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    // â–¼â–¼â–¼ åœ¨ chat.settings.maxMemory = ... çš„ä¸‹ä¸€è¡Œæ·»åŠ  â–¼â–¼â–¼
chat.settings.timePerceptionEnabled = document.getElementById('time-perception-toggle').checked;
chat.settings.customTime = document.getElementById('custom-time-input').value;
// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
    // --- ä¿å­˜ç·šä¸‹æ¨¡å¼è¨­ç½® ---
    if (!chat.settings.offlineMode) chat.settings.offlineMode = {}; // åˆå§‹åŒ–
    chat.settings.offlineMode.enabled = document.getElementById('offline-mode-toggle').checked;
    chat.settings.offlineMode.prompt = document.getElementById('offline-prompt-input').value.trim();
    chat.settings.offlineMode.style = document.getElementById('offline-style-input').value.trim();
    chat.settings.offlineMode.wordCount = parseInt(document.getElementById('offline-word-count-input').value) || 300;
    // presets çš„è³‡æ–™åœ¨ç®¡ç†å‡½æ•¸ä¸­ç›´æ¥æ“ä½œï¼Œé€™è£¡ç„¡éœ€ä¿å­˜
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
// --- ä¿å­˜èŠå¤©ç¸½çµè¨­ç½® ---
if (!chat.settings.summary) chat.settings.summary = {}; // åˆå§‹åŒ–
chat.settings.summary.enabled = document.getElementById('summary-toggle').checked;
chat.settings.summary.mode = document.querySelector('input[name="summary-mode"]:checked').value;
chat.settings.summary.count = parseInt(document.getElementById('summary-count-input').value) || 20;
chat.settings.summary.prompt = document.getElementById('summary-prompt-input').value.trim();
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
    await db.chats.put(chat);

    applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
    
    chatSettingsModal.classList.remove('visible');
    renderChatInterface(state.activeChatId);
    renderChatList();
});
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('æ¸…ç©ºèŠå¤©è¨˜éŒ„', 'æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ­¤èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œç„¡æ³•æ¢å¾©ã€‚ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼

// åŒ¯å‡ºèŠå¤©è¨˜éŒ„æŒ‰éˆ•
document.getElementById('export-chat-history-btn').addEventListener('click', exportChatHistory);

// â€œå°å…¥èŠå¤©è¨˜éŒ„â€é€™å€‹å¯è¦‹çš„æŒ‰éˆ•
document.getElementById('import-chat-history-btn').addEventListener('click', () => {
    // é»æ“Šå®ƒæ™‚ï¼Œæˆ‘å€‘å»è§¸ç™¼é‚£å€‹éš±è—çš„æª”é¸æ“‡æ¡†
    document.getElementById('import-chat-history-input').click();
});

// éš±è—çš„æª”é¸æ“‡æ¡†
document.getElementById('import-chat-history-input').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        importChatHistory(file);
    }
    // æ¯æ¬¡é¸æ“‡å¾Œæ¸…ç©ºï¼Œé€™æ¨£ä¸‹æ¬¡é‚„èƒ½é¸æ“‡åŒä¸€å€‹æª”
    event.target.value = null; 
});

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œæ·»åŠ é€™å…©è¡Œ â–¼â–¼â–¼
setupFileUpload('char-video-image-input', (base64) => document.getElementById('char-video-image-preview').src = base64);
setupFileUpload('user-video-image-input', (base64) => document.getElementById('user-video-image-preview').src = base64);
// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            // â–¼â–¼â–¼ å°‡åŸä¾†çš„ add-sticker-btn äº‹ä»¶ç›£è½å™¨æ›¿æ›ç‚ºä¸‹é¢é€™è¡Œ â–¼â–¼â–¼
document.getElementById('add-sticker-btn').addEventListener('click', openBulkAddStickersModal);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());

            // â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ®µã€æ”¯æŒå¤šé¸ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ sticker-upload-input äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('sticker-upload-input').addEventListener('change', async (event) => {
    const files = event.target.files;
    if (!files.length) return;

    const newStickers = [];
    let canceled = false;

    // ä½¿ç”¨ for...of è¿´åœˆä¾†é€å€‹è™•ç†é¸ä¸­çš„æ–‡ä»¶
    for (const file of files) {
        if (canceled) break; // å¦‚æœç”¨æˆ¶ä¸­é€”å–æ¶ˆäº†ï¼Œå°±è·³å‡ºè¿´åœˆ

        // ç‚ºæ¯å€‹æª”ç”Ÿæˆä¸€å€‹è‡¨æ™‚çš„æœ¬åœ°é è¦½URL
        const previewUrl = URL.createObjectURL(file);
        
        // å½ˆå‡ºå¸¶åœ–ç‰‡é è¦½çš„å‘½åæ¡†
        const name = await showCustomPrompt(
            `ç‚ºè¡¨æƒ…å‘½å (${newStickers.length + 1}/${files.length})`,
            "è«‹è¼¸å…¥è¡¨æƒ…åç¨±",
            file.name.replace(/\.[^/.]+$/, ""), // é»˜èªä½¿ç”¨æª”æ¡ˆåä½œç‚ºåå­—
            'text',
            // é€™æ˜¯ showCustomPrompt çš„ä¸€å€‹éš±è—åŠŸèƒ½ï¼Œå¯ä»¥æ’å…¥é¡å¤–çš„HTML
            `<img src="${previewUrl}" style="max-width: 100px; max-height: 100px; margin-bottom: 10px; border-radius: 8px;">`
        );
        
        // é‡‹æ”¾è‡¨æ™‚çš„é è¦½URLï¼Œé¿å…è¨˜æ†¶é«”æ´©æ¼
        URL.revokeObjectURL(previewUrl);
        
        if (name && name.trim()) {
            // ä½¿ç”¨è€…ç¢ºèªå‘½åï¼Œè®€å–æª”å…§å®¹ä¸¦æº–å‚™ä¿å­˜
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
            
            newStickers.push({
                id: 'sticker_' + (Date.now() + newStickers.length),
                url: base64Url,
                name: name.trim()
            });
        } else if (name === null) {
            // å¦‚æœç”¨æˆ¶é»æ“Šäº†â€œå–æ¶ˆâ€
            const confirmCancel = await showCustomConfirm("ç¢ºèªå–æ¶ˆ", "ç¢ºå®šè¦å–æ¶ˆå‰©é¤˜è¡¨æƒ…çš„ä¸Šå‚³å—ï¼Ÿ");
            if (confirmCancel) {
                canceled = true;
            }
        } else {
            alert("è¡¨æƒ…åä¸èƒ½ç‚ºç©ºï¼");
        }
    }
    
    // è¿´åœˆçµæŸå¾Œï¼Œå¦‚æœæ”¶é›†åˆ°äº†æ–°è¡¨æƒ…ï¼Œå°±æ‰¹é‡æ·»åŠ åˆ°è³‡æ–™åº«
    if (newStickers.length > 0) {
        await db.userStickers.bulkAdd(newStickers);
        state.userStickers.push(...newStickers);
        renderStickerPanel();
        await showCustomAlert("ä¸Šå‚³æˆåŠŸ", `å·²æˆåŠŸæ·»åŠ  ${newStickers.length} å€‹æ–°è¡¨æƒ…ï¼`);
    }

    // æ¸…ç©ºæª”é¸æ“‡å™¨çš„å€¼ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡ç›¸åŒçš„æ–‡ä»¶
    event.target.value = null;
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("ç™¼é€èªéŸ³", "è«‹è¼¸å…¥ä½ æƒ³èªªçš„å…§å®¹ï¼š"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("ç™¼é€ç…§ç‰‡", "è«‹ç”¨æ–‡å­—æè¿°æ‚¨è¦ç™¼é€çš„ç…§ç‰‡ï¼š"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£è«‹æ±‚åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
const waimaiModal = document.getElementById('waimai-request-modal');
document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
    waimaiModal.classList.add('visible');
});

document.getElementById('waimai-cancel-btn').addEventListener('click', () => {
    waimaiModal.classList.remove('visible');
});

document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    
    const productInfoInput = document.getElementById('waimai-product-info');
    const amountInput = document.getElementById('waimai-amount');
    
    const productInfo = productInfoInput.value.trim();
    const amount = parseFloat(amountInput.value);

    if (!productInfo) {
        alert('è«‹è¼¸å…¥å•†å“è³‡è¨Šï¼');
        return;
    }
    if (isNaN(amount) || amount <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ä»£ä»˜é‡‘é¡ï¼');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const now = Date.now();

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    const msg = {
        role: 'user',
        senderName: myNickname, 
        type: 'waimai_request',
        productInfo: productInfo,
        amount: amount,
        status: 'pending',
        countdownEndTime: now + 15 * 60 * 1000,
        timestamp: now
    };

    chat.history.push(msg);
    
    // é‚£ä¸€å¤§æ®µä»£ç¢¼å·²ç¶“è¢«åˆªé™¤äº†
    
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();

    productInfoInput.value = '';
    amountInput.value = '';
    waimaiModal.classList.remove('visible');
});         
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);


// â–²â–²â–² æ›¿æ›åˆ°é€™è£¡çµæŸ â–²â–²â–²


            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
            
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);

// â–¼â–¼â–¼ ã€æœ€çµ‚åŠ å¼·ç‰ˆã€‘ç”¨é€™å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ selection-delete-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('selection-delete-btn').addEventListener('click', async () => {
    if (selectedMessages.size === 0) return;
    const confirmed = await showCustomConfirm('åˆªé™¤æ¶ˆæ¯', `ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${selectedMessages.size} æ¢æ¶ˆæ¯å—ï¼Ÿé€™å°‡æ”¹è®ŠAIçš„è¨˜æ†¶ã€‚`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        
        // 1. ã€æ ¸å¿ƒåŠ å¼·ã€‘åœ¨åˆªé™¤å‰ï¼Œæª¢æŸ¥è¢«åˆªé™¤çš„æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«æŠ•ç¥¨
        let deletedPollsInfo = [];
        for (const timestamp of selectedMessages) {
            const msg = chat.history.find(m => m.timestamp === timestamp);
            if (msg && msg.type === 'poll') {
                deletedPollsInfo.push(`é—œæ–¼â€œ${msg.question}â€çš„æŠ•ç¥¨(æ™‚é–“æˆ³è¨˜: ${msg.timestamp})`);
            }
        }
        
        // 2. æ›´æ–°å¾Œç«¯çš„æ­·å²è¨˜éŒ„
        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
        
        // 3. ã€æ ¸å¿ƒåŠ å¼·ã€‘æ§‹å»ºæ›´å…·é«”çš„â€œéºå¿˜æŒ‡ä»¤â€
        let forgetReason = "ä¸€äº›ä¹‹å‰çš„æ¶ˆæ¯å·²è¢«ä½¿ç”¨è€…åˆªé™¤ã€‚";
        if (deletedPollsInfo.length > 0) {
            forgetReason += ` å…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹æŠ•ç¥¨ï¼š${deletedPollsInfo.join('ï¼›')}ã€‚`;
        }
        forgetReason += " ä½ æ‡‰è©²åƒå®ƒå€‘å¾æœªå­˜åœ¨éä¸€æ¨£ç¹¼çºŒå°è©±ï¼Œä¸¦ç›¸æ‡‰åœ°èª¿æ•´ä½ çš„è¨˜æ†¶å’Œè¡Œç‚ºï¼Œä¸è¦å†æåŠé€™äº›è¢«åˆªé™¤çš„å…§å®¹ã€‚";

        const forgetInstruction = {
            role: 'system',
            content: `[ç³»çµ±æç¤ºï¼š${forgetReason}]`,
            timestamp: Date.now(),
            isHidden: true 
        };
        chat.history.push(forgetInstruction);
        
        // 4. å°‡åŒ…å«â€œéºå¿˜æŒ‡ä»¤â€çš„ã€æ›´æ–°å¾Œçš„chatç‰©ä»¶å­˜å›è³‡æ–™åº«
        await db.chats.put(chat);
        
        // 5. æœ€å¾Œæ‰æ›´æ–°UI
        renderChatInterface(state.activeChatId);
        renderChatList();
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

            document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("ä¿®æ”¹æ˜µç¨±", "è«‹è¼¸å…¥æ–°çš„æ˜µç¨±", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
            document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
            document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
            document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
            document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });

// â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™å…©è¡Œï¼Œæ›¿æ›æ‰èˆŠçš„äº‹ä»¶ç¶å®š â–¼â–¼â–¼

document.getElementById('create-shuoshuo-btn').addEventListener('click', () => openQZonePublisher('shuoshuo'));
document.getElementById('create-post-btn').addEventListener('click', () => openQZonePublisher('complex'));

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

            document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
            document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });

// --- â†“â†“â†“ å¾é€™è£¡é–‹å§‹è¤‡è£½ â†“â†“â†“ ---

document.getElementById('album-photos-back-btn').addEventListener('click', () => {
    state.activeAlbumId = null;
    showScreen('album-screen');
});

document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

document.getElementById('album-photo-input').addEventListener('change', async (event) => {
    if (!state.activeAlbumId) return;
    const files = event.target.files;
    if (!files.length) return;

    const album = await db.qzoneAlbums.get(state.activeAlbumId);
    
    for (const file of files) {
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
    }

    const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
    const updateData = { photoCount };
    
    if (!album.photoCount || album.coverUrl.includes('placeholder')) {
        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
        if(firstPhoto) updateData.coverUrl = firstPhoto.url;
    }

    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
    await renderAlbumPhotosScreen();
    await renderAlbumList();
    
    event.target.value = null;
    alert('ç…§ç‰‡ä¸Šå‚³æˆåŠŸï¼');
});

// --- â†‘â†‘â†‘ è¤‡è£½åˆ°é€™è£¡çµæŸ â†‘â†‘â†‘ ---

// --- â†“â†“â†“ å¾é€™è£¡é–‹å§‹è¤‡è£½ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„ photos-grid-page ç›£è½å™¨ â†“â†“â†“ ---

document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.photo-delete-btn');
    const photoThumb = e.target.closest('.photo-thumb');

    if (deleteBtn) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°åœ–ç‰‡ä¸Š
        const photoId = parseInt(deleteBtn.dataset.photoId);
        const confirmed = await showCustomConfirm(
            'åˆªé™¤ç…§ç‰‡',
            'ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚',
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            const deletedPhoto = await db.qzonePhotos.get(photoId);
            if (!deletedPhoto) return;
            
            await db.qzonePhotos.delete(photoId);

            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            const photoCount = (album.photoCount || 1) - 1;
            const updateData = { photoCount };
            
            if (album.coverUrl === deletedPhoto.url) {
                const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            }
            
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            alert('ç…§ç‰‡å·²åˆªé™¤ã€‚');
        }
    } 
    else if (photoThumb) {
        // é€™å°±æ˜¯æ¢å¾©çš„åœ–ç‰‡é»æ“Šæ”¾å¤§åŠŸèƒ½ï¼
        openPhotoViewer(photoThumb.src);
    }
});

// æ¢å¾©åœ–ç‰‡æª¢è¦–å™¨çš„æ§åˆ¶äº‹ä»¶
document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);

// æ¢å¾©éµç›¤å·¦å³ç®­é ­å’ŒESCéµçš„åŠŸèƒ½
document.addEventListener('keydown', (e) => {
    if (!photoViewerState.isOpen) return; 

    if (e.key === 'ArrowRight') {
        showNextPhoto();
    } else if (e.key === 'ArrowLeft') {
        showPrevPhoto();
    } else if (e.key === 'Escape') {
        closePhotoViewer();
    }
});

// --- â†‘â†‘â†‘ è¤‡è£½åˆ°é€™è£¡çµæŸ â†‘â†‘â†‘ ---
         
document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("å‰µå»ºæ–°ç›¸å†Š", "è«‹è¼¸å…¥ç›¸å†Šåç¨±"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`ç›¸å†Š "${albumName}" å‰µå»ºæˆåŠŸï¼`); } else if (albumName !== null) { alert("ç›¸å†Šåç¨±ä¸èƒ½ç‚ºç©ºï¼"); } });

            document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
            document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
            document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
            document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("è¼¸å…¥åœ–ç‰‡URL", "è«‹è¼¸å…¥ç¶²è·¯åœ–ç‰‡çš„é€£çµ", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
            document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
            const imageModeBtn = document.getElementById('switch-to-image-mode');
            const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
            const imageModeContent = document.getElementById('image-mode-content');
            const textImageModeContent = document.getElementById('text-image-mode-content');
            imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
            textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });

// â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™ä¸€æ•´å¡Šã€ä¿®å¾©å¾Œã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰å‰›æ‰åˆªé™¤çš„èˆŠä»£ç¢¼ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨é€™ã€ä¸€æ•´å¡Šã€‘ä»£ç¢¼ï¼Œæ›¿æ›æ‰èˆŠçš„ 'confirm-create-post-btn' äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ 'confirm-create-post-btn' äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
    const modal = document.getElementById('create-post-modal');
    const mode = modal.dataset.mode;

    // ã€æ ¸å¿ƒæ”¹é€ ã€‘æˆ‘å€‘åœ¨é€™é‡ŒåŠ ä¸€å€‹åˆ¤æ–·
    // å¦‚æœç•¶å‰æ˜¯ 'forum' (å°çµ„ç™¼å¸–) æ¨¡å¼ï¼Œå°±èª¿ç”¨æˆ‘å€‘å‰›å‰›å¯«çš„ç™¼å¸–å‡½æ•¸
    if (mode === 'forum') {
        await handleCreateForumPost();
        return; // åŸ·è¡Œå®Œå°±çµæŸï¼Œä¸å¾€ä¸‹èµ°äº†
    }
    
    // å¦‚æœæ˜¯ 'weibo' æ¨¡å¼ï¼Œå°±èª¿ç”¨ç™¼å¾®åšçš„å‡½æ•¸
    if (mode === 'weibo') {
        await handlePublishWeibo();
        return;
    }

    // --- ä¸‹é¢æ˜¯ä½ åŸä¾†å·²æœ‰çš„ç™¼ä½ˆâ€œå‹•æ…‹â€çš„é‚è¼¯ï¼Œæˆ‘å€‘ä¿æŒä¸è®Š ---
    const editingId = parseInt(modal.dataset.editingPostId);
    const areCommentsVisible = document.getElementById('post-comments-toggle').checked;
    
    const visibility = document.querySelector('input[name="visibility"]:checked').value;
    let visibleGroupIds = null;
    if (visibility === 'groups') {
        visibleGroupIds = Array.from(document.querySelectorAll('#post-visibility-groups input:checked'))
                           .map(cb => parseInt(cb.value));
        if (visibleGroupIds.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å¯è¦‹çš„åˆ†çµ„ï¼");
            return;
        }
    }

    let postData = {};

    if (mode === 'edit') {
        const existingPost = await db.qzonePosts.get(editingId);
        if (!existingPost) {
            alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„å‹•æ…‹ï¼');
            return;
        }
        postData = { 
            ...existingPost, 
            areCommentsVisible: areCommentsVisible,
            visibleGroupIds: visibleGroupIds
        };
        
        if (postData.type === 'shuoshuo') {
            postData.content = document.getElementById('post-public-text').value.trim();
        } else {
            postData.publicText = document.getElementById('post-public-text').value.trim();
            if (postData.type === 'image_post') {
                postData.imageUrl = document.getElementById('post-image-preview').src;
                postData.imageDescription = document.getElementById('post-image-description').value.trim();
            } else if (postData.type === 'text_image') {
                postData.hiddenContent = document.getElementById('post-hidden-text').value.trim();
            }
        }
        await db.qzonePosts.put(postData);

    } else {
        const basePostData = {
            timestamp: Date.now(),
            authorId: 'user',
            areCommentsVisible: areCommentsVisible,
            visibleGroupIds: visibleGroupIds
        };
        
        if (mode === 'shuoshuo') {
            const content = document.getElementById('post-public-text').value.trim();
            if (!content) return alert('èªªèªªå…§å®¹ä¸èƒ½ç‚ºç©ºå“¦ï¼');
            postData = { ...basePostData, type: 'shuoshuo', content: content };
        } else {
            const publicText = document.getElementById('post-public-text').value.trim();
            const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');
            if (isImageModeActive) {
                const imageUrl = document.getElementById('post-image-preview').src;
                const imageDescription = document.getElementById('post-image-description').value.trim();
                if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) return alert('è«‹å…ˆæ·»åŠ ä¸€å¼µåœ–ç‰‡å†ç™¼ä½ˆå‹•æ…‹å“¦ï¼');
                if (!imageDescription) return alert('è«‹ç‚ºä½ çš„åœ–ç‰‡æ·»åŠ ä¸€å€‹ç°¡å–®çš„æè¿°ï¼ˆå¿…å¡«ï¼Œçµ¦AIçœ‹çš„ï¼‰ï¼');
                postData = { ...basePostData, type: 'image_post', publicText, imageUrl, imageDescription };
            } else {
                const hiddenText = document.getElementById('post-hidden-text').value.trim();
                if (!hiddenText) return alert('è«‹è¼¸å…¥æ–‡å­—åœ–æè¿°ï¼');
                postData = { ...basePostData, type: 'text_image', publicText, hiddenContent: hiddenText };
            }
        }
        const newPostId = await db.qzonePosts.add(postData);
        postData.id = newPostId;
    }
    
    let postSummary = postData.content || postData.publicText || postData.imageDescription || postData.hiddenContent || "ï¼ˆç„¡æ–‡å­—å…§å®¹ï¼‰";
    postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');
    for (const chatId in state.chats) {
        const chat = state.chats[chatId];
        if (chat.isGroup) continue;
        const historyMessage = { role: 'system', content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶${editingId ? 'ç·¨è¼¯äº†' : 'ç™¼ä½ˆäº†'}ä¸€æ¢å‹•æ…‹(ID: ${editingId || postData.id})ï¼Œå…§å®¹æ‘˜è¦æ˜¯ï¼šâ€œ${postSummary}â€ã€‚]`, timestamp: Date.now(), isHidden: true };
        chat.history.push(historyMessage);
        await db.chats.put(chat);
    }
    
    await renderQzonePosts();
    modal.classList.remove('visible');
    delete modal.dataset.editingPostId;
    delete modal.dataset.mode;
    alert(`å‹•æ…‹${editingId ? 'ç·¨è¼¯' : 'ç™¼ä½ˆ'}æˆåŠŸï¼`);
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘æ–°ä»£ç¢¼ â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ç‚ºå…¨åŸŸèŠå¤©èƒŒæ™¯çš„ä¸Šå‚³æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('global-bg-upload-input').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if(file) {
        const dataUrl = await new Promise((res) => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.readAsDataURL(file);
        });
        newGlobalBgBase64 = dataUrl; // å°‡æ–°èƒŒæ™¯å­˜å…¥è‡¨æ™‚è®Šæ•¸
        // å³æ™‚æ›´æ–°é è¦½
        const preview = document.getElementById('global-bg-preview');
        preview.style.backgroundImage = `url(${dataUrl})`;
        preview.textContent = '';
    }
});

// ã€å…¨æ–°ã€‘ç‚ºå…¨åŸŸèŠå¤©èƒŒæ™¯çš„ç§»é™¤æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('remove-global-bg-btn').addEventListener('click', () => {
    newGlobalBgBase64 = 'REMOVED'; // ç”¨ä¸€å€‹ç‰¹æ®Šæ¨™è¨˜è¡¨ç¤ºâ€œç§»é™¤â€
    const preview = document.getElementById('global-bg-preview');
    preview.style.backgroundImage = 'none';
    preview.textContent = 'å·²ç§»é™¤';
    alert('å…¨åŸŸèƒŒæ™¯å°‡åœ¨é»æ“Šâ€œä¿å­˜â€å¾Œè¢«ç§»é™¤ã€‚');
});

// ã€å…¨æ–°ã€‘ç‚ºâ€œä¸€éµæ¸…ç©ºå–®äººèƒŒæ™¯â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('clear-all-single-bgs-btn').addEventListener('click', clearAllSingleChatBackgrounds);

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šã€‘åŒ…å«æ‰€æœ‰æ»‘å‹•å’Œé»æ“Šäº‹ä»¶çš„å®Œæ•´ä»£ç¢¼ï¼Œæ›¿æ›æ‰èˆŠçš„ postsList äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

const postsList = document.getElementById('qzone-posts-list');
let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };

function resetAllSwipes(exceptThisOne = null) {
    document.querySelectorAll('.qzone-post-container').forEach(container => {
        if (container !== exceptThisOne) {
            container.querySelector('.qzone-post-item').classList.remove('swiped');
        }
    });
}

const handleSwipeStart = (e) => {
    const targetContainer = e.target.closest('.qzone-post-container');
    if (!targetContainer) return;

    resetAllSwipes(targetContainer);
    swipeState.activeContainer = targetContainer;
    swipeState.isDragging = true;
    swipeState.isClick = true;
    swipeState.swipeDirection = null;
    swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
};

const handleSwipeMove = (e) => {
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    const diffX = currentX - swipeState.startX;
    const diffY = currentY - swipeState.startY;
    const absDiffX = Math.abs(diffX);
    const absDiffY = Math.abs(diffY);
    const clickThreshold = 5;

    if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
        swipeState.isClick = false;
    }

    if (swipeState.swipeDirection === null) {
        if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
            if (absDiffX > absDiffY) {
                swipeState.swipeDirection = 'horizontal';
            } else {
                swipeState.swipeDirection = 'vertical';
            }
        }
    }
    if (swipeState.swipeDirection === 'vertical') {
        handleSwipeEnd(e);
        return;
    }
    if (swipeState.swipeDirection === 'horizontal') {
        e.preventDefault();
        swipeState.currentX = currentX;
        let translation = diffX;
        if (translation > 0) translation = 0;
        if (translation < -90) translation = -90;
        swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
    }
};

const handleSwipeEnd = (e) => {
    if (swipeState.isClick) {
        swipeState.isDragging = false;
        swipeState.activeContainer = null;
        return;
    }
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
    postItem.style.transition = 'transform 0.3s ease';

    const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
    const diffX = finalX - swipeState.startX;
    const swipeThreshold = -40;

    if (swipeState.swipeDirection === 'horizontal' && diffX < swipeThreshold) {
        postItem.classList.add('swiped');
        postItem.style.transform = '';
    } else {
        postItem.classList.remove('swiped');
        postItem.style.transform = '';
    }

    swipeState.isDragging = false;
    swipeState.startX = 0;
    swipeState.startY = 0;
    swipeState.currentX = 0;
    swipeState.activeContainer = null;
    swipeState.swipeDirection = null;
    swipeState.isClick = true;
};

// --- ç¶å®šæ‰€æœ‰æ»‘å‹•äº‹ä»¶ ---
postsList.addEventListener('mousedown', handleSwipeStart);
document.addEventListener('mousemove', handleSwipeMove);
document.addEventListener('mouseup', handleSwipeEnd);
postsList.addEventListener('touchstart', handleSwipeStart, { passive: false });
postsList.addEventListener('touchmove', handleSwipeMove, { passive: false });
postsList.addEventListener('touchend', handleSwipeEnd);

// â–¼â–¼â–¼ æ­¥é©Ÿ3.3ï¼šç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ qzone-posts-list çš„ click äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
postsList.addEventListener('click', async (e) => {
    e.stopPropagation();
    const target = e.target;
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
const summonBtn = target.closest('.action-icon.summon-npc');
if (summonBtn) {
    const postId = parseInt(summonBtn.dataset.postId);
    const authorId = summonBtn.dataset.authorId;
    if (!isNaN(postId) && authorId) {
        handleNpcSummonClick(postId, authorId);
    }
    return; // è™•ç†å®Œå¬å–šé‚è¼¯å¾Œï¼Œç›´æ¥çµæŸï¼Œä¸åŸ·è¡Œå¾ŒçºŒçš„é»è´Šç­‰åˆ¤æ–·
}
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹ï¼šè™•ç†é»æ“Šè©•è«–æœ¬èº«ï¼ˆç”¨æ–¼å›å¾©ï¼‰ã€‘â˜…â˜…â˜…â˜…â˜…
    const commentItem = target.closest('.comment-item');
    // ç¢ºä¿é»æ“Šçš„ä¸æ˜¯åˆªé™¤æŒ‰éˆ•æˆ–è©•è«–è£¡çš„åå­—é€£çµ
    if (commentItem && !target.classList.contains('comment-delete-btn') && !target.classList.contains('commenter-name') && !target.classList.contains('reply-target-name')) {
        const postContainer = commentItem.closest('.qzone-post-container');
        if (postContainer) {
            const commenterName = commentItem.dataset.commenterName;
            const myNickname = state.qzoneSettings.nickname;
            
            // å¦‚æœé»æ“Šçš„æ˜¯è‡ªå·±çš„è©•è«–ï¼Œå‰‡ä¸é€²å…¥å›å¾©æ¨¡å¼
            if (commenterName !== myNickname) {
                const commentInput = postContainer.querySelector('.comment-input');
                commentInput.placeholder = `å›å¾© ${commenterName}:`;
                commentInput.dataset.replyTo = commenterName; // æŠŠè¦å›å¾©çš„äººçš„åå­—ï¼Œè‡¨æ™‚å­˜èµ·ä¾†
                commentInput.focus(); // è‡ªå‹•èšç„¦åˆ°è¼¸å…¥æ¡†
            }
        }
        return; // è™•ç†å®Œé»æ“Šè©•è«–å¾Œï¼Œå°±ä¸ç”¨å¾€ä¸‹åŸ·è¡Œäº†
    }

    if (target.classList.contains('comment-delete-btn')) {
        const postContainer = target.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        const commentIndex = parseInt(target.dataset.commentIndex);
        if (isNaN(postId) || isNaN(commentIndex)) return;
        const post = await db.qzonePosts.get(postId);
        if (!post || !post.comments || !post.comments[commentIndex]) return;
        const commentText = post.comments[commentIndex].text;
        const confirmed = await showCustomConfirm('åˆªé™¤è©•è«–', `ç¢ºå®šè¦åˆªé™¤é€™æ¢è©•è«–å—ï¼Ÿ\n\nâ€œ${commentText.substring(0, 50)}...â€`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            post.comments.splice(commentIndex, 1);
            await db.qzonePosts.update(postId, { comments: post.comments });
            await renderQzonePosts();
            alert('è©•è«–å·²åˆªé™¤ã€‚');
        }
        return;
    }

    if (target.classList.contains('post-actions-btn')) {
        const container = target.closest('.qzone-post-container');
        if (container && container.dataset.postId) showPostActions(parseInt(container.dataset.postId));
        return;
    }

    if (target.closest('.qzone-post-delete-action')) {
        const container = target.closest('.qzone-post-delete-action').parentElement;
        if (!container) return;
        const postIdToDelete = parseInt(container.dataset.postId);
        if (isNaN(postIdToDelete)) return;
        const confirmed = await showCustomConfirm('åˆªé™¤å‹•æ…‹', 'ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™æ¢å‹•æ…‹å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            container.style.transition = 'all 0.3s ease';
            container.style.transform = 'scale(0.8)';
            container.style.opacity = '0';
            setTimeout(async () => {
                 await db.qzonePosts.delete(postIdToDelete);
                 const notificationIdentifier = `(ID: ${postIdToDelete})`;
                 for (const chatId in state.chats) {
                     const chat = state.chats[chatId];
                     const originalHistoryLength = chat.history.length;
                     chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                     if (chat.history.length < originalHistoryLength) await db.chats.put(chat);
                 }
                 await renderQzonePosts();
                 alert('å‹•æ…‹å·²åˆªé™¤ã€‚');
            }, 300);
        }
        return;
    }

    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        showCustomAlert("åœ–ç‰‡å…§å®¹", target.dataset.hiddenText.replace(/<br>/g, '\n'));
        return;
    }
    const icon = target.closest('.action-icon');
    if (icon) {
        const postContainer = icon.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        if (isNaN(postId)) return;
        if (icon.classList.contains('like')) {
            const post = await db.qzonePosts.get(postId);
            if (!post) return;
            if (!post.likes) post.likes = [];
            const userNickname = state.qzoneSettings.nickname;
            const userLikeIndex = post.likes.indexOf(userNickname);
            if (userLikeIndex > -1) {
                post.likes.splice(userLikeIndex, 1);
            } else {
                post.likes.push(userNickname);
                icon.classList.add('animate-like');
                icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
            }
            await db.qzonePosts.update(postId, { likes: post.likes });
        }
        if (icon.classList.contains('favorite')) {
            const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
            if (existingFavorite) {
                await db.favorites.delete(existingFavorite.id);
                await showCustomAlert('æç¤º', 'å·²å–æ¶ˆæ”¶è—');
            } else {
                const postToSave = await db.qzonePosts.get(postId);
                if (postToSave) {
                    await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                    await showCustomAlert('æç¤º', 'æ”¶è—æˆåŠŸï¼');
                }
            }
        }
        await renderQzonePosts();
        return;
    }
    
    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹ï¼šè™•ç†è©•è«–ç™¼é€é‚è¼¯ã€‘â˜…â˜…â˜…â˜…â˜…
    const sendBtn = target.closest('.comment-send-btn');
    if (sendBtn) {
        const postContainer = sendBtn.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('è©•è«–å…§å®¹ä¸èƒ½ç‚ºç©ºå“¦ï¼');
        const post = await db.qzonePosts.get(postId);
        if (!post) return;
        if (!post.comments) post.comments = [];

        // å‰µå»ºæ–°çš„è©•è«–ç‰©ä»¶
        const newComment = { 
            commenterName: state.qzoneSettings.nickname, 
            text: commentText, 
            timestamp: Date.now() 
        };

        // æª¢æŸ¥æ˜¯ä¸æ˜¯åœ¨å›å¾©æ¨¡å¼
        if (commentInput.dataset.replyTo) {
            newComment.replyTo = commentInput.dataset.replyTo; // å¦‚æœæ˜¯ï¼Œå°±æŠŠå›å¾©ç‰©ä»¶çš„åå­—åŠ ä¸Š
        }

        post.comments.push(newComment);
        await db.qzonePosts.update(postId, { comments: post.comments });
        for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            if (!chat.isGroup) {
                let aiNotification = `[ç³»çµ±æç¤ºï¼š'${state.qzoneSettings.nickname}' åœ¨IDç‚º${postId}çš„å‹•æ…‹ä¸‹ç™¼è¡¨äº†è©•è«–ï¼šâ€œ${commentText}â€`;
                if(newComment.replyTo) {
                    aiNotification += ` (é€™æ˜¯å°'${newComment.replyTo}'çš„å›å¾©)`;
                }
                aiNotification += `]`;
                chat.history.push({ role: 'system', content: aiNotification, timestamp: Date.now(), isHidden: true });
                await db.chats.put(chat);
            }
        }
        
        // ç™¼é€å¾Œï¼Œé‡ç½®è¼¸å…¥æ¡†ç‹€æ…‹
        commentInput.value = '';
        commentInput.placeholder = 'å‹å–„çš„è©•è«–æ˜¯äº¤æµçš„èµ·é»';
        delete commentInput.dataset.replyTo; // æ¸…é™¤å›å¾©ç‹€æ…‹

        await renderQzonePosts();
        return;
    }
});
// â–²â–²â–² æ­¥é©Ÿ3.3æ›¿æ›çµæŸ â–²â–²â–²

            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼ä¸‹é¢é€™å…©è¡Œ â–¼â–¼â–¼

            // ç¶å®šå‹•æ…‹é å’Œæ”¶è—é çš„è¿”å›æŒ‰éˆ•
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

            // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œæª¢æŸ¥ä¸¦ç¢ºä¿ä½ æœ‰é€™æ®µå®Œæ•´çš„ä»£ç¢¼ â–¼â–¼â–¼

            // æ”¶è—é æœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('favorites-search-input');
            const searchClearBtn = document.getElementById('favorites-search-clear-btn');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                // æ§åˆ¶æ¸…é™¤æŒ‰éˆ•çš„é¡¯ç¤º/éš±è—
                searchClearBtn.style.display = searchTerm ? 'block' : 'none';

                if (!searchTerm) {
                    displayFilteredFavorites(allFavoriteItems); // å¦‚æœæœç´¢æ¡†ç‚ºç©ºï¼Œé¡¯ç¤ºæ‰€æœ‰
                    return;
                }

                // ç¯©é¸é‚è¼¯
                const filteredItems = allFavoriteItems.filter(item => {
                    let contentToSearch = '';
                    let authorToSearch = '';

                    if (item.type === 'qzone_post') {
                        const post = item.content;
                        contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                        if (post.authorId === 'user') {
                            authorToSearch = state.qzoneSettings.nickname;
                        } else if (state.chats[post.authorId]) {
                            authorToSearch = state.chats[post.authorId].name;
                        }
                    } else if (item.type === 'chat_message') {
                        const msg = item.content;
                        if (typeof msg.content === 'string') {
                            contentToSearch = msg.content;
                        }
                        const chat = state.chats[item.chatId];
                        if (chat) {
                           if (msg.role === 'user') {
                                authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                           } else {
                                authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                           }
                        }
                    }
                    
                    // åŒæ™‚æœç´¢å…§å®¹å’Œä½œè€…ï¼Œä¸¦ä¸”ä¸å€åˆ†å¤§å°å¯«
                    return contentToSearch.toLowerCase().includes(searchTerm) || 
                           authorToSearch.toLowerCase().includes(searchTerm);
                });

                displayFilteredFavorites(filteredItems);
            });

            // æ¸…é™¤æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            searchClearBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                displayFilteredFavorites(allFavoriteItems);
                searchInput.focus();
            });

            // â–²â–²â–² ä»£ç¢¼æª¢æŸ¥çµæŸ â–²â–²â–²

            // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
            
            // ç‚ºèŠå¤©ä»‹é¢çš„æ‰¹é‡æ”¶è—æŒ‰éˆ•ç¶å®šäº‹ä»¶
                        // ç‚ºèŠå¤©ä»‹é¢çš„æ‰¹é‡æ”¶è—æŒ‰éˆ•ç¶å®šäº‹ä»¶ (å·²ä¿®æ­£)
            document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                if (selectedMessages.size === 0) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const favoritesToAdd = [];
                const timestampsToFavorite = [...selectedMessages];

                for (const timestamp of timestampsToFavorite) {
                    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä½¿ç”¨æ–°çš„ã€é«˜æ•ˆçš„ç´¢å¼•é€²è¡ŒæŸ¥è©¢
                    const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                    
                    if (!existing) {
                        const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                        if (messageToSave) {
                            favoritesToAdd.push({
                                type: 'chat_message',
                                content: messageToSave,
                                chatId: state.activeChatId,
                                timestamp: Date.now(), // é€™æ˜¯æ”¶è—æ“ä½œç™¼ç”Ÿçš„æ™‚é–“
                                originalTimestamp: messageToSave.timestamp // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä¿å­˜åŸå§‹æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜åˆ°æ–°æ¬„ä½
                            });
                        }
                    }
                }

                if (favoritesToAdd.length > 0) {
                    await db.favorites.bulkAdd(favoritesToAdd);
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // æ›´æ–°å…¨åŸŸæ”¶è—ç·©å­˜
                    await showCustomAlert('æ”¶è—æˆåŠŸ', `å·²æˆåŠŸæ”¶è— ${favoritesToAdd.length} æ¢æ¶ˆæ¯ã€‚`);
                } else {
                    await showCustomAlert('æç¤º', 'é¸ä¸­çš„æ¶ˆæ¯å‡å·²æ”¶è—éã€‚');
                }
                
                exitSelectionMode();
            });

            // æ”¶è—é é¢çš„"ç·¨è¼¯"æŒ‰éˆ•äº‹ä»¶ (å·²ä¿®æ­£)
            const favoritesEditBtn = document.getElementById('favorites-edit-btn');
            const favoritesView = document.getElementById('favorites-view');
            const favoritesActionBar = document.getElementById('favorites-action-bar');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // ç²å–ä¸»å·¡è¦½åˆ—
            const favoritesList = document.getElementById('favorites-list'); // ç²å–æ”¶è—åˆ—è¡¨
            
            favoritesEditBtn.addEventListener('click', () => {
                isFavoritesSelectionMode = !isFavoritesSelectionMode;
                favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

                if (isFavoritesSelectionMode) {
                    // --- é€²å…¥ç·¨è¼¯æ¨¡å¼ ---
                    favoritesEditBtn.textContent = 'å®Œæˆ';
                    favoritesActionBar.style.display = 'block'; // é¡¯ç¤ºåˆªé™¤æ“ä½œæ¬„
                    mainBottomNav.style.display = 'none'; // â–¼ æ–°å¢ï¼šéš±è—ä¸»å·¡è¦½åˆ—
                    favoritesList.style.paddingBottom = '80px'; // â–¼ æ–°å¢ï¼šçµ¦åˆ—è¡¨åº•éƒ¨å¢åŠ ç©ºé–“
                } else {
                    // --- é€€å‡ºç·¨è¼¯æ¨¡å¼ ---
                    favoritesEditBtn.textContent = 'ç·¨è¼¯';
                    favoritesActionBar.style.display = 'none'; // éš±è—åˆªé™¤æ“ä½œæ¬„
                    mainBottomNav.style.display = 'flex';  // â–¼ æ–°å¢ï¼šæ¢å¾©ä¸»å·¡è¦½åˆ—
                    favoritesList.style.paddingBottom = ''; // â–¼ æ–°å¢ï¼šæ¢å¾©åˆ—è¡¨é»˜èªpadding

                    // é€€å‡ºæ™‚æ¸…ç©ºæ‰€æœ‰é¸æ“‡
                    selectedFavorites.clear();
                    document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                    document.getElementById('favorites-delete-selected-btn').textContent = `åˆªé™¤ (0)`;
                }
            });

// â–¼â–¼â–¼ å°‡å®ƒã€å®Œæ•´æ›¿æ›ã€‘ç‚ºä¸‹é¢é€™æ®µä¿®æ­£å¾Œçš„ä»£ç¢¼ â–¼â–¼â–¼
// æ”¶è—åˆ—è¡¨çš„é»æ“Šé¸æ“‡äº‹ä»¶ (äº‹ä»¶å§”è¨—)
document.getElementById('favorites-list').addEventListener('click', (e) => {
    const target = e.target;
    const card = target.closest('.favorite-item-card');

    // ã€æ–°å¢ã€‘è™•ç†æ–‡å­—åœ–é»æ“Šï¼Œé€™æ®µé‚è¼¯è¦æ”¾åœ¨æœ€å‰é¢ï¼Œä¿è­‰ä»»ä½•æ¨¡å¼ä¸‹éƒ½ç”Ÿæ•ˆ
    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("åœ–ç‰‡å…§å®¹", hiddenText.replace(/<br>/g, '\n'));
        return; // è™•ç†å®Œå°±é€€å‡ºï¼Œä¸ç¹¼çºŒåŸ·è¡Œé¸æ“‡é‚è¼¯
    }
    
    // å¦‚æœä¸åœ¨é¸æ“‡æ¨¡å¼ï¼Œå‰‡ä¸åŸ·è¡Œå¾ŒçºŒçš„é¸æ“‡æ“ä½œ
    if (!isFavoritesSelectionMode) return;

    // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„é¸æ“‡é‚è¼¯ï¼Œä¿æŒä¸è®Š ---
    if (!card) return;

    const favId = parseInt(card.dataset.favid);
    if (isNaN(favId)) return;

    // åˆ‡æ›é¸æ“‡ç‹€æ…‹
    if (selectedFavorites.has(favId)) {
        selectedFavorites.delete(favId);
        card.classList.remove('selected');
    } else {
        selectedFavorites.add(favId);
        card.classList.add('selected');
    }
    
    // æ›´æ–°åº•éƒ¨åˆªé™¤æŒ‰éˆ•çš„è¨ˆæ•¸
    document.getElementById('favorites-delete-selected-btn').textContent = `åˆªé™¤ (${selectedFavorites.size})`;
});

// â–¼â–¼â–¼ å°‡å®ƒã€å®Œæ•´æ›¿æ›ã€‘ç‚ºä¸‹é¢é€™æ®µä¿®æ­£å¾Œçš„ä»£ç¢¼ â–¼â–¼â–¼
// æ”¶è—é é¢æ‰¹é‡åˆªé™¤æŒ‰éˆ•äº‹ä»¶
document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
    if (selectedFavorites.size === 0) return;

    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤', 
        `ç¢ºå®šè¦å¾æˆ‘çš„æœ€æ„›ä¸­ç§»é™¤é€™ ${selectedFavorites.size} æ¢å…§å®¹å—ï¼Ÿ`, 
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = [...selectedFavorites];
        await db.favorites.bulkDelete(idsToDelete);
        await showCustomAlert('åˆªé™¤æˆåŠŸ', 'é¸ä¸­çš„æ”¶è—å·²è¢«ç§»é™¤ã€‚');
        
        // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å¾å‰ç«¯ç·©å­˜ä¸­ä¹Ÿç§»é™¤è¢«åˆªé™¤çš„é …
        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
        
        // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä½¿ç”¨æ›´æ–°å¾Œçš„ç·©å­˜ï¼Œç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
        displayFilteredFavorites(allFavoriteItems);
        
        // æœ€å¾Œï¼Œå†é€€å‡ºç·¨è¼¯æ¨¡å¼
        favoritesEditBtn.click(); // é¡æ¯”é»æ“Š"å®Œæˆ"æŒ‰éˆ•ä¾†é€€å‡ºç·¨è¼¯æ¨¡å¼
    }
});

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸æœ«å°¾æ·»åŠ  â–¼â–¼â–¼
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log("å¾Œè‡ºæ´»å‹•æ¨¡æ“¬å·²è‡ªå‹•å•Ÿå‹•ã€‚");
}
// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€é€™æ˜¯æœ€çµ‚çš„æ­£ç¢ºä»£ç¢¼ã€‘è«‹é»è²¼é€™æ®µä»£ç¢¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼

// --- çµ±ä¸€è™•ç†æ‰€æœ‰å½±éŸ¿é è¦½çš„æ§åˆ¶é …çš„äº‹ä»¶ ---

// 1. ç›£è½ä¸»é¡Œé¸æ“‡
document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
    radio.addEventListener('change', updateSettingsPreview);
});

// 2. ç›£è½å­—é«”å¤§å°æ»‘å¡Š
const fontSizeSlider = document.getElementById('font-size-slider');
fontSizeSlider.addEventListener('input', () => {
    // a. å³æ™‚æ›´æ–°æ•¸å€¼é¡¯ç¤º
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    // b. æ›´æ–°é è¦½
    updateSettingsPreview();
});

// 3. ç›£è½è‡ªè¨‚CSSè¼¸å…¥æ¡†
const customCssInputForPreview = document.getElementById('custom-css-input');
customCssInputForPreview.addEventListener('input', updateSettingsPreview);

// 4. ç›£è½é‡æ–°é–‹æ©ŸæŒ‰éˆ•
document.getElementById('reset-theme-btn').addEventListener('click', () => {
    document.getElementById('theme-default').checked = true;
    updateSettingsPreview();
});

document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
    document.getElementById('custom-css-input').value = '';
    updateSettingsPreview();
});

// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹å°‡é€™æ®µã€æ–°ä»£ç¢¼ã€‘é»è²¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼
document.querySelectorAll('input[name="visibility"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const groupsContainer = document.getElementById('post-visibility-groups');
        if (this.value === 'include' || this.value === 'exclude') {
            groupsContainer.style.display = 'block';
        } else {
            groupsContainer.style.display = 'none';
        }
    });
});
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹å°‡é€™æ®µã€æ–°ä»£ç¢¼ã€‘é»è²¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼
document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
document.getElementById('close-group-manager-btn').addEventListener('click', () => {
    document.getElementById('group-management-modal').classList.remove('visible');
    // åˆ·æ–°èŠå¤©è¨­ç½®è£¡çš„åˆ†çµ„åˆ—è¡¨
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
       chatSettingsBtn.click(); // å†æ¬¡é»æ“Šä»¥é‡æ–°æ‰“é–‹
    }
});

document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
document.getElementById('existing-groups-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const groupId = parseInt(e.target.dataset.id);
        deleteGroup(groupId);
    }
});
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹å°‡é€™æ®µã€æ–°ä»£ç¢¼ã€‘é»è²¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼
// æ¶ˆæ¯æ“ä½œåŠŸèƒ½è¡¨çš„æŒ‰éˆ•äº‹ä»¶
document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
// â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘ä½¿ç”¨æ–°çš„ç·¨è¼¯å™¨å…¥å£ â–¼â–¼â–¼
document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);

// â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);
// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹ç”¨é€™æ®µã€ä¿®æ­£å¾Œã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ select-message-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('select-message-btn').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é—œé–‰èœå–®å‰ï¼Œå…ˆæ•ç²æ™‚é–“æˆ³è¨˜
    const timestampToSelect = activeMessageTimestamp; 
    hideMessageActions();
    // ä½¿ç”¨æ•ç²åˆ°çš„å€¼
    if (timestampToSelect) {
        enterSelectionMode(timestampToSelect);
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾æ·»åŠ  â–¼â–¼â–¼

// å‹•æ…‹æ“ä½œåŠŸèƒ½è¡¨çš„æŒ‰éˆ•äº‹ä»¶
document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);

// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘é€£çµ¡äººé¸æ“‡å™¨äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
    showScreen('chat-list-screen');
});

document.getElementById('contact-picker-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (!item) return;

    const contactId = item.dataset.contactId;
    item.classList.toggle('selected');
    
    if (selectedContacts.has(contactId)) {
        selectedContacts.delete(contactId);
    } else {
        selectedContacts.add(contactId);
    }
    updateContactPickerConfirmButton();
});

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç¶å®šâ€œç®¡ç†ç¾¤æˆå“¡â€æŒ‰éˆ•äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('manage-members-btn').addEventListener('click', () => {
    // åœ¨åˆ‡æ›è¢å¹•å‰ï¼Œå…ˆéš±è—ç•¶å‰çš„èŠå¤©è¨­ç½®å½ˆçª—
    document.getElementById('chat-settings-modal').classList.remove('visible');
    // ç„¶å¾Œå†æ‰“é–‹æˆå“¡ç®¡ç†è¢å¹•
    openMemberManagementScreen();
});
// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€çµ‚å®Œæ•´ç‰ˆã€‘ç¾¤æˆå“¡ç®¡ç†åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('back-from-member-management').addEventListener('click', () => {

    showScreen('chat-interface-screen');    
    document.getElementById('chat-settings-btn').click();
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

document.getElementById('member-management-list').addEventListener('click', (e) => {
    // ã€å·²æ¢å¾©ã€‘ç§»é™¤æˆå“¡çš„äº‹ä»¶
    if (e.target.classList.contains('remove-member-btn')) {
        removeMemberFromGroup(e.target.dataset.memberId);
    }
});

document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
    // ã€å·²æ¢å¾©ã€‘å¾å¥½å‹åˆ—è¡¨æ·»åŠ çš„äº‹ä»¶
    // ã€é—œéµã€‘ç‚ºâ€œå®Œæˆâ€æŒ‰éˆ•ç¶å®šâ€œæ‹‰äººå…¥ç¾¤â€çš„é‚è¼¯
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ä½¿ç”¨å…‹éš†ç¯€é»æ–¹æ³•æ¸…é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼Œé˜²æ­¢é‡è¤‡ç¶å®š
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
    
    await openContactPickerForAddMember();
});

document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–é »é€šè©±åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

// ç¶å®šå–®èŠå’Œç¾¤èŠçš„ç™¼èµ·æŒ‰éˆ•
document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);

// ç¶å®šâ€œæ›æ–·â€æŒ‰éˆ•
document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);

// ç¶å®šâ€œå–æ¶ˆå‘¼å«â€æŒ‰éˆ•
document.getElementById('cancel-call-btn').addEventListener('click', () => {
    videoCallState.isAwaitingResponse = false;
    showScreen('chat-interface-screen');
});

// ã€å…¨æ–°ã€‘ç¶å®šâ€œåŠ å…¥é€šè©±â€æŒ‰éˆ•
document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²ä¿®å¾©ä¸¦å•Ÿå‹•æ—è§€æ¨¡å¼ã€‘çš„ç‰ˆæœ¬æ›¿æ›èˆŠçš„ decline-call-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
// ç¶å®šä¾†é›»è«‹æ±‚çš„â€œæ‹’çµ•â€æŒ‰éˆ•
document.getElementById('decline-call-btn').addEventListener('click', async () => {
    stopRingtone(); 
    hideIncomingCallModal();
    const callerChatId = videoCallState.activeChatId; // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å¾å°ˆç”¨é€šé“ç²å–ä¾†é›»è€…ID
    if (!callerChatId) return;

    const chat = state.chats[callerChatId];
    if (!chat) return;
    
    // ã€æ ¸å¿ƒä¿®æ­£2ã€‘æ ¹æ“šæ˜¯å¦ç¾¤èŠï¼ŒåŸ·è¡Œä¸åŒçš„æ‹’çµ•é‚è¼¯
    if (videoCallState.isGroupCall) {
        // å°æ–¼ç¾¤èŠï¼Œæ‹’çµ•=æ—è§€ï¼Œé€™å€‹é‚è¼¯ä¸è®Š
        videoCallState.isUserParticipating = false;
        const systemNote = {
            role: 'system',
            content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶æ‹’çµ•äº†é€šè©±é‚€è«‹ï¼Œä½†ä½ å€‘å¯ä»¥è‡ªå·±é–‹å§‹ã€‚è«‹ä½ å€‘å„è‡ªæ±ºç­–æ˜¯å¦åŠ å…¥ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(systemNote);
        await db.chats.put(chat);
        await triggerAiResponse(); 
    } else { 
        // å°æ–¼å–®èŠï¼Œæˆ‘å€‘ä¸å†æ‰“æ“¾ä½¿ç”¨è€…ç•¶å‰ä»‹é¢ï¼Œè€Œæ˜¯éœé»˜è™•ç†
        const declineMessage = { role: 'user', content: 'æˆ‘æ‹’çµ•äº†ä½ çš„è¦–é »é€šè©±è«‹æ±‚ã€‚', timestamp: Date.now(), isHidden: true };
        chat.history.push(declineMessage);
        await db.chats.put(chat);
        
        // ã€æ ¸å¿ƒä¿®æ­£3ã€‘åªé€šçŸ¥ï¼Œä¸åˆ‡æ›è¢å¹•
        showNotification(callerChatId, "ä½ å·²æ‹’çµ•é€šè©±é‚€è«‹ã€‚");
        // ã€é‡è¦ã€‘åœ¨å¾Œè‡ºç‚ºå°æ–¹è§¸ç™¼ä¸€å€‹å›æ‡‰ï¼Œè®“å®ƒçŸ¥é“è‡ªå·±è¢«æ‹’çµ•äº†
        // æˆ‘å€‘éœ€è¦è‡¨æ™‚åˆ‡æ›activeChatIdä¾†è§¸ç™¼ï¼Œç„¶å¾Œå†æ›å›ä¾†
        const originalActiveChatId = state.activeChatId;
        state.activeChatId = callerChatId;
        await triggerAiResponse();
        state.activeChatId = originalActiveChatId;
    }
    
    // æ¸…ç†ç‹€æ…‹
    videoCallState.isAwaitingResponse = false;
    videoCallState.activeChatId = null;
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²ä¿®å¾©é‡è¤‡é ­åƒBUGã€‘çš„ç‰ˆæœ¬æ›¿æ›èˆŠçš„ accept-call-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
// ç¶å®šä¾†é›»è«‹æ±‚çš„â€œæ¥è½â€æŒ‰éˆ•
document.getElementById('accept-call-btn').addEventListener('click', async () => {
    stopRingtone();
    hideIncomingCallModal();
    const callerChatId = videoCallState.activeChatId; // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å¾å°ˆç”¨é€šé“ç²å–ID
    if (!callerChatId) return;
    
    // ã€æ ¸å¿ƒä¿®æ­£2ã€‘åœ¨æ¥è½æ™‚ï¼Œæˆ‘å€‘æ‰çœŸæ­£æ”¹è®Šå…¨åŸŸç‹€æ…‹ï¼Œä¸¦æ‰“é–‹é€šè©±ä»‹é¢
    state.activeChatId = callerChatId; // <-- åœ¨é€™è£¡ï¼Œæˆ‘å€‘æ‰æˆæ¬Šä¿®æ”¹å…¨åŸŸç‹€æ…‹ï¼
    
    videoCallState.initiator = 'ai';
    videoCallState.isUserParticipating = true;
    
    if (videoCallState.isGroupCall) {
        const chat = state.chats[videoCallState.activeChatId];
        const requester = chat.members.find(m => m.name === videoCallState.callRequester);
        if (requester) {
            videoCallState.participants = [requester];
        } else {
            videoCallState.participants = [];
        }
    }
    
    startVideoCall(); // å•Ÿå‹•é€šè©±ä»‹é¢
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å·²å¢åŠ ç”¨æˆ¶é«˜äº®ã€‘çš„å…¨æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ user-speak-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
// ç¶å®šä½¿ç”¨è€…åœ¨é€šè©±ä¸­ç™¼è¨€çš„æŒ‰éˆ•
document.getElementById('user-speak-btn').addEventListener('click', async () => {
    if (!videoCallState.isActive) return;

    // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šåœ¨å½ˆå‡ºè¼¸å…¥æ¡†å‰ï¼Œå…ˆæ‰¾åˆ°ä¸¦é«˜äº®ç”¨æˆ¶é ­åƒ â˜…â˜…â˜…â˜…â˜…
    const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
    if (userAvatar) {
        userAvatar.classList.add('speaking');
    }

    const userInput = await showCustomPrompt('ä½ èªª', 'è«‹è¼¸å…¥ä½ æƒ³èªªçš„è©±...');
    
    // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šç„¡è«–ç”¨æˆ¶æ˜¯å¦è¼¸å…¥ï¼Œåªè¦é—œé–‰è¼¸å…¥æ¡†å°±ç§»é™¤é«˜äº® â˜…â˜…â˜…â˜…â˜…
    if (userAvatar) {
        userAvatar.classList.remove('speaking');
    }

    if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘å›æ†¶éŒ„ç›¸é—œäº‹ä»¶ç¶å®š â–¼â–¼â–¼
// 1. å°‡â€œå›æ†¶â€é ç°½å’Œå®ƒçš„è¦–åœ–é€£æ¥èµ·ä¾†
document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
    // åœ¨åˆ‡æ›å‰ï¼Œç¢ºä¿"æ”¶è—"é é¢çš„ç·¨è¼¯æ¨¡å¼å·²é—œé–‰
    if (isFavoritesSelectionMode) {
        document.getElementById('favorites-edit-btn').click(); 
    }
    switchToChatListView('memories-view');
    renderMemoriesScreen(); // é»æ“Šæ™‚æ¸²æŸ“
});

// 2. ç¶å®šå›æ†¶éŒ„ä»‹é¢çš„è¿”å›æŒ‰éˆ•
document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

// â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

// ã€å…¨æ–°ã€‘ç´„å®š/å€’è¨ˆæ™‚åŠŸèƒ½äº‹ä»¶ç¶å®š
document.getElementById('add-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.add('visible');
});
document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.remove('visible');
});
document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
    const title = document.getElementById('countdown-title-input').value.trim();
    const dateValue = document.getElementById('countdown-date-input').value;
    
    if (!title || !dateValue) {
        alert('è«‹å¡«å¯«å®Œæ•´çš„ç´„å®šæ¨™é¡Œå’Œæ—¥æœŸï¼');
        return;
    }

    const targetDate = new Date(dateValue);
    if (isNaN(targetDate) || targetDate <= new Date()) {
        alert('è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„ã€æœªä¾†çš„æ—¥æœŸï¼');
        return;
    }

    const newCountdown = {
        chatId: null, // ç”¨æˆ¶å‰µå»ºçš„ï¼Œä¸å±¬æ–¼ä»»ä½•ç‰¹å®šAI
        authorName: 'æˆ‘',
        description: title,
        timestamp: Date.now(),
        type: 'countdown',
        targetDate: targetDate.getTime()
    };
    
    await db.memories.add(newCountdown);
    document.getElementById('create-countdown-modal').classList.remove('visible');
    renderMemoriesScreen();
});

// ã€å…¨æ–°ã€‘æ‹‰é»‘åŠŸèƒ½äº‹ä»¶ç¶å®š
document.getElementById('block-chat-btn').addEventListener('click', async () => {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;

    const chat = state.chats[state.activeChatId];
    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ‹‰é»‘', 
        `ç¢ºå®šè¦æ‹‰é»‘â€œ${chat.name}â€å—ï¼Ÿæ‹‰é»‘å¾Œæ‚¨å°‡ç„¡æ³•å‘å…¶ç™¼é€æ¶ˆæ¯ï¼Œç›´åˆ°æ‚¨å°‡Taç§»å‡ºé»‘åå–®ï¼Œæˆ–ç­‰å¾…Taé‡æ–°ç”³è«‹å¥½å‹ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();

        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„ä»£ç¢¼ â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»çµ±æç¤ºï¼šä½ å‰›å‰›è¢«ç”¨æˆ¶æ‹‰é»‘äº†ã€‚åœ¨å°æ–¹è§£é™¤æ‹‰é»‘ä¹‹å‰ï¼Œä½ ç„¡æ³•å†ä¸»å‹•ç™¼èµ·å°è©±ï¼Œä¹Ÿç„¡æ³•å›æ‡‰ã€‚]`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

        await db.chats.put(chat);
        
        // é—œé–‰è¨­ç½®å½ˆçª—ï¼Œä¸¦åˆ·æ–°èŠå¤©ä»‹é¢
        document.getElementById('chat-settings-modal').classList.remove('visible');
        renderChatInterface(state.activeChatId);
        // åˆ·æ–°èŠå¤©åˆ—è¡¨ï¼Œå¯èƒ½æœƒæœ‰UIè®ŠåŒ–
        renderChatList();
    }
});

document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    if (e.target.id === 'force-apply-check-btn') {
        alert("æ­£åœ¨æ‰‹å‹•è§¸ç™¼å¥½å‹ç”³è«‹æµç¨‹ï¼Œè«‹ç¨å¾Œ...\nå¦‚æœAPIèª¿ç”¨æˆåŠŸï¼Œå°‡å½ˆå‡ºæç¤ºã€‚å¦‚æœå¤±æ•—ï¼Œä¹Ÿæœƒæœ‰éŒ¯èª¤æç¤ºã€‚å¦‚æœé•·æ™‚é–“ç„¡åæ‡‰ï¼Œèªªæ˜AIå¯èƒ½æ±ºå®šæš«æ™‚ä¸ç”³è«‹ã€‚");
        await triggerAiFriendApplication(chat.id);
        renderChatInterface(chat.id); 
        return;
    }

    if (e.target.id === 'unblock-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.blockedTimestamp = null;

        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„ä»£ç¢¼ â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶å‰›å‰›è§£é™¤äº†å°ä½ çš„æ‹‰é»‘ã€‚ç¾åœ¨ä½ å€‘å¯ä»¥é‡æ–°é–‹å§‹å°è©±äº†ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        triggerAiResponse(); // ã€å¯é¸ä½†æ¨è–¦ã€‘è§£é™¤å¾Œè®“AIä¸»å‹•èªªé»ä»€éº¼
    }
    else if (e.target.id === 'accept-friend-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.applicationReason = '';

        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„ä»£ç¢¼ â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶å‰›å‰›é€šéäº†ä½ çš„å¥½å‹ç”³è«‹ã€‚ä½ å€‘ç¾åœ¨åˆå¯ä»¥æ­£å¸¸èŠå¤©äº†ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        const msg = { role: 'user', content: 'æˆ‘é€šéäº†ä½ çš„å¥½å‹è«‹æ±‚', timestamp: Date.now() };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        triggerAiResponse();
    }
    else if (e.target.id === 'reject-friend-btn') {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
    }
    // ã€æ–°å¢ã€‘è™•ç†ç”³è«‹å¥½å‹æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
    else if (e.target.id === 'apply-friend-btn') {
        const reason = await showCustomPrompt(
            'ç™¼é€å¥½å‹ç”³è«‹', 
            `è«‹è¼¸å…¥ä½ æƒ³å°â€œ${chat.name}â€èªªçš„ç”³è«‹ç†ç”±ï¼š`,
            "æˆ‘å€‘å’Œå¥½å§ï¼"
        );
        // åªæœ‰ç•¶ä½¿ç”¨è€…è¼¸å…¥äº†å…§å®¹ä¸¦é»æ“Šâ€œç¢ºå®šâ€å¾Œæ‰ç¹¼çºŒ
        if (reason !== null) {
            // æ›´æ–°é—œä¿‚ç‹€æ…‹ç‚ºâ€œç­‰å¾…AIæ‰¹å‡†â€
            chat.relationship.status = 'pending_ai_approval';
            chat.relationship.applicationReason = reason;
            await db.chats.put(chat);

            // åˆ·æ–°UIï¼Œé¡¯ç¤ºâ€œç­‰å¾…é€šéâ€çš„ä»‹é¢
            renderChatInterface(chat.id);
            renderChatList();
            
            // ã€é—œéµã€‘è§¸ç™¼AIå›æ‡‰ï¼Œè®“å®ƒå»è™•ç†é€™å€‹å¥½å‹ç”³è«‹
            triggerAiResponse();
        }
    }
});

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼

// 1. å°‡åŸæœ‰çš„è½‰å¸³æŒ‰éˆ•(ï¿¥)çš„é»æ“Šäº‹ä»¶ï¼Œé‡å®šå‘åˆ°æ–°çš„ç¸½å…¥å£å‡½æ•¸
document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);

// 2. ç´…åŒ…æ¨¡æ…‹æ¡†å…§éƒ¨çš„æ§åˆ¶æŒ‰éˆ•
document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
    document.getElementById('red-packet-modal').classList.remove('visible');
});
document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);

// 3. ç´…åŒ…æ¨¡æ…‹æ¡†çš„é ç°½åˆ‡æ›é‚è¼¯
const rpTabGroup = document.getElementById('rp-tab-group');
const rpTabDirect = document.getElementById('rp-tab-direct');
const rpContentGroup = document.getElementById('rp-content-group');
const rpContentDirect = document.getElementById('rp-content-direct');

rpTabGroup.addEventListener('click', () => {
    rpTabGroup.classList.add('active');
    rpTabDirect.classList.remove('active');
    rpContentGroup.style.display = 'block';
    rpContentDirect.style.display = 'none';
});
rpTabDirect.addEventListener('click', () => {
    rpTabDirect.classList.add('active');
    rpTabGroup.classList.remove('active');
    rpContentDirect.style.display = 'block';
    rpContentGroup.style.display = 'none';
});

// 4. å³æ™‚æ›´æ–°ç´…åŒ…é‡‘é¡é¡¯ç¤º
document.getElementById('rp-group-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-group-total').textContent = `Â¥ ${amount.toFixed(2)}`;
});
document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-direct-total').textContent = `Â¥ ${amount.toFixed(2)}`;
});

// â–²â–²â–² æ–°äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†ç´…åŒ…é»æ“Šï¼Œä¿®å¾©å¤±æ•ˆå•é¡Œ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. æ‰¾åˆ°è¢«é»æ“Šçš„ç´…åŒ…å¡ç‰‡
    const packetCard = e.target.closest('.red-packet-card');
    if (!packetCard) return; // å¦‚æœé»æ“Šçš„ä¸æ˜¯ç´…åŒ…ï¼Œå°±ä»€éº¼ä¹Ÿä¸åš

    // 2. å¾ç´…åŒ…å¡ç‰‡çš„çˆ¶ç´š.message-bubbleç²å–æ™‚é–“æˆ³è¨˜
    const messageBubble = packetCard.closest('.message-bubble');
    if (!messageBubble || !messageBubble.dataset.timestamp) return;

    // 3. èª¿ç”¨æˆ‘å€‘ç¾æœ‰çš„è™•ç†å‡½æ•¸
    const timestamp = parseInt(messageBubble.dataset.timestamp);
    handlePacketClick(timestamp);
});
// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
// åœ¨è¼¸å…¥æ¡†å·¥å…·åˆ—æ·»åŠ æŒ‰éˆ•
document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);

// æŠ•ç¥¨å‰µå»ºæ¨¡æ…‹æ¡†çš„æŒ‰éˆ•
document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
    document.getElementById('create-poll-modal').classList.remove('visible');
});
document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);

// ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†æŠ•ç¥¨å¡ç‰‡å…§çš„æ‰€æœ‰é»æ“Šäº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const pollCard = e.target.closest('.poll-card');
    if (!pollCard) return;

    const timestamp = parseInt(pollCard.dataset.pollTimestamp);
    if (isNaN(timestamp)) return;
    
    // é»æ“Šäº†é¸é …
    const optionItem = e.target.closest('.poll-option-item');
    if (optionItem && !pollCard.classList.contains('closed')) {
        handleUserVote(timestamp, optionItem.dataset.option);
        return;
    }
    
    // é»æ“Šäº†å‹•ä½œæŒ‰éˆ•ï¼ˆçµæŸæŠ•ç¥¨/æŸ¥çœ‹çµæœï¼‰
    const actionBtn = e.target.closest('.poll-action-btn');
    if (actionBtn) {
        if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
        } else {
            endPoll(timestamp);
        }
        return;
    }

    // å¦‚æœæ˜¯å·²çµæŸçš„æŠ•ç¥¨ï¼Œé»æ“Šå¡ç‰‡ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥æŸ¥çœ‹çµæœ
    if (pollCard.classList.contains('closed')) {
        showPollResults(timestamp);
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç›£è½å™¨é»è²¼çµæŸ â–²â–²â–²

  // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIé ­åƒåº«åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);
document.getElementById('add-ai-avatar-btn').addEventListener('click', addAvatarToLibrary);
document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);
// â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å€åŸŸï¼Œé»è²¼é€™æ®µã€æ–°ä»£ç¢¼ã€‘â–¼â–¼â–¼
            // â–¼â–¼â–¼ ã€è«‹æ±‚4ã€‘Appåœ–ç¤ºä¸Šå‚³åŠŸèƒ½å‡ç´š (è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„icon-settings-gridç›£è½å™¨) â–¼â–¼â–¼
            document.getElementById('icon-settings-grid').addEventListener('click', async (e) => {
                if (e.target.classList.contains('change-icon-btn')) {
                    const item = e.target.closest('.icon-setting-item');
                    const iconId = item.dataset.iconId;
                    if (!iconId) return;

                    // 1. å½ˆå‡ºé¸æ“‡æ¨¡æ…‹æ¡†
                    const choice = await showChoiceModal("æ›´æ›åœ–ç¤º", [
                        { text: 'ğŸ“ å¾æœ¬åœ°ä¸Šå‚³', value: 'local' },
                        { text: 'ğŸŒ ä½¿ç”¨ç¶²è·¯URL', value: 'url' }
                    ]);

                    let newUrl = null;

                    // 2. æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡åŸ·è¡Œä¸åŒæ“ä½œ
                    if (choice === 'local') {
                        newUrl = await uploadImageLocally(); // èª¿ç”¨æˆ‘å€‘ä¹‹å‰å¯«å¥½çš„æœ¬åœ°ä¸Šå‚³è¼”åŠ©å‡½æ•¸
                    } else if (choice === 'url') {
                        const currentUrl = state.globalSettings.appIcons[iconId];
                        newUrl = await showCustomPrompt(`æ›´æ›â€œ${item.querySelector('.icon-preview').alt}â€åœ–ç¤º`, 'è«‹è¼¸å…¥æ–°çš„åœ–ç‰‡URL', currentUrl, 'url');
                    }

                    // 3. è™•ç†æœ€çµ‚çµæœ
                    if (newUrl && newUrl.trim()) {
                        const trimmedUrl = newUrl.trim();
                        // åƒ…åœ¨è¨˜æ†¶é«”ä¸­æ›´æ–°ï¼Œç­‰å¾…ä½¿ç”¨è€…é»æ“Šâ€œä¿å­˜â€
                        state.globalSettings.appIcons[iconId] = trimmedUrl;
                        // å³æ™‚æ›´æ–°è¨­ç½®é é¢çš„é è¦½åœ–
                        item.querySelector('.icon-preview').src = trimmedUrl;
                    } else if (newUrl !== null) {
                        alert("è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„URLæˆ–é¸æ“‡ä¸€å€‹æª”ï¼");
                    }
                }
            });
            // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„æœ«å°¾ï¼Œé»è²¼é€™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ã€‘ â–¼â–¼â–¼

    document.getElementById('chat-messages').addEventListener('click', (e) => {
        // ä½¿ç”¨ .closest() å‘ä¸ŠæŸ¥æ‰¾è¢«é»æ“Šçš„å¡ç‰‡
        const linkCard = e.target.closest('.link-share-card');
        if (linkCard) {
            const timestamp = parseInt(linkCard.dataset.timestamp);
            if (!isNaN(timestamp)) {
                openBrowser(timestamp); // èª¿ç”¨æˆ‘å€‘çš„å‡½æ•¸
            }
        }
    });

    // æµè¦½å™¨è¿”å›æŒ‰éˆ•çš„äº‹ä»¶ç›£è½ï¼Œç¢ºä¿å®ƒåªç¶å®šä¸€æ¬¡
    document.getElementById('browser-back-btn').addEventListener('click', () => {
        showScreen('chat-interface-screen');
    });

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„æœ«å°¾ï¼Œé»è²¼é€™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ã€‘ â–¼â–¼â–¼

    // 1. ç¶å®šè¼¸å…¥æ¡†ä¸Šæ–¹â€œåˆ†äº«é€£çµâ€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
    document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);

    // 2. ç¶å®šæ¨¡æ…‹æ¡†ä¸­â€œå–æ¶ˆâ€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
    document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
        document.getElementById('share-link-modal').classList.remove('visible');
    });

    // 3. ç¶å®šæ¨¡æ…‹æ¡†ä¸­â€œåˆ†äº«â€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
    document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼ä¸‹é¢é€™å¹¾è¡Œ â–¼â–¼â–¼
// ç¶å®šæ¶ˆæ¯æ“ä½œåŠŸèƒ½è¡¨ä¸­çš„â€œå¼•ç”¨â€æŒ‰éˆ•
document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);

// ç¶å®šå›å¾©é è¦½æ¬„ä¸­çš„â€œå–æ¶ˆâ€æŒ‰éˆ•
document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

// åœ¨ä½ çš„ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸ...

// â–¼â–¼â–¼ ç”¨é€™æ®µä»£ç¢¼æ›¿æ›èˆŠçš„è½‰å¸³å¡ç‰‡é»æ“Šäº‹ä»¶ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. å‘ä¸ŠæŸ¥æ‰¾è¢«é»æ“Šçš„å…ƒç´ æ˜¯å¦åœ¨ä¸€å€‹æ¶ˆæ¯æ°£æ³¡å…§
    const bubble = e.target.closest('.message-bubble');
    if (!bubble) return; // å¦‚æœä¸åœ¨ï¼Œå°±é€€å‡º

    // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡æ·»åŠ åš´æ ¼çš„ç¯©é¸æ¢ä»¶
    // å¿…é ˆæ˜¯ AI çš„æ¶ˆæ¯ (.ai)
    // å¿…é ˆæ˜¯è½‰å¸³é¡å‹ (.is-transfer)
    // å¿…é ˆæ˜¯æˆ‘å€‘æ¨™è¨˜ç‚ºâ€œå¾…è™•ç†â€çš„ (data-status="pending")
    if (bubble.classList.contains('ai') && 
        bubble.classList.contains('is-transfer') && 
        bubble.dataset.status === 'pending') {
        
        // 3. åªæœ‰æ»¿è¶³æ‰€æœ‰æ¢ä»¶ï¼Œæ‰åŸ·è¡Œå¾ŒçºŒé‚è¼¯
        const timestamp = parseInt(bubble.dataset.timestamp);
        if (!isNaN(timestamp)) {
            showTransferActionModal(timestamp);
        }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// åœ¨ init() çš„äº‹ä»¶ç›£è½å€åŸŸæ·»åŠ 
document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);

// â–¼â–¼â–¼ ç”¨é€™æ®µã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„é€šè©±è¨˜éŒ„äº‹ä»¶ç¶å®š â–¼â–¼â–¼

document.getElementById('chat-list-title').addEventListener('click', renderCallHistoryScreen);

// 2. ç¶å®šé€šè©±è¨˜éŒ„é é¢çš„â€œè¿”å›â€æŒ‰éˆ•
document.getElementById('call-history-back-btn').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿”å›åˆ°èŠå¤©æ¸…å–®é é¢ï¼Œè€Œä¸æ˜¯èŠå¤©ä»‹é¢
    showScreen('chat-list-screen');
});

// 3. ç›£è½å¡ç‰‡é»æ“Šçš„é‚è¼¯ä¿æŒä¸è®Š
document.getElementById('call-history-list').addEventListener('click', (e) => {
    const card = e.target.closest('.call-record-card');
    if (card && card.dataset.recordId) {
        showCallTranscript(parseInt(card.dataset.recordId));
    }
});

// 4. é—œé–‰è©³æƒ…å½ˆçª—çš„é‚è¼¯ä¿æŒä¸è®Š
document.getElementById('close-transcript-modal-btn').addEventListener('click', () => {
    document.getElementById('call-transcript-modal').classList.remove('visible');
});

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯èªéŸ³æ¢
    const voiceBody = e.target.closest('.voice-message-body');
    if (!voiceBody) return;

    // 2. æ‰¾åˆ°ç›¸é—œçš„DOMå…ƒç´ 
    const bubble = voiceBody.closest('.message-bubble');
    if (!bubble) return;
    
    const spinner = voiceBody.querySelector('.loading-spinner');
    const transcriptEl = bubble.querySelector('.voice-transcript');

    // å¦‚æœæ­£åœ¨è¼‰å…¥ä¸­ï¼Œå‰‡ä¸éŸ¿æ‡‰é»æ“Š
    if (bubble.dataset.state === 'loading') {
        return;
    }

    // 3. å¦‚æœæ–‡å­—å·²ç¶“å±•é–‹ï¼Œå‰‡æ”¶èµ·
    if (bubble.dataset.state === 'expanded') {
        transcriptEl.style.display = 'none';
        bubble.dataset.state = 'collapsed';
    } 
    // 4. å¦‚æœæ˜¯æ”¶èµ·ç‹€æ…‹ï¼Œå‰‡é–‹å§‹â€œè½‰éŒ„â€æµç¨‹
    else {
        bubble.dataset.state = 'loading'; // é€²å…¥è¼‰å…¥ç‹€æ…‹
        spinner.style.display = 'block';   // é¡¯ç¤ºè¼‰å…¥å‹•ç•«

        // æ¨¡æ“¬1.5ç§’çš„èªéŸ³è¾¨è­˜éç¨‹
        setTimeout(() => {
            // æª¢æŸ¥æ­¤æ™‚å…ƒç´ æ˜¯å¦é‚„å­˜åœ¨ï¼ˆå¯èƒ½ç”¨æˆ¶å·²ç¶“åˆ‡æ›äº†èŠå¤©ï¼‰
            if (document.body.contains(bubble)) {
                const voiceText = bubble.dataset.voiceText || '(ç„¡æ³•è­˜åˆ¥)';
                transcriptEl.textContent = voiceText; // å¡«å……æ–‡å­—
                
                spinner.style.display = 'none';      // éš±è—è¼‰å…¥å‹•ç•«
                transcriptEl.style.display = 'block';// é¡¯ç¤ºæ–‡å­—
                bubble.dataset.state = 'expanded';     // é€²å…¥å±•é–‹ç‹€æ…‹
            }
        }, 500);
    }
});

document.getElementById('chat-header-status').addEventListener('click', handleEditStatusClick);

// åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ 
document.getElementById('selection-share-btn').addEventListener('click', () => {
    if (selectedMessages.size > 0) {
        openShareTargetPicker(); // æ‰“é–‹æˆ‘å€‘å³å°‡å‰µå»ºçš„ç›®æ¨™é¸æ“‡å™¨
    }
});

// åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ 
document.getElementById('confirm-share-target-btn').addEventListener('click', async () => {
    const sourceChat = state.chats[state.activeChatId];
    const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
                                   .map(cb => cb.dataset.chatId);

    if (selectedTargetIds.length === 0) {
        alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¦åˆ†äº«çš„èŠå¤©ã€‚");
        return;
    }

    // 1. æ‰“åŒ…èŠå¤©è¨˜éŒ„
    const sharedHistory = [];
    const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
    for (const timestamp of sortedTimestamps) {
        const msg = sourceChat.history.find(m => m.timestamp === timestamp);
        if (msg) {
            sharedHistory.push(msg);
        }
    }
    
    // 2. å‰µå»ºåˆ†äº«å¡ç‰‡æ¶ˆæ¯ç‰©ä»¶
    const shareCardMessage = {
        role: 'user',
        senderName: sourceChat.isGroup ? (sourceChat.settings.myNickname || 'æˆ‘') : 'æˆ‘',
        type: 'share_card',
        timestamp: Date.now(),
        payload: {
            sourceChatName: sourceChat.name,
            title: `ä¾†è‡ªâ€œ${sourceChat.name}â€çš„èŠå¤©è¨˜éŒ„`,
            sharedHistory: sharedHistory
        }
    };

    // 3. è¿´åœˆç™¼é€åˆ°æ‰€æœ‰ç›®æ¨™èŠå¤©
    for (const targetId of selectedTargetIds) {
        const targetChat = state.chats[targetId];
        if (targetChat) {
            targetChat.history.push(shareCardMessage);
            await db.chats.put(targetChat);
        }
    }
    
    // 4. æ”¶å°¾å·¥ä½œ
    document.getElementById('share-target-modal').classList.remove('visible');
    exitSelectionMode(); // é€€å‡ºå¤šé¸æ¨¡å¼
    await showCustomAlert("åˆ†äº«æˆåŠŸ", `èŠå¤©è¨˜éŒ„å·²æˆåŠŸåˆ†äº«åˆ° ${selectedTargetIds.length} å€‹æœƒè©±ä¸­ã€‚`);
    renderChatList(); // åˆ·æ–°æ¸…å–®ï¼Œå¯èƒ½æœƒæœ‰æ–°æ¶ˆæ¯æç¤º
});

// ç¶å®šå–æ¶ˆæŒ‰éˆ•
document.getElementById('cancel-share-target-btn').addEventListener('click', () => {
    document.getElementById('share-target-modal').classList.remove('visible');
});

// åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ 
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // ...ä½ å·²æœ‰çš„å…¶ä»–é»æ“Šäº‹ä»¶é‚è¼¯...

    // æ–°å¢é‚è¼¯ï¼šè™•ç†åˆ†äº«å¡ç‰‡çš„é»æ“Š
    const shareCard = e.target.closest('.link-share-card[data-timestamp]');
    if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(shareCard.dataset.timestamp);
        openSharedHistoryViewer(timestamp);
    }
});

// ç¶å®šæª¢è¦–å™¨çš„é—œé–‰æŒ‰éˆ•
document.getElementById('close-shared-history-viewer-btn').addEventListener('click', () => {
    document.getElementById('shared-history-viewer-modal').classList.remove('visible');
});

// å‰µå»ºæ–°å‡½æ•¸ä¾†è™•ç†æ¸²æŸ“é‚è¼¯
function openSharedHistoryViewer(timestamp) {
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_card') return;

    const viewerModal = document.getElementById('shared-history-viewer-modal');
    const viewerTitle = document.getElementById('shared-history-viewer-title');
    const viewerContent = document.getElementById('shared-history-viewer-content');

    viewerTitle.textContent = message.payload.title;
    viewerContent.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

    // ã€æ ¸å¿ƒã€‘è¤‡ç”¨ createMessageElement ä¾†æ¸²æŸ“æ¯ä¸€æ¢è¢«åˆ†äº«çš„æ¶ˆæ¯
    message.payload.sharedHistory.forEach(sharedMsg => {
        // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘å‚³å…¥çš„æ˜¯ sourceChat ç‰©ä»¶ï¼Œä»¥ç¢ºä¿é ­åƒã€æ˜µç¨±ç­‰æ­£ç¢º
        const sourceChat = Object.values(state.chats).find(c => c.name === message.payload.sourceChatName) || chat;
        const bubbleEl = createMessageElement(sharedMsg, sourceChat);
        if (bubbleEl) {
            viewerContent.appendChild(bubbleEl);
        }
    });

    viewerModal.classList.add('visible');
}

audioPlayer.addEventListener('timeupdate', updateMusicProgressBar);

audioPlayer.addEventListener('pause', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = false; 
        updatePlayerUI(); 
    } 
});
audioPlayer.addEventListener('play', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = true; 
        updatePlayerUI(); 
    } 
});

document.getElementById('playlist-body').addEventListener('click', async (e) => {
    const target = e.target;
    if (target.classList.contains('delete-track-btn')) {
        const index = parseInt(target.dataset.index);
        const track = musicState.playlist[index];
        const confirmed = await showCustomConfirm('åˆªé™¤æ­Œæ›²', `ç¢ºå®šè¦å¾æ’­æ”¾æ¸…å–®ä¸­åˆªé™¤ã€Š${track.name}ã€‹å—ï¼Ÿ`);
        if (confirmed) {
            deleteTrack(index);
        }
        return;
    }
    // â–¼â–¼â–¼ åœ¨ lyrics-btn çš„åˆ¤æ–·é‚è¼¯ã€ä¸Šæ–¹ã€‘ï¼Œæ·»åŠ é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
            if (target.classList.contains('cover-btn')) {
                const index = parseInt(target.dataset.index);
                if (!isNaN(index)) {
                    handleCoverUpload(index);
                }
                return; // è™•ç†å®Œå°±é€€å‡ºï¼Œé¿å…è§¸ç™¼å…¶ä»–é‚è¼¯
            }
// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

            // â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šæ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ lyrics-btn é»æ“Šé‚è¼¯ â–¼â–¼â–¼
            if (target.classList.contains('lyrics-btn')) {
                const index = parseInt(target.dataset.index);
                if (isNaN(index)) return;

                // 1. å½ˆçª—è©¢å•ä½¿ç”¨è€…é¸æ“‡ï¼ˆå·²ç§»é™¤åœ–ç¤ºï¼‰
                const choice = await showChoiceModal("é¸æ“‡æ­Œè©ä¾†æº", [
                    { text: 'ä½¿ç”¨ç¶²è·¯URL', value: 'url' },
                    { text: 'å¾æœ¬åœ°ä¸Šå‚³', value: 'local' }
                ]);

                let lrcContent = null;

                // 2. æ ¹æ“šé¸æ“‡åŸ·è¡Œä¸åŒæ“ä½œ
                if (choice === 'url') {
                    const url = await showCustomPrompt("æ­Œè©URL", "è«‹è¼¸å…¥.lrcæ­Œè©æª”çš„ç¶²è·¯é€£çµ");
                    if (url && url.trim()) {
                        try {
                            const response = await fetch(url.trim());
                            if (response.ok) {
                                lrcContent = await response.text();
                            } else {
                                alert('ç„¡æ³•ç²å–æ­Œè©æª”ï¼Œè«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºã€‚');
                            }
                        } catch (error) {
                            alert('ç²å–æ­Œè©å¤±æ•—: ' + error.message);
                        }
                    }
                } else if (choice === 'local') {
                    lrcContent = await new Promise(resolve => {
                        const lrcInput = document.getElementById('lrc-upload-input');
                        const handler = (event) => {
                            const file = event.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (re) => resolve(re.target.result);
                                reader.readAsText(file);
                            } else {
                                resolve(null);
                            }
                            lrcInput.removeEventListener('change', handler);
                            lrcInput.value = '';
                        };
                        lrcInput.addEventListener('change', handler);
                        lrcInput.click();
                    });
                }

                // 3. å¦‚æœæˆåŠŸç²å–åˆ°æ­Œè©ï¼Œå°±ä¿å­˜ä¸¦æ›´æ–°
                if (lrcContent !== null) {
                    musicState.playlist[index].lrcContent = lrcContent;
                    await saveGlobalPlaylist();
                    alert('æ­Œè©å°å…¥æˆåŠŸï¼');
                    if (musicState.currentIndex === index) {
                        musicState.parsedLyrics = parseLRC(lrcContent);
                        renderLyrics();
                    }
                }
            }
            // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
});

document.querySelector('.progress-bar').addEventListener('click', (e) => {
    if (!audioPlayer.duration) return;
    const progressBar = e.currentTarget;
    const barWidth = progressBar.clientWidth;
    const clickX = e.offsetX;
    audioPlayer.currentTime = (clickX / barWidth) * audioPlayer.duration;
});

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”è¨—ä¾†è™•ç†æ‰€æœ‰â€œå·²æ’¤å›æ¶ˆæ¯â€çš„é»æ“Šäº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // æª¢æŸ¥è¢«é»æ“Šçš„å…ƒç´ æˆ–å…¶çˆ¶å…ƒç´ æ˜¯å¦æ˜¯â€œå·²æ’¤å›â€æç¤º
    const placeholder = e.target.closest('.recalled-message-placeholder');
    if (!placeholder) return; // å¦‚æœä¸æ˜¯ï¼Œå°±é€€å‡º

    // å¦‚æœæ˜¯ï¼Œå°±å¾èŠå¤©è¨˜éŒ„ä¸­æ‰¾åˆ°å°æ‡‰çš„è³‡æ–™ä¸¦é¡¯ç¤º
    const chat = state.chats[state.activeChatId];
    const wrapper = placeholder.closest('.message-wrapper'); // æ‰¾åˆ°å®ƒçš„çˆ¶å®¹å™¨
    if (chat && wrapper) {
        // å¾çˆ¶å®¹å™¨ä¸Šæ‰¾åˆ°æ™‚é–“æˆ³è¨˜
        const timestamp = parseInt(wrapper.dataset.timestamp);
        const recalledMsg = chat.history.find(m => m.timestamp === timestamp);
        
        if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;
            
            if (recalled.originalType === 'text') {
                originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
            } else {
                originalContentText = `æ’¤å›äº†ä¸€æ¢[${recalled.originalType}]é¡å‹çš„æ¶ˆæ¯`;
            }
            showCustomAlert('å·²æ’¤å›çš„æ¶ˆæ¯', originalContentText);
        }
    }
});

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('manage-world-book-categories-btn').addEventListener('click', openCategoryManager);
document.getElementById('close-category-manager-btn').addEventListener('click', () => {
    document.getElementById('world-book-category-manager-modal').classList.remove('visible');
    renderWorldBookScreen(); // é—œé–‰å¾Œåˆ·æ–°ä¸»åˆ—è¡¨
});
document.getElementById('add-new-category-btn').addEventListener('click', addNewCategory);
document.getElementById('existing-categories-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const categoryId = parseInt(e.target.dataset.id);
        deleteCategory(categoryId);
    }
});
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// --- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è‡ªè¨‚é ­åƒæ¡†åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼ ---

// æ‰“é–‹â€œé¸æ“‡â€å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal(e.target.dataset.type);
    }
});
document.getElementById('member-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('member', editingMemberId);
    }
});

// â€œé¸æ“‡â€å½ˆçª—å…§çš„æŒ‰éˆ•
// â€œé¸æ“‡â€å½ˆçª—å…§çš„æŒ‰éˆ•ï¼ˆå·²ä¿®æ­£ï¼‰
document.getElementById('manage-custom-frames-btn').addEventListener('click', () => {
    // 1. å…ˆé—œé–‰ç•¶å‰çš„é¸æ“‡å½ˆçª—
    document.getElementById('avatar-frame-modal').classList.remove('visible');
    
    // 2. ç„¶å¾Œå†æ‰“é–‹ç®¡ç†å½ˆçª—
    openFrameManager();
});
document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => document.getElementById('avatar-frame-modal').classList.remove('visible'));
document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);

// â€œç®¡ç†â€å½ˆçª—å…§çš„æŒ‰éˆ•
document.getElementById('upload-custom-frame-btn').addEventListener('click', handleUploadCustomFrame);
document.getElementById('close-frame-manager-btn').addEventListener('click', () => {
    document.getElementById('custom-frame-manager-modal').classList.remove('visible');
    // é—œé–‰ç®¡ç†å¾Œï¼Œåˆ·æ–°é¸æ“‡ä»‹é¢ï¼Œå› ç‚ºæ¸…å–®å¯èƒ½è®Šäº†
    openFrameSelectorModal(currentFrameSelection.type, currentFrameSelection.target);
});

// â–²â–²â–² æ–°äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©æ¸…å–®å·¦æ»‘åŠŸèƒ½JSé‚è¼¯ â–¼â–¼â–¼
const chatListEl = document.getElementById('chat-list');
let chatSwipeState = { isDragging: false, startX: 0, activeContent: null };

// é—œé–‰æ‰€æœ‰å·²æ»‘é–‹çš„é …
function resetAllChatSwipes(exceptThisOne = null) {
    document.querySelectorAll('.chat-list-item-content.swiped').forEach(content => {
        if (content !== exceptThisOne) {
            content.classList.remove('swiped');
        }
    });
}

chatListEl.addEventListener('mousedown', (e) => {
    const content = e.target.closest('.chat-list-item-content');
    if (content) {
        resetAllChatSwipes(content);
        chatSwipeState.isDragging = true;
        chatSwipeState.startX = e.pageX;
        chatSwipeState.activeContent = content;
        // é˜»æ­¢æ‹–å‹•æ™‚é¸ä¸­æ–‡æœ¬
        e.preventDefault();
    }
});

document.addEventListener('mousemove', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    const diffX = e.pageX - chatSwipeState.startX;
    if (diffX < 0 && diffX > -170) { // åªå…è¨±å‘å·¦æ»‘, é™åˆ¶æœ€å¤§è·é›¢
        chatSwipeState.activeContent.style.transition = 'none'; // æ»‘å‹•æ™‚ç¦ç”¨å‹•ç•«
        chatSwipeState.activeContent.style.transform = `translateX(${diffX}px)`;
    }
});

document.addEventListener('mouseup', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    
    chatSwipeState.activeContent.style.transition = 'transform 0.3s ease';
    const transformStyle = window.getComputedStyle(chatSwipeState.activeContent).transform;
    const currentTranslateX = new DOMMatrix(transformStyle).m41;

    if (currentTranslateX < -60) { // æ»‘å‹•è¶…éé–¾å€¼
        chatSwipeState.activeContent.classList.add('swiped');
    } else {
        chatSwipeState.activeContent.classList.remove('swiped');
    }
    chatSwipeState.activeContent.style.transform = ''; // æ¸…é™¤å…§è¯æ¨£å¼ï¼Œäº¤ç”±CSS classæ§åˆ¶

    // é‡ç½®ç‹€æ…‹
    chatSwipeState.isDragging = false;
    chatSwipeState.activeContent = null;
});

// ç§»å‹•ç«¯è§¸æ‘¸äº‹ä»¶çš„ç›¸å®¹
chatListEl.addEventListener('touchstart', (e) => {
     const content = e.target.closest('.chat-list-item-content');
    if (content) {
        resetAllChatSwipes(content);
        chatSwipeState.isDragging = true;
        chatSwipeState.startX = e.touches[0].pageX;
        chatSwipeState.activeContent = content;
    }
}, { passive: true });

chatListEl.addEventListener('touchmove', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    const diffX = e.touches[0].pageX - chatSwipeState.startX;
     if (diffX < 0 && diffX > -170) {
        chatSwipeState.activeContent.style.transition = 'none';
        chatSwipeState.activeContent.style.transform = `translateX(${diffX}px)`;
    }
}, { passive: true });

chatListEl.addEventListener('touchend', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    
    chatSwipeState.activeContent.style.transition = 'transform 0.3s ease';
    const transformStyle = window.getComputedStyle(chatSwipeState.activeContent).transform;
    const currentTranslateX = new DOMMatrix(transformStyle).m41;

    if (currentTranslateX < -60) {
        chatSwipeState.activeContent.classList.add('swiped');
    } else {
        chatSwipeState.activeContent.classList.remove('swiped');
    }
    chatSwipeState.activeContent.style.transform = '';

    chatSwipeState.isDragging = false;
    chatSwipeState.activeContent = null;
});
// â–²â–²â–² æ–°JSé‚è¼¯é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©æ¸…å–®æ“ä½œæŒ‰éˆ•é»æ“Šäº‹ä»¶ â–¼â–¼â–¼
chatListEl.addEventListener('click', async (e) => {
    const target = e.target;
    if (target.classList.contains('swipe-action-btn')) {
        const container = target.closest('.chat-list-item-swipe-container');
        if (!container) return;

        const chatId = container.dataset.chatId;
        const chat = state.chats[chatId];
        if (!chat) return;

        if (target.classList.contains('pin') || target.classList.contains('unpin')) {
            // ç½®é ‚æˆ–å–æ¶ˆç½®é ‚
            chat.isPinned = !chat.isPinned;
            await db.chats.put(chat);
            await renderChatList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°æ’åº
        } else if (target.classList.contains('delete')) {
            // åˆªé™¤
            const confirmed = await showCustomConfirm('åˆªé™¤å°è©±', `ç¢ºå®šè¦åˆªé™¤èˆ‡ "${chat.name}" çš„æ•´å€‹å°è©±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false);
                delete state.chats[chat.id];
                if (state.activeChatId === chat.id) state.activeChatId = null;
                await db.chats.delete(chat.id);
                await renderChatList();
            } else {
                // å¦‚æœå–æ¶ˆåˆªé™¤ï¼Œå‰‡æŠŠæ»‘å¡Šæ”¶å›å»
                const content = container.querySelector('.chat-list-item-content');
                if (content) content.classList.remove('swiped');
            }
        }
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç›£è½é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹ï¼ŒæŠŠä¸‹é¢é€™å…©å¡Šå®Œæ•´çš„ eventListener ä»£ç¢¼ã€å‰ªåˆ‡ã€‘æ‰ â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”è¨—ä¾†è™•ç†æ‰€æœ‰é»æ“Šå’Œå‹¾é¸äº‹ä»¶ï¼Œæ•ˆç‡æ›´é«˜
worldBookCheckboxesContainer.addEventListener('click', (e) => {
    const header = e.target.closest('.wb-category-header');
    // å¦‚æœé»æ“Šçš„æ˜¯è³‡æ–™å¤¾é ­éƒ¨ï¼Œä¸¦ä¸”ä¸æ˜¯é»åœ¨æ ¸å–æ–¹å¡Šä¸Š
    if (header && !e.target.matches('input[type="checkbox"]')) {
        const categoryId = header.querySelector('.wb-category-checkbox')?.dataset.categoryId;
        if (categoryId) {
            const bookContainer = worldBookCheckboxesContainer.querySelector(`.wb-book-container[data-container-for="${categoryId}"]`);
            if (bookContainer) {
                header.classList.toggle('collapsed');
                bookContainer.classList.toggle('collapsed');
            }
        }
    }
});

worldBookCheckboxesContainer.addEventListener('change', (e) => {
    const target = e.target;
    
    // å¦‚æœé»æ“Šçš„æ˜¯åˆ†é¡çš„â€œå…¨é¸â€æ ¸å–æ–¹å¡Š
    if (target.classList.contains('wb-category-checkbox')) {
        const categoryId = target.dataset.categoryId;
        const isChecked = target.checked;
        // æ‰¾åˆ°é€™å€‹åˆ†é¡ä¸‹çš„æ‰€æœ‰æ›¸ç±æ ¸å–æ–¹å¡Šï¼Œä¸¦å°‡å®ƒå€‘çš„ç‹€æ…‹è¨­ç½®ç‚ºèˆ‡åˆ†é¡æ ¸å–æ–¹å¡Šä¸€è‡´
        const bookCheckboxes = worldBookCheckboxesContainer.querySelectorAll(`input.wb-book-checkbox[data-parent-category="${categoryId}"]`);
        bookCheckboxes.forEach(cb => cb.checked = isChecked);
    }
    
    // å¦‚æœé»æ“Šçš„æ˜¯å–®å€‹æ›¸ç±çš„æ ¸å–æ–¹å¡Š
    if (target.classList.contains('wb-book-checkbox')) {
        const categoryId = target.dataset.parentCategory;
        if (categoryId) { // æª¢æŸ¥å®ƒæ˜¯å¦å±¬æ–¼ä¸€å€‹åˆ†é¡
            const categoryCheckbox = worldBookCheckboxesContainer.querySelector(`input.wb-category-checkbox[data-category-id="${categoryId}"]`);
            const allBookCheckboxes = worldBookCheckboxesContainer.querySelectorAll(`input.wb-book-checkbox[data-parent-category="${categoryId}"]`);
            // æª¢æŸ¥è©²åˆ†é¡ä¸‹æ˜¯å¦æ‰€æœ‰æ›¸ç±éƒ½è¢«é¸ä¸­äº†
            const allChecked = Array.from(allBookCheckboxes).every(cb => cb.checked);
            // åŒæ­¥åˆ†é¡â€œå…¨é¸â€æ ¸å–æ–¹å¡Šçš„ç‹€æ…‹
            if(categoryCheckbox) categoryCheckbox.checked = allChecked;
        }
    }
    
    // æ¯æ¬¡è®Šæ›´å¾Œéƒ½æ›´æ–°é ‚éƒ¨çš„å·²é¸æ•¸é‡é¡¯ç¤º
    updateWorldBookSelectionDisplay();
});

// â–²â–²â–² æŠŠä¸Šé¢é€™å…©å¡Šå®Œæ•´çš„ eventListener ä»£ç¢¼ã€å‰ªåˆ‡ã€‘æ‰ â–²â–²â–²


    // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼ä¸‹é¢é€™ä¸€æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

    // --- ç¾åŒ–åŠŸèƒ½äº‹ä»¶ç¶å®š ---
    const themeEditor = document.getElementById('theme-css-editor');
    
    // é é¢è¼‰å…¥æ™‚ï¼Œè¼‰å…¥ä¸»é¡Œæ¸…å–®ä¸¦é¡¯ç¤ºç¯„æœ¬
    await loadThemesToDropdown();
    themeEditor.value = THEME_CSS_TEMPLATE;

    // ç¶å®šä¸‹æ‹‰æ¸…å–®é¸æ“‡äº‹ä»¶
    document.getElementById('theme-selector').addEventListener('change', handleThemeSelection);
    
    // ç¶å®šæ‰€æœ‰æ“ä½œæŒ‰éˆ•
    document.getElementById('apply-theme-btn').addEventListener('click', () => applyThemeCss(themeEditor.value));
    document.getElementById('save-theme-btn').addEventListener('click', saveCurrentTheme);
    document.getElementById('save-as-new-theme-btn').addEventListener('click', saveAsNewTheme);
    document.getElementById('rename-theme-btn').addEventListener('click', renameSelectedTheme);
    document.getElementById('delete-theme-btn').addEventListener('click', deleteSelectedTheme);
    document.getElementById('export-theme-btn').addEventListener('click', exportTheme);
    
    // ç¶å®šå°å…¥æŒ‰éˆ•å’Œéš±è—çš„æª”é¸æ“‡å™¨
    document.getElementById('import-theme-btn').addEventListener('click', () => {
        document.getElementById('import-theme-input').click();
    });
    document.getElementById('import-theme-input').addEventListener('change', (e) => {
        importTheme(e.target.files[0]);
        e.target.value = null; // æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡åŒä¸€å€‹æ–‡ä»¶
    });
    
    // â–²â–²â–² æ–°äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²

document.getElementById('api-preset-select').addEventListener('change', handleApiPresetSelectChange);
document.getElementById('manage-api-presets-btn').addEventListener('click', openApiPresetManager);

            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é–å±åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

            // 1. é–å±å£ç´™ä¸Šå‚³
            document.getElementById('lockscreen-wallpaper-upload-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if(file) {
                    const dataUrl = await new Promise((res, rej) => {
                        const reader = new FileReader();
                        reader.onload = () => res(reader.result);
                        reader.onerror = () => rej(reader.error);
                        reader.readAsDataURL(file);
                    });
                    newLockscreenWallpaperBase64 = dataUrl;
                    renderWallpaperScreen(); // ä¸Šå‚³å¾Œå³æ™‚é è¦½
                }
            });

            // 2. å¯†ç¢¼è¼¸å…¥æ¡†æŒ‰éˆ•
            document.getElementById('password-confirm-btn').addEventListener('click', checkPassword);
            document.getElementById('password-cancel-btn').addEventListener('click', hidePasswordModal);
            // å…è¨±åœ¨è¼¸å…¥æ¡†å…§æŒ‰å›è»Šéµç¢ºèª
            document.getElementById('password-input-field').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // 3. ã€å…¨æ–°ã€‘å¸¶æœ‰å‹•ç•«æ•ˆæœçš„ä¸Šæ»‘è§£é–æ‰‹å‹¢
            const lockScreen = document.getElementById('lock-screen');
            const unlockHint = document.getElementById('unlock-hint');
            let touchStartY = 0;
            let isSwiping = false;

// çµ±ä¸€çš„é–‹å§‹è™•ç†å‡½æ•¸
const handleUnlockStart = (e) => {
    if (document.getElementById('password-modal-overlay').classList.contains('visible')) return;
    
    // (ä½ åŸä¾†çš„å…¶ä»–é‚è¼¯ä¿æŒä¸è®Š)
    const blurBg = document.getElementById('lock-screen-background-blur');
    if (state.globalSettings.password) {
        blurBg.style.backgroundImage = lockScreen.style.backgroundImage;
        blurBg.style.display = 'block';
    } else {
        document.getElementById('home-screen').classList.add('active');
    }
    
    touchStartY = getEventCoords(e).y; // ä½¿ç”¨è¼”åŠ©å‡½æ•¸ç²å–Yåº§æ¨™
    isSwiping = true;
    lockScreen.style.transition = 'none';
    unlockHint.style.transition = 'none';
};

// çµ±ä¸€çš„ç§»å‹•è™•ç†å‡½æ•¸
const handleUnlockMove = (e) => {
    if (!isSwiping) return;
    const currentY = getEventCoords(e).y; // ä½¿ç”¨è¼”åŠ©å‡½æ•¸
    let diffY = currentY - touchStartY;
    // (ä½ åŸä¾†çš„å…¶ä»–é‚è¼¯ä¿æŒä¸è®Š)
    if (diffY > 0) diffY = 0;
    lockScreen.style.transform = `translateY(${diffY}px)`;
    unlockHint.style.opacity = Math.max(0, 1 - Math.abs(diffY) / 100);
    if (state.globalSettings.password) {
        const blurBg = document.getElementById('lock-screen-background-blur');
        blurBg.style.opacity = Math.min(1, Math.abs(diffY) / 80);
    }
};

// çµ±ä¸€çš„çµæŸè™•ç†å‡½æ•¸
const handleUnlockEnd = (e) => {
    if (!isSwiping) return;
    isSwiping = false;

    // (ä½ åŸä¾†çš„å…¶ä»–é‚è¼¯ä¿æŒä¸è®Š)
    lockScreen.style.transition = 'transform 0.3s ease-out';
    unlockHint.style.transition = 'opacity 0.3s ease-out';
    const blurBg = document.getElementById('lock-screen-background-blur');
    
    // æ³¨æ„ï¼štouchendäº‹ä»¶çš„åº§æ¨™åœ¨ e.changedTouches[0]
    const touchEndY = e.changedTouches ? e.changedTouches[0].clientY : e.pageY;
    const swipeDistance = touchStartY - touchEndY;
    
    if (swipeDistance > 80) {
        lockScreen.style.transform = 'translateY(-100%)';
        setTimeout(() => {
            if (state.globalSettings.password) {
                showPasswordModal();
            } else {
                unlockPhone();
            }
        }, 300);
    } else {
        lockScreen.style.transform = 'translateY(0)';
        unlockHint.style.opacity = '1';
        if (state.globalSettings.password) {
            blurBg.style.opacity = '0';
            setTimeout(() => { blurBg.style.display = 'none'; }, 300);
        } else {
            document.getElementById('home-screen').classList.remove('active');
        }
    }
};

// 2. ç¶å®šå…©ç¨®äº‹ä»¶åˆ°åŒä¸€å¥—è™•ç†é‚è¼¯ä¸Š
lockScreen.addEventListener('touchstart', handleUnlockStart, { passive: true });
lockScreen.addEventListener('touchmove', handleUnlockMove, { passive: true });
lockScreen.addEventListener('touchend', handleUnlockEnd, { passive: true });

lockScreen.addEventListener('mousedown', handleUnlockStart);
// æ³¨æ„ï¼šmousemoveå’Œmouseupæœ€å¥½ç¶å®šåœ¨documentä¸Šï¼Œé˜²æ­¢æ»‘é¼ æ‹–å‡ºç¯„åœå¾Œå¤±æ•ˆ
document.addEventListener('mousemove', handleUnlockMove);
document.addEventListener('mouseup', handleUnlockEnd);
            
            // â–²â–²â–² æ–°äº‹ä»¶ç›£è½å™¨é»è²¼çµæŸ â–²â–²â–²

// ã€å…¨æ–°ã€‘ç‚ºèŠå¤©åº•éƒ¨å·¥å…·åˆ—æ·»åŠ æ»‘é¼ æ‹–å‹•æ»¾å‹•åŠŸèƒ½
const actionsTopBar = document.getElementById('chat-input-actions-top');
let isDown = false;
let startX;
let scrollLeft;

actionsTopBar.addEventListener('mousedown', (e) => {
    isDown = true;
    actionsTopBar.classList.add('grabbing'); // æ·»åŠ ä¸€å€‹classä¾†æ”¹è®Šæ»‘é¼ æ¨£å¼
    startX = e.pageX - actionsTopBar.offsetLeft;
    scrollLeft = actionsTopBar.scrollLeft;
});

actionsTopBar.addEventListener('mouseleave', () => {
    isDown = false;
    actionsTopBar.classList.remove('grabbing');
});

actionsTopBar.addEventListener('mouseup', () => {
    isDown = false;
    actionsTopBar.classList.remove('grabbing');
});

actionsTopBar.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - actionsTopBar.offsetLeft;
    const walk = (x - startX) * 2; // ä¹˜ä»¥2å¯ä»¥å¢åŠ æ‹–å‹•é€Ÿåº¦ï¼Œæ„Ÿè¦ºæ›´éˆæ•
    actionsTopBar.scrollLeft = scrollLeft - walk;
});

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('location-cancel-btn').addEventListener('click', () => {
    document.getElementById('send-location-modal').classList.remove('visible');
});
document.getElementById('location-confirm-btn').addEventListener('click', sendUserLocation);
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ç‚ºå®šä½æ¨¡æ…‹æ¡†çš„â€œæ·»åŠ é€”ç¶“é»â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('add-trajectory-point-btn').addEventListener('click', () => {
    // é™åˆ¶æœ€å¤šæ·»åŠ 3å€‹é€”ç¶“é»ï¼Œé˜²æ­¢UIéæ–¼æ“æ“ 
    if (document.querySelectorAll('.trajectory-point-input').length < 3) {
        addTrajectoryPointInput();
    } else {
        alert("æœ€å¤šåªèƒ½æ·»åŠ 3å€‹é€”ç¶“é»å“¦ï¼");
    }
});

// ã€æ–°å¢ã€‘æ‰“é–‹å®šä½æ¨¡æ…‹æ¡†æ™‚ï¼Œæ¸…ç©ºèˆŠçš„é€”ç¶“é»
document.getElementById('send-location-btn').addEventListener('click', () => {
    document.getElementById('trajectory-points-container').innerHTML = '';
    document.getElementById('send-location-modal').classList.add('visible');
});

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('reroll-btn').addEventListener('click', handleRerollClick);
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é»è²¼é€™æ•´å¡Šäº‹ä»¶ç›£è½ä»£ç¢¼åˆ° init() æœ«å°¾ â–¼â–¼â–¼

// --- æ‡¸æµ®æ­Œè©æ¬„è¨­ç½®åŠŸèƒ½ ---
document.getElementById('lyrics-settings-btn').addEventListener('click', (e) => {
    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡è§¸ç™¼æ‹–å‹•æˆ–æ‰“é–‹æ’­æ”¾æ©Ÿ
    document.getElementById('lyrics-settings-modal').classList.add('visible');
});

document.getElementById('close-lyrics-settings-btn').addEventListener('click', async () => {
    // ä¿å­˜è¨­ç½®åˆ°å…¨åŸŸç‹€æ…‹ä¸¦å¯«å…¥è³‡æ–™åº«
    state.globalSettings.lyricsBarSettings = lyricsBarSettings;
    await db.globalSettings.put(state.globalSettings);
    document.getElementById('lyrics-settings-modal').classList.remove('visible');
    alert('è¨­ç½®å·²ä¿å­˜ï¼');
});

document.getElementById('reset-lyrics-settings-btn').addEventListener('click', () => {
    // æ¢å¾©åˆ°é è¨­å€¼
    lyricsBarSettings = { fontSize: 14, bgOpacity: 0, fontColor: '#FFFFFF', showOnClose: true };
    applyLyricsSettings(); // æ‡‰ç”¨é»˜èªè¨­ç½®
});

// å³æ™‚æ›´æ–°æ¨£å¼
document.getElementById('lyrics-font-size-slider').addEventListener('input', (e) => {
    lyricsBarSettings.fontSize = e.target.value;
    applyLyricsSettings();
});
document.getElementById('lyrics-bg-opacity-slider').addEventListener('input', (e) => {
    lyricsBarSettings.bgOpacity = e.target.value;
    applyLyricsSettings();
});
document.getElementById('lyrics-font-color-picker').addEventListener('input', (e) => {
    lyricsBarSettings.fontColor = e.target.value;
    applyLyricsSettings();
});

// æ­Œè©æ¬„ä¸Šçš„é—œé–‰æŒ‰éˆ•
document.querySelector('#floating-lyrics-bar .close-btn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('floating-lyrics-bar').style.display = 'none';
});

// æ’­æ”¾æ©Ÿè£¡çš„â€œæ‡¸æµ®/éš±è—â€é–‹é—œ
document.getElementById('toggle-lyrics-bar-btn').addEventListener('click', async (e) => {
    lyricsBarSettings.showOnClose = !lyricsBarSettings.showOnClose;
    e.target.textContent = lyricsBarSettings.showOnClose ? 'æ‡¸æµ®' : 'éš±è—';
    e.target.style.opacity = lyricsBarSettings.showOnClose ? '1' : '0.5';
    // ç«‹å³ä¿å­˜é€™å€‹è¨­ç½®
    state.globalSettings.lyricsBarSettings = lyricsBarSettings;
    await db.globalSettings.put(state.globalSettings);
});

// ã€é‡è¦ã€‘åœ¨é é¢è¼‰å…¥æ™‚ï¼Œå°±æ‡‰ç”¨ä¸€æ¬¡å·²ä¿å­˜çš„è¨­ç½®
applyLyricsSettings();

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥è§’è‰²æ‰‹æ©Ÿâ€åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

            // 1. ç¶å®šä¸»è¢å¹•ä¸Šçš„â€œæŸ¥æ‰‹æ©Ÿâ€APPåœ–ç¤º
            const checkPhoneAppIcon = document.querySelector('.app-icon[data-app-id="check-phone"]');
            if (checkPhoneAppIcon) {
                checkPhoneAppIcon.onclick = openCharacterSelectionScreen; // ä¿®æ”¹onclickäº‹ä»¶
            }

            // 2. è§’è‰²é¸æ“‡åˆ—è¡¨çš„é»æ“Šäº‹ä»¶ (äº‹ä»¶å§”è¨—)
            document.getElementById('character-selection-list').addEventListener('click', (e) => {
                const item = e.target.closest('.character-select-item');
                if (item && item.dataset.chatId) {
                    openCharacterPhone(item.dataset.chatId);
                }
            });
// â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ› â–¼â–¼â–¼
// ã€V3ç‰ˆã€‘è§’è‰²æ‰‹æ©ŸèŠå¤©åˆ—è¡¨çš„é»æ“Šäº‹ä»¶ (äº‹ä»¶å§”è¨—)
document.getElementById('character-chat-list').addEventListener('click', (e) => {
    const item = e.target.closest('.chat-list-item');
    if (item && item.dataset.contactName) {
        // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ¢é‡ #2 â–¼â–¼â–¼
        const isUserChat = item.dataset.isUserChat === 'true';
        console.log("ã€è¨ºæ–·æ—¥èªŒ 2ã€‘: é»æ“Šäº†èŠå¤©åˆ—è¡¨é …", {
            contactName: item.dataset.contactName,
            isUserChat: isUserChat
        });
        // â–²â–²â–² æ¢é‡çµæŸ â–²â–²â–²
        
        // å°‡é€£çµ¡äººåå­—å’Œâ€œèº«ä»½è­‰â€ä¸€èµ·å‚³éçµ¦æ¸²æŸ“å‡½æ•¸
        renderCharacterChatHistory(item.dataset.contactName, isUserChat);
        showCharacterPhonePage('character-chat-history-screen');
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



            // 3. è§’è‰²æ‰‹æ©Ÿé ‚éƒ¨çš„â€œåˆ·æ–°â€å’Œâ€œæ¸…ç©ºâ€æŒ‰éˆ•
            document.getElementById('generate-character-data-btn').addEventListener('click', generateCharacterPhoneData);
            document.getElementById('clear-character-data-btn').addEventListener('click', clearCharacterPhoneData);

            // â–²â–²â–² äº‹ä»¶ç›£è½å™¨æ·»åŠ çµæŸ â–²â–²â–²

            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿå…§éƒ¨çµ±ä¸€è¿”å›äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
            document.getElementById('character-phone-container').addEventListener('click', (e) => {
                const backBtn = e.target.closest('.back-btn');
                if (!backBtn) return;

                // æª¢æŸ¥æ˜¯è¿”å›åˆ°è§’è‰²æ‰‹æ©Ÿå…§éƒ¨é é¢ï¼Œé‚„æ˜¯è¿”å›åˆ°ä¸»è¢å¹•
                if (backBtn.dataset.targetPage) {
                    showCharacterPhonePage(backBtn.dataset.targetPage);
                } else if (backBtn.dataset.targetScreen) {
                    showScreen(backBtn.dataset.targetScreen);
                }
            });
            // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿæ—¥è¨˜APPäº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
            document.getElementById('character-app-grid').addEventListener('click', (e) => {
                const icon = e.target.closest('.app-icon');
                if (icon && icon.querySelector('.label').textContent === 'æ—¥è¨˜') {
                    renderCharacterDiary();
                }
            });
            document.getElementById('generate-diary-entry-btn').addEventListener('click', generateNewDiaryEntry);
            // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥æ‰‹æ©Ÿâ€å…§å®¹å–®æ¢åˆªé™¤åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('character-phone-container').addEventListener('click', (e) => {
    const deleteBtn = e.target.closest('.item-delete-btn');
    if (deleteBtn) {
        // ã€æ–°å¢ã€‘è™•ç†å¾®ä¿¡æ¶ˆæ¯åˆªé™¤
        if (deleteBtn.classList.contains('message-delete-btn')) {
            const contactName = deleteBtn.dataset.contactName;
            const index = parseInt(deleteBtn.dataset.index);
            if (contactName && !isNaN(index)) {
                handleCharacterChatMessageDeletion(contactName, index);
            }
        } 
        // è™•ç†å…¶ä»–åˆ—è¡¨åˆªé™¤
        else {
            const dataType = deleteBtn.dataset.type;
            const index = parseInt(deleteBtn.dataset.index);
            if (dataType && !isNaN(index)) {
                handleCharacterDataDeletion(dataType, index);
            }
        }
    }
});
// â–²â–²â–² åˆªé™¤åŠŸèƒ½äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘NPCåº«ç®¡ç†åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼

// èŠå¤©è¨­ç½®è£¡çš„â€œç®¡ç†NPCåº«â€æŒ‰éˆ•
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.id === 'manage-npcs-btn') {
        // å…ˆé—œé–‰èŠå¤©è¨­ç½®ï¼Œå†æ‰“é–‹NPCç®¡ç†
        document.getElementById('chat-settings-modal').classList.remove('visible');
        openNpcManager();
    }
});

// NPCç®¡ç†ä»‹é¢çš„è¿”å›æŒ‰éˆ•
document.getElementById('back-from-npc-management').addEventListener('click', () => {
    // è¿”å›æ™‚ï¼Œé‡æ–°æ‰“é–‹èŠå¤©è¨­ç½®
    showScreen('chat-interface-screen');
    document.getElementById('chat-settings-btn').click();
});

// NPCç®¡ç†ä»‹é¢çš„â€œ+â€æŒ‰éˆ•
document.getElementById('add-new-npc-btn').addEventListener('click', () => openNpcEditor(null));



// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é»è²¼é€™æ•´å¡Šäº‹ä»¶ç›£è½å™¨ä»£ç¢¼ â–¼â–¼â–¼
// --- å¾Œè‡ºæ´»å‹•è¨­ç½®ä»‹é¢çš„äº‹ä»¶ç¶å®š ---

// 1. ç¸½é–‹é—œçš„äº‹ä»¶
document.getElementById('background-activity-switch').addEventListener('change', () => {
    // æ¯æ¬¡é»æ“Šç¸½é–‹é—œï¼Œéƒ½é‡æ–°æ¸²æŸ“ä¸€æ¬¡è©³ç´°è¨­ç½®å€ï¼ˆå®ƒæœƒæ ¹æ“šé–‹é—œç‹€æ…‹è‡ªå‹•é¡¯ç¤ºæˆ–éš±è—ï¼‰
    renderBackgroundFrequencySelector();
});

// 2. å…¨é¸æŒ‰éˆ•
document.getElementById('bg-select-all-chars').addEventListener('click', () => {
    document.querySelectorAll('.bg-char-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
});

// 3. å…¨ä¸é¸æŒ‰éˆ•
document.getElementById('bg-deselect-all-chars').addEventListener('click', () => {
    document.querySelectorAll('.bg-char-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
});

// é€™æ˜¯ä¿®å¾©å¾Œçš„æ–°ä»£ç¢¼å¡Šï¼Œç”¨å®ƒæ›¿æ›æ‰èˆŠçš„
document.querySelector('#background-activity-details').addEventListener('click', async (e) => { // æ³¨æ„é€™é‡ŒåŠ äº† async
    if (e.target.classList.contains('bg-freq-btn')) {
        const freq = e.target.dataset.freq;
        const selectedCheckboxes = document.querySelectorAll('.bg-char-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            alert('è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹è§’è‰²ï¼');
            return;
        }

        const config = state.globalSettings.backgroundActivityConfig || {};
        selectedCheckboxes.forEach(checkbox => {
            const chatId = checkbox.dataset.chatId;
            if (freq === 'none') {
                delete config[chatId];
            } else {
                config[chatId] = freq;
            }
        });
        
        state.globalSettings.backgroundActivityConfig = config;
        
        // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘æ–°åŠ çš„é—œéµä»£ç¢¼ï¼â˜…â˜…â˜…
        await db.globalSettings.put(state.globalSettings);
        // â˜…â˜…â˜…â˜…â˜… æ·»åŠ çµæŸ â˜…â˜…â˜…â˜…â˜…
        
        renderBackgroundFrequencySelector();

        const freqTextMap = {low:'ä½', medium:'ä¸­', high:'é«˜', none: 'é—œé–‰'};
        const freqText = freqTextMap[freq];
        alert(`å·²ç‚º ${selectedCheckboxes.length} å€‹è§’è‰²å°‡å¾Œè‡ºæ´»å‹•é »ç‡è¨­ç‚º "${freqText}"`);
    }
});
// ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºæ‰€æœ‰å¯ç·¨è¼¯å…ƒç´ çµ±ä¸€ç¶å®šé»æ“Šäº‹ä»¶
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ â–¼â–¼â–¼
// ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºæ‰€æœ‰å¯ç·¨è¼¯å…ƒç´ çµ±ä¸€ç¶å®šé»æ“Šäº‹ä»¶
document.getElementById('home-screen').addEventListener('click', async (e) => { // <-- æŠŠé€™è¡Œä¹Ÿæ”¹æˆ async
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘ä½¿ç”¨ .closest() ä¾†ç¢ºä¿å³ä½¿é»æ“Šåˆ°å­å…ƒç´ ä¹Ÿèƒ½æ­£ç¢ºè§¸ç™¼
    const editableText = e.target.closest('.editable-text');
    if (editableText) {
        handleEditText(editableText);
        return; // è™•ç†å®Œå°±é€€å‡ºï¼Œé¿å…é‡è¤‡è§¸ç™¼
    }

    const editableImage = e.target.closest('.editable-image');
    if (editableImage) {
        // --- â–¼â–¼â–¼ é€™å°±æ˜¯æˆ‘å€‘æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼ ---
        // 1. åˆ¤æ–·è¢«é»æ“Šçš„åœ–ç‰‡æ˜¯ä¸æ˜¯ä¸»è¢å¹•çš„é‚£å€‹å¤§é ­åƒ
        if (editableImage.id === 'profile-avatar-img') {
            // 2. å¦‚æœæ˜¯ï¼Œå°±å½ˆå‡ºä¸€å€‹é¸æ“‡åŠŸèƒ½è¡¨
            const choice = await showChoiceModal("ç·¨è¼¯é ­åƒ", [
                { text: 'æ›´æ›é ­åƒåœ–ç‰‡', value: 'avatar' },
                { text: 'æ›´æ›é ­åƒæ¡†', value: 'frame' }
            ]);
            
            // 3. æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡ï¼ŒåŸ·è¡Œä¸åŒçš„æ“ä½œ
            if (choice === 'avatar') {
                handleEditImage(editableImage); // èª¿ç”¨åŸä¾†çš„æ›´æ›åœ–ç‰‡å‡½æ•¸
            } else if (choice === 'frame') {
                openFrameSelectorModal('home_profile'); // èª¿ç”¨æˆ‘å€‘æ–°å¢çš„æ›´æ›é ­åƒæ¡†å‡½æ•¸
            }
        } else {
            // 4. å¦‚æœé»æ“Šçš„ä¸æ˜¯ä¸»é ­åƒï¼ˆæ¯”å¦‚æ˜¯å…¶ä»–å°å…ƒä»¶çš„åœ–ç‰‡ï¼‰ï¼Œå°±é‚„åŸ·è¡ŒåŸä¾†çš„é‚è¼¯
            handleEditImage(editableImage);
        }
        // --- â–²â–²â–² æ ¸å¿ƒä»£ç¢¼ä¿®æ”¹çµæŸ â–²â–²â–² ---
        return;
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥æ‰‹æ©Ÿâ€å…§å®¹å–®æ¢åˆªé™¤åŠŸèƒ½ â–¼â–¼â–¼
/**
 * è™•ç†è§’è‰²æ‰‹æ©Ÿå…§è³‡æ–™åˆªé™¤çš„é€šç”¨å‡½æ•¸
 * @param {string} dataType - è¦åˆªé™¤çš„è³‡æ–™é¡å‹, æ¯”å¦‚ 'memos', 'shoppingCart'
 * @param {number} index - è¦åˆªé™¤çš„è³‡æ–™åœ¨é™£åˆ—ä¸­çš„ç´¢å¼•
 */
async function handleCharacterDataDeletion(dataType, index) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    
    let dataArray;
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è™•ç†åƒ bank.transactions é€™æ¨£çš„åµŒå¥—æ•¸æ“š
    if (dataType.includes('.')) {
        const keys = dataType.split('.');
        dataArray = chat.characterPhoneData[keys[0]][keys[1]];
    } else {
        dataArray = chat.characterPhoneData[dataType];
    }

    if (!chat || !dataArray) return;

    const itemToDelete = dataArray[index];
    if (!itemToDelete) return;

    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤',
        'ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        dataArray.splice(index, 1);
        await db.chats.put(chat);
        
        // æ ¹æ“šåˆªé™¤çš„é¡å‹ï¼Œé‡æ–°æ¸²æŸ“å°æ‡‰çš„APPä»‹é¢
        switch(dataType) {
            case 'memos': renderCharacterMemos(); break;
            case 'shoppingCart': renderCharacterShoppingCart(); break;
            case 'browserHistory': renderCharacterBrowser(); break;
            case 'diary': renderCharacterDiary(); break;
            case 'bank.transactions': renderCharacterBank(); break; // æ–°å¢
            case 'trajectory': renderCharacterTrajectory(); break;   // æ–°å¢
            case 'appUsage': renderCharacterAppUsage(); break;       // æ–°å¢
            case 'photoAlbum': renderCharacterPhotoAlbum(); break;   // æ–°å¢
        }
        alert('è¨˜éŒ„å·²åˆªé™¤ã€‚');
    }
}
// ä½¿ç”¨äº‹ä»¶å§”è¨—ä¾†è™•ç†æ‰€æœ‰åˆªé™¤æŒ‰éˆ•çš„é»æ“Š
document.getElementById('character-phone-container').addEventListener('click', (e) => {
    if (e.target.classList.contains('item-delete-btn')) {
        const dataType = e.target.dataset.type;
        const index = parseInt(e.target.dataset.index);
        if (dataType && !isNaN(index)) {
            handleCharacterDataDeletion(dataType, index);
        }
    }
});
// â–²â–²â–² åˆªé™¤åŠŸèƒ½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥æ‰‹æ©Ÿâ€å…§å®¹å–®æ¢åˆªé™¤åŠŸèƒ½ â–¼â–¼â–¼
/**
 * è™•ç†è§’è‰²æ‰‹æ©Ÿå…§è³‡æ–™åˆªé™¤çš„é€šç”¨å‡½æ•¸
 * @param {string} dataType - è¦åˆªé™¤çš„è³‡æ–™é¡å‹, æ¯”å¦‚ 'memos', 'shoppingCart'
 * @param {number} index - è¦åˆªé™¤çš„è³‡æ–™åœ¨é™£åˆ—ä¸­çš„ç´¢å¼•
 */
async function handleCharacterDataDeletion(dataType, index) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    
    let dataArray;
    // è™•ç†åƒ bank.transactions é€™æ¨£çš„åµŒå¥—æ•¸æ“š
    if (dataType.includes('.')) {
        const keys = dataType.split('.');
        dataArray = chat.characterPhoneData[keys[0]][keys[1]];
    } else {
        dataArray = chat.characterPhoneData[dataType];
    }

    if (!chat || !dataArray) return;

    const itemToDelete = dataArray[index];
    if (!itemToDelete) return;

    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤',
        'ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        dataArray.splice(index, 1);
        await db.chats.put(chat);
        
        // æ ¹æ“šåˆªé™¤çš„é¡å‹ï¼Œé‡æ–°æ¸²æŸ“å°æ‡‰çš„APPä»‹é¢
        switch(dataType) {
            case 'memos': renderCharacterMemos(); break;
            case 'shoppingCart': renderCharacterShoppingCart(); break;
            case 'browserHistory': renderCharacterBrowser(); break;
            case 'diary': renderCharacterDiary(); break;
            case 'bank.transactions': renderCharacterBank(); break;
            case 'trajectory': renderCharacterTrajectory(); break;
            case 'appUsage': renderCharacterAppUsage(); break;
            case 'photoAlbum': renderCharacterPhotoAlbum(); break;
        }
        alert('è¨˜éŒ„å·²åˆªé™¤ã€‚');
    }
}
// â–²â–²â–² åˆªé™¤åŠŸèƒ½çµæŸ â–²â–²â–²
startGroupSimulation(); // å•Ÿå‹•ç¾¤èŠå°ˆå±¬çš„å¾Œè‡ºæ™‚é˜
// â–²â–²â–² æ–°äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
    // â–¼â–¼â–¼ æ­¥é©Ÿ3.3ï¼šåœ¨ init() çš„å‰é¢é»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
    // ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç›£è½æ•´å€‹å‹•æ…‹æ¸…å–®çš„â€œç„¦é»ç§»å‡ºâ€äº‹ä»¶
    document.getElementById('qzone-posts-list').addEventListener('focusout', (e) => {
        // å¦‚æœæ˜¯è©•è«–è¼¸å…¥æ¡†å¤±å»äº†ç„¦é»
        if (e.target.classList.contains('comment-input')) {
            const commentInput = e.target;
            // ä¸¦ä¸”è¼¸å…¥æ¡†æ˜¯ç©ºçš„
            if (commentInput.value.trim() === '') {
                // å°±é‡ç½®å®ƒçš„ç‹€æ…‹ï¼Œå–æ¶ˆå›å¾©
                commentInput.placeholder = 'å‹å–„çš„è©•è«–æ˜¯äº¤æµçš„èµ·é»';
                delete commentInput.dataset.replyTo;
            }
        }
    });
    // â–²â–²â–² æ­¥é©Ÿ3.3é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œé»è²¼åˆ° init(); çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼
// ã€å…¨æ–°ã€‘ç‚ºæ™‚é–“æ„ŸçŸ¥é–‹é—œæ·»åŠ å³æ™‚äº¤äº’äº‹ä»¶
document.getElementById('time-perception-toggle').addEventListener('change', (e) => {
    const customTimeContainer = document.getElementById('custom-time-container');
    customTimeContainer.style.display = e.target.checked ? 'none' : 'block';
});
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
// è«‹ç”¨é€™æ®µæ–°ä»£ç¢¼æ›¿æ›ä¸Šé¢çš„éŒ¯èª¤ä»£ç¢¼
document.getElementById('char-heart-btn').addEventListener('click', openInnerVoiceModal);

document.getElementById('close-inner-voice-modal').addEventListener('click', () => {
    document.getElementById('inner-voice-modal').classList.remove('visible');
});
document.getElementById('inner-voice-history-btn').addEventListener('click', toggleInnerVoiceHistory);
document.getElementById('back-from-history-btn').addEventListener('click', toggleInnerVoiceHistory);
// â–²â–²â–² å¿ƒè²åŠŸèƒ½äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠä¸‹é¢é€™ä¸€æ•´å¡Šæ–°å‡½æ•¸ï¼Œé»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åŒ¯å‡ºç•¶å‰è§’è‰²çš„èŠå¤©è¨˜éŒ„
 */
async function exportChatHistory() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // 1. å‰µå»ºä¸€å€‹éš»åŒ…å«èŠå¤©è¨˜éŒ„å’Œè§’è‰²åçš„ç‰©ä»¶
    const exportData = {
        characterName: chat.name,
        exportedAt: new Date().toISOString(),
        history: chat.history
    };

    // 2. å°‡é€™å€‹ç‰©ä»¶è½‰æ›ç‚ºæ ¼å¼åŒ–çš„JSONå­—ä¸²
    const jsonString = JSON.stringify(exportData, null, 2);
    
    // 3. å‰µå»ºä¸€å€‹Blobç‰©ä»¶
    const blob = new Blob([jsonString], { type: 'application/json' });
    
    // 4. å‰µå»ºä¸€å€‹è‡¨æ™‚çš„ä¸‹è¼‰é€£çµ
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    
    // 5. è¨­ç½®ä¸‹è¼‰é€£çµçš„å±¬æ€§ï¼ŒåŒ…æ‹¬æª”æ¡ˆå
    const dateStr = new Date().toISOString().split('T')[0];
    link.href = url;
    link.download = `[${chat.name}]-èŠå¤©è¨˜éŒ„-${dateStr}.json`;
    
    // 6. æ¨¡æ“¬é»é¸é€£çµä¾†è§¸ç™¼ä¸‹è¼‰
    document.body.appendChild(link);
    link.click();
    
    // 7. æ¸…ç†è‡¨æ™‚å‰µå»ºçš„å…ƒç´ å’ŒURL
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    await showCustomAlert('åŒ¯å‡ºæˆåŠŸ', `èˆ‡â€œ${chat.name}â€çš„èŠå¤©è¨˜éŒ„å·²é–‹å§‹ä¸‹è¼‰ï¼`);
}

/**
 * ã€å…¨æ–°ã€‘å°å…¥èŠå¤©è¨˜éŒ„åˆ°ç•¶å‰è§’è‰²
 */
async function importChatHistory(file) {
    if (!file) return;
    if (!state.activeChatId) return;
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);

            // é—œéµé©—è­‰ï¼šæª¢æŸ¥å°å…¥çš„æª”æ˜¯å¦åŒ…å«ä¸€å€‹åç‚º 'history' çš„é™£åˆ—
            if (!data.history || !Array.isArray(data.history)) {
                throw new Error("æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘æœ‰æ•ˆçš„'history'è³‡æ–™ã€‚");
            }

            const chat = state.chats[state.activeChatId];
            
            // å®‰å…¨è­¦å‘Šï¼šæé†’ä½¿ç”¨è€…é€™å°‡è¦†è“‹ç¾æœ‰è¨˜éŒ„
            const confirmed = await showCustomConfirm(
                'ç¢ºèªå°å…¥',
                `é€™å°‡æœƒã€è¦†è“‹ã€‘ä½ èˆ‡â€œ${chat.name}â€çš„ç•¶å‰æ‰€æœ‰èŠå¤©è¨˜éŒ„ã€‚æ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`,
                { confirmButtonClass: 'btn-danger' }
            );

            if (confirmed) {
                // æ›¿æ›æ­·å²è¨˜éŒ„
                chat.history = data.history;
                // ä¿å­˜åˆ°è³‡æ–™åº«
                await db.chats.put(chat);
                // åˆ·æ–°ä»‹é¢
                renderChatInterface(state.activeChatId);
                renderChatList(); // åˆ·æ–°æ¸…å–®ä»¥æ›´æ–°æœ€å¾Œä¸€æ¢æ¶ˆæ¯
                await showCustomAlert('å°å…¥æˆåŠŸ', 'èŠå¤©è¨˜éŒ„å·²æˆåŠŸå°å…¥ä¸¦è¦†è“‹ï¼');
            }
        } catch (error) {
            console.error("å°å…¥èŠå¤©è¨˜éŒ„å¤±æ•—:", error);
            await showCustomAlert('å°å…¥å¤±æ•—', `ç„¡æ³•å°å…¥æª”ï¼Œè«‹æª¢æŸ¥æª”æ˜¯å¦ç‚ºæ­£ç¢ºçš„èŠå¤©è¨˜éŒ„å‚™ä»½æª”æ¡ˆã€‚\n\néŒ¯èª¤: ${error.message}`);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

// â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°£æ³¡æ¨£å¼é è¨­å°å…¥/åŒ¯å‡ºåŠŸèƒ½ â–¼â–¼â–¼

/**
 * åŒ¯å‡ºç•¶å‰é¸ä¸­çš„æ°£æ³¡æ¨£å¼é è¨­
 */
async function exportSelectedBubblePreset() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (!selectedId) {
        alert("è«‹å…ˆå¾ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹è¦åŒ¯å‡ºçš„é è¨­ã€‚");
        return;
    }

    const preset = await db.bubbleStylePresets.get(selectedId);
    if (!preset) {
        alert("æ‰¾ä¸åˆ°é¸ä¸­çš„é è¨­ã€‚");
        return;
    }

    // æº–å‚™è¦åŒ¯å‡ºçš„æ•¸æ“š
    const exportData = {
        presetName: preset.name,
        presetCss: preset.css
    };

    // å‰µå»ºä¸¦è§¸ç™¼ä¸‹è¼‰
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `[EPhoneæ°£æ³¡]${preset.name}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/**
 * è™•ç†å°å…¥çš„æ°£æ³¡æ¨£å¼é è¨­æª”
 * @param {File} file - ç”¨æˆ¶é¸æ“‡çš„.jsonæ–‡ä»¶
 */
function importBubblePreset(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            // é©—è­‰æª”å…§å®¹æ˜¯å¦æ­£ç¢º
            if (data.presetName && typeof data.presetCss !== 'undefined') {
                const newPreset = {
                    name: `${data.presetName} (å°å…¥)`,
                    css: data.presetCss
                };
                const newId = await db.bubbleStylePresets.add(newPreset);

                if (!state.bubbleStylePresets) state.bubbleStylePresets = [];
                state.bubbleStylePresets.push({ id: newId, ...newPreset });

                // åˆ·æ–°ä¸‹æ‹‰æ¸…å–®ä¸¦è‡ªå‹•é¸ä¸­æ–°å°å…¥çš„é è¨­
                renderBubblePresetSelector();
                document.getElementById('bubble-style-preset-select').value = newId;
                handlePresetSelectChange();
                await showCustomAlert('å°å…¥æˆåŠŸ', `æ°£æ³¡é è¨­ "${newPreset.name}" å·²æˆåŠŸå°å…¥ï¼`);
            } else {
                alert("å°å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚");
            }
        } catch (error) {
            alert(`å°å…¥å¤±æ•—ï¼šæª”è§£æéŒ¯èª¤ã€‚ ${error.message}`);
        }
    };
    reader.readAsText(file);
}

// â–²â–²â–² æ–°å¢åŠŸèƒ½å‡½æ•¸çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™ã€ä¸€æ•´å¡Šã€‘ä»£ç¢¼ï¼Œæ›¿æ›æ‰æ‰€æœ‰èˆŠçš„ã€å’Œå¾®åšç›¸é—œçš„äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

// â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä¸Šé¢é‚£æ®µèˆŠä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('weibo-app-icon').addEventListener('click', () => {
    renderWeiboProfile(); // æ¸²æŸ“å€‹äººè³‡æ–™
    renderMyWeiboFeed(); // <-- å°±æ˜¯æ–°å¢äº†é€™ä¸€è¡Œï¼ä¸»å‹•æ¸²æŸ“â€œæˆ‘çš„å¾®åšâ€åˆ—è¡¨
    switchToWeiboView('weibo-my-profile-view'); // é è¨­é¡¯ç¤ºâ€œæˆ‘çš„å¾®åšâ€
    showScreen('weibo-screen');
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// 2. ç¶å®šå¾®åšé é¢å…§çš„å„ç¨®é»æ“Šäº‹ä»¶ (ä½¿ç”¨äº‹ä»¶å§”è¨—)
document.getElementById('weibo-screen').addEventListener('click', async (e) => {
    // --- ã€å…¨æ–°ã€‘è™•ç†å¾®åšå¸–å­ä¸­é ­åƒé»æ“Šçš„é‚è¼¯ ---
    const avatarWrapper = e.target.closest('.weibo-post-avatar-clickable');
    if (avatarWrapper) {
        const charId = avatarWrapper.dataset.charId;
        // å¦‚æœé»æ“Šçš„ä¸æ˜¯ç”¨æˆ¶è‡ªå·±ï¼Œå°±æ‰“é–‹TAçš„ä¸»é 
        if (charId && charId !== 'user') {
            openWeiboCharProfile(charId);
        }
        return; // è™•ç†å®Œå°±çµæŸï¼Œä¸å†åŸ·è¡Œå¾Œé¢çš„é‚è¼¯
    }
    
    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
    const target = e.target;
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
            // â–¼â–¼â–¼ åœ¨ 'const target = e.target;' çš„ä¸‹ä¸€è¡Œï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

            // --- ã€å…¨æ–°ã€‘è™•ç†ç†±æœå’Œå»£å ´å¸–å­çš„åˆªé™¤æŒ‰éˆ• ---
            const deleteBtn = target.closest('.weibo-post-delete-btn');
            if (deleteBtn) {
                const postItem = deleteBtn.closest('.weibo-post-item');
                if (postItem) {
                    // å…ˆçµ¦ç”¨æˆ¶ä¸€å€‹ç¢ºèªçš„æ©Ÿæœƒï¼Œé˜²æ­¢èª¤åˆª
                    const confirmed = await showCustomConfirm(
                        'åˆªé™¤å‹•æ…‹',
                        'ç¢ºå®šè¦åˆªé™¤é€™æ¢å‹•æ…‹å—ï¼Ÿï¼ˆæ­¤æ“ä½œåƒ…åœ¨æœ¬é é¢ç”Ÿæ•ˆï¼‰',
                        { confirmButtonClass: 'btn-danger' }
                    );
                    
                    if (confirmed) {
                        // å¦‚æœç”¨æˆ¶ç¢ºèªï¼Œå°±æ’­æ”¾ä¸€å€‹å¥½çœ‹çš„æ¶ˆå¤±å‹•ç•«ï¼Œç„¶å¾Œç§»é™¤å¸–å­
                        postItem.style.transition = 'opacity 0.3s, transform 0.3s';
                        postItem.style.opacity = '0';
                        postItem.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            postItem.remove();
                        }, 300); // ç­‰å‹•ç•«æ’­æ”¾å®Œå†å¾¹åº•åˆªé™¤
                    }
                }
                return; // â˜…â˜…â˜… é—œéµï¼è™•ç†å®Œåˆªé™¤å¾Œï¼Œå¿…é ˆç«‹åˆ»çµæŸï¼Œé˜²æ­¢è§¸ç™¼ä¸‹é¢çš„å…¶ä»–é»æ“Šäº‹ä»¶
            }
            
            // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// ã€æ ¸å¿ƒä¿®å¾©ã€‘è™•ç†å¾®åšä¸­çš„â€œæ–‡å­—åœ–â€é»æ“Šäº‹ä»¶
if (target.classList.contains('weibo-post-image') && target.dataset.hiddenText) {
    showCustomAlert("åœ–ç‰‡å…§å®¹", target.dataset.hiddenText.replace(/<br>/g, '\n'));
    return; // è™•ç†å®Œå¾Œï¼Œç«‹åˆ»é€€å‡ºï¼Œé¿å…è§¸ç™¼å…¶ä»–é‚è¼¯
}
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

    const postItem = target.closest('.weibo-post-item');
    const postId = postItem ? parseInt(postItem.dataset.postId) : null;

    // --- è™•ç†â€œåˆªé™¤è©•è«–â€æŒ‰éˆ• ---
    const deleteCommentBtn = target.closest('.comment-delete-btn');
    if (deleteCommentBtn) {
        const commentItem = deleteCommentBtn.closest('.weibo-comment-item');
        if (postId && commentItem && commentItem.dataset.commentId) {
            deleteWeiboComment(postId, commentItem.dataset.commentId);
        }
        return;
    }

    // --- è™•ç†â€œç”Ÿæˆè©•è«–â€æŒ‰éˆ• ---
    const generateBtn = target.closest('.generate-comments-btn');
    if (generateBtn) {
        if (postId) {
            generateWeiboComments(postId);
        }
        return; 
    }

    // --- è™•ç†åº•éƒ¨å·¡è¦½åˆ—åˆ‡æ› ---
    const navItem = target.closest('.weibo-nav-item');
    if (navItem && navItem.dataset.view) {
        switchToWeiboView(navItem.dataset.view);
        return;
    }

// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ› â–¼â–¼â–¼

            const actionsBtn = target.closest('.post-actions-btn');
            if (actionsBtn) {
                // æ ¸å¿ƒä¿®æ­£1ï¼šå¾æŒ‰éˆ•æœ¬èº«ç²å–æ­£ç¢ºçš„ postId
                const postId = parseInt(actionsBtn.dataset.postId);

                const confirmed = await showCustomConfirm('åˆªé™¤å¾®åš', 'ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™æ¢å¾®åšå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚', { confirmButtonClass: 'btn-danger' });
                
                // æ ¸å¿ƒä¿®æ­£2ï¼šæª¢æŸ¥ postId æ˜¯å¦æ˜¯ä¸€å€‹æœ‰æ•ˆçš„æ•¸å­—
                if (confirmed && !isNaN(postId)) { 
                    await db.weiboPosts.delete(postId);
                    // åˆªé™¤å¾Œï¼Œåˆ·æ–°æ‰€æœ‰ç›¸é—œçš„å¾®åšåˆ—è¡¨å’Œå€‹äººè³‡æ–™
                    await renderMyWeiboFeed(); 
                    await renderFollowingWeiboFeed();
                    await renderWeiboProfile();
                    alert('å¾®åšå·²åˆªé™¤ã€‚');
                }
                return;
            }

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

    
    // --- è™•ç†é»è´Šã€è©•è«–ã€å›å¾© ---
    if (target.closest('.like-btn')) { if (postId) handleWeiboLike(postId); return; }
    if (target.closest('.weibo-comment-send-btn')) { const input = postItem.querySelector('.weibo-comment-input'); if (postId && input) handleWeiboComment(postId, input); return; }
    
    const commentItem = target.closest('.weibo-comment-item');
    if (commentItem) {
        const commenterName = commentItem.dataset.commenterName;
        const commentId = commentItem.dataset.commentId;
        const input = postItem.querySelector('.weibo-comment-input');
        if (input.dataset.replyToId === commentId) {
            input.placeholder = 'ç•™ä¸‹ä½ çš„ç²¾å½©è©•è«–å§...';
            delete input.dataset.replyToId; delete input.dataset.replyToNickname;
        } else {
            input.placeholder = `å›å¾© @${commenterName}:`;
            input.dataset.replyToId = commentId; input.dataset.replyToNickname = commenterName;
            input.focus();
        }
        return;
    }
});

// 3. ã€æ ¸å¿ƒã€‘ç‚ºå¾®åšå€‹äººä¸»é çš„æ‰€æœ‰å¯ç·¨è¼¯å…ƒç´ ï¼Œç¶å®šå°ˆå±¬çš„ç·¨è¼¯å‡½æ•¸
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€åŠŸèƒ½å¢å¼·ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ weibo-profile-page äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('weibo-profile-page').addEventListener('click', async (e) => {
    const target = e.target;
    
    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼ ---
    if (target.id === 'weibo-avatar-img' || target.closest('.weibo-avatar-container')) {
        // 1. å½ˆå‡ºä¸€å€‹é¸æ“‡åŠŸèƒ½è¡¨ï¼Œè®“ä½¿ç”¨è€…æ±ºå®šæ˜¯æ›é ­åƒé‚„æ˜¯æ›æ¡†
        const choice = await showChoiceModal("ç·¨è¼¯é ­åƒ", [
            { text: 'æ›´æ›é ­åƒåœ–ç‰‡', value: 'avatar' },
            { text: 'æ›´æ›é ­åƒæ¡†', value: 'frame' }
        ]);
        
        // 2. æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡ï¼ŒåŸ·è¡Œä¸åŒçš„æ“ä½œ
        if (choice === 'avatar') {
            editWeiboAvatar(); // èª¿ç”¨åŸä¾†çš„æ›´æ›é ­åƒå‡½æ•¸
        } else if (choice === 'frame') {
            openFrameSelectorModal('weibo_profile'); // èª¿ç”¨æˆ‘å€‘æ–°å¢çš„æ›´æ›é ­åƒæ¡†å‡½æ•¸
        }
        return; // è™•ç†å®Œå¾Œç›´æ¥é€€å‡º
    } 
    // --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    else if (target.id === 'weibo-nickname') {
        editWeiboNickname();
    } 
    else if (target.id === 'weibo-user-profession-display') {
        openWeiboUserSettingsModal();
    } 
    else if (target.id === 'weibo-background-img') {
        editWeiboBackground();
    } else if (target.closest('#weibo-fans-item')) {
        editWeiboFansCount();
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// 4. ã€æ ¸å¿ƒã€‘ç‚ºâ€œé—œæ³¨â€æ•¸å­—å’Œâ€œç™¼ä½ˆå¾®åšâ€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('weibo-following-btn').addEventListener('click', showFollowingList);
document.getElementById('create-weibo-post-btn').addEventListener('click', openWeiboPublisherClean);
document.getElementById('close-following-list-btn').addEventListener('click', () => {
    document.getElementById('weibo-following-modal').classList.remove('visible');
});
document.getElementById('clear-following-feed-btn').addEventListener('click', clearFollowingFeed);

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²éš±è—å¯è¦‹ç¯„åœã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ openWeiboPublisherClean å‡½æ•¸ â–¼â–¼â–¼
function openWeiboPublisherClean() {
    // 1. é‡ç½®ä¸¦ç²å–æ¨¡æ…‹æ¡†
    resetCreatePostModal(); 
    const modal = document.getElementById('create-post-modal');
    
    // 2. è¨­ç½®ç‚ºâ€œå¾®åšâ€æ¨¡å¼ï¼Œä¸¦ä¿®æ”¹æ¨™é¡Œå’Œæç¤ºèª
    modal.dataset.mode = 'weibo';
    document.getElementById('create-post-modal-title').textContent = 'ç™¼å¾®åš';
    document.getElementById('post-public-text').placeholder = 'æœ‰ä»€éº¼æ–°é®®äº‹æƒ³åˆ†äº«çµ¦å¤§å®¶ï¼Ÿ';

    // 3. ç¢ºä¿æ‰€æœ‰â€œå‹•æ…‹â€å°ˆå±¬çš„HTMLå…ƒç´ éƒ½è¢«éš±è—
    const imageDescGroup = document.getElementById('post-image-desc-group');
    if (imageDescGroup) imageDescGroup.style.display = 'none';
    
    const commentsToggleGroup = document.getElementById('post-comments-toggle-group');
    if (commentsToggleGroup) commentsToggleGroup.style.display = 'none';

    // â–¼â–¼â–¼ å°±æ˜¯åœ¨é€™è£¡æ–°å¢äº†ä¸€è¡Œä»£ç¢¼ï¼â–¼â–¼â–¼
    const visibilityGroup = document.getElementById('post-visibility-group');
    if (visibilityGroup) visibilityGroup.style.display = 'none';
    // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

    // 4. é¡¯ç¤ºå¾®åšéœ€è¦çš„æ§åˆ¶é …
    const modeSwitcher = document.getElementById('post-mode-switcher');
    if (modeSwitcher) modeSwitcher.style.display = 'flex';
    
    // 5. é¡¯ç¤ºå½ˆçª—
    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


document.getElementById('close-following-list-btn').addEventListener('click', () => {
    document.getElementById('weibo-following-modal').classList.remove('visible');
});
document.getElementById('clear-following-feed-btn').addEventListener('click', clearFollowingFeed);

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ `editWeiboProfileBtn` äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
    // ã€å…¨æ–°ã€‘å¾®åšç”¨æˆ¶äººè¨­è¨­ç½®åŠŸèƒ½äº‹ä»¶ç¶å®š
    document.getElementById('edit-weibo-profile-btn').addEventListener('click', openWeiboUserSettingsModal);
    document.getElementById('cancel-weibo-user-settings-btn').addEventListener('click', () => {
        document.getElementById('weibo-user-settings-modal').classList.remove('visible');
    });
    document.getElementById('save-weibo-user-settings-btn').addEventListener('click', saveWeiboUserSettings);
    document.getElementById('weibo-user-preset-select').addEventListener('change', handleWeiboUserPresetSelection);
    document.getElementById('manage-weibo-user-presets-btn').addEventListener('click', openWeiboUserPresetManager);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«–å£‡åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

// 1. åˆå§‹åŒ–æ™‚å‰µå»ºé»˜èªå°çµ„
await initializeDefaultGroups();

// 2. ç•¶ä½¿ç”¨è€…é»æ“Šâ€œåœˆå­â€Appåœ–ç¤ºæ™‚ï¼Œæ¸²æŸ“å°çµ„æ¸…å–®
document.querySelector('.desktop-app-icon[onclick="showScreen(\'forum-screen\')"]').addEventListener('click', renderForumScreen);

// 3. ç¶å®šå°çµ„é å’Œå¸–å­é çš„è¿”å›æŒ‰éˆ•
document.getElementById('back-to-forum-list').addEventListener('click', () => showScreen('forum-screen'));
document.getElementById('back-to-group-screen').addEventListener('click', () => openGroup(activeGroupId, document.getElementById('group-screen-title').textContent));

// 4. ç¶å®šå¸–å­è©•è«–å€çš„ç™¼é€æŒ‰éˆ•
document.getElementById('send-post-comment-btn').addEventListener('click', handleAddComment);

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸ä¸­ï¼Œç”¨ä¸‹é¢ã€é€™å…©è¡Œã€‘æ›¿æ›èˆŠçš„ generate-fanfic-btn ç›£è½å™¨ â–¼â–¼â–¼
// ç¶å®šåŒäººæ–‡å°çµ„åå¥½é¸æ“‡å™¨è£¡çš„â€œç”Ÿæˆâ€æŒ‰éˆ•
document.getElementById('trigger-fanfic-generation-btn').addEventListener('click', generateFanfic);
// ç¶å®šæ‰€æœ‰å°çµ„é ­éƒ¨é€šç”¨çš„â€œç”Ÿæˆâ€æŒ‰éˆ•
document.getElementById('generate-group-content-btn').addEventListener('click', handleGenerateGroupContent);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// 6. ç¶å®šå¸–å­è©³æƒ…é çš„â€œè½‰è¼‰â€æŒ‰éˆ•
document.getElementById('repost-to-chat-btn').addEventListener('click', repostToChat);

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸ä¸­ï¼Œç”¨ã€é€™ä¸€è¡Œã€‘æ›¿æ›èˆŠçš„ create-group-btn ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('create-group-btn').addEventListener('click', openGroupCreator);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ› â–¼â–¼â–¼
document.getElementById('create-forum-post-btn').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘ä¸å†å½ˆçª—æç¤ºï¼Œè€Œæ˜¯èª¿ç”¨ä¸€å€‹æ–°å‡½æ•¸ä¾†æ‰“é–‹çœŸæ­£çš„ç™¼å¸–è¦–çª—
    openCreateForumPostModal(); 
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼ä¸‹é¢é€™å¡Šã€æ–°ä»£ç¢¼ã€‘ â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºå¸–å­è©³æƒ…é çš„â€œç”Ÿæˆè©•è«–â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('post-detail-content').addEventListener('click', (e) => {
    if (e.target.id === 'generate-forum-comments-btn') {
        generateForumComments();
    }
});

// åœ¨ç”¨æˆ¶æ‰‹å‹•è¼¸å…¥è©•è«–å¾Œï¼Œå¦‚æœè¼¸å…¥æ¡†ç‚ºç©ºå°±å¤±å»ç„¦é»æ™‚ï¼Œè‡ªå‹•å–æ¶ˆå›å¾©ç‹€æ…‹
document.getElementById('post-comment-input').addEventListener('blur', (e) => {
    const input = e.target;
    if (input.value.trim() === '') {
        input.placeholder = 'ç™¼ä½ˆä½ çš„è©•è«–...';
        delete input.dataset.replyTo;
    }
});
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºæ‰€æœ‰è½‰è¼‰çš„å¸–å­å¡ç‰‡æ·»åŠ é»æ“Šäº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const repostCard = e.target.closest('.link-share-card[data-post-id]');
    if (repostCard) {
        const postId = parseInt(repostCard.dataset.postId);
        if (!isNaN(postId)) {
            // èª¿ç”¨ä½ å·²ç¶“å¯«å¥½çš„â€œæ‰“é–‹å¸–å­â€å‡½æ•¸
            openPost(postId);
        }
    }
});

// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«–å£‡å¸–å­åˆ—è¡¨äº‹ä»¶å§”è¨— â–¼â–¼â–¼
document.getElementById('group-post-list').addEventListener('click', async (e) => {
    const postItem = e.target.closest('.forum-post-item');
    if (!postItem) return;

    // æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯åˆªé™¤æŒ‰éˆ•
    if (e.target.classList.contains('forum-post-delete-btn')) {
        const postId = postItem.dataset.postId;
        if (!postId) return;
        
        const post = await db.forumPosts.get(parseInt(postId));
        if (!post) return;

        const confirmed = await showCustomConfirm(
            'åˆªé™¤å¸–å­', 
            `ç¢ºå®šè¦åˆªé™¤å¸–å­ã€Š${post.title}ã€‹å—ï¼Ÿæ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤å¸–å­ä¸‹çš„æ‰€æœ‰è©•è«–ï¼Œä¸”ç„¡æ³•æ¢å¾©ã€‚`, 
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            try {
                // ä½¿ç”¨è³‡æ–™åº«äº‹å‹™ä¾†ç¢ºä¿å¸–å­å’Œè©•è«–è¢«åŒæ™‚åˆªé™¤
                await db.transaction('rw', db.forumPosts, db.forumComments, async () => {
                    // 1. åˆªé™¤æ‰€æœ‰èˆ‡è©²å¸–å­é—œè¯çš„è©•è«–
                    await db.forumComments.where('postId').equals(parseInt(postId)).delete();
                    // 2. åˆªé™¤å¸–å­æœ¬èº«
                    await db.forumPosts.delete(parseInt(postId));
                });

                await showCustomAlert('åˆªé™¤æˆåŠŸ', 'å¸–å­åŠå…¶æ‰€æœ‰è©•è«–å·²è¢«åˆªé™¤ã€‚');
                // åˆ·æ–°å¸–å­åˆ—è¡¨
                await renderGroupPosts(activeGroupId);
            } catch (error) {
                console.error('åˆªé™¤å¸–å­å¤±æ•—:', error);
                await showCustomAlert('åˆªé™¤å¤±æ•—', `æ“ä½œå¤±æ•—: ${error.message}`);
            }
        }
    } else {
        // å¦‚æœé»æ“Šçš„ä¸æ˜¯åˆªé™¤æŒ‰éˆ•ï¼Œé‚£å°±æ˜¯é»æ“Šäº†å¸–å­æœ¬èº«ï¼ŒåŸ·è¡Œè·³è½‰é‚è¼¯
        const postId = postItem.dataset.postId;
        if (postId) {
            openPost(parseInt(postId));
        }
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­/å°çµ„é«˜ç´šåŠŸèƒ½äº‹ä»¶ç›£è½ â–¼â–¼â–¼

// 1. ç‚ºâ€œåœˆå­â€ä¸»é å³ä¸Šè§’çš„â€œ+â€æŒ‰éˆ•ï¼Œç¶å®šå‰µå»ºå°çµ„çš„äº‹ä»¶
document.getElementById('create-group-btn').addEventListener('click', openGroupCreator);

// 2. ç‚ºå°çµ„ç·¨è¼¯å™¨å½ˆçª—çš„â€œä¿å­˜â€å’Œâ€œå–æ¶ˆâ€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('save-group-editor-btn').addEventListener('click', saveGroupSettings);
document.getElementById('cancel-group-editor-btn').addEventListener('click', () => {
    document.getElementById('forum-group-editor-modal').classList.remove('visible');
});

// 3. ç‚ºåˆ†é¡ç®¡ç†å½ˆçª—çš„æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('add-new-forum-category-btn').addEventListener('click', addNewForumCategory);
document.getElementById('close-forum-category-manager-btn').addEventListener('click', () => {
    document.getElementById('forum-category-manager-modal').classList.remove('visible');
});

// 4. ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºåˆ†é¡æ¸…å–®ä¸­çš„â€œåˆªé™¤â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('existing-forum-categories-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) { // è¤‡ç”¨æ¨£å¼
        const categoryId = parseInt(e.target.dataset.id);
        deleteForumCategory(categoryId);
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²


// â–²â–²â–² è«–å£‡äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ä»£ç¢¼ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„æœ«å°¾ï¼Œå°±åœ¨ init(); çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

// --- å¡”ç¾…ç‰Œå åœåŠŸèƒ½äº‹ä»¶ç¶å®š ---
document.getElementById('open-tarot-btn').addEventListener('click', openTarotModal);
document.getElementById('close-tarot-modal-btn').addEventListener('click', () => {
    document.getElementById('tarot-divination-modal').classList.remove('visible');
});
document.getElementById('draw-tarot-cards-btn').addEventListener('click', handleDrawCards);
document.getElementById('back-to-tarot-setup-btn').addEventListener('click', () => {
    document.getElementById('tarot-result-view').style.display = 'none';
    document.getElementById('tarot-setup-view').style.display = 'block';
});
document.getElementById('send-tarot-result-btn').addEventListener('click', sendTarotReadingToChat);
document.getElementById('tarot-history-btn').addEventListener('click', openTarotHistory);
document.getElementById('back-to-tarot-main-btn').addEventListener('click', () => {
    document.getElementById('tarot-history-view').style.display = 'none';
    document.getElementById('tarot-setup-view').style.display = 'block';
});
// ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†æ­·å²è¨˜éŒ„çš„åˆªé™¤æŒ‰éˆ•
document.getElementById('tarot-history-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('tarot-history-delete-btn')) {
        const readingId = parseInt(e.target.dataset.id);
        if (!isNaN(readingId)) {
            deleteTarotReading(readingId);
        }
    }
});

// --- å¡”ç¾…ç‰Œå åœåŠŸèƒ½äº‹ä»¶ç¶å®šçµæŸ ---

// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
// â–¼â–¼â–¼ ç¬¬3æ­¥.3ï¼šåœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('ls-change-bg-btn').addEventListener('click', handleChangeLoversSpaceBackground);
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// ç¶å®šä¸»è¢å¹•Appåœ–ç¤ºçš„é»æ“Šäº‹ä»¶
document.getElementById('lovers-space-app-icon').addEventListener('click', openLoversSpaceEntry);

// â–¼â–¼â–¼ ç”¨é€™å¡Šä»£ç¢¼æ›¿æ› â–¼â–¼â–¼
document.getElementById('ls-char-selector-list').addEventListener('click', async (e) => {
    const item = e.target.closest('.chat-list-item');
    if (item && item.dataset.chatId) {
        const chatId = item.dataset.chatId;
        const chat = state.chats[chatId];
        
        // é—œé–‰é¸æ“‡å½ˆçª—
        document.getElementById('ls-char-selector-modal').classList.remove('visible');
        
        // ã€æ ¸å¿ƒé‚è¼¯ã€‘åˆ¤æ–·æƒ…ä¾¶ç©ºé–“ç‹€æ…‹
        if (chat.loversSpaceData) {
            // å¦‚æœå·²é–‹é€šï¼Œç›´æ¥é€²å…¥
            openLoversSpace(chatId);
        } else {
            // å¦‚æœæœªé–‹é€šï¼Œå½ˆçª—ç¢ºèªæ˜¯å¦ç™¼é€é‚€è«‹
            const confirmed = await showCustomConfirm(
                'é‚€è«‹é–‹å•Ÿæƒ…ä¾¶ç©ºé–“',
                `ä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾¶ç©ºé–“é‚„æœªé–‹å•Ÿï¼Œè¦ç¾åœ¨é‚€è«‹Taå—ï¼Ÿ`
            );
            if (confirmed) {
                // å¦‚æœç”¨æˆ¶ç¢ºèªï¼Œç™¼é€é‚€è«‹ä¸¦è·³è½‰åˆ°èŠå¤©ä»‹é¢
                await sendLoversSpaceInvitation(chatId);
                openChat(chatId);
            }
        }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

document.getElementById('ls-cancel-switch-char-btn').addEventListener('click', () => {
    document.getElementById('ls-char-selector-modal').classList.remove('visible');
});
document.getElementById('ls-switch-char-btn').addEventListener('click', openCharSelectorForLoversSpace);

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€ä¿®å¾©å¾Œã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ 'ls-tab-bar' äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
// ç¶å®šé ç°½åˆ‡æ›äº‹ä»¶
document.getElementById('ls-tab-bar').addEventListener('click', (e) => {
    const tab = e.target.closest('.ls-tab-item');
    if (tab && tab.dataset.view) {
        const viewId = tab.dataset.view;
        // 1. åˆ‡æ›é«˜äº®å’Œè¦–åœ–
        document.querySelectorAll('.ls-tab-item').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        switchLoversSpaceTab(viewId);

        // 2. ã€æ ¸å¿ƒä¿®å¾©ã€‘æ ¹æ“šé»æ“Šçš„é ç°½ï¼Œæ¸²æŸ“å°æ‡‰çš„å…§å®¹
        const chat = state.chats[activeLoversSpaceCharId];
        if (!chat) return;

        if (viewId === 'ls-moments-view') {
            renderLSMoments(chat.loversSpaceData.moments, chat);
        } else if (viewId === 'ls-album-view') {
            renderLSPhotos(chat.loversSpaceData.photos, chat);
        } else if (viewId === 'ls-letters-view') {
            renderLSLetters(chat.loversSpaceData.loveLetters, chat);
        } else if (viewId === 'ls-questions-view') {
            // é€™å°±æ˜¯æˆ‘å€‘æ–°å¢çš„é‚è¼¯ï¼
            renderLSQuestions(chat.loversSpaceData.questions, chat);    
        }
        else if (viewId === 'ls-diary-view') {
    const now = new Date();
    renderLSDiaryView(now.getFullYear(), now.getMonth() + 1);
}
    else if (viewId === 'ls-shares-view') {
        renderLSShares(chat.loversSpaceData.shares, chat);
    }
    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™3è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
    else if (viewId === 'ls-pomodoro-view') {
        openPomodoroScreen();
    }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// ç¶å®šâ€œèªªèªªâ€åŠŸèƒ½çš„æŒ‰éˆ•
document.getElementById('ls-add-moment-btn').addEventListener('click', openMomentCreator);
document.getElementById('ls-cancel-moment-btn').addEventListener('click', () => {
    document.getElementById('ls-create-moment-modal').classList.remove('visible');
});
document.getElementById('ls-confirm-moment-btn').addEventListener('click', handlePostMoment);

// ç¶å®šâ€œç›¸å†Šâ€åŠŸèƒ½çš„æŒ‰éˆ•
document.getElementById('ls-add-album-btn').addEventListener('click', openAlbumCreator);
document.getElementById('ls-select-photos-btn').addEventListener('click', () => {
    document.getElementById('ls-photo-input').click();
});
document.getElementById('ls-photo-input').addEventListener('change', (e) => {
    handlePhotoSelection(e.target.files);
});
// ç¶å®šæ–°å½ˆçª—è£¡çš„æ¨¡å¼åˆ‡æ›æŒ‰éˆ•
const lsImageModeBtn = document.getElementById('ls-switch-to-image-mode');
const lsTextImageModeBtn = document.getElementById('ls-switch-to-text-image-mode');
const lsImageModeContent = document.getElementById('ls-image-mode-content');
const lsTextImageModeContent = document.getElementById('ls-text-image-mode-content');
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä¸Šé¢é‚£æ®µéŒ¯èª¤çš„ä»£ç¢¼ â–¼â–¼â–¼
lsImageModeBtn.addEventListener('click', () => {
    lsImageModeBtn.classList.add('active');
    lsTextImageModeBtn.classList.remove('active');
    // æ–°å¢ä¸‹é¢é€™å…©è¡Œï¼Œé€™æ‰æ˜¯é—œéµï¼
    lsImageModeContent.classList.add('active');
    lsTextImageModeContent.classList.remove('active');
    // èˆŠçš„æ¨£å¼æ§åˆ¶ä¹Ÿä¿ç•™ï¼Œç¢ºä¿è¬ç„¡ä¸€å¤±
    lsImageModeContent.style.display = 'block';
    lsTextImageModeContent.style.display = 'none';
});

lsTextImageModeBtn.addEventListener('click', () => {
    lsTextImageModeBtn.classList.add('active');
    lsImageModeBtn.classList.remove('active');
    // æ–°å¢ä¸‹é¢é€™å…©è¡Œï¼Œé€™æ‰æ˜¯é—œéµï¼
    lsTextImageModeContent.classList.add('active');
    lsImageModeContent.classList.remove('active');
    // èˆŠçš„æ¨£å¼æ§åˆ¶ä¹Ÿä¿ç•™ï¼Œç¢ºä¿è¬ç„¡ä¸€å¤±
    lsTextImageModeContent.style.display = 'block';
    lsImageModeContent.style.display = 'none';
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

 document.getElementById('ls-cancel-album-btn').addEventListener('click', () => {
    document.getElementById('ls-create-album-modal').classList.remove('visible');
});
 document.getElementById('ls-confirm-album-btn').addEventListener('click', handleConfirmAlbum);
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“è¨­ç½®åŠŸèƒ½äº‹ä»¶ç›£è½ â–¼â–¼â–¼
document.getElementById('ls-settings-btn').addEventListener('click', () => {
    const chat = state.chats[activeLoversSpaceCharId];
    if (chat && chat.loversSpaceData) {
        // å°‡å·²ä¿å­˜çš„æ—¥æœŸè¼‰å…¥åˆ°è¼¸å…¥æ¡†ä¸­
        document.getElementById('ls-start-date-input').value = chat.loversSpaceData.relationshipStartDate || '';
    }
    document.getElementById('ls-settings-modal').classList.add('visible');
});

document.getElementById('ls-settings-cancel-btn').addEventListener('click', () => {
    document.getElementById('ls-settings-modal').classList.remove('visible');
});

document.getElementById('ls-settings-save-btn').addEventListener('click', async () => {
    const chat = state.chats[activeLoversSpaceCharId];
    if (!chat) return;

    const newDate = document.getElementById('ls-start-date-input').value;
    chat.loversSpaceData.relationshipStartDate = newDate;
    
    await db.chats.put(chat); // ä¿å­˜åˆ°è³‡æ–™åº«
    
    // é‡æ–°æ¸²æŸ“æ•´å€‹ç©ºé–“ä»¥é¡¯ç¤ºæ›´æ–°
    await renderLoversSpace(chat);

    document.getElementById('ls-settings-modal').classList.remove('visible');
    alert('ç´€å¿µæ—¥å·²ä¿å­˜ï¼');
});
// â–²â–²â–² äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™æ®µæ–°ä»£ç¢¼é»è²¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸ â–¼â–¼â–¼

// ã€æƒ…ä¾¶ç©ºé–“ç›¸å†Šã€‘äº‹ä»¶ç›£è½
document.getElementById('ls-album-list').addEventListener('click', (e) => {
    const item = e.target.closest('.ls-album-item');
    if (!item) return;

    const timestamp = parseInt(item.dataset.timestamp);
    if (isNaN(timestamp)) return;
    
    // æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯åˆªé™¤æŒ‰éˆ•
    if (e.target.classList.contains('ls-photo-delete-btn')) {
        handleDeleteLSPhoto(timestamp);
    } else {
        // å¦å‰‡ï¼Œå°±æ˜¯é»æ“Šäº†åœ–ç‰‡æœ¬èº«ï¼ŒåŸ·è¡ŒæŸ¥çœ‹æè¿°çš„é‚è¼¯
        const chat = state.chats[activeLoversSpaceCharId];
        if (chat && chat.loversSpaceData && chat.loversSpaceData.photos) {
            const photo = chat.loversSpaceData.photos.find(p => p.timestamp === timestamp);
            if (photo) {
                showCustomAlert(`ç…§ç‰‡æè¿° (${formatPostTimestamp(photo.timestamp)})`, photo.description);
            }
        }
    }
});
// â–²â–²â–² äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“èªªèªªäº’å‹•åŠŸèƒ½äº‹ä»¶ç›£è½ â–¼â–¼â–¼
document.getElementById('ls-moments-list').addEventListener('click', async (e) => {
    const target = e.target;
    const momentCard = target.closest('.ls-moment-card');
    if (!momentCard) return;

    // 1. ã€æ ¸å¿ƒã€‘å¾è¢«é»æ“Šçš„å¡ç‰‡ä¸Šç²å–æ­£ç¢ºçš„ç´¢å¼•
    const momentIndex = parseInt(momentCard.dataset.momentIndex);
    const chat = state.chats[activeLoversSpaceCharId];
    // å®‰å…¨æª¢æŸ¥ï¼Œç¢ºä¿èƒ½æ‰¾åˆ°å°æ‡‰çš„è³‡æ–™
    if (!chat || !chat.loversSpaceData || !chat.loversSpaceData.moments[momentIndex]) return;
    
    const moment = chat.loversSpaceData.moments[momentIndex];

    // --- è™•ç†â€œç™¼é€è©•è«–â€æŒ‰éˆ• ---
    if (target.classList.contains('ls-comment-send-btn')) {
        const input = momentCard.querySelector('.ls-comment-input-area input');
        const commentText = input.value.trim();
        if (!commentText) {
            alert("è©•è«–å…§å®¹ä¸èƒ½ç‚ºç©ºï¼");
            return;
        }

        const newComment = {
            author: chat.settings.myNickname || 'æˆ‘',
            text: commentText
        };
        
        if (!moment.comments) {
            moment.comments = [];
        }
        moment.comments.push(newComment);
        
        await db.chats.put(chat); // ä¿å­˜åˆ°è³‡æ–™åº«
        renderLSMoments(chat.loversSpaceData.moments, chat); // åˆ·æ–°ä»‹é¢
    }

    // --- 2. ã€æ ¸å¿ƒã€‘è™•ç†â€œåˆªé™¤èªªèªªâ€æŒ‰éˆ• ---
    if (target.classList.contains('ls-moment-delete-btn')) {
        const confirmed = await showCustomConfirm('åˆªé™¤èªªèªª', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢èªªèªªå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            // 2. ã€æ ¸å¿ƒã€‘ä½¿ç”¨æˆ‘å€‘å‰›å‰›ç²å–çš„ã€çµ•å°æ­£ç¢ºçš„ momentIndex ä¾†åˆªé™¤é™£åˆ—ä¸­çš„å…ƒç´ 
            chat.loversSpaceData.moments.splice(momentIndex, 1);
            await db.chats.put(chat);
            renderLSMoments(chat.loversSpaceData.moments, chat);
        }
    }

    // --- 3. è™•ç†â€œåˆªé™¤è©•è«–â€æŒ‰éˆ• ---
    if (target.classList.contains('ls-comment-delete-btn')) {
        const commentIndex = parseInt(target.dataset.commentIndex);
        const confirmed = await showCustomConfirm('åˆªé™¤è©•è«–', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢è©•è«–å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            moment.comments.splice(commentIndex, 1);
            await db.chats.put(chat);
            renderLSMoments(chat.loversSpaceData.moments, chat);
        }
    }
});

/* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ä»£ç¢¼ï¼Œé»è²¼åˆ° // â–²â–²â–² æƒ…ä¾¶ç©ºé–“äº‹ä»¶ç›£è½çµæŸ â–²â–²â–² çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ */

// --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“æƒ…æ›¸åŠŸèƒ½äº‹ä»¶ç›£è½ ---

// 1. ç¶å®šâ€œå¯«æƒ…æ›¸â€çš„æµ®å‹•æŒ‰éˆ•
document.getElementById('ls-add-letter-btn').addEventListener('click', () => openLoveLetterEditor());

// 2. ç¶å®šå¯«ä¿¡å½ˆçª—çš„â€œå–æ¶ˆâ€å’Œâ€œå¯„å‡ºâ€æŒ‰éˆ•
document.getElementById('ls-cancel-letter-btn').addEventListener('click', () => {
    document.getElementById('ls-create-letter-modal').classList.remove('visible');
});
document.getElementById('ls-confirm-letter-btn').addEventListener('click', handlePostLoveLetter);

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€åŠŸèƒ½æ›´å¼·å¤§çš„ã€‘ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ ls-letters-list äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
// ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºæƒ…æ›¸æ¸…å–®ä¸­çš„æ‰€æœ‰å¡ç‰‡å’ŒæŒ‰éˆ•ç¶å®šé»æ“Šäº‹ä»¶
document.getElementById('ls-letters-list').addEventListener('click', async (e) => {
    const letterItem = e.target.closest('.ls-love-letter-item');
    if (!letterItem) return;

    // æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯åˆªé™¤æŒ‰éˆ•
    if (e.target.classList.contains('ls-letter-delete-btn')) {
        const letterId = letterItem.dataset.letterId;
        const chat = state.chats[activeLoversSpaceCharId];
        const letter = chat.loversSpaceData.loveLetters.find(l => l.id === letterId);
        
        const confirmed = await showCustomConfirm(
            'åˆªé™¤æƒ…æ›¸',
            `ç¢ºå®šè¦åˆªé™¤é€™å°å¯«çµ¦â€œ${letter.recipientName}â€çš„æƒ…æ›¸å—ï¼Ÿ`,
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            chat.loversSpaceData.loveLetters = chat.loversSpaceData.loveLetters.filter(l => l.id !== letterId);
            await db.chats.put(chat);
            renderLSLetters(chat.loversSpaceData.loveLetters, chat);
            alert('æƒ…æ›¸å·²åˆªé™¤ã€‚');
        }
    } 
    // å¦å‰‡ï¼Œå°±æ˜¯é»æ“Šäº†å¡ç‰‡æœ¬èº«ï¼ŒåŸ·è¡ŒæŸ¥çœ‹è©³æƒ…çš„é‚è¼¯
    else if (letterItem.dataset.letterId) {
        showLoveLetterDetail(letterItem.dataset.letterId);
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/* â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠé€™æ®µæ–°ä»£ç¢¼é»è²¼åˆ° // â–²â–²â–² æƒ…ä¾¶ç©ºé–“äº‹ä»¶ç›£è½çµæŸ â–²â–²â–² çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ */

// --- ã€å…¨æ–°ã€‘æƒ…æ›¸æª¢è¦–å™¨æŒ‰éˆ•äº‹ä»¶ç›£è½ ---
document.getElementById('ls-close-letter-viewer-btn').addEventListener('click', () => {
    document.getElementById('ls-letter-viewer-modal').classList.remove('visible');
    activeLoveLetter = null; // é—œé–‰æ™‚æ¸…ç†æš«å­˜çš„è³‡æ–™
});

document.getElementById('ls-reply-letter-btn').addEventListener('click', () => {
    // å…ˆé—œé–‰æª¢è¦–å™¨
    document.getElementById('ls-letter-viewer-modal').classList.remove('visible');
    // ç„¶å¾Œæ‰“é–‹å›å¾©ç·¨è¼¯å™¨
    if (activeLoveLetter) {
        openLoveLetterEditor(activeLoveLetter);
    }
    activeLoveLetter = null; // æ¸…ç†
});

/* â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² */
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ä»£ç¢¼ï¼Œé»è²¼åˆ° // â–²â–²â–² æƒ…ä¾¶ç©ºé–“äº‹ä»¶ç›£è½çµæŸ â–²â–²â–² çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æƒ…ä¾¶æå•åŠŸèƒ½äº‹ä»¶ç›£è½ --- */

// 1. ç¶å®šâ€œæå•â€çš„æµ®å‹•æŒ‰éˆ•
document.getElementById('ls-add-question-btn').addEventListener('click', openQuestionAsker);

// 2. ç¶å®šæå•å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('ls-cancel-ask-btn').addEventListener('click', () => {
    document.getElementById('ls-ask-question-modal').classList.remove('visible');
});
document.getElementById('ls-confirm-ask-btn').addEventListener('click', handlePostQuestion);

// 3. ç¶å®šå›ç­”å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('ls-cancel-answer-btn').addEventListener('click', () => {
    document.getElementById('ls-answer-question-modal').classList.remove('visible');
});
document.getElementById('ls-confirm-answer-btn').addEventListener('click', handlePostAnswer);

// 4. ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºæ‰€æœ‰â€œå›ç­”â€å’Œâ€œåˆªé™¤â€æŒ‰éˆ•ç¶å®šé»æ“Šäº‹ä»¶
document.getElementById('ls-questions-list').addEventListener('click', (e) => {
    // é€™æ˜¯ä½ å·²æœ‰çš„è™•ç†â€œå›ç­”â€æŒ‰éˆ•çš„é‚è¼¯
    if (e.target.classList.contains('ls-answer-btn')) {
        const questionId = e.target.dataset.questionId;
        if (questionId) {
            openAnswerEditor(questionId);
        }
    }

    // â–¼â–¼â–¼ é€™æ˜¯æˆ‘å€‘æ–°åŠ çš„è™•ç†â€œåˆªé™¤â€æŒ‰éˆ•çš„é‚è¼¯ â–¼â–¼â–¼
    if (e.target.classList.contains('ls-question-delete-btn')) {
        const questionId = e.target.dataset.questionId;
        if (questionId) {
            handleDeleteLSQuestion(questionId);
        }
    }
    // â–²â–²â–² æ–°å¢é‚è¼¯çµæŸ â–²â–²â–²
});


/* --- æƒ…ä¾¶æå•äº‹ä»¶ç›£è½çµæŸ --- */

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“å°ˆå±¬æ’­æ”¾æ©Ÿäº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

// 1. ç›£è½ä¸»æ’­æ”¾æ©Ÿå…§çš„æ‰€æœ‰æŒ‰éˆ•
document.getElementById('ls-close-player-btn').addEventListener('click', () => {
    document.getElementById('ls-music-player-overlay').classList.remove('visible');
});
document.getElementById('ls-playlist-btn').addEventListener('click', () => {
    renderLSMusicPlaylist();
    document.getElementById('ls-music-playlist-panel').classList.add('visible');
});
document.getElementById('ls-play-pause-btn').addEventListener('click', toggleLSMusicPlayPause);
document.getElementById('ls-next-btn').addEventListener('click', playNextLSSong);
document.getElementById('ls-prev-btn').addEventListener('click', playPrevLSSong);

// 2. ç›£è½æ’­æ”¾æ¸…å–®é¢æ¿å…§çš„æ‰€æœ‰æŒ‰éˆ•
document.getElementById('ls-close-playlist-btn').addEventListener('click', () => {
    document.getElementById('ls-music-playlist-panel').classList.remove('visible');
});
document.getElementById('ls-clear-playlist-btn').addEventListener('click', async () => {
    const confirmed = await showCustomConfirm('æ¸…ç©ºåˆ—è¡¨', 'ç¢ºå®šè¦æ¸…ç©ºæƒ…ä¾¶ç©ºé–“çš„æ’­æ”¾æ¸…å–®å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        clearLSMusicPlaylist();
    }
});
document.getElementById('ls-playlist-body').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-track-btn')) {
        const index = parseInt(e.target.dataset.index);
        lsMusicState.playlist.splice(index, 1);
        
        // å¦‚æœåˆªé™¤çš„æ˜¯æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²
        if (index === lsMusicState.currentIndex) {
            playNextLSSong();
        } else if (index < lsMusicState.currentIndex) {
            lsMusicState.currentIndex--; // ä¿®æ­£ç´¢å¼•
        }
        renderLSMusicPlaylist();
    }
});

// 3. ç›£è½éŸ³è¨Šæ’­æ”¾æ©Ÿçš„ç‹€æ…‹
const lsAudioPlayer = document.getElementById('ls-audio-player');
lsAudioPlayer.addEventListener('timeupdate', updateLSProgressBar);
lsAudioPlayer.addEventListener('ended', playNextLSSong);
lsAudioPlayer.addEventListener('play', () => {
    lsMusicState.isPlaying = true;
    renderLSMusicPlayerUI();
});
lsAudioPlayer.addEventListener('pause', () => {
    lsMusicState.isPlaying = false;
    renderLSMusicPlayerUI();
});

// 4. ç›£è½é€²åº¦æ¢çš„é»æ“Š
document.getElementById('ls-progress-bar').addEventListener('click', (e) => {
    if (!lsAudioPlayer.duration) return;
    const progressBar = e.currentTarget;
    const barWidth = progressBar.clientWidth;
    const clickX = e.offsetX;
    lsAudioPlayer.currentTime = (clickX / barWidth) * lsAudioPlayer.duration;
});

// 5. ã€æ ¸å¿ƒã€‘æ””æˆªæƒ…ä¾¶ç©ºé–“åˆ†äº«åˆ—è¡¨çš„é»æ“Šäº‹ä»¶ï¼Œä¸å†è§¸ç™¼â€œä¸€èµ·è½â€
document.getElementById('ls-shares-list').addEventListener('click', async (e) => {
    const item = e.target.closest('.ls-share-item');
    if (!item || !item.dataset.shareData) return;

    const shareData = JSON.parse(item.dataset.shareData);

    // å¦‚æœæ˜¯æ­Œæ›²ï¼Œå°±èª¿ç”¨æˆ‘å€‘æ–°çš„æ’­æ”¾æ©Ÿå‡½æ•¸ï¼
    if (shareData.shareType === 'song') {
        openLoversSpaceMusicPlayer(shareData);
    } 
    // å…¶ä»–é¡å‹çš„åˆ†äº«ï¼Œä¿æŒåŸä¾†çš„é‚è¼¯
    else if (shareData.shareType === 'movie' || shareData.shareType === 'book') {
        await showCustomAlert(`åˆ†äº«è©³æƒ… - ${shareData.title}`, shareData.thoughts || shareData.summary || 'æš«ç„¡ç°¡ä»‹');
    }
    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™å¡Šã€å…¨æ–°ã€‘çš„ä»£ç¢¼ â–¼â–¼â–¼
else if (shareData.shareType === 'game') {
    // ç‚ºéŠæˆ²åˆ†äº«å¡ç‰‡æ§‹å»ºä¸€å€‹æ›´è©³ç´°çš„å½ˆçª—å…§å®¹
    const gameInfo = `éŠæˆ²åï¼š${shareData.title}\n\nç°¡ä»‹ï¼š${shareData.summary || 'æš«ç„¡ç°¡ä»‹'}\n\nTaèªªï¼šâ€œ${shareData.thoughts || 'ä¸€èµ·ç©å§ï¼'}â€`;
    await showCustomAlert(`åˆ†äº«çš„éŠæˆ²`, gameInfo);
}
});

// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“æ’­æ”¾æ©Ÿå°é¢/æ­Œè©åˆ‡æ›äº‹ä»¶
document.getElementById('ls-display-area').addEventListener('click', () => {
    document.getElementById('ls-display-area').classList.toggle('show-lyrics');
});

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„æœ«å°¾ï¼Œé»è²¼é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ° init(); çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç•ªèŒ„é˜äº‹ä»¶ç›£è½å™¨ --- */

// 1. ç¶å®šâ€œé–‹å•Ÿæ–°çš„å°ˆæ³¨æ™‚å…‰â€æŒ‰éˆ•
document.getElementById('ls-pomodoro-start-btn-container').addEventListener('click', openPomodoroSetup);

// 2. ç¶å®šè¨­ç½®å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('pomodoro-cancel-setup-btn').addEventListener('click', () => {
    document.getElementById('ls-pomodoro-setup-modal').classList.remove('visible');
});
document.getElementById('pomodoro-confirm-setup-btn').addEventListener('click', startPomodoroSession);

// 3. ã€æ ¸å¿ƒã€‘ç‚ºæˆ‘å€‘æ–°å¢çš„â€œæœ¬åœ°ä¸Šå‚³â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('pomodoro-bg-local-upload-btn').addEventListener('click', () => {
    document.getElementById('pomodoro-bg-file-input').click();
});
document.getElementById('pomodoro-bg-file-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            pomodoroState.tempBgDataUrl = event.target.result; // å°‡æœ¬åœ°åœ–ç‰‡è½‰ç‚ºDataURLæš«å­˜èµ·ä¾†
            document.getElementById('pomodoro-bg-url-input').value = `[æœ¬åœ°åœ–ç‰‡: ${file.name}]`; // åœ¨è¼¸å…¥æ¡†è£¡çµ¦å€‹æç¤º
        };
        reader.readAsDataURL(file);
    }
});

// 4. ç¶å®šè¨ˆæ™‚å™¨ä»‹é¢ä¸Šçš„å…ƒç´ 
document.getElementById('pomodoro-char-avatar').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¾åœ¨å®ƒæœƒèª¿ç”¨APIä¾†ç”Ÿæˆè©±èª
    triggerPomodoroAIResponse('user_click');
});
document.getElementById('pomodoro-end-btn').addEventListener('click', () => {
    endPomodoroSession(false); // falseè¡¨ç¤ºæ˜¯ç”¨æˆ¶æ‰‹å‹•ä¸­æ–·
});

// 5. ç¶å®šæ­·å²è©³æƒ…å½ˆçª—çš„é—œé–‰æŒ‰éˆ•
document.getElementById('pomodoro-close-history-viewer-btn').addEventListener('click', () => {
    document.getElementById('ls-pomodoro-history-viewer-modal').classList.remove('visible');
});
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºç•ªèŒ„é˜è¨ˆæ™‚æ¨¡å¼æ–°å¢çš„äº¤äº’ä»£ç¢¼ â–¼â–¼â–¼
document.querySelector('#ls-pomodoro-setup-modal').addEventListener('change', (e) => {
    if (e.target.name === 'pomodoro-mode') {
        const durationGroup = document.getElementById('pomodoro-duration-input').parentElement;
        if (e.target.value === 'countup') {
            // å¦‚æœé¸æ“‡æ­£è¨ˆæ™‚ï¼Œå°±éš±è—æ™‚é•·è¼¸å…¥æ¡†
            durationGroup.style.display = 'none';
        } else {
            // å¦å‰‡ï¼ˆé¸æ“‡å€’è¨ˆæ™‚ï¼‰ï¼Œå°±é¡¯ç¤ºå®ƒ
            durationGroup.style.display = 'block';
        }
    }
});
// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²

/* --- ç•ªèŒ„é˜äº‹ä»¶ç›£è½çµæŸ --- */
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼é€™å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼
// ã€å…¨æ–°ã€‘è™•ç†æƒ…ä¾¶ç©ºé–“é‚€è«‹å¡ç‰‡çš„é»æ“Šäº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', async (e) => {
    const card = e.target.closest('.waimai-card');
    if (!card) return;
    const messageBubble = card.closest('.message-bubble');
    const invitationMsg = state.chats[state.activeChatId].history.find(m => m.timestamp === parseInt(messageBubble.dataset.timestamp));

    if (invitationMsg && invitationMsg.type === 'lovers_space_invitation' && invitationMsg.status === 'pending') {
        const choice = e.target.dataset.choice; // 'accepted' or 'rejected'
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€æœ€çµ‚é€šçŸ¥ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ if (choice) { ... } ä»£ç¢¼å¡Š â–¼â–¼â–¼
if (choice) {
    // 1. æ›´æ–°é‚€è«‹å¡ç‰‡çš„ç‹€æ…‹
    invitationMsg.status = choice;
    const chat = state.chats[state.activeChatId];
    
    // 2. åˆ¤æ–·ç”¨æˆ¶çš„é¸æ“‡
    if (choice === 'accepted') {
        // å¦‚æœåŒæ„ï¼Œå‰µå»ºæƒ…ä¾¶ç©ºé–“è³‡æ–™
        chat.loversSpaceData = {
            background: 'https://i.postimg.cc/k495F4W5/profile-banner.jpg',
            relationshipStartDate: null,
            moments: [], albums: [], photos: [], loveLetters: [], shares: [], questions: [],
        };
        
        // å‰µå»ºå°ã€ä½¿ç”¨è€…å¯è¦‹ã€‘çš„ç³»çµ±é€šçŸ¥
        const visibleNotice = {
            role: 'system',
            type: 'pat_message',
            content: `[ç³»çµ±ï¼šä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾¶ç©ºé–“å·²æˆåŠŸé–‹å•Ÿï¼]`,
            timestamp: Date.now()
        };
        chat.history.push(visibleNotice);

        // å‰µå»ºçµ¦ã€AIçœ‹ã€‘çš„éš±è—æŒ‡ä»¤
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»çµ±æŒ‡ä»¤ï¼šç”¨æˆ¶åŒæ„äº†ä½ é–‹å•Ÿæƒ…ä¾¶ç©ºé–“çš„é‚€è«‹ã€‚]`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
        // (é€™è£¡æ²’æœ‰ triggerAiResponse()ï¼ŒAIä¸æœƒå›æ‡‰)

    } else { // å¦‚æœæ‹’çµ• (choice === 'rejected')
        
        // --- â–¼â–¼â–¼ é€™å°±æ˜¯æˆ‘å€‘ç‚ºä½ æ–°å¢çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼ ---

        // a. å‰µå»ºä¸€æ¢å°ã€ä½¿ç”¨è€…å¯è¦‹ã€‘çš„ç³»çµ±é€šçŸ¥
        const visibleNotice = {
            role: 'system',
            type: 'pat_message', // è¤‡ç”¨ç°è‰²å±…ä¸­æ°£æ³¡æ¨£å¼
            content: `[ç³»çµ±ï¼šä½ æ‹’çµ•äº†â€œ${chat.name}â€çš„æƒ…ä¾¶ç©ºé–“é‚€è«‹ã€‚]`,
            timestamp: Date.now()
        };
        chat.history.push(visibleNotice);

        // b. å‰µå»ºä¸€æ¢çµ¦ã€AIçœ‹ã€‘çš„éš±è—æŒ‡ä»¤ï¼Œå‘Šè¨´å®ƒè¢«æ‹’çµ•äº†
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»çµ±æŒ‡ä»¤ï¼šç”¨æˆ¶æ‹’çµ•äº†ä½ é–‹å•Ÿæƒ…ä¾¶ç©ºé–“çš„é‚€è«‹ã€‚]`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        chat.history.push(hiddenMessage);

        // c. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°è³‡æ–™åº«
        await db.chats.put(chat);

        // d. åˆ·æ–°èŠå¤©ä»‹é¢ï¼Œè®“å¡ç‰‡ç‹€æ…‹å’Œæ–°çš„ç³»çµ±é€šçŸ¥éƒ½é¡¯ç¤ºå‡ºä¾†
        renderChatInterface(state.activeChatId);
        
        // (é€™è£¡ä¹Ÿæ²’æœ‰ triggerAiResponse()ï¼ŒAIä¸æœƒå›æ‡‰)
        
        // --- â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–² ---
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


    }
});
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
// ã€å…¨æ–°ã€‘è™•ç†æƒ…ä¾¶ç©ºé–“é‚€è«‹å¡ç‰‡çš„é»æ“Šäº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', async (e) => {
    // å°‹æ‰¾è¢«é»æ“Šçš„å…ƒç´ æ˜¯å¦åœ¨é‚€è«‹å¡ç‰‡å…§
    const card = e.target.closest('.waimai-card');
    if (!card) return;
    const messageBubble = card.closest('.message-bubble');
    // é€šéæ™‚é–“æˆ³è¨˜æ‰¾åˆ°å°æ‡‰çš„æ¶ˆæ¯è³‡æ–™
    const invitationMsg = state.chats[state.activeChatId].history.find(m => m.timestamp === parseInt(messageBubble.dataset.timestamp));

    // ç¢ºä¿é€™æ˜¯ä¸€æ¢å¾…è™•ç†çš„æƒ…ä¾¶ç©ºé–“é‚€è«‹
    if (invitationMsg && invitationMsg.type === 'lovers_space_invitation' && invitationMsg.status === 'pending') {
        const choice = e.target.dataset.choice; // ç²å–é»æ“Šçš„æ˜¯ 'accepted' é‚„æ˜¯ 'rejected'
        if (choice) {
            // èª¿ç”¨æˆ‘å€‘å‰›å‰›å‰µå»ºçš„è™•ç†å™¨å‡½æ•¸
            handleLoversSpaceResponse(invitationMsg.timestamp, choice);
        }
    }
});
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–²â–²â–² æƒ…ä¾¶ç©ºé–“äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ä¸»è¢å¹•æ»‘å‹•åˆ†é çš„JSé‚è¼¯ â–¼â–¼â–¼
function initHomeScreenSlider() {
    const slider = document.querySelector('.home-screen-slider');
    const dots = document.querySelectorAll('.pagination-dots .dot');

    if (!slider || dots.length === 0) return;

    // ç›£è½æ»‘å‹•äº‹ä»¶
    slider.addEventListener('scroll', () => {
        // è¨ˆç®—ç•¶å‰æ»‘åˆ°äº†ç¬¬å¹¾é 
        const pageIndex = Math.round(slider.scrollLeft / slider.clientWidth);
        
        // æ›´æ–°å°åœ“é»çš„ç‹€æ…‹
        dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === pageIndex);
        });
    });
}
// â–²â–²â–² æ–°å¢JSé‚è¼¯çµæŸ â–²â–²â–²
initHomeScreenSlider(); // åˆå§‹åŒ–ä¸»è¢å¹•æ»‘å‹•åŠŸèƒ½

// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
// ç›£è½ä¸»è¢å¹•åœ–ç¤ºå’Œå°å…ƒä»¶é¡è‰²é¸æ“‡å™¨çš„å³æ™‚è®ŠåŒ–
document.getElementById('home-icon-widget-text-color-picker').addEventListener('input', (e) => {
    applyHomeIconWidgetTextColor(e.target.value);
});
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// ã€å…¨æ–°ã€‘ä¸»è¢å¹•å­—å‹é™°å½±é–‹é—œçš„å³æ™‚é è¦½äº‹ä»¶
document.getElementById('remove-home-font-shadow-toggle').addEventListener('change', (e) => {
    document.getElementById('phone-screen').classList.toggle('no-home-font-shadow', e.target.checked);
});
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­/å°çµ„åˆ†é¡ç¯©é¸åŠŸèƒ½äº‹ä»¶ç›£è½ â–¼â–¼â–¼
// 1. ç¶å®šä¸»é å’Œå°çµ„é çš„ç¯©é¸æŒ‰éˆ•
document.getElementById('forum-filter-btn').addEventListener('click', () => openForumFilterModal('global'));
document.getElementById('group-filter-btn').addEventListener('click', () => openForumFilterModal('group', activeGroupId));

// 2. ç¶å®šç¯©é¸å½ˆçª—å…§çš„æŒ‰éˆ•
document.getElementById('apply-forum-filter-btn').addEventListener('click', applyForumFilter);
document.getElementById('cancel-forum-filter-btn').addEventListener('click', () => {
    document.getElementById('forum-filter-modal').classList.remove('visible');
});
document.getElementById('reset-forum-filter-btn').addEventListener('click', async () => {
    // æ¸…ç©ºæ ¸å–æ–¹å¡Šä¸¦æ‡‰ç”¨
    document.querySelectorAll('#forum-filter-category-list input:checked').forEach(cb => cb.checked = false);
    await applyForumFilter();
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ç”¨é€™å¡Šã€å·²æ·»åŠ é£›è¡Œæ£‹ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ game-hall-grid äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('game-hall-grid').addEventListener('click', (e) => {
    const gameCard = e.target.closest('.game-card');
    if (!gameCard) return;

    const gameId = gameCard.dataset.game;
    if (gameId === 'werewolf') {
        openWerewolfSetup();
    } else if (gameId === 'sea-turtle-soup') {
        openSeaTurtleSoupSetup();
    } else if (gameId === 'script-kill') {
        openScriptKillSetup();
    } else if (gameId === 'guess-what') {
        openGuessWhatSetup();
    } 
    // â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘æ–°å¢çš„åˆ†æ”¯ â˜…â˜…â˜…
    else if (gameId === 'ludo') {
        openLudoSetup(); // èª¿ç”¨æˆ‘å€‘æ–°å¯«çš„å‡½æ•¸
    } 
    // â˜…â˜…â˜… æ–°å¢çµæŸ â˜…â˜…â˜…
    else {
        alert(`â€œ${gameCard.querySelector('.game-title').textContent}â€é‚„åœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼`);
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ®ºéŠæˆ²äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('start-werewolf-game-btn').addEventListener('click', startWerewolfGame);

document.getElementById('exit-werewolf-game-btn').addEventListener('click', async () => {
    const confirmed = await showCustomConfirm('é€€å‡ºéŠæˆ²', 'ç¢ºå®šè¦ä¸­é€”é€€å‡ºéŠæˆ²å—ï¼Ÿç•¶å‰é€²åº¦ä¸æœƒä¿å­˜ã€‚');
    if (confirmed) {
        werewolfGameState.isActive = false; // åœæ­¢éŠæˆ²è¿´åœˆ
        showScreen('game-hall-screen');
    }
});

document.getElementById('werewolf-my-role-btn').addEventListener('click', () => {
    if (werewolfGameState.isActive) {
        const me = werewolfGameState.players.find(p => p.isUser);
        if (me) {
            alert(`ä½ çš„èº«ä»½æ˜¯ï¼šã€${me.role}ã€‘`);
        }
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾œæ¹¯éŠæˆ²äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

// 1. è¨­ç½®å½ˆçª—å…§çš„äº¤äº’
document.getElementById('cancel-sts-setup-btn').addEventListener('click', () => {
    document.getElementById('sea-turtle-soup-setup-modal').classList.remove('visible');
});
document.getElementById('start-sts-game-btn').addEventListener('click', startSeaTurtleSoupGame);

// ç›£è½â€œå‡ºé¡Œäººâ€ä¸‹æ‹‰æ¸…å–®çš„è®ŠåŒ–
document.getElementById('sts-riddle-provider-select').addEventListener('change', (e) => {
    const userArea = document.getElementById('sts-user-riddle-input-area');
    const aiArea = document.getElementById('sts-ai-riddle-input-area');
    userArea.style.display = 'none';
    aiArea.style.display = 'none';
    if (e.target.value === 'user') {
        userArea.style.display = 'block';
    } else if (e.target.value === 'random_ai') {
        aiArea.style.display = 'block';
    }
});

// 2. éŠæˆ²ä¸»ä»‹é¢çš„æŒ‰éˆ•
document.getElementById('exit-sts-game-btn').addEventListener('click', async () => {
    const confirmed = await showCustomConfirm('é€€å‡ºéŠæˆ²', 'ç¢ºå®šè¦ä¸­é€”é€€å‡ºéŠæˆ²å—ï¼Ÿ');
    if (confirmed) {
        seaTurtleSoupState.isActive = false;
        showScreen('game-hall-screen');
    }
});
document.getElementById('reveal-sts-answer-btn').addEventListener('click', async () => {
    const confirmed = await showCustomConfirm('æ­æ›‰ç­”æ¡ˆ', 'ç¢ºå®šè¦æå‰æ­æ›‰ç­”æ¡ˆä¸¦çµæŸéŠæˆ²å—ï¼Ÿ');
    if (confirmed) {
        revealStsAnswer();
    }
});
document.getElementById('send-sts-question-btn').addEventListener('click', handleStsUserQuestion);
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾æ·»åŠ  â–¼â–¼â–¼
document.getElementById('guess-sts-answer-btn').addEventListener('click', handleStsUserGuess);
// â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
document.getElementById('sts-question-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('send-sts-question-btn').click();
    }
});

// â–²â–²â–² æ–°äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åŠ‡æœ¬æ®ºéŠæˆ²äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('start-script-kill-game-btn').addEventListener('click', startScriptKillGame);
document.getElementById('exit-script-kill-game-btn').addEventListener('click', async () => {
    const confirmed = await showCustomConfirm('é€€å‡ºéŠæˆ²', 'ç¢ºå®šè¦ä¸­é€”é€€å‡ºéŠæˆ²å—ï¼Ÿç•¶å‰é€²åº¦ä¸æœƒä¿å­˜ã€‚');
    if (confirmed) {
        scriptKillGameState.isActive = false; // åœæ­¢éŠæˆ²è¿´åœˆ
        showScreen('game-hall-screen');
    }
});
// åŠ‡æœ¬æ®ºéŠæˆ²äº‹ä»¶ç›£è½å™¨
document.getElementById('script-kill-my-role-btn').addEventListener('click', () => {
    if (!scriptKillGameState.isActive) return;
    const myPlayer = scriptKillGameState.players.find(p => p.isUser);
    if (myPlayer) {
        const modal = document.getElementById('script-kill-role-modal');
        document.getElementById('sk-role-name').textContent = `ä½ çš„è§’è‰²ï¼š${myPlayer.role.name}`;
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨é€™è£¡ â–¼â–¼â–¼
        document.getElementById('sk-role-details').innerHTML = `
            <p><strong>è§’è‰²ä»‹ç´¹:</strong><br>${myPlayer.role.description}</p>
            <p><strong>ä½ çš„æ™‚é–“ç·š:</strong><br>${myPlayer.role.storyline || 'ï¼ˆæš«ç„¡æ™‚é–“ç·šè³‡è¨Šï¼‰'}</p>
            <p><strong>ä½ çš„ä»»å‹™:</strong><br>${myPlayer.role.tasks}</p>
        `;
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        modal.classList.add('visible');
    }
});
document.getElementById('close-sk-role-modal-btn').addEventListener('click', () => {
    document.getElementById('script-kill-role-modal').classList.remove('visible');
});

// æŸ¥çœ‹ç·šç´¢æ¿
document.getElementById('script-kill-all-evidence-btn').addEventListener('click', () => {
    if (!scriptKillGameState.isActive) return;
    const modal = document.getElementById('script-kill-evidence-modal');
    const listEl = document.getElementById('sk-evidence-list');
    listEl.innerHTML = '';

    const myPlayer = scriptKillGameState.players.find(p => p.isUser);
    if (myPlayer.evidence.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">ä½ é‚„æ²’æœ‰æœåˆ°ä»»ä½•ç·šç´¢ã€‚</p>';
    } else {
        myPlayer.evidence.forEach(clue => {
            const card = document.createElement('div');
            card.className = 'sk-evidence-card';
            card.innerHTML = `
                <div class="source">ä¾†æº: ${clue.source}</div>
                <div class="description">${clue.description}</div>
            `;
            listEl.appendChild(card);
        });
    }
    modal.classList.add('visible');
});
document.getElementById('close-sk-evidence-modal-btn').addEventListener('click', () => {
    document.getElementById('script-kill-evidence-modal').classList.remove('visible');
});

// â–¼â–¼â–¼ ã€æœ€çµ‚æµç¨‹ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ script-kill-action-area äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('script-kill-action-area').addEventListener('click', async (e) => {
    const phase = scriptKillGameState.gamePhase;

// â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹è¤‡è£½ï¼Œæ›¿æ›æ‰ä½ èˆŠçš„ 'sk-search-evidence-btn' çš„ if ä»£ç¢¼å¡Š â–¼â–¼â–¼
if (e.target.id === 'sk-search-evidence-btn') {
    const user = scriptKillGameState.players.find(p => p.isUser);
    const script = scriptKillGameState.script;
    
    const searchCount = scriptKillGameState.evidenceCounts[user.id] || 0;
    const phase = scriptKillGameState.gamePhase;

    // æª¢æŸ¥æœè­‰æ¬¡æ•¸é™åˆ¶
    if ((phase === 'evidence_round_1' && searchCount >= 2) || (phase === 'evidence_round_2' && searchCount >= 3)) {
        alert("æœ¬è¼ªæœè­‰æ¬¡æ•¸å·²ç”¨å®Œï¼");
        return;
    }
    
    // æ¶ˆè€—ä¸€æ¬¡æœè­‰æ©Ÿæœƒä¸¦æ›´æ–°UI
    scriptKillGameState.evidenceCounts[user.id] = searchCount + 1;
    updateActionAreaSK();

    let foundMessage = '';

    // æ‰¾å‡ºæ‰€æœ‰é‚„æœªè¢«ç™¼ç¾çš„ç·šç´¢
    const uncollectedClues = script.clues.filter(c => !scriptKillGameState.collectedClueIds.has(c.description));

    if (uncollectedClues.length > 0) {
        // éš¨æ©Ÿæ‰¾åˆ°ä¸€æ¢æ–°ç·šç´¢
        const foundClue = uncollectedClues[Math.floor(Math.random() * uncollectedClues.length)];
        const clueSource = foundClue.owner === 'å…¬å…±' ? 'å…¬å…±å€åŸŸ' : `è§’è‰² ${foundClue.owner} çš„ç§äººç‰©å“`;
        
        // ç„¡è«–å¦‚ä½•ï¼Œç·šç´¢éƒ½æœƒå…ˆåŠ å…¥ç©å®¶æ‰‹ç‰Œï¼Œä¸¦æ¨™è¨˜ç‚ºå·²ç™¼ç¾
        user.evidence.push({ description: foundClue.description, source: clueSource });
        scriptKillGameState.collectedClueIds.add(foundClue.description);

        // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹é‚è¼¯é–‹å§‹ â˜…â˜…â˜… ---

        // åˆ¤æ–·é€™æ¢ç·šç´¢æ˜¯ä¸æ˜¯é—œæ–¼ç©å®¶è‡ªå·±çš„
        if (foundClue.owner === user.role.name) {
            // å¦‚æœæ˜¯ï¼Œå½ˆå‡ºä¸€å€‹é¸æ“‡æ¡†è®“ç©å®¶æ±ºå®š
            const choice = await showChoiceModal(
                'ç™¼ç¾å€‹äººç·šç´¢',
                [
                    { text: 'å…¬é–‹é€™æ¢ç·šç´¢', value: 'public' },
                    { text: 'éš±è—é€™æ¢ç·šç´¢', value: 'private' }
                ]
            );

            if (choice === 'public') {
                // ç©å®¶é¸æ“‡ã€å…¬é–‹ã€‘
                foundMessage = `åœ¨ã€${clueSource}ã€‘ç™¼ç¾ä¸¦å…¬é–‹äº†ç·šç´¢ï¼šâ€œ${foundClue.description}â€`;
                logToScriptKillGame(`${user.name} å®Œæˆäº†ä¸€æ¬¡æœè­‰: ${foundMessage}`);
                await showCustomAlert("æœè­‰çµæœ", foundMessage);
            } else {
                // ç©å®¶é¸æ“‡ã€éš±è—ã€‘æˆ–é—œé–‰äº†å½ˆçª—
                foundMessage = `ä½ åœ¨ã€${clueSource}ã€‘ç™¼ç¾äº†ä¸€æ¢é—œæ–¼è‡ªå·±çš„ç·šç´¢ï¼Œä¸¦é¸æ“‡å°‡å…¶éš±è—ã€‚`;
                // åªçµ¦ç©å®¶è‡ªå·±ä¸€å€‹å½ˆçª—æç¤ºï¼Œå‘Šè¨´ä»–å·²ç¶“æ‹¿åˆ°äº†ç·šç´¢
                await showCustomAlert("æœè­‰çµæœ", `ä½ å·²å°‡ç·šç´¢â€œ${foundClue.description}â€æ”¶å…¥å›Šä¸­ã€‚`);
                // åœ¨å…¬å…±æ—¥èªŒè£¡åªé¡¯ç¤ºä¸€å€‹æ¨¡ç³Šçš„è³‡è¨Šï¼Œå‘Šè¨´å¤§å®¶ä½ æœéè­‰äº†
                logToScriptKillGame(`${user.name} å®Œæˆäº†ä¸€æ¬¡æœè­‰ã€‚`);
            }
        } else {
            // å¦‚æœç·šç´¢æ˜¯å…¬å…±çš„ï¼Œæˆ–è€…é—œæ–¼å…¶ä»–äººçš„ï¼Œå°±æŒ‰åŸä¾†çš„é‚è¼¯ç›´æ¥å…¬é–‹
            foundMessage = `åœ¨ã€${clueSource}ã€‘ç™¼ç¾ç·šç´¢ï¼šâ€œ${foundClue.description}â€`;
            logToScriptKillGame(`${user.name} å®Œæˆäº†ä¸€æ¬¡æœè­‰: ${foundMessage}`);
            await showCustomAlert("æœè­‰çµæœ", foundMessage);
        }
        
        // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹é‚è¼¯çµæŸ â˜…â˜…â˜… ---

    } else {
        // å¦‚æœå·²ç¶“æ²’æœ‰æ–°ç·šç´¢äº†
        foundMessage = "æ²’æœ‰ç™¼ç¾æ›´å¤šæ–°ç·šç´¢äº†ã€‚";
        logToScriptKillGame(`${user.name} å®Œæˆäº†ä¸€æ¬¡æœè­‰: ${foundMessage}`);
        await showCustomAlert("æœè­‰çµæœ", foundMessage);
    }
}
// â–²â–²â–² è¤‡è£½åˆ°é€™è£¡çµæŸ â–²â–²â–²


    // --- 2. è™•ç†â€œçµæŸæœè­‰â€æŒ‰éˆ• ---
    if (e.target.id === 'sk-end-search-btn') {
        if (phase === 'evidence_round_1') {
            scriptKillGameState.gamePhase = 'discussion_round_1';
            await processScriptKillTurn();
        } else if (phase === 'evidence_round_2') {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¬¬äºŒè¼ªæœè­‰å¾Œï¼Œé€²å…¥ç¬¬äºŒè¼ªè¨è«–
            scriptKillGameState.gamePhase = 'discussion_round_2';
            await processScriptKillTurn();
        }
    }

    // --- 3. è™•ç†â€œæˆ‘è¦ç™¼è¨€â€æŒ‰éˆ• ---
    if (e.target.id === 'sk-speak-btn') {
        const speech = await waitForUserActionSK('è¼ªåˆ°ä½ ç™¼è¨€äº†', 'speak', 'è«‹è¼¸å…¥ä½ çš„ç™¼è¨€...');
        const userPlayer = scriptKillGameState.players.find(p => p.isUser);
        logToScriptKillGame({ player: userPlayer, speech: speech }, 'speech');
        
        for (const player of scriptKillGameState.players.filter(p => !p.isUser)) {
             await sleep(2000);
             renderScriptKillGameScreen({ speakingPlayerId: player.id });
             const aiSpeech = await triggerScriptKillAiAction(player.id, 'discuss');
             logToScriptKillGame({ player: player, speech: aiSpeech }, 'speech');
        }
        renderScriptKillGameScreen();
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ“šç•¶å‰è¨è«–è¼ªæ¬¡ï¼Œæ±ºå®šä¸‹ä¸€å€‹éšæ®µ
        if (phase === 'discussion_round_1') {
            scriptKillGameState.gamePhase = 'evidence_round_2';
            await processScriptKillTurn();
        } else if (phase === 'discussion_round_2') {
            // ç¬¬äºŒè¼ªè¨è«–å¾Œï¼Œé€²å…¥ç¬¬ä¸‰è¼ªï¼ˆæœ€çµ‚ï¼‰è¨è«–
            scriptKillGameState.gamePhase = 'discussion_round_3';
            await processScriptKillTurn();
        } else if (phase === 'discussion_round_3') {
            // æœ€çµ‚è¨è«–å¾Œï¼Œæ‰é€²å…¥æŠ•ç¥¨
            scriptKillGameState.gamePhase = 'voting';
            await processScriptKillTurn();
        }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²



// â–¼â–¼â–¼ ã€å…¨æ–° | å·²ä¿®å¾©ã€‘åŠ‡æœ¬æ®ºç®¡ç†åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('manage-custom-scripts-btn').addEventListener('click', openScriptManager);

// ç®¡ç†å™¨å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('add-new-script-btn').addEventListener('click', () => {
    document.getElementById('script-kill-manager-modal').classList.remove('visible');
    openScriptEditorForCreate();
});
document.getElementById('close-script-manager-btn').addEventListener('click', () => {
    document.getElementById('script-kill-manager-modal').classList.remove('visible');
    // é—œé–‰å¾Œåˆ·æ–°ä¸€ä¸‹è¨­ç½®é é¢çš„åŠ‡æœ¬ä¸‹æ‹‰æ¸…å–®
    openScriptKillSetup();
    showScreen('script-kill-setup-screen');
});

// ç·¨è¼¯å™¨å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('save-script-btn').addEventListener('click', saveCustomScript);
document.getElementById('cancel-script-editor-btn').addEventListener('click', () => {
    document.getElementById('script-kill-editor-modal').classList.remove('visible');
    // å¦‚æœæ˜¯å¾ç®¡ç†ä»‹é¢é€²ä¾†çš„ï¼Œå°±è¿”å›ç®¡ç†ä»‹é¢
    if (document.getElementById('script-kill-manager-modal').classList.contains('visible') === false) {
       openScriptManager();
    }
});
// â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åŠ‡æœ¬æ®ºè¦–è¦ºåŒ–ç·¨è¼¯å™¨äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('sk-add-role-btn').addEventListener('click', () => openRoleEditor());
document.getElementById('sk-add-clue-btn').addEventListener('click', () => openClueEditor());

document.getElementById('sk-item-editor-cancel-btn').addEventListener('click', () => {
    document.getElementById('sk-item-editor-modal').classList.remove('visible');
});
document.getElementById('sk-item-editor-save-btn').addEventListener('click', saveItemFromEditor);

// ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†è§’è‰²å’Œç·šç´¢å¡ç‰‡ä¸Šçš„æŒ‰éˆ•é»æ“Š
document.getElementById('script-kill-editor-modal').addEventListener('click', (e) => {
    const target = e.target;
    if (target.classList.contains('edit-role-btn')) {
        openRoleEditor(parseInt(target.dataset.index));
    }
    if (target.classList.contains('delete-role-btn')) {
        const index = parseInt(target.dataset.index);
        currentEditingScriptData.roles.splice(index, 1);
        renderVisualScriptEditor();
    }
    if (target.classList.contains('edit-clue-btn')) {
        openClueEditor(parseInt(target.dataset.index));
    }
    if (target.classList.contains('delete-clue-btn')) {
        const index = parseInt(target.dataset.index);
        currentEditingScriptData.clues.splice(index, 1);
        renderVisualScriptEditor();
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼é€™å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘åŠ‡æœ¬æ®ºè¤‡ç›¤åˆ†äº«åŠŸèƒ½äº‹ä»¶ç¶å®š
document.getElementById('sk-cancel-share-btn').addEventListener('click', () => {
    document.getElementById('script-kill-target-picker-modal').classList.remove('visible');
});
document.getElementById('sk-select-all-btn').addEventListener('click', () => {
    document.querySelectorAll('.script-kill-target-checkbox').forEach(cb => cb.checked = true);
});
document.getElementById('sk-deselect-all-btn').addEventListener('click', () => {
    document.querySelectorAll('.script-kill-target-checkbox').forEach(cb => cb.checked = false);
});
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIåŠ‡æœ¬ç”Ÿæˆå™¨äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('open-sk-ai-generator-btn').addEventListener('click', openAiScriptGenerator);
document.getElementById('sk-ai-generator-cancel-btn').addEventListener('click', () => {
    document.getElementById('sk-ai-generator-modal').classList.remove('visible');
    // è¿”å›åˆ°åŠ‡æœ¬ç®¡ç†ä»‹é¢
    openScriptManager();
});
document.getElementById('sk-trigger-ai-generation-btn').addEventListener('click', generateSkScriptWithAI);
document.getElementById('sk-ai-generator-save-btn').addEventListener('click', saveAiGeneratedScript);
// â–²â–²â–² æ–°äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²

// â–²â–²â–² åŠ‡æœ¬æ®ºäº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œä½ èªªæˆ‘çŒœâ€éŠæˆ²äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

// 1. è¨­ç½®ä»‹é¢çš„äº¤äº’
document.querySelectorAll('input[name="guess_what_mode"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('user-word-input-container').style.display = this.value === 'ai_guesses' ? 'block' : 'none';
    });
});
document.getElementById('start-guess-what-game-btn').addEventListener('click', startGuessWhatGame);

// 2. éŠæˆ²ä»‹é¢çš„äº¤äº’
document.getElementById('exit-guess-what-game-btn').addEventListener('click', async () => {
    const confirmed = await showCustomConfirm('é€€å‡ºéŠæˆ²', 'ç¢ºå®šè¦ä¸­é€”é€€å‡ºéŠæˆ²å—ï¼Ÿè¬åº•å°‡æœƒæ­æ›‰ã€‚');
    if (confirmed) {
        endGuessWhatGame('none', 'éŠæˆ²è¢«ä¸­é€”æ”¾æ£„ã€‚');
        // å»¶é²ä¸€é»å†è¿”å›å¤§å»³ï¼Œè®“ç©å®¶èƒ½çœ‹åˆ°çµæœ
        setTimeout(() => {
            showScreen('game-hall-screen');
        }, 3000);
    }
});

document.getElementById('give-up-guess-what-btn').addEventListener('click', () => {
    endGuessWhatGame(guessWhatGameState.currentTurn === 'user' ? 'ai' : 'user', 'ç©å®¶æ”¾æ£„äº†éŠæˆ²ã€‚');
});

document.getElementById('send-guess-what-input-btn').addEventListener('click', () => {
    const input = document.getElementById('guess-what-user-input');
    const text = input.value.trim();
    if (text) {
        processGuessWhatTurn(text);
        input.value = '';
    }
});

document.getElementById('guess-what-user-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('send-guess-what-input-btn').click();
    }
});

// â–²â–²â–² â€œä½ èªªæˆ‘çŒœâ€äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯µç‰©åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

// 1. ç¶å®šè¼¸å…¥æ¡†ä¸Šæ–¹çš„å¯µç‰©åœ–ç¤ºæŒ‰éˆ•
document.getElementById('pet-action-btn').addEventListener('click', openPetModal);

// 2. ç¶å®šå¯µç‰©å½ˆçª—å…§çš„å„ç¨®æŒ‰éˆ•
document.getElementById('pet-modal-cancel-btn').addEventListener('click', () => {
    document.getElementById('pet-modal').classList.remove('visible');
    currentPetData = null; // å–æ¶ˆæ™‚ä¹Ÿè¦æ¸…ç†
});
document.getElementById('pet-modal-save-btn').addEventListener('click', savePetSettings);

// 3. å³æ™‚æ›´æ–°é è¦½
document.getElementById('pet-type-input').addEventListener('input', updatePetPreview);
document.getElementById('pet-name-input').addEventListener('input', updatePetPreview);
document.getElementById('pet-image-input').addEventListener('input', updatePetPreview);

// 4. â€œåœ¨èŠå¤©ä»‹é¢é¡¯ç¤ºâ€é–‹é—œçš„äº¤äº’
document.getElementById('pet-display-toggle').addEventListener('change', (e) => {
    document.getElementById('pet-position-controls').style.display = e.target.checked ? 'block' : 'none';
});

// 5. å°ºå¯¸æ»‘å¡Šçš„äº¤äº’
const sizeSlider = document.getElementById('pet-size-slider');
sizeSlider.addEventListener('input', () => {
    document.getElementById('pet-size-value').textContent = `${sizeSlider.value}px`;
});

// 6. ç¶å®šæ›´æ›è‡ªè¨‚åœ–ç‰‡çš„é»æ“Šäº‹ä»¶
document.getElementById('pet-preview-display').addEventListener('click', () => {
    document.getElementById('pet-custom-image-input').click();
});
document.getElementById('pet-custom-image-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            // å°‡åœ–ç‰‡çš„Base64é€£çµç›´æ¥å¡«å…¥è¼¸å…¥æ¡†
            document.getElementById('pet-image-input').value = event.target.result;
            updatePetPreview(); // ä¸¦æ›´æ–°é è¦½
        };
        reader.readAsDataURL(file);
    }
});

// 7. ç¶å®šäº’å‹•æŒ‰éˆ• (ä½¿ç”¨äº‹ä»¶å§”è¨—)
document.getElementById('pet-interaction-area').addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON' && e.target.dataset.action) {
        handlePetInteraction(e.target.dataset.action);
    }
});

// 8. åˆå§‹åŒ–å¯µç‰©çš„æ‹–å‹•åŠŸèƒ½
initPetDragging();
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯µç‰©èŠå¤©åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('send-to-pet-btn').addEventListener('click', handleSendToPet);
document.getElementById('pet-chat-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('send-to-pet-btn').click();
    }
});

// ç‚ºå¯µç‰©èŠå¤©è¦–çª—çš„â€œå¤–éƒ¨â€é»æ“Šæ·»åŠ é—œé–‰åŠŸèƒ½
const petChatModal = document.getElementById('pet-chat-modal');
petChatModal.addEventListener('click', (e) => {
    if (e.target === petChatModal) { // åªæœ‰é»æ“Šç°è‰²é®ç½©å±¤æ‰é—œé–‰
        petChatModal.classList.remove('visible');
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
// ã€å…¨æ–°ã€‘ç‚ºâ€œæ”¾ç”Ÿå¯µç‰©â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('pet-abandon-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;

    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ”¾ç”Ÿ',
        'ç¢ºå®šè¦é—œé–‰å¯µç‰©ç³»çµ±å—ï¼Ÿé€™å°‡æœƒé‡ç½®æ‰€æœ‰å¯µç‰©è³‡æ–™ï¼ˆæ•¸å€¼ã€èŠå¤©è¨˜éŒ„ç­‰ï¼‰ï¼Œä½†ä¸æœƒåˆªé™¤ä½ çš„è¨­ç½®ã€‚ä½ å¯ä»¥éš¨æ™‚é‡æ–°é ˜é¤Šã€‚',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        chat.settings.petAdopted = false; // é—œé–‰é ˜é¤Šç‹€æ…‹
        delete chat.settings.pet; // åˆªé™¤å¯µç‰©è³‡æ–™ç‰©ä»¶
        
        await db.chats.put(chat);
        
        renderChatPet(); // å¾èŠå¤©ä»‹é¢ç§»é™¤å¯µç‰©
        document.getElementById('pet-modal').classList.remove('visible'); // é—œé–‰å½ˆçª—
        alert('å¯µç‰©å·²æ”¾ç”Ÿï¼Œæ±Ÿæ¹–å†è¦‹ï¼');
    }
});
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–²â–²â–² å¯µç‰©åŠŸèƒ½äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾¶ç©ºé–“-æƒ…ç·’æ—¥è¨˜äº‹ä»¶ç›£è½ --- */
document.getElementById('lovers-space-screen').addEventListener('click', (e) => {
    const chat = state.chats[activeLoversSpaceCharId];
    if (!chat) return;

    // æ—¥æ›†æœˆä»½åˆ‡æ›
    if (e.target.id === 'ls-prev-month-btn' || e.target.id === 'ls-next-month-btn') {
        const currentDisplay = document.getElementById('ls-current-month-display').textContent;
        const [year, month] = currentDisplay.match(/\d+/g).map(Number);
        let newDate = new Date(year, month - 1, 1);
        
        if (e.target.id === 'ls-prev-month-btn') {
            newDate.setMonth(newDate.getMonth() - 1);
        } else {
            newDate.setMonth(newDate.getMonth() + 1);
        }
        renderLSDiaryView(newDate.getFullYear(), newDate.getMonth() + 1);
        return;
    }
    
    // é»æ“Šæ—¥æ›†æ ¼å­
    const dayCell = e.target.closest('.ls-calendar-day:not(.empty)');
    if (dayCell) {
        openDiaryModal(dayCell.dataset.date);
    }
});

// æ—¥è¨˜ç·¨è¼¯å½ˆçª—äº‹ä»¶
document.getElementById('ls-emoji-selector').addEventListener('click', (e) => {
    if (e.target.classList.contains('emoji-option')) {
        document.querySelectorAll('#ls-emoji-selector .emoji-option').forEach(el => el.classList.remove('selected'));
        e.target.classList.add('selected');
    }
});
document.getElementById('ls-cancel-diary-btn').addEventListener('click', () => {
    document.getElementById('ls-diary-editor-modal').classList.remove('visible');
});
document.getElementById('ls-save-diary-btn').addEventListener('click', handleSaveUserDiary);

// æ—¥è¨˜æŸ¥çœ‹å½ˆçª—é—œé–‰æŒ‰éˆ•
document.getElementById('ls-close-diary-viewer-btn').addEventListener('click', () => {
    document.getElementById('ls-diary-viewer-modal').classList.remove('visible');
});

/* --- æƒ…ç·’æ—¥è¨˜äº‹ä»¶ç›£è½çµæŸ --- */

// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾...

// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™å¹¾è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼

// ç¶å®šç·šä¸‹æ¨¡å¼é è¨­çš„ä¸‹æ‹‰æ¸…å–®å’Œç®¡ç†æŒ‰éˆ•
document.getElementById('offline-preset-select').addEventListener('change', handleOfflinePresetSelection);
document.getElementById('manage-offline-presets-btn').addEventListener('click', openOfflinePresetManager);

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å·²ä¿®å¾©ã€‘ç”¨é€™æ®µæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ â–¼â–¼â–¼
document.getElementById('back-from-dm-list').addEventListener('click', () => {
    // å¾ç§ä¿¡æ¸…å–®è¿”å›æ™‚ï¼Œç›´æ¥é¡¯ç¤ºå¾®åšä¸»è¢å¹•
    showScreen('weibo-screen');
    // ä¸¦ä¸”ç¢ºä¿é è¨­é¡¯ç¤ºçš„æ˜¯â€œæˆ‘çš„å¾®åšâ€é‚£å€‹é ç°½
    switchToWeiboView('weibo-my-profile-view');
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


document.getElementById('back-from-dm-detail').addEventListener('click', () => {
    // å¾ç§ä¿¡è©³æƒ…è¿”å›ç§ä¿¡åˆ—è¡¨
    showScreen('weibo-dm-list-screen');
});

// ç¶å®šâ€œç¹¼çºŒç”Ÿæˆâ€æŒ‰éˆ•
document.getElementById('generate-more-dms-btn').addEventListener('click', handleGenerateMoreDms);

// ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†ç§ä¿¡åˆ—è¡¨çš„é»æ“Š
document.getElementById('weibo-dm-list').addEventListener('click', (e) => {
    const item = e.target.closest('.dm-list-item');
    if (item && item.dataset.fanIndex) {
        openDmDetail(parseInt(item.dataset.fanIndex));
    }
});

// ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†ç§ä¿¡è©³æƒ…é çš„åˆªé™¤æŒ‰éˆ•é»æ“Š
document.getElementById('weibo-dm-messages').addEventListener('click', (e) => {
    const deleteBtn = e.target.closest('.dm-message-delete-btn');
    if (deleteBtn) {
        const fanIndex = parseInt(document.querySelector('.dm-list-item.active')?.dataset.fanIndex ?? document.getElementById('weibo-dm-detail-screen').dataset.currentFanIndex);
        const messageIndex = parseInt(deleteBtn.dataset.messageIndex);
        
        const conversation = state.chats[currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id].weiboDms.find(convo => convo.fanName === document.getElementById('weibo-dm-detail-title').textContent);
        const fanIdx = state.chats[currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id].weiboDms.indexOf(conversation);

        if (!isNaN(fanIdx) && !isNaN(messageIndex)) {
            handleDeleteWeiboDm(fanIdx, messageIndex);
        }
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç›£è½å™¨é»è²¼çµæŸ â–²â–²â–²
document.getElementById('clear-all-dms-btn').addEventListener('click', handleClearAllDms);
// åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸ
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©ç¸½çµåŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('view-summaries-btn').addEventListener('click', openSummaryViewer);
document.getElementById('close-summary-viewer-btn').addEventListener('click', () => {
    document.getElementById('summary-viewer-modal').classList.remove('visible');
    // é—œé–‰å¾Œé‡æ–°æ‰“é–‹è¨­ç½®å½ˆçª—ï¼Œå›åˆ°ä¸Šä¸€ç´š
    document.getElementById('chat-settings-btn').click();
});

// â–¼â–¼â–¼ ç”¨é€™å¡Šã€åŠŸèƒ½æ›´å…¨ã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ summary-list äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
// ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†ç¸½çµæ¸…å–®ä¸­çš„æ‰€æœ‰æŒ‰éˆ•
document.getElementById('summary-list').addEventListener('click', (e) => {
    const editBtn = e.target.closest('.edit-summary-btn');
    if (editBtn) {
        const timestamp = parseInt(editBtn.dataset.timestamp);
        editSummary(timestamp);
        return;
    }
    
    const deleteBtn = e.target.closest('.delete-summary-btn');
    if (deleteBtn) {
        const timestamp = parseInt(deleteBtn.dataset.timestamp);
        deleteSummary(timestamp);
        return;
    }

    // ã€æ ¸å¿ƒæ–°å¢ã€‘è™•ç†å–®æ¢ç²¾ç°¡æŒ‰éˆ•çš„é»æ“Š
    const conciseBtn = e.target.closest('.concise-summary-btn');
    if (conciseBtn) {
        const timestamp = parseInt(conciseBtn.dataset.timestamp);
        handleConciseSummary(timestamp);
        return;
    }
});

// ã€å…¨æ–°ã€‘ç‚ºâ€œå…¨éƒ¨ç²¾ç°¡â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('concise-all-summaries-btn').addEventListener('click', handleConciseAllSummaries);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸ
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºâ€œç«‹å³æ‰‹å‹•ç¸½çµâ€æŒ‰éˆ•ç¶å®šäº‹ä»¶ â–¼â–¼â–¼
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.id === 'manual-summary-btn') {
        // é»æ“Šå¾Œå…ˆé—œé–‰è¨­ç½®å½ˆçª—ï¼Œé¿å…é®æ“‹å¾ŒçºŒçš„æç¤º
        document.getElementById('chat-settings-modal').classList.remove('visible');
        triggerManualSummaryNow();
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ä»£ç¢¼ï¼Œé»è²¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘â€œæ¡ƒå¯¶â€App äº‹ä»¶ç›£è½å™¨ --- */

// 1. ç¶å®šä¸»è¢å¹•çš„Appåœ–ç¤º
document.getElementById('taobao-app-icon').addEventListener('click', openTaobaoApp);
// ç¶å®šæ–°åŠ çš„â€œæ¸…ç©ºâ€æŒ‰éˆ•
document.getElementById('clear-taobao-products-btn').addEventListener('click', clearTaobaoProducts);
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å€åŸŸæœ«å°¾ï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æ¡ƒå¯¶è³¼ç‰©è»ŠåŠŸèƒ½äº‹ä»¶ç›£è½å™¨ --- */

// 1. ç¶å®šAppå…§éƒ¨çš„é ç°½åˆ‡æ›
document.querySelector('.taobao-tabs').addEventListener('click', (e) => {
    if (e.target.classList.contains('taobao-tab')) {
        switchTaobaoView(e.target.dataset.view);
    }
});

// 2. ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œè™•ç†å•†å“åˆ—è¡¨å’Œè³¼ç‰©è»Šåˆ—è¡¨ä¸­çš„æ‰€æœ‰é»æ“Š
document.getElementById('taobao-screen').addEventListener('click', async (e) => {
    const target = e.target;
    
    // é»æ“Šâ€œåŠ å…¥è³¼ç‰©è»Šâ€æŒ‰éˆ•
    if (target.classList.contains('add-cart-btn')) {
        const productId = parseInt(target.dataset.productId);
        if (!isNaN(productId)) {
            await handleAddToCart(productId);
        }
        return;
    }
    
    // é»æ“Šå•†å“å¡ç‰‡ï¼ˆåœ–ç‰‡æˆ–è³‡è¨Šå€ï¼‰ï¼Œæ‰“é–‹è©³æƒ…é 
    const productCard = target.closest('.product-card');
    if (productCard && !target.classList.contains('add-cart-btn')) {
        const productId = parseInt(productCard.dataset.productId);
        if (!isNaN(productId)) {
            await openProductDetail(productId);
        }
        return;
    }
    
    // é»æ“Šè³¼ç‰©è»Šè£¡çš„å•†å“ï¼ˆåœ–ç‰‡æˆ–è³‡è¨Šå€ï¼‰ï¼Œæ‰“é–‹è©³æƒ…é 
    const cartItem = target.closest('.cart-item');
    if (cartItem && (target.classList.contains('product-image') || target.closest('.cart-item-info'))) {
         const productId = parseInt(target.dataset.productId);
         if (!isNaN(productId)) {
            await openProductDetail(productId);
        }
        return;
    }

    // é»æ“Šè³¼ç‰©è»Šæ•¸é‡æ§åˆ¶æŒ‰éˆ•
    if (target.classList.contains('quantity-increase')) {
        const cartId = parseInt(target.dataset.cartId);
        if (!isNaN(cartId)) await handleChangeCartItemQuantity(cartId, 1);
        return;
    }
    if (target.classList.contains('quantity-decrease')) {
        const cartId = parseInt(target.dataset.cartId);
        if (!isNaN(cartId)) await handleChangeCartItemQuantity(cartId, -1);
        return;
    }

    // é»æ“Šè³¼ç‰©è»Šåˆªé™¤æŒ‰éˆ•
    if (target.classList.contains('delete-cart-item-btn')) {
        const cartId = parseInt(target.dataset.cartId);
        if (!isNaN(cartId)) {
            const confirmed = await showCustomConfirm('ç§»å‡ºè³¼ç‰©è»Š', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹å¯¶è²å—ï¼Ÿ');
            if (confirmed) await handleRemoveFromCart(cartId);
        }
        return;
    }

    // é»æ“Šåˆ†é¡é ç°½
    const categoryTab = target.closest('.category-tab-btn');
    if (categoryTab) {
        const category = categoryTab.dataset.category === 'all' ? null : categoryTab.dataset.category;
        await renderTaobaoProducts(category);
        return;
    }
});

// 3. ç¶å®šå•†å“è©³æƒ…å½ˆçª—çš„é—œé–‰æŒ‰éˆ•
document.getElementById('close-product-detail-btn').addEventListener('click', () => {
    document.getElementById('product-detail-modal').classList.remove('visible');
});

// 4. ç¶å®šçµç®—æŒ‰éˆ•
document.getElementById('checkout-btn').addEventListener('click', handleCheckout);


// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ 'top-up-btn' äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('top-up-btn').addEventListener('click', async () => {
    const amountStr = await showCustomPrompt("å……å€¼", "è«‹è¼¸å…¥è¦å……å€¼çš„é‡‘é¡ (å…ƒ):", "", "number");
    if (amountStr !== null) {
        const amount = parseFloat(amountStr);
        if (!isNaN(amount) && amount > 0) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘èª¿ç”¨æˆ‘å€‘çš„æ–°å‡½æ•¸ä¾†è™•ç†å……å€¼å’Œè¨˜éŒ„
            await updateUserBalanceAndLogTransaction(amount, 'å……å€¼');
            await renderBalanceDetails(); // åˆ·æ–°é¤˜é¡å’Œæ˜ç´°
            alert(`æˆåŠŸå……å€¼ Â¥${amount.toFixed(2)}ï¼`);
        } else {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼");
        }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// 4. ç¶å®šé¦–é å³ä¸Šè§’çš„â€œ+â€æŒ‰éˆ•
document.getElementById('add-product-btn').addEventListener('click', openAddProductChoiceModal);

// 5. ç¶å®šæ·»åŠ æ–¹å¼é¸æ“‡å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('add-product-manual-btn').addEventListener('click', () => {
    document.getElementById('add-product-choice-modal').classList.remove('visible');
    openProductEditor();
});
document.getElementById('add-product-link-btn').addEventListener('click', () => {
    document.getElementById('add-product-choice-modal').classList.remove('visible');
    openAddFromLinkModal();
});
document.getElementById('add-product-ai-btn').addEventListener('click', () => {
    document.getElementById('add-product-choice-modal').classList.remove('visible');
    handleGenerateProductsAI();
});
document.getElementById('cancel-add-choice-btn').addEventListener('click', () => {
    document.getElementById('add-product-choice-modal').classList.remove('visible');
});

// 6. ç¶å®šæ‰‹å‹•æ·»åŠ /ç·¨è¼¯å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('cancel-product-editor-btn').addEventListener('click', () => {
    document.getElementById('product-editor-modal').classList.remove('visible');
});
document.getElementById('save-product-btn').addEventListener('click', saveProduct);

// 7. ç¶å®šè­˜åˆ¥é€£çµå½ˆçª—çš„æŒ‰éˆ•
document.getElementById('cancel-link-paste-btn').addEventListener('click', () => {
    document.getElementById('add-from-link-modal').classList.remove('visible');
});
document.getElementById('confirm-link-paste-btn').addEventListener('click', handleAddFromLink);

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œç”¨é€™å¡Šã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ 'products-view' é»æ“Šäº‹ä»¶ â–¼â–¼â–¼
document.getElementById('products-view').addEventListener('click', async (e) => {
    const target = e.target;
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘æŠŠåŸä¾†çš„è³¼è²·é‚è¼¯ï¼Œæ”¹æˆäº†æ‰“é–‹è©³æƒ…é çš„é‚è¼¯
    const productCard = target.closest('.product-card');
    if (productCard && !target.classList.contains('add-cart-btn')) {
        const productId = parseInt(productCard.dataset.productId);
        if (!isNaN(productId)) {
            await openProductDetail(productId); // <--- å°±æ˜¯ä¿®æ”¹äº†é€™è£¡ï¼
        }
        return;
    }
    
    // ä¸‹é¢é€™å…©éƒ¨åˆ†é‚è¼¯ä¿æŒä¸è®Š
    if (target.classList.contains('add-cart-btn')) {
        const productId = parseInt(target.dataset.productId);
        if (!isNaN(productId)) {
            await handleAddToCart(productId);
        }
        return;
    }
    const categoryTab = target.closest('.category-tab-btn');
    if (categoryTab) {
        const category = categoryTab.dataset.category === 'all' ? null : categoryTab.dataset.category;
        renderTaobaoProducts(category);
        return;
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ä»£ç¢¼ï¼Œé»è²¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘â€œæ¡ƒå¯¶â€App æœç´¢èˆ‡AIçµæœå½ˆçª—äº‹ä»¶ç›£è½å™¨ --- */

// 1. ç¶å®šæœç´¢æŒ‰éˆ•
productSearchBtn.addEventListener('click', handleSearchProductsAI);
productSearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        handleSearchProductsAI();
    }
});

// 2. ç¶å®šAIçµæœå½ˆçª—çš„é—œé–‰æŒ‰éˆ•
document.getElementById('close-ai-products-modal-btn').addEventListener('click', async () => {
    aiGeneratedProductsModal.classList.remove('visible');
    // é—œé–‰å¾Œåˆ·æ–°ä¸»é ï¼Œé¡¯ç¤ºæ–°æ·»åŠ çš„å•†å“
    await renderTaobaoProducts(); 
});

// 3. ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œè™•ç†çµæœå½ˆçª—å…§æ‰€æœ‰â€œæ·»åŠ â€æŒ‰éˆ•çš„é»æ“Š
document.getElementById('ai-product-results-grid').addEventListener('click', async (e) => {
    if (e.target.classList.contains('add-to-my-page-btn')) {
        const button = e.target;
        const productData = JSON.parse(button.dataset.product);
        // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¦‚æœAIè¿”å›çš„å•†å“è³‡æ–™è£¡æ²’æœ‰åœ–ç‰‡URL
        if (!productData.imageUrl) {
            // å°±èª¿ç”¨æˆ‘å€‘çš„è¼”åŠ©å‡½æ•¸ï¼Œçµ¦å®ƒä¸€å¼µéš¨æ©Ÿé»˜èªåœ–
            productData.imageUrl = getRandomDefaultProductImage();
            console.log(`AIç”Ÿæˆçš„å•†å“ "${productData.name}" ç¼ºå°‘åœ–ç‰‡ï¼Œå·²è‡ªå‹•è£œå……é è¨­åœ–ã€‚`);
        }
        // â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        // æª¢æŸ¥å•†å“æ˜¯å¦å·²å­˜åœ¨
        const existingProduct = await db.taobaoProducts.where('name').equals(productData.name).first();
        if (existingProduct) {
            alert('é€™å€‹å•†å“å·²ç¶“å­˜åœ¨æ–¼ä½ çš„æ¡ƒå¯¶ä¸»é å•¦ï¼');
            button.textContent = 'å·²æ·»åŠ ';
            button.disabled = true;
            return;
        }

        // æ·»åŠ åˆ°è³‡æ–™åº«
        await db.taobaoProducts.add(productData);
        
        // ç¦ç”¨æŒ‰éˆ•ä¸¦æ›´æ–°æ–‡æœ¬ï¼Œçµ¦ä½¿ç”¨è€…å›é¥‹
        button.textContent = 'âœ“ å·²æ·»åŠ ';
        button.disabled = true;
        
        // ï¼ˆå¯é¸ï¼‰çµ¦å€‹å°æç¤º
        // await showCustomAlert('æ·»åŠ æˆåŠŸ', `â€œ${productData.name}â€å·²æ·»åŠ åˆ°ä½ çš„æ¡ƒå¯¶ï¼`);
    }
});

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æ¡ƒå¯¶è¨‚å–®ç‰©æµåŠŸèƒ½äº‹ä»¶ç›£è½å™¨ --- */

// 1. ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºâ€œæˆ‘çš„è¨‚å–®â€æ¸…å–®ä¸­çš„æ‰€æœ‰è¨‚å–®é …ç¶å®šé»æ“Šäº‹ä»¶
document.getElementById('orders-view').addEventListener('click', (e) => {
    const item = e.target.closest('.order-item');
    if (item && item.dataset.orderId) {
        const orderId = parseInt(item.dataset.orderId);
        if (!isNaN(orderId)) {
            openLogisticsView(orderId);
        }
    }
});

// 2. ç¶å®šç‰©æµé é¢çš„è¿”å›æŒ‰éˆ•
document.getElementById('logistics-back-btn').addEventListener('click', () => {
    // è¿”å›æ™‚ï¼Œç›´æ¥é¡¯ç¤ºâ€œæ¡ƒå¯¶â€ä¸»ä»‹é¢ï¼Œä¸¦è‡ªå‹•åˆ‡æ›åˆ°â€œæˆ‘çš„è¨‚å–®â€é ç°½
    showScreen('taobao-screen');
    switchTaobaoView('orders-view'); 
});

/* --- äº‹ä»¶ç›£è½çµæŸ --- */

// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
document.getElementById('share-cart-to-char-btn').addEventListener('click', handleShareCartRequest);
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸé»è²¼ â–¼â–¼â–¼
document.getElementById('buy-for-char-btn').addEventListener('click', handleBuyForChar);
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
/* --- â€œæ¡ƒå¯¶â€App äº‹ä»¶ç›£è½å™¨çµæŸ --- */
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è§’è‰²æ‰‹æ©Ÿå¤–è§€è¨­ç½®çš„äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('character-phone-container').addEventListener('click', (e) => {
    // ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œåˆ¤æ–·é»æ“Šçš„æ˜¯å“ªå€‹æŒ‰éˆ•
    if (e.target.id === 'upload-char-phone-wallpaper-btn') {
        document.getElementById('char-phone-wallpaper-upload-input').click();
    } 
    else if (e.target.id === 'remove-char-phone-wallpaper-btn') {
        handleCharPhoneWallpaperChange(''); // å‚³å…¥ç©ºå­—ä¸²ä¾†ç§»é™¤å£ç´™
    }
    else {
        const changeIconButton = e.target.closest('.change-icon-btn');
        if (changeIconButton) {
            const iconId = changeIconButton.dataset.iconId;
            handleChangeCharPhoneIcon(iconId);
        }
    }
});

// ç›£è½å£ç´™æª”é¸æ“‡
document.getElementById('char-phone-wallpaper-upload-input').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if(file) {
        const dataUrl = await new Promise(res => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.readAsDataURL(file);
        });
        handleCharPhoneWallpaperChange(dataUrl);
    }
    event.target.value = null; // æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡åŒä¸€å€‹æ–‡ä»¶
});
// â–²â–²â–² äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘è§’è‰²å¾®åšä¸»é äº‹ä»¶ç›£è½å™¨ --- */
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼

// ç‚ºè§’è‰²å¾®åšä¸»é çš„â€œé—œæ³¨â€å’Œâ€œç²‰çµ²â€æ·»åŠ é»æ“Šç·¨è¼¯åŠŸèƒ½
document.getElementById('weibo-char-profile-page').addEventListener('click', async (e) => {
    if (!currentViewingWeiboProfileId) return;
    const chat = state.chats[currentViewingWeiboProfileId];
    if (!chat) return;

    // åˆ¤æ–·é»æ“Šçš„æ˜¯å¦æ˜¯â€œé—œæ³¨â€å€åŸŸ
    if (e.target.closest('#weibo-char-following-item')) {
        const newFollowing = await showCustomPrompt("ç·¨è¼¯é—œæ³¨æ•¸", "è«‹è¼¸å…¥æ–°çš„é—œæ³¨æ•¸:", chat.settings.weiboFollowingCount);
        if (newFollowing !== null) {
            chat.settings.weiboFollowingCount = newFollowing.trim() || '0';
            await db.chats.put(chat);
            await renderWeiboCharProfile(currentViewingWeiboProfileId);
        }
    }
    // åˆ¤æ–·é»æ“Šçš„æ˜¯å¦æ˜¯â€œç²‰çµ²â€å€åŸŸ
    else if (e.target.closest('#weibo-char-fans-item')) {
        const newFans = await showCustomPrompt("ç·¨è¼¯ç²‰çµ²æ•¸", "è«‹è¼¸å…¥æ–°çš„ç²‰çµ²æ•¸ (æ”¯æŒ'è¬'/'å„„'):", chat.settings.weiboFansCount);
        if (newFans !== null) {
            chat.settings.weiboFansCount = newFans.trim() || '0';
            await db.chats.put(chat);
            await renderWeiboCharProfile(currentViewingWeiboProfileId);
        }
    }
});

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä¸Šé¢é‚£æ®µèˆŠä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('back-from-char-profile').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘ä¸å†é¡¯ç¤ºé—œæ³¨æ¸…å–®å½ˆçª—ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›åˆ°å¾®åšä¸»è¢å¹•
    showScreen('weibo-screen'); 
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// 2. ç¶å®šæ–°é é¢å³ä¸Šè§’çš„ç·¨è¼¯æŒ‰éˆ•
document.getElementById('edit-char-weibo-profile-btn').addEventListener('click', openCharWeiboEditor);

// 3. ç¶å®šè§’è‰²è³‡æ–™ç·¨è¼¯å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('cancel-char-weibo-editor-btn').addEventListener('click', () => {
    document.getElementById('char-weibo-editor-modal').classList.remove('visible');
});
document.getElementById('save-char-weibo-editor-btn').addEventListener('click', saveCharWeiboProfile);

// 4. ç‚ºè§’è‰²è³‡æ–™ç·¨è¼¯å½ˆçª—çš„åœ–ç‰‡ä¸Šå‚³ç¶å®šäº‹ä»¶
setupFileUpload('char-weibo-editor-avatar-input', (base64) => {
    document.getElementById('char-weibo-editor-avatar-preview').src = base64;
});
setupFileUpload('char-weibo-editor-bg-input', (base64) => {
    document.getElementById('char-weibo-editor-bg-preview').src = base64;
});

// 5. ç¶å®šé—œæ³¨åˆ—è¡¨çš„é»æ“Šäº‹ä»¶ï¼ˆäº‹ä»¶å§”è¨—ï¼‰
document.getElementById('weibo-following-list-container').addEventListener('click', (e) => {
    const viewProfileBtn = e.target.closest('.view-profile-btn');
    if (viewProfileBtn && viewProfileBtn.dataset.charId) {
        openWeiboCharProfile(viewProfileBtn.dataset.charId);
    }
});

/* --- æ–°äº‹ä»¶ç›£è½çµæŸ --- */
// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘è§’è‰²å¾®åšè³‡æ–™ç·¨è¼¯å™¨äº‹ä»¶ç¶å®š --- */

// 1. ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºè§’è‰²å¾®åšç·¨è¼¯å½ˆçª—å…§çš„æ‰€æœ‰æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('char-weibo-editor-modal').addEventListener('click', (e) => {
    // a. å¦‚æœé»æ“Šçš„æ˜¯â€œæ›´æ›é ­åƒæ¡†â€æŒ‰éˆ•
    if (e.target.classList.contains('change-frame-btn')) {
        const type = e.target.dataset.type; // ç²å–æŒ‰éˆ•é¡å‹ 'char-weibo'
        const targetId = currentViewingWeiboProfileId; // ç²å–ç•¶å‰æ­£åœ¨æŸ¥çœ‹çš„è§’è‰²ID
        
        // èª¿ç”¨é ­åƒæ¡†é¸æ“‡å‡½æ•¸ï¼Œä¸¦å‚³å…¥æ­£ç¢ºçš„åƒæ•¸
        openFrameSelectorModal(type, targetId);
    }
    // b. å¦‚æœé»æ“Šçš„æ˜¯â€œå–æ¶ˆâ€æŒ‰éˆ•
    else if (e.target.id === 'cancel-char-weibo-editor-btn') {
        document.getElementById('char-weibo-editor-modal').classList.remove('visible');
    }
    // c. å¦‚æœé»æ“Šçš„æ˜¯â€œä¿å­˜â€æŒ‰éˆ•
    else if (e.target.id === 'save-char-weibo-editor-btn') {
        saveCharWeiboProfile();
    }
});

// 2. ç‚ºè§’è‰²æ‰‹æ©Ÿçš„åœ–ç‰‡ä¸Šå‚³è¼¸å…¥æ¡†ç¶å®šäº‹ä»¶ï¼ˆé€™æ˜¯ä¹‹å‰å°±æœ‰çš„ï¼Œç¢ºä¿å®ƒåœ¨æ­£ç¢ºçš„ä½ç½®ï¼‰
setupFileUpload('char-weibo-editor-avatar-input', (base64) => {
    document.getElementById('char-weibo-editor-avatar-preview').src = base64;
});
setupFileUpload('char-weibo-editor-bg-input', (base64) => {
    document.getElementById('char-weibo-editor-bg-preview').src = base64;
});

// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œé»è²¼é€™æ•´å¡Šæ–°ä»£ç¢¼ â–¼â–¼â–¼

        /* --- ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿå°çµ„ä»¶ä¸Šå‚³åŠŸèƒ½äº‹ä»¶ç¶å®š --- */

        // è¼”åŠ©å‡½æ•¸ï¼šè™•ç†åœ–ç‰‡ä¸Šå‚³çš„é€šç”¨é‚è¼¯
        const handleWidgetUpload = async (widgetKey, inputFileId) => {
            const fileInput = document.getElementById(inputFileId);
            const file = fileInput.files[0];
            if (!file) return;

            const dataUrl = await new Promise(res => {
                const reader = new FileReader();
                reader.onload = () => res(reader.result);
                reader.readAsDataURL(file);
            });
            
            const chat = state.chats[activeCharacterPhoneId];
            if (!chat.characterPhoneData.widgets) {
                chat.characterPhoneData.widgets = {};
            }
            chat.characterPhoneData.widgets[widgetKey] = dataUrl;
            
            await db.chats.put(chat);
            renderCharPhoneAppearanceScreen(); // åˆ·æ–°è¨­ç½®é é è¦½
            openCharacterPhone(activeCharacterPhoneId); // åˆ·æ–°æ‰‹æ©Ÿä¸»è¢å¹•
            alert('å°å…ƒä»¶åœ–ç‰‡å·²æ›´æ–°ï¼');
            fileInput.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é¸æ“‡
        };

        // è¼”åŠ©å‡½æ•¸ï¼šè™•ç†åœ–ç‰‡ç§»é™¤çš„é€šç”¨é‚è¼¯
        const handleWidgetRemove = async (widgetKey) => {
             const chat = state.chats[activeCharacterPhoneId];
             if (chat.characterPhoneData.widgets && chat.characterPhoneData.widgets[widgetKey]) {
                delete chat.characterPhoneData.widgets[widgetKey];
                await db.chats.put(chat);
                renderCharPhoneAppearanceScreen();
                openCharacterPhone(activeCharacterPhoneId);
                alert('å°å…ƒä»¶åœ–ç‰‡å·²ç§»é™¤ï¼');
             }
        };

        // ç‚ºå››å€‹æ–°æŒ‰éˆ•ç¶å®šäº‹ä»¶
        document.getElementById('upload-widget-1-btn').addEventListener('click', () => {
            document.getElementById('char-phone-widget-1-upload-input').click();
        });
        document.getElementById('remove-widget-1-btn').addEventListener('click', () => {
            handleWidgetRemove('widget1_url');
        });
        document.getElementById('char-phone-widget-1-upload-input').addEventListener('change', () => {
            handleWidgetUpload('widget1_url', 'char-phone-widget-1-upload-input');
        });

        document.getElementById('upload-widget-2-btn').addEventListener('click', () => {
            document.getElementById('char-phone-widget-2-upload-input').click();
        });
        document.getElementById('remove-widget-2-btn').addEventListener('click', () => {
            handleWidgetRemove('widget2_url');
        });
        document.getElementById('char-phone-widget-2-upload-input').addEventListener('change', () => {
            handleWidgetUpload('widget2_url', 'char-phone-widget-2-upload-input');
        });

        /* --- å°çµ„ä»¶äº‹ä»¶ç¶å®šçµæŸ --- */
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©Ÿå¤–è§€é è¨­åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('char-phone-preset-selector').addEventListener('change', handleCharPhonePresetSelection);
document.getElementById('apply-char-phone-preset-btn').addEventListener('click', applySelectedCharPhonePreset);
document.getElementById('save-char-phone-preset-btn').addEventListener('click', saveCurrentCharPhonePreset);
document.getElementById('update-char-phone-preset-btn').addEventListener('click', updateSelectedCharPhonePreset);
document.getElementById('rename-char-phone-preset-btn').addEventListener('click', renameSelectedCharPhonePreset);
document.getElementById('delete-char-phone-preset-btn').addEventListener('click', deleteSelectedCharPhonePreset);
document.getElementById('export-char-phone-preset-btn').addEventListener('click', exportCharPhonePreset);
document.getElementById('import-char-phone-preset-btn').addEventListener('click', () => {
    document.getElementById('import-char-phone-preset-input').click();
});
document.getElementById('import-char-phone-preset-input').addEventListener('change', (e) => {
    importCharPhonePreset(e.target.files[0]);
    e.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡åŒä¸€å€‹æ–‡ä»¶
});
// â–²â–²â–² äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æ©ŸAppå…§å£ç´™åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼

// ç›£è½â€œä¸Šå‚³â€æŒ‰éˆ•çš„é»æ“Šï¼Œå»è§¸ç™¼éš±è—çš„æª”é¸æ“‡å™¨
document.getElementById('upload-char-phone-app-wallpaper-btn').addEventListener('click', () => {
    document.getElementById('char-phone-app-wallpaper-upload-input').click();
});

// ç›£è½æª”é¸æ“‡å™¨çš„è®ŠåŒ–
document.getElementById('char-phone-app-wallpaper-upload-input').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if(file) {
        const dataUrl = await new Promise((res) => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.readAsDataURL(file);
        });
        // æª”è®€å–æˆåŠŸå¾Œï¼Œç«‹åˆ»èª¿ç”¨è™•ç†å‡½æ•¸ä¾†ä¿å­˜å’Œæ‡‰ç”¨
        handleCharPhoneAppWallpaperChange(dataUrl);
    }
    event.target.value = null; // æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡åŒä¸€å€‹æ–‡ä»¶
});

// ç›£è½â€œç§»é™¤â€æŒ‰éˆ•çš„é»æ“Š
document.getElementById('remove-char-phone-app-wallpaper-btn').addEventListener('click', () => {
    // èª¿ç”¨è™•ç†å‡½æ•¸ï¼Œä¸¦å‚³å…¥ç©ºå­—ä¸²è¡¨ç¤ºç§»é™¤
    handleCharPhoneAppWallpaperChange('');
});

// â–²â–²â–² æ–°äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢é€™æ•´å¡Šã€å…¨æ–°çš„ã€‘äº‹ä»¶ç›£è½å™¨ä»£ç¢¼ â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„é£›è¡Œæ£‹äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
/* --- ã€å…¨æ–° | V2åˆ†é¡ç‰ˆã€‘å¿ƒå‹•é£›è¡Œæ£‹åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ --- */

// 1. è¨­ç½®é é¢çš„æŒ‰éˆ•
document.getElementById('start-ludo-game-btn').addEventListener('click', startLudoGame);
document.getElementById('manage-ludo-question-banks-btn').addEventListener('click', openLudoQuestionBankManager);

// 2. éŠæˆ²ä¸»ä»‹é¢çš„æŒ‰éˆ•
document.getElementById('exit-ludo-game-btn').addEventListener('click', async () => {
    const confirmed = await showCustomConfirm('é€€å‡ºéŠæˆ²', 'ç¢ºå®šè¦ä¸­é€”é€€å‡ºéŠæˆ²å—ï¼Ÿ');
    if (confirmed) {
        ludoGameState.isActive = false;
        showScreen('game-hall-screen');
    }
});
document.getElementById('restart-ludo-game-btn').addEventListener('click', async () => {
    const confirmed = await showCustomConfirm('é‡æ–°é–‹å§‹', 'ç¢ºå®šè¦é‡æ–°é–‹å§‹é€™ä¸€å±€å—ï¼Ÿ');
    if (confirmed) {
        startLudoGame(); 
    }
});

// 3. å•é¡Œåº«ç®¡ç†å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('close-qbank-manager-btn').addEventListener('click', async () => {
    document.getElementById('ludo-qbank-manager-modal').classList.remove('visible');
    // å¦‚æœè¨­ç½®é é¢é‚„é–‹è‘—ï¼Œå°±åˆ·æ–°ä¸€ä¸‹ä¸‹æ‹‰æ¸…å–®
    if(document.getElementById('ludo-setup-screen').classList.contains('active')) {
        await openLudoSetup();
    }
});
document.getElementById('add-ludo-qbank-btn').addEventListener('click', addNewLudoQuestionBank);

// 4. å•é¡Œç·¨è¼¯å™¨å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('back-to-qbank-manager-btn').addEventListener('click', () => {
    document.getElementById('ludo-question-editor-modal').classList.remove('visible');
    openLudoQuestionBankManager(); // è¿”å›åˆ°é¡Œåº«ç®¡ç†åˆ—è¡¨
});
document.getElementById('add-ludo-question-btn').addEventListener('click', () => openSingleQuestionEditor(null));

// 5. å–®å€‹å•é¡Œç·¨è¼¯/æ·»åŠ å½ˆçª—çš„æŒ‰éˆ•
document.getElementById('cancel-single-question-btn').addEventListener('click', () => {
    document.getElementById('ludo-single-question-editor-modal').classList.remove('visible');
});
document.getElementById('save-single-question-btn').addEventListener('click', saveSingleQuestion);
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
/* --- ã€å…¨æ–°ã€‘é£›è¡Œæ£‹é¡Œåº«å°å…¥åŠŸèƒ½äº‹ä»¶ç›£è½ --- */
document.getElementById('import-ludo-qbank-btn').addEventListener('click', () => {
    // é»æ“Šâ€œå°å…¥â€æŒ‰éˆ•æ™‚ï¼Œè§¸ç™¼éš±è—çš„æª”é¸æ“‡æ¡†
    document.getElementById('ludo-qbank-import-input').click();
});

document.getElementById('ludo-qbank-import-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        // ç•¶ç”¨æˆ¶é¸æ“‡äº†æª”å¾Œï¼Œèª¿ç”¨æˆ‘å€‘çš„å°å…¥è™•ç†å‡½æ•¸
        importLudoQuestionBank(file);
    }
    e.target.value = null; // æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡åŒä¸€å€‹æ–‡ä»¶
});
/* --- äº‹ä»¶ç›£è½çµæŸ --- */
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²

/* --- é£›è¡Œæ£‹äº‹ä»¶ç›£è½å™¨çµæŸ --- */
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²

// ===================================================================
// 5. å•Ÿå‹•ï¼

// æ‡‰ç”¨å£ç´™ä¸¦æ›´æ–°æ‰€æœ‰æ™‚é˜
applyLockscreenWallpaper();
updateLockClock();

// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½  init() å‡½æ•¸ä¸­èˆŠçš„é–å±å’Œç‹€æ…‹åˆ—é–‹é—œé‚è¼¯ â–¼â–¼â–¼

// 1. è®€å–ã€æ‡‰ç”¨ä¸¦ç›£è½â€œå•Ÿç”¨é–å±â€è¨­ç½®
const enableLockScreenToggle = document.getElementById('enable-lock-screen-toggle');
const lockScreenEnabled = localStorage.getItem('lockScreenEnabled') !== 'false';
enableLockScreenToggle.checked = lockScreenEnabled;

// 2. è®€å–ã€æ‡‰ç”¨ä¸¦ç›£è½â€œé¡¯ç¤ºç‹€æ…‹åˆ—â€è¨­ç½®
const showStatusBarToggle = document.getElementById('show-status-bar-toggle');
const statusBar = document.getElementById('status-bar');
// è®€å–ä¿å­˜çš„ç‹€æ…‹ï¼Œå¦‚æœæ²’ä¿å­˜éï¼Œé è¨­æ˜¯ true (é¡¯ç¤º)
const showStatusBar = localStorage.getItem('showStatusBar') !== 'false'; 
// è®“é–‹é—œçš„ç‹€æ…‹å’Œä¿å­˜çš„ç‹€æ…‹åŒæ­¥
showStatusBarToggle.checked = showStatusBar; 
// æ ¹æ“šä¿å­˜çš„ç‹€æ…‹ï¼Œæ±ºå®šä¸€è¼‰å…¥é€²ä¾†æ™‚æ˜¯å¦é¡¯ç¤ºç‹€æ…‹åˆ—
if (showStatusBar) {
    statusBar.style.display = 'flex';
} else {
    statusBar.style.display = 'none';
}

// 3. ã€é—œéµã€‘çµ¦é–‹é—œæ·»åŠ â€œè®ŠåŒ–â€ç›£è½å™¨ï¼Œé€™æ¨£ä½ æ¯æ¬¡é»æ“Šå®ƒéƒ½æœƒä¿å­˜ç‹€æ…‹
showStatusBarToggle.addEventListener('change', (e) => {
    const isEnabled = e.target.checked;
    // a. å°‡æ–°çš„é–‹é—œç‹€æ…‹ (true æˆ– false) ä¿å­˜åˆ°æµè¦½å™¨çš„ localStorage è£¡
    localStorage.setItem('showStatusBar', isEnabled);
    // b. ç«‹åˆ»æ ¹æ“šæ–°çš„ç‹€æ…‹ä¾†é¡¯ç¤ºæˆ–éš±è—ç‹€æ…‹åˆ—
    statusBar.style.display = isEnabled ? 'flex' : 'none';
});

// 4. æ ¹æ“šæœ€çµ‚çš„é–å±è¨­ç½®ï¼Œæ±ºå®šæ‡‰ç”¨å•Ÿå‹•æ™‚ç¬¬ä¸€å€‹é¡¯ç¤ºçš„è¢å¹•
if (lockScreenEnabled) {
    lockPhone(); // å¦‚æœè¨­ç½®æ˜¯â€œå•Ÿç”¨â€ï¼Œå°±é–å®šæ‰‹æ©Ÿ
} else {
    showScreen('home-screen'); // å¦å‰‡ï¼Œç›´æ¥é€²å…¥ä¸»è¢å¹•
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        }

        init();
 // â–¼â–¼â–¼ æŠŠé€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œé»è²¼åˆ° <script> æ¨™ç±¤å…§çš„ã€è®Šæ•¸å®šç¾©å€åŸŸã€‘çš„æœ«å°¾ â–¼â–¼â–¼

const avatarFrames = [
    { id: 'none', url: '', name: 'ç„¡' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif', name: '14' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif', name: '14' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif', name: '14' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif', name: '14' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif', name: '14' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif', name: '14' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif', name: '14' },
    { id: 'frame_12', url: 'https://i.postimg.cc/7LSRp4hx/e7fa949b9pc84cff0dabe57defceb54c.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/DZgMwc1H/817178fdbpf2ff7740dc98e26ab78759.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/3NffgJSZ/e09c07034ld7e62266c0a5de6a36ae62.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/vHDNGfT2/35ac7f372v588bf48d4f659077196b85.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/KvVsjjgG/3c3aa5219s18b90187ef1f54b3db7ba8.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/k5P1NHcL/55f3e31d8qbc8a02d152b07b99d31567.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/FFCTCzpy/641bad3b3udc599fdb63ca75fde427e5.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/8k7YSLjK/1689aa46aqc4b9ffc0f970e668f56537.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/J0CZSwyW/IMG-6938.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/Df1qLzDf/IMG-6927.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/CLNkrQSW/IMG-6925.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/y8p9s3Jj/IMG-6919.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/Lsr1Zd3Z/IMG-6928.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/Ssgbv41n/IMG-6876.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/SNByPrf9/IMG-7005.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/Z5nrCyS5/IMG-7006.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/mDfMXXFP/IMG-7007.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/DZrGtrqB/IMG-7008.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/ZnJNZWHZ/IMG-7009.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/RhGH0vpt/IMG-7010.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/tRzPkzRg/IMG-7012.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/wTTNGs3Q/IMG-7013.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/3JSG5Jv5/IMG-7014.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/rwDr8X1d/IMG-7015.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/DzDy2vS7/IMG-7017.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/QMVdG9x6/IMG-7016.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/mZ9hgH3J/IMG-7019.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/t4ksHGdg/IMG-7020.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/hP9JpdfT/IMG-7023.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/wTKyXVT9/IMG-7024.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/ZqjKXPSv/IMG-7025.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/gj3Tmqz5/mmexport1751030241029.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/4yCXW52F/mmexport1751030908335.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/VkXngG72/mmexport1751031208329.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/LscBkxZb/mmexport1751017556565.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/1XqzGKwJ/mmexport1751018282681.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/8kHCQwbQ/mmexport1751020645824.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/HWynLK7f/mmexport1751021724230.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/JnwFp3Kx/mmexport1751031208329.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/HLZNWkQw/mmexport1751031767634.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/vH2X6N1y/mmexport1751032231179.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/NFS4ZyvM/mmexport1751032686953.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/3RpmWc8c/mmexport1751033102811.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/L5RLr3tg/mmexport1751035976943.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/4NCPsp5d/mmexport1751034427637.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/CMv02LHm/mmexport1751034842120.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/rFnSzWGx/mmexport1751035618517.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/7YRbzN51/mmexport1751036276038.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/cJpbtPWq/mmexport1751036607799.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/HxLV5v92/mmexport1751036977582.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/D01rYy86/mmexport1751037965259.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/J4fwkTLW/mmexport1751038167142.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/xjpN4swz/IMG-7240.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/ZnzbGdxX/IMG-7239.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/DyYDmKtw/IMG-7238.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/W40f9qtd/IMG-7098.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/8PsK20jQ/IMG-7236.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/cHsTXDVz/IMG-7235.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/sXwm8Yzg/IMG-7234.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/xTk5xN49/IMG-7233.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/k5yv6QBv/IMG-7232.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/yx2m4nbs/IMG-7231.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/vZt0fFKn/IMB-r-HMBXY.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/pddJj9zN/IMG-7094.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/rmB17Qbc/IMB-f-VDf-Fc.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/VkKjzYTK/IMB-f4kk-CT.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/B6KD52vz/IMG-7096.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/9XPwWmwy/IMB-Kf7um-P.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/mrFhKBGz/IMB-e-QWBpa.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/bw4wxW2z/IMB-16r-COL.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/3x0Kx1fz/IMB-K1u-Jp-P.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/CLz0cJ0d/IMG-7116.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/fyyGgW61/IMG-7115.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/gkk7s0vD/IMG-6984.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/0NpZPgYj/IMG-6985.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/tTWKKmTN/IMG-7073.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/jS8tc9wW/IMG-7083.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/rmRVKJpD/IMG-7087.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/zvWGPjms/IMG-7090.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/YSkqDg8V/IMG-7092.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/FzqHTBng/IMG-7093.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/tTpZ6wLs/IMG-7095.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/8P5vt8sW/IMG-7097.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/wMxmCZVC/IMG-7099.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/2jxd0FGp/IMG-7100.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/B6T59xGK/IMG-7101.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/kXfcgFRN/IMG-7106.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/htZppbS4/IMG-7107.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/hPgyjtyn/IMG-7108.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/HLKvs0Kv/IMG-7109.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/wjwbnYkp/IMG-7111.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/bJDMQVkj/IMG-7112.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/SNWBTP5S/IMG-7113.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/jCVMQsKH/IMG-7114.gif', name: '14' },
];

// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²       
    });
</script>
<!-- â–¼â–¼â–¼ é€™æ˜¯æˆ‘å€‘æ–°åŠ çš„éš±è—æª”é¸æ“‡å™¨ â–¼â–¼â–¼ -->
<input type="file" id="character-card-input" accept=".png, .json" style="display: none;">
<!-- â–²â–²â–² æª”é¸æ“‡å™¨çµæŸ â–²â–²â–² -->
<input type="file" id="world-book-import-input" accept=".json, .jsonl" style="display: none;">
<input type="file" id="ludo-qbank-import-input" accept=".json" hidden>
</body>
</html>

